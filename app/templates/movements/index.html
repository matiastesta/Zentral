{% extends 'base.html' %}
{% block title %}Movimientos{% endblock %}
{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Movimientos</h1>
    <p class="mt-1 text-sm text-gray-600">Consulta el historial de ingresos y egresos con filtros avanzados.</p>
</div>

<div class="bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
    <div class="border-b border-gray-200">
        <nav class="flex -mb-px" aria-label="Tabs">
            <button id="tab-mov-ventas" type="button" class="px-4 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600">Ingresos</button>
            <button id="tab-mov-egresos" type="button" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Egresos</button>
            <button id="tab-mov-arqueo" type="button" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Arqueo</button>
            <div class="flex-1"></div>
            <button id="btn-export-mov" type="button" class="m-2 inline-flex items-center px-3 py-2 text-sm font-medium text-blue-700 bg-blue-100 rounded-md hover:bg-blue-200">
                <i class="fas fa-file-export mr-2"></i> Exportar
            </button>
        </nav>
    </div>

    <div class="p-4">
        <div id="panel-mov-ventas" class="space-y-3">
            <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                <table class="min-w-full table-fixed divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="w-28 px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Ticket</th>
                            <th class="w-28 px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Fecha</th>
                            <th class="w-40 px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Tipo</th>
                            <th class="w-28 px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Total</th>
                            <th class="w-32 px-4 py-3 text-xs font-medium tracking-wider text-center text-gray-500 uppercase">Pago</th>
                            <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Notas</th>
                        </tr>
                        <tr class="text-[11px] bg-white align-middle">
                            <th class="px-4 py-1">
                                <input id="mov-ventas-q" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600" placeholder="Ticket / nota">
                            </th>
                            <th class="px-4 py-1">
                                <input id="mov-ventas-range" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white" placeholder="ðŸ“… PerÃ­odo" readonly>
                            </th>
                            <th class="px-4 py-1">
                                <select id="mov-ventas-tipo" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white">
                                    <option value="">Tipo (todos)</option>
                                    <option value="Venta">Venta</option>
                                    <option value="CobroCC">Cobro cuenta corriente</option>
                                </select>
                            </th>
                            <th class="px-4 py-1"></th>
                            <th class="px-4 py-1">
                                <select id="mov-ventas-pago" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white">
                                    <option value="">Pago (todas)</option>
                                    <option>Efectivo</option>
                                    <option>Transferencia</option>
                                    <option>DÃ©bito</option>
                                    <option>CrÃ©dito</option>
                                </select>
                            </th>
                            <th class="px-4 py-1"></th>
                        </tr>
                    </thead>
                    <tbody id="mov-ventas-tbody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="6" class="px-4 py-6 text-sm text-center text-gray-500">Sin datos.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="panel-mov-egresos" class="space-y-3 hidden">
            <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                <table class="min-w-full table-fixed divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="w-28 px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Fecha</th>
                            <th class="w-56 px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">CategorÃ­a</th>
                            <th class="w-56 px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Proveedor</th>
                            <th class="w-28 px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Valor</th>
                            <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Nota</th>
                        </tr>
                        <tr class="text-[11px] bg-white align-middle">
                            <th class="px-4 py-1">
                                <input id="mov-egresos-range" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white" placeholder="ðŸ“… PerÃ­odo" readonly>
                            </th>
                            <th class="px-4 py-1">
                                <div class="relative">
                                    <button id="mov-egresos-cat-btn" type="button" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white text-left">CategorÃ­a (todas)</button>
                                    <div id="mov-egresos-cat-menu" class="hidden absolute left-0 mt-1 w-72 rounded-md border border-gray-200 bg-white shadow-lg z-20">
                                        <div class="p-2 border-b border-gray-100">
                                            <input id="mov-egresos-cat-search" type="text" class="w-full px-2 py-1 border rounded-md text-xs text-gray-600" placeholder="Buscar categorÃ­a">
                                        </div>
                                        <div id="mov-egresos-cat-items" class="max-h-56 overflow-auto py-1"></div>
                                    </div>
                                </div>
                            </th>
                            <th class="px-4 py-1">
                                <div class="relative">
                                    <button id="mov-egresos-sup-btn" type="button" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white text-left">Proveedor (todos)</button>
                                    <div id="mov-egresos-sup-menu" class="hidden absolute left-0 mt-1 w-72 rounded-md border border-gray-200 bg-white shadow-lg z-20">
                                        <div class="p-2 border-b border-gray-100">
                                            <input id="mov-egresos-sup-search" type="text" class="w-full px-2 py-1 border rounded-md text-xs text-gray-600" placeholder="Buscar proveedor">
                                        </div>
                                        <div id="mov-egresos-sup-items" class="max-h-56 overflow-auto py-1"></div>
                                    </div>
                                </div>
                            </th>
                            <th class="px-4 py-1"></th>
                            <th class="px-4 py-1"></th>
                        </tr>
                    </thead>
                    <tbody id="mov-egresos-tbody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="5" class="px-4 py-6 text-sm text-center text-gray-500">Sin datos.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="panel-mov-arqueo" class="space-y-3 hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <input id="mov-arqueo-range" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-white" placeholder="ðŸ“… PerÃ­odo" readonly>
                <div class="text-sm text-gray-600 flex items-center">Arqueos guardados desde Ingresos.</div>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Fecha</th>
                            <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Responsable</th>
                            <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Apertura</th>
                            <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Efectivo del dÃ­a</th>
                            <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Cierre</th>
                        </tr>
                    </thead>
                    <tbody id="mov-arqueo-tbody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="5" class="px-4 py-6 text-sm text-center text-gray-500">Sin datos.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="modal-export-mov" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Exportar movimientos</h3>
                    <p class="text-xs text-gray-500">Se exporta exactamente lo visible (segÃºn tab y filtros).</p>
                </div>
                <button id="btn-close-export-mov" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="btn-export-mov-pdf" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                    <div class="text-2xl">ðŸ“„</div>
                    <div class="mt-2 font-semibold text-gray-900">Exportar a PDF</div>
                    <div class="text-xs text-gray-500">Ideal para imprimir o enviar.</div>
                </button>
                <button id="btn-export-mov-xls" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                    <div class="text-2xl">ðŸ“Š</div>
                    <div class="mt-2 font-semibold text-gray-900">Exportar a Excel</div>
                    <div class="text-xs text-gray-500">Descarga un CSV compatible.</div>
                </button>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end">
                <button id="btn-cancel-export-mov" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const tabVentas = document.getElementById('tab-mov-ventas');
    const tabEgresos = document.getElementById('tab-mov-egresos');
    const tabArqueo = document.getElementById('tab-mov-arqueo');
    const panelVentas = document.getElementById('panel-mov-ventas');
    const panelEgresos = document.getElementById('panel-mov-egresos');
    const panelArqueo = document.getElementById('panel-mov-arqueo');
    const tbodyVentas = document.getElementById('mov-ventas-tbody');
    const tbodyEgresos = document.getElementById('mov-egresos-tbody');
    const tbodyArqueo = document.getElementById('mov-arqueo-tbody');

    const fVentasQ = document.getElementById('mov-ventas-q');
    const fVentasRange = document.getElementById('mov-ventas-range');
    const fVentasPago = document.getElementById('mov-ventas-pago');
    const fVentasTipo = document.getElementById('mov-ventas-tipo');
    const fEgresosRange = document.getElementById('mov-egresos-range');
    const fEgresosCatBtn = document.getElementById('mov-egresos-cat-btn');
    const fEgresosCatMenu = document.getElementById('mov-egresos-cat-menu');
    const fEgresosCatItems = document.getElementById('mov-egresos-cat-items');
    const fEgresosCatSearch = document.getElementById('mov-egresos-cat-search');
    const fEgresosSupBtn = document.getElementById('mov-egresos-sup-btn');
    const fEgresosSupMenu = document.getElementById('mov-egresos-sup-menu');
    const fEgresosSupItems = document.getElementById('mov-egresos-sup-items');
    const fEgresosSupSearch = document.getElementById('mov-egresos-sup-search');
    const fArqueoRange = document.getElementById('mov-arqueo-range');

    const btnExport = document.getElementById('btn-export-mov');
    const modalExport = document.getElementById('modal-export-mov');
    const btnCloseExport = document.getElementById('btn-close-export-mov');
    const btnCancelExport = document.getElementById('btn-cancel-export-mov');
    const btnExportPdf = document.getElementById('btn-export-mov-pdf');
    const btnExportXls = document.getElementById('btn-export-mov-xls');

    let activeTab = 'ventas';
    let lastRendered = [];

    function isPromise(x) { return !!x && typeof x.then === 'function'; }

    function formatearMoneda(valor) {
        const numero = isNaN(valor) ? 0 : valor;
        return '$' + numero.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtFecha(v) {
        try {
            if (window.formatFechaDisplay && typeof window.formatFechaDisplay === 'function') {
                return window.formatFechaDisplay(v);
            }
        } catch (e) {
        }
        return String(v ?? '');
    }

    function parseNumeroSeguro(v) {
        const n = parseFloat(String(v || '').replace(',', '.'));
        return isNaN(n) ? 0 : n;
    }

    function parseFecha(raw) {
        const v = String(raw || '').trim();
        if (!v) return null;
        const dt = new Date(v);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function parseRangoFechas(raw) {
        const txt = String(raw || '').trim();
        const normalized = txt.replace(/\s+a\s+/i, ' - ').replace(/\s+to\s+/i, ' - ');
        const parts = normalized.split(' - ').map(p => p.trim()).filter(Boolean);
        if (parts.length !== 2) return null;
        const a = parseFecha(parts[0]);
        const b = parseFecha(parts[1]);
        if (!a || !b) return null;
        a.setHours(0,0,0,0);
        b.setHours(23,59,59,999);
        return { from: a, to: b };
    }

    function normKey(v) {
        return String(v || '').replace(/\s+/g, ' ').trim().toLowerCase();
    }

    let egresosCatsAll = [];
    let egresosSupsAll = [];
    let egresosCatsSelected = new Set();
    let egresosSupsSelected = new Set();

    function buildUniqueSorted(arr) {
        const seen = new Map();
        (Array.isArray(arr) ? arr : []).forEach(function (raw) {
            const label = String(raw || '').replace(/\s+/g, ' ').trim();
            if (!label) return;
            const k = normKey(label);
            if (!k) return;
            if (!seen.has(k)) seen.set(k, label);
        });
        return Array.from(seen.entries())
            .map(([k, label]) => ({ k, label }))
            .sort((a, b) => String(a.label).localeCompare(String(b.label), 'es'));
    }

    function setDropdownOpen(menu, open) {
        if (!menu) return;
        menu.classList.toggle('hidden', !open);
    }

    function updateCatsButtonLabel() {
        if (!fEgresosCatBtn) return;
        const total = egresosCatsAll.length;
        const selCount = egresosCatsSelected.size;
        if (!selCount || selCount >= total) {
            fEgresosCatBtn.textContent = 'CategorÃ­a (todas)';
            return;
        }
        if (selCount === 1) {
            const only = Array.from(egresosCatsSelected)[0];
            const match = egresosCatsAll.find(x => x.k === only);
            fEgresosCatBtn.textContent = match ? match.label : '1 seleccionada';
            return;
        }
        fEgresosCatBtn.textContent = String(selCount) + ' seleccionadas';
    }

    function updateSupsButtonLabel() {
        if (!fEgresosSupBtn) return;
        const total = egresosSupsAll.length;
        const selCount = egresosSupsSelected.size;
        if (!selCount || selCount >= total) {
            fEgresosSupBtn.textContent = 'Proveedor (todos)';
            return;
        }
        if (selCount === 1) {
            const only = Array.from(egresosSupsSelected)[0];
            const match = egresosSupsAll.find(x => x.k === only);
            fEgresosSupBtn.textContent = match ? match.label : '1 seleccionado';
            return;
        }
        fEgresosSupBtn.textContent = String(selCount) + ' seleccionados';
    }

    function renderCatsItems() {
        if (!fEgresosCatItems) return;
        const q = normKey(fEgresosCatSearch?.value || '');
        const items = egresosCatsAll.filter(it => !q || it.k.includes(q) || normKey(it.label).includes(q));
        const total = egresosCatsAll.length;
        const selCount = egresosCatsSelected.size;
        const allOn = (!selCount || selCount >= total);
        const html = [];
        html.push('<label class="flex items-center gap-2 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 cursor-pointer">'
            + '<input type="checkbox" class="eg-cat-all" ' + (allOn ? 'checked' : '') + ' />'
            + '<span>Todas</span>'
            + '</label>');
        if (!items.length) {
            html.push('<div class="px-3 py-2 text-xs text-gray-400">Sin resultados.</div>');
        } else {
            items.forEach(function (it) {
                const checked = allOn ? true : egresosCatsSelected.has(it.k);
                html.push('<label class="flex items-center gap-2 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 cursor-pointer">'
                    + '<input type="checkbox" class="eg-cat-opt" data-k="' + it.k.replace(/"/g, '&quot;') + '" ' + (checked ? 'checked' : '') + ' />'
                    + '<span class="truncate">' + String(it.label) + '</span>'
                    + '</label>');
            });
        }
        fEgresosCatItems.innerHTML = html.join('');
    }

    function renderSupsItems() {
        if (!fEgresosSupItems) return;
        const q = normKey(fEgresosSupSearch?.value || '');
        const items = egresosSupsAll.filter(it => !q || it.k.includes(q) || normKey(it.label).includes(q));
        const total = egresosSupsAll.length;
        const selCount = egresosSupsSelected.size;
        const allOn = (!selCount || selCount >= total);
        const html = [];
        html.push('<label class="flex items-center gap-2 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 cursor-pointer">'
            + '<input type="checkbox" class="eg-sup-all" ' + (allOn ? 'checked' : '') + ' />'
            + '<span>Todos</span>'
            + '</label>');
        if (!items.length) {
            html.push('<div class="px-3 py-2 text-xs text-gray-400">Sin resultados.</div>');
        } else {
            items.forEach(function (it) {
                const checked = allOn ? true : egresosSupsSelected.has(it.k);
                html.push('<label class="flex items-center gap-2 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 cursor-pointer">'
                    + '<input type="checkbox" class="eg-sup-opt" data-k="' + it.k.replace(/"/g, '&quot;') + '" ' + (checked ? 'checked' : '') + ' />'
                    + '<span class="truncate">' + String(it.label) + '</span>'
                    + '</label>');
            });
        }
        fEgresosSupItems.innerHTML = html.join('');
    }

    function updateEgresosFilterOptions(allExpenses) {
        const all = Array.isArray(allExpenses) ? allExpenses : [];
        const cats = buildUniqueSorted(all.map(e => e?.categoria || ''));
        const sups = buildUniqueSorted(all.map(e => e?.supplier_name || e?.proveedor || ''));

        egresosCatsAll = cats;
        egresosSupsAll = sups;

        const catsKeys = new Set(cats.map(x => x.k));
        egresosCatsSelected = new Set(Array.from(egresosCatsSelected).filter(k => catsKeys.has(k)));
        const supsKeys = new Set(sups.map(x => x.k));
        egresosSupsSelected = new Set(Array.from(egresosSupsSelected).filter(k => supsKeys.has(k)));

        updateCatsButtonLabel();
        updateSupsButtonLabel();
        renderCatsItems();
        renderSupsItems();
    }

    function openExport() { if (modalExport) modalExport.classList.remove('hidden'); }
    function closeExport() { if (modalExport) modalExport.classList.add('hidden'); }

    function escapeCsvCell(v) {
        const s = String(v ?? '');
        if (/[\n\r",;]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
        return s;
    }

    function exportCsv() {
        const rows = lastRendered || [];
        if (!rows.length) return;
        const header = Object.keys(rows[0]);
        const lines = [header.map(escapeCsvCell).join(';')];
        rows.forEach(r => {
            lines.push(header.map(k => escapeCsvCell(r?.[k])).join(';'));
        });
        const blob = new Blob(["\ufeff" + lines.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'movimientos_' + activeTab + '.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.setTimeout(function () { URL.revokeObjectURL(a.href); }, 500);
    }

    function exportPdfPrint() {
        const rows = lastRendered || [];
        const w = window.open('', '_blank');
        if (!w) return;
        const header = rows.length ? Object.keys(rows[0]) : [];
        const headHtml = header.map(h => '<th>' + String(h) + '</th>').join('');
        const bodyHtml = rows.map(r => '<tr>' + header.map(h => '<td>' + String(r?.[h] ?? '') + '</td>').join('') + '</tr>').join('');
        const html = ''
            + '<!doctype html><html lang="es"><head><meta charset="utf-8" />'
            + '<title>Exportar movimientos</title>'
            + '<style>body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#111}h1{font-size:18px;margin:0 0 6px 0}table{width:100%;border-collapse:collapse;font-size:12px}th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}th{background:#f9fafb}</style>'
            + '</head><body>'
            + '<h1>Movimientos (' + activeTab + ')</h1>'
            + '<table><thead><tr>' + headHtml + '</tr></thead><tbody>' + bodyHtml + '</tbody></table>'
            + '<script>window.onload=function(){window.print();}<\/script>'
            + '</body></html>';
        w.document.open();
        w.document.write(html);
        w.document.close();
    }

    function isoFromDate(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return y + '-' + m + '-' + day;
    }

    function getSalesFromApi(range, cb) {
        const qs = [];
        if (range && range.from) qs.push('from=' + encodeURIComponent(isoFromDate(range.from)));
        if (range && range.to) qs.push('to=' + encodeURIComponent(isoFromDate(range.to)));
        qs.push('limit=2000');
        const url = '/sales/api/sales' + (qs.length ? ('?' + qs.join('&')) : '');
        fetch(url, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => {
                const items = data && Array.isArray(data.items) ? data.items : [];
                cb(items);
            })
            .catch(() => cb([]));
    }

    function getExpenses(cb) {
        try {
            if (window.StorageService && typeof window.StorageService.getExpenses === 'function') {
                const res = window.StorageService.getExpenses();
                if (isPromise(res)) return res.then(x => cb(Array.isArray(x) ? x : []));
                return cb(Array.isArray(res) ? res : []);
            }
        } catch (e) {
        }
        cb([]);
    }

    function getArqueosFromApi(fromIso, toIso, cb) {
        const qs = [];
        if (fromIso) qs.push('from=' + encodeURIComponent(fromIso));
        if (toIso) qs.push('to=' + encodeURIComponent(toIso));
        const url = '/movements/api/cash-counts' + (qs.length ? ('?' + qs.join('&')) : '');
        fetch(url, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => {
                const items = data && Array.isArray(data.items) ? data.items : [];
                cb(items);
            })
            .catch(() => cb([]));
    }

    function renderVentas() {
        if (!tbodyVentas) return;
        const q = String(fVentasQ?.value || '').trim().toLowerCase();
        const rango = parseRangoFechas(fVentasRange?.value);
        const pago = String(fVentasPago?.value || '').trim();
        const tipo = String(fVentasTipo?.value || '').trim();

        tbodyVentas.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-sm text-center text-gray-500">Cargandoâ€¦</td></tr>';
        getSalesFromApi(rango, function (sales) {

            let list = Array.isArray(sales) ? sales.slice() : [];
            list = list.filter(s => {
                const txt = (String(s?.ticket || '') + ' ' + String(s?.notes || '')).toLowerCase();
                if (q && !txt.includes(q)) return false;
                if (pago && String(s?.payment_method || '') !== pago) return false;
                if (tipo) {
                    const st = String(s?.type || s?.sale_type || '').trim();
                    if (tipo === 'CobroCC') {
                        if (st !== 'CobroCC') return false;
                    } else if (tipo === 'Venta') {
                        if (st === 'CobroCC') return false;
                    } else {
                        if (st !== tipo) return false;
                    }
                }
                const dt = parseFecha(s?.fecha || s?.date || '');
                if (rango && dt && !(dt >= rango.from && dt <= rango.to)) return false;
                return true;
            });
            list.sort((a, b) => (parseInt(b?.created_at || 0, 10) || 0) - (parseInt(a?.created_at || 0, 10) || 0));

            const labelTipo = function (s) {
                const t = String(s?.type || s?.sale_type || '').trim();
                if (t === 'CobroCC') return 'Cobro CC';
                if (t) return t;
                return 'Venta';
            };

            lastRendered = list.map(s => ({
                Ticket: s?.ticket || '',
                Fecha: fmtFecha(s?.fecha || s?.date || ''),
                Tipo: labelTipo(s),
                Total: formatearMoneda(parseFloat(s?.total || 0) || 0),
                Pago: s?.payment_method || '',
                Notas: s?.notes || ''
            }));

            tbodyVentas.innerHTML = '';
            if (!list.length) {
                tbodyVentas.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-sm text-center text-gray-500">Sin resultados.</td></tr>';
                return;
            }
            list.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = ''
                    + '<td class="px-4 py-3 text-sm text-gray-900">' + String(s?.ticket || '') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-gray-500">' + fmtFecha(s?.fecha || s?.date || '') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-gray-500">' + labelTipo(s) + '</td>'
                    + '<td class="px-4 py-3 text-sm text-right text-gray-900">' + formatearMoneda(parseFloat(s?.total || 0) || 0) + '</td>'
                    + '<td class="px-4 py-3 text-sm text-center text-gray-500">' + String(s?.payment_method || '') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-gray-500">' + String(s?.notes || '') + '</td>';
                tbodyVentas.appendChild(tr);
            });
        });
    }

    function renderEgresos() {
        if (!tbodyEgresos) return;
        getExpenses(function (egresos) {
            updateEgresosFilterOptions(egresos);

            const rango = parseRangoFechas(fEgresosRange?.value);

            let list = Array.isArray(egresos) ? egresos.slice() : [];
            list = list.filter(e => {
                const catKey = normKey(e?.categoria || '');
                if (egresosCatsSelected.size && egresosCatsSelected.size < egresosCatsAll.length) {
                    if (!egresosCatsSelected.has(catKey)) return false;
                }

                const supKey = normKey(e?.supplier_name || e?.proveedor || '');
                if (egresosSupsSelected.size && egresosSupsSelected.size < egresosSupsAll.length) {
                    if (!egresosSupsSelected.has(supKey)) return false;
                }
                const dt = parseFecha(e?.fecha || '');
                if (rango && dt && !(dt >= rango.from && dt <= rango.to)) return false;
                return true;
            });
            list.sort((a, b) => String(b?.fecha || '').localeCompare(String(a?.fecha || '')));

            lastRendered = list.map(e => ({
                Fecha: fmtFecha(e?.fecha || ''),
                CategorÃ­a: e?.categoria || '',
                Proveedor: e?.supplier_name || e?.proveedor || '',
                Valor: formatearMoneda(parseFloat(e?.valor || 0) || 0),
                Nota: e?.nota || ''
            }));

            tbodyEgresos.innerHTML = '';
            if (!list.length) {
                tbodyEgresos.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-sm text-center text-gray-500">Sin resultados.</td></tr>';
                return;
            }
            list.forEach(e => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = ''
                    + '<td class="px-4 py-3 text-sm text-gray-500">' + fmtFecha(e?.fecha || '') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-gray-900">' + String(e?.categoria || '') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-gray-500">' + String(e?.supplier_name || e?.proveedor || '') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-right text-gray-900">' + formatearMoneda(parseFloat(e?.valor || 0) || 0) + '</td>'
                    + '<td class="px-4 py-3 text-sm text-gray-500">' + String(e?.nota || '') + '</td>';
                tbodyEgresos.appendChild(tr);
            });
        });
    }

    function renderArqueo() {
        if (!tbodyArqueo) return;
        const rango = parseRangoFechas(fArqueoRange?.value);
        const fromIso = rango ? (rango.from.getFullYear() + '-' + String(rango.from.getMonth() + 1).padStart(2, '0') + '-' + String(rango.from.getDate()).padStart(2, '0')) : '';
        const toIso = rango ? (rango.to.getFullYear() + '-' + String(rango.to.getMonth() + 1).padStart(2, '0') + '-' + String(rango.to.getDate()).padStart(2, '0')) : '';

        tbodyArqueo.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-sm text-center text-gray-500">Cargandoâ€¦</td></tr>';
        getArqueosFromApi(fromIso, toIso, function (items) {
            let historico = Array.isArray(items) ? items.slice() : [];
            historico.sort((a, b) => String(b?.date || '').localeCompare(String(a?.date || '')));

            lastRendered = historico.map(r => ({
                Fecha: fmtFecha(r?.date || ''),
                Responsable: (r?.employee_name || ''),
                Apertura: formatearMoneda(parseNumeroSeguro(r?.opening_amount)),
                Efectivo_dia: formatearMoneda(parseNumeroSeguro(r?.cash_day_amount)),
                Cierre: formatearMoneda(parseNumeroSeguro(r?.closing_amount))
            }));

            tbodyArqueo.innerHTML = '';
            if (!historico.length) {
                tbodyArqueo.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-sm text-center text-gray-500">Sin resultados.</td></tr>';
                return;
            }
            historico.forEach(r => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = ''
                    + '<td class="px-4 py-3 text-sm text-gray-700">' + fmtFecha(r?.date || '-') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-gray-700">' + String(r?.employee_name || '-') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-right text-gray-700">' + formatearMoneda(parseNumeroSeguro(r?.opening_amount)) + '</td>'
                    + '<td class="px-4 py-3 text-sm text-right text-gray-700">' + formatearMoneda(parseNumeroSeguro(r?.cash_day_amount)) + '</td>'
                    + '<td class="px-4 py-3 text-sm text-right text-gray-700">' + formatearMoneda(parseNumeroSeguro(r?.closing_amount)) + '</td>';
                tbodyArqueo.appendChild(tr);
            });
        });
    }

    function setTab(tab) {
        activeTab = tab;
        if (panelVentas) panelVentas.classList.toggle('hidden', tab !== 'ventas');
        if (panelEgresos) panelEgresos.classList.toggle('hidden', tab !== 'egresos');
        if (panelArqueo) panelArqueo.classList.toggle('hidden', tab !== 'arqueo');

        const setBtn = function (btn, on) {
            if (!btn) return;
            btn.classList.toggle('border-blue-500', on);
            btn.classList.toggle('text-blue-600', on);
            btn.classList.toggle('border-transparent', !on);
            btn.classList.toggle('text-gray-500', !on);
        };
        setBtn(tabVentas, tab === 'ventas');
        setBtn(tabEgresos, tab === 'egresos');
        setBtn(tabArqueo, tab === 'arqueo');

        if (tab === 'ventas') renderVentas();
        if (tab === 'egresos') renderEgresos();
        if (tab === 'arqueo') renderArqueo();
    }

    if (tabVentas) tabVentas.addEventListener('click', function () { setTab('ventas'); });
    if (tabEgresos) tabEgresos.addEventListener('click', function () { setTab('egresos'); });
    if (tabArqueo) tabArqueo.addEventListener('click', function () { setTab('arqueo'); });

    [fVentasQ, fVentasPago, fVentasTipo].forEach(el => { if (el) el.addEventListener('input', renderVentas); if (el) el.addEventListener('change', renderVentas); });

    if (fEgresosCatBtn && fEgresosCatMenu) {
        fEgresosCatBtn.addEventListener('click', function () {
            const open = fEgresosCatMenu.classList.contains('hidden');
            setDropdownOpen(fEgresosCatMenu, open);
            if (open) {
                try { setDropdownOpen(fEgresosSupMenu, false); } catch (e) { }
                try { fEgresosCatSearch?.focus?.(); } catch (e) { }
            }
        });
    }

    if (fEgresosSupBtn && fEgresosSupMenu) {
        fEgresosSupBtn.addEventListener('click', function () {
            const open = fEgresosSupMenu.classList.contains('hidden');
            setDropdownOpen(fEgresosSupMenu, open);
            if (open) {
                try { setDropdownOpen(fEgresosCatMenu, false); } catch (e) { }
                try { fEgresosSupSearch?.focus?.(); } catch (e) { }
            }
        });
    }

    if (fEgresosCatSearch) {
        fEgresosCatSearch.addEventListener('input', function () { renderCatsItems(); });
    }
    if (fEgresosSupSearch) {
        fEgresosSupSearch.addEventListener('input', function () { renderSupsItems(); });
    }

    if (fEgresosCatItems) {
        fEgresosCatItems.addEventListener('change', function (ev) {
            const t = ev && ev.target ? ev.target : null;
            if (!t) return;
            if (t.classList.contains('eg-cat-all')) {
                egresosCatsSelected = new Set();
            }
            if (t.classList.contains('eg-cat-opt')) {
                const k = String(t.getAttribute('data-k') || '').trim();
                if (!k) return;
                if (!egresosCatsSelected.size || egresosCatsSelected.size >= egresosCatsAll.length) {
                    egresosCatsSelected = new Set(egresosCatsAll.map(x => x.k));
                }
                if (t.checked) {
                    egresosCatsSelected.add(k);
                } else {
                    egresosCatsSelected.delete(k);
                }
            }
            updateCatsButtonLabel();
            renderCatsItems();
            try { renderEgresos(); } catch (e) { }
        });
    }

    if (fEgresosSupItems) {
        fEgresosSupItems.addEventListener('change', function (ev) {
            const t = ev && ev.target ? ev.target : null;
            if (!t) return;
            if (t.classList.contains('eg-sup-all')) {
                egresosSupsSelected = new Set();
            }
            if (t.classList.contains('eg-sup-opt')) {
                const k = String(t.getAttribute('data-k') || '').trim();
                if (!k) return;
                if (!egresosSupsSelected.size || egresosSupsSelected.size >= egresosSupsAll.length) {
                    egresosSupsSelected = new Set(egresosSupsAll.map(x => x.k));
                }
                if (t.checked) {
                    egresosSupsSelected.add(k);
                } else {
                    egresosSupsSelected.delete(k);
                }
            }
            updateSupsButtonLabel();
            renderSupsItems();
            try { renderEgresos(); } catch (e) { }
        });
    }

    document.addEventListener('click', function (ev) {
        const t = ev && ev.target ? ev.target : null;
        if (!t) return;
        try {
            if (fEgresosCatMenu && !fEgresosCatMenu.classList.contains('hidden')) {
                if (!fEgresosCatMenu.contains(t) && !fEgresosCatBtn.contains(t)) {
                    setDropdownOpen(fEgresosCatMenu, false);
                }
            }
        } catch (e) {
        }
        try {
            if (fEgresosSupMenu && !fEgresosSupMenu.classList.contains('hidden')) {
                if (!fEgresosSupMenu.contains(t) && !fEgresosSupBtn.contains(t)) {
                    setDropdownOpen(fEgresosSupMenu, false);
                }
            }
        } catch (e) {
        }
    });

    if (fVentasRange && window.flatpickr) {
        flatpickr(fVentasRange, { mode: 'range', dateFormat: 'd/m/Y', locale: window.flatpickr && window.flatpickr.l10ns ? window.flatpickr.l10ns.es : 'es', allowInput: false,
            onChange: function (d) { if (Array.isArray(d) && d.length === 2) renderVentas(); },
            onClose: function (d) { if (Array.isArray(d) && d.length === 2) renderVentas(); }
        });
    }
    if (fEgresosRange && window.flatpickr) {
        flatpickr(fEgresosRange, { mode: 'range', dateFormat: 'd/m/Y', locale: window.flatpickr && window.flatpickr.l10ns ? window.flatpickr.l10ns.es : 'es', allowInput: false,
            onChange: function (d) { if (Array.isArray(d) && d.length === 2) renderEgresos(); },
            onClose: function (d) { if (Array.isArray(d) && d.length === 2) renderEgresos(); }
        });
    }
    if (fArqueoRange && window.flatpickr) {
        flatpickr(fArqueoRange, { mode: 'range', dateFormat: 'd/m/Y', locale: window.flatpickr && window.flatpickr.l10ns ? window.flatpickr.l10ns.es : 'es', allowInput: false,
            onChange: function (d) { if (Array.isArray(d) && d.length === 2) renderArqueo(); },
            onClose: function (d) { if (Array.isArray(d) && d.length === 2) renderArqueo(); }
        });
    }

    if (btnExport) btnExport.addEventListener('click', openExport);
    if (btnCloseExport) btnCloseExport.addEventListener('click', closeExport);
    if (btnCancelExport) btnCancelExport.addEventListener('click', closeExport);
    if (btnExportXls) btnExportXls.addEventListener('click', function () { exportCsv(); closeExport(); });
    if (btnExportPdf) btnExportPdf.addEventListener('click', function () { exportPdfPrint(); closeExport(); });
    if (modalExport) {
        modalExport.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalExport.firstElementChild) closeExport();
        });
    }

    setTab('ventas');

    return;
});
</script>
{% endblock %}
