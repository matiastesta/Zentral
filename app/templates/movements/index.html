{% extends 'base.html' %}
{% block title %}Movimientos{% endblock %}
{% block content %}
<div class="mb-6">
    <h1 class="text-2xl font-bold text-gray-900">Movimientos</h1>
    <p class="mt-1 text-sm text-gray-600">Consulta el historial de ingresos y gastos con filtros avanzados.</p>
</div>

<div class="bg-white rounded-lg shadow border border-gray-200 overflow-visible">
    <div class="border-b border-gray-200">
        <nav class="flex -mb-px" aria-label="Tabs">
            <button id="tab-mov-ventas" type="button" class="px-4 py-3 text-sm font-medium border-b-2 border-blue-500 text-blue-600">Ingresos</button>
            <button id="tab-mov-egresos" type="button" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Gastos</button>
            <button id="tab-mov-arqueo" type="button" class="px-4 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">Arqueo</button>
            <div class="flex-1"></div>
            <button id="btn-export-mov" type="button" class="m-2 inline-flex items-center px-3 py-2 text-sm font-medium text-blue-700 bg-blue-100 rounded-md hover:bg-blue-200">
                <i class="fas fa-file-export mr-2"></i> Exportar
            </button>
        </nav>
    </div>

    <div class="p-4">
        <div id="panel-mov-ventas" class="space-y-3">
            <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                <table class="min-w-full table-fixed divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="w-28 px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Ticket</th>
                            <th class="w-28 px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Fecha</th>
                            <th class="w-40 px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Tipo</th>
                            <th class="w-28 px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Total</th>
                            <th class="w-32 px-4 py-3 text-xs font-medium tracking-wider text-center text-gray-500 uppercase">Pago</th>
                            <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Notas</th>
                            <th class="w-14 px-4 py-3 text-xs font-medium tracking-wider text-center text-gray-500 uppercase"></th>
                        </tr>
                        <tr class="text-[11px] bg-white align-middle">
                            <th class="px-4 py-1">
                                <input id="mov-ventas-q" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600" placeholder="Ticket / nota">
                            </th>
                            <th class="px-4 py-1">
                                <input id="mov-ventas-range" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white" placeholder="ðŸ“… PerÃ­odo" readonly>
                            </th>
                            <th class="px-4 py-1">
                                <select id="mov-ventas-tipo" multiple size="1" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white">
                                    <option value="" selected>Tipo (todos)</option>
                                    <option value="Venta">Venta</option>
                                    <option value="Cobro">Cobro</option>
                                    <option value="CuentaCorriente">Cuenta corriente</option>
                                    <option value="Cambio">Cambio</option>
                                    <option value="IngresoAjusteInv">Ingreso por ajuste</option>
                                </select>
                            </th>
                            <th class="px-4 py-1"></th>
                            <th class="px-4 py-1">
                                <select id="mov-ventas-pago" multiple size="1" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white">
                                    <option value="" selected>Pago (todas)</option>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="DÃ©bito">DÃ©bito</option>
                                    <option value="CrÃ©dito">CrÃ©dito</option>
                                </select>
                            </th>
                            <th class="px-4 py-1"></th>
                        </tr>
                    </thead>
                    <tbody id="mov-ventas-tbody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="7" class="px-4 py-6 text-sm text-center text-gray-500">Sin datos.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="panel-mov-egresos" class="space-y-3 hidden">
            <div class="bg-white rounded-lg shadow border border-gray-200">
                <div id="mov-egresos-scroll" class="overflow-auto" style="max-height: 65vh;">
                <table class="min-w-full table-fixed divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="w-28 px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Fecha</th>
                            <th class="w-56 px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">CategorÃ­a</th>
                            <th class="w-56 px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Proveedor</th>
                            <th class="w-28 px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Valor</th>
                            <th class="w-32 px-4 py-3 text-xs font-medium tracking-wider text-center text-gray-500 uppercase">Pago</th>
                            <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Nota</th>
                            <th class="w-14 px-4 py-3 text-xs font-medium tracking-wider text-center text-gray-500 uppercase"></th>
                        </tr>
                        <tr class="text-[11px] bg-white align-middle">
                            <th class="px-4 py-1">
                                <input id="mov-egresos-range" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white" placeholder="ðŸ“… PerÃ­odo" readonly>
                            </th>
                            <th class="px-4 py-1">
                                <div class="relative">
                                    <button id="mov-egresos-cat-btn" type="button" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white text-left">CategorÃ­a (todas)</button>
                                    <div id="mov-egresos-cat-menu" class="hidden absolute left-0 mt-1 w-72 rounded-md border border-gray-200 bg-white shadow-lg z-50">
                                        <div class="p-2 border-b border-gray-100">
                                            <input id="mov-egresos-cat-search" type="text" class="w-full px-2 py-1 border rounded-md text-xs text-gray-600" placeholder="Buscar categorÃ­a">
                                        </div>
                                        <div id="mov-egresos-cat-items" class="max-h-56 overflow-auto py-1"></div>
                                    </div>
                                </div>
                            </th>
                            <th class="px-4 py-1">
                                <div class="relative">
                                    <button id="mov-egresos-sup-btn" type="button" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white text-left">Proveedor (todos)</button>
                                    <div id="mov-egresos-sup-menu" class="hidden absolute left-0 mt-1 w-72 rounded-md border border-gray-200 bg-white shadow-lg z-50">
                                        <div class="p-2 border-b border-gray-100">
                                            <input id="mov-egresos-sup-search" type="text" class="w-full px-2 py-1 border rounded-md text-xs text-gray-600" placeholder="Buscar proveedor">
                                        </div>
                                        <div id="mov-egresos-sup-items" class="max-h-56 overflow-auto py-1"></div>
                                    </div>
                                </div>
                            </th>
                            <th class="px-4 py-1"></th>
                            <th class="px-4 py-1">
                                <select id="mov-egresos-pago" multiple size="1" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white">
                                    <option value="" selected>Pago (todas)</option>
                                    <option value="Efectivo">Efectivo</option>
                                    <option value="Transferencia">Transferencia</option>
                                    <option value="DÃ©bito">DÃ©bito</option>
                                    <option value="CrÃ©dito">CrÃ©dito</option>
                                </select>
                            </th>
                            <th class="px-4 py-1"></th>
                        </tr>
                    </thead>
                    <tbody id="mov-egresos-tbody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="7" class="px-4 py-6 text-sm text-center text-gray-500">Sin datos.</td></tr>
                    </tbody>
                </table>
                </div>
            </div>
        </div>

        <div id="panel-mov-arqueo" class="space-y-3 hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                <input id="mov-arqueo-range" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-white" placeholder="ðŸ“… PerÃ­odo" readonly>
                <div class="text-sm text-gray-600 flex items-center">Arqueos guardados desde Ingresos.</div>
            </div>
            <div class="bg-white rounded-lg shadow overflow-hidden border border-gray-200">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Fecha</th>
                            <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Responsable</th>
                            <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Apertura</th>
                            <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Efectivo del dÃ­a</th>
                            <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Cierre</th>
                        </tr>
                    </thead>
                    <tbody id="mov-arqueo-tbody" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="5" class="px-4 py-6 text-sm text-center text-gray-500">Sin datos.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div id="modal-export-mov" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Exportar movimientos</h3>
                    <p class="text-xs text-gray-500">Se exporta exactamente lo visible (segÃºn tab y filtros).</p>
                </div>
                <button id="btn-close-export-mov" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="btn-export-mov-pdf" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                    <div class="text-2xl">ðŸ“„</div>
                    <div class="mt-2 font-semibold text-gray-900">Exportar a PDF</div>
                    <div class="text-xs text-gray-500">Ideal para imprimir o enviar.</div>
                </button>
                <button id="btn-export-mov-xls" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                    <div class="text-2xl">ðŸ“Š</div>
                    <div class="mt-2 font-semibold text-gray-900">Exportar a Excel</div>
                    <div class="text-xs text-gray-500">Descarga un CSV compatible.</div>
                </button>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end">
                <button id="btn-cancel-export-mov" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const tabVentas = document.getElementById('tab-mov-ventas');
    const tabEgresos = document.getElementById('tab-mov-egresos');
    const tabArqueo = document.getElementById('tab-mov-arqueo');
    const panelVentas = document.getElementById('panel-mov-ventas');
    const panelEgresos = document.getElementById('panel-mov-egresos');
    const panelArqueo = document.getElementById('panel-mov-arqueo');
    const tbodyVentas = document.getElementById('mov-ventas-tbody');
    const tbodyEgresos = document.getElementById('mov-egresos-tbody');
    const tbodyArqueo = document.getElementById('mov-arqueo-tbody');

    const fVentasQ = document.getElementById('mov-ventas-q');
    const fVentasRange = document.getElementById('mov-ventas-range');
    const fVentasPago = document.getElementById('mov-ventas-pago');
    const fVentasTipo = document.getElementById('mov-ventas-tipo');
    const fEgresosRange = document.getElementById('mov-egresos-range');
    const fEgresosPago = document.getElementById('mov-egresos-pago');
    const fEgresosCatBtn = document.getElementById('mov-egresos-cat-btn');
    const fEgresosCatMenu = document.getElementById('mov-egresos-cat-menu');
    const fEgresosCatItems = document.getElementById('mov-egresos-cat-items');
    const fEgresosCatSearch = document.getElementById('mov-egresos-cat-search');
    const fEgresosSupBtn = document.getElementById('mov-egresos-sup-btn');
    const fEgresosSupMenu = document.getElementById('mov-egresos-sup-menu');
    const fEgresosSupItems = document.getElementById('mov-egresos-sup-items');
    const fEgresosSupSearch = document.getElementById('mov-egresos-sup-search');
    const fArqueoRange = document.getElementById('mov-arqueo-range');

    const btnExport = document.getElementById('btn-export-mov');
    const modalExport = document.getElementById('modal-export-mov');
    const btnCloseExport = document.getElementById('btn-close-export-mov');
    const btnCancelExport = document.getElementById('btn-cancel-export-mov');
    const btnExportPdf = document.getElementById('btn-export-mov-pdf');
    const btnExportXls = document.getElementById('btn-export-mov-xls');

    let activeTab = 'ventas';
    let lastRendered = [];

    function isPromise(x) { return !!x && typeof x.then === 'function'; }

    function formatearMoneda(valor) {
        const numero = isNaN(valor) ? 0 : valor;
        return '$' + numero.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtFecha(v) {
        try {
            if (window.formatFechaDisplay && typeof window.formatFechaDisplay === 'function') {
                return window.formatFechaDisplay(v);
            }
        } catch (e) {
        }
        return String(v ?? '');
    }

    function parseNumeroSeguro(v) {
        const n = parseFloat(String(v || '').replace(',', '.'));
        return isNaN(n) ? 0 : n;
    }

    function parseFecha(raw) {
        const v = String(raw || '').trim();
        if (!v) return null;
        const m = v.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if (m) {
            const dd = parseInt(m[1], 10);
            const mm = parseInt(m[2], 10);
            const yy = parseInt(m[3], 10);
            const dt = new Date(yy, mm - 1, dd);
            return isNaN(dt.getTime()) ? null : dt;
        }
        const dt = new Date(v);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function endOfPeriod(d) {
        if (!d) return null;
        const x = new Date(d.getFullYear(), d.getMonth() + 1, 0);
        x.setHours(23, 59, 59, 999);
        return x;
    }

    function parseRangoFechas(raw) {
        const txt = String(raw || '').trim();
        if (!txt) return null;
        const normalized = txt.replace(/\s+a\s+/i, ' - ').replace(/\s+to\s+/i, ' - ');
        const parts = normalized.split(' - ').map(p => p.trim()).filter(Boolean);
        if (!parts.length) return null;
        if (parts.length === 1) {
            const a = parseFecha(parts[0]);
            if (!a) return null;
            a.setHours(0, 0, 0, 0);
            const b = endOfPeriod(a);
            return b ? { from: a, to: b } : null;
        }
        if (parts.length !== 2) return null;
        const a = parseFecha(parts[0]);
        const b = parseFecha(parts[1]);
        if (!a || !b) return null;
        a.setHours(0, 0, 0, 0);
        b.setHours(23, 59, 59, 999);
        const from = (a <= b) ? a : b;
        const to = (a <= b) ? b : a;
        return { from, to };
    }

    function normKey(v) {
        return String(v || '').replace(/\s+/g, ' ').trim().toLowerCase();
    }

    function getSelectedValues(selectEl) {
        if (!selectEl) return [];
        try {
            if (selectEl.selectedOptions) {
                return Array.from(selectEl.selectedOptions)
                    .map(o => String(o.value || '').trim())
                    .filter(Boolean);
            }
        } catch (e) {
        }
        const v = String(selectEl.value || '').trim();
        return v ? [v] : [];
    }

    function getSelectFilterState(selectEl) {
        const emptyValue = '';
        if (!selectEl) return { mode: 'all', values: [] };
        let selectedVals = [];
        try {
            selectedVals = Array.from(selectEl.selectedOptions || []).map(o => String(o.value || ''));
        } catch (e) {
            const v = String(selectEl.value || '').trim();
            selectedVals = v ? [v] : [];
        }

        const realSelected = selectedVals.filter(v => v !== emptyValue && String(v).trim());
        const allVals = Array.from(selectEl.options || [])
            .map(o => String(o.value || ''))
            .filter(v => v !== emptyValue && String(v).trim());

        if (selectedVals.includes(emptyValue)) return { mode: 'all', values: [] };
        if (!allVals.length) return { mode: 'all', values: [] };
        if (!realSelected.length) return { mode: 'none', values: [] };
        if (realSelected.length >= allVals.length) return { mode: 'all', values: [] };
        return { mode: 'some', values: realSelected };
    }

    function isLockedSale(s) {
        try {
            const st = String(s?.type || s?.sale_type || '').trim();
            const notes = String(s?.notes || s?.notes_display || '');
            if (st === 'AjusteInvCosto' || st === 'IngresoAjusteInv') return true;
            if (notes && notes.indexOf('AdjustmentId:') >= 0) return true;
        } catch (e) {
        }
        return false;
    }

    function saleKind(s) {
        const st = String(s?.type || s?.sale_type || '').trim();
        const pm = normKey(s?.payment_method || '');
        const onAcc = !!(s && (s.on_account === true || s.on_account === 1 || s.on_account === '1'));

        if (st === 'CobroCC') return 'Cobro';
        if (st === 'Cambio') return 'Cambio';
        if (st === 'IngresoAjusteInv') return 'IngresoAjusteInv';
        if (onAcc || pm.includes('cuenta corriente') || pm === 'cuenta corriente') return 'CuentaCorriente';
        return 'Venta';
    }

    function labelTipo(s) {
        const k = saleKind(s);
        if (k === 'Cobro') return 'Cobro';
        if (k === 'CuentaCorriente') return 'Cuenta corriente';
        if (k === 'Cambio') return 'Cambio';
        if (k === 'IngresoAjusteInv') return 'Ingreso por ajuste';
        return 'Venta';
    }

    function buildTicketDetail(s) {
        try {
            const items = Array.isArray(s?.items) ? s.items : [];
            if (!items.length) return '';
            const parts = [];
            for (let i = 0; i < items.length; i++) {
                const it = items[i] || {};
                const name = String(it?.nombre || it?.product_name || 'Producto').trim();
                const qty = parseNumeroSeguro(it?.cantidad ?? it?.qty);
                if (!name) continue;
                const qtxt = (qty && isFinite(qty)) ? (String(qty.toLocaleString('es-AR', { maximumFractionDigits: 2 })) + 'x ') : '';
                parts.push(qtxt + name);
                if (parts.length >= 3) break;
            }
            if (!parts.length) return '';
            const suffix = (items.length > parts.length) ? 'â€¦' : '';
            return 'Detalle: ' + parts.join(', ') + suffix;
        } catch (e) {
            return '';
        }
    }

    let egresosCatsAll = [];
    let egresosSupsAll = [];
    let egresosCatsSelected = new Set();
    let egresosSupsSelected = new Set();
    let egresosCatsAllSelected = true;
    let egresosSupsAllSelected = true;

    function buildUniqueSorted(arr) {
        const seen = new Map();
        (Array.isArray(arr) ? arr : []).forEach(function (raw) {
            const label = String(raw || '').replace(/\s+/g, ' ').trim();
            if (!label) return;
            const k = normKey(label);
            if (!k) return;
            if (!seen.has(k)) seen.set(k, label);
        });
        return Array.from(seen.entries())
            .map(([k, label]) => ({ k, label }))
            .sort((a, b) => String(a.label).localeCompare(String(b.label), 'es'));
    }

    function setDropdownOpen(menu, open, anchorBtn) {
        if (!menu) return;
        menu.classList.toggle('hidden', !open);
        if (!open) {
            try {
                menu.style.position = '';
                menu.style.left = '';
                menu.style.top = '';
                menu.style.maxHeight = '';
                menu.style.zIndex = '';
            } catch (e) {}
            return;
        }

        try {
            const btn = anchorBtn || null;
            if (!btn || !btn.getBoundingClientRect) return;
            const r = btn.getBoundingClientRect();
            const pad = 10;
            const spaceBelow = Math.max(0, window.innerHeight - r.bottom - pad);
            const spaceAbove = Math.max(0, r.top - pad);

            const wantUp = (spaceBelow < 220) && (spaceAbove > spaceBelow);
            const maxH = Math.max(140, Math.min(340, (wantUp ? (spaceAbove - 12) : (spaceBelow - 12))));

            menu.style.position = 'fixed';
            menu.style.left = Math.max(pad, Math.min(r.left, window.innerWidth - pad - 300)) + 'px';
            menu.style.top = (wantUp ? Math.max(pad, r.top - maxH - 6) : (r.bottom + 6)) + 'px';
            menu.style.maxHeight = maxH + 'px';
            menu.style.overflow = 'auto';
            menu.style.zIndex = '1050';
        } catch (e) {
        }
    }

    function selectAllMultiSelect(selectEl) {
        if (!selectEl) return;
        try {
            Array.from(selectEl.options || []).forEach(function (o) { o.selected = true; });
        } catch (e) {
        }
    }

    function updateCatsButtonLabel() {
        if (!fEgresosCatBtn) return;
        const total = egresosCatsAll.length;
        const selCount = egresosCatsSelected.size;
        if (egresosCatsAllSelected) {
            fEgresosCatBtn.textContent = 'CategorÃ­a (todas)';
            return;
        }
        if (!selCount) {
            fEgresosCatBtn.textContent = 'CategorÃ­a (ninguna)';
            return;
        }
        if (selCount === 1) {
            const only = Array.from(egresosCatsSelected)[0];
            const match = egresosCatsAll.find(x => x.k === only);
            fEgresosCatBtn.textContent = match ? match.label : '1 seleccionada';
            return;
        }
        fEgresosCatBtn.textContent = String(selCount) + ' seleccionadas';
    }

    function updateSupsButtonLabel() {
        if (!fEgresosSupBtn) return;
        const total = egresosSupsAll.length;
        const selCount = egresosSupsSelected.size;
        if (egresosSupsAllSelected) {
            fEgresosSupBtn.textContent = 'Proveedor (todos)';
            return;
        }
        if (!selCount) {
            fEgresosSupBtn.textContent = 'Proveedor (ninguno)';
            return;
        }
        if (selCount === 1) {
            const only = Array.from(egresosSupsSelected)[0];
            const match = egresosSupsAll.find(x => x.k === only);
            fEgresosSupBtn.textContent = match ? match.label : '1 seleccionado';
            return;
        }
        fEgresosSupBtn.textContent = String(selCount) + ' seleccionados';
    }

    function renderCatsItems() {
        if (!fEgresosCatItems) return;
        const q = normKey(fEgresosCatSearch?.value || '');
        const items = egresosCatsAll.filter(it => !q || it.k.includes(q) || normKey(it.label).includes(q));
        const total = egresosCatsAll.length;
        const selCount = egresosCatsSelected.size;
        const allOn = egresosCatsAllSelected;
        const html = [];
        html.push('<label class="flex items-center gap-2 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 cursor-pointer">'
            + '<input type="checkbox" class="eg-cat-all" ' + (allOn ? 'checked' : '') + ' />'
            + '<span>Todas</span>'
            + '</label>');
        if (!items.length) {
            html.push('<div class="px-3 py-2 text-xs text-gray-400">Sin resultados.</div>');
        } else {
            items.forEach(function (it) {
                const checked = allOn ? true : egresosCatsSelected.has(it.k);
                html.push('<label class="flex items-center gap-2 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 cursor-pointer">'
                    + '<input type="checkbox" class="eg-cat-opt" data-k="' + it.k.replace(/"/g, '&quot;') + '" ' + (checked ? 'checked' : '') + ' />'
                    + '<span class="truncate">' + String(it.label) + '</span>'
                    + '</label>');
            });
        }
        fEgresosCatItems.innerHTML = html.join('');
    }

    function renderSupsItems() {
        if (!fEgresosSupItems) return;
        const q = normKey(fEgresosSupSearch?.value || '');
        const items = egresosSupsAll.filter(it => !q || it.k.includes(q) || normKey(it.label).includes(q));
        const total = egresosSupsAll.length;
        const selCount = egresosSupsSelected.size;
        const allOn = egresosSupsAllSelected;
        const html = [];
        html.push('<label class="flex items-center gap-2 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 cursor-pointer">'
            + '<input type="checkbox" class="eg-sup-all" ' + (allOn ? 'checked' : '') + ' />'
            + '<span>Todos</span>'
            + '</label>');
        if (!items.length) {
            html.push('<div class="px-3 py-2 text-xs text-gray-400">Sin resultados.</div>');
        } else {
            items.forEach(function (it) {
                const checked = allOn ? true : egresosSupsSelected.has(it.k);
                html.push('<label class="flex items-center gap-2 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 cursor-pointer">'
                    + '<input type="checkbox" class="eg-sup-opt" data-k="' + it.k.replace(/"/g, '&quot;') + '" ' + (checked ? 'checked' : '') + ' />'
                    + '<span class="truncate">' + String(it.label) + '</span>'
                    + '</label>');
            });
        }
        fEgresosSupItems.innerHTML = html.join('');
    }

    function updateEgresosFilterOptions(allExpenses) {
        const all = Array.isArray(allExpenses) ? allExpenses : [];
        const cats = buildUniqueSorted(all.map(e => e?.categoria || ''));
        const sups = buildUniqueSorted(all.map(e => e?.supplier_name || e?.proveedor || ''));

        egresosCatsAll = cats;
        egresosSupsAll = sups;

        const catsKeys = new Set(cats.map(x => x.k));
        egresosCatsSelected = new Set(Array.from(egresosCatsSelected).filter(k => catsKeys.has(k)));
        const supsKeys = new Set(sups.map(x => x.k));
        egresosSupsSelected = new Set(Array.from(egresosSupsSelected).filter(k => supsKeys.has(k)));

        if (egresosCatsAllSelected) {
            egresosCatsSelected = new Set();
        }
        if (egresosSupsAllSelected) {
            egresosSupsSelected = new Set();
        }

        if (!cats.length) {
            egresosCatsAllSelected = true;
            egresosCatsSelected = new Set();
        } else if (!egresosCatsAllSelected && egresosCatsSelected.size >= cats.length) {
            egresosCatsAllSelected = true;
            egresosCatsSelected = new Set();
        }

        if (!sups.length) {
            egresosSupsAllSelected = true;
            egresosSupsSelected = new Set();
        } else if (!egresosSupsAllSelected && egresosSupsSelected.size >= sups.length) {
            egresosSupsAllSelected = true;
            egresosSupsSelected = new Set();
        }

        updateCatsButtonLabel();
        updateSupsButtonLabel();
        renderCatsItems();
        renderSupsItems();
    }

    function openExport() { if (modalExport) modalExport.classList.remove('hidden'); }
    function closeExport() { if (modalExport) modalExport.classList.add('hidden'); }

    function escapeCsvCell(v) {
        const s = String(v ?? '');
        if (/[\n\r",;]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
        return s;
    }

    function exportCsv() {
        const rows = lastRendered || [];
        if (!rows.length) return;
        const header = Object.keys(rows[0]);
        const lines = [header.map(escapeCsvCell).join(';')];
        rows.forEach(r => {
            lines.push(header.map(k => escapeCsvCell(r?.[k])).join(';'));
        });
        const blob = new Blob(["\ufeff" + lines.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'movimientos_' + activeTab + '.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.setTimeout(function () { URL.revokeObjectURL(a.href); }, 500);
    }

    function exportPdfPrint() {
        const rows = lastRendered || [];
        const w = window.open('', '_blank');
        if (!w) return;
        const header = rows.length ? Object.keys(rows[0]) : [];
        const headHtml = header.map(h => '<th>' + String(h) + '</th>').join('');
        const bodyHtml = rows.map(r => '<tr>' + header.map(h => '<td>' + String(r?.[h] ?? '') + '</td>').join('') + '</tr>').join('');
        const html = ''
            + '<!doctype html><html lang="es"><head><meta charset="utf-8" />'
            + '<title>Exportar movimientos</title>'
            + '<style>body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#111}h1{font-size:18px;margin:0 0 6px 0}table{width:100%;border-collapse:collapse;font-size:12px}th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}th{background:#f9fafb}</style>'
            + '</head><body>'
            + '<h1>Movimientos (' + activeTab + ')</h1>'
            + '<table><thead><tr>' + headHtml + '</tr></thead><tbody>' + bodyHtml + '</tbody></table>'
            + '<script>window.onload=function(){window.print();}<\/script>'
            + '</body></html>';
        w.document.open();
        w.document.write(html);
        w.document.close();
    }

    function isoFromDate(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return y + '-' + m + '-' + day;
    }

    function getSalesFromApi(range, cb) {
        const qs = [];
        if (range && range.from) qs.push('from=' + encodeURIComponent(isoFromDate(range.from)));
        if (range && range.to) qs.push('to=' + encodeURIComponent(isoFromDate(range.to)));
        qs.push('limit=20000');
        const url = '/sales/api/sales' + (qs.length ? ('?' + qs.join('&')) : '');
        fetch(url, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => {
                const items = data && Array.isArray(data.items) ? data.items : [];
                cb(items);
            })
            .catch(() => cb([]));
    }

    function apiDeleteSale(ticket) {
        const t = String(ticket || '').trim();
        if (!t) return Promise.resolve({ ok: false, error: 'invalid_ticket' });
        return fetch('/sales/api/sales/' + encodeURIComponent(t), {
            method: 'DELETE',
            credentials: 'same-origin'
        }).then(r => r.json()).catch(() => ({ ok: false, error: 'network' }));
    }

    function apiDeleteExpense(expenseId) {
        const id = String(expenseId || '').trim();
        if (!id) return Promise.resolve({ ok: false, error: 'invalid_expense' });
        return fetch('/expenses/api/expenses/' + encodeURIComponent(id), {
            method: 'DELETE',
            credentials: 'same-origin'
        }).then(r => r.json()).catch(() => ({ ok: false, error: 'network' }));
    }

    function getExpenses(cb) {
        try {
            if (window.StorageService && typeof window.StorageService.getExpenses === 'function') {
                const res = window.StorageService.getExpenses();
                if (isPromise(res)) return res.then(x => cb(Array.isArray(x) ? x : []));
                return cb(Array.isArray(res) ? res : []);
            }
        } catch (e) {
        }
        cb([]);
    }

    function getArqueosFromApi(fromIso, toIso, cb) {
        const qs = [];
        if (fromIso) qs.push('from=' + encodeURIComponent(fromIso));
        if (toIso) qs.push('to=' + encodeURIComponent(toIso));
        const url = '/movements/api/cash-counts' + (qs.length ? ('?' + qs.join('&')) : '');
        fetch(url, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => {
                const items = data && Array.isArray(data.items) ? data.items : [];
                cb(items);
            })
            .catch(() => cb([]));
    }

    function renderVentas() {
        if (!tbodyVentas) return;
        const q = String(fVentasQ?.value || '').trim().toLowerCase();
        const rango = parseRangoFechas(fVentasRange?.value);
        const pagosState = getSelectFilterState(fVentasPago);
        const tiposState = getSelectFilterState(fVentasTipo);

        tbodyVentas.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-sm text-center text-gray-500">Cargandoâ€¦</td></tr>';
        getSalesFromApi(rango, function (sales) {

            let list = Array.isArray(sales) ? sales.slice() : [];
            list = list.filter(s => {
                const txt = (String(s?.ticket || '') + ' ' + String(s?.notes_display || s?.notes || '')).toLowerCase();
                if (q && !txt.includes(q)) return false;
                const pm = String(s?.payment_method || '').trim();
                if (pagosState.mode === 'none') return false;
                if (pagosState.mode === 'some' && pagosState.values.indexOf(pm) < 0) return false;

                const kind = saleKind(s);
                if (tiposState.mode === 'none') return false;
                if (tiposState.mode === 'some' && tiposState.values.indexOf(kind) < 0) return false;

                const dt = parseFecha(s?.fecha || s?.date || '');
                if (rango && dt && !(dt >= rango.from && dt <= rango.to)) return false;
                return true;
            });
            list.sort((a, b) => (parseInt(b?.created_at || 0, 10) || 0) - (parseInt(a?.created_at || 0, 10) || 0));

            const buildNotes = function (s) {
                const base = String(s?.notes_display || s?.notes || '').trim();
                const detail = buildTicketDetail(s);
                if (!detail) return base;
                if (!base) return detail;
                return base + ' Â· ' + detail;
            };

            lastRendered = list.map(s => ({
                Ticket: s?.ticket || '',
                Fecha: fmtFecha(s?.fecha || s?.date || ''),
                Tipo: labelTipo(s),
                Total: formatearMoneda(parseFloat(s?.total || 0) || 0),
                Pago: s?.payment_method || '',
                Notas: buildNotes(s)
            }));

            tbodyVentas.innerHTML = '';
            if (!list.length) {
                tbodyVentas.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-sm text-center text-gray-500">Sin resultados.</td></tr>';
                return;
            }
            list.forEach(s => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                const ticket = String(s?.ticket || '').trim();
                const locked = isLockedSale(s);
                tr.innerHTML = ''
                    + '<td class="px-4 py-3 text-sm text-gray-900">' + String(s?.ticket || '') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-gray-500">' + fmtFecha(s?.fecha || s?.date || '') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-gray-500">' + labelTipo(s) + '</td>'
                    + '<td class="px-4 py-3 text-sm text-right text-gray-900">' + formatearMoneda(parseFloat(s?.total || 0) || 0) + '</td>'
                    + '<td class="px-4 py-3 text-sm text-center text-gray-500">' + String(s?.payment_method || '') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-gray-500">' + String(buildNotes(s) || '').replace(/__tmp__|_tmp_/gi, '') + '</td>'
                    + '<td class="px-4 py-3 text-center">'
                    +   (locked ? '' : ('<button type="button" class="btn-del-sale h-8 w-8 inline-flex items-center justify-center rounded-md border border-red-200 bg-red-50 text-red-700 hover:bg-red-100" data-ticket="' + String(ticket).replace(/"/g, '&quot;') + '" title="Eliminar">'
                    +       '<i class="fas fa-trash text-[12px]"></i>'
                    +   '</button>'))
                    + '</td>';
                tbodyVentas.appendChild(tr);
            });

            try {
                tbodyVentas.querySelectorAll('.btn-del-sale').forEach(function (btn) {
                    btn.addEventListener('click', async function () {
                        const t = String(btn.getAttribute('data-ticket') || '').trim();
                        if (!t) return;
                        const ok = await (window.confirmModal ? window.confirmModal(
                            'Â¿QuerÃ©s eliminar el ticket ' + t + '? Esta acciÃ³n revierte inventario y elimina el movimiento asociado.',
                            'Eliminar ingreso',
                            'No se puede deshacer.'
                        ) : Promise.resolve(window.confirm('Â¿Eliminar el ticket ' + t + '?')));
                        if (!ok) return;
                        const res = await apiDeleteSale(t);
                        if (!res || res.ok !== true) {
                            const msg = (res && (res.message || res.error)) ? String(res.message || res.error) : 'No se pudo eliminar.';
                            if (window.showAlertModal) window.showAlertModal(msg, 'Error', 'Eliminar ingreso');
                            return;
                        }
                        renderVentas();
                    });
                });
            } catch (e) {}
        });
    }

    function renderEgresos() {
        if (!tbodyEgresos) return;
        getExpenses(function (egresos) {
            updateEgresosFilterOptions(egresos);

            const rango = parseRangoFechas(fEgresosRange?.value);
            const pagosState = getSelectFilterState(fEgresosPago);

            let list = Array.isArray(egresos) ? egresos.slice() : [];
            list = list.filter(e => {
                const catKey = normKey(e?.categoria || '');
                if (!egresosCatsAllSelected) {
                    if (!egresosCatsSelected.size) return false;
                    if (!egresosCatsSelected.has(catKey)) return false;
                }

                const supKey = normKey(e?.supplier_name || e?.proveedor || '');
                if (!egresosSupsAllSelected) {
                    if (!egresosSupsSelected.size) return false;
                    if (!egresosSupsSelected.has(supKey)) return false;
                }
                const dt = parseFecha(e?.fecha || '');
                if (rango && dt && !(dt >= rango.from && dt <= rango.to)) return false;

                const pay = String(e?.forma_pago || e?.payment_method || e?.pago || '').trim();
                if (pagosState.mode === 'none') return false;
                if (pagosState.mode === 'some' && pagosState.values.indexOf(pay) < 0) return false;

                return true;
            });
            list.sort((a, b) => String(b?.fecha || '').localeCompare(String(a?.fecha || '')));

            lastRendered = list.map(e => ({
                Fecha: fmtFecha(e?.fecha || ''),
                CategorÃ­a: e?.categoria || '',
                Proveedor: e?.supplier_name || e?.proveedor || '',
                Valor: formatearMoneda(parseFloat(e?.valor || 0) || 0),
                Pago: String(e?.forma_pago || e?.payment_method || e?.pago || ''),
                Nota: e?.nota || ''
            }));

            tbodyEgresos.innerHTML = '';
            if (!list.length) {
                tbodyEgresos.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-sm text-center text-gray-500">Sin resultados.</td></tr>';
                return;
            }
            list.forEach(e => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                const eid = String(e?.id || '').trim();
                tr.innerHTML = ''
                    + '<td class="px-4 py-3 text-sm text-gray-500">' + fmtFecha(e?.fecha || '') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-gray-900">' + String(e?.categoria || '') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-gray-500">' + String(e?.supplier_name || e?.proveedor || '') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-right text-gray-900">' + formatearMoneda(parseFloat(e?.valor || 0) || 0) + '</td>'
                    + '<td class="px-4 py-3 text-sm text-center text-gray-500">' + String(e?.forma_pago || e?.payment_method || e?.pago || '') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-gray-500">' + String(e?.nota || '') + '</td>'
                    + '<td class="px-4 py-3 text-center">'
                    +   '<button type="button" class="btn-del-exp h-8 w-8 inline-flex items-center justify-center rounded-md border border-red-200 bg-red-50 text-red-700 hover:bg-red-100" data-expense-id="' + String(eid).replace(/"/g, '&quot;') + '" title="Eliminar">'
                    +       '<i class="fas fa-trash text-[12px]"></i>'
                    +   '</button>'
                    + '</td>';
                tbodyEgresos.appendChild(tr);
            });

            try {
                tbodyEgresos.querySelectorAll('.btn-del-exp').forEach(function (btn) {
                    btn.addEventListener('click', async function () {
                        const id = String(btn.getAttribute('data-expense-id') || '').trim();
                        if (!id) return;
                        const ok = await (window.confirmModal ? window.confirmModal(
                            'Â¿QuerÃ©s eliminar este egreso? Esta acciÃ³n elimina el gasto y desaparece del historial.',
                            'Eliminar egreso',
                            'No se puede deshacer.'
                        ) : Promise.resolve(window.confirm('Â¿Eliminar egreso?')));
                        if (!ok) return;
                        const res = await apiDeleteExpense(id);
                        if (!res || res.ok !== true) {
                            const msg = (res && (res.message || res.error)) ? String(res.message || res.error) : 'No se pudo eliminar.';
                            if (window.showAlertModal) window.showAlertModal(msg, 'Error', 'Eliminar egreso');
                            return;
                        }
                        renderEgresos();
                    });
                });
            } catch (e) {}
        });
    }

    function renderArqueo() {
        if (!tbodyArqueo) return;
        const rango = parseRangoFechas(fArqueoRange?.value);
        const fromIso = rango ? (rango.from.getFullYear() + '-' + String(rango.from.getMonth() + 1).padStart(2, '0') + '-' + String(rango.from.getDate()).padStart(2, '0')) : '';
        const toIso = rango ? (rango.to.getFullYear() + '-' + String(rango.to.getMonth() + 1).padStart(2, '0') + '-' + String(rango.to.getDate()).padStart(2, '0')) : '';

        tbodyArqueo.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-sm text-center text-gray-500">Cargandoâ€¦</td></tr>';
        getArqueosFromApi(fromIso, toIso, function (items) {
            let historico = Array.isArray(items) ? items.slice() : [];
            historico.sort((a, b) => String(b?.date || '').localeCompare(String(a?.date || '')));

            lastRendered = historico.map(r => ({
                Fecha: fmtFecha(r?.date || ''),
                Responsable: (r?.employee_name || ''),
                Apertura: formatearMoneda(parseNumeroSeguro(r?.opening_amount)),
                Efectivo_dia: formatearMoneda(parseNumeroSeguro(r?.cash_day_amount)),
                Cierre: formatearMoneda(parseNumeroSeguro(r?.closing_amount))
            }));

            tbodyArqueo.innerHTML = '';
            if (!historico.length) {
                tbodyArqueo.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-sm text-center text-gray-500">Sin resultados.</td></tr>';
                return;
            }
            historico.forEach(r => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = ''
                    + '<td class="px-4 py-3 text-sm text-gray-700">' + fmtFecha(r?.date || '-') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-gray-700">' + String(r?.employee_name || '-') + '</td>'
                    + '<td class="px-4 py-3 text-sm text-right text-gray-700">' + formatearMoneda(parseNumeroSeguro(r?.opening_amount)) + '</td>'
                    + '<td class="px-4 py-3 text-sm text-right text-gray-700">' + formatearMoneda(parseNumeroSeguro(r?.cash_day_amount)) + '</td>'
                    + '<td class="px-4 py-3 text-sm text-right text-gray-700">' + formatearMoneda(parseNumeroSeguro(r?.closing_amount)) + '</td>';
                tbodyArqueo.appendChild(tr);
            });
        });
    }

    function setTab(tab) {
        activeTab = tab;
        if (panelVentas) panelVentas.classList.toggle('hidden', tab !== 'ventas');
        if (panelEgresos) panelEgresos.classList.toggle('hidden', tab !== 'egresos');
        if (panelArqueo) panelArqueo.classList.toggle('hidden', tab !== 'arqueo');

        const setBtn = function (btn, on) {
            if (!btn) return;
            btn.classList.toggle('border-blue-500', on);
            btn.classList.toggle('text-blue-600', on);
            btn.classList.toggle('border-transparent', !on);
            btn.classList.toggle('text-gray-500', !on);
        };
        setBtn(tabVentas, tab === 'ventas');
        setBtn(tabEgresos, tab === 'egresos');
        setBtn(tabArqueo, tab === 'arqueo');

        if (tab === 'ventas') renderVentas();
        if (tab === 'egresos') renderEgresos();
        if (tab === 'arqueo') renderArqueo();
    }

    if (tabVentas) tabVentas.addEventListener('click', function () { setTab('ventas'); });
    if (tabEgresos) tabEgresos.addEventListener('click', function () { setTab('egresos'); });
    if (tabArqueo) tabArqueo.addEventListener('click', function () { setTab('arqueo'); });

    egresosCatsAllSelected = true;
    egresosSupsAllSelected = true;
    egresosCatsSelected = new Set();
    egresosSupsSelected = new Set();

    selectAllMultiSelect(fVentasPago);
    selectAllMultiSelect(fVentasTipo);
    selectAllMultiSelect(fEgresosPago);

    initTodosMultiSelect(fVentasPago);
    initTodosMultiSelect(fVentasTipo);
    initTodosMultiSelect(fEgresosPago);

    [fVentasQ, fVentasPago, fVentasTipo].forEach(el => { if (el) el.addEventListener('input', renderVentas); if (el) el.addEventListener('change', renderVentas); });
    if (fEgresosPago) fEgresosPago.addEventListener('change', function () { try { renderEgresos(); } catch (e) { } });

    if (fEgresosCatBtn && fEgresosCatMenu) {
        fEgresosCatBtn.addEventListener('click', function () {
            const open = fEgresosCatMenu.classList.contains('hidden');
            setDropdownOpen(fEgresosCatMenu, open, fEgresosCatBtn);
            if (open) {
                try { const sc = document.getElementById('mov-egresos-scroll'); if (sc) sc.style.overflow = 'visible'; } catch (e) {}
                try { setDropdownOpen(fEgresosSupMenu, false, fEgresosSupBtn); } catch (e) { }
                try { fEgresosCatSearch?.focus?.(); } catch (e) { }
            } else {
                try {
                    const sc = document.getElementById('mov-egresos-scroll');
                    if (sc && (!fEgresosSupMenu || fEgresosSupMenu.classList.contains('hidden'))) sc.style.overflow = 'auto';
                } catch (e) {}
            }
        });
    }

    if (fEgresosSupBtn && fEgresosSupMenu) {
        fEgresosSupBtn.addEventListener('click', function () {
            const open = fEgresosSupMenu.classList.contains('hidden');
            setDropdownOpen(fEgresosSupMenu, open, fEgresosSupBtn);
            if (open) {
                try { const sc = document.getElementById('mov-egresos-scroll'); if (sc) sc.style.overflow = 'visible'; } catch (e) {}
                try { setDropdownOpen(fEgresosCatMenu, false, fEgresosCatBtn); } catch (e) { }
                try { fEgresosSupSearch?.focus?.(); } catch (e) { }
            } else {
                try {
                    const sc = document.getElementById('mov-egresos-scroll');
                    if (sc && (!fEgresosCatMenu || fEgresosCatMenu.classList.contains('hidden'))) sc.style.overflow = 'auto';
                } catch (e) {}
            }
        });
    }

    if (fEgresosCatSearch) {
        fEgresosCatSearch.addEventListener('input', function () { renderCatsItems(); });
    }
    if (fEgresosSupSearch) {
        fEgresosSupSearch.addEventListener('input', function () { renderSupsItems(); });
    }

    if (fEgresosCatItems) {
        fEgresosCatItems.addEventListener('change', function (ev) {
            const t = ev && ev.target ? ev.target : null;
            if (!t) return;
            if (t.classList.contains('eg-cat-all')) {
                if (egresosCatsAllSelected) {
                    egresosCatsAllSelected = false;
                    egresosCatsSelected = new Set();
                } else {
                    egresosCatsAllSelected = true;
                    egresosCatsSelected = new Set();
                }
            }
            if (t.classList.contains('eg-cat-opt')) {
                const k = String(t.getAttribute('data-k') || '').trim();
                if (!k) return;
                if (egresosCatsAllSelected) {
                    egresosCatsAllSelected = false;
                    egresosCatsSelected = new Set(egresosCatsAll.map(x => x.k));
                }
                if (t.checked) egresosCatsSelected.add(k);
                else egresosCatsSelected.delete(k);

                if (egresosCatsSelected.size >= egresosCatsAll.length) {
                    egresosCatsAllSelected = true;
                    egresosCatsSelected = new Set();
                }
            }
            updateCatsButtonLabel();
            renderCatsItems();
            try { renderEgresos(); } catch (e) { }
        });
    }

    if (fEgresosSupItems) {
        fEgresosSupItems.addEventListener('change', function (ev) {
            const t = ev && ev.target ? ev.target : null;
            if (!t) return;
            if (t.classList.contains('eg-sup-all')) {
                if (egresosSupsAllSelected) {
                    egresosSupsAllSelected = false;
                    egresosSupsSelected = new Set();
                } else {
                    egresosSupsAllSelected = true;
                    egresosSupsSelected = new Set();
                }
            }
            if (t.classList.contains('eg-sup-opt')) {
                const k = String(t.getAttribute('data-k') || '').trim();
                if (!k) return;
                if (egresosSupsAllSelected) {
                    egresosSupsAllSelected = false;
                    egresosSupsSelected = new Set(egresosSupsAll.map(x => x.k));
                }
                if (t.checked) egresosSupsSelected.add(k);
                else egresosSupsSelected.delete(k);

                if (egresosSupsSelected.size >= egresosSupsAll.length) {
                    egresosSupsAllSelected = true;
                    egresosSupsSelected = new Set();
                }
            }
            updateSupsButtonLabel();
            renderSupsItems();
            try { renderEgresos(); } catch (e) { }
        });
    }

    function initTodosMultiSelect(selectEl) {
        if (!selectEl) return;
        let internal = false;
        const allValue = '';
        const getAllOptionValues = function () {
            try {
                return Array.from(selectEl.options || [])
                    .map(o => String(o.value || ''))
                    .filter(v => v !== allValue);
            } catch (e) {
                return [];
            }
        };

        const apply = function (mode) {
            internal = true;
            try {
                const allVals = getAllOptionValues();
                const opts = Array.from(selectEl.options || []);
                if (mode === 'all') {
                    opts.forEach(o => { if (String(o.value || '') === allValue) o.selected = true; else o.selected = true; });
                } else if (mode === 'none') {
                    opts.forEach(o => { o.selected = false; });
                } else if (mode === 'sync') {
                    const selectedVals = Array.from(selectEl.selectedOptions || []).map(o => String(o.value || ''));
                    const selectedReal = selectedVals.filter(v => v !== allValue);
                    const hasAll = selectedVals.includes(allValue);
                    const allOpt = opts.find(o => String(o.value || '') === allValue);
                    if (allOpt) {
                        allOpt.selected = hasAll || (allVals.length > 0 && selectedReal.length >= allVals.length);
                    }
                }
            } catch (e) {
            }
            internal = false;
        };

        selectEl.addEventListener('change', function () {
            if (internal) return;
            const selectedVals = Array.from(selectEl.selectedOptions || []).map(o => String(o.value || ''));
            const hasAll = selectedVals.includes(allValue);
            const allVals = getAllOptionValues();
            const realSelected = selectedVals.filter(v => v !== allValue);

            if (hasAll) {
                if (realSelected.length >= allVals.length) {
                    apply('none');
                } else {
                    apply('all');
                }
            } else {
                apply('sync');
            }
        });

        apply('sync');
    }

    function resetTodosMultiSelect(selectEl) {
        if (!selectEl) return;
        try {
            const opts = Array.from(selectEl.options || []);
            const allOpt = opts.find(o => String(o.value || '') === '');
            opts.forEach(o => { o.selected = false; });
            if (allOpt) allOpt.selected = true;
        } catch (e) {
        }
    }

    document.addEventListener('click', function (ev) {
        const t = ev && ev.target ? ev.target : null;
        if (!t) return;
        try {
            if (fEgresosCatMenu && !fEgresosCatMenu.classList.contains('hidden')) {
                if (!fEgresosCatMenu.contains(t) && !fEgresosCatBtn.contains(t)) {
                    setDropdownOpen(fEgresosCatMenu, false, fEgresosCatBtn);
                    try {
                        const sc = document.getElementById('mov-egresos-scroll');
                        if (sc && (!fEgresosSupMenu || fEgresosSupMenu.classList.contains('hidden'))) sc.style.overflow = 'auto';
                    } catch (e) {}
                }
            }
        } catch (e) {
        }
        try {
            if (fEgresosSupMenu && !fEgresosSupMenu.classList.contains('hidden')) {
                if (!fEgresosSupMenu.contains(t) && !fEgresosSupBtn.contains(t)) {
                    setDropdownOpen(fEgresosSupMenu, false, fEgresosSupBtn);
                    try {
                        const sc = document.getElementById('mov-egresos-scroll');
                        if (sc && (!fEgresosCatMenu || fEgresosCatMenu.classList.contains('hidden'))) sc.style.overflow = 'auto';
                    } catch (e) {}
                }
            }
        } catch (e) {
        }
    });

    if (fVentasRange && window.flatpickr) {
        flatpickr(fVentasRange, { mode: 'range', dateFormat: 'd/m/Y', locale: window.flatpickr && window.flatpickr.l10ns ? window.flatpickr.l10ns.es : 'es', allowInput: false,
            onChange: function (d) { if (Array.isArray(d) && d.length >= 1) renderVentas(); },
            onClose: function (d) { if (Array.isArray(d) && d.length >= 1) renderVentas(); }
        });
    }
    if (fEgresosRange && window.flatpickr) {
        flatpickr(fEgresosRange, { mode: 'range', dateFormat: 'd/m/Y', locale: window.flatpickr && window.flatpickr.l10ns ? window.flatpickr.l10ns.es : 'es', allowInput: false,
            onChange: function (d) { if (Array.isArray(d) && d.length >= 1) renderEgresos(); },
            onClose: function (d) { if (Array.isArray(d) && d.length >= 1) renderEgresos(); }
        });
    }
    if (fArqueoRange && window.flatpickr) {
        flatpickr(fArqueoRange, { mode: 'range', dateFormat: 'd/m/Y', locale: window.flatpickr && window.flatpickr.l10ns ? window.flatpickr.l10ns.es : 'es', allowInput: false,
            onChange: function (d) { if (Array.isArray(d) && d.length >= 1) renderArqueo(); },
            onClose: function (d) { if (Array.isArray(d) && d.length >= 1) renderArqueo(); }
        });
    }

    if (btnExport) btnExport.addEventListener('click', openExport);
    if (btnCloseExport) btnCloseExport.addEventListener('click', closeExport);
    if (btnCancelExport) btnCancelExport.addEventListener('click', closeExport);
    if (btnExportXls) btnExportXls.addEventListener('click', function () { exportCsv(); closeExport(); });
    if (btnExportPdf) btnExportPdf.addEventListener('click', function () { exportPdfPrint(); closeExport(); });
    if (modalExport) {
        modalExport.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalExport.firstElementChild) closeExport();
        });
    }

    setTab('ventas');

    return;
});
</script>
{% endblock %}
