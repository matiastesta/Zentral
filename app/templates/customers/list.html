 {% extends 'base.html' %}
{% block title %}{{ business.label_customers if business and business.label_customers else 'Clientes' }}{% endblock %}
{% block content %}
<div class="mb-6">
    <div class="flex items-center gap-2">
        <h1 class="text-2xl font-bold text-gray-900">{{ business.label_customers if business and business.label_customers else 'Clientes' }}</h1>
        <button type="button" class="inline-flex items-center justify-center h-8 w-8 rounded-md hover:bg-gray-100 text-gray-600" data-kpi-toggle="customers" data-kpi-key="customers" data-kpi-target="#kpi-section-customers" aria-expanded="true" aria-label="Mostrar/ocultar KPIs">
            <i data-kpi-toggle-icon class="fas fa-chevron-down"></i>
        </button>
    </div>
    <p class="mt-1 text-sm text-gray-600">Centraliza la información de tus {{ label_customers|lower }} para mejorar el seguimiento y la fidelización.</p>
</div>

<!-- Resumen de clientes -->
<div id="kpi-section-customers" class="grid grid-cols-1 gap-4 mb-6 md:grid-cols-4">
    <div class="p-4 bg-white rounded-lg shadow border border-gray-200">
        <div class="h-full flex flex-col items-center justify-center text-center">
            <div class="h-10 w-10 rounded-full bg-indigo-50 text-indigo-700 flex items-center justify-center">
                <i class="fas fa-users text-sm"></i>
            </div>
            <p class="mt-2 text-sm font-medium text-gray-500">Total de {{ label_customers|lower }} registrados</p>
            <p id="kpi-clientes-total" class="mt-2 text-2xl font-semibold text-gray-900">0</p>
        </div>
    </div>
    <div class="p-4 bg-white rounded-lg shadow border border-gray-200">
        <div class="h-full flex flex-col items-center justify-center text-center">
            <div class="h-10 w-10 rounded-full bg-green-50 text-green-700 flex items-center justify-center">
                <i class="fas fa-user-check text-sm"></i>
            </div>
            <p class="mt-2 text-sm font-medium text-gray-500">{{ label_customers }} activos</p>
            <p id="kpi-clientes-activos" class="mt-2 text-2xl font-semibold text-gray-900">0</p>
        </div>
    </div>
    <div class="p-4 bg-white rounded-lg shadow border border-gray-200">
        <div class="h-full flex flex-col items-center justify-center text-center">
            <div class="h-10 w-10 rounded-full bg-amber-50 text-amber-800 flex items-center justify-center">
                <i class="fas fa-exclamation-triangle text-sm"></i>
            </div>
            <p class="mt-2 text-sm font-medium text-gray-500">{{ label_customers }} deudores</p>
            <p id="kpi-clientes-deudores" class="mt-2 text-2xl font-semibold text-gray-900">0</p>
            <div id="kpi-clientes-deudores-sub" class="mt-1 text-xs text-gray-500"></div>
        </div>
    </div>
    <div class="p-4 bg-white rounded-lg shadow border border-gray-200">
        <div class="h-full flex flex-col items-center justify-center text-center">
            <div class="h-10 w-10 rounded-full bg-red-50 text-red-700 flex items-center justify-center">
                <i class="fas fa-dollar-sign text-sm"></i>
            </div>
            <p class="mt-2 text-sm font-medium text-gray-500">Deuda total</p>
            <p id="kpi-clientes-deuda" class="mt-2 text-2xl font-semibold text-gray-900">$0,00</p>
        </div>
    </div>
</div>

<!-- Tabla de clientes -->
<div class="bg-white rounded-lg shadow border border-gray-200 overflow-visible">
    <div class="px-4 py-3 border-b border-gray-100 flex items-start justify-between gap-3">
        <div>
            <h2 class="text-sm font-semibold text-gray-900">Listado de {{ label_customers|lower }}</h2>
            <p class="text-xs text-gray-500">Visualizá el historial comercial y el estado de cuenta corriente. Usá los filtros para segmentar por clasificación y saldo.</p>
        </div>
        <div class="flex gap-2 justify-end">
            <button id="btn-config-alertas" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-gray-100 rounded-md hover:bg-gray-200">
                <i class="fas fa-sliders-h mr-2"></i> Configuración de CRM
            </button>
            <button id="btn-nuevo-cliente" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                <i class="fas fa-user-plus mr-2"></i> Nuevo cliente
            </button>
        </div>
    </div>
    <table class="min-w-full table-fixed divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th data-sort="nombre" class="w-72 px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase cursor-pointer select-none">Nombre y apellido</th>
                <th data-sort="clasificacion" class="w-40 px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase cursor-pointer select-none"><span id="clientes-th-clas-label">Clasificación</span></th>
                <th data-sort="cantidad_compras" class="w-28 px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase cursor-pointer select-none">Compras</th>
                <th data-sort="monto_total_comprado" class="w-32 px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase cursor-pointer select-none">Monto</th>
                <th data-sort="saldo_actual" class="w-44 px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase cursor-pointer select-none">Cuenta corriente</th>
                <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Notas</th>
                <th class="w-14 px-4 py-3"></th>
            </tr>
            <tr class="text-[11px] bg-white align-middle">
                <th class="px-4 py-1">
                    <input id="clientes-search" type="text" placeholder="Nombre, email o teléfono" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600">
                </th>
                <th class="px-4 py-1">
                    <div class="relative">
                        <button id="clientes-filter-clasificacion-btn" type="button" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white text-left">Clasificación: todas</button>
                        <div id="clientes-filter-clasificacion-menu" class="hidden absolute left-0 mt-1 w-72 rounded-md border border-gray-200 bg-white shadow-lg z-20">
                            <div id="clientes-filter-clasificacion-items" class="max-h-56 overflow-auto py-1"></div>
                        </div>
                    </div>
                </th>
                <th class="px-4 py-1"></th>
                <th class="px-4 py-1"></th>
                <th class="px-4 py-1">
                    <div class="relative">
                        <button id="clientes-filter-cc-btn" type="button" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white text-left">Cuenta corriente: todas</button>
                        <div id="clientes-filter-cc-menu" class="hidden absolute left-0 mt-1 w-72 rounded-md border border-gray-200 bg-white shadow-lg z-20">
                            <div id="clientes-filter-cc-items" class="max-h-56 overflow-auto py-1"></div>
                        </div>
                    </div>
                </th>
                <th class="px-4 py-1"></th>
                <th class="px-4 py-1"></th>
            </tr>
        </thead>
        <tbody id="clientes-tbody" class="bg-white divide-y divide-gray-200">
            <tr>
                <td colspan="7" class="px-4 py-6 text-sm text-center text-gray-500">Cargando...</td>
            </tr>
        </tbody>
    </table>
</div>

<div id="modal-customer-form" class="hidden fixed inset-0 z-50" style="z-index:70;">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 id="customer-form-title" class="text-base font-semibold text-gray-900">Nuevo cliente</h3>
                    <p class="text-xs text-gray-500">Los campos obligatorios son: nombre, apellido y teléfono.</p>
                </div>
                <button id="btn-close-customer-form" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Nombre</label>
                    <input id="cust-first-name" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Apellido</label>
                    <input id="cust-last-name" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Teléfono</label>
                    <input id="cust-phone" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Email (opcional)</label>
                    <input id="cust-email" type="email" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Fecha de Nacimiento (opcional)</label>
                    <input id="cust-birthday" type="date" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs font-medium text-gray-600 mb-1">Dirección (opcional)</label>
                    <input id="cust-address" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs font-medium text-gray-600 mb-1">Observaciones internas (opcional)</label>
                    <textarea id="cust-notes" rows="3" class="w-full px-3 py-2 text-sm border rounded-md" placeholder=""></textarea>
                </div>
                <div id="msg-customer-form-error" class="md:col-span-2 text-[11px] text-red-600 hidden flex items-center gap-1"><i class="fas fa-exclamation-circle"></i><span>Completá nombre, apellido y teléfono.</span></div>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                <button id="btn-cancel-customer-form" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="btn-save-customer-form" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md bg-blue-600 hover:bg-blue-700">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-alerts" class="hidden fixed inset-0 z-50" style="z-index:70;">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-start justify-center p-4 overflow-y-auto">
        <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden flex flex-col my-4" style="max-height: calc(100vh - 2rem);">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Configuración de CRM</h3>
                    <p class="text-xs text-gray-500">Ajustá reglas de clasificación y alertas de cuenta corriente.</p>
                </div>
                <button id="btn-close-alerts" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 space-y-4 overflow-y-auto flex-1">
                <div class="p-3 border border-gray-200 rounded-xl bg-gray-50">
                    <div class="text-sm font-semibold text-gray-900">Clasificación de clientes</div>
                    <div class="mt-1 text-[11px] text-gray-500">Reglas basadas en compras recientes. El cliente “Mejor” siempre exige más compras que “Frecuente”.</div>
                    <div class="mt-2 p-3 rounded-lg border border-amber-200 bg-amber-50 text-[11px] text-amber-900">
                        La condición de Deudor / Deudor crítico tiene prioridad absoluta sobre las clasificaciones comerciales. Mientras exista deuda, el cliente será considerado deudor independientemente de sus compras.
                    </div>
                    <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Ventana de compra (días)</label>
                            <input id="crm-recent-days" type="number" min="1" class="w-full px-3 py-2 text-sm border rounded-md" value="60">
                            <div class="mt-1 text-[11px] text-gray-500">Ej.: 60 días = últimos 2 meses aprox.</div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Frecuente: compras mínimas</label>
                            <input id="crm-freq-min" type="number" min="1" class="w-full px-3 py-2 text-sm border rounded-md" value="1">
                            <div class="mt-1 text-[11px] text-gray-500">Si el cliente cumple esto en la ventana, es “Frecuente”.</div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Mejor cliente: compras mínimas</label>
                            <input id="crm-best-min" type="number" min="1" class="w-full px-3 py-2 text-sm border rounded-md" value="2">
                            <div class="mt-1 text-[11px] text-gray-500">Debe ser mayor que “Frecuente”.</div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Título (columna)</label>
                            <input id="crm-label-clas-title" type="text" class="w-full px-3 py-2 text-sm border rounded-md" value="Clasificación">
                            <div class="mt-1 text-[11px] text-gray-500">Se muestra como título en la tabla.</div>
                        </div>
                    </div>

                    <div class="mt-3 p-3 border border-gray-200 rounded-lg bg-white">
                        <div class="flex items-start justify-between gap-3">
                            <div>
                                <div class="text-sm font-semibold text-gray-900">Vista previa</div>
                                <div class="text-[11px] text-gray-500">Así se interpretan las reglas con tus valores actuales.</div>
                            </div>
                            <div class="h-8 w-8 rounded-full bg-gray-100 text-gray-600 flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-eye text-xs"></i>
                            </div>
                        </div>
                        <div id="crm-preview" class="mt-3 text-[11px] text-gray-700"></div>
                    </div>
                </div>

                <div class="pt-2 border-t border-gray-100">
                    <div class="p-3 border border-gray-200 rounded-xl bg-gray-50">
                        <div class="text-xs font-semibold text-gray-800">Nombres de clasificaciones</div>
                        <div class="mt-1 text-[11px] text-gray-500">Estos nombres se ven en la tabla y en el filtro de clasificación.</div>
                        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Mejor cliente</label>
                                <input id="crm-label-best" type="text" class="w-full px-3 py-2 text-sm border rounded-md" value="Mejor cliente">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Frecuente</label>
                                <input id="crm-label-freq" type="text" class="w-full px-3 py-2 text-sm border rounded-md" value="Frecuente">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Inactivo</label>
                                <input id="crm-label-inactive" type="text" class="w-full px-3 py-2 text-sm border rounded-md" value="Inactivo">
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Deudor</label>
                                <input id="crm-label-debtor" type="text" class="w-full px-3 py-2 text-sm border rounded-md" value="Deudor">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-3 border border-gray-200 rounded-xl bg-gray-50">
                    <div class="text-sm font-semibold text-gray-900">Alertas</div>
                    <div class="mt-1 text-[11px] text-gray-500">Estas alertas se aplican sobre la cuenta corriente (según días de deuda).</div>
                    <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Cuenta corriente vencida</label>
                            <div class="flex items-center gap-2">
                                <input id="crm-debt-overdue-days" type="number" min="1" class="w-full px-3 py-2 text-sm border rounded-md" value="30">
                                <span class="text-xs text-gray-500">días</span>
                            </div>
                            <div class="mt-1 text-[11px] text-gray-500">Se considera “vencida” si supera este valor.</div>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Cuenta corriente vencida crítica</label>
                            <div class="flex items-center gap-2">
                                <input id="crm-debt-critical-days" type="number" min="1" class="w-full px-3 py-2 text-sm border rounded-md" value="60">
                                <span class="text-xs text-gray-500">días</span>
                            </div>
                            <div class="mt-1 text-[11px] text-gray-500">Debe ser mayor que “vencida”.</div>
                        </div>
                    </div>
                </div>

                <div id="crm-config-error" class="hidden p-3 rounded-lg border border-red-200 bg-red-50 text-[11px] text-red-700"></div>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2 bg-white">
                <button id="btn-cancel-alerts" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="btn-save-alerts" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md bg-blue-600 hover:bg-blue-700">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-customer-legajo" class="hidden fixed inset-0 z-50" style="z-index:60;">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div class="min-w-0">
                    <h3 id="legajo-title" class="text-base font-semibold text-gray-900 truncate">Legajo del cliente</h3>
                    <p id="legajo-subtitle" class="text-xs text-gray-500 truncate">—</p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="btn-edit-legajo" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-blue-700 bg-blue-50 rounded-md hover:bg-blue-100">
                        <i class="fas fa-pen mr-2"></i> Editar
                    </button>
                    <button id="btn-close-legajo" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <div class="p-5 space-y-4">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                    <div class="p-4 border border-gray-200 rounded-xl bg-white">
                        <div class="text-xs font-semibold text-gray-700">Datos</div>
                        <div class="mt-2 space-y-1 text-sm text-gray-800">
                            <div><span class="text-gray-500">Nombre:</span> <span id="legajo-fullname">—</span></div>
                            <div><span class="text-gray-500">Teléfono:</span> <span id="legajo-phone">—</span></div>
                            <div><span class="text-gray-500">Email:</span> <span id="legajo-email">—</span></div>
                            <div><span class="text-gray-500">Incorporación:</span> <span id="legajo-join">—</span></div>
                            <div><span class="text-gray-500">Fecha de Nacimiento:</span> <span id="legajo-bday">—</span></div>
                            <div><span class="text-gray-500">Dirección:</span> <span id="legajo-address">—</span></div>
                        </div>
                    </div>

                    <div class="p-4 border border-gray-200 rounded-xl bg-white">
                        <div class="text-xs font-semibold text-gray-700">CRM</div>
                        <div class="mt-2 space-y-1 text-sm text-gray-800">
                            <div><span class="text-gray-500">Clasificación:</span> <span id="legajo-clas">—</span></div>
                            <div><span class="text-gray-500">Compras:</span> <span id="legajo-compras">—</span></div>
                            <div><span class="text-gray-500">Monto total:</span> <span id="legajo-monto">—</span></div>
                            <div><span class="text-gray-500">Última compra:</span> <span id="legajo-ultima">—</span></div>
                            <div><span class="text-gray-500">Frecuencia:</span> <span id="legajo-freq">—</span></div>
                        </div>
                    </div>

                    <div class="p-4 border border-gray-200 rounded-xl bg-white">
                        <div class="text-xs font-semibold text-gray-700">Cuenta corriente</div>
                        <div class="mt-2 space-y-1 text-sm text-gray-800">
                            <div><span class="text-gray-500">Tiene CC:</span> <span id="legajo-cc">—</span></div>
                            <div><span class="text-gray-500">Saldo actual:</span> <span id="legajo-saldo">—</span></div>
                            <div><span class="text-gray-500">Días de deuda:</span> <span id="legajo-dias">—</span></div>
                            <div><span class="text-gray-500">Alerta:</span> <span id="legajo-alerta">—</span></div>
                        </div>
                    </div>
                </div>

                <div class="p-4 border border-gray-200 rounded-xl bg-white">
                    <div class="flex items-center justify-between gap-2">
                        <div>
                            <div class="text-xs font-semibold text-gray-700">Últimas compras</div>
                            <div class="text-[11px] text-gray-500">Se muestran las últimas ventas asociadas al cliente.</div>
                        </div>
                    </div>
                    <div class="mt-3 overflow-hidden border border-gray-200 rounded-lg">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Fecha</th>
                                    <th class="px-3 py-2 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Pago</th>
                                    <th class="px-3 py-2 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Total</th>
                                    <th class="px-3 py-2 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Adeudado</th>
                                </tr>
                            </thead>
                            <tbody id="legajo-sales" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td colspan="4" class="px-3 py-4 text-sm text-gray-500 text-center">—</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="p-4 border border-gray-200 rounded-xl bg-white">
                    <div class="text-xs font-semibold text-gray-700">Observaciones internas</div>
                    <div id="legajo-notes" class="mt-2 text-sm text-gray-700 whitespace-pre-wrap">—</div>
                </div>
            </div>

            <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                <button id="btn-close-legajo-2" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-settle-debt" class="hidden fixed inset-0 z-50" style="z-index:70;">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Saldar deuda</h3>
                    <p id="settle-subtitle" class="text-xs text-gray-500">—</p>
                </div>
                <button id="btn-close-settle" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 space-y-3">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Venta adeudada</label>
                    <select id="settle-sale" class="w-full px-3 py-2 text-sm border rounded-md bg-white"></select>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="p-3 border border-gray-200 rounded-lg">
                        <div class="text-[11px] text-gray-500">Deuda a saldar</div>
                        <div id="settle-amount" class="mt-1 text-sm font-semibold text-red-700">$0,00</div>
                    </div>
                    <div class="p-3 border border-gray-200 rounded-lg">
                        <div class="text-[11px] text-gray-500">Medio de pago</div>
                        <select id="settle-method" class="mt-2 w-full px-3 py-2 text-sm border rounded-md bg-white">
                            <option value="Efectivo">Efectivo</option>
                            <option value="Transferencia">Transferencia</option>
                            <option value="Débito">Débito</option>
                            <option value="Crédito">Crédito</option>
                        </select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Monto a pagar</label>
                    <input id="settle-pay-amount" type="number" min="0" step="0.01" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                    <div class="mt-1 text-[11px] text-gray-500">Podés pagar el total o un monto parcial (se descuenta de la deuda).</div>
                </div>
                <div id="settle-error" class="text-[11px] text-red-600 hidden flex items-center gap-1"><i class="fas fa-exclamation-circle"></i><span>Seleccioná una venta válida.</span></div>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                <button id="btn-cancel-settle" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="btn-confirm-settle" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md bg-blue-600 hover:bg-blue-700">Confirmar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const KEY_CRM = 'clientes_crm_config';
    const KEY_ALERTS = 'clientes_alertas_config';

    const kpiTotal = document.getElementById('kpi-clientes-total');
    const kpiActivos = document.getElementById('kpi-clientes-activos');
    const kpiDeudores = document.getElementById('kpi-clientes-deudores');
    const kpiDeuda = document.getElementById('kpi-clientes-deuda');
    const kpiDeudoresSub = document.getElementById('kpi-clientes-deudores-sub');

    const inputSearch = document.getElementById('clientes-search');
    const filterClasBtn = document.getElementById('clientes-filter-clasificacion-btn');
    const filterClasMenu = document.getElementById('clientes-filter-clasificacion-menu');
    const filterClasItems = document.getElementById('clientes-filter-clasificacion-items');
    const filterCcBtn = document.getElementById('clientes-filter-cc-btn');
    const filterCcMenu = document.getElementById('clientes-filter-cc-menu');
    const filterCcItems = document.getElementById('clientes-filter-cc-items');
    const tbody = document.getElementById('clientes-tbody');
    const btnNuevo = document.getElementById('btn-nuevo-cliente');
    const btnConfigAlertas = document.getElementById('btn-config-alertas');

    const modalForm = document.getElementById('modal-customer-form');
    const titleForm = document.getElementById('customer-form-title');
    const btnCloseForm = document.getElementById('btn-close-customer-form');
    const btnCancelForm = document.getElementById('btn-cancel-customer-form');
    const btnSaveForm = document.getElementById('btn-save-customer-form');
    const msgFormError = document.getElementById('msg-customer-form-error');
    const inputFirst = document.getElementById('cust-first-name');
    const inputLast = document.getElementById('cust-last-name');
    const inputPhone = document.getElementById('cust-phone');
    const inputEmail = document.getElementById('cust-email');
    const inputBirthday = document.getElementById('cust-birthday');
    const inputAddress = document.getElementById('cust-address');
    const inputNotes = document.getElementById('cust-notes');

    const modalAlerts = document.getElementById('modal-alerts');
    const btnCloseAlerts = document.getElementById('btn-close-alerts');
    const btnCancelAlerts = document.getElementById('btn-cancel-alerts');
    const btnSaveAlerts = document.getElementById('btn-save-alerts');
    const inputCrmRecentDays = document.getElementById('crm-recent-days');
    const inputCrmDebtOverdueDays = document.getElementById('crm-debt-overdue-days');
    const inputCrmDebtCriticalDays = document.getElementById('crm-debt-critical-days');
    const inputCrmFreqMin = document.getElementById('crm-freq-min');
    const inputCrmBestMin = document.getElementById('crm-best-min');
    const inputCrmLabelClasTitle = document.getElementById('crm-label-clas-title');
    const inputCrmLabelBest = document.getElementById('crm-label-best');
    const inputCrmLabelFreq = document.getElementById('crm-label-freq');
    const inputCrmLabelInactive = document.getElementById('crm-label-inactive');
    const inputCrmLabelDebtor = document.getElementById('crm-label-debtor');

    const crmPreview = document.getElementById('crm-preview');
    const crmConfigError = document.getElementById('crm-config-error');

    const thClasLabel = document.getElementById('clientes-th-clas-label');

    const modalLegajo = document.getElementById('modal-customer-legajo');
    const btnCloseLegajo = document.getElementById('btn-close-legajo');
    const btnCloseLegajo2 = document.getElementById('btn-close-legajo-2');
    const btnEditLegajo = document.getElementById('btn-edit-legajo');
    const legajoTitle = document.getElementById('legajo-title');
    const legajoSubtitle = document.getElementById('legajo-subtitle');
    const legajoFullname = document.getElementById('legajo-fullname');
    const legajoPhone = document.getElementById('legajo-phone');
    const legajoEmail = document.getElementById('legajo-email');
    const legajoJoin = document.getElementById('legajo-join');
    const legajoBday = document.getElementById('legajo-bday');
    const legajoAddress = document.getElementById('legajo-address');
    const legajoClas = document.getElementById('legajo-clas');
    const legajoCompras = document.getElementById('legajo-compras');
    const legajoMonto = document.getElementById('legajo-monto');
    const legajoUltima = document.getElementById('legajo-ultima');
    const legajoFreq = document.getElementById('legajo-freq');
    const legajoCc = document.getElementById('legajo-cc');
    const legajoSaldo = document.getElementById('legajo-saldo');
    const legajoDias = document.getElementById('legajo-dias');
    const legajoAlerta = document.getElementById('legajo-alerta');
    const legajoSales = document.getElementById('legajo-sales');
    const legajoNotes = document.getElementById('legajo-notes');

    const modalSettle = document.getElementById('modal-settle-debt');
    const btnCloseSettle = document.getElementById('btn-close-settle');
    const btnCancelSettle = document.getElementById('btn-cancel-settle');
    const btnConfirmSettle = document.getElementById('btn-confirm-settle');
    const settleSubtitle = document.getElementById('settle-subtitle');
    const settleSale = document.getElementById('settle-sale');
    const settleAmount = document.getElementById('settle-amount');
    const settleMethod = document.getElementById('settle-method');
    const settlePayAmount = document.getElementById('settle-pay-amount');
    const settleError = document.getElementById('settle-error');

    let cacheCustomers = [];
    let cacheSales = [];
    let editingCustomerId = null;
    let sortKey = 'monto_total_comprado';
    let sortDir = 'desc';
    let lastDerived = [];
    let legajoCustomerId = null;
    let settleCustomerId = null;

    function isPromise(x) { return !!x && typeof x.then === 'function'; }
    function ensureArray(x) { return Array.isArray(x) ? x : []; }
    function safeStr(v) { return String(v == null ? '' : v); }

    function normKey(v) {
        return safeStr(v).replace(/\s+/g, ' ').trim().toLowerCase();
    }

    function setDropdownOpen(menu, open) {
        if (!menu) return;
        menu.classList.toggle('hidden', !open);
    }

    let clasTitle = 'Clasificación';
    let clasOpts = [
        { k: 'deudor_critico', label: 'Deudor crítico' },
        { k: 'deudor', label: 'Deudor' },
        { k: 'mejor_cliente', label: 'Mejor cliente' },
        { k: 'frecuente', label: 'Frecuente' },
        { k: 'inactivo', label: 'Inactivo' },
    ];
    const ccOpts = [
        { k: 'al_dia', label: 'Cuenta corriente al día' },
        { k: 'vencida', label: 'Cuenta corriente vencida' },
        { k: 'vencida_critica', label: 'Cuenta corriente vencida crítica' },
        { k: 'sin_cc', label: 'Sin cuenta corriente' },
    ];

    let clasSelected = new Set();
    let ccSelected = new Set();

    let clasAllMode = true;
    let ccAllMode = true;

    function formatMultiLabel(allText, opts, selectedSet, pluralWord, allMode) {
        const selCount = selectedSet.size;
        if (allMode) return allText;
        if (!selCount) return allText;
        if (selCount === 1) {
            const k = Array.from(selectedSet)[0];
            const match = (Array.isArray(opts) ? opts : []).find(x => x.k === k);
            return match ? match.label : ('1 ' + String(pluralWord || 'seleccionado'));
        }
        return String(selCount) + ' ' + String(pluralWord || 'seleccionados');
    }

    function renderMultiselectItems(container, allLabel, opts, selectedSet, clsAll, clsOpt, allMode) {
        if (!container) return;
        const total = opts.length;
        const allOn = !!allMode;
        const html = [];
        html.push('<label class="flex items-center gap-2 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 cursor-pointer">'
            + '<input type="checkbox" class="' + clsAll + '" ' + (allOn ? 'checked' : '') + ' />'
            + '<span>' + allLabel + '</span>'
            + '</label>');
        opts.forEach(function (it) {
            const checked = allOn ? true : selectedSet.has(it.k);
            html.push('<label class="flex items-center gap-2 px-3 py-2 text-xs text-gray-700 hover:bg-gray-50 cursor-pointer">'
                + '<input type="checkbox" class="' + clsOpt + '" data-k="' + String(it.k).replace(/"/g, '&quot;') + '" ' + (checked ? 'checked' : '') + ' />'
                + '<span class="truncate">' + safeStr(it.label) + '</span>'
                + '</label>');
        });
        container.innerHTML = html.join('');
    }

    function syncCustomersFilterButtons() {
        if (filterClasBtn) {
            filterClasBtn.textContent = formatMultiLabel(clasTitle + ': todas', clasOpts, clasSelected, 'seleccionadas', clasAllMode);
        }
        if (filterCcBtn) {
            filterCcBtn.textContent = formatMultiLabel('Cuenta corriente: todas', ccOpts, ccSelected, 'seleccionadas', ccAllMode);
        }
    }

    function setCrmError(msg) {
        if (!crmConfigError) return;
        const m = safeStr(msg).trim();
        if (!m) {
            crmConfigError.textContent = '';
            crmConfigError.classList.add('hidden');
            return;
        }
        crmConfigError.textContent = m;
        crmConfigError.classList.remove('hidden');
    }

    function readCrmFormValues() {
        const recentDays = Math.max(1, parseInt(inputCrmRecentDays?.value || 60, 10) || 60);
        const overdueDays = Math.max(1, parseInt(inputCrmDebtOverdueDays?.value || 30, 10) || 30);
        const criticalDays = Math.max(overdueDays, parseInt(inputCrmDebtCriticalDays?.value || 60, 10) || 60);
        const freqMin = Math.max(1, parseInt(inputCrmFreqMin?.value || 1, 10) || 1);
        const bestMin = Math.max(1, parseInt(inputCrmBestMin?.value || 2, 10) || 2);
        const labels = {
            clas_title: safeStr(inputCrmLabelClasTitle?.value || 'Clasificación').trim() || 'Clasificación',
            best: safeStr(inputCrmLabelBest?.value || 'Mejor cliente').trim() || 'Mejor cliente',
            freq: safeStr(inputCrmLabelFreq?.value || 'Frecuente').trim() || 'Frecuente',
            inactive: safeStr(inputCrmLabelInactive?.value || 'Inactivo').trim() || 'Inactivo',
            debtor: safeStr(inputCrmLabelDebtor?.value || 'Deudor').trim() || 'Deudor',
        };
        return {
            recent_days: recentDays,
            debt_overdue_days: overdueDays,
            debt_critical_days: criticalDays,
            freq_min_purchases: freqMin,
            best_min_purchases: bestMin,
            labels
        };
    }

    function validateCrmConfig(cfg) {
        const c = cfg && typeof cfg === 'object' ? cfg : readCrmFormValues();
        if (!(c.best_min_purchases > c.freq_min_purchases)) {
            return 'Para evitar solapamientos: "Mejor cliente: compras mínimas" debe ser mayor que "Frecuente: compras mínimas".';
        }
        if (!(c.debt_critical_days > c.debt_overdue_days)) {
            return 'Para evitar solapamientos: "Vencida crítica" debe ser mayor que "Vencida".';
        }
        if (!safeStr(c.labels?.clas_title).trim()) return 'El título de clasificación no puede estar vacío.';
        if (!safeStr(c.labels?.best).trim()) return 'El nombre de "Mejor cliente" no puede estar vacío.';
        if (!safeStr(c.labels?.freq).trim()) return 'El nombre de "Frecuente" no puede estar vacío.';
        if (!safeStr(c.labels?.inactive).trim()) return 'El nombre de "Inactivo" no puede estar vacío.';
        if (!safeStr(c.labels?.debtor).trim()) return 'El nombre de "Deudor" no puede estar vacío.';
        return '';
    }

    function renderCrmPreview(cfg) {
        if (!crmPreview) return;
        const c = cfg && typeof cfg === 'object' ? cfg : readCrmFormValues();
        const title = safeStr(c.labels?.clas_title || 'Clasificación') || 'Clasificación';
        const best = safeStr(c.labels?.best || 'Mejor cliente') || 'Mejor cliente';
        const freq = safeStr(c.labels?.freq || 'Frecuente') || 'Frecuente';
        const inactive = safeStr(c.labels?.inactive || 'Inactivo') || 'Inactivo';
        const debtor = safeStr(c.labels?.debtor || 'Deudor') || 'Deudor';

        const rows = [
            { k: debtor, c1: 'Con deuda (saldo > 0)', c2: 'Crítica si >= ' + safeStr(c.debt_critical_days) + ' días' },
            { k: best, c1: '>= ' + safeStr(c.best_min_purchases) + ' compras en ' + safeStr(c.recent_days) + ' días', c2: 'Sin deuda' },
            { k: freq, c1: '>= ' + safeStr(c.freq_min_purchases) + ' compras en ' + safeStr(c.recent_days) + ' días', c2: 'Sin deuda' },
            { k: inactive, c1: 'No cumple Mejor/Frecuente', c2: 'Sin deuda y sin actividad reciente' },
        ];

        const html = [];
        html.push('<div class="overflow-x-auto">');
        html.push('<table class="min-w-full text-[11px] border border-gray-200 rounded-md overflow-hidden">');
        html.push('<thead class="bg-gray-50">');
        html.push('<tr>'
            + '<th class="px-2 py-2 text-left font-semibold text-gray-600">' + safeStr(title) + '</th>'
            + '<th class="px-2 py-2 text-left font-semibold text-gray-600">1ra condición</th>'
            + '<th class="px-2 py-2 text-left font-semibold text-gray-600">2da condición</th>'
            + '</tr>');
        html.push('</thead>');
        html.push('<tbody class="bg-white">');
        rows.forEach(function (r, idx) {
            const rowCls = (idx % 2 === 0) ? 'bg-white' : 'bg-gray-50/50';
            html.push('<tr class="' + rowCls + '">'
                + '<td class="px-2 py-2 font-medium text-gray-800">' + safeStr(r.k) + '</td>'
                + '<td class="px-2 py-2 text-gray-700">' + safeStr(r.c1) + '</td>'
                + '<td class="px-2 py-2 text-gray-700">' + safeStr(r.c2) + '</td>'
                + '</tr>');
        });
        html.push('</tbody></table></div>');
        crmPreview.innerHTML = html.join('');

        try {
            if (filterClasBtn) filterClasBtn.textContent = safeStr(title) + ': todas';
        } catch (e) {
        }
    }

    function openModal(el) { if (el) el.classList.remove('hidden'); }
    function closeModal(el) { if (el) el.classList.add('hidden'); }

    function readCrmConfig() {
        try {
            const raw = window.localStorage.getItem(KEY_CRM);
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && typeof parsed === 'object') {
                const overdue = Math.max(1, parseInt(parsed.debt_overdue_days || 30, 10) || 30);
                const critical = Math.max(overdue, parseInt(parsed.debt_critical_days || 60, 10) || 60);
                return {
                    recent_days: Math.max(1, parseInt(parsed.recent_days || 60, 10) || 60),
                    debt_overdue_days: overdue,
                    debt_critical_days: critical,
                    freq_min_purchases: Math.max(1, parseInt(parsed.freq_min_purchases || 1, 10) || 1),
                    best_min_purchases: Math.max(1, parseInt(parsed.best_min_purchases || 2, 10) || 2),
                    labels: {
                        clas_title: safeStr(parsed.labels?.clas_title || 'Clasificación') || 'Clasificación',
                        best: safeStr(parsed.labels?.best || 'Mejor cliente') || 'Mejor cliente',
                        freq: safeStr(parsed.labels?.freq || 'Frecuente') || 'Frecuente',
                        inactive: safeStr(parsed.labels?.inactive || 'Inactivo') || 'Inactivo',
                        debtor: safeStr(parsed.labels?.debtor || 'Deudor') || 'Deudor'
                    }
                };
            }
        } catch (e) {
        }

        // Migración desde config anterior de alertas (si existe)
        try {
            const rawOld = window.localStorage.getItem(KEY_ALERTS);
            const old = rawOld ? JSON.parse(rawOld) : null;
            const overdue = Math.max(1, parseInt(old?.warn15 || old?.warn10 || 15, 10) || 15);
            const critical = Math.max(overdue, parseInt(old?.crit30 || 30, 10) || 30);
            return {
                recent_days: 60,
                debt_overdue_days: overdue,
                debt_critical_days: critical,
                freq_min_purchases: 1,
                best_min_purchases: 2,
                labels: { clas_title: 'Clasificación', best: 'Mejor cliente', freq: 'Frecuente', inactive: 'Inactivo', debtor: 'Deudor' }
            };
        } catch (e) {
        }

        return {
            recent_days: 60,
            debt_overdue_days: 30,
            debt_critical_days: 60,
            freq_min_purchases: 1,
            best_min_purchases: 2,
            labels: { clas_title: 'Clasificación', best: 'Mejor cliente', freq: 'Frecuente', inactive: 'Inactivo', debtor: 'Deudor', debtor_critical: 'Deudor crítico' }
        };
    }

    function writeCrmConfig(cfg) {
        try {
            window.localStorage.setItem(KEY_CRM, JSON.stringify(cfg));
        } catch (e) {
        }
    }

    function apiGetCrmConfig() {
        return fetch('/customers/api/crm-config', { method: 'GET', credentials: 'same-origin' })
            .then(r => r.json())
            .then(function (res) {
                if (res && res.ok === true && res.item && typeof res.item === 'object') return res.item;
                return null;
            })
            .catch(function () { return null; });
    }

    function apiSaveCrmConfig(cfg) {
        const payload = cfg && typeof cfg === 'object' ? cfg : readCrmFormValues();
        return fetch('/customers/api/crm-config', {
            method: 'PUT',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(r => r.json()).then(function (res) {
            if (res && res.ok === true && res.item && typeof res.item === 'object') return res.item;
            return null;
        }).catch(function () { return null; });
    }

    let crmCfgCache = null;
    function getCrmCfg() {
        if (!crmCfgCache) crmCfgCache = readCrmConfig();
        return crmCfgCache;
    }
    function setCrmCfg(cfg) {
        crmCfgCache = cfg && typeof cfg === 'object' ? cfg : null;
    }

    function refreshCrmCfgFromApi() {
        return apiGetCrmConfig().then(function (cfg) {
            if (!cfg) return null;
            try {
                writeCrmConfig(cfg);
            } catch (e) {
            }
            setCrmCfg(cfg);
            applyCrmLabelsToUi(cfg);
            return cfg;
        });
    }

    function saveSales(list) {
        const payload = ensureArray(list);
        try {
            if (window.StorageService && typeof window.StorageService.saveSales === 'function') {
                return window.StorageService.saveSales(payload);
            }
        } catch (e) {
        }
        return null;
    }

    function apiSettleDebt(opts) {
        const payload = opts && typeof opts === 'object' ? opts : {};
        return fetch('/sales/api/sales/settle', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(r => r.json());
    }

    function truncateText(s, max) {
        const txt = safeStr(s);
        const m = parseInt(max || 80, 10) || 80;
        if (txt.length <= m) return txt;
        return txt.slice(0, m - 1) + '…';
    }

    function closeAllRowMenus() {
        const menus = document.querySelectorAll('.menu-cliente-acciones');
        menus.forEach(m => m.classList.add('hidden'));
    }

    function salesForCustomer(customer) {
        const cid = safeStr(customer?.id);
        const fullName = safeStr(customer?.full_name).trim();
        const list = ensureArray(cacheSales).filter(s => {
            const sid = safeStr(s?.customer_id);
            if (sid && cid && sid === cid) return true;
            if (!sid && fullName) return safeStr(s?.customer_name).toLowerCase() === fullName.toLowerCase();
            return false;
        });
        return list.slice().sort((a, b) => {
            const ta = parseDateToTs(a?.fecha) || (parseInt(a?.created_at || 0, 10) || 0);
            const tb = parseDateToTs(b?.fecha) || (parseInt(b?.created_at || 0, 10) || 0);
            return (tb || 0) - (ta || 0);
        });
    }

    function openLegajo(id) {
        const derived = ensureArray(lastDerived).length ? lastDerived : computeDerived(cacheCustomers, cacheSales);
        const c = ensureArray(derived).find(x => safeStr(x.id) === safeStr(id));
        if (!c) return;

        legajoCustomerId = safeStr(c.id);

        const joinDateRaw = new Date(c.created_at || Date.now()).toISOString().slice(0, 10);
        const joinDate = (window.formatFechaDisplay && typeof window.formatFechaDisplay === 'function')
            ? window.formatFechaDisplay(joinDateRaw)
            : joinDateRaw;

        if (legajoTitle) legajoTitle.textContent = 'Legajo · ' + safeStr(c.full_name || 'Cliente');
        if (legajoSubtitle) legajoSubtitle.textContent = 'ID ' + safeStr(c.id) + ' · ' + badgeClas(c).replace(/<[^>]*>/g, '').trim();
        if (legajoFullname) legajoFullname.textContent = safeStr(c.full_name || '—');
        if (legajoPhone) legajoPhone.textContent = safeStr(c.phone || '—');
        if (legajoEmail) legajoEmail.textContent = safeStr(c.email || '—');
        if (legajoJoin) legajoJoin.textContent = joinDate;
        if (legajoBday) legajoBday.textContent = safeStr(c.birthday || '—');
        if (legajoAddress) legajoAddress.textContent = safeStr(c.address || '—');

        if (legajoClas) legajoClas.innerHTML = badgeClas(c) + (badgeAlerta(c) ? (' ' + badgeAlerta(c)) : '');
        if (legajoCompras) legajoCompras.textContent = safeStr(c.cantidad_compras || 0);
        if (legajoMonto) legajoMonto.textContent = fmtMoney(parseFloat(c.monto_total_comprado || 0) || 0);
        if (legajoUltima) legajoUltima.textContent = safeStr(c.ultima_compra || '—');
        if (legajoFreq) legajoFreq.textContent = (isFinite(c.frecuencia_compra) ? c.frecuencia_compra.toFixed(2) : '0.00') + ' compras/mes';

        if (legajoCc) legajoCc.textContent = c.tiene_cuenta_corriente ? 'Sí' : 'No';
        if (legajoSaldo) legajoSaldo.textContent = fmtMoney(parseFloat(c.saldo_actual || 0) || 0);
        if (legajoDias) legajoDias.textContent = c.saldo_actual > 0 ? (safeStr(c.dias_deuda || 0) + ' días') : '—';
        if (legajoAlerta) legajoAlerta.innerHTML = badgeAlerta(c) || '<span class="text-gray-500">—</span>';

        if (legajoNotes) legajoNotes.textContent = safeStr(c.notes || '—');

        if (legajoSales) {
            const list = salesForCustomer(c).slice(0, 10);
            if (!list.length) {
                legajoSales.innerHTML = '<tr><td colspan="4" class="px-3 py-4 text-sm text-gray-500 text-center">Sin ventas asociadas.</td></tr>';
            } else {
                legajoSales.innerHTML = '';
                list.forEach(s => {
                    const ts = parseDateToTs(s?.fecha) || (parseInt(s?.created_at || 0, 10) || 0);
                    const fechaRaw = ts ? new Date(ts).toISOString().slice(0, 10) : '—';
                    const fecha = (window.formatFechaDisplay && typeof window.formatFechaDisplay === 'function')
                        ? window.formatFechaDisplay(fechaRaw)
                        : fechaRaw;
                    const pago = safeStr(s?.payment_method || s?.forma_pago || (s?.on_account ? 'Cuenta corriente' : '') || '—');
                    const total = fmtMoney(parseFloat(s?.total || 0) || 0);
                    const due = fmtMoney(parseFloat(s?.due_amount || 0) || 0);
                    const dueClass = (parseFloat(s?.due_amount || 0) || 0) > 0 ? 'text-red-700 font-semibold' : 'text-gray-700';
                    const tr = document.createElement('tr');
                    tr.innerHTML = ''
                        + '<td class="px-3 py-2 text-sm text-gray-700">' + fecha + '</td>'
                        + '<td class="px-3 py-2 text-sm text-gray-700">' + pago + '</td>'
                        + '<td class="px-3 py-2 text-sm text-right text-gray-700">' + total + '</td>'
                        + '<td class="px-3 py-2 text-sm text-right ' + dueClass + '">' + due + '</td>';
                    legajoSales.appendChild(tr);
                });
            }
        }

        openModal(modalLegajo);
    }

    function openSettleDebt(id) {
        const derived = ensureArray(lastDerived).length ? lastDerived : computeDerived(cacheCustomers, cacheSales);
        const c = ensureArray(derived).find(x => safeStr(x.id) === safeStr(id));
        if (!c) return;

        settleCustomerId = safeStr(c.id);
        if (settleSubtitle) settleSubtitle.textContent = safeStr(c.full_name || 'Cliente');
        if (settleError) settleError.classList.add('hidden');

        const outs = ensureArray(cacheSales)
            .filter(s => {
                const sid = safeStr(s?.customer_id);
                return sid && sid === settleCustomerId && (parseFloat(s?.due_amount || 0) || 0) > 0;
            })
            .sort((a, b) => (parseInt(b?.created_at || 0, 10) || 0) - (parseInt(a?.created_at || 0, 10) || 0));

        if (settleSale) {
            settleSale.innerHTML = '';
            if (!outs.length) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'Sin deudas pendientes.';
                settleSale.appendChild(opt);
            } else {
                outs.forEach(s => {
                    const due = parseFloat(s?.due_amount || 0) || 0;
                    const fechaRaw = safeStr(s?.fecha || '');
                    const fecha = (window.formatFechaDisplay && typeof window.formatFechaDisplay === 'function')
                        ? window.formatFechaDisplay(fechaRaw)
                        : fechaRaw;
                    const opt = document.createElement('option');
                    opt.value = safeStr(s?.id);
                    opt.textContent = safeStr(s?.ticket || '') + ' · ' + fecha + ' · Deuda: ' + fmtMoney(due);
                    settleSale.appendChild(opt);
                });
            }
        }

        const firstId = outs.length ? safeStr(outs[0]?.id) : '';
        if (settleSale && firstId) settleSale.value = firstId;
        const firstDue = outs.length ? (parseFloat(outs[0]?.due_amount || 0) || 0) : 0;
        if (settleAmount) settleAmount.textContent = fmtMoney(firstDue);
        if (settlePayAmount) settlePayAmount.value = String(firstDue || 0);

        openModal(modalSettle);
    }

    function syncSettleAmount() {
        const id = safeStr(settleSale?.value);
        const s = ensureArray(cacheSales).find(x => safeStr(x?.id) === id);
        const due = s ? (parseFloat(s?.due_amount || 0) || 0) : 0;
        if (settleAmount) settleAmount.textContent = fmtMoney(due);
        if (settlePayAmount) settlePayAmount.value = String(due || 0);
    }

    function confirmSettleDebt() {
        const saleId = safeStr(settleSale?.value);
        const method = safeStr(settleMethod?.value || 'Efectivo') || 'Efectivo';
        const payAmount = parseFloat(settlePayAmount?.value || 0) || 0;
        if (!saleId) {
            if (settleError) settleError.classList.remove('hidden');
            return;
        }
        const s = ensureArray(cacheSales).find(x => safeStr(x?.id) === saleId);
        const due = s ? (parseFloat(s?.due_amount || 0) || 0) : 0;
        if (!(payAmount > 0) || payAmount - due > 0.00001) {
            if (settleError) {
                settleError.querySelector('span').textContent = 'Ingresá un monto válido (mayor a 0 y menor o igual a la deuda).';
                settleError.classList.remove('hidden');
            }
            return;
        }
        if (settleError) {
            settleError.querySelector('span').textContent = 'Seleccioná una venta válida.';
            settleError.classList.add('hidden');
        }
        apiSettleDebt({ sale_id: saleId, payment_method: method, amount: payAmount })
            .then(function (data) {
                if (!data || data.ok !== true) {
                    if (settleError) settleError.classList.remove('hidden');
                    return;
                }
                const reload = readSales();
                Promise.resolve(reload).then(function (sales) {
                    cacheSales = ensureArray(sales);
                    closeModal(modalSettle);
                    render();
                    if (legajoCustomerId && legajoCustomerId === settleCustomerId) {
                        openLegajo(legajoCustomerId);
                    }
                });
            })
            .catch(function () {
                if (settleError) settleError.classList.remove('hidden');
            });
    }

    function applyCrmLabelsToUi(cfg) {
        const c = cfg && typeof cfg === 'object' ? cfg : readCrmConfig();
        setCrmCfg(c);
        const title = safeStr(c.labels?.clas_title || 'Clasificación') || 'Clasificación';
        clasTitle = title;
        clasOpts = [
            { k: 'deudor_critico', label: safeStr(c.labels?.debtor_critical || 'Deudor crítico') || 'Deudor crítico' },
            { k: 'deudor', label: safeStr(c.labels?.debtor || 'Deudor') || 'Deudor' },
            { k: 'mejor_cliente', label: safeStr(c.labels?.best || 'Mejor cliente') || 'Mejor cliente' },
            { k: 'frecuente', label: safeStr(c.labels?.freq || 'Frecuente') || 'Frecuente' },
            { k: 'inactivo', label: safeStr(c.labels?.inactive || 'Inactivo') || 'Inactivo' },
        ];
        try {
            const allowed = new Set(clasOpts.map(x => x.k));
            clasSelected = new Set(Array.from(clasSelected).filter(k => allowed.has(k)));
        } catch (e) {
        }
        if (thClasLabel) thClasLabel.textContent = title;
        syncCustomersFilterButtons();
        try {
            renderMultiselectItems(filterClasItems, 'Todas', clasOpts, clasSelected, 'cust-cl-all', 'cust-cl-opt', clasAllMode);
        } catch (e) {
        }
    }

    function fmtMoney(n) {
        const num = isNaN(n) ? 0 : n;
        return '$' + num.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function parseDateToTs(d) {
        const s = safeStr(d).trim();
        if (!s) return 0;
        const t = Date.parse(s);
        if (!isNaN(t)) return t;
        return 0;
    }

    function daysSince(ts) {
        if (!ts) return null;
        const diff = Date.now() - ts;
        const d = Math.floor(diff / (1000 * 60 * 60 * 24));
        return d < 0 ? 0 : d;
    }

    function monthsBetween(fromTs, toTs) {
        const a = new Date(fromTs || Date.now());
        const b = new Date(toTs || Date.now());
        const months = (b.getFullYear() - a.getFullYear()) * 12 + (b.getMonth() - a.getMonth());
        return Math.max(1, months + 1);
    }

    function canonicalizeCustomer(c) {
        const obj = c && typeof c === 'object' ? c : {};
        const id = safeStr(obj.id || obj.customer_id || '').trim() || safeStr(obj.created_at || Date.now());

        const full = safeStr(obj.name || obj.nombre || '').trim();
        const first = safeStr(obj.first_name || obj.nombre || '').trim();
        const last = safeStr(obj.last_name || obj.apellido || '').trim();

        let firstName = first;
        let lastName = last;
        if ((!firstName || !lastName) && full) {
            const parts = full.split(' ').filter(Boolean);
            if (!firstName && parts.length) firstName = parts[0];
            if (!lastName && parts.length > 1) lastName = parts.slice(1).join(' ');
        }

        const phone = safeStr(obj.phone || obj.telefono || '').trim();
        const email = safeStr(obj.email || '').trim();
        const birthday = safeStr(obj.birthday || obj.fecha_cumpleanos || '').trim();
        const address = safeStr(obj.address || obj.direccion || '').trim();
        const notes = safeStr(obj.notes || obj.observaciones || '').trim();
        const createdAt = parseInt(obj.created_at || obj.fecha_incorporacion_ts || 0, 10) || parseDateToTs(obj.fecha_incorporacion) || Date.now();

        return {
            id,
            first_name: firstName,
            last_name: lastName,
            phone,
            email,
            birthday,
            address,
            notes,
            created_at: createdAt
        };
    }

    function dedupeCustomers(list) {
        const map = new Map();
        ensureArray(list).forEach(raw => {
            const c = canonicalizeCustomer(raw);
            const key = c.id || (safeStr(c.first_name).toLowerCase() + '|' + safeStr(c.last_name).toLowerCase() + '|' + safeStr(c.phone).toLowerCase());
            if (!map.has(key)) {
                map.set(key, c);
                return;
            }
            const prev = map.get(key);
            map.set(key, {
                ...prev,
                first_name: prev.first_name || c.first_name,
                last_name: prev.last_name || c.last_name,
                phone: prev.phone || c.phone,
                email: prev.email || c.email,
                birthday: prev.birthday || c.birthday,
                address: prev.address || c.address,
                notes: prev.notes || c.notes,
                created_at: Math.min(prev.created_at || Date.now(), c.created_at || Date.now())
            });
        });
        return Array.from(map.values());
    }

    function readCustomers() {
        const storageFallback = function () {
            try {
                if (window.StorageService && typeof window.StorageService.getCustomers === 'function') {
                    const res = window.StorageService.getCustomers();
                    if (isPromise(res)) {
                        return Promise.resolve(res)
                            .then(function (items) { return ensureArray(items); })
                            .catch(function () { return []; });
                    }
                    return Promise.resolve(ensureArray(res));
                }
            } catch (e) {
            }
            return Promise.resolve([]);
        };

        try {
            return fetch('/customers/api/customers?limit=5000', { credentials: 'same-origin' })
                .then(function (r) {
                    if (!r || !r.ok) throw new Error('http_' + String(r ? r.status : '0'));
                    return r.json();
                })
                .then(function (data) {
                    if (data && data.ok === true) return ensureArray(data.items);
                    return ensureArray((data && data.items) ? data.items : []);
                })
                .catch(function () {
                    return storageFallback();
                });
        } catch (e) {
            return storageFallback();
        }
    }

    function saveCustomers(list) {
        const payload = ensureArray(list);
        try {
            if (window.StorageService && typeof window.StorageService.saveCustomers === 'function') {
                return window.StorageService.saveCustomers(payload);
            }
        } catch (e) {
        }
        return null;
    }

    function readSales() {
        const storageFallback = function () {
            try {
                if (window.StorageService && typeof window.StorageService.getSales === 'function') {
                    const res = window.StorageService.getSales();
                    if (isPromise(res)) {
                        return Promise.resolve(res)
                            .then(function (items) { return ensureArray(items); })
                            .catch(function () { return []; });
                    }
                    return Promise.resolve(ensureArray(res));
                }
            } catch (e) {
            }
            return Promise.resolve([]);
        };

        try {
            return fetch('/sales/api/sales?limit=2000&include_replaced=1', { credentials: 'same-origin' })
                .then(function (r) {
                    if (!r || !r.ok) throw new Error('http_' + String(r ? r.status : '0'));
                    return r.json();
                })
                .then(function (data) {
                    if (data && data.ok === true) return ensureArray(data.items);
                    return ensureArray((data && data.items) ? data.items : []);
                })
                .catch(function () {
                    return storageFallback();
                });
        } catch (e) {
            return storageFallback();
        }
    }

    function computeP90(values) {
        const arr = ensureArray(values).filter(v => typeof v === 'number' && isFinite(v)).sort((a, b) => a - b);
        if (!arr.length) return 0;
        const idx = Math.floor(0.9 * (arr.length - 1));
        return arr[idx];
    }

    function computeDerived(customers, salesArr) {
        const crm = getCrmCfg();
        const sales = ensureArray(salesArr);
        const nowTs = Date.now();
        const winMs = Math.max(1, parseInt(crm?.recent_days || 60, 10) || 60) * 24 * 60 * 60 * 1000;
        const freqMin = Math.max(1, parseInt(crm?.freq_min_purchases || 1, 10) || 1);
        const bestMin = Math.max(1, parseInt(crm?.best_min_purchases || 2, 10) || 2);
        const overdueDays = Math.max(1, parseInt(crm?.debt_overdue_days || 30, 10) || 30);

        const mapped = customers.map(c => {
            const cid = safeStr(c.id);
            const fullName = (safeStr(c.first_name) + ' ' + safeStr(c.last_name)).trim();
            const salesFor = salesArr.filter(s => safeStr(s?.customer_id) === cid || (!safeStr(s?.customer_id) && fullName && safeStr(s?.customer_name).toLowerCase() === fullName.toLowerCase()));

            const purchaseSales = salesFor.filter(s => {
                const t = safeStr(s?.type || s?.sale_type).trim();
                const total = parseFloat(s?.total || 0) || 0;
                if (t === 'CobroCC') return false;
                return total > 0;
            });

            const cantidad = purchaseSales.length;
            const totalComprado = purchaseSales.reduce((acc, s) => acc + (parseFloat(s?.total || 0) || 0), 0);
            const ultimaTs = purchaseSales.reduce((acc, s) => {
                const ts = parseDateToTs(s?.fecha) || (parseInt(s?.created_at || 0, 10) || 0);
                return Math.max(acc, ts || 0);
            }, 0);
            const meses = monthsBetween(c.created_at || Date.now(), Date.now());
            const freq = cantidad / meses;

            const saldo = salesFor.reduce((acc, s) => acc + (parseFloat(s?.due_amount || 0) || 0), 0);
            const tieneCc = saldo > 0 || salesFor.some(s => !!s?.on_account);
            const oldestImpagoTs = salesFor.reduce((acc, s) => {
                const due = parseFloat(s?.due_amount || 0) || 0;
                if (due <= 0) return acc;
                const ts = parseDateToTs(s?.fecha) || (parseInt(s?.created_at || 0, 10) || 0);
                if (!ts) return acc;
                if (!acc) return ts;
                return Math.min(acc, ts);
            }, 0);
            const diasDeuda = saldo > 0 ? (daysSince(oldestImpagoTs) ?? 0) : 0;

            const diasUltCompra = ultimaTs ? (daysSince(ultimaTs) ?? 0) : null;
            const recentPurchases = purchaseSales.filter(s => {
                const ts = parseDateToTs(s?.fecha) || (parseInt(s?.created_at || 0, 10) || 0);
                if (!ts) return false;
                return (nowTs - ts) <= winMs;
            }).length;

            let clas = 'inactivo';
            if (saldo > 0) {
                clas = (diasDeuda >= criticalDays) ? 'deudor_critico' : 'deudor';
            } else if (recentPurchases >= bestMin) {
                clas = 'mejor_cliente';
            } else if (recentPurchases >= freqMin) {
                clas = 'frecuente';
            } else {
                clas = 'inactivo';
            }

            const alert = (saldo > 0 && diasDeuda >= criticalDays) ? 'vencida_critica' : ((saldo > 0 && diasDeuda >= overdueDays) ? 'vencida' : '');

            const ultimaCompraRaw = ultimaTs ? new Date(ultimaTs).toISOString().slice(0, 10) : '';
            const ultimaCompra = (window.formatFechaDisplay && typeof window.formatFechaDisplay === 'function')
                ? window.formatFechaDisplay(ultimaCompraRaw)
                : ultimaCompraRaw;

            return {
                ...c,
                full_name: fullName,
                cantidad_compras: cantidad,
                monto_total_comprado: totalComprado,
                ultima_compra_ts: ultimaTs,
                ultima_compra: ultimaCompra,
                frecuencia_compra: freq,
                saldo_actual: saldo,
                tiene_cuenta_corriente: tieneCc,
                dias_deuda: diasDeuda,
                clasificacion: clas,
                alerta_cc: alert
            };
        });

        return mapped;
    }

    function applyFilters(list) {
        const q = safeStr(inputSearch?.value).trim().toLowerCase();
        const totalClas = clasOpts.length;
        const totalCc = ccOpts.length;

        return ensureArray(list).filter(c => {
            const clKey = normKey(c.clasificacion);
            if (!clasAllMode && clasSelected.size) {
                if (!clasSelected.has(clKey)) return false;
            }

            if (!ccAllMode && ccSelected.size) {
                const crm = getCrmCfg();
                const overdueDays = Math.max(1, parseInt(crm?.debt_overdue_days || 30, 10) || 30);
                const criticalDays = Math.max(overdueDays, parseInt(crm?.debt_critical_days || 60, 10) || 60);
                const has = function (k) {
                    const saldo = (parseFloat(c.saldo_actual || 0) || 0);
                    const dias = (parseInt(c.dias_deuda || 0, 10) || 0);
                    const hasCc = !!c.tiene_cuenta_corriente;
                    if (k === 'sin_cc') return !hasCc;
                    if (k === 'al_dia') return hasCc && (saldo <= 0 || dias <= overdueDays);
                    if (k === 'vencida') return (saldo > 0) && (dias > overdueDays) && (dias <= criticalDays);
                    if (k === 'vencida_critica') return (saldo > 0) && (dias > criticalDays);
                    return false;
                };
                const ok = Array.from(ccSelected).some(has);
                if (!ok) return false;
            }

            if (q) {
                const hay = [
                    safeStr(c.first_name),
                    safeStr(c.last_name),
                    safeStr(c.full_name),
                    safeStr(c.email),
                    safeStr(c.phone)
                ].join(' ').toLowerCase();
                if (!hay.includes(q)) return false;
            }
            return true;
        });
    }

    function sortRows(list) {
        const dir = (sortDir === 'asc') ? 1 : -1;
        const key = safeStr(sortKey);

        const getVal = function (c) {
            if (key === 'nombre') return safeStr(c.full_name).toLowerCase();
            if (key === 'fecha_incorporacion') return c.created_at || 0;
            if (key === 'cantidad_compras') return c.cantidad_compras || 0;
            if (key === 'frecuencia_compra') return c.frecuencia_compra || 0;
            if (key === 'monto_total_comprado') return c.monto_total_comprado || 0;
            if (key === 'saldo_actual') return c.saldo_actual || 0;
            return 0;
        };

        return ensureArray(list).slice().sort((a, b) => {
            const va = getVal(a);
            const vb = getVal(b);
            if (typeof va === 'number' && typeof vb === 'number') return (va - vb) * dir;
            return safeStr(va).localeCompare(safeStr(vb)) * dir;
        });
    }

    function badgeClas(c) {
        const crm = getCrmCfg();
        const cls = safeStr(c.clasificacion);
        const lblBest = safeStr(crm?.labels?.best || 'Mejor cliente') || 'Mejor cliente';
        const lblFreq = safeStr(crm?.labels?.freq || 'Frecuente') || 'Frecuente';
        const lblInactive = safeStr(crm?.labels?.inactive || 'Inactivo') || 'Inactivo';
        const lblDebtor = safeStr(crm?.labels?.debtor || 'Deudor') || 'Deudor';
        const lblDebtorCrit = safeStr(crm?.labels?.debtor_critical || 'Deudor crítico') || 'Deudor crítico';
        if (cls === 'deudor_critico') return '<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-red-600 text-white text-[11px] font-medium">' + lblDebtorCrit + '</span>';
        if (cls === 'deudor') return '<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-red-50 text-red-700 text-[11px] font-medium">' + lblDebtor + '</span>';
        if (cls === 'inactivo') return '<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 text-[11px] font-medium">' + lblInactive + '</span>';
        if (cls === 'mejor_cliente') return '<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 text-[11px] font-medium">' + lblBest + '</span>';
        if (cls === 'frecuente') return '<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 text-[11px] font-medium">' + lblFreq + '</span>';
        return '<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 text-[11px] font-medium">' + lblInactive + '</span>';
    }

    function deleteCustomer(id) {
        const cid = safeStr(id).trim();
        if (!cid) return;

        const c = ensureArray(cacheCustomers).find(x => safeStr(x.id) === cid);
        const label = c ? ((safeStr(c.first_name) + ' ' + safeStr(c.last_name)).trim() || safeStr(c.name) || cid) : cid;

        const doConfirm = function () {
            if (window.confirmModal && typeof window.confirmModal === 'function') {
                return window.confirmModal(
                    '¿Seguro que querés eliminar ' + label + '?',
                    'Eliminar cliente',
                    'Esta acción no se puede deshacer.',
                    { okText: 'Eliminar', cancelText: 'Cancelar' }
                );
            }
            return Promise.resolve(window.confirm('¿Seguro que querés eliminar ' + label + '?'));
        };

        doConfirm().then(function (ok) {
            if (!ok) return;
            fetch('/customers/api/customers/' + encodeURIComponent(cid), {
                method: 'DELETE',
                credentials: 'same-origin'
            }).then(r => r.json()).then(function (res) {
                if (!res || res.ok !== true) return;
                Promise.resolve(readCustomers()).then(function (items) {
                    cacheCustomers = dedupeCustomers(items);
                    render();
                });
            }).catch(function () {
            });
        });
    }

    function badgeAlerta(c) {
        if (!(c.saldo_actual > 0)) return '';
        const crm = getCrmCfg();
        const overdueDays = Math.max(1, parseInt(crm?.debt_overdue_days || 30, 10) || 30);
        const criticalDays = Math.max(overdueDays, parseInt(crm?.debt_critical_days || 60, 10) || 60);
        const dias = (parseInt(c.dias_deuda || 0, 10) || 0);
        if (dias >= criticalDays) return '<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-red-100 text-red-700 text-[11px] font-medium">Vencida crítica · ' + safeStr(dias) + 'd</span>';
        if (dias >= overdueDays) return '<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-amber-100 text-amber-800 text-[11px] font-medium">Vencida · ' + safeStr(dias) + 'd</span>';
        return '';
    }

    function render() {
        if (!tbody) return;

        const derived = computeDerived(cacheCustomers, cacheSales);
        lastDerived = derived;
        const filtered = applyFilters(derived);
        const sorted = sortRows(filtered);

        const totalClientes = derived.length;
        const nowTs = Date.now();
        const days30 = 30 * 24 * 60 * 60 * 1000;
        const activos = derived.filter(x => (parseInt(x.ultima_compra_ts || 0, 10) || 0) > 0 && (nowTs - (parseInt(x.ultima_compra_ts || 0, 10) || 0)) <= days30).length;

        const crm = getCrmCfg();
        const overdueDays = Math.max(1, parseInt(crm?.debt_overdue_days || 30, 10) || 30);
        const conDeuda = derived.filter(x => (x.saldo_actual || 0) > 0 && ((parseInt(x.dias_deuda || 0, 10) || 0) <= overdueDays)).length;
        const conDeudaVencida = derived.filter(x => (x.saldo_actual || 0) > 0 && ((parseInt(x.dias_deuda || 0, 10) || 0) > overdueDays)).length;
        const deudores = conDeuda + conDeudaVencida;
        const deudaTotal = derived.reduce((acc, x) => acc + (parseFloat(x.saldo_actual || 0) || 0), 0);

        if (kpiTotal) kpiTotal.textContent = safeStr(totalClientes);
        if (kpiActivos) kpiActivos.textContent = safeStr(activos);
        if (kpiDeudores) kpiDeudores.textContent = safeStr(deudores);
        if (kpiDeuda) kpiDeuda.textContent = fmtMoney(deudaTotal);
        if (kpiDeudoresSub) {
            kpiDeudoresSub.textContent = 'Con deuda: ' + safeStr(conDeuda) + ' · Con deuda vencida: ' + safeStr(conDeudaVencida);
        }

        if (!sorted.length) {
            tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-sm text-center text-gray-500">Sin resultados.</td></tr>';
            return;
        }

        tbody.innerHTML = '';
        sorted.forEach(c => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';

            const comprasInt = parseInt(c.cantidad_compras || 0, 10) || 0;
            const monto = fmtMoney(parseFloat(c.monto_total_comprado || 0) || 0);
            const saldo = parseFloat(c.saldo_actual || 0) || 0;
            const ccText = saldo > 0 ? fmtMoney(saldo) : '—';
            const ccClass = saldo > 0 ? 'text-red-700 font-semibold' : 'text-gray-600';
            const notas = truncateText(c.notes || '', 60) || '—';

            const isDebtor = saldo > 0;

            tr.innerHTML = ''
                + '<td class="px-4 py-3 text-sm text-gray-900">'
                +   '<div class="font-medium">' + safeStr(c.full_name || '-') + '</div>'
                + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-700">' + badgeClas(c) + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-700">' + String(comprasInt) + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-700">' + monto + '</td>'
                + '<td class="px-4 py-3 text-sm text-right ' + ccClass + '">' + ccText + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-700">' + safeStr(notas) + '</td>'
                + '<td class="px-4 py-3 text-sm text-right">'
                +   '<div class="relative inline-block text-left">'
                +     '<button type="button" class="btn-cliente-menu inline-flex items-center justify-center h-8 w-8 rounded-full hover:bg-gray-100" data-id="' + safeStr(c.id) + '">' 
                +       '<i class="fas fa-ellipsis-v text-gray-500 text-xs"></i>'
                +     '</button>'
                +     '<div class="menu-cliente-acciones hidden origin-top-right absolute right-0 mt-1 w-44 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">'
                +       '<div class="py-1 text-[11px]">'
                +         '<button type="button" class="w-full text-left px-3 py-2 text-blue-700 hover:bg-blue-50" data-action="legajo" data-id="' + safeStr(c.id) + '">Ver legajo</button>'
                +         '<button type="button" class="w-full text-left px-3 py-2 text-blue-700 hover:bg-blue-50" data-action="edit" data-id="' + safeStr(c.id) + '">Editar</button>'
                +         '<button type="button" class="w-full text-left px-3 py-2 text-blue-700 hover:bg-blue-50" data-action="delete" data-id="' + safeStr(c.id) + '">Eliminar</button>'
                +         (isDebtor ? ('<button type="button" class="w-full text-left px-3 py-2 text-red-700 hover:bg-red-50" data-action="settle" data-id="' + safeStr(c.id) + '">Saldar deuda</button>') : '')
                +       '</div>'
                +     '</div>'
                +   '</div>'
                + '</td>';

            tbody.appendChild(tr);
        });
    }

    function loadAll() {
        try {
            if (tbody) {
                tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-sm text-center text-gray-500">Cargando...</td></tr>';
            }
        } catch (e) {
        }
        const cRes = readCustomers();
        const sRes = readSales();

        const apply = function (customers, sales) {
            cacheCustomers = dedupeCustomers(customers);
            cacheSales = ensureArray(sales);
            render();
        };

        if (isPromise(cRes) || isPromise(sRes)) {
            Promise.all([Promise.resolve(cRes), Promise.resolve(sRes)])
                .then(function (arr) {
                    apply(arr[0], arr[1]);
                })
                .catch(function () {
                    try {
                        cacheCustomers = [];
                        cacheSales = [];
                        render();
                    } catch (e) {
                    }
                    try {
                        if (tbody) {
                            tbody.innerHTML = '<tr><td colspan="7" class="px-4 py-6 text-sm text-center text-gray-500">No se pudieron cargar los datos.</td></tr>';
                        }
                    } catch (e) {
                    }
                });
        } else {
            apply(cRes, sRes);
        }
    }

    function clearForm() {
        editingCustomerId = null;
        if (titleForm) titleForm.textContent = 'Nuevo cliente';
        if (msgFormError) msgFormError.classList.add('hidden');
        if (inputFirst) inputFirst.value = '';
        if (inputLast) inputLast.value = '';
        if (inputPhone) inputPhone.value = '';
        if (inputEmail) inputEmail.value = '';
        if (inputBirthday) inputBirthday.value = '';
        if (inputAddress) inputAddress.value = '';
        if (inputNotes) inputNotes.value = '';
    }

    function openNewCustomer() {
        clearForm();
        openModal(modalForm);
        if (inputFirst) inputFirst.focus();
    }

    function openEditCustomer(id) {
        const c = ensureArray(cacheCustomers).find(x => safeStr(x.id) === safeStr(id));
        if (!c) return;
        editingCustomerId = safeStr(c.id);
        if (titleForm) titleForm.textContent = 'Editar cliente';
        if (msgFormError) msgFormError.classList.add('hidden');
        if (inputFirst) inputFirst.value = safeStr(c.first_name);
        if (inputLast) inputLast.value = safeStr(c.last_name);
        if (inputPhone) inputPhone.value = safeStr(c.phone);
        if (inputEmail) inputEmail.value = safeStr(c.email);
        if (inputBirthday) inputBirthday.value = safeStr(c.birthday);
        if (inputAddress) inputAddress.value = safeStr(c.address);
        if (inputNotes) inputNotes.value = safeStr(c.notes);
        openModal(modalForm);
    }

    function saveCustomerFromForm() {
        const first = safeStr(inputFirst?.value).trim();
        const last = safeStr(inputLast?.value).trim();
        const phone = safeStr(inputPhone?.value).trim();

        if (!first || !last || !phone) {
            if (msgFormError) msgFormError.classList.remove('hidden');
            return;
        }

        const payload = {
            first_name: first,
            last_name: last,
            phone: phone,
            email: safeStr(inputEmail?.value).trim(),
            birthday: safeStr(inputBirthday?.value).trim(),
            address: safeStr(inputAddress?.value).trim(),
            notes: safeStr(inputNotes?.value).trim(),
        };

        const isEditing = !!editingCustomerId;
        const url = isEditing ? ('/customers/api/customers/' + encodeURIComponent(editingCustomerId)) : '/customers/api/customers';
        const method = isEditing ? 'PUT' : 'POST';

        fetch(url, {
            method: method,
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        }).then(r => r.json()).then(function (res) {
            if (!res || res.ok !== true) {
                if (msgFormError) msgFormError.classList.remove('hidden');
                return;
            }
            Promise.resolve(readCustomers()).then(function (items) {
                cacheCustomers = dedupeCustomers(items);
                closeModal(modalForm);
                render();
            });
        }).catch(function () {
            if (msgFormError) msgFormError.classList.remove('hidden');
        });
    }

    function initSorting() {
        const ths = document.querySelectorAll('thead th[data-sort]');
        ths.forEach(th => {
            th.addEventListener('click', function () {
                const k = safeStr(th.getAttribute('data-sort'));
                if (!k) return;
                if (sortKey === k) sortDir = (sortDir === 'asc') ? 'desc' : 'asc';
                else {
                    sortKey = k;
                    sortDir = (k === 'nombre') ? 'asc' : 'desc';
                }
                render();
            });
        });
    }

    function initActions() {
        if (btnNuevo) btnNuevo.addEventListener('click', function () { openNewCustomer(); });
        if (btnCloseForm) btnCloseForm.addEventListener('click', function () { closeModal(modalForm); });
        if (btnCancelForm) btnCancelForm.addEventListener('click', function () { closeModal(modalForm); });
        if (btnSaveForm) btnSaveForm.addEventListener('click', function () { saveCustomerFromForm(); });
        if (modalForm) {
            modalForm.addEventListener('click', function (e) {
                const target = e.target;
                if (target && target === modalForm.firstElementChild) closeModal(modalForm);
            });
        }

        if (btnConfigAlertas) {
            btnConfigAlertas.addEventListener('click', function () {
                Promise.resolve(refreshCrmCfgFromApi()).then(function () {
                    const cfg = getCrmCfg();
                    setCrmError('');
                    if (inputCrmRecentDays) inputCrmRecentDays.value = safeStr(cfg.recent_days);
                    if (inputCrmDebtOverdueDays) inputCrmDebtOverdueDays.value = safeStr(cfg.debt_overdue_days);
                    if (inputCrmDebtCriticalDays) inputCrmDebtCriticalDays.value = safeStr(cfg.debt_critical_days || Math.max(cfg.debt_overdue_days || 30, 60));
                    if (inputCrmFreqMin) inputCrmFreqMin.value = safeStr(cfg.freq_min_purchases);
                    if (inputCrmBestMin) inputCrmBestMin.value = safeStr(cfg.best_min_purchases);
                    if (inputCrmLabelClasTitle) inputCrmLabelClasTitle.value = safeStr(cfg.labels?.clas_title || 'Clasificación');
                    if (inputCrmLabelBest) inputCrmLabelBest.value = safeStr(cfg.labels?.best || 'Mejor cliente');
                    if (inputCrmLabelFreq) inputCrmLabelFreq.value = safeStr(cfg.labels?.freq || 'Frecuente');
                    if (inputCrmLabelInactive) inputCrmLabelInactive.value = safeStr(cfg.labels?.inactive || 'Inactivo');
                    if (inputCrmLabelDebtor) inputCrmLabelDebtor.value = safeStr(cfg.labels?.debtor || 'Deudor');
                    try { renderCrmPreview(readCrmFormValues()); } catch (e) { }
                    openModal(modalAlerts);
                });
            });
        }
        if (btnCloseAlerts) btnCloseAlerts.addEventListener('click', function () { closeModal(modalAlerts); });
        if (btnCancelAlerts) btnCancelAlerts.addEventListener('click', function () { closeModal(modalAlerts); });
        if (btnSaveAlerts) {
            btnSaveAlerts.addEventListener('click', function () {
                const cfg = readCrmFormValues();
                const err = validateCrmConfig(cfg);
                if (err) {
                    setCrmError(err);
                    return;
                }
                setCrmError('');
                Promise.resolve(apiSaveCrmConfig(cfg)).then(function (saved) {
                    const applied = saved && typeof saved === 'object' ? saved : cfg;
                    writeCrmConfig(applied);
                    applyCrmLabelsToUi(applied);
                    closeModal(modalAlerts);
                    render();
                }).catch(function () {
                    setCrmError('No se pudo guardar la configuración.');
                });
            });
        }

        const onCrmInput = function () {
            setCrmError('');
            try { renderCrmPreview(readCrmFormValues()); } catch (e) { }
        };
        [
            inputCrmRecentDays,
            inputCrmDebtOverdueDays,
            inputCrmDebtCriticalDays,
            inputCrmFreqMin,
            inputCrmBestMin,
            inputCrmLabelClasTitle,
            inputCrmLabelBest,
            inputCrmLabelFreq,
            inputCrmLabelInactive,
            inputCrmLabelDebtor,
        ].forEach(function (el) {
            if (el) el.addEventListener('input', onCrmInput);
            if (el) el.addEventListener('change', onCrmInput);
        });
        if (modalAlerts) {
            modalAlerts.addEventListener('click', function (e) {
                const target = e.target;
                if (target && target === modalAlerts.firstElementChild) closeModal(modalAlerts);
            });
        }

        if (btnCloseLegajo) btnCloseLegajo.addEventListener('click', function () { closeModal(modalLegajo); });
        if (btnCloseLegajo2) btnCloseLegajo2.addEventListener('click', function () { closeModal(modalLegajo); });
        if (btnEditLegajo) btnEditLegajo.addEventListener('click', function () { if (legajoCustomerId) openEditCustomer(legajoCustomerId); });
        if (modalLegajo) {
            modalLegajo.addEventListener('click', function (e) {
                const target = e.target;
                if (target && target === modalLegajo.firstElementChild) closeModal(modalLegajo);
            });
        }

        if (btnCloseSettle) btnCloseSettle.addEventListener('click', function () { closeModal(modalSettle); });
        if (btnCancelSettle) btnCancelSettle.addEventListener('click', function () { closeModal(modalSettle); });
        if (btnConfirmSettle) btnConfirmSettle.addEventListener('click', function () { confirmSettleDebt(); });
        if (settleSale) settleSale.addEventListener('change', function () { syncSettleAmount(); });
        if (modalSettle) {
            modalSettle.addEventListener('click', function (e) {
                const target = e.target;
                if (target && target === modalSettle.firstElementChild) closeModal(modalSettle);
            });
        }

        if (inputSearch) inputSearch.addEventListener('input', function () { render(); });

        if (filterClasItems) {
            renderMultiselectItems(filterClasItems, 'Todas', clasOpts, clasSelected, 'cust-cl-all', 'cust-cl-opt', clasAllMode);
        }
        if (filterCcItems) {
            renderMultiselectItems(filterCcItems, 'Todas', ccOpts, ccSelected, 'cust-cc-all', 'cust-cc-opt', ccAllMode);
        }
        syncCustomersFilterButtons();

        if (filterClasBtn && filterClasMenu) {
            filterClasBtn.addEventListener('click', function () {
                const open = filterClasMenu.classList.contains('hidden');
                setDropdownOpen(filterClasMenu, open);
                if (open) {
                    try { setDropdownOpen(filterCcMenu, false); } catch (e) { }
                }
            });
        }
        if (filterCcBtn && filterCcMenu) {
            filterCcBtn.addEventListener('click', function () {
                const open = filterCcMenu.classList.contains('hidden');
                setDropdownOpen(filterCcMenu, open);
                if (open) {
                    try { setDropdownOpen(filterClasMenu, false); } catch (e) { }
                }
            });
        }

        if (filterClasItems) {
            filterClasItems.addEventListener('change', function (ev) {
                const t = ev && ev.target ? ev.target : null;
                if (!t) return;
                if (t.classList.contains('cust-cl-all')) {
                    if (clasAllMode) {
                        clasAllMode = false;
                        clasSelected = new Set();
                    } else {
                        clasAllMode = true;
                        clasSelected = new Set();
                    }
                }
                if (t.classList.contains('cust-cl-opt')) {
                    const k = String(t.getAttribute('data-k') || '').trim();
                    if (!k) return;
                    clasAllMode = false;
                    if (t.checked) clasSelected.add(k);
                    else clasSelected.delete(k);
                }
                renderMultiselectItems(filterClasItems, 'Todas', clasOpts, clasSelected, 'cust-cl-all', 'cust-cl-opt', clasAllMode);
                syncCustomersFilterButtons();
                render();
            });
        }

        if (filterCcItems) {
            filterCcItems.addEventListener('change', function (ev) {
                const t = ev && ev.target ? ev.target : null;
                if (!t) return;
                if (t.classList.contains('cust-cc-all')) {
                    if (ccAllMode) {
                        ccAllMode = false;
                        ccSelected = new Set();
                    } else {
                        ccAllMode = true;
                        ccSelected = new Set();
                    }
                }
                if (t.classList.contains('cust-cc-opt')) {
                    const k = String(t.getAttribute('data-k') || '').trim();
                    if (!k) return;
                    ccAllMode = false;
                    if (t.checked) ccSelected.add(k);
                    else ccSelected.delete(k);
                }
                renderMultiselectItems(filterCcItems, 'Todas', ccOpts, ccSelected, 'cust-cc-all', 'cust-cc-opt', ccAllMode);
                syncCustomersFilterButtons();
                render();
            });
        }

        if (tbody) {
            tbody.addEventListener('click', function (e) {
                const menuBtn = e.target.closest('button.btn-cliente-menu');
                if (menuBtn) {
                    e.stopPropagation();
                    const wrap = menuBtn.closest('.relative');
                    if (!wrap) return;
                    const menu = wrap.querySelector('.menu-cliente-acciones');
                    if (!menu) return;
                    const wasOpen = !menu.classList.contains('hidden');
                    closeAllRowMenus();
                    if (!wasOpen) menu.classList.remove('hidden');
                    return;
                }

                const actionBtn = e.target.closest('button[data-action]');
                if (!actionBtn) return;
                e.stopPropagation();
                const action = safeStr(actionBtn.getAttribute('data-action'));
                const id = safeStr(actionBtn.getAttribute('data-id'));
                closeAllRowMenus();
                if (action === 'edit') openEditCustomer(id);
                if (action === 'legajo') openLegajo(id);
                if (action === 'settle') openSettleDebt(id);
                if (action === 'delete') deleteCustomer(id);
            });
        }

        document.addEventListener('click', function () {
            closeAllRowMenus();
        });

        document.addEventListener('click', function (ev) {
            const t = ev && ev.target ? ev.target : null;
            if (!t) return;
            try {
                if (filterClasMenu && !filterClasMenu.classList.contains('hidden')) {
                    if (!filterClasMenu.contains(t) && !filterClasBtn.contains(t)) setDropdownOpen(filterClasMenu, false);
                }
            } catch (e) {
            }
            try {
                if (filterCcMenu && !filterCcMenu.classList.contains('hidden')) {
                    if (!filterCcMenu.contains(t) && !filterCcBtn.contains(t)) setDropdownOpen(filterCcMenu, false);
                }
            } catch (e) {
            }
        });
    }

    applyCrmLabelsToUi(readCrmConfig());
    Promise.resolve(refreshCrmCfgFromApi()).then(function () {
        render();
    });
    initSorting();
    initActions();
    loadAll();

    // Deep-link desde calendario
    try {
        const params = new URLSearchParams(window.location.search);
        const openId = safeStr(params.get('open_legajo'));
        if (openId) {
            const doOpen = function () {
                openLegajo(openId);
            };
            setTimeout(doOpen, 0);
        }
    } catch (e) {
    }
});
</script>
{% endblock %}
