{% extends 'base.html' %}
{% block title %}Nuevo proveedor{% endblock %}
{% block content %}
<div class="mb-6">
    <div class="flex items-start justify-between gap-3">
        <div>
            <h1 id="titulo-proveedor" class="text-2xl font-bold text-gray-900">Nuevo proveedor</h1>
            <p class="mt-1 text-sm text-gray-600">Alta rápida con campos obligatorios y una sección de información complementaria (opcional).</p>
        </div>
        <a href="{{ url_for('suppliers.index') }}" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">
            <i class="fas fa-arrow-left mr-2"></i> Volver a Proveedores
        </a>
    </div>
</div>

<div class="bg-white rounded-lg shadow border border-gray-200">
    <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
        <div>
            <h2 class="text-sm font-semibold text-gray-900">Datos obligatorios</h2>
            <p class="text-xs text-gray-500">Con estos datos ya podés usar el proveedor en Gastos.</p>
        </div>
    </div>

    <div class="p-4 space-y-4">
        <input id="supplier-id" type="hidden" value="">

        <div class="grid grid-cols-1 lg:grid-cols-6 gap-3">
            <div class="lg:col-span-3">
                <label class="block text-xs font-medium text-gray-600 mb-1">Nombre del proveedor</label>
                <input id="supplier-name" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Razón social o nombre comercial">
            </div>
            <div class="lg:col-span-2">
                <label class="block text-xs font-medium text-gray-600 mb-1">Tipo de proveedor</label>
                <select id="supplier-type" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                    <option value="Services">Servicios</option>
                    <option value="Products">Productos</option>
                    <option value="Mixed">Mixto</option>
                </select>
            </div>
            <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Estado</label>
                <select id="supplier-status" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                    <option value="Active">Activo</option>
                    <option value="Inactive">Inactivo</option>
                    <option value="Discontinued">Dado de baja</option>
                </select>
            </div>
        </div>

        <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Categorías (multiselección)</label>
            <label class="flex items-center gap-2 p-2 border rounded-md text-sm mb-2 bg-gray-50">
                <input id="supplier-category-inventory" type="checkbox" class="rounded">
                <span>Inventario</span>
            </label>
            <div id="supplier-categories" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
            </div>
            <div class="mt-2 flex justify-end">
                <button id="btn-manage-supplier-categories" type="button" class="text-[11px] text-blue-700 hover:text-blue-900">Administrar categorías</button>
            </div>
        </div>

        <div class="pt-2">
            <button id="btn-toggle-complementaria" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-blue-700 bg-blue-50 rounded-md hover:bg-blue-100">
                Información complementaria
            </button>
        </div>

        <div id="panel-complementaria" class="hidden border rounded-lg p-4 bg-gray-50 space-y-4">
            <div>
                <h3 class="text-sm font-semibold text-gray-900">Información administrativa</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-2">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Tipo de comprobante habitual</label>
                        <select id="supplier-invoice-type" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                            <option value="">—</option>
                            <option>Factura A</option>
                            <option>Factura B</option>
                            <option>Factura C</option>
                            <option>Ticket</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Forma de pago habitual</label>
                        <select id="supplier-default-payment" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                            <option value="">—</option>
                            <option>Efectivo</option>
                            <option>Transferencia</option>
                            <option>Tarjeta</option>
                            <option>Cuenta corriente</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Plazo de pago</label>
                        <select id="supplier-payment-terms" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                            <option value="">—</option>
                            <option>Contado</option>
                            <option>7 días</option>
                            <option>15 días</option>
                            <option>30 días</option>
                        </select>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-sm font-semibold text-gray-900">Información de contacto</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-2">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Persona de contacto</label>
                        <input id="supplier-contact-person" type="text" class="w-full px-3 py-2 text-sm border rounded-md">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Teléfono</label>
                        <input id="supplier-phone" type="text" class="w-full px-3 py-2 text-sm border rounded-md">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Email</label>
                        <input id="supplier-email" type="email" class="w-full px-3 py-2 text-sm border rounded-md">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Dirección</label>
                        <input id="supplier-address" type="text" class="w-full px-3 py-2 text-sm border rounded-md">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Canal preferido</label>
                        <select id="supplier-preferred-channel" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                            <option value="">—</option>
                            <option>WhatsApp</option>
                            <option>Email</option>
                            <option>Teléfono</option>
                        </select>
                    </div>
                </div>
            </div>

            <div>
                <h3 class="text-sm font-semibold text-gray-900">Archivos y documentación</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-2">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Adjuntar archivos</label>
                        <input id="supplier-attachments" type="file" multiple class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                        <p class="mt-1 text-xs text-gray-500">Se guarda la información del archivo (nombre, tipo y tamaño).</p>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Notas internas</label>
                        <textarea id="supplier-notes" rows="3" class="w-full px-3 py-2 text-sm border rounded-md"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-2 justify-end pt-2">
            <a href="{{ url_for('suppliers.index') }}" class="px-4 py-2 text-sm font-medium rounded-md border border-gray-200 bg-gray-50 hover:bg-gray-100 text-center">Cancelar</a>
            <button id="btn-guardar-proveedor" type="button" class="px-4 py-2 text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Guardar proveedor</button>
        </div>
    </div>
</div>

<div id="modal-supplier-categories" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-lg bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">Categorías</h3>
                    <p class="text-xs text-gray-500">Administrá categorías operativas (no inventario).</p>
                </div>
                <button id="btn-close-supplier-categories" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600" aria-label="Cerrar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-6 gap-2 items-end">
                    <div class="md:col-span-5">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Nueva categoría</label>
                        <input id="supplier-new-category-name" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Ej: Publicidad">
                    </div>
                    <div class="md:col-span-1 flex justify-end">
                        <button id="btn-supplier-add-category" type="button" class="w-full inline-flex items-center justify-center px-3 py-2 text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">Agregar</button>
                    </div>
                </div>
                <div class="border border-gray-200 rounded-xl overflow-hidden">
                    <div id="supplier-categories-admin-list" class="max-h-[320px] overflow-auto divide-y divide-gray-100"></div>
                </div>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                <button id="btn-cancel-supplier-categories" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const baseListUrl = "{{ url_for('suppliers.index') }}";
    const params = new URLSearchParams(window.location.search);
    const returnTo = params.get('return_to');
    const prefillCategory = params.get('prefill_category');

    const titulo = document.getElementById('titulo-proveedor');
    const inputId = document.getElementById('supplier-id');
    const inputName = document.getElementById('supplier-name');
    const selectType = document.getElementById('supplier-type');
    const selectStatus = document.getElementById('supplier-status');
    const categoriesWrap = document.getElementById('supplier-categories');
    const inventoryCheckbox = document.getElementById('supplier-category-inventory');
    const btnManageCategories = document.getElementById('btn-manage-supplier-categories');
    const modalCats = document.getElementById('modal-supplier-categories');
    const btnCloseCats = document.getElementById('btn-close-supplier-categories');
    const btnCancelCats = document.getElementById('btn-cancel-supplier-categories');
    const inputNewCatName = document.getElementById('supplier-new-category-name');
    const btnAddCat = document.getElementById('btn-supplier-add-category');
    const catsAdminList = document.getElementById('supplier-categories-admin-list');

    const btnToggle = document.getElementById('btn-toggle-complementaria');
    const panelComp = document.getElementById('panel-complementaria');

    const invoiceType = document.getElementById('supplier-invoice-type');
    const defaultPayment = document.getElementById('supplier-default-payment');
    const paymentTerms = document.getElementById('supplier-payment-terms');

    const contactPerson = document.getElementById('supplier-contact-person');
    const phone = document.getElementById('supplier-phone');
    const email = document.getElementById('supplier-email');
    const address = document.getElementById('supplier-address');
    const preferredChannel = document.getElementById('supplier-preferred-channel');

    const attachments = document.getElementById('supplier-attachments');
    const notes = document.getElementById('supplier-notes');

    const btnGuardar = document.getElementById('btn-guardar-proveedor');

    let lastLoadedMetaObj = {};
    let inventorySupplierFlag = false;

    function isPromise(x) {
        return !!x && typeof x.then === 'function';
    }

    function parseMetaObj(raw) {
        const s = String(raw || '').trim();
        if (!s) return {};
        try {
            const parsed = JSON.parse(s);
            return (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) ? parsed : {};
        } catch (e) {
            return {};
        }
    }

    function normalizeCategories(values) {
        const arr = Array.isArray(values) ? values : [];
        const out = [];
        arr.forEach(function (x) {
            const raw = String(x || '').trim();
            if (!raw) return;
            const low = raw.toLowerCase();
            if (low === 'inventario') {
                inventorySupplierFlag = true;
                return;
            }
            if (low === 'compra de productos e insumos') {
                out.push('Gastos operativos');
                return;
            }
            if (low === 'domicilios y logística' || low === 'domicilios y logistica') {
                out.push('Transportes');
                return;
            }
            out.push(raw);
        });
        return out;
    }

    function readExpenseCategories() {
        try {
            if (window.StorageService && typeof window.StorageService.getAdapter === 'function') {
                const a = window.StorageService.getAdapter();
                if (a && typeof a.getExpenseCategories === 'function') {
                    return a.getExpenseCategories();
                }
            }
        } catch (e) {
        }
        return [];
    }

    function renderSupplierCategories() {
        if (!categoriesWrap) return Promise.resolve();
        const base = [
            'Servicios públicos',
            'Gastos operativos',
            'Arriendo',
            'Nómina',
            'Transportes',
            'Mantenimiento y reparaciones',
            'Muebles, equipos o maquinarias',
            'Otro'
        ];

        const res = readExpenseCategories();
        const finish = function (items) {
            const all = base.slice();
            (Array.isArray(items) ? items : []).forEach(function (c) {
                const name = (c && typeof c === 'object') ? String(c.name || '').trim() : String(c || '').trim();
                if (!name) return;
                if (name.toLowerCase() === 'inventario') return;
                if (all.includes(name)) return;
                all.splice(all.length - 1, 0, name);
            });

            categoriesWrap.innerHTML = '';
            all.forEach(function (c) {
                const label = document.createElement('label');
                label.className = 'flex items-center gap-2 p-2 border rounded-md text-sm';
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.value = c;
                input.className = 'rounded';
                const span = document.createElement('span');
                span.textContent = c;
                label.appendChild(input);
                label.appendChild(span);
                categoriesWrap.appendChild(label);
            });
        };

        if (isPromise(res)) return res.then(finish).catch(function () { finish([]); });
        finish(res);
        return Promise.resolve();
    }

    function syncInventoryCheckbox() {
        if (!inventoryCheckbox) return;
        inventoryCheckbox.checked = !!inventorySupplierFlag;
    }

    async function apiJson(url, options) {
        const res = await fetch(url, {
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json'
            },
            ...(options || {})
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok || (data && data.ok === false)) {
            const msg = (data && (data.message || data.error)) ? (data.message || data.error) : ('HTTP ' + res.status);
            throw new Error(msg);
        }
        return data;
    }

    function openCategoriesModal() {
        if (!modalCats) return;
        modalCats.classList.remove('hidden');
        if (inputNewCatName) inputNewCatName.value = '';
        renderCategoriesAdminList();
        if (inputNewCatName) inputNewCatName.focus();
    }

    function closeCategoriesModal() {
        if (!modalCats) return;
        modalCats.classList.add('hidden');
    }

    function renderCategoriesAdminList() {
        if (!catsAdminList) return;
        const res = readExpenseCategories();
        const apply = function (items) {
            const list = Array.isArray(items) ? items : [];
            catsAdminList.innerHTML = '';
            const filtered = list
                .map(function (c) {
                    if (c && typeof c === 'object') return { id: String(c.id || '').trim(), name: String(c.name || '').trim() };
                    const name = String(c || '').trim();
                    return { id: '', name };
                })
                .filter(function (x) { return x && x.name && x.name.toLowerCase() !== 'inventario'; })
                .sort(function (a, b) { return a.name.localeCompare(b.name); });

            if (!filtered.length) {
                const empty = document.createElement('div');
                empty.className = 'px-4 py-6 text-sm text-center text-gray-500';
                empty.textContent = 'No hay categorías personalizadas.';
                catsAdminList.appendChild(empty);
                return;
            }

            filtered.forEach(function (c) {
                const row = document.createElement('div');
                row.className = 'px-4 py-3 flex items-center justify-between gap-3';
                row.innerHTML = '<div class="text-sm text-gray-800">' + c.name + '</div>';
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'text-xs text-red-700 hover:text-red-900';
                btn.textContent = 'Eliminar';
                btn.addEventListener('click', function () {
                    if (!c.id) return;
                    const go = function () {
                        apiJson('/expenses/api/categories/' + encodeURIComponent(c.id), { method: 'DELETE' })
                            .then(function () {
                                const selected = getSelectedCategories();
                                return renderSupplierCategories().then(function () {
                                    setSelectedCategories(selected);
                                    syncInventoryCheckbox();
                                    return renderCategoriesAdminList();
                                });
                            })
                            .catch(function (e) {
                                const msg = String(e && e.message ? e.message : 'No se pudo eliminar la categoría.');
                                if (window.showAlertModal) window.showAlertModal(msg, 'Atención', 'Error');
                                else alert(msg);
                            });
                    };
                    if (window.confirmModal) {
                        window.confirmModal(
                            '¿Eliminar la categoría “' + c.name + '”?',
                            'Eliminar categoría',
                            'Confirmación requerida',
                            { okText: 'Eliminar', cancelText: 'Cancelar' }
                        ).then(function (ok) { if (ok) go(); });
                    } else {
                        if (confirm('¿Eliminar la categoría “' + c.name + '”?')) go();
                    }
                });
                row.appendChild(btn);
                catsAdminList.appendChild(row);
            });
        };

        if (isPromise(res)) return res.then(apply).catch(function () { apply([]); });
        apply(res);
    }

    function addNewCategoryFromModal() {
        const name = String(inputNewCatName?.value || '').trim();
        if (!name) return;
        if (name.toLowerCase() === 'inventario') {
            if (window.showAlertModal) window.showAlertModal('La categoría “Inventario” es exclusiva del módulo de Inventario.', 'Atención', 'Categoría reservada');
            else alert('La categoría “Inventario” es exclusiva del módulo de Inventario.');
            return;
        }
        apiJson('/expenses/api/categories', {
            method: 'POST',
            body: JSON.stringify({ name: name })
        }).then(function () {
            const selected = getSelectedCategories();
            selected.push(name);
            renderSupplierCategories().then(function () {
                setSelectedCategories(selected);
                syncInventoryCheckbox();
                renderCategoriesAdminList();
                if (inputNewCatName) inputNewCatName.value = '';
            });
        }).catch(function (e) {
            const msg = String(e && e.message ? e.message : 'No se pudo crear la categoría.');
            if (window.showAlertModal) window.showAlertModal(msg, 'Atención', 'Error');
            else alert(msg);
        });
    }

    function getSelectedCategories() {
        if (!categoriesWrap) return [];
        return Array.from(categoriesWrap.querySelectorAll('input[type="checkbox"]'))
            .filter(cb => cb.checked)
            .map(cb => cb.value);
    }

    function setSelectedCategories(values) {
        if (!categoriesWrap) return;
        const set = new Set((values || []).map(String));
        categoriesWrap.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.checked = set.has(String(cb.value));
        });
    }

    function readAttachmentsMeta() {
        if (!attachments || !attachments.files) return [];
        return Array.from(attachments.files).map(f => ({
            name: f.name,
            size: f.size,
            type: f.type,
            lastModified: f.lastModified
        }));
    }

    function cargarDesdeId(id) {
        const sid = String(id || '').trim();
        if (!sid) return;
        apiJson('/suppliers/api/suppliers/' + encodeURIComponent(sid))
            .then(function (data) {
                const found = (data && data.item) ? data.item : null;
                if (!found) return;

            if (titulo) titulo.textContent = 'Editar proveedor';
            if (inputId) inputId.value = String(found.id);
            if (inputName) inputName.value = found.name || '';
            if (selectType) selectType.value = found.supplier_type || 'Services';
            if (selectStatus) selectStatus.value = found.status || 'Active';
            const metaParsed = parseMetaObj(found.meta_json || '');
            lastLoadedMetaObj = metaParsed;
            if (metaParsed && metaParsed.inventory_supplier === true) inventorySupplierFlag = true;
            setSelectedCategories(normalizeCategories(found.categories || []));
            syncInventoryCheckbox();

            if (invoiceType) invoiceType.value = found.invoice_type || '';
            if (defaultPayment) defaultPayment.value = found.default_payment_method || '';
            if (paymentTerms) paymentTerms.value = found.payment_terms || '';

            if (contactPerson) contactPerson.value = found.contact_person || '';
            if (phone) phone.value = found.phone || '';
            if (email) email.value = found.email || '';
            if (address) address.value = found.address || '';
            if (preferredChannel) preferredChannel.value = found.preferred_contact_channel || '';

            if (notes) notes.value = found.notes || '';

        }).catch(function () {
        });
    }

    function validarObligatorios() {
        const name = (inputName?.value || '').trim();
        const cats = getSelectedCategories();
        if (!name) return false;
        if (!inventorySupplierFlag && !cats.length) return false;
        return true;
    }

    function guardarProveedor() {
        if (!validarObligatorios()) {
            if (window.showAlertModal) window.showAlertModal('Completá los campos obligatorios: Nombre y al menos 1 categoría.', 'Atención', 'Validación requerida');
            else alert('Completá los campos obligatorios: Nombre y al menos 1 categoría.');
            return;
        }

        const id = (inputId?.value || '').trim() || '';

        const payload = {
            id,
            name: (inputName?.value || '').trim(),
            supplier_type: (selectType?.value || 'Services').trim(),
            categories: getSelectedCategories(),
            status: (selectStatus?.value || 'Active').trim(),
            invoice_type: (invoiceType?.value || '').trim(),
            default_payment_method: (defaultPayment?.value || '').trim(),
            payment_terms: (paymentTerms?.value || '').trim(),
            contact_person: (contactPerson?.value || '').trim(),
            phone: (phone?.value || '').trim(),
            email: (email?.value || '').trim(),
            address: (address?.value || '').trim(),
            preferred_contact_channel: (preferredChannel?.value || '').trim(),
            notes: (notes?.value || '').trim()
        };

        const filesMeta = readAttachmentsMeta();
        const metaObj = (lastLoadedMetaObj && typeof lastLoadedMetaObj === 'object' && !Array.isArray(lastLoadedMetaObj))
            ? { ...lastLoadedMetaObj }
            : {};
        if (inventorySupplierFlag) metaObj.inventory_supplier = true;
        else if (metaObj && metaObj.inventory_supplier) delete metaObj.inventory_supplier;
        if (filesMeta.length) metaObj.attachments = filesMeta;
        if (Object.keys(metaObj).length) {
            try {
                payload.meta_json = JSON.stringify(metaObj);
            } catch (e) {
            }
        }

        const isEdit = !!String(payload.id || '').trim();
        const url = isEdit
            ? ('/suppliers/api/suppliers/' + encodeURIComponent(String(payload.id)))
            : '/suppliers/api/suppliers';
        const method = isEdit ? 'PUT' : 'POST';

        apiJson(url, {
            method: method,
            body: JSON.stringify(payload)
        }).then(function (data) {
            const savedId = String((data && data.item && data.item.id) ? data.item.id : payload.id).trim();
            const savedName = String((data && data.item && data.item.name) ? data.item.name : payload.name).trim();
            if (returnTo) {
                const sep = returnTo.includes('?') ? '&' : '?';
                const next = returnTo + sep + 'supplier_id=' + encodeURIComponent(String(savedId)) + '&supplier_name=' + encodeURIComponent(savedName || '');
                window.location.href = next;
                return;
            }
            window.location.href = baseListUrl;
        }).catch(function (e) {
            if (window.showAlertModal) window.showAlertModal('No se pudo guardar el proveedor. ' + String(e && e.message ? e.message : ''), 'Atención', 'Error');
            else alert('No se pudo guardar el proveedor.');
        });
    }

    if (btnToggle && panelComp) {
        btnToggle.addEventListener('click', function() {
            panelComp.classList.toggle('hidden');
        });
    }

    if (btnGuardar) {
        btnGuardar.addEventListener('click', function() {
            guardarProveedor();
        });
    }

    if (inventoryCheckbox) {
        inventoryCheckbox.addEventListener('change', function () {
            inventorySupplierFlag = !!inventoryCheckbox.checked;
        });
    }

    if (btnManageCategories) {
        btnManageCategories.addEventListener('click', function () {
            openCategoriesModal();
        });
    }
    if (btnCloseCats) btnCloseCats.addEventListener('click', function () { closeCategoriesModal(); });
    if (btnCancelCats) btnCancelCats.addEventListener('click', function () { closeCategoriesModal(); });
    if (btnAddCat) btnAddCat.addEventListener('click', function () { addNewCategoryFromModal(); });
    if (inputNewCatName) {
        inputNewCatName.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                addNewCategoryFromModal();
            }
        });
    }

    renderSupplierCategories().then(function () {
        const id = params.get('id');
        if (id) {
            cargarDesdeId(id);
        } else {
            const cat = String(prefillCategory || '').trim();
            if (cat && cat.toLowerCase() === 'inventario') {
                inventorySupplierFlag = true;
            } else if (cat) {
                setSelectedCategories([cat]);
            }
            syncInventoryCheckbox();
        }
    });
});
</script>
{% endblock %}
