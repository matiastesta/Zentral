{% extends 'base.html' %}
{% block title %}Gastos{% endblock %}
{% block content %}
<div class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <div class="flex items-center gap-2">
                <h1 class="text-2xl font-bold text-gray-900">Gastos</h1>
                <button type="button" class="inline-flex items-center justify-center h-8 w-8 rounded-md hover:bg-gray-100 text-gray-600" data-kpi-toggle="expenses" data-kpi-key="expenses" data-kpi-target="#kpi-section-expenses" aria-expanded="true" aria-label="Mostrar/ocultar KPIs">
                    <i data-kpi-toggle-icon class="fas fa-chevron-down"></i>
                </button>
            </div>
            <p class="mt-1 text-sm text-gray-600">Controla los costos fijos y variables de tu negocio.</p>
        </div>
        <div class="flex gap-3">
            <a href="{{ url_for('expenses.new') }}" class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                <i class="fas fa-plus mr-2"></i> Nuevo gasto
            </a>
        </div>
    </div>

    <div id="kpi-section-expenses" class="grid grid-cols-1 md:grid-cols-4 gap-2 items-stretch">
        <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col items-center justify-center text-center">
            <div class="h-10 w-10 mb-2 flex items-center justify-center rounded-full bg-indigo-50 text-indigo-700">
                <i class="fas fa-money-bill-wave"></i>
            </div>
            <div>
                <p class="text-xs uppercase tracking-wide text-gray-500">Gastos de hoy</p>
                <p id="kpi-gastos-hoy" class="text-lg font-semibold text-gray-900">$0,00</p>
            </div>
        </div>

        <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col items-center justify-center text-center">
            <div class="h-10 w-10 mb-2 flex items-center justify-center rounded-full bg-blue-50 text-blue-700">
                <i class="fas fa-receipt"></i>
            </div>
            <div>
                <p class="text-xs uppercase tracking-wide text-gray-500">Cantidad de gastos de hoy</p>
                <p id="kpi-cant-gastos-hoy" class="text-lg font-semibold text-gray-900">0</p>
            </div>
        </div>

        <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col items-center justify-center text-center">
            <div class="h-10 w-10 mb-2 flex items-center justify-center rounded-full bg-emerald-50 text-emerald-700">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div>
                <p class="text-xs uppercase tracking-wide text-gray-500">Gastos del mes</p>
                <p id="kpi-gastos-mes" class="text-lg font-semibold text-gray-900">$0,00</p>
            </div>
        </div>

        <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col">
            <div class="text-center">
                <p class="text-xs uppercase tracking-wide text-gray-500">Top categorÃ­as (mes)</p>
            </div>
            <div class="mt-1 flex items-center gap-2" style="min-height:78px">
                <div class="relative flex items-center justify-start" style="width:78px;height:78px">
                    <svg id="kpi-top-cats-pie" viewBox="0 0 120 120" width="78" height="78" class="block"></svg>
                    <div id="kpi-top-cats-tooltip" class="hidden absolute top-0 left-0 pointer-events-none bg-white border border-gray-200 shadow-lg rounded-md px-2 py-1 text-[11px] text-gray-800"></div>
                </div>
                <div id="kpi-top-cats-legend" class="flex-1 space-y-0.5 text-[8px] leading-[1.05] overflow-hidden"></div>
            </div>
        </div>
    </div>

<!-- Historial de gastos -->
<div id="historial-gastos" class="bg-white rounded-xl shadow overflow-visible">
    <div class="px-4 py-3 border-b border-gray-100 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
        <div>
            <h2 class="text-sm font-semibold text-gray-900">Historial de movimientos</h2>
            <p class="text-xs text-gray-500">Gastos recientes.</p>
        </div>
        <div class="flex flex-wrap gap-2 text-[11px]">
            <button id="btn-export-gastos" type="button" class="px-3 py-1 rounded-md border border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 inline-flex items-center gap-2">
                <span>Exportar</span>
                <i class="fas fa-file-export text-[10px]"></i>
            </button>
        </div>
    </div>
    <table class="min-w-full divide-y divide-gray-200 text-xs">
        <thead class="bg-gray-50">
            <tr class="text-xs">
                <th id="th-sort-fecha" class="px-3 py-2 text-left text-gray-600 font-semibold align-bottom cursor-pointer select-none">
                    <span class="inline-flex items-center gap-1">
                        <span>Fecha</span>
                        <span id="sort-fecha" class="text-[10px] text-gray-400"></span>
                    </span>
                </th>
                <th class="px-3 py-2 text-left text-gray-600 font-semibold align-bottom">CategorÃ­a</th>
                <th id="th-sort-valor" class="px-3 py-2 text-right text-gray-600 font-semibold align-bottom cursor-pointer select-none">
                    <span class="inline-flex items-center gap-1 justify-end w-full">
                        <span>Valor</span>
                        <span id="sort-valor" class="text-[10px] text-gray-400"></span>
                    </span>
                </th>
                <th id="th-sort-proveedor" class="px-3 py-2 text-left text-gray-600 font-semibold align-bottom cursor-pointer select-none">
                    <span class="inline-flex items-center gap-1">
                        <span>Proveedor</span>
                        <span id="sort-proveedor" class="text-[10px] text-gray-400"></span>
                    </span>
                </th>
                <th class="px-3 py-2 text-left text-gray-600 font-semibold align-bottom">Nota</th>
                <th class="px-3 py-2 text-left text-gray-600 font-semibold align-bottom">Archivo</th>
                <th class="px-3 py-2 text-right text-gray-600 font-semibold align-bottom"></th>
            </tr>
            <tr class="text-[11px] bg-white align-middle">
                <th class="px-3 py-1">
                    <div class="inline-block min-w-[110px] max-w-[140px] w-full">
                        <input id="filtro-rango-gastos" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600" placeholder="dd/mm/aaaa - dd/mm/aaaa" readonly>
                    </div>
                </th>
                <th class="px-3 py-1">
                    <select id="filtro-categoria-gastos" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white">
                        <option value="">Todas</option>
                        <option value="Servicios pÃºblicos">Servicios pÃºblicos</option>
                        <option value="Gastos operativos">Gastos operativos</option>
                        <option value="Arriendo">Arriendo</option>
                        <option value="NÃ³mina">NÃ³mina</option>
                        <option value="Transportes">Transportes</option>
                        <option value="Mantenimiento y reparaciones">Mantenimiento y reparaciones</option>
                        <option value="Muebles, equipos o maquinarias">Muebles, equipos o maquinarias</option>
                        <option value="Otro">Otro</option>
                    </select>
                </th>
                <th class="px-3 py-1"></th>
                <th class="px-3 py-1">
                    <div class="relative" id="wrap-filtro-proveedor-gastos">
                        <input id="filtro-proveedor-gastos" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600" placeholder="Buscar proveedor" autocomplete="off">
                        <input id="filtro-proveedor-gastos-id" type="hidden" value="">
                        <div id="filtro-proveedor-gastos-dd" class="hidden absolute z-10 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg overflow-hidden"></div>
                    </div>
                </th>
                <th class="px-3 py-1"></th>
                <th class="px-3 py-1"></th>
                <th class="px-3 py-1"></th>
            </tr>
        </thead>
        <tbody id="gastos-tbody" class="bg-white divide-y divide-gray-200">
            <tr>
                <td colspan="7" class="px-4 py-6 text-sm text-center text-gray-500">TodavÃ­a no hay gastos registrados. Usa el botÃ³n "Nuevo gasto" para cargarlos.</td>
            </tr>
        </tbody>
    </table>

    <div class="hidden">
        <span id="gastos-total-periodo">$0,00</span>
    </div>
</div>

</div>

<div id="modal-export-gastos" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Exportar historial</h3>
                    <p class="text-xs text-gray-500">Se exporta exactamente lo que estÃ¡s viendo (con filtros aplicados).</p>
                </div>
                <button id="btn-close-export-gastos" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="btn-export-gastos-pdf" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                    <div class="text-3xl leading-none select-none">ðŸ“„</div>
                    <div class="mt-2 font-semibold text-gray-900">Exportar a PDF</div>
                    <div class="text-xs text-gray-500">Ideal para imprimir o enviar.</div>
                </button>
                <button id="btn-export-gastos-xls" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                    <div class="text-3xl leading-none select-none">ðŸ“Š</div>
                    <div class="mt-2 font-semibold text-gray-900">Exportar a Excel</div>
                    <div class="text-xs text-gray-500">Descarga un CSV compatible.</div>
                </button>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end">
                <button id="btn-cancel-export-gastos" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-preview-egreso" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Archivo adjunto</h3>
                    <p class="text-xs text-gray-500">Vista previa del comprobante asociado al gasto.</p>
                </div>
                <button id="btn-close-preview-egreso" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="preview-egreso-body" class="p-5 text-sm text-gray-700"></div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end">
                <button id="btn-cancel-preview-egreso" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const tbody = document.getElementById('gastos-tbody');
    const elTotalPeriodo = document.getElementById('gastos-total-periodo');

    const kpiGastosHoy = document.getElementById('kpi-gastos-hoy');
    const kpiCantGastosHoy = document.getElementById('kpi-cant-gastos-hoy');
    const kpiGastosMes = document.getElementById('kpi-gastos-mes');
    const kpiTopCatsPie = document.getElementById('kpi-top-cats-pie');
    const kpiTopCatsTooltip = document.getElementById('kpi-top-cats-tooltip');
    const kpiTopCatsLegend = document.getElementById('kpi-top-cats-legend');

    const btnExport = document.getElementById('btn-export-gastos');
    const modalExport = document.getElementById('modal-export-gastos');
    const btnCloseExport = document.getElementById('btn-close-export-gastos');
    const btnCancelExport = document.getElementById('btn-cancel-export-gastos');
    const btnExportPdf = document.getElementById('btn-export-gastos-pdf');
    const btnExportXls = document.getElementById('btn-export-gastos-xls');

    const modalPreview = document.getElementById('modal-preview-egreso');
    const previewBody = document.getElementById('preview-egreso-body');
    const btnClosePreview = document.getElementById('btn-close-preview-egreso');
    const btnCancelPreview = document.getElementById('btn-cancel-preview-egreso');

    const filtroRango = document.getElementById('filtro-rango-gastos');
    const filtroCategoria = document.getElementById('filtro-categoria-gastos');
    const filtroProveedor = document.getElementById('filtro-proveedor-gastos');
    const filtroProveedorId = document.getElementById('filtro-proveedor-gastos-id');
    const filtroProveedorDd = document.getElementById('filtro-proveedor-gastos-dd');

    const newUrl = "{{ url_for('expenses.new') }}";
    const suppliersNewUrl = "{{ url_for('suppliers.new') }}";

    const thSortFecha = document.getElementById('th-sort-fecha');
    const thSortValor = document.getElementById('th-sort-valor');
    const thSortProveedor = document.getElementById('th-sort-proveedor');
    const sortFecha = document.getElementById('sort-fecha');
    const sortValor = document.getElementById('sort-valor');
    const sortProveedor = document.getElementById('sort-proveedor');

    const sortState = { key: 'fecha', dir: 'desc' };

    let lastRendered = [];

    function formatearMoneda(valor) {
        const numero = isNaN(valor) ? 0 : valor;
        return '$' + numero.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtFecha(v) {
        try {
            if (window.formatFechaDisplay && typeof window.formatFechaDisplay === 'function') {
                return window.formatFechaDisplay(v);
            }
        } catch (e) {
        }
        return String(v ?? '');
    }

    function parseNumeroSeguro(v) {
        const n = parseFloat(String(v || '').replace(',', '.'));
        return isNaN(n) ? 0 : n;
    }

    function isSameDay(a, b) {
        if (!a || !b) return false;
        return a.getFullYear() === b.getFullYear() && a.getMonth() === b.getMonth() && a.getDate() === b.getDate();
    }

    function updateKpis(allEgresos) {
        const list = Array.isArray(allEgresos) ? allEgresos : [];
        const now = new Date();
        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const month = now.getMonth();
        const year = now.getFullYear();

        let totalHoy = 0;
        let countHoy = 0;
        let totalMes = 0;
        const cats = {};

        list.forEach(e => {
            if (e && e.meta && e.meta.supplier_cc_payment === true) return;
            const dt = parseFechaEgreso(e?.fecha);
            if (!dt) return;
            const val = parseNumeroSeguro(e?.valor);
            if (!(val > 0)) return;

            if (isSameDay(dt, today)) {
                totalHoy += val;
                countHoy += 1;
            }

            if (dt.getFullYear() === year && dt.getMonth() === month) {
                totalMes += val;
                const c = String(e?.categoria || 'Sin categorÃ­a').trim() || 'Sin categorÃ­a';
                cats[c] = (cats[c] || 0) + val;
            }
        });

        if (kpiGastosHoy) kpiGastosHoy.textContent = formatearMoneda(totalHoy);
        if (kpiCantGastosHoy) kpiCantGastosHoy.textContent = String(countHoy);
        if (kpiGastosMes) kpiGastosMes.textContent = formatearMoneda(totalMes);

        if (kpiTopCatsTooltip) {
            kpiTopCatsTooltip.classList.add('hidden');
        }

        if (!kpiTopCatsPie) return;

        const entriesAll = Object.keys(cats).map(k => ({ cat: k, total: cats[k] }));
        entriesAll.sort((a, b) => (b.total - a.total));

        if (!entriesAll.length || !(totalMes > 0)) {
            kpiTopCatsPie.innerHTML = '';
            if (kpiTopCatsLegend) kpiTopCatsLegend.innerHTML = '<div class="text-gray-500">Sin datos</div>';
            const empty = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            empty.setAttribute('x', '60');
            empty.setAttribute('y', '64');
            empty.setAttribute('text-anchor', 'middle');
            empty.setAttribute('font-size', '11');
            empty.setAttribute('fill', '#6b7280');
            empty.textContent = 'Sin datos';
            kpiTopCatsPie.appendChild(empty);
            return;
        }

        const maxSlices = 6;
        const main = entriesAll.slice(0, maxSlices - 1);
        const rest = entriesAll.slice(maxSlices - 1);
        const otrosTotal = rest.reduce((acc, x) => acc + (x.total || 0), 0);
        const entries = otrosTotal > 0 ? main.concat([{ cat: 'Otros', total: otrosTotal }]) : main;

        const palette = ['#4f46e5', '#2563eb', '#059669', '#d97706', '#db2777', '#0ea5e9', '#7c3aed', '#16a34a'];
        const cx = 60;
        const cy = 60;
        const r = 44;

        const svgNS = 'http://www.w3.org/2000/svg';
        kpiTopCatsPie.innerHTML = '';

        const bg = document.createElementNS(svgNS, 'circle');
        bg.setAttribute('cx', String(cx));
        bg.setAttribute('cy', String(cy));
        bg.setAttribute('r', String(r));
        bg.setAttribute('fill', '#f3f4f6');
        kpiTopCatsPie.appendChild(bg);

        const polar = function (angleDeg) {
            const a = (angleDeg - 90) * Math.PI / 180;
            return { x: cx + r * Math.cos(a), y: cy + r * Math.sin(a) };
        };

        const tooltip = function (evt, label) {
            if (!kpiTopCatsTooltip) return;
            const box = kpiTopCatsPie.getBoundingClientRect();
            const x = (evt.clientX - box.left);
            const y = (evt.clientY - box.top);
            kpiTopCatsTooltip.textContent = label;
            const maxX = Math.max(0, box.width - 10);
            const maxY = Math.max(0, box.height - 10);
            kpiTopCatsTooltip.style.transform = 'translate(' + Math.min(maxX, Math.max(0, x + 10)) + 'px,' + Math.min(maxY, Math.max(0, y + 10)) + 'px)';
            kpiTopCatsTooltip.classList.remove('hidden');
        };

        const hideTooltip = function () {
            if (!kpiTopCatsTooltip) return;
            kpiTopCatsTooltip.classList.add('hidden');
        };

        if (kpiTopCatsLegend) kpiTopCatsLegend.innerHTML = '';

        const maxLegendItems = 3;

        let start = 0;
        entries.forEach((item, idx) => {
            const frac = (item.total || 0) / totalMes;
            const sweep = frac * 360;
            const end = start + sweep;
            const pct = frac * 100;
            const pctTxt = (Math.round(pct * 10) / 10).toFixed(1).replace(/\.0$/, '') + '%';
            const label = String(item.cat) + ' Â· ' + pctTxt + ' Â· ' + formatearMoneda(item.total || 0);

            if (kpiTopCatsLegend && idx < maxLegendItems) {
                const row = document.createElement('div');
                row.className = 'flex items-center gap-1 text-[11px] leading-4';
                row.innerHTML = ''
                    + '<div class="min-w-0 flex items-center gap-1 flex-1">'
                    +   '<span class="h-1.5 w-1.5 rounded-full" style="background-color:' + palette[idx % palette.length] + '"></span>'
                    +   '<span class="truncate text-gray-700 flex-1">' + String(item.cat) + '</span>'
                    + '</div>'
                    + '<span class="text-gray-500 w-9 shrink-0 text-right tabular-nums">' + pctTxt + '</span>';
                kpiTopCatsLegend.appendChild(row);
            }

            if (sweep >= 359.99) {
                const full = document.createElementNS(svgNS, 'circle');
                full.setAttribute('cx', String(cx));
                full.setAttribute('cy', String(cy));
                full.setAttribute('r', String(r));
                full.setAttribute('fill', palette[idx % palette.length]);
                full.setAttribute('stroke', '#ffffff');
                full.setAttribute('stroke-width', '1');
                full.style.cursor = 'pointer';
                full.addEventListener('mousemove', function (evt) { tooltip(evt, label); });
                full.addEventListener('mouseenter', function (evt) { tooltip(evt, label); });
                full.addEventListener('mouseleave', function () { hideTooltip(); });
                kpiTopCatsPie.appendChild(full);
            } else {
                const p1 = polar(start);
                const p2 = polar(end);
                const large = sweep > 180 ? '1' : '0';
                const path = document.createElementNS(svgNS, 'path');
                const d = [
                    'M', cx, cy,
                    'L', p1.x.toFixed(2), p1.y.toFixed(2),
                    'A', r, r, 0, large, 1, p2.x.toFixed(2), p2.y.toFixed(2),
                    'Z'
                ].join(' ');
                path.setAttribute('d', d);
                path.setAttribute('fill', palette[idx % palette.length]);
                path.setAttribute('stroke', '#ffffff');
                path.setAttribute('stroke-width', '1');
                path.style.cursor = 'pointer';
                path.addEventListener('mousemove', function (evt) { tooltip(evt, label); });
                path.addEventListener('mouseenter', function (evt) { tooltip(evt, label); });
                path.addEventListener('mouseleave', function () { hideTooltip(); });
                kpiTopCatsPie.appendChild(path);
            }
            start = end;
        });

        const hole = document.createElementNS(svgNS, 'circle');
        hole.setAttribute('cx', String(cx));
        hole.setAttribute('cy', String(cy));
        hole.setAttribute('r', '22');
        hole.setAttribute('fill', '#ffffff');
        kpiTopCatsPie.appendChild(hole);

        const centerText = document.createElementNS(svgNS, 'text');
        centerText.setAttribute('x', String(cx));
        centerText.setAttribute('y', String(cy + 4));
        centerText.setAttribute('text-anchor', 'middle');
        centerText.setAttribute('font-size', '10');
        centerText.setAttribute('fill', '#111827');
        centerText.textContent = 'Mes';
        kpiTopCatsPie.appendChild(centerText);
    }

    function iconoCategoria(categoria) {
        const c = String(categoria || '').toLowerCase();
        if (c.includes('nÃ³mina') || c.includes('nomina')) return 'fa-user-tie';
        if (c.includes('servicios')) return 'fa-bolt';
        if (c.includes('gastos operativos')) return 'fa-receipt';
        if (c.includes('arriendo')) return 'fa-house';
        if (c.includes('transporte')) return 'fa-truck-fast';
        if (c.includes('mantenimiento') || c.includes('reparaciones')) return 'fa-screwdriver-wrench';
        if (c.includes('muebles') || c.includes('equipos') || c.includes('maquinarias')) return 'fa-industry';
        if (c.includes('otro')) return 'fa-tag';
        return 'fa-tag';
    }

    function leerEgresos() {
        try {
            if (window.StorageService && typeof window.StorageService.getExpenses === 'function') {
                return window.StorageService.getExpenses();
            }
        } catch (e) {
        }
        return [];
    }

    function deleteEgresoById(id) {
        const eid = String(id || '').trim();
        if (!eid) return;

        fetch('/expenses/api/expenses/' + encodeURIComponent(eid), {
            method: 'DELETE',
            credentials: 'same-origin'
        })
            .then(r => r.json().catch(() => ({})))
            .then(function (data) {
                if (data && data.ok === true) {
                    renderTabla();
                    return;
                }
                if (window.showAlertModal) window.showAlertModal('No se pudo eliminar el gasto. IntentÃ¡ nuevamente.', 'AtenciÃ³n', 'Error');
                else alert('No se pudo eliminar el gasto.');
            })
            .catch(function () {
                if (window.showAlertModal) window.showAlertModal('No se pudo eliminar el gasto. RevisÃ¡ tu conexiÃ³n e intentÃ¡ nuevamente.', 'AtenciÃ³n', 'Error');
                else alert('No se pudo eliminar el gasto.');
            });
    }

    function openPreviewEgreso(files) {
        if (!modalPreview || !previewBody) return;
        const list = Array.isArray(files) ? files : [];

        if (!list.length) {
            previewBody.innerHTML = '<div class="text-sm text-gray-600">Este gasto no tiene archivos adjuntos.</div>';
        } else {
            const rows = list.map(function (f) {
                const name = String(f?.name || 'Archivo');
                const type = String(f?.type || '').trim();
                const size = (typeof f?.size === 'number') ? f.size : parseInt(f?.size || 0, 10) || 0;
                const sizeKb = size ? Math.round(size / 1024) : 0;
                const url = String(f?.url || f?.data_url || '').trim();
                const openLink = url ? ('<a class="text-indigo-700 hover:underline" href="' + url.replace(/"/g, '&quot;') + '" target="_blank" rel="noopener">Descargar</a>') : '<span class="text-gray-400">â€”</span>';

                return ''
                    + '<tr class="border-b border-gray-100">'
                    + '<td class="py-2 pr-2 text-gray-900">' + name.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</td>'
                    + '<td class="py-2 pr-2 text-gray-500">' + (type ? type.replace(/</g, '&lt;').replace(/>/g, '&gt;') : 'â€”') + '</td>'
                    + '<td class="py-2 pr-2 text-gray-500">' + (sizeKb ? (String(sizeKb) + ' KB') : 'â€”') + '</td>'
                    + '<td class="py-2 text-right">' + openLink + '</td>'
                    + '</tr>';
            }).join('');

            previewBody.innerHTML = ''
                + '<div class="overflow-auto">'
                + '<table class="w-full text-xs">'
                + '<thead><tr class="text-gray-600">'
                + '<th class="text-left font-semibold py-2 pr-2">Nombre</th>'
                + '<th class="text-left font-semibold py-2 pr-2">Tipo</th>'
                + '<th class="text-left font-semibold py-2 pr-2">TamaÃ±o</th>'
                + '<th class="text-right font-semibold py-2">AcciÃ³n</th>'
                + '</tr></thead>'
                + '<tbody>' + rows + '</tbody>'
                + '</table>'
                + '</div>';
        }

        modalPreview.classList.remove('hidden');
    }

    function closePreviewEgreso() {
        if (!modalPreview) return;
        modalPreview.classList.add('hidden');
        if (previewBody) previewBody.innerHTML = '';
    }

    function leerSuppliers() {
        try {
            if (window.StorageService && typeof window.StorageService.getSuppliers === 'function') {
                return window.StorageService.getSuppliers();
            }
        } catch (e) {
        }
        return [];
    }

    function isPromise(x) {
        return !!x && typeof x.then === 'function';
    }

    function setProveedorFiltro(id, name) {
        if (filtroProveedorId) filtroProveedorId.value = id ? String(id) : '';
        if (filtroProveedor) filtroProveedor.value = name ? String(name) : '';
    }

    function hideProveedorDd() {
        if (!filtroProveedorDd) return;
        filtroProveedorDd.classList.add('hidden');
        filtroProveedorDd.innerHTML = '';
    }

    function showProveedorDd(items, query) {
        if (!filtroProveedorDd) return;
        filtroProveedorDd.innerHTML = '';
        const q = String(query || '').trim();

        items.forEach(s => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'w-full text-left px-3 py-2 text-sm hover:bg-gray-50';
            btn.textContent = String(s?.name || 'Proveedor');
            btn.addEventListener('click', function () {
                setProveedorFiltro(s?.id || '', s?.name || '');
                hideProveedorDd();
                renderTabla();
            });
            filtroProveedorDd.appendChild(btn);
        });

        if (q && !items.length) {
            const empty = document.createElement('div');
            empty.className = 'px-3 py-2 text-xs text-gray-500';
            empty.textContent = 'Sin coincidencias.';
            filtroProveedorDd.appendChild(empty);
        }

        if (q) {
            const hr = document.createElement('div');
            hr.className = 'h-px bg-gray-100';
            filtroProveedorDd.appendChild(hr);

            const btnCreate = document.createElement('button');
            btnCreate.type = 'button';
            btnCreate.className = 'w-full text-left px-3 py-2 text-sm text-blue-700 hover:bg-blue-50';
            btnCreate.textContent = '+ Crear proveedor';
            btnCreate.addEventListener('click', function () {
                const returnTo = window.location.pathname + window.location.search;
                window.location.href = suppliersNewUrl + '?return_to=' + encodeURIComponent(returnTo);
            });
            filtroProveedorDd.appendChild(btnCreate);
        }

        if (!items.length && !q) {
            hideProveedorDd();
            return;
        }
        filtroProveedorDd.classList.remove('hidden');
    }

    function actualizarProveedorDd() {
        const q = (filtroProveedor?.value || '').trim().toLowerCase();
        if (!q) {
            hideProveedorDd();
            return;
        }
        const res = leerSuppliers();
        const apply = function (suppliers) {
            const items = (Array.isArray(suppliers) ? suppliers : [])
                .filter(s => (s?.status || 'Active') !== 'Discontinued')
                .filter(s => String(s?.name || '').toLowerCase().includes(q))
                .slice(0, 10);
            showProveedorDd(items, q);
        };
        if (isPromise(res)) res.then(apply).catch(() => apply([]));
        else apply(res);
    }

    function parseRangoFechas(raw) {
        const txt = String(raw || '').trim();
        const normalized = txt.replace(/\s+a\s+/i, ' - ').replace(/\s+to\s+/i, ' - ');
        const parts = normalized.split(' - ').map(p => p.trim()).filter(Boolean);
        if (parts.length !== 2) return null;
        const [d1, m1, y1] = parts[0].split('/').map(x => parseInt(x, 10));
        const [d2, m2, y2] = parts[1].split('/').map(x => parseInt(x, 10));
        if (!d1 || !m1 || !y1 || !d2 || !m2 || !y2) return null;
        const a = new Date(y1, m1 - 1, d1);
        const b = new Date(y2, m2 - 1, d2);
        if (isNaN(a.getTime()) || isNaN(b.getTime())) return null;
        a.setHours(0, 0, 0, 0);
        b.setHours(23, 59, 59, 999);
        return { from: a, to: b };
    }

    function parseFechaEgreso(raw) {
        const v = String(raw || '').trim();
        if (!v) return null;
        if (v.includes('/')) {
            const [d, m, y] = v.split('/').map(x => parseInt(x, 10));
            if (!d || !m || !y) return null;
            const dt = new Date(y, m - 1, d);
            return isNaN(dt.getTime()) ? null : dt;
        }
        const dt = new Date(v);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function formatFechaLabel(dt) {
        if (!dt) return '-';
        const d = String(dt.getDate()).padStart(2, '0');
        const m = String(dt.getMonth() + 1).padStart(2, '0');
        const y = String(dt.getFullYear());
        return d + '/' + m + '/' + y;
    }

    function startOfDay(dt) {
        const x = new Date(dt.getFullYear(), dt.getMonth(), dt.getDate());
        x.setHours(0, 0, 0, 0);
        return x;
    }

    function labelDia(dt) {
        if (!dt) return '';
        const today = startOfDay(new Date());
        const d = startOfDay(dt);
        const diff = Math.round((today.getTime() - d.getTime()) / 86400000);
        if (diff === 0) return 'Hoy';
        if (diff === 1) return 'Ayer';
        return '';
    }

    function badgeEstadoPago(status) {
        const s = String(status || '').trim();
        if (!s) return '';
        if (s === 'Pending' || s === 'Pendiente') {
            return '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] font-medium bg-yellow-50 text-yellow-700"><i class="fas fa-clock text-[10px]"></i> Pendiente</span>';
        }
        if (s === 'Paid' || s === 'Pagado') {
            return '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] font-medium bg-green-50 text-green-700"><i class="fas fa-check-circle text-[10px]"></i> Pagado</span>';
        }
        return '';
    }

    function badgeOrigen(origin) {
        const o = String(origin || '').trim();
        if (!o || o === 'Manual' || o === 'manual') {
            return '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-50 text-gray-700"><i class="fas fa-pen text-[10px]"></i> Manual</span>';
        }
        if (o === 'Inventory' || o === 'inventory') {
            return '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] font-medium bg-blue-50 text-blue-700"><i class="fas fa-box text-[10px]"></i> Inventario</span>';
        }
        return '<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[11px] font-medium bg-gray-50 text-gray-700"><i class="fas fa-link text-[10px]"></i> ' + o + '</span>';
    }

    function escapeHtml(v) {
        return String(v ?? '')
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function buildNoteCellHtml(note, rowKey) {
        const raw = String(note || '');
        const parts = raw.split(/\r?\n/);
        const summary = String(parts[0] || '').trim();
        const rest = String(parts.slice(1).join('\n') || '').trim();
        const sid = 'note_' + String(rowKey || '').replace(/[^a-zA-Z0-9_-]/g, '').slice(0, 40);
        const summaryHtml = escapeHtml(summary || raw).replace(/\n/g, '<br>');
        const restHtml = escapeHtml(rest).replace(/\n/g, '<br>');
        if (!restHtml) return '<div class="whitespace-pre-line">' + summaryHtml + '</div>';
        return ''
            + '<div class="whitespace-pre-line">'
            +   '<div>' + summaryHtml + '</div>'
            +   '<button type="button" class="btn-note-toggle mt-1 text-[11px] text-indigo-700 hover:text-indigo-900" data-target="' + sid + '" data-open="0">Ver mÃ¡s</button>'
            +   '<div id="' + sid + '" class="hidden mt-1 text-gray-500">' + restHtml + '</div>'
            + '</div>';
    }

    function buildTraceHint(e) {
        const createdAt = String(e?.created_at || '').trim();
        const originRef = String(e?.origin_ref || '').trim();
        if (!createdAt && !originRef) return '';
        const titleParts = [];
        if (originRef) titleParts.push('Ref: ' + originRef);
        if (createdAt) titleParts.push('Creado: ' + fmtFecha(createdAt));
        const title = escapeHtml(titleParts.join(' | '));
        return '<span class="ml-2 text-gray-400" title="' + title + '"><i class="fas fa-receipt"></i></span>';
    }

    function countAdjuntos(e) {
        const files = e?.comprobante;
        return Array.isArray(files) ? files.length : 0;
    }

    function setSort(key) {
        if (sortState.key === key) {
            sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
        } else {
            sortState.key = key;
            sortState.dir = key === 'fecha' ? 'desc' : 'asc';
        }
        renderTabla();
    }

    function renderSortIndicators() {
        if (sortFecha) sortFecha.textContent = sortState.key === 'fecha' ? (sortState.dir === 'asc' ? 'â†‘' : 'â†“') : '';
        if (sortValor) sortValor.textContent = sortState.key === 'valor' ? (sortState.dir === 'asc' ? 'â†‘' : 'â†“') : '';
        if (sortProveedor) sortProveedor.textContent = sortState.key === 'proveedor' ? (sortState.dir === 'asc' ? 'â†‘' : 'â†“') : '';
    }

    function renderTabla() {
        if (!tbody) return;
        tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-sm text-center text-gray-500">Cargandoâ€¦</td></tr>';

        const res = leerEgresos();
        const apply = function (arr) {
        const egresosAll = Array.isArray(arr) ? arr.slice() : [];
        updateKpis(egresosAll);
        let egresos = egresosAll
            .filter(e => !(e && e.meta && e.meta.supplier_cc_payment === true))
            .slice();

        const rango = parseRangoFechas(filtroRango?.value);
        if (rango) {
            egresos = egresos.filter(e => {
                const dt = parseFechaEgreso(e?.fecha);
                if (!dt) return true;
                return dt >= rango.from && dt <= rango.to;
            });
        }

        const categoriaFiltro = (filtroCategoria?.value || '').trim();
        if (categoriaFiltro) {
            egresos = egresos.filter(e => String(e?.categoria || '') === categoriaFiltro);
        }

        const proveedorId = (filtroProveedorId?.value || '').trim();
        const proveedorQ = (filtroProveedor?.value || '').trim().toLowerCase();
        if (proveedorId) {
            egresos = egresos.filter(e => String(e?.supplier_id || '') === proveedorId);
        } else if (proveedorQ) {
            egresos = egresos.filter(e => String(e?.supplier_name || e?.proveedor || '').toLowerCase().includes(proveedorQ));
        }

        const totalPeriodo = egresos.reduce((acc, e) => acc + parseNumeroSeguro(e?.valor), 0);
        if (elTotalPeriodo) elTotalPeriodo.textContent = formatearMoneda(totalPeriodo);

        const dirMul = sortState.dir === 'asc' ? 1 : -1;
        egresos.sort((a, b) => {
            if (sortState.key === 'valor') {
                return (parseNumeroSeguro(a?.valor) - parseNumeroSeguro(b?.valor)) * dirMul;
            }
            if (sortState.key === 'proveedor') {
                return String(a?.supplier_name || a?.proveedor || '').localeCompare(String(b?.supplier_name || b?.proveedor || '')) * dirMul;
            }
            const da = parseFechaEgreso(a?.fecha);
            const db = parseFechaEgreso(b?.fecha);
            const ta = da ? da.getTime() : 0;
            const tb = db ? db.getTime() : 0;
            return (ta - tb) * dirMul;
        });

        renderSortIndicators();

        lastRendered = egresos.slice();

        tbody.innerHTML = '';
        if (!egresos.length) {
            const tr = document.createElement('tr');
            tr.innerHTML = '<td colspan="7" class="px-4 py-6 text-sm text-center text-gray-500">TodavÃ­a no hay gastos registrados. Usa el botÃ³n "Nuevo gasto" para cargarlos.</td>';
            tbody.appendChild(tr);
            return;
        }

        egresos.forEach(e => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50 group';
            const adjCount = countAdjuntos(e);

            const noteHtml = buildNoteCellHtml((e?.nota || ''), (e?.id || e?.fecha || ''));

            const files = Array.isArray(e?.comprobante) ? e.comprobante : [];
            const fileBtn = adjCount
                ? ('<button type="button" class="btn-egreso-file inline-flex items-center gap-1 text-indigo-700 hover:text-indigo-900" data-id="' + String(e?.id || '') + '"><i class="fas fa-paperclip"></i><span class="text-[11px]">Ver (' + String(adjCount) + ')</span></button>')
                : '<span class="text-gray-400">â€”</span>';

            tr.innerHTML = `
                <td class="px-3 py-2 text-xs text-gray-500">${fmtFecha(e?.fecha || '-')}</td>
                <td class="px-3 py-2 text-xs text-gray-700">
                    <span class="inline-flex items-center gap-2">
                        <i class="fas ${iconoCategoria(e?.categoria)} text-gray-400"></i>
                        <span>${e?.categoria || '-'}</span>
                    </span>
                </td>
                <td class="px-3 py-2 text-xs text-right text-gray-700">${formatearMoneda(parseNumeroSeguro(e?.valor))}</td>
                <td class="px-3 py-2 text-xs text-gray-700">${e?.supplier_name || e?.proveedor || '-'}</td>
                <td class="px-3 py-2 text-xs text-gray-500">${noteHtml}</td>
                <td class="px-3 py-2 text-xs text-gray-500">${fileBtn}</td>
                <td class="px-3 py-2 text-xs text-right">
                    <div class="inline-flex items-center justify-end gap-1">
                        <button type="button" class="btn-egreso-remito h-8 w-8 inline-flex items-center justify-center rounded-full hover:bg-gray-100" title="Descargar remito" data-id="${e?.id}">ðŸ§¾</button>
                        <div class="relative inline-block text-left">
                            <button type="button" class="btn-egreso-menu inline-flex items-center justify-center h-8 w-8 rounded-full hover:bg-gray-100" data-id="${e?.id}">
                                <i class="fas fa-ellipsis-v text-gray-500 text-xs"></i>
                            </button>
                            <div class="menu-egreso-acciones hidden origin-top-right absolute right-0 mt-1 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">
                                <div class="py-1 text-[11px]">
                                    <button type="button" class="w-full text-left px-3 py-2 hover:bg-gray-100" data-action="edit" data-id="${e?.id}">Editar</button>
                                    <button type="button" class="w-full text-left px-3 py-2 text-red-700 hover:bg-red-50" data-action="delete" data-id="${e?.id}">Eliminar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });
        };
        if (isPromise(res)) res.then(apply).catch(() => apply([]));
        else apply(res);
    }

    if (tbody) {
        tbody.addEventListener('click', function(e) {
            const btnNote = e.target.closest('.btn-note-toggle');
            if (btnNote) {
                const targetId = String(btnNote.getAttribute('data-target') || '').trim();
                if (!targetId) return;
                const el = document.getElementById(targetId);
                if (!el) return;
                const open = String(btnNote.getAttribute('data-open') || '0') === '1';
                el.classList.toggle('hidden', open);
                btnNote.setAttribute('data-open', open ? '0' : '1');
                btnNote.textContent = open ? 'Ver mÃ¡s' : 'Ver menos';
                return;
            }

            const btnRemito = e.target.closest('.btn-egreso-remito');
            if (btnRemito) {
                const id = btnRemito.getAttribute('data-id');
                if (!id) return;
                window.location.href = '/expenses/api/expenses/' + encodeURIComponent(String(id)) + '/remito.pdf';
                return;
            }

            const btnMenu = e.target.closest('.btn-egreso-menu');
            if (btnMenu) {
                const root = btnMenu.parentElement;
                const menu = root ? root.querySelector('.menu-egreso-acciones') : null;
                if (!menu) return;
                const isOpen = !menu.classList.contains('hidden');
                Array.from(document.querySelectorAll('.menu-egreso-acciones')).forEach(m => m.classList.add('hidden'));
                if (!isOpen) menu.classList.remove('hidden');
                return;
            }

            const act = e.target.closest('.menu-egreso-acciones button[data-action]');
            if (act) {
                const action = act.getAttribute('data-action');
                const id = act.getAttribute('data-id');
                Array.from(document.querySelectorAll('.menu-egreso-acciones')).forEach(m => m.classList.add('hidden'));
                if (!id) return;
                if (action === 'edit') {
                    window.location.href = newUrl + '?id=' + encodeURIComponent(id);
                    return;
                }
                if (action === 'delete') {
                    if (window.confirmModal) {
                        window.confirmModal(
                            'Â¿Eliminar gasto? Esta acciÃ³n no se puede deshacer.',
                            'Eliminar gasto',
                            'ConfirmaciÃ³n requerida',
                            { okText: 'Eliminar', cancelText: 'Cancelar' }
                        ).then(function (ok) {
                            if (!ok) return;
                            deleteEgresoById(id);
                        });
                        return;
                    }
                    const ok = confirm('Â¿Eliminar gasto? Esta acciÃ³n no se puede deshacer.');
                    if (!ok) return;
                    deleteEgresoById(id);
                    return;
                }
                return;
            }

            const btnFile = e.target.closest('.btn-egreso-file');
            if (btnFile) {
                const id = btnFile.getAttribute('data-id');
                if (!id) return;
                const eg = (Array.isArray(lastRendered) ? lastRendered : []).find(x => String(x?.id || '') === String(id));
                openPreviewEgreso(eg?.comprobante || []);
                return;
            }
        });
    }

    if (tbody) {
        tbody.addEventListener('click', function(e) {
            const btnDup = e.target.closest('.btn-duplicar-egreso');
            if (!btnDup) return;
            const id = btnDup.getAttribute('data-id');
            if (!id) return;
            window.location.href = newUrl + '?duplicate_id=' + encodeURIComponent(id);
        });
    }

    document.addEventListener('click', function (ev) {
        const target = ev.target;
        const anyMenu = target && target.closest ? target.closest('.menu-egreso-acciones') : null;
        const anyBtn = target && target.closest ? target.closest('.btn-egreso-menu') : null;
        if (anyMenu || anyBtn) return;
        Array.from(document.querySelectorAll('.menu-egreso-acciones')).forEach(m => m.classList.add('hidden'));
    });

    if (btnClosePreview) btnClosePreview.addEventListener('click', function () { closePreviewEgreso(); });
    if (btnCancelPreview) btnCancelPreview.addEventListener('click', function () { closePreviewEgreso(); });
    if (modalPreview) {
        modalPreview.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalPreview.firstElementChild) closePreviewEgreso();
        });
    }

    if (thSortFecha) thSortFecha.addEventListener('click', function () { setSort('fecha'); });
    if (thSortValor) thSortValor.addEventListener('click', function () { setSort('valor'); });
    if (thSortProveedor) thSortProveedor.addEventListener('click', function () { setSort('proveedor'); });

    if (filtroCategoria) {
        filtroCategoria.addEventListener('change', function() {
            renderTabla();
        });
    }

    if (filtroProveedor) {
        filtroProveedor.addEventListener('input', function() {
            if (filtroProveedorId) filtroProveedorId.value = '';
            actualizarProveedorDd();
            renderTabla();
        });
        filtroProveedor.addEventListener('focus', function () {
            actualizarProveedorDd();
        });
        filtroProveedor.addEventListener('blur', function () {
            window.setTimeout(function () {
                hideProveedorDd();
            }, 120);
        });
    }

    document.addEventListener('click', function (ev) {
        const wrap = document.getElementById('wrap-filtro-proveedor-gastos');
        if (!wrap) return;
        if (!wrap.contains(ev.target)) hideProveedorDd();
    });

    if (filtroRango && window.flatpickr) {
        flatpickr(filtroRango, {
            mode: 'range',
            dateFormat: 'd/m/Y',
            locale: window.flatpickr && window.flatpickr.l10ns ? window.flatpickr.l10ns.es : 'es',
            allowInput: false,
            onChange: function (selectedDates) {
                if (Array.isArray(selectedDates) && selectedDates.length === 2) {
                    renderTabla();
                }
            },
            onClose: function (selectedDates) {
                if (Array.isArray(selectedDates) && selectedDates.length === 2) {
                    renderTabla();
                }
            }
        });
        filtroRango.addEventListener('change', function () {
            renderTabla();
        });
    }

    function openExport() {
        if (!modalExport) return;
        modalExport.classList.remove('hidden');
    }
    function closeExport() {
        if (!modalExport) return;
        modalExport.classList.add('hidden');
    }

    function getPeriodLabelSafe() {
        const raw = String(filtroRango?.value || '').trim();
        return raw ? raw : 'todo';
    }

    function escapeCsvCell(v) {
        const s = String(v ?? '');
        if (/[\n\r",;]/.test(s)) {
            return '"' + s.replace(/"/g, '""') + '"';
        }
        return s;
    }

    function exportCsv() {
        const rows = lastRendered || [];
        const header = ['Fecha','CategorÃ­a','Valor','Proveedor','Origen','Origin Ref','Creado','Nota'];
        const lines = [header.map(escapeCsvCell).join(';')];
        rows.forEach(e => {
            lines.push([
                fmtFecha(e?.fecha || ''),
                e?.categoria || '',
                String(parseNumeroSeguro(e?.valor)),
                e?.supplier_name || e?.proveedor || '',
                e?.origin || '',
                e?.origin_ref || '',
                fmtFecha(e?.created_at || ''),
                e?.nota || ''
            ].map(escapeCsvCell).join(';'));
        });
        const blob = new Blob(["\ufeff" + lines.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        const period = getPeriodLabelSafe().replace(/\s+/g, '_').replace(/\//g, '-');
        a.href = URL.createObjectURL(blob);
        a.download = 'gastos_' + period + '.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.setTimeout(function () { URL.revokeObjectURL(a.href); }, 500);
    }

    function exportPdfPrint() {
        const rows = lastRendered || [];
        const w = window.open('', '_blank');
        if (!w) return;
        const period = getPeriodLabelSafe();
        const totalTxt = elTotalPeriodo ? (elTotalPeriodo.textContent || '') : '';

        const rowsHtml = rows.map(function (e) {
            return ''
                + '<tr>'
                + '<td>' + String(fmtFecha(e?.fecha || '')) + '</td>'
                + '<td>' + String(e?.categoria || '') + '</td>'
                + '<td class="num">' + String(formatearMoneda(parseNumeroSeguro(e?.valor)) || '') + '</td>'
                + '<td>' + String(e?.supplier_name || e?.proveedor || '') + '</td>'
                + '<td>' + String(e?.origin || '') + '</td>'
                + '<td>' + String(e?.origin_ref || '') + '</td>'
                + '<td>' + String(fmtFecha(e?.created_at || '')) + '</td>'
                + '<td>' + String(e?.nota || '') + '</td>'
                + '</tr>';
        }).join('');

        const html = `
<!doctype html>
<html lang="es"><head><meta charset="utf-8" />
<title>Exportar gastos</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#111}
h1{font-size:18px;margin:0 0 6px 0}
p{margin:0 0 14px 0;color:#555;font-size:12px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}
th{background:#f9fafb}
td.num,th.num{text-align:right}
.meta{display:flex;justify-content:space-between;gap:12px;align-items:flex-end;margin-bottom:12px}
.pill{font-size:12px;color:#111}
</style>
</head><body>
<div class="meta">
  <div>
    <h1>Historial de gastos</h1>
    <p>PerÃ­odo: ${period}</p>
  </div>
  <div class="pill">Total del perÃ­odo mostrado: <strong>${totalTxt}</strong></div>
</div>
<table>
  <thead><tr>
    <th>Fecha</th><th>CategorÃ­a</th><th class="num">Valor</th><th>Proveedor</th><th>Origen</th><th>Ref</th><th>Creado</th><th>Nota</th>
  </tr></thead>
  <tbody>
    ` + rowsHtml + `
  </tbody>
</table>
<script>window.onload=function(){window.print();}<\/script>
</body></html>`;
        w.document.open();
        w.document.write(html);
        w.document.close();
    }

    if (btnExport) btnExport.addEventListener('click', function () { openExport(); });
    if (btnCloseExport) btnCloseExport.addEventListener('click', function () { closeExport(); });
    if (btnCancelExport) btnCancelExport.addEventListener('click', function () { closeExport(); });
    if (modalExport) {
        modalExport.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalExport.firstElementChild) closeExport();
        });
    }
    if (btnExportXls) btnExportXls.addEventListener('click', function () { exportCsv(); closeExport(); });
    if (btnExportPdf) btnExportPdf.addEventListener('click', function () { exportPdfPrint(); closeExport(); });

    renderTabla();
});
</script>
{% endblock %}
