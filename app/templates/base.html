<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} - Zentral</title>
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- flatpickr CSS (date picker) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    {% block styles %}{% endblock %}
</head>
{% set brand_color = (business.primary_color if business and business.primary_color else '#0d1067') %}
{% set bg_brightness = (business.background_brightness if business and business.background_brightness else 1.0) %}
{% set bg_contrast = (business.background_contrast if business and business.background_contrast else 1.0) %}
{% set bg_img = (url_for('files.download_file_api', file_id=business.background_file_id) if business and business.background_file_id else (url_for('static', filename='uploads/' ~ business.background_image_filename) if business and business.background_image_filename else '')) %}
<body class="bg-gray-100" style="background-color: #fbf9f5; --brand-color: {{ brand_color }}; --app-bg-brightness: {{ bg_brightness }}; --app-bg-contrast: {{ bg_contrast }}; --app-bg-image: {% if bg_img %}url('{{ bg_img }}'){% else %}none{% endif %};">
    {% set ep = request.endpoint or '' %}
    {% set label_customers = 'Clientes' %}
    {% set label_products = 'Productos' %}
    {% set show_tenant_modules = not (current_user.is_authenticated and current_user.role == 'zentral_admin' and not is_support_mode) %}
    <!-- Navigation -->
    <nav class="text-white shadow-lg sticky top-0 z-20" style="background-color: var(--brand-color);" data-brand-color="{{ brand_color }}">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center space-x-3">
                        <!-- Logo del negocio (configurable más adelante) -->
                        <div class="h-9 w-9 rounded-full bg-white bg-opacity-10 flex items-center justify-center border border-white border-opacity-30 overflow-hidden">
                            {% if request.path.startswith('/superadmin') and current_user.is_authenticated and current_user.role == 'zentral_admin' and not is_support_mode %}
                                <i class="fas fa-user-shield"></i>
                            {% elif business and business.logo_file_id %}
                                <img src="{{ url_for('files.download_file_api', file_id=business.logo_file_id) }}" alt="Logo" class="h-9 w-9 object-cover">
                            {% elif business and business.logo_filename %}
                                <img src="{{ url_for('static', filename='uploads/' ~ business.logo_filename) }}" alt="Logo" class="h-9 w-9 object-cover">
                            {% else %}
                                <span class="text-sm font-semibold">{{ (business.name[0] if business and business.name else 'N')|upper }}</span>
                            {% endif %}
                        </div>
                        <div class="flex flex-col leading-tight">
                            {% if request.path.startswith('/superadmin') and current_user.is_authenticated and current_user.role == 'zentral_admin' and not is_support_mode %}
                                <span class="text-sm font-semibold">Superadmin</span>
                            {% else %}
                                <span class="text-sm font-semibold">{{ business.name if business else 'Nombre del negocio' }}</span>
                            {% endif %}
                            <span class="text-xs text-gray-200">Zentral · Sistema de gestión</span>
                        </div>
                    </div>
                </div>
                <div class="hidden sm:ml-6 sm:flex sm:items-center gap-2">
                    {% if current_user.is_authenticated and is_support_mode %}
                    <div class="inline-flex items-center px-3 py-1.5 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-900 border border-yellow-200">
                        <i class="fas fa-headset mr-2"></i>
                        Soporte: {{ support_company.name if support_company else '—' }}
                    </div>
                    <form method="post" action="{{ url_for('superadmin.clear_impersonation') }}" class="inline" data-confirm="1" data-confirm-title="Salir del modo soporte" data-confirm-message="Vas a volver al panel de Superadmin." data-confirm-ok="Salir" data-confirm-cancel="Cancelar">
                        <button type="submit" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md">
                            <i class="fas fa-sign-out-alt mr-2"></i> Salir soporte
                        </button>
                    </form>
                    {% endif %}
                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('user_settings.user_detail', user_id=current_user.id) }}" class="inline-flex items-center px-3 py-2 text-sm font-medium text-blue-100 hover:text-white hover:bg-blue-700 rounded-md">
                        <i class="fas fa-user-circle mr-2"></i> ¡Hola {{ current_user.display_name or current_user.username }}!
                    </a>
                    {% endif %}
                </div>
                <!-- Mobile menu button -->
                <div class="-mr-2 flex items-center sm:hidden">
                    <button type="button" class="inline-flex items-center justify-center p-2 rounded-md text-blue-200 hover:text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Abrir menú principal</span>
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile menu, show/hide based on menu state. -->
        <div class="sm:hidden hidden" id="mobile-menu">
            <div class="pt-2 pb-3 space-y-1">
                {% if show_tenant_modules and current_user.is_authenticated and current_user.can('dashboard') %}
                <a href="{{ url_for('main.index') }}" class="{% if ep.startswith('main.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                </a>
                {% endif %}
                {% if show_tenant_modules and current_user.is_authenticated and current_user.can('calendar') %}
                <a href="{{ url_for('calendar.index') }}" class="{% if ep.startswith('calendar.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-calendar-alt mr-2"></i> Calendario
                </a>
                {% endif %}
                {% if show_tenant_modules and current_user.is_authenticated and current_user.can('sales') %}
                <a href="{{ url_for('sales.index') }}" class="{% if ep.startswith('sales.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-shopping-cart mr-2"></i> Ventas
                </a>
                {% endif %}
                {% if show_tenant_modules and current_user.is_authenticated and current_user.can('customers') %}
                <a href="{{ url_for('customers.index') }}" class="{% if ep.startswith('customers.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-user mr-2"></i> {{ label_customers }}
                </a>
                {% endif %}
                {% if show_tenant_modules and current_user.is_authenticated and current_user.can('suppliers') %}
                <a href="{{ url_for('suppliers.index') }}" class="{% if ep.startswith('suppliers.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-truck mr-2"></i> Proveedores
                </a>
                {% endif %}
                {% if show_tenant_modules and current_user.is_authenticated and current_user.can('employees') %}
                <a href="{{ url_for('employees.index') }}" class="{% if ep.startswith('employees.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-hard-hat mr-2"></i> Empleados
                </a>
                {% endif %}
                {% if show_tenant_modules and current_user.is_authenticated and current_user.can('expenses') %}
                <a href="{{ url_for('expenses.index') }}" class="{% if ep.startswith('expenses.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-money-bill-wave mr-2"></i> Gastos
                </a>
                {% endif %}
                {% if show_tenant_modules and current_user.is_authenticated and current_user.can('inventory') %}
                <a href="{{ url_for('inventory.index') }}" class="{% if ep.startswith('inventory.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-boxes mr-2"></i> Inventario
                </a>
                {% endif %}
                {% if show_tenant_modules and current_user.is_authenticated and current_user.can('movements') %}
                <a href="{{ url_for('movements.index') }}" class="{% if ep.startswith('movements.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-exchange-alt mr-2"></i> Movimientos
                </a>
                {% endif %}
                {% if show_tenant_modules and current_user.is_authenticated and current_user.can('reports') %}
                <a href="{{ url_for('reports.index') }}" class="{% if ep.startswith('reports.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-chart-bar mr-2"></i> Reportes
                </a>
                {% endif %}
                {% if show_tenant_modules and current_user.is_authenticated and current_user.can('user_settings') %}
                <a href="{{ url_for('user_settings.index') }}" class="{% if ep.startswith('user_settings.') or ep.startswith('user-settings.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-user-cog mr-2"></i> Config. de Usuario
                </a>
                {% endif %}
                {% if show_tenant_modules and current_user.is_authenticated and current_user.can('settings') %}
                <a href="{{ url_for('settings.business_settings') }}" class="{% if ep.startswith('settings.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-cog mr-2"></i> Config. del negocio
                </a>
                {% endif %}
                {% if current_user.is_authenticated and (current_user.is_master or current_user.role == 'zentral_admin') %}
                <a href="{{ url_for('superadmin.index') }}" class="{% if ep.startswith('superadmin.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-shield-alt mr-2"></i> Superadmin
                </a>
                {% endif %}
                {% if current_user.is_authenticated %}
                <div class="pt-4 pb-3 border-t border-blue-700">
                    <div class="flex items-center px-4">
                        <div class="flex-shrink-0">
                            <div class="h-10 w-10 rounded-full bg-blue-300 flex items-center justify-center">
                                <span class="text-blue-800 font-medium">{{ (current_user.display_name or current_user.username)[0].upper() }}</span>
                            </div>
                        </div>
                        <div class="ml-3">
                            <div class="text-base font-medium text-white">{{ current_user.username }}</div>
                            <div class="text-sm font-medium text-blue-200">{{ current_user.email }}</div>
                        </div>
                    </div>
                    <div class="mt-3 space-y-1">
                        {% if current_user.is_authenticated and is_support_mode %}
                        <div class="px-4 pb-2">
                            <div class="inline-flex items-center px-3 py-1.5 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-900 border border-yellow-200">
                                <i class="fas fa-headset mr-2"></i>
                                Soporte: {{ support_company.name if support_company else '—' }}
                            </div>
                        </div>
                        <form method="post" action="{{ url_for('superadmin.clear_impersonation') }}" class="block px-4" data-confirm="1" data-confirm-title="Salir del modo soporte" data-confirm-message="Vas a volver al panel de Superadmin." data-confirm-ok="Salir" data-confirm-cancel="Cancelar">
                            <button type="submit" class="w-full text-left px-4 py-2 text-base font-medium text-red-100 hover:text-white hover:bg-red-700 rounded-md">
                                <i class="fas fa-sign-out-alt mr-2"></i> Salir soporte
                            </button>
                        </form>
                        {% endif %}
                        <a href="{{ url_for('user_settings.user_detail', user_id=current_user.id) }}" class="block px-4 py-2 text-base font-medium text-blue-200 hover:text-white hover:bg-blue-700">
                            <i class="fas fa-user-circle mr-2"></i> ¡Hola {{ current_user.display_name or current_user.username }}!
                        </a>
                        <a href="{{ url_for('superadmin.index') if (current_user.role == 'zentral_admin' and not is_support_mode) else (url_for('settings.business_settings') if current_user.can('settings') else (url_for('user_settings.index') if current_user.can('user_settings') else url_for('main.index'))) }}" class="block px-4 py-2 text-base font-medium text-blue-200 hover:text-white hover:bg-blue-700">
                            <i class="fas fa-cog mr-2"></i> Configuración
                        </a>
                        <a href="{{ url_for('auth.logout') }}" class="block px-4 py-2 text-base font-medium text-blue-200 hover:text-white hover:bg-blue-700" data-confirm-logout="1">
                            <i class="fas fa-sign-out-alt mr-2"></i> Cerrar sesión
                        </a>
                    </div>
                </div>
                {% else %}
                <div class="pt-4 pb-3 border-t border-blue-700">
                    <div class="space-y-1">
                        <a href="{{ url_for('auth.login') }}" class="block px-4 py-2 text-base font-medium text-blue-200 hover:text-white hover:bg-blue-700">
                            Iniciar sesión
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Main Layout: Sidebar + Content -->
    <div class="flex py-4 px-4 sm:px-6 lg:px-8 gap-4">
        <!-- Sidebar -->
        <aside class="w-72 hidden md:block">
            <div class="bg-white rounded-xl shadow p-4 space-y-2 sticky top-20" style="background-color: #ffffff; color: #000000;">
                <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-2">Navegación</h2>
                {% if show_tenant_modules %}
                {% if current_user.is_authenticated and current_user.can('dashboard') %}
                <a href="{{ url_for('main.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('main.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('calendar') %}
                <a href="{{ url_for('calendar.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('calendar.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-calendar-alt mr-2"></i> Calendario
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('sales') %}
                <a href="{{ url_for('sales.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('sales.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-shopping-cart mr-2"></i> Ventas
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('expenses') %}
                <a href="{{ url_for('expenses.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('expenses.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-money-bill-wave mr-2"></i> Gastos
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('inventory') %}
                <a href="{{ url_for('inventory.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('inventory.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-boxes mr-2"></i> Inventario
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('movements') %}
                <a href="{{ url_for('movements.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('movements.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-exchange-alt mr-2"></i> Movimientos
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('customers') %}
                <a href="{{ url_for('customers.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('customers.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-user mr-2"></i> {{ label_customers }}
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('suppliers') %}
                <a href="{{ url_for('suppliers.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('suppliers.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-truck mr-2"></i> Proveedores
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('employees') %}
                <a href="{{ url_for('employees.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('employees.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-hard-hat mr-2"></i> Empleados
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('reports') %}
                <a href="{{ url_for('reports.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('reports.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-chart-bar mr-2"></i> Informes
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('user_settings') %}
                <a href="{{ url_for('user_settings.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('user_settings.') or ep.startswith('user-settings.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-user-cog mr-2"></i> Config. de Usuario
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('settings') %}
                <a href="{{ url_for('settings.business_settings') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('settings.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-cog mr-2"></i> Config. del negocio
                </a>
                {% endif %}
                {% endif %}
                {% if current_user.is_authenticated and (current_user.is_master or current_user.role == 'zentral_admin') %}
                <a href="{{ url_for('superadmin.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('superadmin.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-shield-alt mr-2"></i> Superadmin
                </a>
                {% endif %}
                <a href="{{ url_for('auth.logout') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-red-50 hover:text-red-700" data-confirm-logout="1">
                    <i class="fas fa-sign-out-alt mr-2"></i> Cerrar sesión
                </a>

                <!-- Marca de agua Zentra Consultora -->
                <div class="pt-4 mt-4 border-t border-gray-100">
                    <div class="w-full">
                        <img src="{{ url_for('static', filename='images/zentral-logo.svg') }}" alt="ZENTRAL" class="w-full h-14 object-contain">
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 max-w-7xl mx-auto">
            <!-- Flash messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="mb-4 p-4 rounded-md {% if category == 'success' %}bg-green-100 text-green-800{% elif category == 'error' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-4">
        <div class="max-w-7xl mx-auto py-3 px-4 overflow-hidden sm:px-6 lg:px-8">
            <p class="text-center text-gray-500 text-sm">
                &copy; {{ now.year }} Zentral. Todos los derechos reservados.
            </p>
        </div>
    </footer>

    <div id="modal-alert" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40" data-close="1"></div>
        <div class="relative h-full w-full flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border-2 border-gray-300 overflow-hidden">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div class="w-full text-center">
                        <h3 id="alert-title" class="text-base font-semibold text-gray-900">Atención</h3>
                        <p id="alert-subtitle" class="text-xs text-gray-500">—</p>
                    </div>
                    <button id="btn-close-alert" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5">
                    <div id="alert-message" class="text-sm text-gray-700 text-center"></div>
                </div>
                <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                    <button id="btn-ok-alert" type="button" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-confirm" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40" data-close="1"></div>
        <div class="relative h-full w-full flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border-2 border-gray-300 overflow-hidden">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div class="w-full text-center">
                        <h3 id="confirm-title" class="text-base font-semibold text-gray-900">Confirmar</h3>
                        <p id="confirm-subtitle" class="text-xs text-gray-500">—</p>
                    </div>
                    <button id="btn-close-confirm" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5">
                    <div id="confirm-message" class="text-sm text-gray-700 text-center"></div>
                </div>
                <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                    <button id="btn-cancel-confirm" type="button" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                    <button id="btn-ok-confirm" type="button" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- flatpickr JS (date picker) -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="{{ url_for('static', filename='js/services/adapters/api_adapter.js') }}"></script>
    <script src="{{ url_for('static', filename='js/services/storage_service.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    {% block scripts %}{% endblock %}

    <script>
        (function () {
            function getAlertEls() {
                return {
                    modal: document.getElementById('modal-alert'),
                    title: document.getElementById('alert-title'),
                    subtitle: document.getElementById('alert-subtitle'),
                    message: document.getElementById('alert-message'),
                    btnOk: document.getElementById('btn-ok-alert'),
                    btnClose: document.getElementById('btn-close-alert'),
                };
            }

            function getConfirmEls() {
                return {
                    modal: document.getElementById('modal-confirm'),
                    title: document.getElementById('confirm-title'),
                    subtitle: document.getElementById('confirm-subtitle'),
                    message: document.getElementById('confirm-message'),
                    btnOk: document.getElementById('btn-ok-confirm'),
                    btnCancel: document.getElementById('btn-cancel-confirm'),
                    btnClose: document.getElementById('btn-close-confirm'),
                };
            }

            let confirmPromiseResolve = null;

            window.formatFechaDisplay = function (raw) {
                if (raw === null || raw === undefined) return '';
                if (typeof raw === 'number' && isFinite(raw)) {
                    const dnum = new Date(raw);
                    if (isNaN(dnum.getTime())) return String(raw);
                    const dd = String(dnum.getDate()).padStart(2, '0');
                    const mm = String(dnum.getMonth() + 1).padStart(2, '0');
                    const yy = String(dnum.getFullYear());
                    return dd + '/' + mm + '/' + yy;
                }

                const v = String(raw || '').trim();
                if (!v || v === '—' || v === '-') return v;
                if (/^\d{2}\/\d{2}\/\d{4}/.test(v)) return v;
                if (/^\d{4}-\d{2}-\d{2}/.test(v)) {
                    const y = v.slice(0, 4);
                    const m = v.slice(5, 7);
                    const d = v.slice(8, 10);
                    const restRaw = v.length > 10 ? v.slice(10) : '';
                    const rest = restRaw && restRaw[0] === 'T' ? (' ' + restRaw.slice(1)) : restRaw;
                    return d + '/' + m + '/' + y + rest;
                }

                const dt = new Date(v);
                if (!isNaN(dt.getTime())) {
                    const dd = String(dt.getDate()).padStart(2, '0');
                    const mm = String(dt.getMonth() + 1).padStart(2, '0');
                    const yy = String(dt.getFullYear());
                    return dd + '/' + mm + '/' + yy;
                }

                return v;
            };

            window.closeAlertModal = function () {
                const els = getAlertEls();
                if (!els.modal) return;
                els.modal.classList.add('hidden');
            };

            window.showAlertModal = function (message, title, subtitle) {
                const els = getAlertEls();
                const msg = String(message || '').trim();
                const ttl = String(title || '').trim() || 'Atención';
                const sub = String(subtitle || '').trim();
                if (!els.modal || !els.message || !els.title) {
                    alert(ttl + (msg ? (': ' + msg) : ''));
                    return;
                }
                els.title.textContent = ttl;
                if (els.subtitle) els.subtitle.textContent = sub || '—';
                els.message.textContent = msg;
                els.modal.classList.remove('hidden');
            };

            window.closeConfirmModal = function (result) {
                const els = getConfirmEls();
                if (!els.modal) return;
                els.modal.classList.add('hidden');
                if (confirmPromiseResolve) {
                    const fn = confirmPromiseResolve;
                    confirmPromiseResolve = null;
                    fn(!!result);
                }
            };

            window.confirmModal = function (message, title, subtitle, opts) {
                const els = getConfirmEls();
                const msg = String(message || '').trim();
                const ttl = String(title || '').trim() || 'Confirmar';
                const sub = String(subtitle || '').trim();
                const o = (opts && typeof opts === 'object') ? opts : {};
                const okLabel = String(o.okText || 'Confirmar');
                const cancelLabel = String(o.cancelText || 'Cancelar');
                if (!els.modal || !els.message || !els.title) {
                    return Promise.resolve(window.confirm(ttl + (msg ? (': ' + msg) : '')));
                }
                els.title.textContent = ttl;
                if (els.subtitle) els.subtitle.textContent = sub || '—';
                els.message.textContent = msg;
                if (els.btnOk) els.btnOk.textContent = okLabel;
                if (els.btnCancel) els.btnCancel.textContent = cancelLabel;
                els.modal.classList.remove('hidden');
                return new Promise(function (resolve) {
                    confirmPromiseResolve = resolve;
                });
            };

            document.addEventListener('DOMContentLoaded', function () {
                const els = getAlertEls();
                if (!els.modal) return;
                if (els.btnOk) els.btnOk.addEventListener('click', function () { window.closeAlertModal(); });
                if (els.btnClose) els.btnClose.addEventListener('click', function () { window.closeAlertModal(); });
                els.modal.addEventListener('click', function (e) {
                    const target = e.target;
                    if (target && target.getAttribute && target.getAttribute('data-close') === '1') window.closeAlertModal();
                });
                document.addEventListener('keydown', function (e) {
                    if (!els.modal || els.modal.classList.contains('hidden')) return;
                    if (e.key === 'Escape') window.closeAlertModal();
                });

                const cels = getConfirmEls();
                if (cels.modal) {
                    if (cels.btnOk) cels.btnOk.addEventListener('click', function () { window.closeConfirmModal(true); });
                    if (cels.btnCancel) cels.btnCancel.addEventListener('click', function () { window.closeConfirmModal(false); });
                    if (cels.btnClose) cels.btnClose.addEventListener('click', function () { window.closeConfirmModal(false); });
                    cels.modal.addEventListener('click', function (e) {
                        const target = e.target;
                        if (target && target.getAttribute && target.getAttribute('data-close') === '1') window.closeConfirmModal(false);
                    });
                    document.addEventListener('keydown', function (e) {
                        if (!cels.modal || cels.modal.classList.contains('hidden')) return;
                        if (e.key === 'Escape') window.closeConfirmModal(false);
                    });
                }
            });
        })();
    </script>
    
    <script>
        // Toggle mobile menu
        document.addEventListener('DOMContentLoaded', function() {
            const nav = document.querySelector('nav[data-brand-color]');
            if (nav) {
                const c = (nav.getAttribute('data-brand-color') || '').trim();
                if (c) nav.style.backgroundColor = c;

                try {
                    const hex = c;
                    const m = String(hex || '').trim().match(/^#?([0-9a-f]{3}|[0-9a-f]{6})$/i);
                    if (m) {
                        let s = m[1];
                        if (s.length === 3) s = s.split('').map(ch => ch + ch).join('');
                        const n = parseInt(s, 16);
                        const r = (n >> 16) & 255;
                        const g = (n >> 8) & 255;
                        const b = n & 255;
                        const root = document.documentElement;
                        root.style.setProperty('--brand-color', '#' + s.toLowerCase());
                        root.style.setProperty('--brand-color-rgb', r + ',' + g + ',' + b);
                        root.style.setProperty('--brand-color-dark', 'rgb(' + Math.max(0, Math.round(r * 0.86)) + ',' + Math.max(0, Math.round(g * 0.86)) + ',' + Math.max(0, Math.round(b * 0.86)) + ')');
                        root.style.setProperty('--brand-color-darker', 'rgb(' + Math.max(0, Math.round(r * 0.76)) + ',' + Math.max(0, Math.round(g * 0.76)) + ',' + Math.max(0, Math.round(b * 0.76)) + ')');
                        root.style.setProperty('--brand-color-50', 'rgba(' + r + ',' + g + ',' + b + ',0.08)');
                        root.style.setProperty('--brand-color-100', 'rgba(' + r + ',' + g + ',' + b + ',0.12)');
                        root.style.setProperty('--brand-color-200', 'rgba(' + r + ',' + g + ',' + b + ',0.20)');
                    }
                } catch (e) {
                }
            }
            document.querySelectorAll('[data-brand-bg]').forEach(function(el) {
                const c = (el.getAttribute('data-brand-bg') || '').trim();
                if (c) el.style.backgroundColor = c;
            });
            const mobileMenuButton = document.querySelector('button[aria-controls="mobile-menu"]');
            const mobileMenu = document.getElementById('mobile-menu');
            const userMenuButton = document.getElementById('user-menu');
            const userMenu = document.querySelector('[role="menu"]');
            
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    mobileMenu.classList.toggle('hidden');
                });
            }
            
            if (userMenuButton && userMenu) {
                userMenuButton.addEventListener('click', function() {
                    userMenu.classList.toggle('hidden');
                });
                
                // Close user menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!userMenuButton.contains(event.target) && !userMenu.contains(event.target)) {
                        userMenu.classList.add('hidden');
                    }
                });
            }

            document.querySelectorAll('a[data-confirm-logout="1"]').forEach(function (a) {
                a.addEventListener('click', async function (ev) {
                    try {
                        ev.preventDefault();
                        const href = a.getAttribute('href') || '';
                        const ok = await (window.confirmModal ? window.confirmModal(
                            '¿Querés cerrar sesión?',
                            'Cerrar sesión',
                            'Vas a salir del sistema.',
                            { okText: 'Cerrar sesión', cancelText: 'Cancelar' }
                        ) : Promise.resolve(window.confirm('¿Querés cerrar sesión?')));
                        if (!ok) return;
                        window.location.href = href;
                    } catch (e) {
                        window.location.href = a.getAttribute('href') || '/auth/logout';
                    }
                });
            });

            document.querySelectorAll('form[data-confirm="1"]').forEach(function (form) {
                form.addEventListener('submit', async function (ev) {
                    try {
                        if (form.getAttribute('data-confirmed') === '1') return;
                        ev.preventDefault();
                        const title = (form.getAttribute('data-confirm-title') || 'Confirmar').trim();
                        const msg = (form.getAttribute('data-confirm-message') || '¿Confirmás la acción?').trim();
                        const okText = (form.getAttribute('data-confirm-ok') || 'Confirmar').trim();
                        const cancelText = (form.getAttribute('data-confirm-cancel') || 'Cancelar').trim();
                        const ok = await (window.confirmModal ? window.confirmModal(
                            msg,
                            title,
                            '',
                            { okText: okText, cancelText: cancelText }
                        ) : Promise.resolve(window.confirm(title + (msg ? (': ' + msg) : ''))));
                        if (!ok) return;
                        form.setAttribute('data-confirmed', '1');
                        form.submit();
                    } catch (e) {
                        form.setAttribute('data-confirmed', '1');
                        form.submit();
                    }
                });
            });
        });
    </script>

    <script>
        (function () {
            function formatCurrencyARS(value) {
                let n;
                if (typeof value === 'number') n = value;
                else n = parseFloat(String(value ?? '').replace(',', '.'));
                if (!isFinite(n)) n = 0;
                try {
                    const abs = Math.abs(n);
                    const formatted = new Intl.NumberFormat('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(abs);
                    return (n < 0 ? '-$' : '$') + formatted;
                } catch (e) {
                    try {
                        const abs = Math.abs(n);
                        const formatted = abs.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
                        return (n < 0 ? '-$' : '$') + formatted;
                    } catch (err) {
                        return (n < 0 ? '-$' : '$') + String(Math.abs(n));
                    }
                }
            }

            function _formatCurrencyARSFixed(n, fracDigits) {
                const x = (typeof n === 'number' && isFinite(n)) ? n : 0;
                const d = Math.max(0, Math.min(2, parseInt(fracDigits || 0, 10) || 0));
                try {
                    const abs = Math.abs(x);
                    const formatted = new Intl.NumberFormat('es-AR', { minimumFractionDigits: d, maximumFractionDigits: d }).format(abs);
                    return (x < 0 ? '-$' : '$') + formatted;
                } catch (e) {
                    try {
                        const abs = Math.abs(x);
                        const formatted = abs.toLocaleString('es-AR', { minimumFractionDigits: d, maximumFractionDigits: d });
                        return (x < 0 ? '-$' : '$') + formatted;
                    } catch (err) {
                        return (x < 0 ? '-$' : '$') + String(Math.abs(x));
                    }
                }
            }

            function parseCurrencyARS(raw) {
                const input = String(raw ?? '').trim();
                if (!input) return 0;
                let s = input.replace(/\$/g, '').replace(/\s/g, '');
                let sign = 1;
                if (s.startsWith('-')) {
                    sign = -1;
                    s = s.slice(1);
                }
                if (!s) return 0;

                // Mantener solo dígitos y separadores comunes
                s = s.replace(/[^0-9.,]/g, '');

                if (s.indexOf(',') >= 0) {
                    const parts = s.split(',');
                    const intPart = String(parts[0] || '').replace(/\./g, '').replace(/[^0-9]/g, '');
                    const decPart = String(parts.slice(1).join(',') || '').replace(/[^0-9]/g, '');
                    const num = parseFloat((intPart || '0') + '.' + (decPart || '0'));
                    return isNaN(num) ? 0 : (sign * num);
                }

                const dotCount = (s.match(/\./g) || []).length;
                const hasDot = s.indexOf('.') >= 0;

                if (hasDot) {
                    const isThousandsOnly = /^\d{1,3}(\.\d{3})+$/.test(s);
                    if (isThousandsOnly) {
                        const num = parseFloat(s.replace(/\./g, ''));
                        return isNaN(num) ? 0 : (sign * num);
                    }

                    const lastDot = s.lastIndexOf('.');
                    const fracLen = lastDot >= 0 ? (s.length - lastDot - 1) : 0;

                    // Si hay múltiples puntos o el sufijo es de 3+ dígitos, asumimos miles.
                    if (dotCount > 1 || fracLen > 2) {
                        const num = parseFloat(s.replace(/\./g, ''));
                        return isNaN(num) ? 0 : (sign * num);
                    }

                    // Caso decimal: mantener solo el último punto como separador decimal
                    const intPart = String(s.slice(0, lastDot)).replace(/\./g, '').replace(/[^0-9]/g, '');
                    const decPart = String(s.slice(lastDot + 1)).replace(/[^0-9]/g, '');
                    const num = parseFloat((intPart || '0') + '.' + (decPart || '0'));
                    return isNaN(num) ? 0 : (sign * num);
                }

                const cleaned = s.replace(/[^0-9]/g, '');
                const num = parseFloat(cleaned);
                return isNaN(num) ? 0 : (sign * num);
            }

            function bindCurrencyInputsARS(root) {
                const scope = root || document;
                const nodes = scope.querySelectorAll('input[data-currency="ars"]');
                Array.from(nodes).forEach(function (el) {
                    try {
                        if (!el || el.getAttribute('data-currency-bound') === '1') return;
                        el.setAttribute('data-currency-bound', '1');

                        const setCaretByDigits = function (inputEl, formattedValue, digitsBeforeCaret) {
                            try {
                                if (!inputEl || typeof inputEl.setSelectionRange !== 'function') return;
                                const targetDigits = Math.max(0, parseInt(digitsBeforeCaret || 0, 10) || 0);
                                if (!targetDigits) {
                                    const pos = String(formattedValue || '').length;
                                    inputEl.setSelectionRange(pos, pos);
                                    return;
                                }
                                let seen = 0;
                                const s = String(formattedValue || '');
                                for (let i = 0; i < s.length; i++) {
                                    if (s[i] >= '0' && s[i] <= '9') {
                                        seen++;
                                        if (seen >= targetDigits) {
                                            inputEl.setSelectionRange(i + 1, i + 1);
                                            return;
                                        }
                                    }
                                }
                                inputEl.setSelectionRange(s.length, s.length);
                            } catch (e) {
                            }
                        };

                        const countDigitsBeforeCaret = function (rawValue, caretPos) {
                            try {
                                const s = String(rawValue || '');
                                const p = Math.max(0, Math.min(s.length, parseInt(caretPos || 0, 10) || 0));
                                let c = 0;
                                for (let i = 0; i < p; i++) {
                                    if (s[i] >= '0' && s[i] <= '9') c++;
                                }
                                return c;
                            } catch (e) {
                                return 0;
                            }
                        };

                        if (el.disabled || el.readOnly) {
                            const v0 = String(el.value ?? '').trim();
                            if (v0) el.value = formatCurrencyARS(parseCurrencyARS(v0));
                            return;
                        }

                        el.addEventListener('input', function () {
                            const raw = String(el.value ?? '');
                            const trimmed = raw.trim();
                            if (!trimmed) return;
                            if (/^\s*-?\$?\s*$/.test(raw)) return;
                            const rawNoSpace = raw.replace(/\s/g, '');
                            const trailingComma = /,$/.test(rawNoSpace.replace(/\$/g, ''));

                            let sign = '';
                            try {
                                if (trimmed.startsWith('-')) sign = '-';
                            } catch (e) {
                            }

                            let s = rawNoSpace.replace(/\$/g, '');
                            if (s.startsWith('-')) s = s.slice(1);
                            s = s.replace(/[^0-9,]/g, '');

                            const commaIdx = s.indexOf(',');
                            let intPart = s;
                            let decPart = '';
                            if (commaIdx >= 0) {
                                intPart = s.slice(0, commaIdx);
                                decPart = s.slice(commaIdx + 1);
                            }
                            if (decPart.length > 2) decPart = decPart.slice(0, 2);

                            if (!intPart && !decPart && !trailingComma) return;

                            const intDigits = String(intPart || '').replace(/[^0-9]/g, '');
                            const intFormatted = (intDigits ? intDigits : '0').replace(/\B(?=(\d{3})+(?!\d))/g, '.');

                            let out = sign + '$' + intFormatted;
                            if (commaIdx >= 0 || trailingComma) {
                                out += ',' + (decPart || '');
                            }
                            el.value = out;
                            try {
                                const pos = out.length;
                                el.setSelectionRange(pos, pos);
                            } catch (e) {
                            }
                        });

                        el.addEventListener('blur', function () {
                            const v = String(el.value ?? '').trim();
                            if (!v) {
                                el.value = '';
                                return;
                            }
                            el.value = formatCurrencyARS(parseCurrencyARS(v));
                        });

                        const vv = String(el.value ?? '').trim();
                        if (vv) el.value = formatCurrencyARS(parseCurrencyARS(vv));
                    } catch (e) {
                    }
                });
            }

            window.formatCurrencyARS = formatCurrencyARS;
            window.parseCurrencyARS = parseCurrencyARS;
            window.bindCurrencyInputsARS = bindCurrencyInputsARS;

            document.addEventListener('DOMContentLoaded', function () {
                bindCurrencyInputsARS(document);
            });
        })();
    </script>

    <script>
        (function () {
            try {
                const sr = (String('{{ request.script_root or "" }}') || '').trim();
                try {
                    if (sr) window.__storage_ns = sr;
                } catch (e) {
                }
                if (sr && sr.startsWith('/c/')) {
                    const origFetch = window.fetch;
                    window.fetch = function (input, init) {
                        try {
                            if (typeof input === 'string') {
                                const url = input;
                                if (url.startsWith('/') && !url.startsWith(sr + '/')) {
                                    input = sr + url;
                                }
                            } else if (input && typeof input === 'object' && input.url) {
                                const url = String(input.url || '');
                                if (url.startsWith('/') && !url.startsWith(sr + '/')) {
                                    input = new Request(sr + url, input);
                                }
                            }
                        } catch (e) {
                        }
                        return origFetch(input, init);
                    };
                }
            } catch (e) {
            }

            function getStorageKey(key) {
                return 'kpi_collapsed_' + String(key || '').trim();
            }

            function readCollapsed(key) {
                try {
                    return localStorage.getItem(getStorageKey(key)) === '1';
                } catch (e) {
                    return false;
                }
            }

            function writeCollapsed(key, collapsed) {
                try {
                    localStorage.setItem(getStorageKey(key), collapsed ? '1' : '0');
                } catch (e) {
                }
            }

            function applyState(btn, target, key) {
                if (!btn || !target) return;
                const collapsed = readCollapsed(key);
                target.classList.toggle('hidden', collapsed);
                btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
                const icon = btn.querySelector('[data-kpi-toggle-icon]') || btn.querySelector('i');
                if (icon) {
                    icon.classList.toggle('fa-chevron-right', collapsed);
                    icon.classList.toggle('fa-chevron-down', !collapsed);
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                document.querySelectorAll('[data-kpi-toggle]').forEach(function (btn) {
                    const key = (btn.getAttribute('data-kpi-key') || btn.getAttribute('data-kpi-toggle') || '').trim();
                    const targetSel = (btn.getAttribute('data-kpi-target') || '').trim();
                    if (!key || !targetSel) return;
                    const target = document.querySelector(targetSel);
                    if (!target) return;

                    applyState(btn, target, key);

                    btn.addEventListener('click', function () {
                        const willCollapse = !target.classList.contains('hidden');
                        writeCollapsed(key, willCollapse);
                        applyState(btn, target, key);
                    });
                });
            });
        })();
    </script>
</body>
</html>
