<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} - Zentral</title>
    {% if business and business.logo_filename %}
        <link rel="icon" type="image/png" href="{{ url_for('static', filename='uploads/' ~ business.logo_filename) }}">
        <link rel="apple-touch-icon" href="{{ url_for('static', filename='uploads/' ~ business.logo_filename) }}">
    {% else %}
        <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect width='64' height='64' rx='14' fill='%230d1067'/%3E%3Ctext x='32' y='42' font-size='34' text-anchor='middle' fill='white' font-family='Arial'%3EZ%3C/text%3E%3C/svg%3E">
    {% endif %}
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- flatpickr CSS (date picker) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    {% block styles %}{% endblock %}
</head>
<body class="bg-gray-100" style="background-color: #fbf9f5;">
    {% set ep = request.endpoint or '' %}
    {% set brand_color = (business.primary_color if business and business.primary_color else '#0d1067') %}
    {% set label_customers = (business.label_customers if business and business.label_customers else 'Clientes') %}
    {% set label_products = (business.label_products if business and business.label_products else 'Productos') %}
    <!-- Navigation -->
    <nav class="text-white shadow-lg sticky top-0 z-20" style="background-color: #0d1067;" data-brand-color="{{ brand_color }}">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex">
                    <div class="flex-shrink-0 flex items-center space-x-3">
                        <!-- Logo del negocio (configurable más adelante) -->
                        <div class="h-9 w-9 rounded-full bg-white bg-opacity-10 flex items-center justify-center border border-white border-opacity-30 overflow-hidden">
                            {% if business and business.logo_filename %}
                                <img src="{{ url_for('static', filename='uploads/' ~ business.logo_filename) }}" alt="Logo" class="h-9 w-9 object-cover">
                            {% else %}
                                <span class="text-sm font-semibold">{{ (business.name[0] if business and business.name else 'N')|upper }}</span>
                            {% endif %}
                        </div>
                        <div class="flex flex-col leading-tight">
                            <span class="text-sm font-semibold">{{ business.name if business else 'Nombre del negocio' }}</span>
                            <span class="text-xs text-gray-200">Zentral · Sistema de gestión</span>
                        </div>
                    </div>
                </div>
                <div class="hidden sm:ml-6 sm:flex sm:items-center">
                    {% if current_user.is_authenticated %}
                    <a href="{{ url_for('user_settings.user_detail', user_id=current_user.id) }}" class="inline-flex items-center px-3 py-2 text-sm font-medium text-blue-100 hover:text-white hover:bg-blue-700 rounded-md">
                        <i class="fas fa-user-circle mr-2"></i> ¡Hola {{ current_user.username }}!
                    </a>
                    {% endif %}
                </div>
                <!-- Mobile menu button -->
                <div class="-mr-2 flex items-center sm:hidden">
                    <button type="button" class="inline-flex items-center justify-center p-2 rounded-md text-blue-200 hover:text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white" aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Abrir menú principal</span>
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Mobile menu, show/hide based on menu state. -->
        <div class="sm:hidden hidden" id="mobile-menu">
            <div class="pt-2 pb-3 space-y-1">
                {% if current_user.is_authenticated and current_user.can('dashboard') %}
                <a href="{{ url_for('main.index') }}" class="{% if ep.startswith('main.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('calendar') %}
                <a href="{{ url_for('calendar.index') }}" class="{% if ep.startswith('calendar.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-calendar-alt mr-2"></i> Calendario
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('sales') %}
                <a href="{{ url_for('sales.index') }}" class="{% if ep.startswith('sales.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-shopping-cart mr-2"></i> Ventas
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('customers') %}
                <a href="{{ url_for('customers.index') }}" class="{% if ep.startswith('customers.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-user mr-2"></i> {{ label_customers }}
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('suppliers') %}
                <a href="{{ url_for('suppliers.index') }}" class="{% if ep.startswith('suppliers.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-truck mr-2"></i> Proveedores
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('employees') %}
                <a href="{{ url_for('employees.index') }}" class="{% if ep.startswith('employees.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-hard-hat mr-2"></i> Empleados
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('expenses') %}
                <a href="{{ url_for('expenses.index') }}" class="{% if ep.startswith('expenses.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-money-bill-wave mr-2"></i> Gastos
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('inventory') %}
                <a href="{{ url_for('inventory.index') }}" class="{% if ep.startswith('inventory.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-boxes mr-2"></i> Inventario
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('movements') %}
                <a href="{{ url_for('movements.index') }}" class="{% if ep.startswith('movements.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-exchange-alt mr-2"></i> Movimientos
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('reports') %}
                <a href="{{ url_for('reports.index') }}" class="{% if ep.startswith('reports.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-chart-bar mr-2"></i> Reportes
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('user_settings') %}
                <a href="{{ url_for('user_settings.index') }}" class="{% if ep.startswith('user_settings.') or ep.startswith('user-settings.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-user-cog mr-2"></i> Config. de Usuario
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('settings') %}
                <a href="{{ url_for('settings.business_settings') }}" class="{% if ep.startswith('settings.') %}bg-blue-700 text-white border-blue-500{% else %}text-blue-200 hover:bg-blue-700 hover:text-white border-transparent{% endif %} block pl-3 pr-4 py-2 border-l-4 text-base font-medium">
                    <i class="fas fa-cog mr-2"></i> Config. del negocio
                </a>
                {% endif %}
                {% if current_user.is_authenticated %}
                <div class="pt-4 pb-3 border-t border-blue-700">
                    <div class="flex items-center px-4">
                        <div class="flex-shrink-0">
                            <div class="h-10 w-10 rounded-full bg-blue-300 flex items-center justify-center">
                                <span class="text-blue-800 font-medium">{{ current_user.username[0].upper() }}</span>
                            </div>
                        </div>
                        <div class="ml-3">
                            <div class="text-base font-medium text-white">{{ current_user.username }}</div>
                            <div class="text-sm font-medium text-blue-200">{{ current_user.email }}</div>
                        </div>
                    </div>
                    <div class="mt-3 space-y-1">
                        <a href="{{ url_for('user_settings.user_detail', user_id=current_user.id) }}" class="block px-4 py-2 text-base font-medium text-blue-200 hover:text-white hover:bg-blue-700">
                            <i class="fas fa-user-circle mr-2"></i> ¡Hola {{ current_user.username }}!
                        </a>
                        <a href="{{ url_for('settings.business_settings') if current_user.can('settings') else (url_for('user_settings.index') if current_user.can('user_settings') else url_for('main.index')) }}" class="block px-4 py-2 text-base font-medium text-blue-200 hover:text-white hover:bg-blue-700">
                            <i class="fas fa-cog mr-2"></i> Configuración
                        </a>
                        <a href="{{ url_for('auth.logout') }}" class="block px-4 py-2 text-base font-medium text-blue-200 hover:text-white hover:bg-blue-700">
                            <i class="fas fa-sign-out-alt mr-2"></i> Cerrar sesión
                        </a>
                    </div>
                </div>
                {% else %}
                <div class="pt-4 pb-3 border-t border-blue-700">
                    <div class="space-y-1">
                        <a href="{{ url_for('auth.login') }}" class="block px-4 py-2 text-base font-medium text-blue-200 hover:text-white hover:bg-blue-700">
                            Iniciar sesión
                        </a>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Main Layout: Sidebar + Content -->
    <div class="flex py-4 px-4 sm:px-6 lg:px-8 gap-4">
        <!-- Sidebar -->
        <aside class="w-72 hidden md:block">
            <div class="bg-white rounded-xl shadow p-4 space-y-2 sticky top-20" style="background-color: #ffffff; color: #000000;">
                <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wide mb-2">Navegación</h2>
                {% if current_user.is_authenticated and current_user.can('dashboard') %}
                <a href="{{ url_for('main.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('main.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-tachometer-alt mr-2"></i> Dashboard
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('calendar') %}
                <a href="{{ url_for('calendar.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('calendar.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-calendar-alt mr-2"></i> Calendario
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('sales') %}
                <a href="{{ url_for('sales.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('sales.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-shopping-cart mr-2"></i> Ventas
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('expenses') %}
                <a href="{{ url_for('expenses.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('expenses.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-money-bill-wave mr-2"></i> Gastos
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('inventory') %}
                <a href="{{ url_for('inventory.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('inventory.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-boxes mr-2"></i> Inventario
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('movements') %}
                <a href="{{ url_for('movements.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('movements.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-exchange-alt mr-2"></i> Movimientos
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('customers') %}
                <a href="{{ url_for('customers.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('customers.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-user mr-2"></i> {{ label_customers }}
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('suppliers') %}
                <a href="{{ url_for('suppliers.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('suppliers.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-truck mr-2"></i> Proveedores
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('employees') %}
                <a href="{{ url_for('employees.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('employees.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-hard-hat mr-2"></i> Empleados
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('reports') %}
                <a href="{{ url_for('reports.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('reports.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-chart-bar mr-2"></i> Informes
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('user_settings') %}
                <a href="{{ url_for('user_settings.index') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('user_settings.') or ep.startswith('user-settings.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-user-cog mr-2"></i> Config. de Usuario
                </a>
                {% endif %}
                {% if current_user.is_authenticated and current_user.can('settings') %}
                <a href="{{ url_for('settings.business_settings') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium {% if ep.startswith('settings.') %}bg-blue-50 text-blue-700{% else %}text-gray-700 hover:bg-blue-50 hover:text-blue-700{% endif %}">
                    <i class="fas fa-cog mr-2"></i> Config. del negocio
                </a>
                {% endif %}
                <a href="{{ url_for('auth.logout') }}" class="w-full inline-flex items-center px-3 py-2 rounded-md text-sm font-medium text-gray-600 hover:bg-red-50 hover:text-red-700">
                    <i class="fas fa-sign-out-alt mr-2"></i> Cerrar sesión
                </a>

                <!-- Marca de agua Zentra Consultora -->
                <div class="pt-4 mt-4 border-t border-gray-100">
                    <div class="w-full">
                        <img src="{{ url_for('static', filename='images/zentra-consultora-horizontal.png.png') }}" alt="Zentra" class="w-full h-12 object-contain">
                    </div>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 max-w-7xl mx-auto">
            <!-- Flash messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="mb-4 p-4 rounded-md {% if category == 'success' %}bg-green-100 text-green-800{% elif category == 'error' %}bg-red-100 text-red-800{% else %}bg-blue-100 text-blue-800{% endif %}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            
            {% block content %}{% endblock %}
        </main>
    </div>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-8">
        <div class="max-w-7xl mx-auto py-6 px-4 overflow-hidden sm:px-6 lg:px-8">
            <p class="mt-4 text-center text-gray-500 text-sm">
                &copy; {{ now.year }} Zentral. Todos los derechos reservados.
            </p>
        </div>
    </footer>

    <div id="modal-alert" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40" data-close="1"></div>
        <div class="relative h-full w-full flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border-2 border-gray-300 overflow-hidden">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div class="w-full text-center">
                        <h3 id="alert-title" class="text-base font-semibold text-gray-900">Atención</h3>
                        <p id="alert-subtitle" class="text-xs text-gray-500">—</p>
                    </div>
                    <button id="btn-close-alert" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5">
                    <div id="alert-message" class="text-sm text-gray-700 text-center"></div>
                </div>
                <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                    <button id="btn-ok-alert" type="button" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-confirm" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40" data-close="1"></div>
        <div class="relative h-full w-full flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border-2 border-gray-300 overflow-hidden">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div class="w-full text-center">
                        <h3 id="confirm-title" class="text-base font-semibold text-gray-900">Confirmar</h3>
                        <p id="confirm-subtitle" class="text-xs text-gray-500">—</p>
                    </div>
                    <button id="btn-close-confirm" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5">
                    <div id="confirm-message" class="text-sm text-gray-700 text-center"></div>
                </div>
                <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                    <button id="btn-cancel-confirm" type="button" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                    <button id="btn-ok-confirm" type="button" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- flatpickr JS (date picker) -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script src="{{ url_for('static', filename='js/services/adapters/local_storage_adapter.js') }}"></script>
    <script src="{{ url_for('static', filename='js/services/adapters/api_adapter.js') }}"></script>
    <script src="{{ url_for('static', filename='js/services/storage_service.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    {% block scripts %}{% endblock %}

    <script>
        (function () {
            function getAlertEls() {
                return {
                    modal: document.getElementById('modal-alert'),
                    title: document.getElementById('alert-title'),
                    subtitle: document.getElementById('alert-subtitle'),
                    message: document.getElementById('alert-message'),
                    btnOk: document.getElementById('btn-ok-alert'),
                    btnClose: document.getElementById('btn-close-alert'),
                };
            }

            function getConfirmEls() {
                return {
                    modal: document.getElementById('modal-confirm'),
                    title: document.getElementById('confirm-title'),
                    subtitle: document.getElementById('confirm-subtitle'),
                    message: document.getElementById('confirm-message'),
                    btnOk: document.getElementById('btn-ok-confirm'),
                    btnCancel: document.getElementById('btn-cancel-confirm'),
                    btnClose: document.getElementById('btn-close-confirm'),
                };
            }

            let confirmPromiseResolve = null;

            window.formatFechaDisplay = function (raw) {
                if (raw === null || raw === undefined) return '';
                if (typeof raw === 'number' && isFinite(raw)) {
                    const dnum = new Date(raw);
                    if (isNaN(dnum.getTime())) return String(raw);
                    const dd = String(dnum.getDate()).padStart(2, '0');
                    const mm = String(dnum.getMonth() + 1).padStart(2, '0');
                    const yy = String(dnum.getFullYear());
                    return dd + '/' + mm + '/' + yy;
                }

                const v = String(raw || '').trim();
                if (!v || v === '—' || v === '-') return v;
                if (/^\d{2}\/\d{2}\/\d{4}/.test(v)) return v;
                if (/^\d{4}-\d{2}-\d{2}/.test(v)) {
                    const y = v.slice(0, 4);
                    const m = v.slice(5, 7);
                    const d = v.slice(8, 10);
                    const restRaw = v.length > 10 ? v.slice(10) : '';
                    const rest = restRaw && restRaw[0] === 'T' ? (' ' + restRaw.slice(1)) : restRaw;
                    return d + '/' + m + '/' + y + rest;
                }

                const dt = new Date(v);
                if (!isNaN(dt.getTime())) {
                    const dd = String(dt.getDate()).padStart(2, '0');
                    const mm = String(dt.getMonth() + 1).padStart(2, '0');
                    const yy = String(dt.getFullYear());
                    return dd + '/' + mm + '/' + yy;
                }

                return v;
            };

            window.closeAlertModal = function () {
                const els = getAlertEls();
                if (!els.modal) return;
                els.modal.classList.add('hidden');
            };

            window.showAlertModal = function (message, title, subtitle) {
                const els = getAlertEls();
                const msg = String(message || '').trim();
                const ttl = String(title || '').trim() || 'Atención';
                const sub = String(subtitle || '').trim();
                if (!els.modal || !els.message || !els.title) {
                    alert(ttl + (msg ? (': ' + msg) : ''));
                    return;
                }
                els.title.textContent = ttl;
                if (els.subtitle) els.subtitle.textContent = sub || '—';
                els.message.textContent = msg;
                els.modal.classList.remove('hidden');
            };

            window.closeConfirmModal = function (result) {
                const els = getConfirmEls();
                if (!els.modal) return;
                els.modal.classList.add('hidden');
                if (confirmPromiseResolve) {
                    const fn = confirmPromiseResolve;
                    confirmPromiseResolve = null;
                    fn(!!result);
                }
            };

            window.confirmModal = function (message, title, subtitle, opts) {
                const els = getConfirmEls();
                const msg = String(message || '').trim();
                const ttl = String(title || '').trim() || 'Confirmar';
                const sub = String(subtitle || '').trim();
                const o = (opts && typeof opts === 'object') ? opts : {};
                const okLabel = String(o.okText || 'Confirmar');
                const cancelLabel = String(o.cancelText || 'Cancelar');
                if (!els.modal || !els.message || !els.title) {
                    return Promise.resolve(window.confirm(ttl + (msg ? (': ' + msg) : '')));
                }
                els.title.textContent = ttl;
                if (els.subtitle) els.subtitle.textContent = sub || '—';
                els.message.textContent = msg;
                if (els.btnOk) els.btnOk.textContent = okLabel;
                if (els.btnCancel) els.btnCancel.textContent = cancelLabel;
                els.modal.classList.remove('hidden');
                return new Promise(function (resolve) {
                    confirmPromiseResolve = resolve;
                });
            };

            document.addEventListener('DOMContentLoaded', function () {
                const els = getAlertEls();
                if (!els.modal) return;
                if (els.btnOk) els.btnOk.addEventListener('click', function () { window.closeAlertModal(); });
                if (els.btnClose) els.btnClose.addEventListener('click', function () { window.closeAlertModal(); });
                els.modal.addEventListener('click', function (e) {
                    const target = e.target;
                    if (target && target.getAttribute && target.getAttribute('data-close') === '1') window.closeAlertModal();
                });
                document.addEventListener('keydown', function (e) {
                    if (!els.modal || els.modal.classList.contains('hidden')) return;
                    if (e.key === 'Escape') window.closeAlertModal();
                });

                const cels = getConfirmEls();
                if (cels.modal) {
                    if (cels.btnOk) cels.btnOk.addEventListener('click', function () { window.closeConfirmModal(true); });
                    if (cels.btnCancel) cels.btnCancel.addEventListener('click', function () { window.closeConfirmModal(false); });
                    if (cels.btnClose) cels.btnClose.addEventListener('click', function () { window.closeConfirmModal(false); });
                    cels.modal.addEventListener('click', function (e) {
                        const target = e.target;
                        if (target && target.getAttribute && target.getAttribute('data-close') === '1') window.closeConfirmModal(false);
                    });
                    document.addEventListener('keydown', function (e) {
                        if (!cels.modal || cels.modal.classList.contains('hidden')) return;
                        if (e.key === 'Escape') window.closeConfirmModal(false);
                    });
                }
            });
        })();
    </script>
    
    <script>
        // Toggle mobile menu
        document.addEventListener('DOMContentLoaded', function() {
            const nav = document.querySelector('nav[data-brand-color]');
            if (nav) {
                const c = (nav.getAttribute('data-brand-color') || '').trim();
                if (c) nav.style.backgroundColor = c;
            }
            document.querySelectorAll('[data-brand-bg]').forEach(function(el) {
                const c = (el.getAttribute('data-brand-bg') || '').trim();
                if (c) el.style.backgroundColor = c;
            });
            const mobileMenuButton = document.querySelector('button[aria-controls="mobile-menu"]');
            const mobileMenu = document.getElementById('mobile-menu');
            const userMenuButton = document.getElementById('user-menu');
            const userMenu = document.querySelector('[role="menu"]');
            
            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    mobileMenu.classList.toggle('hidden');
                });
            }
            
            if (userMenuButton && userMenu) {
                userMenuButton.addEventListener('click', function() {
                    userMenu.classList.toggle('hidden');
                });
                
                // Close user menu when clicking outside
                document.addEventListener('click', function(event) {
                    if (!userMenuButton.contains(event.target) && !userMenu.contains(event.target)) {
                        userMenu.classList.add('hidden');
                    }
                });
            }
        });
    </script>

    <script>
        (function () {
            function getStorageKey(key) {
                return 'kpi_collapsed_' + String(key || '').trim();
            }

            function readCollapsed(key) {
                try {
                    return localStorage.getItem(getStorageKey(key)) === '1';
                } catch (e) {
                    return false;
                }
            }

            function writeCollapsed(key, collapsed) {
                try {
                    localStorage.setItem(getStorageKey(key), collapsed ? '1' : '0');
                } catch (e) {
                }
            }

            function applyState(btn, target, key) {
                if (!btn || !target) return;
                const collapsed = readCollapsed(key);
                target.classList.toggle('hidden', collapsed);
                btn.setAttribute('aria-expanded', collapsed ? 'false' : 'true');
                const icon = btn.querySelector('[data-kpi-toggle-icon]') || btn.querySelector('i');
                if (icon) {
                    icon.classList.toggle('fa-chevron-right', collapsed);
                    icon.classList.toggle('fa-chevron-down', !collapsed);
                }
            }

            document.addEventListener('DOMContentLoaded', function () {
                document.querySelectorAll('[data-kpi-toggle]').forEach(function (btn) {
                    const key = (btn.getAttribute('data-kpi-key') || btn.getAttribute('data-kpi-toggle') || '').trim();
                    const targetSel = (btn.getAttribute('data-kpi-target') || '').trim();
                    if (!key || !targetSel) return;
                    const target = document.querySelector(targetSel);
                    if (!target) return;

                    applyState(btn, target, key);

                    btn.addEventListener('click', function () {
                        const willCollapse = !target.classList.contains('hidden');
                        writeCollapsed(key, willCollapse);
                        applyState(btn, target, key);
                    });
                });
            });
        })();
    </script>
</body>
</html>
