{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock %}
{% block content %}
<div class="mb-6 flex items-center justify-between">
    <div>
        <h1 class="text-2xl font-bold text-gray-900">Editar empresa</h1>
        <p class="mt-1 text-sm text-gray-600">Actualizá datos internos y admin principal.</p>
    </div>
    <div class="flex items-center gap-2">
        <button id="btn-open-manage-plans" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md bg-gray-100 hover:bg-gray-200">Administrar planes</button>
        <a href="{{ url_for('superadmin.company_overview', company_id=company.id) }}" class="inline-flex items-center px-3 py-2 text-sm font-medium rounded-md bg-gray-100 hover:bg-gray-200">Volver</a>
    </div>
</div>

<div class="p-5 bg-white rounded-lg shadow max-w-2xl">
    <form method="post" action="{{ url_for('superadmin.company_edit', company_id=company.id) }}" class="space-y-4">
        <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Nombre</label>
            <input name="company_name" class="w-full px-3 py-2 text-sm border rounded-md" value="{{ company.name }}" required>
        </div>
        <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Plan</label>
            <select id="select-plan" name="plan" class="w-full px-3 py-2 text-sm border rounded-md bg-white" required>
                {% for p in plans %}
                    <option value="{{ p }}" {% if company.plan == p %}selected{% endif %}>{{ p }}</option>
                {% endfor %}
                <option value="__new__">Agregar nuevo plan</option>
            </select>
        </div>
        <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Vence suscripción</label>
            <input type="hidden" id="subscription-ends-at" name="subscription_ends_at" value="{{ company.subscription_ends_at.isoformat() if company.subscription_ends_at else '' }}">
            <input id="subscription-ends-at-display" class="w-full px-3 py-2 text-sm border rounded-md bg-white" value="" placeholder="dd/mm/aaaa" autocomplete="off">
        </div>
        <div id="plan-new-wrap" class="hidden">
            <label class="block text-xs font-medium text-gray-600 mb-1">Nuevo plan</label>
            <input id="input-plan-new" name="plan_new" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Ej: premium-mensual">
        </div>
        <div>
            <label class="block text-xs font-medium text-gray-600 mb-1">Notas internas (opcional)</label>
            <textarea name="notes" rows="4" class="w-full px-3 py-2 text-sm border rounded-md">{{ company.notes or '' }}</textarea>
        </div>

        <div class="pt-2 border-t">
            <h2 class="text-lg font-medium text-gray-900 mb-2">Admin principal</h2>
            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Usuario</label>
                    <input name="admin_username" class="w-full px-3 py-2 text-sm border rounded-md" value="{{ admin_user.username if admin_user else '' }}" placeholder="Ej: admin">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Nueva contraseña</label>
                    <input name="admin_password" type="password" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Dejar vacío para no cambiar">
                </div>
            </div>
            {% if admin_user %}
            <div class="mt-3 text-sm">
                <div class="text-xs font-medium text-gray-600 mb-1">Contraseña actual</div>
                <div class="font-medium text-gray-900">{{ admin_user.password_plain or '' }}</div>
            </div>
            {% endif %}
        </div>

        <div class="pt-2">
            <button type="submit" class="inline-flex items-center px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Guardar cambios</button>
        </div>
    </form>
</div>

<div id="modal-manage-plans" class="hidden fixed inset-0 z-50" aria-hidden="true">
    <div class="absolute inset-0 bg-black/30" data-close="1"></div>
    <div class="absolute inset-y-0 right-0 w-full max-w-md bg-white shadow-xl flex flex-col">
        <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
            <div>
                <h2 class="text-base font-semibold text-gray-900">Administrar planes</h2>
                <p class="mt-1 text-xs text-gray-500">Creá o eliminá planes disponibles.</p>
            </div>
            <button id="btn-close-manage-plans" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600" title="Cerrar">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-5 overflow-y-auto space-y-4">
            <form method="post" action="{{ url_for('superadmin.plan_create') }}" class="space-y-2">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Nuevo plan</label>
                    <input name="plan_code" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Ej: premium-mensual" required>
                </div>
                <button type="submit" class="w-full inline-flex items-center justify-center px-3 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">Agregar plan</button>
            </form>

            <div class="border-t pt-4">
                <div class="text-sm font-semibold text-gray-900 mb-2">Planes existentes</div>
                <div class="space-y-2">
                    {% for p in plans_rows %}
                        <div class="flex items-center justify-between gap-2 p-2 rounded-md border">
                            <div class="text-sm">
                                <div class="font-medium text-gray-900">{{ p.code }}</div>
                                {% if p.active %}
                                    <div class="text-xs text-green-700">activo</div>
                                {% else %}
                                    <div class="text-xs text-gray-500">inactivo</div>
                                {% endif %}
                            </div>
                            <div class="flex items-center gap-2">
                                {% if p.active %}
                                    <form method="post" action="{{ url_for('superadmin.plan_disable', plan_code=p.code) }}" class="inline" data-confirm="1" data-confirm-title="Eliminar plan" data-confirm-message="Vas a eliminar el plan {{ p.code }}. No se podrá seleccionar para nuevas empresas." data-confirm-ok="Eliminar" data-confirm-cancel="Cancelar">
                                        <button type="submit" class="inline-flex items-center px-2.5 py-1.5 text-xs font-medium rounded-md bg-gray-900 text-white hover:bg-black">Eliminar</button>
                                    </form>
                                {% else %}
                                    <form method="post" action="{{ url_for('superadmin.plan_create') }}" class="inline">
                                        <input type="hidden" name="plan_code" value="{{ p.code }}">
                                        <button type="submit" class="inline-flex items-center px-2.5 py-1.5 text-xs font-medium rounded-md bg-gray-100 hover:bg-gray-200">Reactivar</button>
                                    </form>
                                {% endif %}
                            </div>
                        </div>
                    {% else %}
                        <div class="text-sm text-gray-500">No hay planes todavía.</div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const planSelect = document.getElementById('select-plan');
    const planNewWrap = document.getElementById('plan-new-wrap');
    const planNewInput = document.getElementById('input-plan-new');
    const subEndsHidden = document.getElementById('subscription-ends-at');
    const subEndsDisplay = document.getElementById('subscription-ends-at-display');
    const plansModal = document.getElementById('modal-manage-plans');
    const btnOpenPlans = document.getElementById('btn-open-manage-plans');
    const btnClosePlans = document.getElementById('btn-close-manage-plans');
    function syncPlanNew() {
        const isNew = planSelect && String(planSelect.value || '') === '__new__';
        if (planNewWrap) planNewWrap.classList.toggle('hidden', !isNew);
        if (planNewInput) planNewInput.required = !!isNew;
        if (isNew && planNewInput) {
            try { planNewInput.focus(); } catch (e) { }
        }
    }
    if (planSelect) planSelect.addEventListener('change', syncPlanNew);
    if (btnOpenPlans) btnOpenPlans.addEventListener('click', function () {
        if (plansModal) plansModal.classList.remove('hidden');
    });
    if (btnClosePlans) btnClosePlans.addEventListener('click', function () {
        if (plansModal) plansModal.classList.add('hidden');
    });
    if (plansModal) plansModal.addEventListener('click', function (e) {
        const el = e.target;
        if (el && el.getAttribute && el.getAttribute('data-close') === '1') {
            plansModal.classList.add('hidden');
        }
    });

    try {
        if (subEndsDisplay && typeof flatpickr === 'function') {
            if (flatpickr && flatpickr.l10ns && flatpickr.l10ns.es) {
                try { flatpickr.localize(flatpickr.l10ns.es); } catch (e) { }
            }
            flatpickr(subEndsDisplay, {
                dateFormat: 'd/m/Y',
                allowInput: true,
                appendTo: document.body,
                disableMobile: true,
                locale: (flatpickr && flatpickr.l10ns && flatpickr.l10ns.es) ? flatpickr.l10ns.es : undefined,
                defaultDate: (subEndsHidden && subEndsHidden.value) ? subEndsHidden.value : null,
                onChange: function (selectedDates) {
                    const d = (Array.isArray(selectedDates) && selectedDates.length) ? selectedDates[0] : null;
                    if (!subEndsHidden) return;
                    if (!d) {
                        subEndsHidden.value = '';
                        return;
                    }
                    const iso = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
                    subEndsHidden.value = iso;
                },
                onClose: function (selectedDates, dateStr, instance) {
                    try {
                        if (!subEndsHidden) return;
                        const raw = String((dateStr || (instance && instance.input && instance.input.value) || '')).trim();
                        if (!raw) {
                            subEndsHidden.value = '';
                            return;
                        }
                        const m = raw.match(/^(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?$/);
                        if (!m) return;
                        const dd = String(m[1]).padStart(2, '0');
                        const mm = String(m[2]).padStart(2, '0');
                        let yyyy = m[3] ? String(m[3]) : '';
                        if (!yyyy) {
                            yyyy = String(new Date().getFullYear());
                        } else if (yyyy.length === 2) {
                            yyyy = '20' + yyyy;
                        }
                        subEndsHidden.value = yyyy + '-' + mm + '-' + dd;
                    } catch (e) {
                    }
                }
            });

            try {
                subEndsDisplay.addEventListener('change', function () {
                    try {
                        if (!subEndsHidden) return;
                        const raw = String(subEndsDisplay.value || '').trim();
                        if (!raw) {
                            subEndsHidden.value = '';
                            return;
                        }
                        const m = raw.match(/^(\d{1,2})\/(\d{1,2})(?:\/(\d{2,4}))?$/);
                        if (!m) return;
                        const dd = String(m[1]).padStart(2, '0');
                        const mm = String(m[2]).padStart(2, '0');
                        let yyyy = m[3] ? String(m[3]) : '';
                        if (!yyyy) {
                            yyyy = String(new Date().getFullYear());
                        } else if (yyyy.length === 2) {
                            yyyy = '20' + yyyy;
                        }
                        subEndsHidden.value = yyyy + '-' + mm + '-' + dd;
                    } catch (e) {
                    }
                });
            } catch (e) {
            }
        }
    } catch (e) {
    }
    syncPlanNew();
});
</script>
{% endblock %}
