{% extends 'base.html' %}
{% block title %}Inventario{% endblock %}
{% block content %}
<div class="mb-6">
    <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
        <div>
            <div class="flex items-center gap-2">
                <h1 class="text-2xl font-bold text-gray-900">Inventario</h1>
                <button type="button" class="inline-flex items-center justify-center h-8 w-8 rounded-md hover:bg-gray-100 text-gray-600" data-kpi-toggle="inventory" data-kpi-key="inventory" data-kpi-target="#kpi-section-inventory" aria-expanded="true" aria-label="Mostrar/ocultar KPIs">
                    <i data-kpi-toggle-icon class="fas fa-chevron-down"></i>
                </button>
            </div>
            <p class="mt-1 text-sm text-gray-600">Inventario es el √∫nico punto de entrada de stock. Cada alta de lote genera un egreso autom√°tico.</p>
        </div>
        <div class="flex gap-2 justify-end">
            <button id="btn-create-inv" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;">
                <i class="fas fa-plus mr-2"></i> Crear √≠tem
            </button>
            <button id="btn-add-lot" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-200 bg-white hover:bg-gray-50">
                <i class="fas fa-plus mr-2 text-gray-500"></i> Agregar lote
            </button>
        </div>
    </div>
</div>

<div id="modal-select-supplier" class="hidden fixed inset-0 z-50" style="z-index: 70;">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i class="fas fa-search text-gray-500"></i>
                    <div class="font-semibold text-gray-900">Seleccionar proveedor</div>
                </div>
                <button id="btn-close-select-supplier" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600" aria-label="Cerrar">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-4">
                <div class="relative">
                    <div class="absolute inset-y-0 left-3 flex items-center text-gray-400">
                        <i class="fas fa-search"></i>
                    </div>
                    <input id="supplier-modal-search" type="text" class="w-full pl-10 pr-3 py-2 text-sm rounded-lg bg-white border border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-200" placeholder="Buscar proveedor por nombre o categor√≠a...">
                </div>

                <div class="mt-3 rounded-xl bg-white overflow-hidden border border-gray-200">
                    <div id="supplier-modal-list" class="max-h-[360px] overflow-auto divide-y divide-gray-100"></div>
                </div>

                <div class="mt-3 flex items-center justify-between gap-2">
                    <a id="link-create-supplier-from-inv" href="{{ url_for('suppliers.new') }}" class="inline-flex items-center px-3 py-2 text-xs font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">
                        <i class="fas fa-user-plus mr-2 text-gray-500"></i> Crear proveedor
                    </a>
                    <button id="btn-cancel-select-supplier" type="button" class="px-4 py-2 text-xs font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-create-category" class="hidden fixed inset-0 z-50" style="z-index: 60;">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Crear categor√≠a</h3>
                    <p class="text-xs text-gray-500">Evitamos duplicados por calidad de datos.</p>
                </div>
                <button id="btn-close-create-cat" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5">
                <label class="block text-xs font-medium text-gray-600 mb-1">Nombre <span class="text-red-600">*</span></label>
                <input id="cat-name" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Ej: Alimentos">
                <div id="cat-msg" class="mt-2 text-[11px] text-gray-600"></div>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex items-center justify-end gap-2">
                <button id="btn-cancel-create-cat" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="btn-save-create-cat" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;">Crear</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-edit-lot" class="hidden fixed inset-0 z-50" style="z-index: 66;">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Editar lote</h3>
                    <p id="edit-lot-subtitle" class="text-xs text-gray-500"></p>
                </div>
                <button id="btn-close-edit-lot" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fas fa-times"></i></button>
            </div>

            <div class="p-5">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                    <div class="md:col-span-6">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Producto</label>
                        <div id="edit-lot-product" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Cantidad</label>
                        <input id="edit-lot-qty" type="number" min="0" step="0.01" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Costo unitario</label>
                        <input id="edit-lot-cu" type="number" min="0" step="0.01" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                    </div>

                    <div class="md:col-span-4">
                        <label class="block text-xs font-medium text-gray-600 mb-1">C√≥digo de lote</label>
                        <input id="edit-lot-code" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Ej: L-000123">
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Fecha de ingreso</label>
                        <input id="edit-lot-date" type="date" class="w-full px-3 py-2 text-sm border rounded-md">
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Vencimiento</label>
                        <input id="edit-lot-exp" type="date" class="w-full px-3 py-2 text-sm border rounded-md">
                    </div>

                    <div class="md:col-span-12">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Proveedor</label>
                        <div class="relative">
                            <input id="edit-lot-supplier" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-white" placeholder="Buscar y seleccionar proveedor" autocomplete="off">
                            <input id="edit-lot-supplier-id" type="hidden" value="">
                        </div>
                        <div class="mt-2 grid grid-cols-2 gap-2">
                            <a id="link-create-supplier-lot-edit" href="{{ url_for('suppliers.new') }}" class="w-full text-center px-3 py-1.5 text-xs font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Crear proveedor</a>
                            <button id="btn-select-supplier-lot-edit" type="button" class="w-full px-3 py-1.5 text-xs font-medium rounded-md border border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100">Seleccionar</button>
                        </div>
                    </div>

                    <div class="md:col-span-12">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Observaciones</label>
                        <input id="edit-lot-note" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Opcional">
                        <div id="edit-lot-msg" class="mt-2 text-[11px] text-gray-600"></div>
                    </div>
                </div>
            </div>

            <div class="px-5 py-4 border-t border-gray-100 flex items-center justify-end gap-2">
                <button id="btn-cancel-edit-lot" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="btn-save-edit-lot" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;">Guardar</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-product-file" class="hidden fixed inset-0 z-50" style="z-index: 65;">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden flex flex-col" style="max-height: calc(100vh - 2rem);">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between sticky top-0 bg-white z-10">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Legajo del producto</h3>
                    <p id="file-subtitle" class="text-xs text-gray-500"></p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="btn-edit-file" type="button" class="px-3 py-2 text-xs font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Editar legajo</button>
                    <button id="btn-save-file" type="button" class="hidden px-3 py-2 text-xs font-medium rounded-md text-white" style="background-color:#0d1067;">Guardar</button>
                    <button id="btn-cancel-file" type="button" class="hidden px-3 py-2 text-xs font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Cancelar</button>
                    <button id="btn-close-file" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600" aria-label="Cerrar"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <div id="file-scroll" class="flex-1 min-h-0 overflow-y-auto p-5">
                <div id="file-sections" class="space-y-5">
                    <div id="file-view-cards" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="rounded-xl border border-gray-200 bg-white p-4">
                            <div class="text-xs font-semibold text-gray-700">Datos</div>
                            <div class="mt-2 text-xs text-gray-600 space-y-1">
                                <div><span class="text-gray-500">Nombre:</span> <span id="file-v-name" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Categor√≠a:</span> <span id="file-v-category" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Unidad:</span> <span id="file-v-unit" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Estado:</span> <span id="file-v-active" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Proveedor:</span> <span id="file-v-supplier" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Descripci√≥n:</span> <span id="file-v-desc" class="text-gray-800"></span></div>
                            </div>
                        </div>

                        <div class="rounded-xl border border-gray-200 bg-white p-4">
                            <div class="text-xs font-semibold text-gray-700">Stock</div>
                            <div class="mt-2 text-xs text-gray-600 space-y-1">
                                <div><span class="text-gray-500">Stock actual:</span> <span id="file-v-stock" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Stock m√≠nimo:</span> <span id="file-v-min" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Punto de pedido:</span> <span id="file-v-reorder" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Estado:</span> <span id="file-v-status" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Metodolog√≠a:</span> <span id="file-v-method" class="text-gray-800"></span></div>
                            </div>
                        </div>

                        <div class="rounded-xl border border-gray-200 bg-white p-4">
                            <div class="text-xs font-semibold text-gray-700">Imagen</div>
                            <div class="mt-2 flex items-start gap-3">
                                <div class="h-28 w-28 rounded-lg border border-gray-200 bg-gray-50 overflow-hidden flex items-center justify-center">
                                    <img id="file-v-image-preview" src="" alt="" class="h-full w-full object-cover hidden">
                                    <div id="file-v-image-placeholder" class="text-gray-400 text-sm"><i class="fas fa-image"></i></div>
                                </div>
                                <div id="file-v-image-optional" class="text-[11px] leading-tight text-gray-500">Opcional.</div>
                            </div>
                        </div>
                    </div>
                    <div id="file-sec-a">
                        <div id="file-sec-a-title" class="text-sm font-semibold text-gray-900">A. Informaci√≥n general</div>
                        <div id="file-sec-a-grid" class="mt-2 grid grid-cols-1 md:grid-cols-12 gap-3 items-start">
                            <div class="md:col-span-6">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Nombre</label>
                                <div id="file-name-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <input id="file-name" type="text" class="hidden w-full px-3 py-2 text-sm border rounded-md">
                            </div>
                            <div class="md:col-span-4">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Categor√≠a</label>
                                <div id="file-cat-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <select id="file-cat" class="hidden w-full px-3 py-2 text-sm border rounded-md bg-white">
                                    <option value="">‚Äî Seleccionar ‚Äî</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Unidad</label>
                                <div id="file-unit-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <select id="file-unit" class="hidden w-full px-3 py-2 text-sm border rounded-md bg-white">
                                    <option value="Unidad">Unidad</option>
                                    <option value="Kg">Kg</option>
                                    <option value="L">L</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div id="wrap-file-unit" class="md:col-span-3 hidden">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Unidad (otro)</label>
                                <input id="file-unit-other" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Ej: caja">
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">C√≥digo interno / SKU</label>
                                <div id="file-sku" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Estado</label>
                                <div id="file-active-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <label id="file-active-edit-wrap" class="hidden w-full inline-flex items-center gap-2 px-3 py-2 text-sm border rounded-md bg-white cursor-pointer select-none">
                                    <input id="file-active" type="checkbox" class="rounded border-gray-300" checked>
                                    <span id="file-active-label" class="text-sm text-gray-700">Activo</span>
                                </label>
                            </div>
                            <div class="md:col-span-6">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Proveedor principal</label>
                                <div id="file-supplier-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <div id="file-supplier-edit" class="hidden">
                                    <div class="relative">
                                        <input id="file-primary-supplier" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-white" placeholder="Buscar y seleccionar proveedor" autocomplete="off">
                                        <input id="file-primary-supplier-id" type="hidden" value="">
                                    </div>
                                    <div class="mt-2 grid grid-cols-2 gap-2">
                                        <a id="link-create-supplier-file" href="{{ url_for('suppliers.new') }}" class="w-full text-center px-3 py-1.5 text-xs font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Crear proveedor</a>
                                        <button id="btn-select-supplier-file" type="button" class="w-full px-3 py-1.5 text-xs font-medium rounded-md border border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100">Seleccionar</button>
                                    </div>
                                </div>
                            </div>
                            <div class="md:col-span-12">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Descripci√≥n</label>
                                <div id="file-desc-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <textarea id="file-desc" rows="2" class="hidden w-full px-3 py-2 text-sm border rounded-md" placeholder="Opcional"></textarea>
                            </div>
                            <div class="md:col-span-12">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Imagen del producto</label>
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-start">
                                    <div class="md:col-span-3">
                                        <div class="h-32 w-32 rounded-lg border border-gray-200 bg-gray-50 overflow-hidden flex items-center justify-center">
                                            <img id="file-image-preview" src="" alt="" class="h-full w-full object-cover hidden">
                                            <div id="file-image-placeholder" class="text-gray-400 text-sm"><i class="fas fa-image"></i></div>
                                        </div>
                                    </div>
                                    <div class="md:col-span-9">
                                        <div id="file-image-view" class="text-[9px] leading-tight text-gray-500">Opcional.</div>
                                        <div id="file-image-edit" class="hidden">
                                            <input id="file-image" type="file" accept="image/png,image/jpeg" class="w-full text-sm">
                                            <div class="mt-1 text-[9px] leading-tight text-gray-500">Opcional. Si no carg√°s imagen, se mostrar√° un placeholder. Pod√©s editarla cuando quieras.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="md:col-span-6">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Metodolog√≠a</label>
                                <div id="file-method-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <select id="file-method" class="hidden w-full px-3 py-2 text-sm border rounded-md bg-white">
                                    <option value="FIFO">PEPS</option>
                                    <option value="Average">Costo promedio</option>
                                </select>
                                <div id="file-method-lock-msg" class="hidden mt-1 text-[10px] leading-tight text-amber-700">La metodolog√≠a no puede modificarse una vez que el producto tiene movimientos.</div>
                            </div>
                        </div>
                    </div>

                    <div id="file-sec-b">
                        <div id="file-sec-b-title" class="text-sm font-semibold text-gray-900">B. Estado de stock</div>
                        <div id="file-sec-b-grid" class="mt-2 grid grid-cols-1 md:grid-cols-12 gap-3">
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Stock actual</label>
                                <div id="file-stock" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Stock m√≠nimo</label>
                                <div id="file-min-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <input id="file-min" type="number" min="0" step="0.01" class="hidden w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Punto de pedido</label>
                                <div id="file-reorder-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <input id="file-reorder" type="number" min="0" step="0.01" class="hidden w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Estado</label>
                                <div id="file-status" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div id="file-sec-c-title" class="text-sm font-semibold text-gray-900">C. Historial de lotes</div>
                        <div id="file-sec-c-wrap" class="mt-2 overflow-auto border border-gray-200 rounded-lg" style="max-height: 40vh;">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Ingreso</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Lote</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Inicial</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Restante</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">CU</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Proveedor</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Vencimiento</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Obs</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="file-lots-tbody" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">Seleccion√° un producto.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="file-sec-d">
                        <div id="file-sec-d-title" class="text-sm font-semibold text-gray-900">D. Stock en el tiempo</div>
                        <div class="mt-2 flex items-center justify-between gap-2">
                            <div class="inline-flex gap-1 rounded-lg bg-gray-50 p-1 border border-gray-100">
                                <button id="file-chart-15" type="button" class="px-3 py-1.5 text-xs font-medium rounded-md text-gray-600 hover:text-gray-900">15 d√≠as</button>
                                <button id="file-chart-30" type="button" class="px-3 py-1.5 text-xs font-medium rounded-md bg-white shadow-sm text-gray-900">30 d√≠as</button>
                                <button id="file-chart-60" type="button" class="px-3 py-1.5 text-xs font-medium rounded-md text-gray-600 hover:text-gray-900">60 d√≠as</button>
                                <button id="file-chart-90" type="button" class="px-3 py-1.5 text-xs font-medium rounded-md text-gray-600 hover:text-gray-900">90 d√≠as</button>
                            </div>
                            <div id="file-chart-meta" class="text-[11px] text-gray-500 whitespace-nowrap"></div>
                        </div>

                        <div id="file-chart-card" class="mt-3 border border-gray-200 rounded-lg bg-white p-3">
                            <div id="file-chart-wrap" class="relative w-full">
                                <svg id="file-chart-svg" viewBox="0 0 640 200" class="w-full h-48"></svg>
                                <div id="file-chart-tooltip" class="hidden absolute z-10 px-2 py-1 text-[11px] rounded-md border border-gray-200 bg-white shadow"></div>
                            </div>
                            <div class="mt-2 text-[11px] text-gray-500">Stock real calculado desde movimientos (no se guarda hist√≥rico).</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-5 py-4 border-t border-gray-100 flex justify-end sticky bottom-0 bg-white z-10">
                <button id="btn-close-file-bottom" type="button" class="text-sm font-medium text-gray-700 hover:text-gray-900">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div id="kpi-section-inventory" class="grid grid-cols-1 md:grid-cols-4 gap-2 items-stretch mb-6">
    <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col items-center justify-center text-center">
        <div class="h-10 w-10 mb-2 flex items-center justify-center rounded-full bg-emerald-50 text-emerald-700">
            <i class="fas fa-coins"></i>
        </div>
        <div>
            <p class="text-xs uppercase tracking-wide text-gray-500">Valor total del stock</p>
            <p id="kpi-stock-value" class="text-lg font-semibold text-gray-900">$0,00</p>
        </div>
    </div>
    <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col items-center justify-center text-center">
        <div class="h-10 w-10 mb-2 flex items-center justify-center rounded-full bg-indigo-50 text-indigo-700">
            <i class="fas fa-boxes"></i>
        </div>
        <div>
            <p class="text-xs uppercase tracking-wide text-gray-500">Productos</p>
            <p id="kpi-products" class="text-lg font-semibold text-gray-900">0</p>
        </div>
    </div>

    <button id="kpi-alerts-card" type="button" class="md:col-span-2 p-3 rounded-xl bg-white shadow border border-gray-100 text-left hover:bg-gray-50">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch">
            <div class="flex flex-col items-center md:items-start text-center md:text-left">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 flex items-center justify-center rounded-full bg-amber-50 text-amber-700">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="flex flex-col">
                        <div class="text-xs uppercase tracking-wide text-gray-500">Alertas activas</div>
                        <div class="mt-0.5 flex items-baseline justify-center md:justify-start gap-2">
                            <div class="text-3xl font-semibold text-gray-900 leading-none"><span id="kpi-alerts">0</span></div>
                            <div class="text-sm font-medium text-gray-700 leading-none">stock bajo + vencimientos</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col items-center md:items-start text-center md:text-left md:border-l md:border-gray-100 md:pl-4">
                <div class="text-xs uppercase tracking-wide text-gray-500">Alertas por producto</div>
                <div id="kpi-alerts-list" class="mt-2 w-full space-y-1"></div>
                <div id="kpi-alerts-hint" class="mt-2 text-[10px] text-gray-500">Click para ver productos en ‚ÄúReponer‚Äù y ‚ÄúCr√≠tico‚Äù.</div>
            </div>
        </div>
    </button>
</div>

<div class="bg-white rounded-xl shadow overflow-visible">
    <div class="px-4 py-3 border-b border-gray-100">
        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <div>
                <h2 class="text-sm font-semibold text-gray-900">Historial de movimientos de inventario</h2>
                <p class="text-xs text-gray-500">Las ventas descuentan stock seg√∫n la metodolog√≠a configurada. En el resumen se muestra costo promedio.</p>
            </div>
            <div class="flex flex-wrap gap-2 text-[11px]">
                <button id="btn-precios-inv" type="button" class="px-3 py-1 rounded-md border border-gray-200 bg-white text-gray-700 hover:bg-gray-50 inline-flex items-center gap-2">
                    <span>Actualizar precios</span>
                    <i class="fas fa-tags text-[10px]"></i>
                </button>
                <button id="btn-export-inv" type="button" class="px-3 py-1 rounded-md border border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 inline-flex items-center gap-2">
                    <span>Exportar</span>
                    <i class="fas fa-file-export text-[10px]"></i>
                </button>
            </div>
        </div>

        <div class="mt-3 inline-flex gap-1 rounded-lg bg-gray-50 p-1 border border-gray-100">
            <button id="tab-current" type="button" class="px-3 py-1.5 text-xs font-medium rounded-md bg-white shadow-sm text-gray-900">Stock actual</button>
            <button id="tab-lots" type="button" class="px-3 py-1.5 text-xs font-medium rounded-md text-gray-600 hover:text-gray-900">Stock ingreso</button>
        </div>
    </div>

    <div id="panel-current">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Imagen</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Producto</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Categor√≠a</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Stock</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Unidad</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Costo prom.</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Valor total</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Descripci√≥n</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-center text-gray-500 uppercase">Estado</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase"></th>
                </tr>
                <tr class="text-[11px] bg-white align-middle">
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1">
                        <input id="inv-q" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600" placeholder="Buscar producto">
                    </th>
                    <th class="px-4 py-1">
                        <select id="inv-cat" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white">
                            <option value="">Todas</option>
                        </select>
                    </th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1">
                        <select id="inv-status" multiple size="1" class="w-28 max-w-[112px] px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white">
                            <option value="">Todos</option>
                            <option value="OK">OK</option>
                            <option value="Reponer">Reponer</option>
                            <option value="Cr√≠tico">Cr√≠tico</option>
                        </select>
                    </th>
                    <th class="px-4 py-1"></th>
                </tr>
            </thead>
            <tbody id="inv-tbody-current" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="10" class="px-4 py-6 text-sm text-center text-gray-500">Todav√≠a no hay productos. Us√° ‚ÄúCrear √≠tem‚Äù para comenzar.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="panel-lots" class="hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Imagen</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Producto</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Descripci√≥n</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Fecha de ingreso</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Cantidad</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Costo unitario</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Proveedor</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Vencimiento</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Acciones</th>
                </tr>
                <tr class="text-[11px] bg-white align-middle">
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1">
                        <input id="inv-q-lots" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600" placeholder="Buscar producto">
                    </th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1">
                        <input id="inv-lots-sup" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600" placeholder="Proveedor">
                    </th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                </tr>
            </thead>
            <tbody id="inv-tbody-lots" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">Todav√≠a no hay lotes cargados.</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div id="modal-precios-inv" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Actualizar precios</h3>
                    <p class="text-xs text-gray-500">Edit√° el precio de venta. Se guarda en base de datos y se refleja en Ventas.</p>
                </div>
                <button id="btn-close-precios-inv" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fas fa-times"></i></button>
            </div>

            <div class="p-5">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Buscar producto</label>
                        <input id="precios-q" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Nombre del producto">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Categor√≠a</label>
                        <select id="precios-cat" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                            <option value="">Todas</option>
                        </select>
                    </div>
                </div>

                <div class="mt-4 overflow-auto border border-gray-200 rounded-lg" style="max-height: 60vh;">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Producto</th>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Categor√≠a</th>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Precio actual</th>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Nuevo precio</th>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">% cambio</th>
                            </tr>
                        </thead>
                        <tbody id="precios-tbody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="5" class="px-4 py-6 text-sm text-center text-gray-500">Cargando productos‚Ä¶</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="px-5 py-4 border-t border-gray-100 flex items-center justify-between">
                <div id="precios-msg" class="text-[11px] text-gray-600">Guard√° para aplicar los cambios.</div>
                <div class="flex gap-2">
                    <button id="btn-cancel-precios-inv" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cerrar</button>
                    <button id="btn-save-precios-inv" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;">Guardar cambios</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-create-inv" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden flex flex-col" style="max-height: calc(100vh - 2rem);">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between sticky top-0 bg-white z-10">
                <div>
                    <h3 id="create-inv-title" class="text-base font-semibold text-gray-900">Crear √≠tem</h3>
                    <p id="create-inv-subtitle" class="text-xs text-gray-500">¬øQu√© deseas hacer?</p>
                </div>
                <button id="btn-close-create-inv" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fas fa-times"></i></button>
            </div>

            <div id="create-inv-scroll" class="flex-1 min-h-0 overflow-y-auto">
            <div id="create-choice" class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="btn-choice-product" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                    <div class="text-2xl">üÜï</div>
                    <div class="mt-2 font-semibold text-gray-900">Crear producto nuevo</div>
                    <div class="text-xs text-gray-500">Defin√≠ el √≠tem consolidado y su configuraci√≥n.</div>
                </button>
                <button id="btn-choice-lot" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                    <div class="text-2xl">‚ûï</div>
                    <div class="mt-2 font-semibold text-gray-900">Agregar lote a producto existente</div>
                    <div class="text-xs text-gray-500">Ingres√° stock real con costo y vencimiento.</div>
                </button>
            </div>

            <div id="form-product" class="hidden p-5">
                <div class="space-y-4">
                    <div>
                        <div class="text-sm font-semibold text-gray-900">Datos b√°sicos</div>
                        <div class="mt-2 grid grid-cols-1 md:grid-cols-12 gap-3">
                            <div class="md:col-span-6">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Nombre <span class="text-red-600">*</span></label>
                                <input id="prod-name" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Ej: Caf√© en grano 1kg">
                            </div>
                            <div class="md:col-span-4">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Categor√≠a <span class="text-red-600">*</span></label>
                                <div class="flex gap-2">
                                    <select id="prod-cat-id" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                                        <option value="">‚Äî Seleccionar ‚Äî</option>
                                    </select>
                                    <button id="btn-open-create-cat" type="button" class="shrink-0 inline-flex items-center justify-center w-10 h-10 rounded-md border border-gray-200 bg-white hover:bg-gray-50 text-gray-700" title="Crear categor√≠a">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Unidad <span class="text-red-600">*</span></label>
                                <select id="prod-unit" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                                    <option value="Unidad">Unidad</option>
                                    <option value="Kg">Kg</option>
                                    <option value="L">L</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div id="wrap-prod-unit" class="md:col-span-3 hidden">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Unidad (otro)</label>
                                <input id="prod-unit-other" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Ej: caja">
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Estado</label>
                                <label class="w-full h-10 inline-flex items-center gap-2 px-3 py-2 text-sm border rounded-md bg-white cursor-pointer select-none">
                                    <input id="prod-active" type="checkbox" class="rounded border-gray-300" checked>
                                    <span id="prod-active-label" class="text-sm text-gray-700">Activo</span>
                                </label>
                            </div>
                            <div class="md:col-span-5">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Descripci√≥n</label>
                                <textarea id="prod-desc" rows="1" class="w-full h-10 px-3 py-2 text-sm border rounded-md resize-none" placeholder="Opcional"></textarea>
                            </div>
                            <div class="md:col-span-4">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Proveedor principal (opcional)</label>
                                <div class="relative">
                                    <input id="prod-primary-supplier" type="text" class="w-full h-10 px-2 py-2 text-sm border rounded-md bg-white" placeholder="Buscar y seleccionar proveedor" autocomplete="off">
                                    <input id="prod-primary-supplier-id" type="hidden" value="">
                                </div>
                                <div class="mt-2 flex gap-2">
                                    <a id="link-create-supplier-product" href="{{ url_for('suppliers.new') }}" class="flex-1 text-center px-2 py-1.5 text-xs font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Crear</a>
                                    <button id="btn-select-supplier-product" type="button" class="flex-1 px-2 py-1.5 text-xs font-medium rounded-md border border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100">Seleccionar</button>
                                </div>
                                <div class="mt-1 text-[5px] leading-none text-gray-500" style="font-size:11px;line-height:1;">Autocompleta al cargar un lote.</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="text-sm font-semibold text-gray-900">Imagen del producto</div>
                        <div class="mt-2 grid grid-cols-1 md:grid-cols-12 gap-3 items-start">
                            <div class="md:col-span-3">
                                <div class="h-24 w-24 rounded-lg border border-gray-200 bg-gray-50 overflow-hidden flex items-center justify-center">
                                    <img id="prod-image-preview" src="" alt="" class="h-full w-full object-cover hidden">
                                    <div id="prod-image-placeholder" class="text-gray-400 text-sm"><i class="fas fa-image"></i></div>
                                </div>
                            </div>
                            <div class="md:col-span-9">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Subir imagen (PNG/JPG)</label>
                                <input id="prod-image" type="file" accept="image/png,image/jpeg" class="w-full text-sm">
                                <div class="mt-1 text-[5px] leading-none text-gray-500" style="font-size:11px;line-height:1;">Opcional. Si no carg√°s imagen, se mostrar√° un placeholder. Pod√©s editarla cuando quieras.</div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="text-sm font-semibold text-gray-900">Configuraci√≥n de stock</div>
                        <div class="mt-2 grid grid-cols-1 md:grid-cols-12 gap-3">
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Maneja lotes</label>
                                <label class="w-full inline-flex items-center gap-2 px-3 py-2 text-sm border rounded-md bg-white cursor-pointer select-none">
                                    <input id="prod-lots" type="checkbox" class="rounded border-gray-300" checked>
                                    <span id="prod-lots-label" class="text-sm text-gray-700">S√≠</span>
                                </label>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Metodolog√≠a</label>
                                <select id="prod-method" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                                    <option value="FIFO">PEPS</option>
                                    <option value="Average">Costo promedio</option>
                                </select>
                                <div id="prod-method-lock-msg" class="hidden mt-1 text-[9px] leading-tight text-amber-700">La metodolog√≠a no puede modificarse una vez que el producto tiene movimientos.</div>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Stock m√≠nimo</label>
                                <input id="prod-min" type="number" min="0" step="0.01" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                                <div class="mt-1 text-[5px] leading-none text-gray-500" style="font-size:11px;line-height:1;">Alerta cr√≠tica.</div>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Punto de pedido</label>
                                <input id="prod-reorder" type="number" min="0" step="0.01" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                                <div class="mt-1 text-[5px] leading-none text-gray-500" style="font-size:11px;line-height:1;">Alerta preventiva (‚ÄúReponer‚Äù).</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex justify-end gap-2">
                    <button id="btn-back-1" type="button" class="px-4 py-2 text-sm font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Cancelar</button>
                    <button id="btn-save-product" type="button" class="px-4 py-2 text-sm font-medium rounded-md text-white" style="background-color:#0d1067;">Guardar √≠tem</button>
                </div>
            </div>

            <div id="form-lot" class="hidden p-5">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                    <div class="md:col-span-6">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Producto</label>
                        <select id="lot-product" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                            <option value="">‚Äî Seleccionar ‚Äî</option>
                        </select>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Fecha de ingreso</label>
                        <input id="lot-date" type="date" class="w-full px-3 py-2 text-sm border rounded-md" value="{{ now.strftime('%Y-%m-%d') }}">
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Proveedor</label>
                        <div class="relative">
                            <input id="lot-supplier" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-white" placeholder="Buscar y seleccionar proveedor" autocomplete="off">
                            <input id="lot-supplier-id" type="hidden" value="">
                        </div>
                        <div class="mt-2 grid grid-cols-2 gap-2">
                            <a id="link-create-supplier-lot" href="{{ url_for('suppliers.new') }}" class="w-full text-center px-3 py-1.5 text-xs font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Crear proveedor</a>
                            <button id="btn-select-supplier-lot" type="button" class="w-full px-3 py-1.5 text-xs font-medium rounded-md border border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100">Seleccionar</button>
                        </div>
                    </div>

                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Costo unitario</label>
                        <input id="lot-cu" type="number" min="0" step="0.01" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Cantidad</label>
                        <input id="lot-qty" type="number" min="0" step="0.01" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Costo total</label>
                        <input id="lot-ct" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-gray-50" value="$0,00" readonly>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Vencimiento</label>
                        <input id="lot-exp" type="date" class="w-full px-3 py-2 text-sm border rounded-md">
                        <label class="mt-2 inline-flex items-center text-xs text-gray-600"><input id="lot-no-exp" type="checkbox" class="rounded border-gray-300 mr-2"> No corresponde</label>
                    </div>

                    <div class="md:col-span-12">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Nota</label>
                        <input id="lot-note" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Opcional">
                    </div>
                </div>
                <div class="mt-4 flex justify-end gap-2">
                    <button id="btn-back-2" type="button" class="px-4 py-2 text-sm font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Cancelar</button>
                    <button id="btn-save-lot" type="button" class="px-4 py-2 text-sm font-medium rounded-md text-white" style="background-color:#0d1067;">Guardar lote</button>
                </div>
            </div>

            </div>
        </div>
    </div>
</div>

<div id="modal-export-inv" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Exportar inventario</h3>
                    <p class="text-xs text-gray-500">Se exporta la tab activa con filtros aplicados.</p>
                </div>
                <button id="btn-close-export-inv" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="btn-export-inv-pdf" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                    <div class="text-2xl">üìÑ</div>
                    <div class="mt-2 font-semibold text-gray-900">Exportar a PDF</div>
                    <div class="text-xs text-gray-500">Ideal para imprimir o enviar.</div>
                </button>
                <button id="btn-export-inv-xls" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                    <div class="text-2xl">üìä</div>
                    <div class="mt-2 font-semibold text-gray-900">Exportar a Excel</div>
                    <div class="text-xs text-gray-500">Descarga un CSV compatible con Excel.</div>
                </button>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end">
                <button id="btn-cancel-export-inv" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const btnCreate = document.getElementById('btn-create-inv');
    const btnAddLot = document.getElementById('btn-add-lot');
    const btnPrecios = document.getElementById('btn-precios-inv');
    const btnExport = document.getElementById('btn-export-inv');
    const tabCurrent = document.getElementById('tab-current');
    const tabLots = document.getElementById('tab-lots');
    const panelCurrent = document.getElementById('panel-current');
    const panelLots = document.getElementById('panel-lots');

    const tbodyCurrent = document.getElementById('inv-tbody-current');
    const tbodyLots = document.getElementById('inv-tbody-lots');

    const filterQ = document.getElementById('inv-q');
    const filterQLots = document.getElementById('inv-q-lots');
    const filterCat = document.getElementById('inv-cat');
    const filterStatus = document.getElementById('inv-status');
    const filterLotsSup = document.getElementById('inv-lots-sup');

    const kpiStockValue = document.getElementById('kpi-stock-value');
    const kpiProducts = document.getElementById('kpi-products');
    const kpiExpire = document.getElementById('kpi-expire');
    const kpiAlerts = document.getElementById('kpi-alerts');
    const kpiAlertsList = document.getElementById('kpi-alerts-list');
    const kpiAlertsCard = document.getElementById('kpi-alerts-card');
    const kpiAlertsHint = document.getElementById('kpi-alerts-hint');

    const modalCreate = document.getElementById('modal-create-inv');
    const btnCloseCreate = document.getElementById('btn-close-create-inv');
    const choiceWrap = document.getElementById('create-choice');

    const createInvTitle = document.getElementById('create-inv-title');
    const createInvSubtitle = document.getElementById('create-inv-subtitle');
    const formProduct = document.getElementById('form-product');
    const formLot = document.getElementById('form-lot');
    const btnChoiceProduct = document.getElementById('btn-choice-product');
    const btnChoiceLot = document.getElementById('btn-choice-lot');
    const btnBack1 = document.getElementById('btn-back-1');
    const btnBack2 = document.getElementById('btn-back-2');
    const createInvScroll = document.getElementById('create-inv-scroll');

    const modalCreateCat = document.getElementById('modal-create-category');
    const btnOpenCreateCat = document.getElementById('btn-open-create-cat');
    const btnCloseCreateCat = document.getElementById('btn-close-create-cat');
    const btnCancelCreateCat = document.getElementById('btn-cancel-create-cat');
    const btnSaveCreateCat = document.getElementById('btn-save-create-cat');
    const catName = document.getElementById('cat-name');
    const catMsg = document.getElementById('cat-msg');

    const modalEditLot = document.getElementById('modal-edit-lot');
    const btnCloseEditLot = document.getElementById('btn-close-edit-lot');
    const btnCancelEditLot = document.getElementById('btn-cancel-edit-lot');
    const btnSaveEditLot = document.getElementById('btn-save-edit-lot');
    const editLotSubtitle = document.getElementById('edit-lot-subtitle');
    const editLotProduct = document.getElementById('edit-lot-product');
    const editLotQty = document.getElementById('edit-lot-qty');
    const editLotCu = document.getElementById('edit-lot-cu');
    const editLotCode = document.getElementById('edit-lot-code');
    const editLotDate = document.getElementById('edit-lot-date');
    const editLotExp = document.getElementById('edit-lot-exp');
    const editLotSupplier = document.getElementById('edit-lot-supplier');
    const editLotSupplierId = document.getElementById('edit-lot-supplier-id');
    const btnSelectSupplierLotEdit = document.getElementById('btn-select-supplier-lot-edit');
    const linkCreateSupplierLotEdit = document.getElementById('link-create-supplier-lot-edit');
    const editLotNote = document.getElementById('edit-lot-note');
    const editLotMsg = document.getElementById('edit-lot-msg');

    let editingLotId = '';

    function categoryLabel(p) {
        try {
            const co = p && (p.category_obj || p.categoryObj);
            const name = co && (co.name || co.label);
            if (name) return String(name || '').trim();
        } catch (e) {
        }
        try {
            const c = (p && (p.category || p.category_name)) ?? '';
            if (c && typeof c === 'string') return String(c).trim();
            if (c && typeof c === 'object') {
                const n = (c && (c.name || c.label)) ? String(c.name || c.label).trim() : '';
                return n || '';
            }
        } catch (e) {
        }
        return '';
    }

    const modalFile = document.getElementById('modal-product-file');
    const fileSubtitle = document.getElementById('file-subtitle');
    const btnEditFile = document.getElementById('btn-edit-file');
    const btnSaveFile = document.getElementById('btn-save-file');
    const btnCancelFile = document.getElementById('btn-cancel-file');
    const btnCloseFile = document.getElementById('btn-close-file');
    const btnCloseFileBottom = document.getElementById('btn-close-file-bottom');

    const fileScroll = document.getElementById('file-scroll');

    const fileNameView = document.getElementById('file-name-view');
    const fileName = document.getElementById('file-name');
    const fileCatView = document.getElementById('file-cat-view');
    const fileCat = document.getElementById('file-cat');
    const fileUnitView = document.getElementById('file-unit-view');
    const fileUnit = document.getElementById('file-unit');
    const wrapFileUnit = document.getElementById('wrap-file-unit');
    const fileUnitOther = document.getElementById('file-unit-other');
    const fileSku = document.getElementById('file-sku');
    const fileActiveView = document.getElementById('file-active-view');
    const fileActiveEditWrap = document.getElementById('file-active-edit-wrap');
    const fileActive = document.getElementById('file-active');
    const fileActiveLabel = document.getElementById('file-active-label');

    const fileSupplierView = document.getElementById('file-supplier-view');
    const fileSupplierEdit = document.getElementById('file-supplier-edit');
    const filePrimarySupplier = document.getElementById('file-primary-supplier');
    const filePrimarySupplierId = document.getElementById('file-primary-supplier-id');
    const btnSelectSupplierFile = document.getElementById('btn-select-supplier-file');
    const linkCreateSupplierFile = document.getElementById('link-create-supplier-file');

    const fileDescView = document.getElementById('file-desc-view');
    const fileDesc = document.getElementById('file-desc');

    const fileImagePreview = document.getElementById('file-image-preview');
    const fileImagePlaceholder = document.getElementById('file-image-placeholder');
    const fileImageView = document.getElementById('file-image-view');
    const fileImageEdit = document.getElementById('file-image-edit');
    const fileImage = document.getElementById('file-image');

    const fileMethodView = document.getElementById('file-method-view');
    const fileMethod = document.getElementById('file-method');
    const fileMethodLockMsg = document.getElementById('file-method-lock-msg');

    const fileStock = document.getElementById('file-stock');
    const fileMinView = document.getElementById('file-min-view');
    const fileMin = document.getElementById('file-min');
    const fileReorderView = document.getElementById('file-reorder-view');
    const fileReorder = document.getElementById('file-reorder');
    const fileStatus = document.getElementById('file-status');
    const fileLotsTbody = document.getElementById('file-lots-tbody');

    const fileViewCards = document.getElementById('file-view-cards');
    const fileVName = document.getElementById('file-v-name');
    const fileVCategory = document.getElementById('file-v-category');
    const fileVUnit = document.getElementById('file-v-unit');
    const fileVActive = document.getElementById('file-v-active');
    const fileVSupplier = document.getElementById('file-v-supplier');
    const fileVDesc = document.getElementById('file-v-desc');
    const fileVStock = document.getElementById('file-v-stock');
    const fileVMin = document.getElementById('file-v-min');
    const fileVReorder = document.getElementById('file-v-reorder');
    const fileVStatus = document.getElementById('file-v-status');
    const fileVMethod = document.getElementById('file-v-method');
    const fileVImagePreview = document.getElementById('file-v-image-preview');
    const fileVImagePlaceholder = document.getElementById('file-v-image-placeholder');
    const fileVImageOptional = document.getElementById('file-v-image-optional');

    const fileSecA = document.getElementById('file-sec-a');
    const fileSecB = document.getElementById('file-sec-b');
    const fileSecD = document.getElementById('file-sec-d');

    const btnFileChart15 = document.getElementById('file-chart-15');
    const btnFileChart30 = document.getElementById('file-chart-30');
    const btnFileChart60 = document.getElementById('file-chart-60');
    const btnFileChart90 = document.getElementById('file-chart-90');
    const fileChartMeta = document.getElementById('file-chart-meta');
    const fileChartWrap = document.getElementById('file-chart-wrap');
    const fileChartSvg = document.getElementById('file-chart-svg');
    const fileChartTooltip = document.getElementById('file-chart-tooltip');

    const modalSelectSupplier = document.getElementById('modal-select-supplier');
    const btnCloseSelectSupplier = document.getElementById('btn-close-select-supplier');
    const btnCancelSelectSupplier = document.getElementById('btn-cancel-select-supplier');
    const supplierModalSearch = document.getElementById('supplier-modal-search');
    const supplierModalList = document.getElementById('supplier-modal-list');
    const linkCreateSupplierFromInv = document.getElementById('link-create-supplier-from-inv');

    const prodName = document.getElementById('prod-name');
    const prodCatId = document.getElementById('prod-cat-id');
    const prodUnit = document.getElementById('prod-unit');
    const wrapProdUnit = document.getElementById('wrap-prod-unit');
    const prodUnitOther = document.getElementById('prod-unit-other');
    const prodActive = document.getElementById('prod-active');
    const prodActiveLabel = document.getElementById('prod-active-label');
    const prodImage = document.getElementById('prod-image');
    const prodImagePreview = document.getElementById('prod-image-preview');
    const prodImagePlaceholder = document.getElementById('prod-image-placeholder');
    const prodLots = document.getElementById('prod-lots');
    const prodLotsLabel = document.getElementById('prod-lots-label');
    const prodMethod = document.getElementById('prod-method');
    const prodMethodLockMsg = document.getElementById('prod-method-lock-msg');
    const prodMin = document.getElementById('prod-min');
    const prodReorder = document.getElementById('prod-reorder');
    const prodDesc = document.getElementById('prod-desc');
    const prodPrimarySupplier = document.getElementById('prod-primary-supplier');
    const prodPrimarySupplierId = document.getElementById('prod-primary-supplier-id');
    const btnSelectSupplierProduct = document.getElementById('btn-select-supplier-product');
    const linkCreateSupplierProduct = document.getElementById('link-create-supplier-product');
    const btnSaveProduct = document.getElementById('btn-save-product');

    const lotProduct = document.getElementById('lot-product');
    const lotDate = document.getElementById('lot-date');
    const lotSupplier = document.getElementById('lot-supplier');
    const lotSupplierId = document.getElementById('lot-supplier-id');
    const btnSelectSupplierLot = document.getElementById('btn-select-supplier-lot');
    const linkCreateSupplierLot = document.getElementById('link-create-supplier-lot');
    const lotCu = document.getElementById('lot-cu');
    const lotQty = document.getElementById('lot-qty');
    const lotCt = document.getElementById('lot-ct');
    const lotExp = document.getElementById('lot-exp');
    const lotNoExp = document.getElementById('lot-no-exp');
    const lotNote = document.getElementById('lot-note');
    const btnSaveLot = document.getElementById('btn-save-lot');

    const modalExport = document.getElementById('modal-export-inv');
    const btnCloseExport = document.getElementById('btn-close-export-inv');
    const btnCancelExport = document.getElementById('btn-cancel-export-inv');
    const btnExportPdf = document.getElementById('btn-export-inv-pdf');
    const btnExportXls = document.getElementById('btn-export-inv-xls');

    const modalPrecios = document.getElementById('modal-precios-inv');
    const btnClosePrecios = document.getElementById('btn-close-precios-inv');
    const btnCancelPrecios = document.getElementById('btn-cancel-precios-inv');
    const btnSavePrecios = document.getElementById('btn-save-precios-inv');
    const preciosTbody = document.getElementById('precios-tbody');
    const preciosMsg = document.getElementById('precios-msg');
    const preciosQ = document.getElementById('precios-q');
    const preciosCat = document.getElementById('precios-cat');

    let activeTab = 'current';

    let cacheProducts = [];
    let cacheLots = [];
    let cacheMovements = [];
    let cacheCategories = [];
    let didLoadCategories = false;
    let suppliersCache = null;
    let currentSupplierTarget = '';
    let suppressSupplierInputClear = false;

    function applyReturnedSupplierSelection() {
        try {
            const url = new URL(window.location.href);
            const supplierId = String(url.searchParams.get('supplier_id') || '').trim();
            const supplierName = String(url.searchParams.get('supplier_name') || '').trim();
            const target = String(url.searchParams.get('inv_supplier_target') || '').trim();
            if (!target) return;
            if (!supplierId && !supplierName) return;

            if (target === 'lot') {
                openAddLot();
            } else if (target === 'product') {
                openCreate();
            } else {
                openCreate();
            }

            currentSupplierTarget = target;
            setSupplierOnTarget({ id: supplierId, name: supplierName });

            suppliersCache = null;

            url.searchParams.delete('supplier_id');
            url.searchParams.delete('supplier_name');
            url.searchParams.delete('inv_supplier_target');
            window.history.replaceState({}, '', url.pathname + (url.searchParams.toString() ? ('?' + url.searchParams.toString()) : ''));
        } catch (e) {
        }
    }

    let fileProductId = '';
    let fileEditMode = false;
    let fileImageWasChanged = false;
    let fileChartDays = 30;
    let fileChartSeries = [];

    function parseNumeroSeguro(v) {
        const n = parseFloat(String(v ?? '').replace(',', '.'));
        return isNaN(n) ? 0 : n;
    }

    function openAddLot() {
        resetCreateModal();
        abrirModal(modalCreate, true);
        try { if (createInvScroll) createInvScroll.scrollTop = 0; } catch (e) { }
        if (createInvTitle) createInvTitle.textContent = 'Agregar lote a un producto existente';
        if (createInvSubtitle) createInvSubtitle.textContent = 'Ingres√° stock real con costo y vencimiento.';
        if (choiceWrap) choiceWrap.classList.add('hidden');
        if (formProduct) formProduct.classList.add('hidden');
        if (formLot) {
            formLot.classList.remove('hidden');
        }
        try {
            poblarProductosSelect();
        } catch (e) {
        }
    }

    function _dateToIso(d) {
        try {
            const yy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return yy + '-' + mm + '-' + dd;
        } catch (e) {
            return '';
        }
    }

    function _dateAddDays(d, days) {
        const x = new Date(d.getTime());
        x.setDate(x.getDate() + days);
        return x;
    }

    function buildStockSeriesFromMovements({ currentStock, movements, days }) {
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        const end = now;
        const start = _dateAddDays(end, -(Math.max(1, parseInt(days || 30, 10)) - 1));

        const byDate = new Map();
        const byIn = new Map();
        const byOut = new Map();
        (Array.isArray(movements) ? movements : []).forEach(m => {
            const ds = String(m?.date || '').slice(0, 10);
            if (!ds) return;
            const t = new Date(ds + 'T00:00:00').getTime();
            if (isNaN(t)) return;
            if (t < start.getTime() || t > end.getTime()) return;
            const delta = parseNumeroSeguro(m?.qty_delta);
            byDate.set(ds, (byDate.get(ds) || 0) + delta);

            const rawType = String(m?.type || '').trim().toLowerCase();
            let inQty = 0;
            let outQty = 0;
            if (rawType === 'sale') {
                outQty = Math.max(0, -delta);
            } else if (rawType === 'purchase' || rawType === 'return') {
                inQty = Math.max(0, delta);
            } else {
                inQty = Math.max(0, delta);
                outQty = Math.max(0, -delta);
            }
            if (inQty) byIn.set(ds, (byIn.get(ds) || 0) + inQty);
            if (outQty) byOut.set(ds, (byOut.get(ds) || 0) + outQty);
        });

        const dates = [];
        for (let i = 0; i < Math.max(1, parseInt(days || 30, 10)); i++) {
            dates.push(_dateToIso(_dateAddDays(start, i)));
        }

        const seriesReversed = [];
        let stockEnd = parseNumeroSeguro(currentStock);
        for (let i = dates.length - 1; i >= 0; i--) {
            const ds = dates[i];
            const delta = byDate.get(ds) || 0;
            const inQty = byIn.get(ds) || 0;
            const outQty = byOut.get(ds) || 0;
            seriesReversed.push({ date: ds, stock: stockEnd, delta: delta, in_qty: inQty, out_qty: outQty });
            stockEnd = stockEnd - delta;
        }

        return seriesReversed.reverse();
    }

    function setFileChartButtons(days) {
        fileChartDays = parseInt(days || 30, 10);
        const d = fileChartDays;
        const setBtn = (btn, isActive) => {
            if (!btn) return;
            btn.classList.toggle('bg-white', isActive);
            btn.classList.toggle('shadow-sm', isActive);
            btn.classList.toggle('text-gray-900', isActive);
            btn.classList.toggle('text-gray-600', !isActive);
        };
        setBtn(btnFileChart15, d === 15);
        setBtn(btnFileChart30, d === 30);
        setBtn(btnFileChart60, d === 60);
        setBtn(btnFileChart90, d === 90);
    }

    function renderFileStockChart(series) {
        if (!fileChartSvg) return;
        const s = Array.isArray(series) ? series : [];
        fileChartSeries = s;

        const w = 640;
        const h = 200;
        const padL = 48;
        const padR = 12;
        const padT = 12;
        const padB = 30;

        const colStock = '#0d1067';
        const colIn = '#16a34a';
        const colOut = '#dc2626';

        const fmtShortDate = function (ds) {
            try {
                const d = new Date(String(ds || '').slice(0, 10) + 'T00:00:00');
                if (isNaN(d.getTime())) return String(ds || '').slice(5, 10);
                const dd = String(d.getDate()).padStart(2, '0');
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                return dd + '/' + mm;
            } catch (e) {
                return String(ds || '').slice(5, 10);
            }
        };

        const fmtNum = function (v) {
            return parseNumeroSeguro(v).toLocaleString('es-AR', { maximumFractionDigits: 2 });
        };

        const stockValues = s.map(p => parseNumeroSeguro(p.stock));
        const inValues = s.map(p => parseNumeroSeguro(p.in_qty));
        const outValues = s.map(p => parseNumeroSeguro(p.out_qty));
        const all = stockValues.concat(inValues).concat(outValues);
        let minV = 0;
        let maxV = all.length ? Math.max.apply(null, all) : 0;
        if (!(maxV > 0)) maxV = 1;

        const plotW = w - padL - padR;
        const plotH = h - padT - padB;

        const xFor = (i) => {
            if (s.length <= 1) return padL;
            return padL + (i / (s.length - 1)) * plotW;
        };
        const yFor = (v) => {
            const vv = parseNumeroSeguro(v);
            const t = (vv - minV) / (maxV - minV);
            return (padT + plotH) - t * plotH;
        };

        const pathFor = function (key) {
            let d = '';
            s.forEach((p, i) => {
                const x = xFor(i);
                const y = yFor(p && p[key]);
                d += (i === 0 ? 'M' : 'L') + x.toFixed(2) + ' ' + y.toFixed(2) + ' ';
            });
            return d.trim();
        };

        const dStock = pathFor('stock');
        const dIn = pathFor('in_qty');
        const dOut = pathFor('out_qty');

        const yTicks = 4;
        const gridY = Array.from({ length: yTicks + 1 }).map((_, i) => {
            const t = i / yTicks;
            return (padT + plotH) - t * plotH;
        });

        const grid = gridY.map(y => '<line x1="' + padL + '" y1="' + y.toFixed(2) + '" x2="' + (w - padR) + '" y2="' + y.toFixed(2) + '" stroke="#F3F4F6" stroke-width="1" />').join('');
        const axisX = '<line x1="' + padL + '" y1="' + (padT + plotH).toFixed(2) + '" x2="' + (w - padR) + '" y2="' + (padT + plotH).toFixed(2) + '" stroke="#E5E7EB" stroke-width="1" />';
        const axisY = '<line x1="' + padL + '" y1="' + padT + '" x2="' + padL + '" y2="' + (padT + plotH) + '" stroke="#E5E7EB" stroke-width="1" />';

        const yLabels = gridY.map((y, i) => {
            const t = i / yTicks;
            const val = minV + t * (maxV - minV);
            return '<text x="' + (padL - 8) + '" y="' + (y + 4).toFixed(2) + '" text-anchor="end" font-size="10" fill="#6B7280">' + fmtNum(val) + '</text>';
        }).join('');

        const xTicks = Math.min(4, Math.max(2, s.length));
        const xLabelIdx = Array.from({ length: xTicks }).map((_, i) => {
            if (xTicks === 1) return 0;
            return Math.round((i / (xTicks - 1)) * (s.length - 1));
        });
        const xLabels = xLabelIdx.map(idx => {
            const x = xFor(idx);
            const ds = s[idx] ? s[idx].date : '';
            return '<text x="' + x.toFixed(2) + '" y="' + (h - 10) + '" text-anchor="middle" font-size="10" fill="#6B7280">' + fmtShortDate(ds) + '</text>';
        }).join('');

        const axisTitles = ''
            + '<text x="' + ((padL + (w - padR)) / 2).toFixed(2) + '" y="' + (h - 2) + '" text-anchor="middle" font-size="10" fill="#9CA3AF">Fecha</text>'
            + '<text x="12" y="' + ((padT + plotH / 2)).toFixed(2) + '" text-anchor="middle" font-size="10" fill="#9CA3AF" transform="rotate(-90 12 ' + ((padT + plotH / 2)).toFixed(2) + ')">Cantidad</text>';

        const area = '<path d="' + dStock + 'L ' + (w - padR) + ' ' + (padT + plotH) + ' L ' + padL + ' ' + (padT + plotH) + ' Z" fill="' + colStock + '" opacity="0.06" />';
        const pathStock = '<path d="' + dStock + '" fill="none" stroke="' + colStock + '" stroke-width="2" />';
        const pathIn = '<path d="' + dIn + '" fill="none" stroke="' + colIn + '" stroke-width="2" />';
        const pathOut = '<path d="' + dOut + '" fill="none" stroke="' + colOut + '" stroke-width="2" />';

        const overlay = '<rect id="file-chart-hit" x="' + padL + '" y="' + padT + '" width="' + plotW + '" height="' + plotH + '" fill="transparent" />';
        const hoverLayer = ''
            + '<g id="file-chart-hover" opacity="0">'
            + '  <line id="file-chart-vline" x1="0" y1="' + padT + '" x2="0" y2="' + (padT + plotH) + '" stroke="#CBD5E1" stroke-width="1" stroke-dasharray="3 3" />'
            + '  <circle id="file-chart-dot-stock" cx="0" cy="0" r="4" fill="' + colStock + '" stroke="#ffffff" stroke-width="2" />'
            + '  <circle id="file-chart-dot-in" cx="0" cy="0" r="4" fill="' + colIn + '" stroke="#ffffff" stroke-width="2" />'
            + '  <circle id="file-chart-dot-out" cx="0" cy="0" r="4" fill="' + colOut + '" stroke="#ffffff" stroke-width="2" />'
            + '</g>';

        fileChartSvg.innerHTML = grid + axisX + axisY + yLabels + xLabels + axisTitles + area + pathStock + pathIn + pathOut + hoverLayer + overlay;

        if (fileChartMeta) {
            const last = s.length ? s[s.length - 1] : null;
            if (!last) {
                fileChartMeta.textContent = '';
            } else {
                const st = fmtNum(last.stock);
                const inn = fmtNum(last.in_qty);
                const outt = fmtNum(last.out_qty);
                fileChartMeta.innerHTML = ''
                    + '<span class="inline-flex items-center gap-1">'
                    + '  <span class="inline-block h-2 w-2 rounded-full" style="background:' + colStock + '"></span>'
                    + '  <span>Stock: ' + st + '</span>'
                    + '</span>'
                    + '<span class="mx-2">¬∑</span>'
                    + '<span class="inline-flex items-center gap-1">'
                    + '  <span class="inline-block h-2 w-2 rounded-full" style="background:' + colIn + '"></span>'
                    + '  <span>Ingresos: ' + inn + '</span>'
                    + '</span>'
                    + '<span class="mx-2">¬∑</span>'
                    + '<span class="inline-flex items-center gap-1">'
                    + '  <span class="inline-block h-2 w-2 rounded-full" style="background:' + colOut + '"></span>'
                    + '  <span>Egresos: ' + outt + '</span>'
                    + '</span>';
            }
        }

        const hideTip = function () {
            if (!fileChartTooltip) return;
            fileChartTooltip.classList.add('hidden');
        };
        hideTip();

        const hit = fileChartSvg.querySelector('#file-chart-hit');
        const hover = fileChartSvg.querySelector('#file-chart-hover');
        const vline = fileChartSvg.querySelector('#file-chart-vline');
        const dotStock = fileChartSvg.querySelector('#file-chart-dot-stock');
        const dotIn = fileChartSvg.querySelector('#file-chart-dot-in');
        const dotOut = fileChartSvg.querySelector('#file-chart-dot-out');

        const updateHover = function (idx, ev) {
            const p = fileChartSeries[idx];
            if (!p || !fileChartWrap || !fileChartTooltip) return;
            const rect = fileChartWrap.getBoundingClientRect();
            const x = ev.clientX - rect.left;
            const y = ev.clientY - rect.top;

            const xSvg = xFor(idx);
            const yStock = yFor(p.stock);
            const yIn = yFor(p.in_qty);
            const yOut = yFor(p.out_qty);

            try {
                if (hover) hover.setAttribute('opacity', '1');
                if (vline) {
                    vline.setAttribute('x1', xSvg.toFixed(2));
                    vline.setAttribute('x2', xSvg.toFixed(2));
                }
                if (dotStock) {
                    dotStock.setAttribute('cx', xSvg.toFixed(2));
                    dotStock.setAttribute('cy', yStock.toFixed(2));
                }
                if (dotIn) {
                    dotIn.setAttribute('cx', xSvg.toFixed(2));
                    dotIn.setAttribute('cy', yIn.toFixed(2));
                }
                if (dotOut) {
                    dotOut.setAttribute('cx', xSvg.toFixed(2));
                    dotOut.setAttribute('cy', yOut.toFixed(2));
                }
            } catch (e) {
            }

            const delta = parseNumeroSeguro(p.delta);
            const deltaTxt = delta ? ('Œî ' + fmtNum(delta)) : 'Œî 0';
            fileChartTooltip.innerHTML = ''
                + '<div class="font-semibold text-gray-900">' + String(p.date) + '</div>'
                + '<div class="mt-1 space-y-0.5">'
                + '  <div class="text-gray-600 inline-flex items-center gap-1"><span class="inline-block h-2 w-2 rounded-full" style="background:' + colStock + '"></span><span>Stock: ' + fmtNum(p.stock) + '</span></div>'
                + '  <div class="text-gray-600 inline-flex items-center gap-1"><span class="inline-block h-2 w-2 rounded-full" style="background:' + colIn + '"></span><span>Ingresos: ' + fmtNum(p.in_qty) + '</span></div>'
                + '  <div class="text-gray-600 inline-flex items-center gap-1"><span class="inline-block h-2 w-2 rounded-full" style="background:' + colOut + '"></span><span>Egresos: ' + fmtNum(p.out_qty) + '</span></div>'
                + '  <div class="text-gray-600">' + deltaTxt + '</div>'
                + '</div>';
            fileChartTooltip.style.left = Math.min(Math.max(0, x + 10), rect.width - 140) + 'px';
            fileChartTooltip.style.top = Math.max(0, y + 10) + 'px';
            fileChartTooltip.classList.remove('hidden');
        };

        const hideHover = function () {
            hideTip();
            try { if (hover) hover.setAttribute('opacity', '0'); } catch (e) { }
        };

        if (hit) {
            hit.addEventListener('mousemove', function (ev) {
                if (!fileChartWrap) return;
                const rect = fileChartWrap.getBoundingClientRect();
                const x = ev.clientX - rect.left;
                if (!(s && s.length)) return;
                const t = (x - (padL / w) * rect.width) / ((plotW / w) * rect.width);
                const idx = Math.max(0, Math.min(s.length - 1, Math.round(t * (s.length - 1))));
                updateHover(idx, ev);
            });
            hit.addEventListener('mouseleave', hideHover);
        }
    }

    function refreshFileChart(productId, days) {
        const pid = String(productId || '').trim();
        if (!pid) return;
        const relLots = (Array.isArray(cacheLots) ? cacheLots : []).filter(l => String(l?.product_id) === pid);
        const currentStock = relLots.reduce((acc, l) => acc + parseNumeroSeguro(l?.qty_available), 0);
        setFileChartButtons(days);
        apiListMovements(pid).then(function (movs) {
            const series = buildStockSeriesFromMovements({ currentStock, movements: movs, days: fileChartDays });
            renderFileStockChart(series);
        }).catch(function () {
            renderFileStockChart(buildStockSeriesFromMovements({ currentStock, movements: [], days: fileChartDays }));
        });
    }

    function isPromise(x) {
        return !!x && typeof x.then === 'function';
    }

    function loadSuppliersCache() {
        if (Array.isArray(suppliersCache)) return Promise.resolve(suppliersCache);
        try {
            if (window.StorageService && typeof window.StorageService.getSuppliers === 'function') {
                const res = window.StorageService.getSuppliers();
                if (isPromise(res)) {
                    return res.then(function (list) {
                        suppliersCache = Array.isArray(list) ? list : [];
                        return suppliersCache;
                    }).catch(function () {
                        suppliersCache = [];
                        return suppliersCache;
                    });
                }
                suppliersCache = Array.isArray(res) ? res : [];
                return Promise.resolve(suppliersCache);
            }
        } catch (e) {
        }
        return apiListSuppliers('').then(function (list) {
            suppliersCache = Array.isArray(list) ? list : [];
            return suppliersCache;
        }).catch(function () {
            suppliersCache = [];
            return suppliersCache;
        });
    }

    function normalizeSupplierCats(s) {
        const cats = s && Array.isArray(s.categories) ? s.categories : [];
        return cats.map(x => String(x || '').trim()).filter(Boolean);
    }

    function openSupplierModal(target) {
        currentSupplierTarget = String(target || '').trim();
        if (!modalSelectSupplier) return;
        abrirModal(modalSelectSupplier, true);
        if (supplierModalSearch) supplierModalSearch.value = '';
        loadSuppliersCache().then(function () {
            renderSupplierModalList('');
            try { supplierModalSearch?.focus(); } catch (e) { }
        });
    }

    function closeSupplierModal() {
        if (!modalSelectSupplier) return;
        abrirModal(modalSelectSupplier, false);
    }

    function setSupplierOnTarget(s) {
        const id = String(s?.id || '').trim();
        const name = String(s?.name || '').trim();
        if (currentSupplierTarget === 'lot_edit') {
            suppressSupplierInputClear = true;
            if (editLotSupplierId) editLotSupplierId.value = id;
            if (editLotSupplier) editLotSupplier.value = name;
            suppressSupplierInputClear = false;
            return;
        }
        if (currentSupplierTarget === 'file') {
            suppressSupplierInputClear = true;
            const fileSupplierId = document.getElementById('file-primary-supplier-id');
            const fileSupplier = document.getElementById('file-primary-supplier');
            if (fileSupplierId) fileSupplierId.value = id;
            if (fileSupplier) fileSupplier.value = name;
            suppressSupplierInputClear = false;
            return;
        }
        if (currentSupplierTarget === 'lot') {
            suppressSupplierInputClear = true;
            if (lotSupplierId) lotSupplierId.value = id;
            if (lotSupplier) lotSupplier.value = name;
            suppressSupplierInputClear = false;
            return;
        }
        suppressSupplierInputClear = true;
        if (prodPrimarySupplierId) prodPrimarySupplierId.value = id;
        if (prodPrimarySupplier) prodPrimarySupplier.value = name;
        suppressSupplierInputClear = false;
    }

    function renderSupplierModalList(q) {
        if (!supplierModalList) return;
        const query = String(q || '').trim().toLowerCase();
        const list = Array.isArray(suppliersCache) ? suppliersCache : [];
        const filtered = list
            .filter(s => (s?.status || 'Active') !== 'Discontinued')
            .filter(s => {
                const cats = normalizeSupplierCats(s).map(x => String(x || '').trim().toLowerCase());
                return cats.includes('inventario');
            })
            .filter(s => {
                if (!query) return true;
                const name = String(s?.name || '').toLowerCase();
                return name.includes(query);
            })
            .slice(0, 300);

        supplierModalList.innerHTML = '';
        const head = document.createElement('div');
        head.className = 'sticky top-0 z-10 bg-gray-50 px-4 py-2 text-[11px] font-semibold text-gray-500 uppercase grid grid-cols-2 gap-3';
        head.innerHTML = '<div>Proveedor</div><div>Categor√≠as</div>';
        supplierModalList.appendChild(head);

        if (!filtered.length) {
            const empty = document.createElement('div');
            empty.className = 'px-4 py-6 text-sm text-center text-gray-500';
            empty.textContent = 'Sin resultados.';
            supplierModalList.appendChild(empty);
            return;
        }

        filtered.forEach(function (s) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'w-full text-left px-4 py-3 hover:bg-gray-50 grid grid-cols-2 gap-3';
            const cats = normalizeSupplierCats(s);
            const catsLabel = cats.length ? cats.join(' ¬∑ ') : '‚Äî';
            btn.innerHTML = ''
                + '<div class="text-[11px] leading-4 font-semibold text-gray-900">' + String(s?.name || 'Proveedor') + '</div>'
                + '<div class="text-[9px] leading-4 text-gray-600">' + catsLabel + '</div>';
            btn.addEventListener('click', function () {
                setSupplierOnTarget(s);
                closeSupplierModal();
            });
            supplierModalList.appendChild(btn);
        });
    }

    function formatMoney(n) {
        const val = isNaN(n) ? 0 : n;
        return '$' + val.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function fmtFecha(v) {
        try {
            if (window.formatFechaDisplay && typeof window.formatFechaDisplay === 'function') {
                return window.formatFechaDisplay(v);
            }
        } catch (e) {
        }
        return String(v ?? '');
    }

    function openPrecios() {
        abrirModal(modalPrecios, true);
        if (!Array.isArray(cacheProducts) || !cacheProducts.length) {
            if (preciosTbody) preciosTbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-sm text-center text-gray-500">Cargando productos‚Ä¶</td></tr>';
            loadProductsLots(function () {
                renderPreciosTable();
            });
            return;
        }
        renderPreciosTable();
    }

    function closePrecios() {
        abrirModal(modalPrecios, false);
    }

    function apiListProducts() {
        return fetch('/inventory/api/products?active=1&limit=5000', { credentials: 'same-origin' })
            .then(r => r.json())
            .then(d => (d && d.ok && Array.isArray(d.items)) ? d.items : []);
    }

    function apiListSuppliers(q) {
        const qs = [];
        const query = String(q || '').trim();
        if (query) qs.push('q=' + encodeURIComponent(query));
        qs.push('limit=5000');
        const url = '/suppliers/api/suppliers' + (qs.length ? ('?' + qs.join('&')) : '');
        return fetch(url, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(d => (d && d.ok && Array.isArray(d.items)) ? d.items : []);
    }

    function apiListCategories() {
        return fetch('/inventory/api/categories?active=1&limit=5000', { credentials: 'same-origin' })
            .then(r => r.json())
            .then(d => (d && d.ok && Array.isArray(d.items)) ? d.items : []);
    }

    function apiCreateCategory(payload) {
        return fetch('/inventory/api/categories', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload || {})
        }).then(r => r.json());
    }

    function apiGetMethodLock(productId) {
        return fetch('/inventory/api/products/' + encodeURIComponent(String(productId)) + '/method_lock', { credentials: 'same-origin' })
            .then(r => r.json());
    }

    function apiUploadProductImage(productId, file) {
        const fd = new FormData();
        fd.append('image', file);
        return fetch('/inventory/api/products/' + encodeURIComponent(String(productId)) + '/image', {
            method: 'POST',
            credentials: 'same-origin',
            body: fd
        }).then(r => r.json());
    }

    function apiListLots() {
        return fetch('/inventory/api/lots?limit=10000', { credentials: 'same-origin' })
            .then(r => r.json())
            .then(d => (d && d.ok && Array.isArray(d.items)) ? d.items : []);
    }

    function apiListMovements(productId) {
        const qs = [];
        if (productId) qs.push('product_id=' + encodeURIComponent(String(productId)));
        qs.push('limit=2000');
        const url = '/inventory/api/movements' + (qs.length ? ('?' + qs.join('&')) : '');
        return fetch(url, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(d => (d && d.ok && Array.isArray(d.items)) ? d.items : []);
    }

    function apiCreateProduct(payload) {
        return fetch('/inventory/api/products', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload || {})
        }).then(r => r.json());
    }

    function apiUpdateProduct(productId, payload) {
        return fetch('/inventory/api/products/' + encodeURIComponent(String(productId)), {
            method: 'PUT',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload || {})
        }).then(r => r.json());
    }

    function apiDeleteProduct(productId) {
        return fetch('/inventory/api/products/' + encodeURIComponent(String(productId)), {
            method: 'DELETE',
            credentials: 'same-origin'
        }).then(r => r.json());
    }

    function apiCreateLot(payload) {
        return fetch('/inventory/api/lots', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload || {})
        }).then(r => r.json());
    }

    function apiBulkUpdatePrices(items) {
        return fetch('/inventory/api/products/prices', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: Array.isArray(items) ? items : [] })
        }).then(r => r.json());
    }

    function apiDeleteLot(lotId) {
        return fetch('/inventory/api/lots/' + encodeURIComponent(String(lotId)), {
            method: 'DELETE',
            credentials: 'same-origin'
        }).then(r => r.json());
    }

    function apiUpdateLot(lotId, payload) {
        return fetch('/inventory/api/lots/' + encodeURIComponent(String(lotId)), {
            method: 'PUT',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload || {})
        }).then(r => r.json());
    }

    function loadProductsLots(cb) {
        const pRes = apiListProducts();
        const lRes = apiListLots();
        const mRes = apiListMovements('');
        return Promise.all([Promise.resolve(pRes), Promise.resolve(lRes), Promise.resolve(mRes)]).then(function (vals) {
            const products = Array.isArray(vals[0]) ? vals[0] : [];
            const lots = Array.isArray(vals[1]) ? vals[1] : [];
            const movements = Array.isArray(vals[2]) ? vals[2] : [];
            cacheProducts = products;
            cacheLots = lots;
            cacheMovements = movements;
            if (typeof cb === 'function') cb(products, lots, movements);
        }).catch(function () {
            cacheProducts = [];
            cacheLots = [];
            cacheMovements = [];
            if (typeof cb === 'function') cb([], [], []);
        });
    }

    function loadCategories(cb) {
        return apiListCategories().then(function (cats) {
            cacheCategories = Array.isArray(cats) ? cats : [];
            if (typeof cb === 'function') cb(cacheCategories);
            return cacheCategories;
        }).catch(function () {
            cacheCategories = [];
            if (typeof cb === 'function') cb([]);
            return [];
        });
    }

    function refreshCategorySelect(selectedId) {
        if (!prodCatId) return;
        const cur = String(selectedId ?? prodCatId.value ?? '').trim();
        const cats = (Array.isArray(cacheCategories) ? cacheCategories : []).filter(c => !!c && c.active !== false);
        cats.sort((a, b) => String(a?.name || '').localeCompare(String(b?.name || '')));
        prodCatId.innerHTML = '<option value="">‚Äî Seleccionar ‚Äî</option>';
        cats.forEach(c => {
            const opt = document.createElement('option');
            opt.value = String(c.id);
            opt.textContent = String(c.name || 'Categor√≠a');
            prodCatId.appendChild(opt);
        });
        prodCatId.value = cur;
    }

    function badgeStatus(st) {
        if (st === 'Cr√≠tico') return '<span class="px-2 py-0.5 rounded-full bg-red-50 text-red-700 text-[11px] font-medium">Cr√≠tico</span>';
        if (st === 'Reponer') return '<span class="px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 text-[11px] font-medium">Reponer</span>';
        return '<span class="px-2 py-0.5 rounded-full bg-green-50 text-green-700 text-[11px] font-medium">OK</span>';
    }

    function getStatus(stock, reorderPoint, minStock) {
        const s = parseNumeroSeguro(stock);
        const rp = parseNumeroSeguro(reorderPoint);
        const ms = parseNumeroSeguro(minStock);
        if (ms > 0 && s <= ms) return 'Cr√≠tico';
        if (rp > 0 && s <= rp) return 'Reponer';
        return 'OK';
    }

    function abrirModal(el, open) {
        if (!el) return;
        const willOpen = !!open;
        el.classList.toggle('hidden', !willOpen);
        try { el.setAttribute('aria-hidden', willOpen ? 'false' : 'true'); } catch (e) { }
        try {
            const anyOpen = Array.from(document.querySelectorAll('.fixed.inset-0.z-50')).some(m => !m.classList.contains('hidden'));
            document.body.classList.toggle('overflow-hidden', anyOpen);
        } catch (e) { }
    }

    let editingProductId = '';

    function syncProductToggleLabels() {
        if (prodActiveLabel) prodActiveLabel.textContent = (prodActive && prodActive.checked) ? 'Activo' : 'Inactivo';
        if (prodLotsLabel) prodLotsLabel.textContent = (prodLots && prodLots.checked) ? 'S√≠' : 'No';
    }

    function syncFileToggleLabels() {
        if (fileActiveLabel) fileActiveLabel.textContent = (fileActive && fileActive.checked) ? 'Activo' : 'Inactivo';
    }

    function refreshFileCategorySelect(selectedId) {
        if (!fileCat) return;
        const cur = String(selectedId ?? fileCat.value ?? '').trim();
        const cats = (Array.isArray(cacheCategories) ? cacheCategories : []).filter(c => !!c && c.active !== false);
        cats.sort((a, b) => String(a?.name || '').localeCompare(String(b?.name || '')));
        fileCat.innerHTML = '<option value="">‚Äî Seleccionar ‚Äî</option>';
        cats.forEach(c => {
            const opt = document.createElement('option');
            opt.value = String(c.id);
            opt.textContent = String(c.name || 'Categor√≠a');
            fileCat.appendChild(opt);
        });
        fileCat.value = cur;
    }

    function setFileImagePreviewUrl(url) {
        const imgUrl = String(url || '').trim();
        const hasImg = !!imgUrl;

        if (fileImagePreview) {
            fileImagePreview.src = hasImg ? imgUrl : '';
            fileImagePreview.classList.toggle('hidden', !hasImg);
        }
        if (fileImagePlaceholder) fileImagePlaceholder.classList.toggle('hidden', hasImg);

        if (fileVImagePreview) {
            fileVImagePreview.src = hasImg ? imgUrl : '';
            fileVImagePreview.classList.toggle('hidden', !hasImg);
        }
        if (fileVImagePlaceholder) fileVImagePlaceholder.classList.toggle('hidden', hasImg);
        if (fileVImageOptional) fileVImageOptional.classList.toggle('hidden', hasImg);

        if (fileImageView) fileImageView.classList.toggle('hidden', hasImg);
    }

    function toggleFileEditMode(enable) {
        fileEditMode = !!enable;

        if (fileViewCards) fileViewCards.classList.toggle('hidden', fileEditMode);
        if (fileSecA) fileSecA.classList.toggle('hidden', !fileEditMode);
        if (fileSecB) fileSecB.classList.toggle('hidden', !fileEditMode);
        if (fileSecD) fileSecD.classList.toggle('hidden', fileEditMode);

        if (btnEditFile) btnEditFile.classList.toggle('hidden', fileEditMode);
        if (btnSaveFile) btnSaveFile.classList.toggle('hidden', !fileEditMode);
        if (btnCancelFile) btnCancelFile.classList.toggle('hidden', !fileEditMode);

        if (fileNameView) fileNameView.classList.toggle('hidden', fileEditMode);
        if (fileName) fileName.classList.toggle('hidden', !fileEditMode);

        if (fileCatView) fileCatView.classList.toggle('hidden', fileEditMode);
        if (fileCat) fileCat.classList.toggle('hidden', !fileEditMode);

        if (fileUnitView) fileUnitView.classList.toggle('hidden', fileEditMode);
        if (fileUnit) fileUnit.classList.toggle('hidden', !fileEditMode);
        if (wrapFileUnit) wrapFileUnit.classList.toggle('hidden', !fileEditMode || String(fileUnit?.value || '') !== 'Otro');

        if (fileActiveView) fileActiveView.classList.toggle('hidden', fileEditMode);
        if (fileActiveEditWrap) fileActiveEditWrap.classList.toggle('hidden', !fileEditMode);
        syncFileToggleLabels();

        if (fileSupplierView) fileSupplierView.classList.toggle('hidden', fileEditMode);
        if (fileSupplierEdit) fileSupplierEdit.classList.toggle('hidden', !fileEditMode);

        if (fileDescView) fileDescView.classList.toggle('hidden', fileEditMode);
        if (fileDesc) fileDesc.classList.toggle('hidden', !fileEditMode);

        if (fileImageEdit) fileImageEdit.classList.toggle('hidden', !fileEditMode);

        if (fileMethodView) fileMethodView.classList.toggle('hidden', fileEditMode);
        if (fileMethod) fileMethod.classList.toggle('hidden', !fileEditMode);

        if (fileMinView) fileMinView.classList.toggle('hidden', fileEditMode);
        if (fileMin) fileMin.classList.toggle('hidden', !fileEditMode);
        if (fileReorderView) fileReorderView.classList.toggle('hidden', fileEditMode);
        if (fileReorder) fileReorder.classList.toggle('hidden', !fileEditMode);

        setFileCompactMode(!fileEditMode);
    }

    function setFileCompactMode(compact) {
        const c = !!compact;

        const setTitle = function (el) {
            if (!el) return;
            el.classList.toggle('text-sm', !c);
            el.classList.toggle('text-xs', c);
        };

        const setGrid = function (el) {
            if (!el) return;
            el.classList.toggle('gap-3', !c);
            el.classList.toggle('gap-2', c);
        };

        const setField = function (el) {
            if (!el) return;
            if (c) {
                el.classList.remove('px-3');
                el.classList.remove('py-2');
                el.classList.remove('text-sm');
                el.classList.remove('border');
                el.classList.remove('rounded-md');
                el.classList.remove('bg-gray-50');
                el.classList.add('px-0');
                el.classList.add('py-0');
                el.classList.add('text-xs');
                el.classList.add('text-gray-700');
            } else {
                el.classList.remove('px-0');
                el.classList.remove('py-0');
                el.classList.remove('text-xs');
                el.classList.remove('text-gray-700');
                el.classList.add('px-3');
                el.classList.add('py-2');
                el.classList.add('text-sm');
                el.classList.add('border');
                el.classList.add('rounded-md');
                el.classList.add('bg-gray-50');
            }
        };

        setTitle(document.getElementById('file-sec-a-title'));
        setTitle(document.getElementById('file-sec-b-title'));
        setTitle(document.getElementById('file-sec-c-title'));
        setTitle(document.getElementById('file-sec-d-title'));

        setGrid(document.getElementById('file-sec-a-grid'));
        setGrid(document.getElementById('file-sec-b-grid'));

        // Campos en modo vista
        setField(fileNameView);
        setField(fileCatView);
        setField(fileUnitView);
        setField(fileSku);
        setField(fileActiveView);
        setField(fileSupplierView);
        setField(fileDescView);
        setField(fileMethodView);
        setField(fileStock);
        setField(fileMinView);
        setField(fileReorderView);
        setField(fileStatus);

        // Ajustes de layout
        if (fileScroll) {
            fileScroll.classList.toggle('p-5', !c);
            fileScroll.classList.toggle('p-4', c);
        }

        const sections = document.getElementById('file-sections');
        if (sections) {
            sections.classList.toggle('space-y-5', !c);
            sections.classList.toggle('space-y-3', c);
        }

        const lotsWrap = document.getElementById('file-sec-c-wrap');
        if (lotsWrap) {
            lotsWrap.style.maxHeight = c ? '26vh' : '40vh';
            try {
                const cells = Array.from(lotsWrap.querySelectorAll('th,td'));
                cells.forEach(function (cell) {
                    cell.classList.toggle('px-4', !c);
                    cell.classList.toggle('py-3', !c);
                    cell.classList.toggle('px-3', c);
                    cell.classList.toggle('py-2', c);
                    cell.classList.toggle('text-sm', !c);
                    cell.classList.toggle('text-xs', c);
                });
            } catch (e) {
            }
        }

        const chartCard = document.getElementById('file-chart-card');
        if (chartCard) {
            chartCard.classList.toggle('p-3', !c);
            chartCard.classList.toggle('p-2', c);
        }

        if (fileChartSvg) {
            fileChartSvg.classList.toggle('h-48', !c);
            fileChartSvg.classList.toggle('h-36', c);
        }
    }

    function closeProductFile() {
        fileProductId = '';
        fileEditMode = false;
        fileImageWasChanged = false;
        if (fileImage) fileImage.value = '';
        toggleFileEditMode(false);
        abrirModal(modalFile, false);
    }

    function renderFileLots(productId) {
        if (!fileLotsTbody) return;
        const pid = String(productId || '').trim();
        const lots = (Array.isArray(cacheLots) ? cacheLots : [])
            .filter(l => String(l?.product_id) === pid)
            .slice();
        lots.sort((a, b) => String(b?.received_at || '').localeCompare(String(a?.received_at || '')));
        if (!lots.length) {
            fileLotsTbody.innerHTML = '<tr><td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">Todav√≠a no hay lotes para este producto.</td></tr>';
            return;
        }
        fileLotsTbody.innerHTML = '';
        lots.forEach(l => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = ''
                + '<td class="px-4 py-3 text-sm text-gray-500">' + fmtFecha(l?.received_at || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + String(l?.lot_code || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-500">' + String(parseNumeroSeguro(l?.qty_initial).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-500">' + String(parseNumeroSeguro(l?.qty_available).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-500">' + formatMoney(parseNumeroSeguro(l?.unit_cost)) + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + String(l?.supplier_name || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + (l?.expiration_date ? fmtFecha(l.expiration_date) : '‚Äî') + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + (String(l?.note || '').trim() || '‚Äî') + '</td>'
                + '<td class="px-4 py-3 text-sm text-right">'
                + '  <button type="button" class="btn-edit-file-lot text-xs font-medium text-indigo-700 hover:text-indigo-900" data-lot-id="' + String(l?.id || '') + '">Editar</button>'
                + '</td>';
            fileLotsTbody.appendChild(tr);
        });
        Array.from(fileLotsTbody.querySelectorAll('.btn-edit-file-lot')).forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.getAttribute('data-lot-id') || '';
                openEditLot(id);
            });
        });
    }

    function openProductFile(productId) {
        const pid = String(productId || '').trim();
        if (!pid || !modalFile) return;

        fileProductId = pid;
        fileEditMode = false;
        fileImageWasChanged = false;
        if (fileVName) fileVName.textContent = '‚Äî';
        if (fileVCategory) fileVCategory.textContent = '‚Äî';
        if (fileVUnit) fileVUnit.textContent = '‚Äî';
        if (fileVActive) fileVActive.textContent = '‚Äî';
        if (fileVSupplier) fileVSupplier.textContent = '‚Äî';
        if (fileVDesc) fileVDesc.textContent = '‚Äî';
        if (fileVStock) fileVStock.textContent = '‚Äî';
        if (fileVMin) fileVMin.textContent = '‚Äî';
        if (fileVReorder) fileVReorder.textContent = '‚Äî';
        if (fileVStatus) fileVStatus.textContent = '‚Äî';
        if (fileVMethod) fileVMethod.textContent = '‚Äî';
        if (fileSubtitle) fileSubtitle.textContent = 'Cargando‚Ä¶';
        if (fileLotsTbody) fileLotsTbody.innerHTML = '<tr><td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">Cargando‚Ä¶</td></tr>';
        if (fileChartSvg) fileChartSvg.innerHTML = '';
        toggleFileEditMode(false);
        abrirModal(modalFile, true);

        const ensure = (!Array.isArray(cacheProducts) || !cacheProducts.length)
            ? loadProductsLots
            : function (cb) { if (typeof cb === 'function') cb(cacheProducts, cacheLots, cacheMovements); };

        const maybePromise = ensure(function () {
            try {
                const prod = (Array.isArray(cacheProducts) ? cacheProducts : []).find(p => String(p?.id || '') === pid);
                if (!prod) {
                    if (window.showAlertModal) window.showAlertModal('No se encontr√≥ el producto seleccionado.', 'Atenci√≥n', 'Legajo');
                    else alert('No se encontr√≥ el producto seleccionado.');
                    closeProductFile();
                    return;
                }

                fileProductId = pid;
                fileImageWasChanged = false;

                if (fileSubtitle) fileSubtitle.textContent = String(prod?.name || '');

                const catName = String(prod?.category?.name || prod?.category || '').trim();
                const unitName = String(prod?.unit_name || prod?.unit || '').trim();
                const supplierName = String(prod?.primary_supplier_name || '').trim();
                const supplierId = String(prod?.primary_supplier_id || '').trim();
                const internalCode = String(prod?.internal_code || '').trim();

                if (fileNameView) fileNameView.textContent = String(prod?.name || '');
                if (fileName) fileName.value = String(prod?.name || '');

                if (fileVName) fileVName.textContent = String(prod?.name || '‚Äî');
                if (fileVCategory) fileVCategory.textContent = catName || '‚Äî';
                if (fileVUnit) fileVUnit.textContent = unitName || '‚Äî';
                if (fileVActive) fileVActive.textContent = (prod?.active !== false) ? 'Activo' : 'Inactivo';
                if (fileVSupplier) fileVSupplier.textContent = supplierName || '‚Äî';
                if (fileVDesc) fileVDesc.textContent = (String(prod?.description || '').trim() || '‚Äî');

                if (fileCatView) fileCatView.textContent = catName || '‚Äî';
                if (!didLoadCategories) {
                    didLoadCategories = true;
                    loadCategories(function () {
                        refreshCategorySelect(prodCatId?.value || '');
                        refreshFileCategorySelect(String(prod?.category_id || prod?.category?.id || ''));
                    });
                } else {
                    refreshFileCategorySelect(String(prod?.category_id || prod?.category?.id || ''));
                }

                const knownUnits = ['Unidad', 'Kg', 'L', 'Otro'];
                if (fileUnitView) fileUnitView.textContent = unitName || '‚Äî';
                if (fileUnit) {
                    if (knownUnits.includes(unitName)) {
                        fileUnit.value = unitName || 'Unidad';
                        if (wrapFileUnit) wrapFileUnit.classList.toggle('hidden', String(fileUnit.value) !== 'Otro');
                        if (fileUnitOther && String(fileUnit.value) !== 'Otro') fileUnitOther.value = '';
                    } else {
                        fileUnit.value = 'Otro';
                        if (wrapFileUnit) wrapFileUnit.classList.remove('hidden');
                        if (fileUnitOther) fileUnitOther.value = unitName;
                    }
                }

                const active = (prod?.active !== false);
                if (fileActiveView) fileActiveView.textContent = active ? 'Activo' : 'Inactivo';
                if (fileActive) fileActive.checked = active;
                syncFileToggleLabels();

                if (fileSku) fileSku.textContent = internalCode || '‚Äî';

                if (fileSupplierView) fileSupplierView.textContent = supplierName || '‚Äî';
                if (filePrimarySupplier) filePrimarySupplier.value = supplierName;
                if (filePrimarySupplierId) filePrimarySupplierId.value = supplierId;

                const desc = String(prod?.description || '').trim();
                if (fileDescView) fileDescView.textContent = desc || '‚Äî';
                if (fileDesc) fileDesc.value = desc;

                setFileImagePreviewUrl(String(prod?.image_url || '').trim());
                if (fileImage) fileImage.value = '';

                const method = String(prod?.method || 'FIFO').trim() || 'FIFO';
                const methodLabel = (method === 'Average') ? 'Costo promedio' : 'PEPS';
                if (fileMethodView) fileMethodView.textContent = methodLabel;
                if (fileMethod) fileMethod.value = method;
                if (fileVMethod) fileVMethod.textContent = methodLabel;

                try {
                    if (fileMethod && typeof apiGetMethodLock === 'function') {
                        apiGetMethodLock(pid).then(function (res) {
                            const locked = !!(res && res.ok && res.locked);
                            fileMethod.disabled = locked;
                            fileMethod.classList.toggle('bg-gray-50', locked);
                            if (fileMethodLockMsg) fileMethodLockMsg.classList.toggle('hidden', !locked);
                        }).catch(function () {
                        });
                    }
                } catch (e) {
                }

                try {
                    const relLots = (Array.isArray(cacheLots) ? cacheLots : []).filter(l => String(l?.product_id) === pid);
                    const stock = relLots.reduce((acc, l) => acc + parseNumeroSeguro(l?.qty_available), 0);
                    const status = getStatus(stock, prod?.reorder_point, prod?.min_stock);
                    const statusLabel = (status === 'Cr√≠tico') ? 'üî¥ Cr√≠tico' : (status === 'Reponer') ? 'üü° Atenci√≥n' : 'üü¢ OK';

                    if (fileStock) fileStock.textContent = String(stock.toLocaleString('es-AR', { maximumFractionDigits: 2 }));
                    if (fileMinView) fileMinView.textContent = String(parseNumeroSeguro(prod?.min_stock).toLocaleString('es-AR', { maximumFractionDigits: 2 }));
                    if (fileMin) fileMin.value = String(prod?.min_stock ?? '');
                    if (fileReorderView) fileReorderView.textContent = String(parseNumeroSeguro(prod?.reorder_point).toLocaleString('es-AR', { maximumFractionDigits: 2 }));
                    if (fileReorder) fileReorder.value = String(prod?.reorder_point ?? '');
                    if (fileStatus) fileStatus.textContent = statusLabel;

                    if (fileVStock) fileVStock.textContent = String(stock.toLocaleString('es-AR', { maximumFractionDigits: 2 }));
                    if (fileVMin) fileVMin.textContent = String(parseNumeroSeguro(prod?.min_stock).toLocaleString('es-AR', { maximumFractionDigits: 2 }));
                    if (fileVReorder) fileVReorder.textContent = String(parseNumeroSeguro(prod?.reorder_point).toLocaleString('es-AR', { maximumFractionDigits: 2 }));
                    if (fileVStatus) fileVStatus.textContent = statusLabel;
                } catch (e) {
                }

                renderFileLots(pid);
                refreshFileChart(pid, fileChartDays || 30);
                toggleFileEditMode(false);
                abrirModal(modalFile, true);
                try { document.getElementById('file-scroll')?.scrollTo?.(0, 0); } catch (e) { }
            } catch (e) {
                try { console.error('openProductFile failed', e); } catch (err) { }
                if (window.showAlertModal) window.showAlertModal('No se pudo cargar el legajo. Revis√° la consola para m√°s detalles.', 'Error', 'Legajo');
                else alert('No se pudo cargar el legajo.');
            }
        });

        try {
            if (maybePromise && typeof maybePromise.catch === 'function') {
                maybePromise.catch(function () {
                    if (window.showAlertModal) window.showAlertModal('No se pudo cargar el legajo.', 'Error', 'Operaci√≥n fallida');
                    else alert('No se pudo cargar el legajo.');
                    closeProductFile();
                });
            }
        } catch (e) {
        }
    }

    function saveProductFile() {
        const pid = String(fileProductId || '').trim();
        if (!pid) return;

        const name = String(fileName?.value || '').trim();
        const categoryId = String(fileCat?.value || '').trim();
        const unitBase = String(fileUnit?.value || '').trim();
        const unitOther = String(fileUnitOther?.value || '').trim();
        const unit = (unitBase === 'Otro') ? unitOther : unitBase;
        const desc = String(fileDesc?.value || '').trim();
        const primarySupplierName = String(filePrimarySupplier?.value || '').trim();
        const primarySupplierId = String(filePrimarySupplierId?.value || '').trim();
        const active = !!fileActive?.checked;

        const min = parseNumeroSeguro(fileMin?.value);
        const reorderPoint = parseNumeroSeguro(fileReorder?.value);

        if (!name) { if (window.showAlertModal) window.showAlertModal('Complet√° el nombre del producto.', 'Atenci√≥n', 'Validaci√≥n requerida'); else alert('Complet√° el nombre del producto.'); return; }
        if (!categoryId) { if (window.showAlertModal) window.showAlertModal('Seleccion√° la categor√≠a del producto.', 'Atenci√≥n', 'Validaci√≥n requerida'); else alert('Seleccion√° la categor√≠a del producto.'); return; }
        if (!unit) { if (window.showAlertModal) window.showAlertModal('Complet√° la unidad.', 'Atenci√≥n', 'Validaci√≥n requerida'); else alert('Complet√° la unidad.'); return; }

        const payload = {
            name,
            category_id: parseInt(categoryId, 10),
            unit_name: unit,
            description: desc,
            primary_supplier_id: primarySupplierId,
            primary_supplier_name: primarySupplierName,
            active: active,
            min_stock: min,
            reorder_point: reorderPoint,
        };

        if (fileMethod && !fileMethod.disabled) {
            payload.method = String(fileMethod.value || '').trim() || 'FIFO';
        }

        apiUpdateProduct(pid, payload).then(function (res) {
            if (!res || res.ok !== true) {
                const err = String(res?.error || '').trim();
                const msg = (err === 'method_locked')
                    ? 'La metodolog√≠a no puede modificarse una vez que el producto tiene movimientos.'
                    : 'No se pudo guardar el legajo.';
                if (window.showAlertModal) window.showAlertModal(msg, 'Error', 'Operaci√≥n fallida');
                else alert(msg);
                return;
            }

            const item = res.item;
            if (item && item.id) {
                cacheProducts = (Array.isArray(cacheProducts) ? cacheProducts : []).map(p => (String(p?.id) === String(item.id)) ? item : p);
            }

            const file = (fileImage && fileImage.files && fileImage.files.length) ? fileImage.files[0] : null;
            if (fileImageWasChanged && file) {
                apiUploadProductImage(pid, file).then(function (res2) {
                    const item2 = res2?.item;
                    if (item2 && item2.id) {
                        cacheProducts = (Array.isArray(cacheProducts) ? cacheProducts : []).map(p => (String(p?.id) === String(item2.id)) ? item2 : p);
                    }
                    fileImageWasChanged = false;
                    if (fileImage) fileImage.value = '';
                    renderAll();
                    openProductFile(pid);
                }).catch(function () {
                    fileImageWasChanged = false;
                    if (fileImage) fileImage.value = '';
                    renderAll();
                    openProductFile(pid);
                });
                return;
            }

            renderAll();
            openProductFile(pid);
        }).catch(function () {
            if (window.showAlertModal) window.showAlertModal('No se pudo guardar el legajo.', 'Error', 'Operaci√≥n fallida');
            else alert('No se pudo guardar el legajo.');
        });
    }

    function clearProductForm() {
        if (prodName) prodName.value = '';
        if (prodCatId) prodCatId.value = '';
        if (prodUnit) prodUnit.value = 'Unidad';
        if (prodUnitOther) prodUnitOther.value = '';
        if (wrapProdUnit) wrapProdUnit.classList.add('hidden');
        if (prodActive) prodActive.checked = true;
        if (prodPrimarySupplier) prodPrimarySupplier.value = '';
        if (prodPrimarySupplierId) prodPrimarySupplierId.value = '';
        if (prodReorder) prodReorder.value = '';
        if (prodLots) prodLots.checked = true;
        syncProductToggleLabels();
        if (prodMethod) prodMethod.value = 'FIFO';
        if (prodMethod) {
            prodMethod.disabled = false;
            prodMethod.classList.remove('bg-gray-50');
        }
        if (prodMethodLockMsg) prodMethodLockMsg.classList.add('hidden');
        if (prodMin) prodMin.value = '';
        if (prodDesc) prodDesc.value = '';
        if (prodImage) prodImage.value = '';
        if (prodImagePreview) {
            prodImagePreview.src = '';
            prodImagePreview.classList.add('hidden');
        }
        if (prodImagePlaceholder) prodImagePlaceholder.classList.remove('hidden');
    }

    function resetCreateModal() {
        editingProductId = '';
        clearProductForm();
        if (choiceWrap) choiceWrap.classList.remove('hidden');
        if (formProduct) formProduct.classList.add('hidden');
        if (formLot) formLot.classList.add('hidden');
        try { if (formProduct) formProduct.style.display = ''; } catch (e) { }
        try { if (formLot) formLot.style.display = ''; } catch (e) { }
    }

    function openEditProduct(productId) {
        const pid = String(productId || '').trim();
        if (!pid) return;
        const prod = (Array.isArray(cacheProducts) ? cacheProducts : []).find(p => String(p?.id || '') === pid);
        if (!prod) return;

        editingProductId = pid;
        resetCreateModal();
        abrirModal(modalCreate, true);
        try { if (createInvScroll) createInvScroll.scrollTop = 0; } catch (e) { }
        if (createInvTitle) createInvTitle.textContent = 'Editar producto';
        if (createInvSubtitle) createInvSubtitle.textContent = '';
        if (choiceWrap) choiceWrap.classList.add('hidden');
        if (formProduct) formProduct.classList.remove('hidden');
        try { if (formLot) formLot.style.display = ''; } catch (e) { }

        if (prodName) prodName.value = String(prod?.name || '');
        if (prodCatId) prodCatId.value = String(prod?.category_id || prod?.category?.id || '');
        const unitName = String(prod?.unit_name || prod?.unit || 'Unidad').trim() || 'Unidad';
        if (prodUnit) {
            const known = ['Unidad', 'Kg', 'L', 'Otro'];
            if (known.includes(unitName)) {
                prodUnit.value = unitName;
                if (wrapProdUnit) wrapProdUnit.classList.toggle('hidden', unitName !== 'Otro');
                if (prodUnitOther && unitName !== 'Otro') prodUnitOther.value = '';
            } else {
                prodUnit.value = 'Otro';
                if (wrapProdUnit) wrapProdUnit.classList.remove('hidden');
                if (prodUnitOther) prodUnitOther.value = unitName;
            }
        }
        if (prodLots) prodLots.checked = !!prod?.uses_lots;
        if (prodMethod) prodMethod.value = String(prod?.method || 'FIFO');
        if (prodMin) prodMin.value = String(prod?.min_stock ?? '');
        if (prodReorder) prodReorder.value = String(prod?.reorder_point ?? '');
        if (prodPrimarySupplierId) prodPrimarySupplierId.value = String(prod?.primary_supplier_id || '').trim();
        if (prodPrimarySupplier) prodPrimarySupplier.value = String(prod?.primary_supplier_name || '');
        if (prodActive) prodActive.checked = (prod?.active !== false);
        if (prodDesc) prodDesc.value = String(prod?.description || '');
        syncProductToggleLabels();

        const imgUrl = String(prod?.image_url || '').trim();
        if (imgUrl && prodImagePreview) {
            prodImagePreview.src = imgUrl;
            prodImagePreview.classList.remove('hidden');
            if (prodImagePlaceholder) prodImagePlaceholder.classList.add('hidden');
        } else {
            if (prodImagePreview) {
                prodImagePreview.src = '';
                prodImagePreview.classList.add('hidden');
            }
            if (prodImagePlaceholder) prodImagePlaceholder.classList.remove('hidden');
        }

        if (!didLoadCategories) {
            didLoadCategories = true;
            loadCategories(function () {
                refreshCategorySelect(String(prod?.category_id || prod?.category?.id || ''));
            });
        } else {
            refreshCategorySelect(String(prod?.category_id || prod?.category?.id || ''));
        }

        if (prodMethod) {
            apiGetMethodLock(pid).then(function (res) {
                const locked = !!(res && res.ok && res.locked);
                prodMethod.disabled = locked;
                prodMethod.classList.toggle('bg-gray-50', locked);
                if (prodMethodLockMsg) prodMethodLockMsg.classList.toggle('hidden', !locked);
            }).catch(function () {
            });
        }
    }

    function openCreate() {
        resetCreateModal();
        abrirModal(modalCreate, true);
        try { if (createInvScroll) createInvScroll.scrollTop = 0; } catch (e) { }
        if (createInvTitle) createInvTitle.textContent = 'Crear √≠tem';
        if (createInvSubtitle) createInvSubtitle.textContent = '';
        if (choiceWrap) choiceWrap.classList.add('hidden');
        if (formProduct) formProduct.classList.remove('hidden');
        try { if (formLot) formLot.style.display = ''; } catch (e) { }
        if (!didLoadCategories) {
            didLoadCategories = true;
            loadCategories(function () {
                refreshCategorySelect('');
            });
        } else {
            refreshCategorySelect('');
        }
    }

    function closeCreate() {
        abrirModal(modalCreate, false);
    }

    function openExport() {
        abrirModal(modalExport, true);
    }

    function closeExport() {
        abrirModal(modalExport, false);
    }

    function switchTab(tab) {
        activeTab = tab;
        if (panelCurrent) panelCurrent.classList.toggle('hidden', tab !== 'current');
        if (panelLots) panelLots.classList.toggle('hidden', tab !== 'lots');
        if (tabCurrent) tabCurrent.classList.toggle('bg-white', tab === 'current');
        if (tabCurrent) tabCurrent.classList.toggle('shadow-sm', tab === 'current');
        if (tabCurrent) tabCurrent.classList.toggle('text-gray-900', tab === 'current');
        if (tabLots) tabLots.classList.toggle('bg-white', tab === 'lots');
        if (tabLots) tabLots.classList.toggle('shadow-sm', tab === 'lots');
        if (tabLots) tabLots.classList.toggle('text-gray-900', tab === 'lots');
        if (tabLots) tabLots.classList.toggle('text-gray-600', tab !== 'lots');
        if (tabCurrent) tabCurrent.classList.toggle('text-gray-600', tab !== 'current');
        renderAll();
    }

    function getVisibleRowsData() {
        const products = Array.isArray(cacheProducts) ? cacheProducts : [];
        const lots = Array.isArray(cacheLots) ? cacheLots : [];
        const q = String(filterQ?.value || '').trim().toLowerCase();
        const lotsSupQ = String(filterLotsSup?.value || '').trim().toLowerCase();
        const cat = String(filterCat?.value || '').trim();
        const stList = (filterStatus && filterStatus.selectedOptions)
            ? Array.from(filterStatus.selectedOptions).map(o => String(o.value || '').trim()).filter(Boolean)
            : [];

        const compute = (p) => {
            const rel = lots.filter(l => String(l.product_id) === String(p.id));
            const stock = rel.reduce((acc, l) => acc + parseNumeroSeguro(l.qty_available), 0);
            const costSum = rel.reduce((acc, l) => acc + (parseNumeroSeguro(l.qty_available) * parseNumeroSeguro(l.unit_cost)), 0);
            const avg = stock > 0 ? (costSum / stock) : 0;
            const status = getStatus(stock, p.reorder_point, p.min_stock);
            return { stock, avg, total: stock * avg, status };
        };

        const filteredProducts = products
            .filter(p => {
                if (q && !String(p.name || '').toLowerCase().includes(q)) return false;
                if (cat && categoryLabel(p) !== cat) return false;
                const metrics = compute(p);
                if (stList.length && stList.indexOf(metrics.status) < 0) return false;
                return true;
            })
            .map(p => ({ p, m: compute(p) }));

        const filteredLots = lots
            .filter(l => {
                const p = products.find(x => String(x.id) === String(l.product_id));
                if (!p) return false;
                if (q && !String(p.name || '').toLowerCase().includes(q)) return false;
                if (lotsSupQ && !String(l?.supplier_name || '').toLowerCase().includes(lotsSupQ)) return false;
                return true;
            })
            .map(l => {
                const p = products.find(x => String(x.id) === String(l.product_id));
                return { l, p };
            });

        return { filteredProducts, filteredLots, products, lots };
    }

    function updateFilterOptions(products, lots) {
        if (filterCat) {
            const current = filterCat.value;
            const cats = Array.from(new Set(products.map(p => String(categoryLabel(p) || '').trim()).filter(Boolean))).sort();
            filterCat.innerHTML = '<option value="">Todas</option>';
            cats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                filterCat.appendChild(opt);
            });
            filterCat.value = current;
        }
    }

    function renderKPIs(products, lots) {
        const days30 = 30 * 24 * 60 * 60 * 1000;
        const now = Date.now();
        const expSoon = lots.filter(l => {
            const exp = String(l.expiration_date || '').trim();
            if (!exp) return false;
            const t = new Date(exp).getTime();
            if (!t) return false;
            return t >= now && t <= (now + days30) && parseNumeroSeguro(l.qty_available) > 0;
        });
        const expSoonCount = expSoon.length;

        let totalValue = 0;
        let alerts = 0;
        const alertProducts = [];
        products.forEach(p => {
            const rel = lots.filter(l => String(l.product_id) === String(p.id));
            const stock = rel.reduce((acc, l) => acc + parseNumeroSeguro(l.qty_available), 0);
            const costSum = rel.reduce((acc, l) => acc + (parseNumeroSeguro(l.qty_available) * parseNumeroSeguro(l.unit_cost)), 0);
            const avg = stock > 0 ? (costSum / stock) : 0;
            totalValue += stock * avg;
            const st = getStatus(stock, p.reorder_point, p.min_stock);
            if (st !== 'OK') {
                alerts += 1;
                alertProducts.push({ name: String(p?.name || 'Producto'), status: st });
            }
        });
        alerts += expSoonCount;

        alertProducts.sort(function (a, b) {
            const rank = function (s) {
                if (s === 'Cr√≠tico') return 0;
                if (s === 'Reponer') return 1;
                return 2;
            };
            return rank(a.status) - rank(b.status) || String(a.name).localeCompare(String(b.name));
        });

        if (kpiStockValue) kpiStockValue.textContent = formatMoney(totalValue);
        if (kpiProducts) kpiProducts.textContent = String(products.length);
        if (kpiExpire) kpiExpire.textContent = String(expSoonCount);
        if (kpiAlerts) kpiAlerts.textContent = String(alerts);

        if (kpiAlertsList) {
            const maxItems = 6;
            const shown = alertProducts.slice(0, maxItems);
            if (!shown.length) {
                kpiAlertsList.innerHTML = '<div class="text-sm text-gray-500">Sin alertas de stock.</div>';
            } else {
                const first = shown[0];
                const rest = shown.slice(1);
                const firstTag = (first.status === 'Cr√≠tico') ? 'Cr√≠tico' : (first.status === 'Reponer') ? 'Reponer' : 'OK';
                const firstCls = (first.status === 'Cr√≠tico') ? 'text-red-700' : (first.status === 'Reponer') ? 'text-indigo-700' : 'text-gray-700';
                const firstRow = '<div class="flex items-center justify-between gap-2">'
                    + '<div class="truncate text-sm font-semibold text-gray-900">' + String(first.name) + '</div>'
                    + '<span class="shrink-0 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold ' + (first.status === 'Cr√≠tico' ? 'bg-red-50 text-red-700' : first.status === 'Reponer' ? 'bg-indigo-50 text-indigo-700' : 'bg-green-50 text-green-700') + '">' + firstTag + '</span>'
                    + '</div>';

                const restRows = rest.map(it => {
                    const tag = (it.status === 'Cr√≠tico') ? 'Cr√≠tico' : (it.status === 'Reponer') ? 'Reponer' : 'OK';
                    const pill = (it.status === 'Cr√≠tico')
                        ? 'bg-red-50 text-red-700'
                        : (it.status === 'Reponer')
                            ? 'bg-indigo-50 text-indigo-700'
                            : 'bg-green-50 text-green-700';
                    return '<div class="flex items-center justify-between gap-2">'
                        + '<div class="truncate text-[11px] text-gray-700">' + String(it.name) + '</div>'
                        + '<span class="shrink-0 inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold ' + pill + '">' + tag + '</span>'
                        + '</div>';
                }).join('');

                kpiAlertsList.innerHTML = firstRow + (restRows ? ('<div class="mt-2 space-y-1">' + restRows + '</div>') : '');
            }
            if (kpiAlertsHint) kpiAlertsHint.classList.toggle('hidden', shown.length > 0);
        }
    }

    function renderCurrent(filteredProducts) {
        if (!tbodyCurrent) return;
        if (!filteredProducts.length) {
            tbodyCurrent.innerHTML = '<tr><td colspan="10" class="px-4 py-6 text-sm text-center text-gray-500">No hay resultados para los filtros actuales.</td></tr>';
            return;
        }
        tbodyCurrent.innerHTML = '';
        filteredProducts.forEach(({ p, m }) => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            const imgUrl = String(p?.image_url || '').trim();
            const imgCell = imgUrl
                ? ('<img src="' + imgUrl + '" alt="" class="h-9 w-9 rounded-md object-cover border border-gray-200 bg-gray-50">')
                : ('<div class="h-9 w-9 rounded-md border border-gray-200 bg-gray-50 flex items-center justify-center text-gray-400"><i class="fas fa-image"></i></div>');
            const desc = String(p?.description || '').trim();

            tr.innerHTML = ''
                + '<td class="px-4 py-3">' + imgCell + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-900"><div class="font-medium">' + String(p.name || '') + '</div></td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + String(categoryLabel(p) || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-500">' + String(m.stock.toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + String(p.unit_name || p.unit || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-500">' + formatMoney(m.avg) + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-500">' + formatMoney(m.total) + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500"><div class="max-w-xs truncate">' + (desc || '‚Äî') + '</div></td>'
                + '<td class="px-4 py-3 text-sm text-center">' + badgeStatus(m.status) + '</td>'
                + '<td class="px-4 py-3 text-sm text-right">'
                + '  <div class="relative inline-flex">'
                + '    <button type="button" class="btn-actions-toggle h-8 w-8 inline-flex items-center justify-center rounded-md hover:bg-gray-100 text-gray-500" aria-label="Acciones" data-product-id="' + String(p.id) + '">' 
                + '      <i class="fas fa-ellipsis-v"></i>'
                + '    </button>'
                + '    <div class="row-actions-menu hidden absolute right-0 mt-2 w-40 rounded-md border border-gray-200 bg-white shadow-lg z-20">'
                + '      <button type="button" class="btn-view-file w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50" data-product-id="' + String(p.id) + '">Ver legajo</button>'
                + '      <button type="button" class="btn-deactivate-product w-full text-left px-3 py-2 text-xs text-red-600 hover:bg-gray-50" data-product-id="' + String(p.id) + '">Desactivar</button>'
                + '    </div>'
                + '  </div>'
                + '</td>';

            tbodyCurrent.appendChild(tr);
        });

        const closeAllMenus = function () {
            Array.from(tbodyCurrent.querySelectorAll('.row-actions-menu')).forEach(function (m) {
                m.classList.add('hidden');
            });
        };

        Array.from(tbodyCurrent.querySelectorAll('.btn-actions-toggle')).forEach(btn => {
            btn.addEventListener('click', function (ev) {
                ev.preventDefault();
                ev.stopPropagation();
                const wrap = this.closest('td');
                if (!wrap) return;
                const menu = wrap.querySelector('.row-actions-menu');
                if (!menu) return;
                const willOpen = menu.classList.contains('hidden');
                closeAllMenus();
                menu.classList.toggle('hidden', !willOpen);
            });
        });

        document.addEventListener('click', closeAllMenus, { once: true });

        Array.from(tbodyCurrent.querySelectorAll('.btn-view-file')).forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.getAttribute('data-product-id') || '';
                closeAllMenus();
                openProductFile(id);
            });
        });

        Array.from(tbodyCurrent.querySelectorAll('.btn-deactivate-product')).forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.getAttribute('data-product-id') || '';
                if (!id) return;
                closeAllMenus();
                const confirmFn = (window.confirmModal && typeof window.confirmModal === 'function')
                    ? window.confirmModal
                    : function (m) { return Promise.resolve(window.confirm(m)); };
                confirmFn('¬øSeguro que quer√©s desactivar este producto?', 'Desactivar producto', 'Este producto tiene historial. Ser√° desactivado.', { okText: 'Desactivar', cancelText: 'Cancelar' })
                    .then(function (ok) {
                        if (!ok) return;
                        apiDeleteProduct(id).then(function (res) {
                            if (!res || res.ok !== true) {
                                if (window.showAlertModal) window.showAlertModal('No se pudo desactivar el producto.', 'Error', 'Operaci√≥n fallida');
                                else alert('No se pudo desactivar el producto.');
                                return;
                            }
                            renderAll();
                        }).catch(function () {
                            if (window.showAlertModal) window.showAlertModal('No se pudo desactivar el producto.', 'Error', 'Operaci√≥n fallida');
                            else alert('No se pudo desactivar el producto.');
                        });
                    });
            });
        });
    }

    function renderLots(filteredLots) {
        if (!tbodyLots) return;
        if (!filteredLots.length) {
            tbodyLots.innerHTML = '<tr><td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">No hay resultados para los filtros actuales.</td></tr>';
            return;
        }
        tbodyLots.innerHTML = '';
        filteredLots.forEach(({ l, p }) => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            const imgUrl = String(p?.image_url || '').trim();
            const imgCell = imgUrl
                ? ('<img src="' + imgUrl + '" alt="" class="h-9 w-9 rounded-md object-cover border border-gray-200 bg-gray-50">')
                : ('<div class="h-9 w-9 rounded-md border border-gray-200 bg-gray-50 flex items-center justify-center text-gray-400"><i class="fas fa-image"></i></div>');
            const desc = String(p?.description || '').trim();
            tr.innerHTML = ''
                + '<td class="px-4 py-3">' + imgCell + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-900">' + String(p?.name || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500"><div class="max-w-xs truncate">' + (desc || '‚Äî') + '</div></td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + fmtFecha(l.received_at || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-500">' + String(parseNumeroSeguro(l.qty_initial).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-500">' + formatMoney(parseNumeroSeguro(l.unit_cost)) + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + String(l.supplier_name || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + (l.expiration_date ? fmtFecha(l.expiration_date) : '‚Äî') + '</td>'
                + '<td class="px-4 py-3 text-sm text-right">'
                + '  <div class="relative inline-flex">'
                + '    <button type="button" class="btn-lot-actions-toggle h-8 w-8 inline-flex items-center justify-center rounded-md hover:bg-gray-100 text-gray-500" aria-label="Acciones" data-lot-id="' + String(l.id) + '" data-product-id="' + String(p?.id || '') + '">' 
                + '      <i class="fas fa-ellipsis-v"></i>'
                + '    </button>'
                + '    <div class="lot-actions-menu hidden absolute right-0 mt-2 w-44 rounded-md border border-gray-200 bg-white shadow-lg z-20">'
                + '      <button type="button" class="btn-lot-edit w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50" data-lot-id="' + String(l.id) + '">Editar lote</button>'
                + '      <button type="button" class="btn-lot-go-file w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50" data-product-id="' + String(p?.id || '') + '">Ir al legajo</button>'
                + '      <button type="button" class="btn-lot-delete w-full text-left px-3 py-2 text-xs text-red-600 hover:bg-gray-50" data-lot-id="' + String(l.id) + '">Eliminar lote</button>'
                + '    </div>'
                + '  </div>'
                + '</td>';
            tbodyLots.appendChild(tr);
        });

        const closeAllLotMenus = function () {
            Array.from(tbodyLots.querySelectorAll('.lot-actions-menu')).forEach(function (m) {
                m.classList.add('hidden');
            });
        };

        Array.from(tbodyLots.querySelectorAll('.btn-lot-actions-toggle')).forEach(btn => {
            btn.addEventListener('click', function (ev) {
                ev.preventDefault();
                ev.stopPropagation();
                const wrap = this.closest('td');
                if (!wrap) return;
                const menu = wrap.querySelector('.lot-actions-menu');
                if (!menu) return;
                const willOpen = menu.classList.contains('hidden');
                closeAllLotMenus();
                menu.classList.toggle('hidden', !willOpen);
            });
        });

        document.addEventListener('click', closeAllLotMenus, { once: true });

        Array.from(tbodyLots.querySelectorAll('.btn-lot-edit')).forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.getAttribute('data-lot-id') || '';
                closeAllLotMenus();
                openEditLot(id);
            });
        });

        Array.from(tbodyLots.querySelectorAll('.btn-lot-go-file')).forEach(btn => {
            btn.addEventListener('click', function () {
                const pid = this.getAttribute('data-product-id') || '';
                if (!pid) return;
                closeAllLotMenus();
                openProductFile(pid);
            });
        });

        Array.from(tbodyLots.querySelectorAll('.btn-lot-delete')).forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.getAttribute('data-lot-id') || '';
                if (!id) return;
                closeAllLotMenus();

                const confirmFn = (window.confirmModal && typeof window.confirmModal === 'function')
                    ? window.confirmModal
                    : function (m) { return Promise.resolve(window.confirm(m)); };

                confirmFn('¬øSeguro que quer√©s eliminar este lote?', 'Eliminar lote', 'Esta acci√≥n no se puede deshacer.', { okText: 'Eliminar', cancelText: 'Cancelar' })
                    .then(function (ok) {
                        if (!ok) return;
                        apiDeleteLot(id).then(function (res) {
                            if (!res || res.ok !== true) {
                                const err = String(res?.error || '').trim();
                                const msg = (err === 'lot_has_sales')
                                    ? 'No se puede eliminar: el lote ya tiene consumos registrados.'
                                    : 'No se pudo eliminar el lote.';
                                if (window.showAlertModal) window.showAlertModal(msg, 'Error', 'Operaci√≥n fallida');
                                else alert(msg);
                                return;
                            }
                            cacheLots = (Array.isArray(cacheLots) ? cacheLots : []).filter(l => String(l?.id || '') !== String(id));
                            renderAll();
                        }).catch(function () {
                            if (window.showAlertModal) window.showAlertModal('No se pudo eliminar el lote.', 'Error', 'Operaci√≥n fallida');
                            else alert('No se pudo eliminar el lote.');
                        });
                    });
            });
        });
    }

    function openEditLot(lotId) {
        const id = String(lotId || '').trim();
        if (!id || !modalEditLot) return;
        const lot = (Array.isArray(cacheLots) ? cacheLots : []).find(l => String(l?.id || '') === id);
        if (!lot) return;
        const prod = (Array.isArray(cacheProducts) ? cacheProducts : []).find(p => String(p?.id || '') === String(lot?.product_id || ''));

        editingLotId = id;
        if (editLotSubtitle) editLotSubtitle.textContent = String(prod?.name || lot?.product_name || '');
        if (editLotProduct) editLotProduct.textContent = String(prod?.name || lot?.product_name || '');
        if (editLotQty) editLotQty.value = String(parseNumeroSeguro(lot?.qty_initial) || '');
        if (editLotCu) editLotCu.value = String(parseNumeroSeguro(lot?.unit_cost) || '');

        if (editLotCode) editLotCode.value = String(lot?.lot_code || '');
        if (editLotDate) editLotDate.value = String(lot?.received_at || '').slice(0, 10);
        if (editLotExp) editLotExp.value = String(lot?.expiration_date || '').slice(0, 10);

        if (editLotSupplier) editLotSupplier.value = String(lot?.supplier_name || '');
        if (editLotSupplierId) editLotSupplierId.value = String(lot?.supplier_id || '');
        if (editLotNote) editLotNote.value = String(lot?.note || '');
        if (editLotMsg) editLotMsg.textContent = '';

        abrirModal(modalEditLot, true);
    }

    function closeEditLot() {
        editingLotId = '';
        if (editLotMsg) editLotMsg.textContent = '';
        abrirModal(modalEditLot, false);
    }

    function saveEditLot() {
        const id = String(editingLotId || '').trim();
        if (!id) return;

        const qtyInitial = parseNumeroSeguro(editLotQty?.value);
        const unitCost = parseNumeroSeguro(editLotCu?.value);

        const payload = {
            lot_code: String(editLotCode?.value || '').trim(),
            date: String(editLotDate?.value || '').trim(),
            expiration_date: String(editLotExp?.value || '').trim(),
            supplier_id: String(editLotSupplierId?.value || '').trim(),
            supplier_name: String(editLotSupplier?.value || '').trim(),
            note: String(editLotNote?.value || '').trim(),
            qty_initial: qtyInitial,
            unit_cost: unitCost,
        };

        if (!payload.date) {
            if (editLotMsg) editLotMsg.textContent = 'Complet√° la fecha de ingreso.';
            return;
        }
        if (!payload.supplier_name) {
            if (editLotMsg) editLotMsg.textContent = 'Complet√° el proveedor.';
            return;
        }

        if (!(payload.qty_initial > 0)) {
            if (editLotMsg) editLotMsg.textContent = 'La cantidad debe ser mayor a 0.';
            return;
        }
        if (!(payload.unit_cost >= 0)) {
            if (editLotMsg) editLotMsg.textContent = 'El costo unitario no puede ser negativo.';
            return;
        }

        if (editLotMsg) editLotMsg.textContent = 'Guardando‚Ä¶';
        apiUpdateLot(id, payload).then(function (res) {
            if (!res || res.ok !== true) {
                const err = String(res?.error || '').trim();
                const msg = (err === 'supplier_not_found')
                    ? 'Proveedor inv√°lido.'
                    : (err === 'lot_has_sales')
                        ? 'No se puede cambiar cantidad/costo porque el lote ya tiene consumos registrados.'
                        : (err === 'qty_required')
                            ? 'La cantidad debe ser mayor a 0.'
                            : (err === 'unit_cost_invalid')
                                ? 'El costo unitario no puede ser negativo.'
                                : 'No se pudo guardar el lote.';
                if (editLotMsg) editLotMsg.textContent = msg;
                return;
            }
            const item = res.item;
            if (item && item.id) {
                cacheLots = (Array.isArray(cacheLots) ? cacheLots : []).map(l => (String(l?.id) === String(item.id)) ? item : l);
            }
            closeEditLot();
            renderAll();
        }).catch(function () {
            if (editLotMsg) editLotMsg.textContent = 'No se pudo guardar el lote.';
        });
    }

    function renderAll() {
        if (!didLoadCategories) {
            didLoadCategories = true;
            loadCategories(function () {
                refreshCategorySelect(prodCatId?.value || '');
            });
        }
        loadProductsLots(function (products, lots, movements) {
            updateFilterOptions(products, lots);
            renderKPIs(products, lots);
            const vis = getVisibleRowsData();
            if (activeTab === 'current') renderCurrent(vis.filteredProducts);
            if (activeTab === 'lots') renderLots(vis.filteredLots);
        });
    }

    function poblarProductosSelect() {
        if (!lotProduct) return;
        const products = Array.isArray(cacheProducts) ? cacheProducts : [];
        const current = lotProduct.value;
        lotProduct.innerHTML = '<option value="">‚Äî Seleccionar ‚Äî</option>';
        products.forEach(p => {
            const opt = document.createElement('option');
            opt.value = String(p.id);
            opt.textContent = String(p.name || 'Producto');
            lotProduct.appendChild(opt);
        });
        lotProduct.value = current;
    }

    function updateLotCt() {
        const cu = parseNumeroSeguro(lotCu?.value);
        const qty = parseNumeroSeguro(lotQty?.value);
        const ct = cu * qty;
        if (lotCt) lotCt.value = formatMoney(ct);
    }

    function crearEgresoDesdeInventario({ fecha, proveedor, valor, nota }) {
        try {
            if (window.StorageService && typeof window.StorageService.addExpenseFromInventory === 'function') {
                const res = window.StorageService.addExpenseFromInventory({
                    id: String(Date.now()),
                    fecha: String(fecha || ''),
                    categoria: 'Inventario',
                    valor: parseNumeroSeguro(valor),
                    nota: String(nota || ''),
                    forma_pago: 'Transferencia',
                    tipo_gasto: 'Variable',
                    frecuencia: '√önico',
                    comprobante: [],
                    custom_fields: [],
                    proveedor: String(proveedor || ''),
                    supplier_id: '',
                    supplier_name: String(proveedor || '')
                });
                try {
                    if (res && typeof res.then === 'function') res.catch(function () { });
                } catch (e) {
                }
                return res;
            }
        } catch (e) {
            // noop
        }
        return null;
    }

    function pctChange(oldPrice, newPrice) {
        const oldv = parseNumeroSeguro(oldPrice);
        const newv = parseNumeroSeguro(newPrice);
        if (!(oldv > 0) || !isFinite(oldv)) return '';
        const pct = ((newv - oldv) / oldv) * 100;
        if (!isFinite(pct)) return '';
        return pct.toFixed(2);
    }

    function updatePreciosCats(products) {
        if (!preciosCat) return;
        const current = String(preciosCat.value || '').trim();
        const cats = Array.from(new Set((Array.isArray(products) ? products : []).map(p => String(p?.category?.name || p?.category || '').trim()).filter(Boolean))).sort();
        preciosCat.innerHTML = '<option value="">Todas</option>';
        cats.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            preciosCat.appendChild(opt);
        });
        preciosCat.value = current;
    }

    function renderPreciosTable() {
        if (!preciosTbody) return;
        const products = Array.isArray(cacheProducts) ? cacheProducts.slice() : [];
        products.sort((a, b) => String(a?.name || '').localeCompare(String(b?.name || '')));
        updatePreciosCats(products);

        const q = String(preciosQ?.value || '').trim().toLowerCase();
        const cat = String(preciosCat?.value || '').trim();
        const visible = products.filter(p => {
            if (q && !String(p?.name || '').toLowerCase().includes(q)) return false;
            if (cat && String(p?.category?.name || p?.category || '') !== cat) return false;
            return true;
        });

        if (!visible.length) {
            preciosTbody.innerHTML = '<tr><td colspan="5" class="px-4 py-6 text-sm text-center text-gray-500">No hay productos para los filtros actuales.</td></tr>';
            return;
        }

        preciosTbody.innerHTML = '';
        visible.forEach(p => {
            const oldP = parseNumeroSeguro(p?.sale_price);
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.setAttribute('data-product-id', String(p?.id || ''));
            tr.setAttribute('data-old-price', String(oldP));
            tr.innerHTML = ''
                + '<td class="px-4 py-3 text-sm text-gray-900">' + String(p?.name || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + String(p?.category?.name || p?.category || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-500">' + formatMoney(oldP) + '</td>'
                + '<td class="px-4 py-3 text-sm text-right">'
                +   '<input type="number" step="0.01" min="0" class="w-32 px-2 py-1 border rounded-md text-right text-sm input-new-price" value="' + String(oldP.toFixed(2)) + '">'
                + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-600">'
                +   '<span class="pct-cell">' + (oldP > 0 ? '0.00' : '') + '</span>'
                + '</td>';
            preciosTbody.appendChild(tr);

            const input = tr.querySelector('.input-new-price');
            const pctEl = tr.querySelector('.pct-cell');
            const recalc = function () {
                const nv = parseNumeroSeguro(input?.value);
                const pct = pctChange(oldP, nv);
                if (pctEl) pctEl.textContent = pct;
            };
            if (input) input.addEventListener('input', recalc);
            recalc();
        });
    }

    function exportCsv() {
        const { filteredProducts, filteredLots } = getVisibleRowsData();
        let rows = [];
        if (activeTab === 'current') {
            rows.push(['Producto','Categor√≠a','Stock','Unidad','Costo prom.','Valor total','Estado']);
            filteredProducts.forEach(({ p, m }) => {
                rows.push([
                    String(p.name || ''),
                    String(p?.category?.name || p?.category || ''),
                    String(m.stock),
                    String(p.unit_name || p.unit || ''),
                    String(m.avg),
                    String(m.total),
                    String(m.status)
                ]);
            });
        } else {
            rows.push(['Producto','Lote','Ingreso','Proveedor','CU','Disponible','CT','Vencimiento']);
            filteredLots.forEach(({ l, p }) => {
                const ct = parseNumeroSeguro(l.qty_available) * parseNumeroSeguro(l.unit_cost);
                rows.push([
                    String(p?.name || ''),
                    String(l.lot_code || ''),
                    String(fmtFecha(l.received_at || '')),
                    String(l.supplier_name || ''),
                    String(parseNumeroSeguro(l.unit_cost)),
                    String(parseNumeroSeguro(l.qty_available)),
                    String(ct),
                    String(fmtFecha(l.expiration_date || ''))
                ]);
            });
        }
        const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (activeTab === 'current' ? 'inventario_stock_actual.csv' : 'inventario_lotes.csv');
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    function exportPdfPrint() {
        const { filteredProducts, filteredLots } = getVisibleRowsData();
        const title = (activeTab === 'current') ? 'Inventario - Stock actual' : 'Inventario - Stock total (lotes)';
        let head = '';
        let body = '';
        if (activeTab === 'current') {
            head = '<tr>'
                + '<th>Producto</th><th>Categor√≠a</th><th style="text-align:right">Stock</th><th>Unidad</th><th style="text-align:right">Costo prom.</th><th style="text-align:right">Valor total</th><th>Estado</th>'
                + '</tr>';
            filteredProducts.forEach(({ p, m }) => {
                body += '<tr>'
                    + '<td>' + String(p.name || '') + '</td>'
                    + '<td>' + String(p?.category?.name || p?.category || '') + '</td>'
                    + '<td style="text-align:right">' + String(m.stock.toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</td>'
                    + '<td>' + String(p.unit_name || p.unit || '') + '</td>'
                    + '<td style="text-align:right">' + formatMoney(m.avg) + '</td>'
                    + '<td style="text-align:right">' + formatMoney(m.total) + '</td>'
                    + '<td>' + String(m.status) + '</td>'
                    + '</tr>';
            });
        } else {
            head = '<tr>'
                + '<th>Producto</th><th>Lote</th><th>Ingreso</th><th>Proveedor</th><th style="text-align:right">CU</th><th style="text-align:right">Disponible</th><th style="text-align:right">CT</th><th>Vencimiento</th>'
                + '</tr>';
            filteredLots.forEach(({ l, p }) => {
                const ct = parseNumeroSeguro(l.qty_available) * parseNumeroSeguro(l.unit_cost);
                body += '<tr>'
                    + '<td>' + String(p?.name || '') + '</td>'
                    + '<td>' + String(l.lot_code || '') + '</td>'
                    + '<td>' + String(fmtFecha(l.received_at || '')) + '</td>'
                    + '<td>' + String(l.supplier_name || '') + '</td>'
                    + '<td style="text-align:right">' + formatMoney(parseNumeroSeguro(l.unit_cost)) + '</td>'
                    + '<td style="text-align:right">' + String(parseNumeroSeguro(l.qty_available).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</td>'
                    + '<td style="text-align:right">' + formatMoney(ct) + '</td>'
                    + '<td>' + (l.expiration_date ? String(fmtFecha(l.expiration_date)) : '‚Äî') + '</td>'
                    + '</tr>';
            });
        }

        const html = ''
            + '<html><head><title>' + title + '</title>'
            + '<style>'
            + 'body{font-family:Arial, sans-serif; padding:18px; color:#111827;}'
            + 'h1{font-size:16px;margin:0 0 10px 0;}'
            + 'table{width:100%; border-collapse:collapse; font-size:12px;}'
            + 'th,td{border:1px solid #e5e7eb; padding:8px;}'
            + 'th{background:#f9fafb; text-align:left;}'
            + '</style></head><body>'
            + '<h1>' + title + '</h1>'
            + '<table><thead>' + head + '</thead><tbody>' + body + '</tbody></table>'
            + '<script>window.onload=function(){window.print();};<\/script>'
            + '</body></html>';
        const w = window.open('', '_blank');
        if (!w) return;
        w.document.open();
        w.document.write(html);
        w.document.close();
    }

    if (btnCreate) btnCreate.addEventListener('click', openCreate);
    if (btnCloseCreate) btnCloseCreate.addEventListener('click', closeCreate);

    if (btnAddLot) btnAddLot.addEventListener('click', openAddLot);
    if (btnPrecios) btnPrecios.addEventListener('click', openPrecios);
    if (btnClosePrecios) btnClosePrecios.addEventListener('click', closePrecios);
    if (btnCancelPrecios) btnCancelPrecios.addEventListener('click', closePrecios);
    if (preciosQ) preciosQ.addEventListener('input', renderPreciosTable);
    if (preciosCat) preciosCat.addEventListener('change', renderPreciosTable);
    if (btnSavePrecios) {
        btnSavePrecios.addEventListener('click', function () {
            const rows = Array.from(preciosTbody ? preciosTbody.querySelectorAll('tr[data-product-id]') : []);
            const changes = [];
            rows.forEach(tr => {
                const id = tr.getAttribute('data-product-id');
                const oldP = parseNumeroSeguro(tr.getAttribute('data-old-price'));
                const input = tr.querySelector('.input-new-price');
                const newP = parseNumeroSeguro(input?.value);
                if (!id) return;
                if (!isFinite(newP) || newP < 0) return;
                if (Math.abs(newP - oldP) < 0.00001) return;
                changes.push({ id: parseInt(id, 10), sale_price: newP });
            });
            if (!changes.length) {
                if (preciosMsg) preciosMsg.textContent = 'No hay cambios para guardar.';
                return;
            }
            if (preciosMsg) preciosMsg.textContent = 'Guardando‚Ä¶';
            apiBulkUpdatePrices(changes).then(function (res) {
                if (!res || res.ok !== true) {
                    if (preciosMsg) preciosMsg.textContent = 'No se pudieron guardar los precios.';
                    return;
                }
                const updated = Array.isArray(res.items) ? res.items : [];
                const map = new Map(updated.map(p => [String(p.id), p]));
                cacheProducts = (Array.isArray(cacheProducts) ? cacheProducts : []).map(p => {
                    const u = map.get(String(p.id));
                    return u ? { ...p, sale_price: u.sale_price } : p;
                });
                if (preciosMsg) preciosMsg.textContent = 'Precios actualizados.';
                renderAll();
            }).catch(function () {
                if (preciosMsg) preciosMsg.textContent = 'No se pudieron guardar los precios.';
            });
        });
    }

    if (btnExport) btnExport.addEventListener('click', openExport);
    if (btnCloseExport) btnCloseExport.addEventListener('click', closeExport);
    if (btnCancelExport) btnCancelExport.addEventListener('click', closeExport);
    if (btnExportXls) btnExportXls.addEventListener('click', function () { exportCsv(); closeExport(); });
    if (btnExportPdf) btnExportPdf.addEventListener('click', function () { exportPdfPrint(); closeExport(); });

    if (tabCurrent) tabCurrent.addEventListener('click', function () { switchTab('current'); });
    if (tabLots) tabLots.addEventListener('click', function () { switchTab('lots'); });

    if (btnChoiceProduct) btnChoiceProduct.addEventListener('click', function () {
        if (choiceWrap) choiceWrap.classList.add('hidden');
        if (formProduct) formProduct.classList.remove('hidden');
        try { if (createInvScroll) createInvScroll.scrollTop = 0; } catch (e) { }
    });
    if (btnChoiceLot) btnChoiceLot.addEventListener('click', function () {
        if (choiceWrap) choiceWrap.classList.add('hidden');
        if (formLot) formLot.classList.remove('hidden');
        poblarProductosSelect();
        try { if (createInvScroll) createInvScroll.scrollTop = 0; } catch (e) { }
    });
    if (btnBack1) btnBack1.addEventListener('click', resetCreateModal);
    if (btnBack2) btnBack2.addEventListener('click', closeCreate);

    if (prodUnit) {
        prodUnit.addEventListener('change', function () {
            const esOtro = String(prodUnit.value) === 'Otro';
            if (wrapProdUnit) wrapProdUnit.classList.toggle('hidden', !esOtro);
        });
    }

    if (prodActive) prodActive.addEventListener('change', syncProductToggleLabels);
    if (prodLots) prodLots.addEventListener('change', syncProductToggleLabels);

    if (btnEditFile) btnEditFile.addEventListener('click', function () { toggleFileEditMode(true); });
    if (btnCancelFile) btnCancelFile.addEventListener('click', function () { if (fileProductId) openProductFile(fileProductId); else closeProductFile(); });
    if (btnSaveFile) btnSaveFile.addEventListener('click', saveProductFile);
    if (btnCloseFile) btnCloseFile.addEventListener('click', closeProductFile);
    if (btnCloseFileBottom) btnCloseFileBottom.addEventListener('click', closeProductFile);

    if (fileActive) fileActive.addEventListener('change', syncFileToggleLabels);
    if (fileUnit) {
        fileUnit.addEventListener('change', function () {
            const esOtro = String(fileUnit.value) === 'Otro';
            if (wrapFileUnit) wrapFileUnit.classList.toggle('hidden', !esOtro || !fileEditMode);
        });
    }

    if (filePrimarySupplier) {
        filePrimarySupplier.addEventListener('input', function () {
            if (suppressSupplierInputClear) return;
            if (filePrimarySupplierId) filePrimarySupplierId.value = '';
        });
    }

    if (btnSelectSupplierFile) btnSelectSupplierFile.addEventListener('click', function () { openSupplierModal('file'); });
    if (linkCreateSupplierFile) linkCreateSupplierFile.addEventListener('click', function (ev) { ev.preventDefault(); goCreateSupplier('file'); });

    if (fileImage) {
        fileImage.addEventListener('change', function () {
            const f = (fileImage.files && fileImage.files.length) ? fileImage.files[0] : null;
            fileImageWasChanged = true;
            if (!f) {
                fileImageWasChanged = false;
                return;
            }
            try {
                const url = URL.createObjectURL(f);
                setFileImagePreviewUrl(url);
            } catch (e) {
            }
        });
    }

    if (btnFileChart15) btnFileChart15.addEventListener('click', function () { if (fileProductId) refreshFileChart(fileProductId, 15); });
    if (btnFileChart30) btnFileChart30.addEventListener('click', function () { if (fileProductId) refreshFileChart(fileProductId, 30); });
    if (btnFileChart60) btnFileChart60.addEventListener('click', function () { if (fileProductId) refreshFileChart(fileProductId, 60); });
    if (btnFileChart90) btnFileChart90.addEventListener('click', function () { if (fileProductId) refreshFileChart(fileProductId, 90); });

    if (lotNoExp) {
        lotNoExp.addEventListener('change', function () {
            const no = !!lotNoExp.checked;
            if (lotExp) {
                lotExp.value = '';
                lotExp.disabled = no;
                lotExp.classList.toggle('bg-gray-50', no);
            }
        });
    }

    if (lotCu) lotCu.addEventListener('input', updateLotCt);
    if (lotQty) lotQty.addEventListener('input', updateLotCt);

    if (btnSaveProduct) {
        btnSaveProduct.addEventListener('click', function () {
            const name = String(prodName?.value || '').trim();
            const categoryId = String(prodCatId?.value || '').trim();
            const unitBase = String(prodUnit?.value || '').trim();
            const unitOther = String(prodUnitOther?.value || '').trim();
            const unit = (unitBase === 'Otro') ? unitOther : unitBase;
            const manageLots = !!prodLots?.checked;
            const method = String(prodMethod?.value || 'FIFO').trim();
            const min = parseNumeroSeguro(prodMin?.value);
            const reorderPoint = parseNumeroSeguro(prodReorder?.value);
            const desc = String(prodDesc?.value || '').trim();
            const primarySupplierName = String(prodPrimarySupplier?.value || '').trim();
            const primarySupplierId = String(prodPrimarySupplierId?.value || '').trim();
            const active = !!prodActive?.checked;

            if (!name) { if (window.showAlertModal) window.showAlertModal('Complet√° el nombre del producto.', 'Atenci√≥n', 'Validaci√≥n requerida'); else alert('Complet√° el nombre del producto.'); return; }
            if (!categoryId) { if (window.showAlertModal) window.showAlertModal('Seleccion√° la categor√≠a del producto.', 'Atenci√≥n', 'Validaci√≥n requerida'); else alert('Seleccion√° la categor√≠a del producto.'); return; }
            if (!unit) { if (window.showAlertModal) window.showAlertModal('Complet√° la unidad.', 'Atenci√≥n', 'Validaci√≥n requerida'); else alert('Complet√° la unidad.'); return; }

            const payload = {
                name,
                category_id: parseInt(categoryId, 10),
                unit_name: unit,
                uses_lots: manageLots,
                method,
                min_stock: min,
                reorder_point: reorderPoint,
                description: desc,
                primary_supplier_id: primarySupplierId,
                primary_supplier_name: primarySupplierName,
                active: active,
                sale_price: 0
            };

            const req = editingProductId
                ? apiUpdateProduct(editingProductId, payload)
                : apiCreateProduct(payload);

            req.then(function (res) {
                if (!res || res.ok !== true) {
                    const err = String(res?.error || '').trim();
                    const msg = (err === 'category_required')
                        ? 'Seleccion√° una categor√≠a.'
                        : (err === 'method_locked')
                            ? 'La metodolog√≠a no puede modificarse una vez que el producto tiene movimientos.'
                            : (editingProductId ? 'No se pudo editar el producto.' : 'No se pudo crear el producto.');
                    if (window.showAlertModal) window.showAlertModal(msg, 'Error', 'Operaci√≥n fallida');
                    else alert(msg);
                    return;
                }
                const item = res.item;
                const pid = String(item?.id || editingProductId || '').trim();
                const file = (prodImage && prodImage.files && prodImage.files.length) ? prodImage.files[0] : null;
                if (pid && file) {
                    apiUploadProductImage(pid, file).then(function () {
                        closeCreate();
                        renderAll();
                    }).catch(function () {
                        closeCreate();
                        renderAll();
                    });
                    return;
                }
                closeCreate();
                renderAll();
            }).catch(function () {
                const msg = editingProductId ? 'No se pudo editar el producto.' : 'No se pudo crear el producto.';
                if (window.showAlertModal) window.showAlertModal(msg, 'Error', 'Operaci√≥n fallida');
                else alert(msg);
            });
        });
    }

    function openCreateCategory() {
        if (!modalCreateCat) return;
        if (catName) catName.value = '';
        if (catMsg) catMsg.textContent = '';
        abrirModal(modalCreateCat, true);
        try { catName?.focus(); } catch (e) { }
    }

    function closeCreateCategory() {
        if (!modalCreateCat) return;
        abrirModal(modalCreateCat, false);
    }

    if (btnOpenCreateCat) btnOpenCreateCat.addEventListener('click', openCreateCategory);
    if (btnCloseCreateCat) btnCloseCreateCat.addEventListener('click', closeCreateCategory);
    if (btnCancelCreateCat) btnCancelCreateCat.addEventListener('click', closeCreateCategory);
    if (btnSaveCreateCat) {
        btnSaveCreateCat.addEventListener('click', function () {
            const name = String(catName?.value || '').trim();
            if (!name) {
                if (catMsg) catMsg.textContent = 'Complet√° el nombre.';
                return;
            }
            if (catMsg) catMsg.textContent = 'Creando‚Ä¶';
            apiCreateCategory({ name }).then(function (res) {
                if (!res || res.ok !== true) {
                    const err = String(res?.error || '').trim();
                    if (err === 'already_exists') {
                        if (catMsg) catMsg.textContent = 'Ya existe una categor√≠a con ese nombre.';
                    } else {
                        if (catMsg) catMsg.textContent = 'No se pudo crear la categor√≠a.';
                    }
                    return;
                }
                const item = res.item;
                if (!didLoadCategories) didLoadCategories = true;
                loadCategories(function () {
                    refreshCategorySelect(String(item?.id || ''));
                });
                closeCreateCategory();
            }).catch(function () {
                if (catMsg) catMsg.textContent = 'No se pudo crear la categor√≠a.';
            });
        });
    }

    function setImagePreviewFromFile(file) {
        if (!file || !prodImagePreview) return;
        try {
            const url = URL.createObjectURL(file);
            prodImagePreview.src = url;
            prodImagePreview.classList.remove('hidden');
            if (prodImagePlaceholder) prodImagePlaceholder.classList.add('hidden');
        } catch (e) {
        }
    }

    if (prodImage) {
        prodImage.addEventListener('change', function () {
            const file = (prodImage.files && prodImage.files.length) ? prodImage.files[0] : null;
            if (!file) {
                if (prodImagePreview) {
                    prodImagePreview.src = '';
                    prodImagePreview.classList.add('hidden');
                }
                if (prodImagePlaceholder) prodImagePlaceholder.classList.remove('hidden');
                return;
            }
            setImagePreviewFromFile(file);
        });
    }

    if (prodPrimarySupplier) {
        prodPrimarySupplier.addEventListener('input', function () {
            if (suppressSupplierInputClear) return;
            if (prodPrimarySupplierId) prodPrimarySupplierId.value = '';
        });
    }

    if (lotSupplier) {
        lotSupplier.addEventListener('input', function () {
            if (suppressSupplierInputClear) return;
            if (lotSupplierId) lotSupplierId.value = '';
        });
    }

    function safeReturnToWithTarget(target) {
        try {
            const url = new URL(window.location.href);
            url.searchParams.delete('supplier_id');
            url.searchParams.delete('supplier_name');
            url.searchParams.delete('inv_supplier_target');
            url.searchParams.set('inv_supplier_target', String(target || ''));
            return url.pathname + (url.searchParams.toString() ? ('?' + url.searchParams.toString()) : '');
        } catch (e) {
            return window.location.pathname + window.location.search;
        }
    }

    function goCreateSupplier(target) {
        const returnTo = safeReturnToWithTarget(target);
        const qs = [
            'return_to=' + encodeURIComponent(returnTo),
            'prefill_category=' + encodeURIComponent('Inventario')
        ];
        window.location.href = '/suppliers/new?' + qs.join('&');
    }

    if (btnSelectSupplierProduct) {
        btnSelectSupplierProduct.addEventListener('click', function () {
            openSupplierModal('product');
        });
    }
    if (btnSelectSupplierLot) {
        btnSelectSupplierLot.addEventListener('click', function () {
            openSupplierModal('lot');
        });
    }

    if (btnSelectSupplierLotEdit) btnSelectSupplierLotEdit.addEventListener('click', function () { openSupplierModal('lot_edit'); });

    if (btnCloseSelectSupplier) btnCloseSelectSupplier.addEventListener('click', closeSupplierModal);
    if (btnCancelSelectSupplier) btnCancelSelectSupplier.addEventListener('click', closeSupplierModal);
    if (supplierModalSearch) {
        supplierModalSearch.addEventListener('input', function () {
            renderSupplierModalList(supplierModalSearch.value);
        });
    }

    if (linkCreateSupplierFromInv) {
        linkCreateSupplierFromInv.addEventListener('click', function (ev) {
            ev.preventDefault();
            goCreateSupplier(currentSupplierTarget || 'product');
        });
    }
    if (linkCreateSupplierProduct) {
        linkCreateSupplierProduct.addEventListener('click', function (ev) {
            ev.preventDefault();
            goCreateSupplier('product');
        });
    }
    if (linkCreateSupplierLot) {
        linkCreateSupplierLot.addEventListener('click', function (ev) {
            ev.preventDefault();
            goCreateSupplier('lot');
        });
    }

    if (linkCreateSupplierLotEdit) linkCreateSupplierLotEdit.addEventListener('click', function (ev) { ev.preventDefault(); goCreateSupplier('lot_edit'); });

    if (editLotSupplier) {
        editLotSupplier.addEventListener('input', function () {
            if (suppressSupplierInputClear) return;
            if (editLotSupplierId) editLotSupplierId.value = '';
        });
    }

    if (btnSaveEditLot) btnSaveEditLot.addEventListener('click', saveEditLot);
    if (btnCancelEditLot) btnCancelEditLot.addEventListener('click', closeEditLot);
    if (btnCloseEditLot) btnCloseEditLot.addEventListener('click', closeEditLot);

    if (btnAddLot) btnAddLot.addEventListener('click', openAddLot);

    if (btnSaveLot) {
        btnSaveLot.addEventListener('click', function () {
            const productId = String(lotProduct?.value || '').trim();
            const entryDate = String(lotDate?.value || '').trim();
            const supplier = String(lotSupplier?.value || '').trim();
            const supplierId = String(lotSupplierId?.value || '').trim();
            const cu = parseNumeroSeguro(lotCu?.value);
            const qty = parseNumeroSeguro(lotQty?.value);
            const expiration = (lotNoExp?.checked) ? '' : String(lotExp?.value || '').trim();
            const note = String(lotNote?.value || '').trim();

            if (!productId) { if (window.showAlertModal) window.showAlertModal('Seleccion√° un producto.', 'Atenci√≥n', 'Validaci√≥n requerida'); else alert('Seleccion√° un producto.'); return; }
            if (!entryDate) { if (window.showAlertModal) window.showAlertModal('Complet√° la fecha de ingreso.', 'Atenci√≥n', 'Validaci√≥n requerida'); else alert('Complet√° la fecha de ingreso.'); return; }
            if (!supplier) { if (window.showAlertModal) window.showAlertModal('Complet√° el proveedor.', 'Atenci√≥n', 'Validaci√≥n requerida'); else alert('Complet√° el proveedor.'); return; }
            if (!(cu > 0)) { if (window.showAlertModal) window.showAlertModal('El costo unitario debe ser mayor a 0.', 'Atenci√≥n', 'Validaci√≥n requerida'); else alert('El costo unitario debe ser mayor a 0.'); return; }
            if (!(qty > 0)) { if (window.showAlertModal) window.showAlertModal('La cantidad debe ser mayor a 0.', 'Atenci√≥n', 'Validaci√≥n requerida'); else alert('La cantidad debe ser mayor a 0.'); return; }

            const prod = (Array.isArray(cacheProducts) ? cacheProducts : []).find(p => String(p.id) === String(productId));
            if (!prod) { if (window.showAlertModal) window.showAlertModal('Producto inv√°lido.', 'Atenci√≥n', 'Validaci√≥n requerida'); else alert('Producto inv√°lido.'); return; }

            const lotId = String(Date.now());
            const lotCode = 'L-' + lotId.slice(-6);

            const total = cu * qty;
            const expensePayload = {
                id: String(Date.now()),
                fecha: entryDate,
                categoria: 'Inventario',
                valor: total,
                nota: 'Desde Inventario - ' + String(prod.name || '') + ' (' + lotCode + ')',
                forma_pago: 'Transferencia',
                tipo_gasto: 'Variable',
                frecuencia: '√önico',
                comprobante: [],
                custom_fields: [],
                proveedor: String(supplier || ''),
                supplier_id: supplierId,
                supplier_name: String(supplier || '')
            };

            apiCreateLot({
                product_id: parseInt(productId, 10),
                date: entryDate,
                unit_cost: cu,
                qty: qty,
                supplier_id: supplierId,
                supplier_name: supplier,
                lot_code: lotCode,
                expiration_date: expiration,
                note: note
            }).then(function (res) {
                if (!res || res.ok !== true) {
                    if (window.showAlertModal) window.showAlertModal('No se pudo cargar el lote.', 'Error', 'Operaci√≥n fallida');
                    else alert('No se pudo cargar el lote.');
                    return;
                }
                crearEgresoDesdeInventario({ fecha: entryDate, proveedor: supplier, valor: total, nota: expensePayload.nota });
                closeCreate();
                renderAll();
            }).catch(function () {
                if (window.showAlertModal) window.showAlertModal('No se pudo cargar el lote.', 'Error', 'Operaci√≥n fallida');
                else alert('No se pudo cargar el lote.');
            });
        });
    }

    [filterQ, filterCat, filterStatus].forEach(el => {
        if (!el) return;
        el.addEventListener('input', renderAll);
        el.addEventListener('change', renderAll);
    });

    if (filterQLots && filterQ) {
        try { filterQLots.value = String(filterQ.value || ''); } catch (e) { }
        filterQLots.addEventListener('input', function () {
            try { filterQ.value = String(filterQLots.value || ''); } catch (e) { }
            try { renderAll(); } catch (e) { }
        });
        filterQ.addEventListener('input', function () {
            try { filterQLots.value = String(filterQ.value || ''); } catch (e) { }
        });
    }

    if (filterLotsSup) {
        filterLotsSup.addEventListener('input', renderAll);
        filterLotsSup.addEventListener('change', renderAll);
    }

    function setStatusFilter(values) {
        if (!filterStatus) return;
        const wanted = Array.isArray(values) ? values.map(v => String(v || '').trim()).filter(Boolean) : [];
        Array.from(filterStatus.options).forEach(function (o) {
            const v = String(o.value || '').trim();
            if (!v) {
                o.selected = false;
            } else {
                o.selected = wanted.indexOf(v) >= 0;
            }
        });
        try { filterStatus.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) { }
    }

    // Estado filter: permitir multi-selecci√≥n simple (sin Ctrl/Cmd) y que "Todos" seleccione OK+Reponer+Cr√≠tico.
    let suppressStatusSync = false;

    function getStatusOptions() {
        if (!filterStatus) return { allOpt: null, statusOpts: [] };
        const opts = Array.from(filterStatus.options || []);
        const allOpt = opts.find(o => String(o.value || '').trim() === '') || null;
        const statusOpts = opts.filter(o => String(o.value || '').trim() !== '');
        return { allOpt, statusOpts };
    }

    function syncTodosOption() {
        if (!filterStatus) return;
        const { allOpt, statusOpts } = getStatusOptions();
        if (!allOpt) return;
        const allSelected = statusOpts.length > 0 && statusOpts.every(o => !!o.selected);
        allOpt.selected = allSelected;
    }

    if (filterStatus) {
        filterStatus.addEventListener('change', function () {
            if (suppressStatusSync) return;
            const { allOpt, statusOpts } = getStatusOptions();
            if (!allOpt) {
                try { renderAll(); } catch (e) { }
                return;
            }

            const todosSelected = !!allOpt.selected;
            if (todosSelected) {
                suppressStatusSync = true;
                statusOpts.forEach(function (o) { o.selected = true; });
                suppressStatusSync = false;
            } else {
                // Si est√°n las 3 seleccionadas, marcamos "Todos" para que el dropdown lo muestre.
                suppressStatusSync = true;
                syncTodosOption();
                suppressStatusSync = false;
            }

            try { renderAll(); } catch (e) { }
        });

        // Inicial: si al cargar est√°n todas seleccionadas, reflejar en "Todos".
        try { syncTodosOption(); } catch (e) { }
    }

    function setStatusFilterButtonText(text) {
        if (!filterStatus) return;
        const t = String(text || '').trim();
        const root = filterStatus.closest('th') || filterStatus.parentElement || document;
        const selectors = [
            'button.multiselect',
            'button[data-id="inv-status"]',
            '.dropdown-toggle[data-id="inv-status"]',
            '.bootstrap-select button',
        ];
        let btn = null;
        for (let i = 0; i < selectors.length; i++) {
            try {
                btn = root.querySelector(selectors[i]);
                if (btn) break;
            } catch (e) {
            }
        }
        if (!btn) return;
        const innerSelectors = [
            '.filter-option-inner-inner',
            '.filter-option',
            'span',
        ];
        for (let i = 0; i < innerSelectors.length; i++) {
            try {
                const el = btn.querySelector(innerSelectors[i]);
                if (el) {
                    el.textContent = t;
                    return;
                }
            } catch (e) {
            }
        }
        try { btn.textContent = t; } catch (e) { }
    }

    function refreshStatusFilterCompactLabel() {
        if (!filterStatus) return;
        const { allOpt, statusOpts } = getStatusOptions();
        if (!allOpt) return;
        const selected = statusOpts.filter(o => !!o.selected);
        if (!selected.length || selected.length === statusOpts.length) {
            setStatusFilterButtonText('Todos');
            return;
        }
        if (selected.length === 1) {
            setStatusFilterButtonText(String(selected[0].value || '').trim() || 'Estado');
            return;
        }
        setStatusFilterButtonText(String(selected.length) + ' seleccionados');
    }

    if (filterStatus) {
        filterStatus.addEventListener('change', function () {
            try { refreshStatusFilterCompactLabel(); } catch (e) { }
        });
        try {
            setTimeout(function () { try { refreshStatusFilterCompactLabel(); } catch (e) { } }, 0);
            setTimeout(function () { try { refreshStatusFilterCompactLabel(); } catch (e) { } }, 250);
        } catch (e) {
        }
    }

    if (kpiAlertsCard) {
        kpiAlertsCard.addEventListener('click', function () {
            setStatusFilter(['Reponer', 'Cr√≠tico']);
            try { switchTab('current'); } catch (e) { }
            try { document.getElementById('panel-current')?.scrollIntoView?.({ behavior: 'smooth', block: 'start' }); } catch (e) { }
        });
    }

    applyReturnedSupplierSelection();

    switchTab('current');
});
</script>
{% endblock %}
