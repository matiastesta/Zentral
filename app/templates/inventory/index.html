{% extends 'base.html' %}
{% block title %}Inventario{% endblock %}
{% block content %}
<div class="mb-6">
    <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
        <div>
            <div class="flex items-center gap-2">
                <h1 class="text-2xl font-bold text-gray-900">Inventario</h1>
                <button type="button" class="inline-flex items-center justify-center h-8 w-8 rounded-md hover:bg-gray-100 text-gray-600" data-kpi-toggle="inventory" data-kpi-key="inventory" data-kpi-target="#kpi-section-inventory" aria-expanded="true" aria-label="Mostrar/ocultar KPIs">
                    <i data-kpi-toggle-icon class="fas fa-chevron-down"></i>
                </button>
            </div>
            <p class="mt-1 text-sm text-gray-600">Inventario es el único punto de entrada de stock. Cada alta de lote genera un egreso automático.</p>
        </div>
        <div class="flex gap-2 justify-end">
            <button id="btn-register-inv" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;">
                <i class="fas fa-plus mr-2"></i> Registrar Inventario
            </button>
        </div>
    </div>
</div>

<div id="modal-select-supplier" class="hidden fixed inset-0 z-50" style="z-index: 70;">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-4 py-3 border-b border-gray-100 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <i class="fas fa-search text-gray-500"></i>
                    <div class="font-semibold text-gray-900">Seleccionar proveedor</div>
                </div>
                <button id="btn-close-select-supplier" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600" aria-label="Cerrar">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-4">
                <div class="relative">
                    <div class="absolute inset-y-0 left-3 flex items-center text-gray-400">
                        <i class="fas fa-search"></i>
                    </div>
                    <input id="supplier-modal-search" type="text" class="w-full pl-10 pr-3 py-2 text-sm rounded-lg bg-white border border-gray-200 focus:outline-none focus:ring-2 focus:ring-indigo-200" placeholder="Buscar proveedor por nombre o categoría...">
                </div>

                <div class="mt-3 rounded-xl bg-white overflow-hidden border border-gray-200">
                    <div id="supplier-modal-list" class="max-h-[360px] overflow-auto divide-y divide-gray-100"></div>
                </div>

                <div class="mt-3 flex items-center justify-between gap-2">
                    <a id="link-create-supplier-from-inv" href="{{ url_for('suppliers.new') }}" class="inline-flex items-center px-3 py-2 text-xs font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">
                        <i class="fas fa-user-plus mr-2 text-gray-500"></i> Crear proveedor
                    </a>
                    <button id="btn-cancel-select-supplier" type="button" class="px-4 py-2 text-xs font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-create-category" class="hidden fixed inset-0 z-50" style="z-index: 60;">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Crear categoría</h3>
                    <p class="text-xs text-gray-500">Evitamos duplicados por calidad de datos.</p>
                </div>
                <button id="btn-close-create-cat" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5">
                <label class="block text-xs font-medium text-gray-600 mb-1">Nombre <span class="text-red-600">*</span></label>
                <input id="cat-name" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Ej: Alimentos">
                <div id="cat-msg" class="mt-2 text-[11px] text-gray-600"></div>

                <div class="mt-4">
                    <div class="text-xs font-semibold text-gray-700">Categorías existentes</div>
                    <div class="mt-2 rounded-lg border border-gray-200 bg-white overflow-hidden">
                        <div id="cat-list" class="max-h-56 overflow-auto divide-y divide-gray-100"></div>
                    </div>
                    <div class="mt-1 text-[11px] text-gray-500">Podés borrar una categoría si no tiene productos asociados.</div>
                </div>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex items-center justify-end gap-2">
                <button id="btn-cancel-create-cat" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="btn-save-create-cat" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;">Crear</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-edit-lot" class="hidden fixed inset-0 z-50" style="z-index: 66;">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Editar lote</h3>
                    <p id="edit-lot-subtitle" class="text-xs text-gray-500"></p>
                </div>
                <button id="btn-close-edit-lot" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fas fa-times"></i></button>
            </div>

            <div class="p-5">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                    <div class="md:col-span-6">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Producto</label>
                        <div id="edit-lot-product" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Cantidad</label>
                        <input id="edit-lot-qty" type="number" min="0" step="0.01" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Costo unitario</label>
                        <input id="edit-lot-cu" type="text" inputmode="decimal" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="$0" data-currency="ars">
                    </div>

                    <div class="md:col-span-4">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Código de lote</label>
                        <input id="edit-lot-code" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Ej: L-000123">
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Fecha de ingreso</label>
                        <input id="edit-lot-date" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-white" placeholder="dd/mm/aaaa" autocomplete="off">
                    </div>
                    <div class="md:col-span-4">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Vencimiento</label>
                        <input id="edit-lot-exp" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-white" placeholder="dd/mm/aaaa" autocomplete="off">
                    </div>

                    <div class="md:col-span-12">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Proveedor</label>
                        <div class="relative">
                            <input id="edit-lot-supplier" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-white" placeholder="Buscar y seleccionar proveedor" autocomplete="off">
                            <input id="edit-lot-supplier-id" type="hidden" value="">
                        </div>
                        <div class="mt-2 grid grid-cols-2 gap-2">
                            <a id="link-create-supplier-lot-edit" href="{{ url_for('suppliers.new') }}" class="w-full text-center px-3 py-1.5 text-xs font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Crear proveedor</a>
                            <button id="btn-select-supplier-lot-edit" type="button" class="w-full px-3 py-1.5 text-xs font-medium rounded-md border border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100">Seleccionar</button>
                        </div>
                    </div>

                    <div class="md:col-span-12">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Observaciones</label>
                        <input id="edit-lot-note" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Opcional">
                        <div id="edit-lot-msg" class="mt-2 text-[11px] text-gray-600"></div>
                    </div>
                </div>
            </div>

            <div class="px-5 py-4 border-t border-gray-100 flex items-center justify-between gap-2">
                <button id="btn-open-adjust-lot" type="button" class="hidden inline-flex items-center px-3 py-2 text-sm font-medium rounded-md border border-amber-200 bg-amber-50 text-amber-800 hover:bg-amber-100">Ajustar lote</button>
                <div class="flex items-center justify-end gap-2">
                    <button id="btn-cancel-edit-lot" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                    <button id="btn-save-edit-lot" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;">Guardar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-adjust-lot" class="hidden fixed inset-0 z-50" style="z-index: 67;">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Ajustar lote</h3>
                    <p id="adjust-lot-subtitle" class="text-xs text-gray-500"></p>
                </div>
                <button id="btn-close-adjust-lot" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fas fa-times"></i></button>
            </div>

            <div class="p-5">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                    <div class="md:col-span-6">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Producto</label>
                        <div id="adjust-lot-product" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Consumido</label>
                        <div id="adjust-lot-consumed" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Fecha</label>
                        <div id="adjust-lot-date" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                    </div>

                    <div class="md:col-span-6">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Cantidad actual</label>
                        <div id="adjust-lot-qty-old" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                    </div>
                    <div class="md:col-span-6">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Costo unitario actual</label>
                        <div id="adjust-lot-cu-old" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                    </div>

                    <div class="md:col-span-6">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Nueva cantidad <span class="text-red-600">*</span></label>
                        <input id="adjust-lot-qty-new" type="number" min="0" step="0.01" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                    </div>
                    <div class="md:col-span-6">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Nuevo costo unitario <span class="text-red-600">*</span></label>
                        <input id="adjust-lot-cu-new" type="text" inputmode="decimal" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="$0" data-currency="ars">
                    </div>

                    <div class="md:col-span-12">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Nota</label>
                        <input id="adjust-lot-note" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Opcional">
                    </div>

                    <div class="md:col-span-12">
                        <label class="inline-flex items-start gap-2 text-sm text-gray-700 select-none">
                            <input id="adjust-lot-confirm" type="checkbox" class="mt-1 rounded border-gray-300">
                            <span>Entiendo que este ajuste es irreversible y afecta CMV, márgenes e informes.</span>
                        </label>
                        <div id="adjust-lot-msg" class="mt-2 text-[11px] text-gray-600"></div>
                    </div>
                </div>
            </div>

            <div class="px-5 py-4 border-t border-gray-100 flex items-center justify-end gap-2">
                <button id="btn-cancel-adjust-lot" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="btn-save-adjust-lot" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;">Confirmar ajuste</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-product-file" class="hidden fixed inset-0 z-50" style="z-index: 65;">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden flex flex-col" style="max-height: calc(100vh - 2rem);">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between sticky top-0 bg-white z-10">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Legajo del producto</h3>
                    <p id="file-subtitle" class="text-xs text-gray-500"></p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="btn-edit-file" type="button" class="px-3 py-2 text-xs font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Editar legajo</button>
                    <button id="btn-save-file" type="button" class="hidden px-3 py-2 text-xs font-medium rounded-md text-white" style="background-color:#0d1067;">Guardar</button>
                    <button id="btn-cancel-file" type="button" class="hidden px-3 py-2 text-xs font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Cancelar</button>
                    <button id="btn-close-file" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600" aria-label="Cerrar"><i class="fas fa-times"></i></button>
                </div>
            </div>

            <div id="file-scroll" class="flex-1 min-h-0 overflow-y-auto p-5">
                <div id="file-sections" class="space-y-5">
                    <div id="file-view-cards" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="rounded-xl border border-gray-200 bg-white p-4">
                            <div class="text-xs font-semibold text-gray-700">Datos</div>
                            <div class="mt-2 text-xs text-gray-600 space-y-1">
                                <div><span class="text-gray-500">Nombre:</span> <span id="file-v-name" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Categoría:</span> <span id="file-v-category" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Código interno:</span> <span id="file-v-codigo-interno" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Código de barras:</span> <span id="file-v-barcode" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Estado:</span> <span id="file-v-active" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Proveedor:</span> <span id="file-v-supplier" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Descripción:</span> <span id="file-v-desc" class="text-gray-800"></span></div>
                            </div>
                        </div>

                        <div class="rounded-xl border border-gray-200 bg-white p-4">
                            <div class="text-xs font-semibold text-gray-700">Stock</div>
                            <div class="mt-2 text-xs text-gray-600 space-y-1">
                                <div><span class="text-gray-500">Stock actual:</span> <span id="file-v-stock" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Stock mínimo:</span> <span id="file-v-min" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Punto de pedido:</span> <span id="file-v-reorder" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Estado:</span> <span id="file-v-status" class="text-gray-800"></span></div>
                                <div><span class="text-gray-500">Metodología:</span> <span id="file-v-method" class="text-gray-800"></span></div>
                            </div>
                        </div>

                        <div class="rounded-xl border border-gray-200 bg-white p-4">
                            <div class="text-xs font-semibold text-gray-700">Imagen</div>
                            <div class="mt-2 flex items-start gap-3">
                                <div class="h-28 w-28 rounded-lg border border-gray-200 bg-gray-50 overflow-hidden flex items-center justify-center">
                                    <img id="file-v-image-preview" src="" alt="" class="h-full w-full object-cover hidden">
                                    <div id="file-v-image-placeholder" class="text-gray-400 text-sm"><i class="fas fa-image"></i></div>
                                </div>
                                <div id="file-v-image-optional" class="text-[11px] leading-tight text-gray-500">Opcional.</div>
                            </div>
                        </div>
                    </div>
                    <div id="file-sec-a">
                        <div id="file-sec-a-title" class="text-sm font-semibold text-gray-900">A. Información general</div>
                        <div id="file-sec-a-grid" class="mt-2 grid grid-cols-1 md:grid-cols-12 gap-3 items-start">
                            <div class="md:col-span-6">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Nombre</label>
                                <div id="file-name-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <input id="file-name" type="text" class="hidden w-full px-3 py-2 text-sm border rounded-md">
                            </div>
                            <div class="md:col-span-4">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Categoría</label>
                                <div id="file-cat-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <select id="file-cat" class="hidden w-full px-3 py-2 text-sm border rounded-md bg-white">
                                    <option value="">— Seleccionar —</option>
                                </select>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Código interno</label>
                                <div id="file-sku" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <input id="file-codigo-interno" type="text" maxlength="12" class="hidden w-full px-3 py-2 text-sm border rounded-md" placeholder="Opcional">
                                <div id="file-codigo-interno-hint" class="hidden mt-1 text-[11px] text-gray-500">0/12 · Sin espacios</div>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Código de barras</label>
                                <div id="file-barcode-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <input id="file-barcode" type="text" maxlength="64" class="hidden w-full px-3 py-2 text-sm border rounded-md" placeholder="Opcional">
                                <div id="file-barcode-hint" class="hidden mt-1 text-[11px] text-gray-500">0/64 · A-Z y 0-9</div>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Estado</label>
                                <div id="file-active-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <label id="file-active-edit-wrap" class="hidden w-full inline-flex items-center gap-2 px-3 py-2 text-sm border rounded-md bg-white cursor-pointer select-none">
                                    <input id="file-active" type="checkbox" class="rounded border-gray-300" checked>
                                    <span id="file-active-label" class="text-sm text-gray-700">Activo</span>
                                </label>
                            </div>
                            <div class="md:col-span-6">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Proveedor principal</label>
                                <div id="file-supplier-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <div id="file-supplier-edit" class="hidden">
                                    <div class="relative">
                                        <input id="file-primary-supplier" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-white" placeholder="Buscar y seleccionar proveedor" autocomplete="off">
                                        <input id="file-primary-supplier-id" type="hidden" value="">
                                    </div>
                                    <div class="mt-2 grid grid-cols-2 gap-2">
                                        <a id="link-create-supplier-file" href="{{ url_for('suppliers.new') }}" class="w-full text-center px-3 py-1.5 text-xs font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Crear proveedor</a>
                                        <button id="btn-select-supplier-file" type="button" class="w-full px-3 py-1.5 text-xs font-medium rounded-md border border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100">Seleccionar</button>
                                    </div>
                                </div>
                            </div>
                            <div class="md:col-span-12">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Descripción</label>
                                <div id="file-desc-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <textarea id="file-desc" rows="2" class="hidden w-full px-3 py-2 text-sm border rounded-md" placeholder="Opcional"></textarea>
                            </div>
                            <div class="md:col-span-12">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Imagen del producto</label>
                                <div class="grid grid-cols-1 md:grid-cols-12 gap-3 items-start">
                                    <div class="md:col-span-3">
                                        <div class="h-32 w-32 rounded-lg border border-gray-200 bg-gray-50 overflow-hidden flex items-center justify-center">
                                            <img id="file-image-preview" src="" alt="" class="h-full w-full object-cover hidden">
                                            <div id="file-image-placeholder" class="text-gray-400 text-sm"><i class="fas fa-image"></i></div>
                                        </div>
                                    </div>
                                    <div class="md:col-span-9">
                                        <div id="file-image-view" class="text-[9px] leading-tight text-gray-500">Opcional.</div>
                                        <div id="file-image-edit" class="hidden">
                                            <input id="file-image" type="file" accept="image/png,image/jpeg" class="w-full text-sm">
                                            <div class="mt-1 text-[9px] leading-tight text-gray-500">Opcional. Si no cargás imagen, se mostrará un placeholder. Podés editarla cuando quieras.</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="md:col-span-6">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Metodología</label>
                                <div id="file-method-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <select id="file-method" class="hidden w-full px-3 py-2 text-sm border rounded-md bg-white">
                                    <option value="FIFO">PEPS</option>
                                    <option value="Average">Costo promedio</option>
                                </select>
                                <div id="file-method-lock-msg" class="hidden mt-1 text-[10px] leading-tight text-amber-700">La metodología no puede modificarse una vez que el producto tiene movimientos.</div>
                            </div>
                        </div>
                    </div>

                    <div id="file-sec-b">
                        <div id="file-sec-b-title" class="text-sm font-semibold text-gray-900">B. Estado de stock</div>
                        <div id="file-sec-b-grid" class="mt-2 grid grid-cols-1 md:grid-cols-12 gap-3">
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Stock actual</label>
                                <div id="file-stock" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Stock mínimo</label>
                                <div id="file-min-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <input id="file-min" type="number" min="0" step="0.01" class="hidden w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Punto de pedido</label>
                                <div id="file-reorder-view" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                                <input id="file-reorder" type="number" min="0" step="0.01" class="hidden w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Estado</label>
                                <div id="file-status" class="px-3 py-2 text-sm border rounded-md bg-gray-50"></div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div id="file-sec-c-title" class="text-sm font-semibold text-gray-900">C. Historial de lotes</div>
                        <div id="file-sec-c-wrap" class="mt-2 overflow-auto border border-gray-200 rounded-lg" style="max-height: 40vh;">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Ingreso</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Lote</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Inicial</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Restante</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">CU</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Proveedor</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Vencimiento</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Obs</th>
                                        <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="file-lots-tbody" class="bg-white divide-y divide-gray-200">
                                    <tr><td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">Seleccioná un producto.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="file-sec-d">
                        <div id="file-sec-d-title" class="text-sm font-semibold text-gray-900">D. Stock en el tiempo</div>
                        <div class="mt-2 flex items-center justify-between gap-2">
                            <div class="inline-flex gap-1 rounded-lg bg-gray-50 p-1 border border-gray-100">
                                <button id="file-chart-15" type="button" class="px-3 py-1.5 text-xs font-medium rounded-md text-gray-600 hover:text-gray-900">15 días</button>
                                <button id="file-chart-30" type="button" class="px-3 py-1.5 text-xs font-medium rounded-md bg-white shadow-sm text-gray-900">30 días</button>
                                <button id="file-chart-60" type="button" class="px-3 py-1.5 text-xs font-medium rounded-md text-gray-600 hover:text-gray-900">60 días</button>
                                <button id="file-chart-90" type="button" class="px-3 py-1.5 text-xs font-medium rounded-md text-gray-600 hover:text-gray-900">90 días</button>
                            </div>
                            <div id="file-chart-meta" class="text-[11px] text-gray-500 whitespace-nowrap"></div>
                        </div>

                        <div id="file-chart-card" class="mt-3 border border-gray-200 rounded-lg bg-white p-3">
                            <div id="file-chart-wrap" class="relative w-full">
                                <svg id="file-chart-svg" viewBox="0 0 640 200" class="w-full h-48"></svg>
                                <div id="file-chart-tooltip" class="hidden absolute z-10 px-2 py-1 text-[11px] rounded-md border border-gray-200 bg-white shadow"></div>
                            </div>
                            <div class="mt-2 text-[11px] text-gray-500">Stock real calculado desde movimientos (no se guarda histórico).</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-5 py-4 border-t border-gray-100 flex justify-end sticky bottom-0 bg-white z-10">
                <button id="btn-close-file-bottom" type="button" class="text-sm font-medium text-gray-700 hover:text-gray-900">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div id="kpi-section-inventory" class="grid grid-cols-1 md:grid-cols-4 gap-2 items-stretch mb-6">
    <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col items-center justify-center text-center">
        <div class="h-10 w-10 mb-2 flex items-center justify-center rounded-full bg-emerald-50 text-emerald-700">
            <i class="fas fa-coins"></i>
        </div>
        <div>
            <p class="text-xs uppercase tracking-wide text-gray-500">Valor total del stock</p>
            <p id="kpi-stock-value" class="text-lg font-semibold text-gray-900">$0,00</p>
        </div>
    </div>
    <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col items-center justify-center text-center">
        <div class="h-10 w-10 mb-2 flex items-center justify-center rounded-full bg-indigo-50 text-indigo-700">
            <i class="fas fa-boxes"></i>
        </div>
        <div>
            <p class="text-xs uppercase tracking-wide text-gray-500">Productos</p>
            <p id="kpi-products" class="text-lg font-semibold text-gray-900">0</p>
        </div>
    </div>

    <button id="kpi-alerts-card" type="button" class="md:col-span-2 p-3 rounded-xl bg-white shadow border border-gray-100 text-left hover:bg-gray-50">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch">
            <div class="flex flex-col items-center text-center">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 flex items-center justify-center rounded-full bg-amber-50 text-amber-700">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="flex flex-col">
                        <div class="text-xs uppercase tracking-wide text-gray-500">Alertas activas</div>
                        <div class="mt-0.5 flex items-baseline justify-center gap-2">
                            <div class="text-3xl font-semibold text-gray-900 leading-none"><span id="kpi-alerts">0</span></div>
                            <div class="text-xs font-medium text-gray-700 leading-none">stock bajo + vencimientos</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col items-center text-center md:border-l md:border-gray-100 md:pl-4">
                <div class="text-xs uppercase tracking-wide text-gray-500">Alertas por producto</div>
                <div id="kpi-alerts-list" class="mt-2 w-full space-y-1"></div>
                <div id="kpi-alerts-hint" class="mt-2 text-xs text-gray-500">Click para ver productos en “Reponer” y “Crítico”.</div>
            </div>
        </div>
    </button>
</div>

<div class="bg-white rounded-xl shadow overflow-visible">
    <div class="px-4 py-3 border-b border-gray-100">
        <div class="flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <div>
                <h2 class="text-sm font-semibold text-gray-900">Historial de movimientos de inventario</h2>
                <p class="text-xs text-gray-500">Las ventas descuentan stock según la metodología configurada. En el resumen se muestra costo promedio.</p>
            </div>
            <div class="flex flex-wrap gap-2 text-[11px]">
                <button id="btn-precios-inv" type="button" class="px-3 py-1 rounded-md border border-gray-200 bg-white text-gray-700 hover:bg-gray-50 inline-flex items-center gap-2">
                    <span>Actualizar precios</span>
                    <i class="fas fa-tags text-[10px]"></i>
                </button>
                <button id="btn-export-inv" type="button" class="px-3 py-1 rounded-md border border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 inline-flex items-center gap-2">
                    <span>Exportar</span>
                    <i class="fas fa-file-export text-[10px]"></i>
                </button>
                <div id="inv-danger-wrap" class="relative inline-flex">
                    <button id="btn-inv-danger" type="button" class="px-3 py-1 rounded-md border border-red-200 bg-red-50 text-red-700 hover:bg-red-100 inline-flex items-center gap-2" aria-haspopup="menu" aria-expanded="false">
                        <span>Acciones</span>
                        <i class="fas fa-exclamation-triangle text-[10px]"></i>
                        <i class="fas fa-chevron-down text-[10px]"></i>
                    </button>
                    <div id="inv-danger-menu" class="hidden absolute right-0 mt-2 w-56 rounded-md border border-gray-200 bg-white shadow-lg z-30 overflow-hidden">
                        <button id="btn-inv-danger-empty" type="button" class="w-full text-left px-3 py-2 text-xs text-red-700 hover:bg-gray-50">Vaciar inventario</button>
                        <button id="btn-inv-danger-delete" type="button" class="w-full text-left px-3 py-2 text-xs text-red-700 hover:bg-gray-50">Borrar inventario</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-3 inline-flex gap-1 rounded-lg bg-gray-50 p-1 border border-gray-100">
            <button id="tab-current" type="button" class="px-3 py-1.5 text-xs font-medium rounded-md bg-white shadow-sm text-gray-900">Stock actual</button>
            <button id="tab-lots" type="button" class="px-3 py-1.5 text-xs font-medium rounded-md text-gray-600 hover:text-gray-900">Stock ingreso</button>
        </div>
    </div>

    <div id="panel-current">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Imagen</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Producto</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Categoría</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Stock</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Costo prom.</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Valor total</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Código interno</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-center text-gray-500 uppercase">Estado</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase"></th>
                </tr>
                <tr class="text-[11px] bg-white align-middle">
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1">
                        <input id="inv-q" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600" placeholder="Buscar producto">
                    </th>
                    <th class="px-4 py-1">
                        <select id="inv-cat" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white">
                            <option value="">Todas</option>
                        </select>
                    </th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1">
                        <select id="inv-status" multiple size="1" class="w-28 max-w-[112px] px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white">
                            <option value="">Todos</option>
                            <option value="OK">OK</option>
                            <option value="Reponer">Reponer</option>
                            <option value="Crítico">Crítico</option>
                            <option value="Inactivo">Inactivo</option>
                        </select>
                    </th>
                    <th class="px-4 py-1"></th>
                </tr>
            </thead>
            <tbody id="inv-tbody-current" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">Cargando inventario…</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="panel-lots" class="hidden">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Imagen</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Producto</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Código interno</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Fecha de ingreso</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Cantidad</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Costo unitario</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Proveedor</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Vencimiento</th>
                    <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Acciones</th>
                </tr>
                <tr class="text-[11px] bg-white align-middle">
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1">
                        <input id="inv-q-lots" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600" placeholder="Buscar producto">
                    </th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1">
                        <input id="inv-lots-sup" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600" placeholder="Proveedor">
                    </th>
                    <th class="px-4 py-1"></th>
                    <th class="px-4 py-1"></th>
                </tr>
            </thead>
            <tbody id="inv-tbody-lots" class="bg-white divide-y divide-gray-200">
                <tr>
                    <td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">Cargando inventario…</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div id="modal-precios-inv" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-5xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Actualizar precios</h3>
                    <p class="text-xs text-gray-500">Editá el precio de venta. Se guarda en base de datos y se refleja en Ventas.</p>
                </div>
                <button id="btn-close-precios-inv" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fas fa-times"></i></button>
            </div>

            <div class="p-5">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="md:col-span-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Buscar producto</label>
                        <input id="precios-q" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Nombre del producto">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Categoría</label>
                        <select id="precios-cat" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                            <option value="">Todas</option>
                        </select>
                    </div>
                </div>

                <div class="mt-4 overflow-auto border border-gray-200 rounded-lg" style="max-height: 60vh;">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Producto</th>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-left text-gray-500 uppercase">Categoría</th>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Costo unitario</th>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Precio actual</th>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">Nuevo precio</th>
                                <th class="px-4 py-3 text-xs font-medium tracking-wider text-right text-gray-500 uppercase">
                                    <div class="flex items-center justify-end gap-2">
                                        <span>% cambio</span>
                                        <input id="precios-global-pct" type="number" step="0.01" class="w-24 px-2 py-1 border rounded-md text-right text-xs bg-white" placeholder="%">
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="precios-tbody" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="6" class="px-4 py-6 text-sm text-center text-gray-500">Cargando productos…</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="px-5 py-4 border-t border-gray-100 flex items-center justify-between">
                <div id="precios-msg" class="text-[11px] text-gray-600">Guardá para aplicar los cambios.</div>
                <div class="flex gap-2">
                    <button id="btn-cancel-precios-inv" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cerrar</button>
                    <button id="btn-save-precios-inv" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;">Guardar cambios</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-create-inv" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div id="create-inv-panel" class="w-full max-w-4xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden flex flex-col" style="max-height: calc(100vh - 2rem);">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between sticky top-0 bg-white z-10">
                <div>
                    <h3 id="create-inv-title" class="text-base font-semibold text-gray-900">Crear ítem</h3>
                    <p id="create-inv-subtitle" class="text-xs text-gray-500">¿Qué deseas hacer?</p>
                </div>
                <button id="btn-close-create-inv" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fas fa-times"></i></button>
            </div>

            <div id="create-inv-scroll" class="flex-1 min-h-0 overflow-y-auto">

            <div id="create-choice" class="p-5">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <button id="btn-choice-product" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                        <div class="text-sm font-semibold text-gray-900">Crear ítem</div>
                        <div class="mt-1 text-xs text-gray-500">Registrar un producto nuevo.</div>
                    </button>
                    <button id="btn-choice-lot" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                        <div class="text-sm font-semibold text-gray-900">Agregar lote</div>
                        <div class="mt-1 text-xs text-gray-500">Ingresar stock a un producto existente.</div>
                    </button>
                    <button id="btn-choice-import" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                        <div class="text-sm font-semibold text-gray-900">Importar masivamente</div>
                        <div class="mt-1 text-xs text-gray-500">Por Excel</div>
                    </button>
                </div>
            </div>

            <div id="form-product" class="hidden p-5">
                <div class="space-y-4">
                    <div>
                        <div class="text-sm font-semibold text-gray-900">Datos básicos</div>
                        <div class="mt-2 grid grid-cols-1 md:grid-cols-12 gap-3">
                            <div class="md:col-span-6">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Nombre <span class="text-red-600">*</span></label>
                                <input id="prod-name" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Ej: Café en grano 1kg">
                            </div>
                            <div class="md:col-span-4">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Categoría <span class="text-red-600">*</span></label>
                                <div class="flex gap-2">
                                    <select id="prod-cat-id" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                                        <option value="">— Seleccionar —</option>
                                    </select>
                                    <button id="btn-open-create-cat" type="button" class="shrink-0 inline-flex items-center justify-center w-10 h-10 rounded-md border border-gray-200 bg-white hover:bg-gray-50 text-gray-700" title="Crear categoría">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Código interno</label>
                                <input id="prod-codigo-interno" type="text" maxlength="12" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Opcional">
                                <div id="prod-codigo-interno-hint" class="mt-1 text-[11px] text-gray-500">0/12 · Sin espacios</div>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Código de barras</label>
                                <input id="prod-barcode" type="text" maxlength="64" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Opcional">
                                <div id="prod-barcode-hint" class="mt-1 text-[11px] text-gray-500">0/64 · A-Z y 0-9</div>
                            </div>
                            <div class="md:col-span-5">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Descripción</label>
                                <textarea id="prod-desc" rows="1" class="w-full h-10 px-3 py-2 text-sm border rounded-md resize-none" placeholder="Opcional"></textarea>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Precio de Lista</label>
                                <input id="prod-sale-price" type="text" inputmode="decimal" class="w-full h-10 px-3 py-2 text-sm border rounded-md" placeholder="$0" data-currency="ars">
                            </div>
                        </div>
                    </div>

                    <div id="prod-first-lot" class="space-y-2">
                        <div class="text-sm font-semibold text-gray-900">Agregar primer lote</div>
                        <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                            <div class="md:col-span-5">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Proveedor</label>
                                <div class="relative">
                                    <input id="prod-lot-supplier" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-white" placeholder="Buscar y seleccionar proveedor (opcional)" autocomplete="off">
                                    <input id="prod-lot-supplier-id" type="hidden" value="">
                                </div>
                                <div class="mt-2 grid grid-cols-1 gap-2">
                                    <button id="btn-select-supplier-prod-lot" type="button" class="w-full px-3 py-1.5 text-xs font-medium rounded-md border border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100">Seleccionar</button>
                                </div>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Costo unitario</label>
                                <input id="prod-lot-cu" type="text" inputmode="decimal" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="$0" data-currency="ars">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Cantidad</label>
                                <input id="prod-lot-qty" type="number" min="0" step="0.01" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                            </div>

                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Costo total</label>
                                <input id="prod-lot-ct" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-gray-50" value="$0" readonly>
                            </div>
                            <div class="md:col-span-3">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Vencimiento</label>
                                <input id="prod-lot-exp" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-gray-50" placeholder="dd/mm/aaaa" autocomplete="off" disabled>
                                <label class="mt-2 inline-flex items-center text-xs text-gray-600"><input id="prod-lot-no-exp" type="checkbox" class="rounded border-gray-300 mr-2" checked> No corresponde</label>
                            </div>
                            <div class="md:col-span-6">
                                <label class="block text-xs font-medium text-gray-600 mb-1">Nota del lote</label>
                                <input id="prod-lot-note" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Opcional">
                            </div>
                        </div>
                    </div>

                    <div>
                        <button id="btn-toggle-prod-extra" type="button" class="w-full inline-flex items-center justify-between px-3 py-2 text-sm font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50" aria-expanded="false">
                            <span>Información Complementaria</span>
                            <i id="icon-toggle-prod-extra" class="fas fa-chevron-down text-gray-500"></i>
                        </button>
                    </div>

                    <div id="prod-extra" class="hidden space-y-4">
                        <div>
                            <div class="text-sm font-semibold text-gray-900">Imagen del producto</div>
                            <div class="mt-2 grid grid-cols-1 md:grid-cols-12 gap-3 items-start">
                                <div class="md:col-span-3">
                                    <div class="h-24 w-24 rounded-lg border border-gray-200 bg-gray-50 overflow-hidden flex items-center justify-center">
                                        <img id="prod-image-preview" src="" alt="" class="h-full w-full object-cover hidden">
                                        <div id="prod-image-placeholder" class="text-gray-400 text-sm"><i class="fas fa-image"></i></div>
                                    </div>
                                </div>
                                <div class="md:col-span-9">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Subir imagen (PNG/JPG)</label>
                                    <input id="prod-image" type="file" accept="image/png,image/jpeg" class="w-full text-sm">
                                    <div class="mt-1 text-[5px] leading-none text-gray-500" style="font-size:11px;line-height:1;">Opcional. Si no cargás imagen, se mostrará un placeholder. Podés editarla cuando quieras.</div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <div class="text-sm font-semibold text-gray-900">Configuración de stock</div>
                            <div class="mt-2 grid grid-cols-1 md:grid-cols-12 gap-3">
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Stock mínimo</label>
                                    <input id="prod-min" type="number" min="0" step="0.01" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                                    <div class="mt-1 text-[5px] leading-none text-gray-500" style="font-size:11px;line-height:1;">Alerta crítica.</div>
                                </div>
                                <div class="md:col-span-3">
                                    <label class="block text-xs font-medium text-gray-600 mb-1">Punto de pedido</label>
                                    <input id="prod-reorder" type="number" min="0" step="0.01" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                                    <div class="mt-1 text-[5px] leading-none text-gray-500" style="font-size:11px;line-height:1;">Alerta preventiva (“Reponer”).</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="mt-4 flex justify-end gap-2">
                    <button id="btn-back-1" type="button" class="px-4 py-2 text-sm font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Cancelar</button>
                    <button id="btn-save-product" type="button" class="px-4 py-2 text-sm font-medium rounded-md text-white" style="background-color:#0d1067;">Guardar ítem</button>
                </div>
            </div>

            <div id="form-lot" class="hidden p-5">
                <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
                    <div class="md:col-span-6">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Producto</label>
                        <select id="lot-product" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                            <option value="">— Seleccionar —</option>
                        </select>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Proveedor</label>
                        <div class="relative">
                            <input id="lot-supplier" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-white" placeholder="Buscar y seleccionar proveedor" autocomplete="off">
                            <input id="lot-supplier-id" type="hidden" value="">
                        </div>
                        <div class="mt-2 grid grid-cols-2 gap-2">
                            <a id="link-create-supplier-lot" href="{{ url_for('suppliers.new') }}" class="w-full text-center px-3 py-1.5 text-xs font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Crear proveedor</a>
                            <button id="btn-select-supplier-lot" type="button" class="w-full px-3 py-1.5 text-xs font-medium rounded-md border border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100">Seleccionar</button>
                        </div>
                    </div>

                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Costo unitario</label>
                        <input id="lot-cu" type="text" inputmode="decimal" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="$0" data-currency="ars">
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Cantidad</label>
                        <input id="lot-qty" type="number" min="0" step="0.01" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="0">
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Costo total</label>
                        <input id="lot-ct" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-gray-50" value="$0" readonly>
                    </div>
                    <div class="md:col-span-3">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Vencimiento</label>
                        <input id="lot-exp" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-white" placeholder="dd/mm/aaaa" autocomplete="off" disabled>
                        <label class="mt-2 inline-flex items-center text-xs text-gray-600"><input id="lot-no-exp" type="checkbox" class="rounded border-gray-300 mr-2" checked> No corresponde</label>
                    </div>

                    <div class="md:col-span-12">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Nota</label>
                        <input id="lot-note" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Opcional">
                    </div>
                </div>
                <div class="mt-4 flex justify-end gap-2">
                    <button id="btn-back-2" type="button" class="px-4 py-2 text-sm font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Cancelar</button>
                    <button id="btn-save-lot" type="button" class="px-4 py-2 text-sm font-medium rounded-md text-white" style="background-color:#0d1067;">Guardar lote</button>
                </div>
            </div>

            <div id="form-import" class="hidden p-5">
                <div class="space-y-4">
                    <div class="rounded-xl border border-gray-200 bg-white p-4">
                        <div class="text-sm font-semibold text-gray-900">Formato del Excel</div>
                        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <div class="text-xs font-semibold text-gray-700">Columnas obligatorias</div>
                                <div class="mt-2 text-xs text-gray-600 space-y-1">
                                    <div>nombre</div>
                                    <div>categoria</div>
                                    <div>precio_lista</div>
                                </div>
                            </div>
                            <div>
                                <div class="text-xs font-semibold text-gray-700">Columnas opcionales</div>
                                <div class="mt-2 text-xs text-gray-600 grid grid-cols-2 gap-x-6 gap-y-1">
                                    <div>codigo_interno</div>
                                    <div>descripcion</div>
                                    <div>costo_unitario</div>
                                    <div>cantidad</div>
                                    <div>proveedor</div>
                                    <div>vencimiento</div>
                                    <div>nota_lote</div>
                                    <div>stock_minimo</div>
                                    <div>punto_pedido</div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-3 text-[11px] text-gray-500">Cada fila representa un ítem. Si hay cantidad, se crea un lote inicial.</div>
                    </div>

                    <div class="flex flex-col md:flex-row md:items-end gap-3">
                        <div class="flex-1">
                            <label class="block text-xs font-medium text-gray-600 mb-1">Archivo Excel (.xlsx)</label>
                            <input id="import-file" type="file" accept=".xlsx" class="w-full text-sm" />
                        </div>
                        <div class="flex gap-2">
                            <button id="btn-download-import-template" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-200 bg-white hover:bg-gray-50">
                                <i class="fas fa-download mr-2 text-gray-500"></i> Descargar plantilla
                            </button>
                            <button id="btn-run-import" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;">
                                <i class="fas fa-search mr-2"></i> Previsualizar
                            </button>
                        </div>
                    </div>

                    <div id="import-result" class="hidden rounded-xl border border-gray-200 bg-white p-4"></div>
                </div>
                <div class="mt-4 flex justify-end gap-2">
                    <button id="btn-back-3" type="button" class="px-4 py-2 text-sm font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Volver</button>
                </div>
            </div>

            <div id="form-preview" class="hidden p-5">
                <div class="space-y-4">
                    <div class="rounded-xl border border-gray-200 bg-white p-4">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                            <div>
                                <div class="text-sm font-semibold text-gray-900">Previsualizar importación</div>
                                <div class="mt-1 text-[11px] text-gray-500">Editá y corregí antes de impactar datos.</div>
                            </div>
                            <div class="flex gap-2">
                                <button id="btn-preview-back" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-200 bg-white hover:bg-gray-50">Volver</button>
                                <button id="btn-import-valid" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-200 bg-white hover:bg-gray-50">Importar solo válidas</button>
                                <button id="btn-confirm-import" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;">Confirmar importación</button>
                            </div>
                        </div>

                        <div class="mt-3 grid grid-cols-2 md:grid-cols-6 gap-2">
                            <div class="rounded-lg border border-gray-200 p-3">
                                <div class="text-xs text-gray-500">Filas detectadas</div>
                                <div id="preview-count-total" class="text-lg font-semibold text-gray-900">0</div>
                            </div>
                            <div class="rounded-lg border border-gray-200 p-3">
                                <div class="text-xs text-gray-500">Filas válidas</div>
                                <div id="preview-count-valid" class="text-lg font-semibold text-gray-900">0</div>
                            </div>
                            <div class="rounded-lg border border-gray-200 p-3">
                                <div class="text-xs text-gray-500">Filas con error</div>
                                <div id="preview-count-errors" class="text-lg font-semibold text-gray-900">0</div>
                            </div>
                            <button id="preview-card-new-cats" type="button" class="rounded-lg border border-gray-200 p-3 text-left hover:bg-gray-50">
                                <div class="text-xs text-gray-500">Categorías nuevas <span class="text-[11px] text-gray-400">· Click para desplegar</span></div>
                                <div id="preview-count-new-cats" class="text-lg font-semibold text-gray-900">0</div>
                            </button>
                            <button id="preview-card-new-sups" type="button" class="rounded-lg border border-gray-200 p-3 text-left hover:bg-gray-50">
                                <div class="text-xs text-gray-500">Proveedores nuevos <span class="text-[11px] text-gray-400">· Click para desplegar</span></div>
                                <div id="preview-count-new-sups" class="text-lg font-semibold text-gray-900">0</div>
                            </button>
                            <div class="rounded-lg border border-gray-200 p-3">
                                <div class="text-xs text-gray-500">Ítems ya existen</div>
                                <div id="preview-count-exists" class="text-lg font-semibold text-gray-900">0</div>
                            </div>
                        </div>
                    </div>

                    <div id="preview-drilldown" class="hidden rounded-xl border border-gray-200 bg-white p-4">
                        <div class="flex items-center justify-between gap-3">
                            <div>
                                <div id="preview-drilldown-title" class="text-sm font-semibold text-gray-900">Detalle</div>
                                <div class="mt-1 text-[11px] text-gray-500">Detectadas en el Excel (se crearán si no existen).</div>
                            </div>
                            <button id="btn-preview-drilldown-back" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 rounded-md border border-gray-200 bg-white hover:bg-gray-50">Volver a la tabla</button>
                        </div>
                        <div class="mt-3 rounded-lg border border-gray-200 overflow-hidden">
                            <div id="preview-drilldown-list" class="max-h-64 overflow-auto divide-y divide-gray-100"></div>
                        </div>
                    </div>

                    <div class="rounded-xl border border-gray-200 bg-white overflow-hidden">
                        <div class="overflow-x-auto overflow-y-auto" style="max-height: 55vh;">
                            <table class="min-w-full divide-y divide-gray-200" style="min-width: 1350px;">
                                <thead class="bg-gray-50 sticky top-0">
                                    <tr>
                                        <th class="px-3 py-2 text-xs font-semibold text-gray-600 text-center" style="min-width:140px;">Fila</th>
                                        <th class="px-3 py-2 text-xs font-semibold text-gray-600 text-center" style="min-width:210px;">Nombre</th>
                                        <th class="px-3 py-2 text-xs font-semibold text-gray-600 text-center" style="min-width:160px;">Categoría</th>
                                        <th class="px-3 py-2 text-xs font-semibold text-gray-600 text-center" style="min-width:140px;">Código interno</th>
                                        <th class="px-3 py-2 text-xs font-semibold text-gray-600 text-center" style="min-width:115px;">Precio lista</th>
                                        <th class="px-3 py-2 text-xs font-semibold text-gray-600 text-center" style="min-width:220px;">Descripción</th>
                                        <th class="px-3 py-2 text-xs font-semibold text-gray-600 text-center" style="min-width:110px;">Cantidad</th>
                                        <th class="px-3 py-2 text-xs font-semibold text-gray-600 text-center" style="min-width:115px;">Costo unit.</th>
                                        <th class="px-3 py-2 text-xs font-semibold text-gray-600 text-center" style="min-width:180px;">Proveedor</th>
                                        <th class="px-3 py-2 text-xs font-semibold text-gray-600 text-center" style="min-width:140px;">Vencimiento</th>
                                        <th class="px-3 py-2 text-xs font-semibold text-gray-600 text-center" style="min-width:200px;">Nota lote</th>
                                        <th class="px-3 py-2 text-xs font-semibold text-gray-600 text-center" style="min-width:110px;">Stock mín.</th>
                                        <th class="px-3 py-2 text-xs font-semibold text-gray-600 text-center" style="min-width:120px;">Punto pedido</th>
                                        <th class="px-3 py-2 text-xs font-semibold text-gray-600 text-center" style="min-width:110px;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="preview-tbody" class="divide-y divide-gray-100"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="preview-result" class="hidden rounded-xl border border-gray-200 bg-white p-4"></div>
                </div>
            </div>

            </div>
        </div>
    </div>
</div>

<div id="modal-import-confirm" class="hidden fixed inset-0 z-50" style="z-index: 80;">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 id="import-confirm-title" class="text-base font-semibold text-gray-900">Confirmar importación</h3>
                    <p id="import-confirm-subtitle" class="text-xs text-gray-500">Revisá el resumen antes de impactar datos.</p>
                </div>
                <button id="btn-close-import-confirm" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600" aria-label="Cerrar">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="p-5 space-y-4">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-2">
                    <div class="rounded-xl border border-gray-200 p-3">
                        <div class="text-xs text-gray-500">Ítems</div>
                        <div id="import-confirm-items" class="text-lg font-semibold text-gray-900">0</div>
                    </div>
                    <div class="rounded-xl border border-gray-200 p-3">
                        <div class="text-xs text-gray-500">Lotes</div>
                        <div id="import-confirm-lots" class="text-lg font-semibold text-gray-900">0</div>
                    </div>
                    <div class="rounded-xl border border-gray-200 p-3">
                        <div class="text-xs text-gray-500">Categorías nuevas</div>
                        <div id="import-confirm-cats" class="text-lg font-semibold text-gray-900">0</div>
                    </div>
                    <div class="rounded-xl border border-gray-200 p-3">
                        <div class="text-xs text-gray-500">Proveedores nuevos</div>
                        <div id="import-confirm-sups" class="text-lg font-semibold text-gray-900">0</div>
                    </div>
                    <div class="rounded-xl border border-gray-200 p-3">
                        <div class="text-xs text-gray-500">Filas</div>
                        <div id="import-confirm-rows" class="text-lg font-semibold text-gray-900">0</div>
                    </div>
                </div>

                <div class="rounded-xl border border-gray-200 bg-gray-50 p-4">
                    <div class="flex items-start gap-3">
                        <div class="h-9 w-9 rounded-lg bg-indigo-50 text-indigo-700 flex items-center justify-center shrink-0">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <div class="min-w-0">
                            <div class="text-sm font-semibold text-gray-900">Qué va a pasar</div>
                            <div id="import-confirm-note" class="mt-1 text-xs text-gray-600"></div>
                            <div class="mt-2 text-[11px] text-gray-500">Esto registra inventario con “Ajuste interno” (no afecta caja).</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="px-5 py-4 border-t border-gray-100 flex items-center justify-end gap-2">
                <button id="btn-cancel-import-confirm" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="btn-ok-import-confirm" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;">Confirmar importación</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-export-inv" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Exportar inventario</h3>
                    <p class="text-xs text-gray-500">Se exporta la tab activa con filtros aplicados.</p>
                </div>
                <button id="btn-close-export-inv" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="btn-export-inv-pdf" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                    <div class="text-2xl">📄</div>
                    <div class="mt-2 font-semibold text-gray-900">Exportar a PDF</div>
                    <div class="text-xs text-gray-500">Ideal para imprimir o enviar.</div>
                </button>
                <button id="btn-export-inv-xls" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                    <div class="text-2xl">📊</div>
                    <div class="mt-2 font-semibold text-gray-900">Exportar a Excel</div>
                    <div class="text-xs text-gray-500">Descarga un CSV compatible con Excel.</div>
                </button>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end">
                <button id="btn-cancel-export-inv" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-empty-inv" class="hidden fixed inset-0 z-50" style="z-index: 80;">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 id="empty-inv-title" class="text-base font-semibold text-gray-900">Vaciar inventario</h3>
                    <p id="empty-inv-subtitle" class="text-xs text-gray-500">Acción peligrosa: elimina lotes y movimientos. No se puede deshacer.</p>
                </div>
                <button id="btn-close-empty-inv" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-5 space-y-3">
                <div class="text-sm text-gray-700">
                    Para confirmar, escribí exactamente:
                    <span id="empty-inv-phrase" class="font-mono font-semibold">vaciar inventario</span>
                </div>
                <input id="empty-inv-confirm" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="vaciar inventario" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false">
                <div id="empty-inv-msg" class="text-[11px] text-gray-600"></div>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                <button id="btn-cancel-empty-inv" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="btn-ok-empty-inv" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md opacity-50 cursor-not-allowed" disabled>Confirmar</button>
            </div>
        </div>
    </div>
</div>

<script id="inv-permissions" type="application/json">{{ {
    'lot_adjust': (current_user.is_authenticated),
} | tojson }}</script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const btnRegister = document.getElementById('btn-register-inv');
    const btnCreate = document.getElementById('btn-create-inv');
    const btnAddLot = document.getElementById('btn-add-lot');
    const btnPrecios = document.getElementById('btn-precios-inv');
    const btnExport = document.getElementById('btn-export-inv');
    const invDangerWrap = document.getElementById('inv-danger-wrap');
    const btnInvDanger = document.getElementById('btn-inv-danger');
    const invDangerMenu = document.getElementById('inv-danger-menu');
    const btnInvDangerEmpty = document.getElementById('btn-inv-danger-empty');
    const btnInvDangerDelete = document.getElementById('btn-inv-danger-delete');
    const tabCurrent = document.getElementById('tab-current');
    const tabLots = document.getElementById('tab-lots');
    const panelCurrent = document.getElementById('panel-current');
    const panelLots = document.getElementById('panel-lots');

    const tbodyCurrent = document.getElementById('inv-tbody-current');
    const tbodyLots = document.getElementById('inv-tbody-lots');

    const filterQ = document.getElementById('inv-q');
    const filterQLots = document.getElementById('inv-q-lots');
    const filterCat = document.getElementById('inv-cat');
    const filterStatus = document.getElementById('inv-status');
    const filterLotsSup = document.getElementById('inv-lots-sup');

    const kpiStockValue = document.getElementById('kpi-stock-value');
    const kpiProducts = document.getElementById('kpi-products');
    const kpiExpire = document.getElementById('kpi-expire');
    const kpiAlerts = document.getElementById('kpi-alerts');
    const kpiAlertsList = document.getElementById('kpi-alerts-list');
    const kpiAlertsCard = document.getElementById('kpi-alerts-card');
    const kpiAlertsHint = document.getElementById('kpi-alerts-hint');

    const modalCreate = document.getElementById('modal-create-inv');
    const createInvPanel = document.getElementById('create-inv-panel');
    const btnCloseCreate = document.getElementById('btn-close-create-inv');
    const choiceWrap = document.getElementById('create-choice');

    const modalImportConfirm = document.getElementById('modal-import-confirm');
    const btnCloseImportConfirm = document.getElementById('btn-close-import-confirm');
    const btnCancelImportConfirm = document.getElementById('btn-cancel-import-confirm');
    const btnOkImportConfirm = document.getElementById('btn-ok-import-confirm');
    const importConfirmTitle = document.getElementById('import-confirm-title');
    const importConfirmSubtitle = document.getElementById('import-confirm-subtitle');
    const importConfirmItems = document.getElementById('import-confirm-items');
    const importConfirmLots = document.getElementById('import-confirm-lots');
    const importConfirmCats = document.getElementById('import-confirm-cats');
    const importConfirmSups = document.getElementById('import-confirm-sups');
    const importConfirmRows = document.getElementById('import-confirm-rows');
    const importConfirmNote = document.getElementById('import-confirm-note');

    const createInvTitle = document.getElementById('create-inv-title');
    const createInvSubtitle = document.getElementById('create-inv-subtitle');
    const formProduct = document.getElementById('form-product');
    const formLot = document.getElementById('form-lot');
    const formImport = document.getElementById('form-import');
    const formPreview = document.getElementById('form-preview');
    const btnChoiceProduct = document.getElementById('btn-choice-product');
    const btnChoiceLot = document.getElementById('btn-choice-lot');
    const btnChoiceImport = document.getElementById('btn-choice-import');
    const btnBack1 = document.getElementById('btn-back-1');
    const btnBack2 = document.getElementById('btn-back-2');
    const btnBack3 = document.getElementById('btn-back-3');
    const createInvScroll = document.getElementById('create-inv-scroll');

    const importFile = document.getElementById('import-file');
    const btnDownloadImportTemplate = document.getElementById('btn-download-import-template');
    const btnRunImport = document.getElementById('btn-run-import');
    const importResult = document.getElementById('import-result');

    const btnPreviewBack = document.getElementById('btn-preview-back');
    const btnImportValid = document.getElementById('btn-import-valid');
    const btnConfirmImport = document.getElementById('btn-confirm-import');
    const previewTbody = document.getElementById('preview-tbody');
    const previewResult = document.getElementById('preview-result');

    const previewCountTotal = document.getElementById('preview-count-total');
    const previewCountValid = document.getElementById('preview-count-valid');
    const previewCountErrors = document.getElementById('preview-count-errors');
    const previewCountNewCats = document.getElementById('preview-count-new-cats');
    const previewCountNewSups = document.getElementById('preview-count-new-sups');
    const previewCountExists = document.getElementById('preview-count-exists');
    const previewCardNewCats = document.getElementById('preview-card-new-cats');
    const previewCardNewSups = document.getElementById('preview-card-new-sups');
    const previewDrilldown = document.getElementById('preview-drilldown');
    const previewDrilldownTitle = document.getElementById('preview-drilldown-title');
    const previewDrilldownList = document.getElementById('preview-drilldown-list');
    const btnPreviewDrilldownBack = document.getElementById('btn-preview-drilldown-back');

    const modalCreateCat = document.getElementById('modal-create-category');
    const btnOpenCreateCat = document.getElementById('btn-open-create-cat');
    const btnCloseCreateCat = document.getElementById('btn-close-create-cat');
    const btnCancelCreateCat = document.getElementById('btn-cancel-create-cat');
    const btnSaveCreateCat = document.getElementById('btn-save-create-cat');
    const catName = document.getElementById('cat-name');
    const catMsg = document.getElementById('cat-msg');
    const catList = document.getElementById('cat-list');

    const modalEditLot = document.getElementById('modal-edit-lot');
    const btnCloseEditLot = document.getElementById('btn-close-edit-lot');
    const btnCancelEditLot = document.getElementById('btn-cancel-edit-lot');
    const btnSaveEditLot = document.getElementById('btn-save-edit-lot');
    const editLotSubtitle = document.getElementById('edit-lot-subtitle');
    const editLotProduct = document.getElementById('edit-lot-product');
    const editLotQty = document.getElementById('edit-lot-qty');
    const editLotCu = document.getElementById('edit-lot-cu');
    const editLotCode = document.getElementById('edit-lot-code');
    const editLotDate = document.getElementById('edit-lot-date');
    const editLotExp = document.getElementById('edit-lot-exp');
    const editLotSupplier = document.getElementById('edit-lot-supplier');
    const editLotSupplierId = document.getElementById('edit-lot-supplier-id');
    const btnSelectSupplierLotEdit = document.getElementById('btn-select-supplier-lot-edit');
    const linkCreateSupplierLotEdit = document.getElementById('link-create-supplier-lot-edit');
    const editLotNote = document.getElementById('edit-lot-note');
    const editLotMsg = document.getElementById('edit-lot-msg');
    const btnOpenAdjustLot = document.getElementById('btn-open-adjust-lot');

    const modalAdjustLot = document.getElementById('modal-adjust-lot');
    const btnCloseAdjustLot = document.getElementById('btn-close-adjust-lot');
    const btnCancelAdjustLot = document.getElementById('btn-cancel-adjust-lot');
    const btnSaveAdjustLot = document.getElementById('btn-save-adjust-lot');
    const adjustLotSubtitle = document.getElementById('adjust-lot-subtitle');
    const adjustLotProduct = document.getElementById('adjust-lot-product');
    const adjustLotConsumed = document.getElementById('adjust-lot-consumed');
    const adjustLotDate = document.getElementById('adjust-lot-date');
    const adjustLotQtyOld = document.getElementById('adjust-lot-qty-old');
    const adjustLotCuOld = document.getElementById('adjust-lot-cu-old');
    const adjustLotQtyNew = document.getElementById('adjust-lot-qty-new');
    const adjustLotCuNew = document.getElementById('adjust-lot-cu-new');
    const adjustLotNote = document.getElementById('adjust-lot-note');
    const adjustLotConfirm = document.getElementById('adjust-lot-confirm');
    const adjustLotMsg = document.getElementById('adjust-lot-msg');

    try {
        if (typeof flatpickr === 'function') {
            const commonOpts = {
                dateFormat: 'Y-m-d',
                allowInput: true,
                locale: (flatpickr && flatpickr.l10ns && flatpickr.l10ns.es) ? flatpickr.l10ns.es : undefined,
            };
            const commonOptsDmY = {
                dateFormat: 'd/m/Y',
                allowInput: true,
                locale: (flatpickr && flatpickr.l10ns && flatpickr.l10ns.es) ? flatpickr.l10ns.es : undefined,
            };
            if (typeof flatpickr.l10ns !== 'undefined' && flatpickr.l10ns.es) {
                try { flatpickr.localize(flatpickr.l10ns.es); } catch (e) { }
            }
            const lotDate = document.getElementById('lot-date');
            const lotExp = document.getElementById('lot-exp');
            if (lotDate) flatpickr(lotDate, commonOptsDmY);
            if (lotExp) flatpickr(lotExp, commonOptsDmY);
            if (editLotDate) flatpickr(editLotDate, commonOptsDmY);
            if (editLotExp) flatpickr(editLotExp, commonOptsDmY);
            if (prodLotDate) flatpickr(prodLotDate, commonOptsDmY);
            if (prodLotExp) flatpickr(prodLotExp, commonOptsDmY);
        }
    } catch (e) {
    }

    function todayIso() {
        try {
            return new Date().toISOString().slice(0, 10);
        } catch (e) {
            return '';
        }
    }

    function todayDisplay() {
        try {
            if (window.formatFechaDisplay) return window.formatFechaDisplay(new Date());
        } catch (e) {
        }
        try {
            const d = new Date();
            const dd = String(d.getDate()).padStart(2, '0');
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const yy = String(d.getFullYear());
            return dd + '/' + mm + '/' + yy;
        } catch (e) {
            return '';
        }
    }

    let editingLotId = '';
    let editingLotConsumedQty = 0;
    let canAdjustLot = false;

    try {
        const el = document.getElementById('inv-permissions');
        const parsed = el ? JSON.parse(String(el.textContent || '{}')) : {};
        canAdjustLot = !!parsed?.lot_adjust;
    } catch (e) {
        canAdjustLot = false;
    }

    function categoryLabel(p) {
        try {
            const co = p && (p.category_obj || p.categoryObj);
            const name = co && (co.name || co.label);
            if (name) return String(name || '').trim();
        } catch (e) {
        }
        try {
            const c = (p && (p.category || p.category_name)) ?? '';
            if (c && typeof c === 'string') return String(c).trim();
            if (c && typeof c === 'object') {
                const n = (c && (c.name || c.label)) ? String(c.name || c.label).trim() : '';
                return n || '';
            }
        } catch (e) {
        }
        return '';
    }

    const modalFile = document.getElementById('modal-product-file');
    const fileSubtitle = document.getElementById('file-subtitle');
    const btnEditFile = document.getElementById('btn-edit-file');
    const btnSaveFile = document.getElementById('btn-save-file');
    const btnCancelFile = document.getElementById('btn-cancel-file');
    const btnCloseFile = document.getElementById('btn-close-file');
    const btnCloseFileBottom = document.getElementById('btn-close-file-bottom');

    const fileScroll = document.getElementById('file-scroll');

    const fileNameView = document.getElementById('file-name-view');
    const fileName = document.getElementById('file-name');
    const fileCatView = document.getElementById('file-cat-view');
    const fileCat = document.getElementById('file-cat');
    const fileSku = document.getElementById('file-sku');
    const fileCodigoInterno = document.getElementById('file-codigo-interno');
    const fileCodigoInternoHint = document.getElementById('file-codigo-interno-hint');
    const fileVBarcode = document.getElementById('file-v-barcode');
    const fileBarcodeView = document.getElementById('file-barcode-view');
    const fileBarcode = document.getElementById('file-barcode');
    const fileBarcodeHint = document.getElementById('file-barcode-hint');
    const fileActiveView = document.getElementById('file-active-view');
    const fileActiveEditWrap = document.getElementById('file-active-edit-wrap');
    const fileActive = document.getElementById('file-active');
    const fileActiveLabel = document.getElementById('file-active-label');

    const fileSupplierView = document.getElementById('file-supplier-view');
    const fileSupplierEdit = document.getElementById('file-supplier-edit');
    const filePrimarySupplier = document.getElementById('file-primary-supplier');
    const filePrimarySupplierId = document.getElementById('file-primary-supplier-id');
    const btnSelectSupplierFile = document.getElementById('btn-select-supplier-file');
    const linkCreateSupplierFile = document.getElementById('link-create-supplier-file');

    const fileDescView = document.getElementById('file-desc-view');
    const fileDesc = document.getElementById('file-desc');

    const fileImagePreview = document.getElementById('file-image-preview');
    const fileImagePlaceholder = document.getElementById('file-image-placeholder');
    const fileImageView = document.getElementById('file-image-view');
    const fileImageEdit = document.getElementById('file-image-edit');
    const fileImage = document.getElementById('file-image');

    const fileMethodView = document.getElementById('file-method-view');
    const fileMethod = document.getElementById('file-method');
    const fileMethodLockMsg = document.getElementById('file-method-lock-msg');

    const fileStock = document.getElementById('file-stock');
    const fileMinView = document.getElementById('file-min-view');
    const fileMin = document.getElementById('file-min');
    const fileReorderView = document.getElementById('file-reorder-view');
    const fileReorder = document.getElementById('file-reorder');
    const fileStatus = document.getElementById('file-status');
    const fileLotsTbody = document.getElementById('file-lots-tbody');

    const fileViewCards = document.getElementById('file-view-cards');
    const fileVName = document.getElementById('file-v-name');
    const fileVCategory = document.getElementById('file-v-category');
    const fileVCodigoInterno = document.getElementById('file-v-codigo-interno');
    const fileVActive = document.getElementById('file-v-active');
    const fileVSupplier = document.getElementById('file-v-supplier');
    const fileVDesc = document.getElementById('file-v-desc');
    const fileVStock = document.getElementById('file-v-stock');
    const fileVMin = document.getElementById('file-v-min');
    const fileVReorder = document.getElementById('file-v-reorder');
    const fileVStatus = document.getElementById('file-v-status');
    const fileVMethod = document.getElementById('file-v-method');
    const fileVImagePreview = document.getElementById('file-v-image-preview');
    const fileVImagePlaceholder = document.getElementById('file-v-image-placeholder');
    const fileVImageOptional = document.getElementById('file-v-image-optional');

    const fileSecA = document.getElementById('file-sec-a');
    const fileSecB = document.getElementById('file-sec-b');
    const fileSecD = document.getElementById('file-sec-d');

    const btnFileChart15 = document.getElementById('file-chart-15');
    const btnFileChart30 = document.getElementById('file-chart-30');
    const btnFileChart60 = document.getElementById('file-chart-60');
    const btnFileChart90 = document.getElementById('file-chart-90');
    const fileChartMeta = document.getElementById('file-chart-meta');
    const fileChartWrap = document.getElementById('file-chart-wrap');
    const fileChartSvg = document.getElementById('file-chart-svg');
    const fileChartTooltip = document.getElementById('file-chart-tooltip');

    const modalSelectSupplier = document.getElementById('modal-select-supplier');
    const btnCloseSelectSupplier = document.getElementById('btn-close-select-supplier');
    const btnCancelSelectSupplier = document.getElementById('btn-cancel-select-supplier');
    const supplierModalSearch = document.getElementById('supplier-modal-search');
    const supplierModalList = document.getElementById('supplier-modal-list');
    const linkCreateSupplierFromInv = document.getElementById('link-create-supplier-from-inv');

    const prodName = document.getElementById('prod-name');
    const prodCatId = document.getElementById('prod-cat-id');
    const prodCodigoInterno = document.getElementById('prod-codigo-interno');
    const prodCodigoInternoHint = document.getElementById('prod-codigo-interno-hint');
    const prodBarcode = document.getElementById('prod-barcode');
    const prodBarcodeHint = document.getElementById('prod-barcode-hint');
    const prodActive = document.getElementById('prod-active');
    const prodActiveLabel = document.getElementById('prod-active-label');
    const prodImage = document.getElementById('prod-image');
    const prodImagePreview = document.getElementById('prod-image-preview');
    const prodImagePlaceholder = document.getElementById('prod-image-placeholder');
    const prodLots = document.getElementById('prod-lots');
    const prodLotsLabel = document.getElementById('prod-lots-label');
    const prodMethod = document.getElementById('prod-method');
    const prodMethodLockMsg = document.getElementById('prod-method-lock-msg');
    const prodMin = document.getElementById('prod-min');
    const prodReorder = document.getElementById('prod-reorder');
    const prodDesc = document.getElementById('prod-desc');
    const btnSaveProduct = document.getElementById('btn-save-product');
    const prodSalePrice = document.getElementById('prod-sale-price');
    const btnToggleProdExtra = document.getElementById('btn-toggle-prod-extra');
    const iconToggleProdExtra = document.getElementById('icon-toggle-prod-extra');
    const prodExtra = document.getElementById('prod-extra');

    const prodFirstLot = document.getElementById('prod-first-lot');
    const prodLotDate = document.getElementById('prod-lot-date');
    const prodLotSupplier = document.getElementById('prod-lot-supplier');
    const prodLotSupplierId = document.getElementById('prod-lot-supplier-id');
    const btnSelectSupplierProdLot = document.getElementById('btn-select-supplier-prod-lot');
    const prodLotCu = document.getElementById('prod-lot-cu');
    const prodLotQty = document.getElementById('prod-lot-qty');
    const prodLotCt = document.getElementById('prod-lot-ct');
    const prodLotExp = document.getElementById('prod-lot-exp');
    const prodLotNoExp = document.getElementById('prod-lot-no-exp');
    const prodLotNote = document.getElementById('prod-lot-note');

    const lotProduct = document.getElementById('lot-product');
    const lotDate = document.getElementById('lot-date');
    const lotSupplier = document.getElementById('lot-supplier');
    const lotSupplierId = document.getElementById('lot-supplier-id');
    const btnSelectSupplierLot = document.getElementById('btn-select-supplier-lot');
    const linkCreateSupplierLot = document.getElementById('link-create-supplier-lot');
    const lotCu = document.getElementById('lot-cu');
    const lotQty = document.getElementById('lot-qty');
    const lotCt = document.getElementById('lot-ct');
    const lotExp = document.getElementById('lot-exp');
    const lotNoExp = document.getElementById('lot-no-exp');
    const lotNote = document.getElementById('lot-note');
    const btnSaveLot = document.getElementById('btn-save-lot');

    const modalExport = document.getElementById('modal-export-inv');
    const btnCloseExport = document.getElementById('btn-close-export-inv');
    const btnCancelExport = document.getElementById('btn-cancel-export-inv');
    const btnExportPdf = document.getElementById('btn-export-inv-pdf');
    const btnExportXls = document.getElementById('btn-export-inv-xls');

    const modalEmptyInv = document.getElementById('modal-empty-inv');
    const emptyInvTitle = document.getElementById('empty-inv-title');
    const emptyInvSubtitle = document.getElementById('empty-inv-subtitle');
    const emptyInvPhrase = document.getElementById('empty-inv-phrase');
    const btnCloseEmptyInv = document.getElementById('btn-close-empty-inv');
    const btnCancelEmptyInv = document.getElementById('btn-cancel-empty-inv');
    const btnOkEmptyInv = document.getElementById('btn-ok-empty-inv');
    const inputEmptyInvConfirm = document.getElementById('empty-inv-confirm');
    const emptyInvMsg = document.getElementById('empty-inv-msg');

    let inventoryDangerAction = 'empty';

    const modalPrecios = document.getElementById('modal-precios-inv');
    const btnClosePrecios = document.getElementById('btn-close-precios-inv');
    const btnCancelPrecios = document.getElementById('btn-cancel-precios-inv');
    const btnSavePrecios = document.getElementById('btn-save-precios-inv');
    const preciosTbody = document.getElementById('precios-tbody');
    const preciosMsg = document.getElementById('precios-msg');
    const preciosQ = document.getElementById('precios-q');
    const preciosCat = document.getElementById('precios-cat');
    const preciosGlobalPct = document.getElementById('precios-global-pct');

    let activeTab = 'current';

    let cacheProducts = [];
    let cacheLots = [];
    let cacheMovements = [];
    let cacheCategories = [];
    let didLoadCategories = false;
    let suppliersCache = null;

    let inventoryHasLoaded = false;
    let inventoryLoading = false;
    let currentSupplierTarget = '';
    let suppressSupplierInputClear = false;

     let prefillLotProductId = '';
     const PRODUCT_DRAFT_KEY = 'inventory_product_draft_v1';

     function saveProductDraft() {
         try {
             const codigoInterno = String(prodCodigoInterno?.value || '').trim();
             const barcode = String(prodBarcode?.value || '').trim();
             const payload = {
                 name: String(prodName?.value || ''),
                 category_id: String(prodCatId?.value || ''),
                 codigo_interno: codigoInterno,
                 barcode: barcode,
                 active: true,
                 description: String(prodDesc?.value || ''),
                 uses_lots: true,
                 method: 'FIFO',
                 min_stock: String(prodMin?.value ?? ''),
                 reorder_point: String(prodReorder?.value ?? ''),
                 sale_price: String(prodSalePrice?.value ?? '')
             };
             sessionStorage.setItem(PRODUCT_DRAFT_KEY, JSON.stringify(payload));
         } catch (e) {
         }
     }

     function restoreProductDraft() {
         try {
             const raw = sessionStorage.getItem(PRODUCT_DRAFT_KEY);
             if (!raw) return;
             const d = JSON.parse(raw);
             if (!d || typeof d !== 'object') return;

             if (prodName && d.name != null) prodName.value = String(d.name || '');
             if (prodCatId && d.category_id != null) prodCatId.value = String(d.category_id || '');
             if (prodCodigoInterno && d.codigo_interno != null) prodCodigoInterno.value = String(d.codigo_interno || '');
             if (prodBarcode && d.barcode != null) prodBarcode.value = String(d.barcode || '');

             if (prodDesc && d.description != null) prodDesc.value = String(d.description || '');
             if (prodMin && d.min_stock != null) prodMin.value = String(d.min_stock ?? '');
             if (prodReorder && d.reorder_point != null) prodReorder.value = String(d.reorder_point ?? '');
             if (prodSalePrice && d.sale_price != null) prodSalePrice.value = formatMonedaARS(parseMonedaARS(d.sale_price));

             syncProductToggleLabels();
             sessionStorage.removeItem(PRODUCT_DRAFT_KEY);
         } catch (e) {
         }
     }

    function applyReturnedSupplierSelection() {
        try {
            const url = new URL(window.location.href);
            const supplierId = String(url.searchParams.get('supplier_id') || '').trim();
            const supplierName = String(url.searchParams.get('supplier_name') || '').trim();
            const target = String(url.searchParams.get('inv_supplier_target') || '').trim();
            if (!target) return;
            if (!supplierId && !supplierName) return;

            // Si ya restauramos el borrador del modal, NO re-abrimos (eso resetea inputs).
            const didRestoreDraft = !!window.__inv_draft_restored;
            if (!didRestoreDraft) {
                if (target === 'lot') {
                    openAddLot();
                } else if (target === 'prod_lot') {
                    openCreate();
                } else if (target === 'product') {
                    openCreate();
                    restoreProductDraft();
                } else {
                    // fallback: abrir el modal sin tocar formularios
                    try { abrirModal(modalCreate, true); } catch (e) { }
                }
            }

            currentSupplierTarget = target;
            setSupplierOnTarget({ id: supplierId, name: supplierName });

            suppliersCache = null;

            url.searchParams.delete('supplier_id');
            url.searchParams.delete('supplier_name');
            url.searchParams.delete('inv_supplier_target');
            window.history.replaceState({}, '', url.pathname + (url.searchParams.toString() ? ('?' + url.searchParams.toString()) : ''));
        } catch (e) {
        }
    }

    let fileProductId = '';
    let fileEditMode = false;
    let fileImageWasChanged = false;
    let fileChartDays = 30;
    let fileChartSeries = [];

    function parseNumeroSeguro(v) {
        const n = parseFloat(String(v ?? '').replace(',', '.'));
        return isNaN(n) ? 0 : n;
    }

    function parseMonedaARS(v) {
        if (window.parseCurrencyARS) return window.parseCurrencyARS(v);
        const s = String(v ?? '').replace(/\$/g, '').replace(/\s/g, '').replace(/\./g, '').replace(',', '.');
        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
    }

    function formatMonedaARS(v) {
        if (window.formatCurrencyARS) return window.formatCurrencyARS(v);
        const n = parseFloat(String(v ?? 0));
        const x = isNaN(n) ? 0 : n;
        try {
            const abs = Math.abs(x);
            const formatted = abs.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
            return (x < 0 ? '-$' : '$') + formatted;
        } catch (e) {
            return (x < 0 ? '-$' : '$') + String(Math.abs(x));
        }
    }

    function esc(v) {
        const s = String(v ?? '');
        return s
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#39;');
    }

    function fmtNumero(v) {
        return parseNumeroSeguro(v).toLocaleString('es-AR', { maximumFractionDigits: 2 });
    }

    function fmtMoneda(v) {
        return formatMonedaARS(parseNumeroSeguro(v));
    }

    function openAddLot() {
        resetCreateModal();
        abrirModal(modalCreate, true);
        try { if (createInvScroll) createInvScroll.scrollTop = 0; } catch (e) { }
        if (createInvTitle) createInvTitle.textContent = 'Agregar lote a un producto existente';
        if (createInvSubtitle) createInvSubtitle.textContent = 'Ingresá stock real con costo y vencimiento.';
        if (choiceWrap) choiceWrap.classList.add('hidden');
        if (formProduct) formProduct.classList.add('hidden');
        if (formLot) {
            formLot.classList.remove('hidden');
        }
        if (formImport) formImport.classList.add('hidden');
        if (formPreview) formPreview.classList.add('hidden');
        try {
            poblarProductosSelect();
            if (prefillLotProductId && lotProduct) {
                lotProduct.value = String(prefillLotProductId);
                prefillLotProductId = '';
            }
        } catch (e) {
        }

        try {
            if (lotDate && window.formatFechaDisplay) lotDate.value = window.formatFechaDisplay(new Date());
        } catch (e) {
        }

        try {
            if (lotNoExp) {
                lotNoExp.checked = true;
                lotNoExp.dispatchEvent(new Event('change', { bubbles: true }));
            }
        } catch (e) {
        }
    }

    function _dateToIso(d) {
        try {
            const yy = d.getFullYear();
            const mm = String(d.getMonth() + 1).padStart(2, '0');
            const dd = String(d.getDate()).padStart(2, '0');
            return yy + '-' + mm + '-' + dd;
        } catch (e) {
            return '';
        }
    }

    function _dateAddDays(d, days) {
        const x = new Date(d.getTime());
        x.setDate(x.getDate() + days);
        return x;
    }

    function buildStockSeriesFromMovements({ currentStock, movements, days }) {
        const now = new Date();
        now.setHours(0, 0, 0, 0);
        const end = now;
        const start = _dateAddDays(end, -(Math.max(1, parseInt(days || 30, 10)) - 1));

        const byDate = new Map();
        const byIn = new Map();
        const byOut = new Map();
        (Array.isArray(movements) ? movements : []).forEach(m => {
            const ds = String(m?.date || '').slice(0, 10);
            if (!ds) return;
            const t = new Date(ds + 'T00:00:00').getTime();
            if (isNaN(t)) return;
            if (t < start.getTime() || t > end.getTime()) return;
            const delta = parseNumeroSeguro(m?.qty_delta);
            byDate.set(ds, (byDate.get(ds) || 0) + delta);

            const rawType = String(m?.type || '').trim().toLowerCase();
            let inQty = 0;
            let outQty = 0;
            if (rawType === 'sale') {
                outQty = Math.max(0, -delta);
            } else if (rawType === 'purchase' || rawType === 'return') {
                inQty = Math.max(0, delta);
            } else {
                inQty = Math.max(0, delta);
                outQty = Math.max(0, -delta);
            }
            if (inQty) byIn.set(ds, (byIn.get(ds) || 0) + inQty);
            if (outQty) byOut.set(ds, (byOut.get(ds) || 0) + outQty);
        });

        const dates = [];
        for (let i = 0; i < Math.max(1, parseInt(days || 30, 10)); i++) {
            dates.push(_dateToIso(_dateAddDays(start, i)));
        }

        const seriesReversed = [];
        let stockEnd = parseNumeroSeguro(currentStock);
        for (let i = dates.length - 1; i >= 0; i--) {
            const ds = dates[i];
            const delta = byDate.get(ds) || 0;
            const inQty = byIn.get(ds) || 0;
            const outQty = byOut.get(ds) || 0;
            seriesReversed.push({ date: ds, stock: stockEnd, delta: delta, in_qty: inQty, out_qty: outQty });
            stockEnd = stockEnd - delta;
        }

        return seriesReversed.reverse();
    }

    function setFileChartButtons(days) {
        fileChartDays = parseInt(days || 30, 10);
        const d = fileChartDays;
        const setBtn = (btn, isActive) => {
            if (!btn) return;
            btn.classList.toggle('bg-white', isActive);
            btn.classList.toggle('shadow-sm', isActive);
            btn.classList.toggle('text-gray-900', isActive);
            btn.classList.toggle('text-gray-600', !isActive);
        };
        setBtn(btnFileChart15, d === 15);
        setBtn(btnFileChart30, d === 30);
        setBtn(btnFileChart60, d === 60);
        setBtn(btnFileChart90, d === 90);
    }

    function renderFileStockChart(series) {
        if (!fileChartSvg) return;
        const s = Array.isArray(series) ? series : [];
        fileChartSeries = s;

        const w = 640;
        const h = 200;
        const padL = 48;
        const padR = 12;
        const padT = 12;
        const padB = 30;

        const colStock = '#0d1067';
        const colIn = '#16a34a';
        const colOut = '#dc2626';

        const fmtShortDate = function (ds) {
            try {
                const d = new Date(String(ds || '').slice(0, 10) + 'T00:00:00');
                if (isNaN(d.getTime())) return String(ds || '').slice(5, 10);
                const dd = String(d.getDate()).padStart(2, '0');
                const mm = String(d.getMonth() + 1).padStart(2, '0');
                return dd + '/' + mm;
            } catch (e) {
                return String(ds || '').slice(5, 10);
            }
        };

        const fmtNum = function (v) {
            return parseNumeroSeguro(v).toLocaleString('es-AR', { maximumFractionDigits: 2 });
        };

        const stockValues = s.map(p => parseNumeroSeguro(p.stock));
        const inValues = s.map(p => parseNumeroSeguro(p.in_qty));
        const outValues = s.map(p => parseNumeroSeguro(p.out_qty));
        const all = stockValues.concat(inValues).concat(outValues);
        let minV = 0;
        let maxV = all.length ? Math.max.apply(null, all) : 0;
        if (!(maxV > 0)) maxV = 1;

        const plotW = w - padL - padR;
        const plotH = h - padT - padB;

        const xFor = (i) => {
            if (s.length <= 1) return padL;
            return padL + (i / (s.length - 1)) * plotW;
        };
        const yFor = (v) => {
            const vv = parseNumeroSeguro(v);
            const t = (vv - minV) / (maxV - minV);
            return (padT + plotH) - t * plotH;
        };

        const pathFor = function (key) {
            let d = '';
            s.forEach((p, i) => {
                const x = xFor(i);
                const y = yFor(p && p[key]);
                d += (i === 0 ? 'M' : 'L') + x.toFixed(2) + ' ' + y.toFixed(2) + ' ';
            });
            return d.trim();
        };

        const dStock = pathFor('stock');
        const dIn = pathFor('in_qty');
        const dOut = pathFor('out_qty');

        const yTicks = 4;
        const gridY = Array.from({ length: yTicks + 1 }).map((_, i) => {
            const t = i / yTicks;
            return (padT + plotH) - t * plotH;
        });

        const grid = gridY.map(y => '<line x1="' + padL + '" y1="' + y.toFixed(2) + '" x2="' + (w - padR) + '" y2="' + y.toFixed(2) + '" stroke="#F3F4F6" stroke-width="1" />').join('');
        const axisX = '<line x1="' + padL + '" y1="' + (padT + plotH).toFixed(2) + '" x2="' + (w - padR) + '" y2="' + (padT + plotH).toFixed(2) + '" stroke="#E5E7EB" stroke-width="1" />';
        const axisY = '<line x1="' + padL + '" y1="' + padT + '" x2="' + padL + '" y2="' + (padT + plotH) + '" stroke="#E5E7EB" stroke-width="1" />';

        const yLabels = gridY.map((y, i) => {
            const t = i / yTicks;
            const val = minV + t * (maxV - minV);
            return '<text x="' + (padL - 8) + '" y="' + (y + 4).toFixed(2) + '" text-anchor="end" font-size="10" fill="#6B7280">' + fmtNum(val) + '</text>';
        }).join('');

        const xTicks = Math.min(4, Math.max(2, s.length));
        const xLabelIdx = Array.from({ length: xTicks }).map((_, i) => {
            if (xTicks === 1) return 0;
            return Math.round((i / (xTicks - 1)) * (s.length - 1));
        });
        const xLabels = xLabelIdx.map(idx => {
            const x = xFor(idx);
            const ds = s[idx] ? s[idx].date : '';
            return '<text x="' + x.toFixed(2) + '" y="' + (h - 10) + '" text-anchor="middle" font-size="10" fill="#6B7280">' + fmtShortDate(ds) + '</text>';
        }).join('');

        const axisTitles = ''
            + '<text x="' + ((padL + (w - padR)) / 2).toFixed(2) + '" y="' + (h - 2) + '" text-anchor="middle" font-size="10" fill="#9CA3AF">Fecha</text>'
            + '<text x="12" y="' + ((padT + plotH / 2)).toFixed(2) + '" text-anchor="middle" font-size="10" fill="#9CA3AF" transform="rotate(-90 12 ' + ((padT + plotH / 2)).toFixed(2) + ')">Cantidad</text>';

        const area = '<path d="' + dStock + 'L ' + (w - padR) + ' ' + (padT + plotH) + ' L ' + padL + ' ' + (padT + plotH) + ' Z" fill="' + colStock + '" opacity="0.06" />';
        const pathStock = '<path d="' + dStock + '" fill="none" stroke="' + colStock + '" stroke-width="2" />';
        const pathIn = '<path d="' + dIn + '" fill="none" stroke="' + colIn + '" stroke-width="2" />';
        const pathOut = '<path d="' + dOut + '" fill="none" stroke="' + colOut + '" stroke-width="2" />';

        const overlay = '<rect id="file-chart-hit" x="' + padL + '" y="' + padT + '" width="' + plotW + '" height="' + plotH + '" fill="transparent" />';
        const hoverLayer = ''
            + '<g id="file-chart-hover" opacity="0">'
            + '  <line id="file-chart-vline" x1="0" y1="' + padT + '" x2="0" y2="' + (padT + plotH) + '" stroke="#CBD5E1" stroke-width="1" stroke-dasharray="3 3" />'
            + '  <circle id="file-chart-dot-stock" cx="0" cy="0" r="4" fill="' + colStock + '" stroke="#ffffff" stroke-width="2" />'
            + '  <circle id="file-chart-dot-in" cx="0" cy="0" r="4" fill="' + colIn + '" stroke="#ffffff" stroke-width="2" />'
            + '  <circle id="file-chart-dot-out" cx="0" cy="0" r="4" fill="' + colOut + '" stroke="#ffffff" stroke-width="2" />'
            + '</g>';

        fileChartSvg.innerHTML = grid + axisX + axisY + yLabels + xLabels + axisTitles + area + pathStock + pathIn + pathOut + hoverLayer + overlay;

        if (fileChartMeta) {
            const last = s.length ? s[s.length - 1] : null;
            if (!last) {
                fileChartMeta.textContent = '';
            } else {
                const st = fmtNum(last.stock);
                const inn = fmtNum(last.in_qty);
                const outt = fmtNum(last.out_qty);
                fileChartMeta.innerHTML = ''
                    + '<span class="inline-flex items-center gap-1">'
                    + '  <span class="inline-block h-2 w-2 rounded-full" style="background:' + colStock + '"></span>'
                    + '  <span>Stock: ' + st + '</span>'
                    + '</span>'
                    + '<span class="mx-2">·</span>'
                    + '<span class="inline-flex items-center gap-1">'
                    + '  <span class="inline-block h-2 w-2 rounded-full" style="background:' + colIn + '"></span>'
                    + '  <span>Ingresos: ' + inn + '</span>'
                    + '</span>'
                    + '<span class="mx-2">·</span>'
                    + '<span class="inline-flex items-center gap-1">'
                    + '  <span class="inline-block h-2 w-2 rounded-full" style="background:' + colOut + '"></span>'
                    + '  <span>Egresos: ' + outt + '</span>'
                    + '</span>';
            }
        }

        const hideTip = function () {
            if (!fileChartTooltip) return;
            fileChartTooltip.classList.add('hidden');
        };
        hideTip();

        const hit = fileChartSvg.querySelector('#file-chart-hit');
        const hover = fileChartSvg.querySelector('#file-chart-hover');
        const vline = fileChartSvg.querySelector('#file-chart-vline');
        const dotStock = fileChartSvg.querySelector('#file-chart-dot-stock');
        const dotIn = fileChartSvg.querySelector('#file-chart-dot-in');
        const dotOut = fileChartSvg.querySelector('#file-chart-dot-out');

        const updateHover = function (idx, ev) {
            const p = fileChartSeries[idx];
            if (!p || !fileChartWrap || !fileChartTooltip) return;
            const rect = fileChartWrap.getBoundingClientRect();
            const x = ev.clientX - rect.left;
            const y = ev.clientY - rect.top;

            const xSvg = xFor(idx);
            const yStock = yFor(p.stock);
            const yIn = yFor(p.in_qty);
            const yOut = yFor(p.out_qty);

            try {
                if (hover) hover.setAttribute('opacity', '1');
                if (vline) {
                    vline.setAttribute('x1', xSvg.toFixed(2));
                    vline.setAttribute('x2', xSvg.toFixed(2));
                }
                if (dotStock) {
                    dotStock.setAttribute('cx', xSvg.toFixed(2));
                    dotStock.setAttribute('cy', yStock.toFixed(2));
                }
                if (dotIn) {
                    dotIn.setAttribute('cx', xSvg.toFixed(2));
                    dotIn.setAttribute('cy', yIn.toFixed(2));
                }
                if (dotOut) {
                    dotOut.setAttribute('cx', xSvg.toFixed(2));
                    dotOut.setAttribute('cy', yOut.toFixed(2));
                }
            } catch (e) {
            }

            const delta = parseNumeroSeguro(p.delta);
            const deltaTxt = delta ? ('Δ ' + fmtNum(delta)) : 'Δ 0';
            fileChartTooltip.innerHTML = ''
                + '<div class="font-semibold text-gray-900">' + String(p.date) + '</div>'
                + '<div class="mt-1 space-y-0.5">'
                + '  <div class="text-gray-600 inline-flex items-center gap-1"><span class="inline-block h-2 w-2 rounded-full" style="background:' + colStock + '"></span><span>Stock: ' + fmtNum(p.stock) + '</span></div>'
                + '  <div class="text-gray-600 inline-flex items-center gap-1"><span class="inline-block h-2 w-2 rounded-full" style="background:' + colIn + '"></span><span>Ingresos: ' + fmtNum(p.in_qty) + '</span></div>'
                + '  <div class="text-gray-600 inline-flex items-center gap-1"><span class="inline-block h-2 w-2 rounded-full" style="background:' + colOut + '"></span><span>Egresos: ' + fmtNum(p.out_qty) + '</span></div>'
                + '  <div class="text-gray-600">' + deltaTxt + '</div>'
                + '</div>';
            fileChartTooltip.style.left = Math.min(Math.max(0, x + 10), rect.width - 140) + 'px';
            fileChartTooltip.style.top = Math.max(0, y + 10) + 'px';
            fileChartTooltip.classList.remove('hidden');
        };

        const hideHover = function () {
            hideTip();
            try { if (hover) hover.setAttribute('opacity', '0'); } catch (e) { }
        };

        if (hit) {
            hit.addEventListener('mousemove', function (ev) {
                if (!fileChartWrap) return;
                const rect = fileChartWrap.getBoundingClientRect();
                const x = ev.clientX - rect.left;
                if (!(s && s.length)) return;
                const t = (x - (padL / w) * rect.width) / ((plotW / w) * rect.width);
                const idx = Math.max(0, Math.min(s.length - 1, Math.round(t * (s.length - 1))));
                updateHover(idx, ev);
            });
            hit.addEventListener('mouseleave', hideHover);
        }
    }

    function refreshFileChart(productId, days) {
        const pid = String(productId || '').trim();
        if (!pid) return;
        const relLots = (Array.isArray(cacheLots) ? cacheLots : []).filter(l => String(l?.product_id) === pid);
        const currentStock = relLots.reduce((acc, l) => acc + parseNumeroSeguro(l?.qty_available), 0);
        setFileChartButtons(days);
        apiListMovements(pid).then(function (movs) {
            const series = buildStockSeriesFromMovements({ currentStock, movements: movs, days: fileChartDays });
            renderFileStockChart(series);
        }).catch(function () {
            renderFileStockChart(buildStockSeriesFromMovements({ currentStock, movements: [], days: fileChartDays }));
        });
    }

    function isPromise(x) {
        return !!x && typeof x.then === 'function';
    }

    function loadSuppliersCache() {
        if (Array.isArray(suppliersCache)) return Promise.resolve(suppliersCache);
        try {
            if (window.StorageService && typeof window.StorageService.getSuppliers === 'function') {
                const res = window.StorageService.getSuppliers();
                if (isPromise(res)) {
                    return res.then(function (list) {
                        suppliersCache = Array.isArray(list) ? list : [];
                        return suppliersCache;
                    }).catch(function () {
                        suppliersCache = [];
                        return suppliersCache;
                    });
                }
                suppliersCache = Array.isArray(res) ? res : [];
                return Promise.resolve(suppliersCache);
            }
        } catch (e) {
        }
        return apiListSuppliers('').then(function (list) {
            suppliersCache = Array.isArray(list) ? list : [];
            return suppliersCache;
        }).catch(function () {
            suppliersCache = [];
            return suppliersCache;
        });
    }

    function normalizeSupplierCats(s) {
        const cats = s && Array.isArray(s.categories) ? s.categories : [];
        return cats.map(x => String(x || '').trim()).filter(Boolean);
    }

    function openSupplierModal(target) {
        currentSupplierTarget = String(target || '').trim();
        if (!modalSelectSupplier) return;
        abrirModal(modalSelectSupplier, true);
        if (supplierModalSearch) supplierModalSearch.value = '';
        loadSuppliersCache().then(function () {
            renderSupplierModalList('');
            try { supplierModalSearch?.focus(); } catch (e) { }
        });
    }

    function closeSupplierModal() {
        if (!modalSelectSupplier) return;
        abrirModal(modalSelectSupplier, false);
    }

    function setSupplierOnTarget(s) {
        const id = String(s?.id || '').trim();
        const name = String(s?.name || '').trim();
        if (currentSupplierTarget === 'lot_edit') {
            suppressSupplierInputClear = true;
            if (editLotSupplierId) editLotSupplierId.value = id;
            if (editLotSupplier) editLotSupplier.value = name;
            suppressSupplierInputClear = false;
            return;
        }
        if (currentSupplierTarget === 'file') {
            suppressSupplierInputClear = true;
            const fileSupplierId = document.getElementById('file-primary-supplier-id');
            const fileSupplier = document.getElementById('file-primary-supplier');
            if (fileSupplierId) fileSupplierId.value = id;
            if (fileSupplier) fileSupplier.value = name;
            suppressSupplierInputClear = false;
            return;
        }
        if (currentSupplierTarget === 'prod_lot') {
            suppressSupplierInputClear = true;
            if (prodLotSupplierId) prodLotSupplierId.value = id;
            if (prodLotSupplier) prodLotSupplier.value = name;
            suppressSupplierInputClear = false;
            return;
        }
        if (currentSupplierTarget === 'lot') {
            suppressSupplierInputClear = true;
            if (lotSupplierId) lotSupplierId.value = id;
            if (lotSupplier) lotSupplier.value = name;
            suppressSupplierInputClear = false;
            return;
        }
        return;
    }

    function renderSupplierModalList(q) {
        if (!supplierModalList) return;
        const query = String(q || '').trim().toLowerCase();
        const list = Array.isArray(suppliersCache) ? suppliersCache : [];
        const filtered = list
            .filter(s => (s?.status || 'Active') !== 'Discontinued')
            .filter(s => {
                const cats = normalizeSupplierCats(s).map(x => String(x || '').trim().toLowerCase());
                return cats.includes('inventario');
            })
            .filter(s => {
                if (!query) return true;
                const name = String(s?.name || '').toLowerCase();
                return name.includes(query);
            })
            .slice(0, 300);

        supplierModalList.innerHTML = '';
        const head = document.createElement('div');
        head.className = 'sticky top-0 z-10 bg-gray-50 px-4 py-2 text-[11px] font-semibold text-gray-500 uppercase grid grid-cols-2 gap-3';
        head.innerHTML = '<div>Proveedor</div><div>Categorías</div>';
        supplierModalList.appendChild(head);

        if (!filtered.length) {
            const empty = document.createElement('div');
            empty.className = 'px-4 py-6 text-sm text-center text-gray-500';
            empty.textContent = 'Sin resultados.';
            supplierModalList.appendChild(empty);
            return;
        }

        filtered.forEach(function (s) {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'w-full text-left px-4 py-3 hover:bg-gray-50 grid grid-cols-2 gap-3';
            const cats = normalizeSupplierCats(s);
            const catsLabel = cats.length ? cats.join(' · ') : '—';
            btn.innerHTML = ''
                + '<div class="text-[11px] leading-4 font-semibold text-gray-900">' + String(s?.name || 'Proveedor') + '</div>'
                + '<div class="text-[9px] leading-4 text-gray-600">' + catsLabel + '</div>';
            btn.addEventListener('click', function () {
                setSupplierOnTarget(s);
                closeSupplierModal();
            });
            supplierModalList.appendChild(btn);
        });
    }

    function formatMoney(n) {
        const val = isNaN(n) ? 0 : n;
        return '$' + val.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    let preciosDraft = new Map();
    let preciosGlobalPctValue = null;

    function formatMoneyARS0(n) {
        const x = parseNumeroSeguro(n);
        const v = Math.round(x);
        try {
            const abs = Math.abs(v);
            const formatted = abs.toLocaleString('es-AR', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            return (v < 0 ? '-$' : '$') + formatted;
        } catch (e) {
            return (v < 0 ? '-$' : '$') + String(Math.abs(v));
        }
    }

    function roundPrecio(v) {
        const n = parseNumeroSeguro(v);
        if (!isFinite(n)) return 0;
        return Math.max(0, Math.round(n));
    }

    function getDraft(pid, oldP, unitCost) {
        const id = String(pid || '').trim();
        const base = roundPrecio(oldP);
        const d = preciosDraft.get(id);
        if (d && typeof d === 'object') return d;
        const pct = pctFromNewPrice(base, base);
        return { newPrice: base, pct: pct, dirty: false };
    }

    function unitCostForProduct(productId) {
        const pid = String(productId || '').trim();
        if (!pid) return 0;
        try {
            const lots = Array.isArray(cacheLots) ? cacheLots : [];
            const rel = lots.filter(l => String(l?.product_id || '') === pid);
            const stock = rel.reduce((acc, l) => acc + Math.max(0, parseNumeroSeguro(l?.qty_available)), 0);
            const costSum = rel.reduce((acc, l) => acc + (Math.max(0, parseNumeroSeguro(l?.qty_available)) * Math.max(0, parseNumeroSeguro(l?.unit_cost))), 0);
            const avg = stock > 0 ? (costSum / stock) : 0;
            return isFinite(avg) ? avg : 0;
        } catch (e) {
            return 0;
        }
    }

    function setDraft(pid, draft) {
        const id = String(pid || '').trim();
        if (!id) return;
        preciosDraft.set(id, { ...draft });
    }

    function setRowDirty(tr, isDirty) {
        if (!tr) return;
        tr.classList.toggle('bg-indigo-50', !!isDirty);
        tr.classList.toggle('transition-colors', true);
        tr.classList.toggle('duration-200', true);
        tr.setAttribute('data-dirty', isDirty ? '1' : '0');
    }

    function syncSaveButton() {
        const hasDirty = Array.from(preciosDraft.values()).some(d => !!d?.dirty);
        if (btnSavePrecios) {
            btnSavePrecios.disabled = !hasDirty;
            btnSavePrecios.classList.toggle('opacity-50', !hasDirty);
            btnSavePrecios.classList.toggle('cursor-not-allowed', !hasDirty);
        }
        if (preciosMsg) {
            if (!hasDirty) preciosMsg.textContent = 'Guardá para aplicar los cambios.';
        }
    }

    function fmtFecha(v) {
        try {
            if (window.formatFechaDisplay && typeof window.formatFechaDisplay === 'function') {
                return window.formatFechaDisplay(v);
            }
        } catch (e) {
        }
        return String(v ?? '');
    }

    function openPrecios() {
        abrirModal(modalPrecios, true);
        preciosDraft = new Map();
        preciosGlobalPctValue = null;
        if (preciosGlobalPct) preciosGlobalPct.value = '';
        syncSaveButton();
        if (preciosMsg) preciosMsg.textContent = 'Guardá para aplicar los cambios.';
        if (!Array.isArray(cacheProducts) || !cacheProducts.length) {
            if (preciosTbody) preciosTbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-sm text-center text-gray-500">Cargando productos…</td></tr>';
            loadProductsLots(function (products, lots, movements) {
                updateFilterOptions(products, lots);
                renderKPIs(products, lots);
                const vis = getVisibleRowsData();
                if (activeTab === 'current') renderCurrent(vis.filteredProducts);
                if (activeTab === 'lots') renderLots(vis.filteredLots);
                renderPreciosTable();
            });
            return;
        }
        renderPreciosTable();
    }

    function closePrecios() {
        abrirModal(modalPrecios, false);
    }

    function lastUnitCost(relLots) {
        const rel = Array.isArray(relLots) ? relLots : [];
        if (!rel.length) return 0;
        let best = null;
        let bestT = 0;
        let bestId = 0;
        rel.forEach(function (l) {
            const t = new Date(String(l?.received_at || '')).getTime() || 0;
            const id = parseInt(String(l?.id || 0), 10) || 0;
            if (!best) {
                best = l;
                bestT = t;
                bestId = id;
                return;
            }
            if (t > bestT || (t === bestT && id > bestId)) {
                best = l;
                bestT = t;
                bestId = id;
            }
        });
        return parseNumeroSeguro(best?.unit_cost);
    }

    function apiListProducts() {
        return fetch('/inventory/api/products?limit=5000&active=1', { credentials: 'same-origin' })
            .then(function (r) {
                if (!r || !r.ok) return [];
                return r.json().then(
                    (d) => (d && d.ok && Array.isArray(d.items)) ? d.items : [],
                    () => []
                );
            })
            .catch(function () { return []; });
    }

    function apiListSuppliers(q) {
        const qs = [];
        const query = String(q || '').trim();
        if (query) qs.push('q=' + encodeURIComponent(query));
        qs.push('limit=5000');
        const url = '/suppliers/api/suppliers' + (qs.length ? ('?' + qs.join('&')) : '');
        return fetch(url, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(d => (d && d.ok && Array.isArray(d.items)) ? d.items : []);
    }

    function apiListCategories() {
        return fetch('/inventory/api/categories?active=1&limit=5000', { credentials: 'same-origin' })
            .then(r => r.json())
            .then(d => (d && d.ok && Array.isArray(d.items)) ? d.items : []);
    }

    function apiCreateCategory(payload) {
        return fetch('/inventory/api/categories', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload || {})
        }).then(r => r.json());
    }

    function apiDeleteCategory(categoryId) {
        return fetch('/inventory/api/categories/' + encodeURIComponent(String(categoryId)), {
            method: 'DELETE',
            credentials: 'same-origin'
        }).then(r => r.json());
    }

    function apiGetMethodLock(productId) {
        return fetch('/inventory/api/products/' + encodeURIComponent(String(productId)) + '/method_lock', { credentials: 'same-origin' })
            .then(r => r.json());
    }

    function apiUploadProductImage(productId, file) {
        const fd = new FormData();
        fd.append('image', file);
        return fetch('/inventory/api/products/' + encodeURIComponent(String(productId)) + '/image', {
            method: 'POST',
            credentials: 'same-origin',
            body: fd
        }).then(r => r.json());
    }

    function apiListLots() {
        return fetch('/inventory/api/lots?limit=10000', { credentials: 'same-origin' })
            .then(function (r) {
                if (!r || !r.ok) return [];
                return r.json().then(
                    (d) => (d && d.ok && Array.isArray(d.items)) ? d.items : [],
                    () => []
                );
            })
            .catch(function () { return []; });
    }

    function apiListMovements(productId) {
        const qs = [];
        if (productId) qs.push('product_id=' + encodeURIComponent(String(productId)));
        qs.push('limit=2000');
        const url = '/inventory/api/movements' + (qs.length ? ('?' + qs.join('&')) : '');
        return fetch(url, { credentials: 'same-origin' })
            .then(function (r) {
                if (!r || !r.ok) return [];
                return r.json().then(
                    (d) => (d && d.ok && Array.isArray(d.items)) ? d.items : [],
                    () => []
                );
            })
            .catch(function () { return []; });
    }

    function apiCreateProduct(payload) {
        return fetch('/inventory/api/products', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload || {})
        }).then(r => r.json());
    }

    function apiUpdateProduct(productId, payload) {
        return fetch('/inventory/api/products/' + encodeURIComponent(String(productId)), {
            method: 'PUT',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload || {})
        }).then(r => r.json());
    }

    function apiDeleteProduct(productId) {
        return fetch('/inventory/api/products/' + encodeURIComponent(String(productId)), {
            method: 'DELETE',
            credentials: 'same-origin'
        }).then(r => r.json());
    }

    function apiHardDeleteProduct(productId) {
        return fetch('/inventory/api/products/' + encodeURIComponent(String(productId)) + '/hard', {
            method: 'DELETE',
            credentials: 'same-origin'
        }).then(r => r.json());
    }

    function apiCreateLot(payload) {
        return fetch('/inventory/api/lots', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload || {})
        }).then(r => r.json());
    }

    function apiBulkUpdatePrices(items) {
        return fetch('/inventory/api/products/prices', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ items: Array.isArray(items) ? items : [] })
        }).then(async function (r) {
            let data = null;
            try {
                data = await r.json();
            } catch (e) {
                data = null;
            }

            if (!r.ok) {
                const err = (data && (data.error || data.message)) ? String(data.error || data.message) : ('http_' + String(r.status || 'error'));
                return { ok: false, error: err, status: r.status };
            }
            if (!data || typeof data !== 'object') {
                return { ok: false, error: 'invalid_response' };
            }
            return data;
        });
    }

    function apiDeleteLot(lotId) {
        return fetch('/inventory/api/lots/' + encodeURIComponent(String(lotId)), {
            method: 'DELETE',
            credentials: 'same-origin'
        }).then(r => r.json());
    }

    function apiUpdateLot(lotId, payload) {
        return fetch('/inventory/api/lots/' + encodeURIComponent(String(lotId)), {
            method: 'PUT',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload || {})
        }).then(r => r.json());
    }

    function apiAdjustLot(lotId, payload) {
        return fetch('/inventory/api/lots/' + encodeURIComponent(String(lotId)) + '/adjust', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload || {})
        }).then(r => r.json());
    }

    function apiEmptyInventory(confirmText) {
        return fetch('/inventory/api/empty', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ confirm: String(confirmText || '') })
        }).then(r => r.json());
    }

    function apiClearInventory(confirmText) {
        return fetch('/inventory/api/clear', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ confirm: String(confirmText || '') })
        }).then(r => r.json());
    }

    function loadProductsLots(cb, opts) {
        const o = (opts && typeof opts === 'object') ? opts : {};
        const shouldLoadMovements = !!o.movements;
        const pRes = apiListProducts();
        const lRes = apiListLots();
        const mRes = shouldLoadMovements ? apiListMovements('') : Promise.resolve([]);
        return Promise.allSettled([Promise.resolve(pRes), Promise.resolve(lRes), Promise.resolve(mRes)]).then(function (results) {
            const getArr = function (idx) {
                try {
                    const r = results[idx];
                    if (!r || r.status !== 'fulfilled') return [];
                    return Array.isArray(r.value) ? r.value : [];
                } catch (e) {
                    return [];
                }
            };
            const products = getArr(0);
            const lots = getArr(1);
            const movements = getArr(2);
            cacheProducts = products;
            cacheLots = lots;
            cacheMovements = movements;
            if (typeof cb === 'function') cb(products, lots, movements);
        }).catch(function () {
            cacheProducts = [];
            cacheLots = [];
            cacheMovements = [];
            if (typeof cb === 'function') cb([], [], []);
        });
    }

    function loadCategories(cb) {
        return apiListCategories().then(function (cats) {
            cacheCategories = Array.isArray(cats) ? cats : [];
            if (typeof cb === 'function') cb(cacheCategories);
            return cacheCategories;
        }).catch(function () {
            cacheCategories = [];
            if (typeof cb === 'function') cb([]);
            return [];
        });
    }

    function refreshCategorySelect(selectedId) {
        if (!prodCatId) return;
        const cur = String(selectedId ?? prodCatId.value ?? '').trim();
        const cats = (Array.isArray(cacheCategories) ? cacheCategories : []).filter(c => !!c && c.active !== false);
        cats.sort((a, b) => String(a?.name || '').localeCompare(String(b?.name || '')));
        prodCatId.innerHTML = '<option value="">— Seleccionar —</option>';
        cats.forEach(c => {
            const opt = document.createElement('option');
            opt.value = String(c.id);
            opt.textContent = String(c.name || 'Categoría');
            prodCatId.appendChild(opt);
        });
        prodCatId.value = cur;
    }

    function badgeStatus(st) {
        if (st === 'Inactivo') return '<span class="px-2 py-0.5 rounded-full bg-gray-100 text-gray-700 text-[11px] font-medium">Inactivo</span>';
        if (st === 'Crítico') return '<span class="px-2 py-0.5 rounded-full bg-red-50 text-red-700 text-[11px] font-medium">Crítico</span>';
        if (st === 'Reponer') return '<span class="px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 text-[11px] font-medium">Reponer</span>';
        return '<span class="px-2 py-0.5 rounded-full bg-green-50 text-green-700 text-[11px] font-medium">OK</span>';
    }

    function statusBadgeHtml(st) {
        return badgeStatus(st);
    }

    function getStatus(stock, reorderPoint, minStock) {
        const s = parseNumeroSeguro(stock);
        const rp = parseNumeroSeguro(reorderPoint);
        const ms = parseNumeroSeguro(minStock);
        if (ms > 0 && s <= ms) return 'Crítico';
        if (rp > 0 && s <= rp) return 'Reponer';
        return 'OK';
    }

    function abrirModal(el, open) {
        if (!el) return;
        const willOpen = !!open;
        el.classList.toggle('hidden', !willOpen);
        try { el.setAttribute('aria-hidden', willOpen ? 'false' : 'true'); } catch (e) { }
        try {
            const anyOpen = Array.from(document.querySelectorAll('.fixed.inset-0.z-50')).some(m => !m.classList.contains('hidden'));
            document.body.classList.toggle('overflow-hidden', anyOpen);
        } catch (e) { }
    }

    let editingProductId = '';

    function syncProductToggleLabels() {
        if (prodActiveLabel) prodActiveLabel.textContent = (prodActive && prodActive.checked) ? 'Activo' : 'Inactivo';
        if (prodLotsLabel) prodLotsLabel.textContent = (prodLots && prodLots.checked) ? 'Sí' : 'No';
    }

    function syncFileToggleLabels() {
        if (fileActiveLabel) fileActiveLabel.textContent = (fileActive && fileActive.checked) ? 'Activo' : 'Inactivo';
    }

    function refreshFileCategorySelect(selectedId) {
        if (!fileCat) return;
        const cur = String(selectedId ?? fileCat.value ?? '').trim();
        const cats = (Array.isArray(cacheCategories) ? cacheCategories : []).filter(c => !!c && c.active !== false);
        cats.sort((a, b) => String(a?.name || '').localeCompare(String(b?.name || '')));
        fileCat.innerHTML = '<option value="">— Seleccionar —</option>';
        cats.forEach(c => {
            const opt = document.createElement('option');
            opt.value = String(c.id);
            opt.textContent = String(c.name || 'Categoría');
            fileCat.appendChild(opt);
        });
        fileCat.value = cur;
    }

    function setFileImagePreviewUrl(url) {
        const imgUrl = String(url || '').trim();
        const hasImg = !!imgUrl;

        if (fileImagePreview) {
            fileImagePreview.src = hasImg ? imgUrl : '';
            fileImagePreview.classList.toggle('hidden', !hasImg);
        }
        if (fileImagePlaceholder) fileImagePlaceholder.classList.toggle('hidden', hasImg);

        if (fileVImagePreview) {
            fileVImagePreview.src = hasImg ? imgUrl : '';
            fileVImagePreview.classList.toggle('hidden', !hasImg);
        }
        if (fileVImagePlaceholder) fileVImagePlaceholder.classList.toggle('hidden', hasImg);
        if (fileVImageOptional) fileVImageOptional.classList.toggle('hidden', hasImg);

        if (fileImageView) fileImageView.classList.toggle('hidden', hasImg);
    }

    function toggleFileEditMode(enable) {
        fileEditMode = !!enable;

        if (fileViewCards) fileViewCards.classList.toggle('hidden', fileEditMode);
        if (fileSecA) fileSecA.classList.toggle('hidden', !fileEditMode);
        if (fileSecB) fileSecB.classList.toggle('hidden', !fileEditMode);
        if (fileSecD) fileSecD.classList.toggle('hidden', fileEditMode);

        if (btnEditFile) btnEditFile.classList.toggle('hidden', fileEditMode);
        if (btnSaveFile) btnSaveFile.classList.toggle('hidden', !fileEditMode);
        if (btnCancelFile) btnCancelFile.classList.toggle('hidden', !fileEditMode);

        if (fileNameView) fileNameView.classList.toggle('hidden', fileEditMode);
        if (fileName) fileName.classList.toggle('hidden', !fileEditMode);

        if (fileCatView) fileCatView.classList.toggle('hidden', fileEditMode);
        if (fileCat) fileCat.classList.toggle('hidden', !fileEditMode);

        if (fileSku) fileSku.classList.toggle('hidden', fileEditMode);
        if (fileCodigoInterno) fileCodigoInterno.classList.toggle('hidden', !fileEditMode);
        if (fileCodigoInternoHint) fileCodigoInternoHint.classList.toggle('hidden', !fileEditMode);

        if (fileBarcodeView) fileBarcodeView.classList.toggle('hidden', fileEditMode);
        if (fileBarcode) fileBarcode.classList.toggle('hidden', !fileEditMode);
        if (fileBarcodeHint) fileBarcodeHint.classList.toggle('hidden', !fileEditMode);

        if (fileActiveView) fileActiveView.classList.toggle('hidden', fileEditMode);
        if (fileActiveEditWrap) fileActiveEditWrap.classList.toggle('hidden', !fileEditMode);
        syncFileToggleLabels();

        if (fileSupplierView) fileSupplierView.classList.toggle('hidden', fileEditMode);
        if (fileSupplierEdit) fileSupplierEdit.classList.toggle('hidden', !fileEditMode);

        if (fileDescView) fileDescView.classList.toggle('hidden', fileEditMode);
        if (fileDesc) fileDesc.classList.toggle('hidden', !fileEditMode);

        if (fileImageEdit) fileImageEdit.classList.toggle('hidden', !fileEditMode);

        if (fileMethodView) fileMethodView.classList.toggle('hidden', fileEditMode);
        if (fileMethod) fileMethod.classList.toggle('hidden', !fileEditMode);

        if (fileMinView) fileMinView.classList.toggle('hidden', fileEditMode);
        if (fileMin) fileMin.classList.toggle('hidden', !fileEditMode);
        if (fileReorderView) fileReorderView.classList.toggle('hidden', fileEditMode);
        if (fileReorder) fileReorder.classList.toggle('hidden', !fileEditMode);

        setFileCompactMode(!fileEditMode);
    }

    function setFileCompactMode(compact) {
        const c = !!compact;

        const setTitle = function (el) {
            if (!el) return;
            el.classList.toggle('text-sm', !c);
            el.classList.toggle('text-xs', c);
        };

        const setGrid = function (el) {
            if (!el) return;
            el.classList.toggle('gap-3', !c);
            el.classList.toggle('gap-2', c);
        };

        const setField = function (el) {
            if (!el) return;
            if (c) {
                el.classList.remove('px-3');
                el.classList.remove('py-2');
                el.classList.remove('text-sm');
                el.classList.remove('border');
                el.classList.remove('rounded-md');
                el.classList.remove('bg-gray-50');
                el.classList.add('px-0');
                el.classList.add('py-0');
                el.classList.add('text-xs');
                el.classList.add('text-gray-700');
            } else {
                el.classList.remove('px-0');
                el.classList.remove('py-0');
                el.classList.remove('text-xs');
                el.classList.remove('text-gray-700');
                el.classList.add('px-3');
                el.classList.add('py-2');
                el.classList.add('text-sm');
                el.classList.add('border');
                el.classList.add('rounded-md');
                el.classList.add('bg-gray-50');
            }
        };

        setTitle(document.getElementById('file-sec-a-title'));
        setTitle(document.getElementById('file-sec-b-title'));
        setTitle(document.getElementById('file-sec-c-title'));
        setTitle(document.getElementById('file-sec-d-title'));

        setGrid(document.getElementById('file-sec-a-grid'));
        setGrid(document.getElementById('file-sec-b-grid'));

        // Campos en modo vista
        setField(fileNameView);
        setField(fileCatView);
        setField(fileSku);
        setField(fileActiveView);
        setField(fileSupplierView);
        setField(fileDescView);
        setField(fileMethodView);
        setField(fileStock);
        setField(fileMinView);
        setField(fileReorderView);
        setField(fileStatus);

        // Ajustes de layout
        if (fileScroll) {
            fileScroll.classList.toggle('p-5', !c);
            fileScroll.classList.toggle('p-4', c);
        }

        const sections = document.getElementById('file-sections');
        if (sections) {
            sections.classList.toggle('space-y-5', !c);
            sections.classList.toggle('space-y-3', c);
        }

        const lotsWrap = document.getElementById('file-sec-c-wrap');
        if (lotsWrap) {
            lotsWrap.style.maxHeight = c ? '26vh' : '40vh';
            try {
                const cells = Array.from(lotsWrap.querySelectorAll('th,td'));
                cells.forEach(function (cell) {
                    cell.classList.toggle('px-4', !c);
                    cell.classList.toggle('py-3', !c);
                    cell.classList.toggle('px-3', c);
                    cell.classList.toggle('py-2', c);
                    cell.classList.toggle('text-sm', !c);
                    cell.classList.toggle('text-xs', c);
                });
            } catch (e) {
            }
        }

        const chartCard = document.getElementById('file-chart-card');
        if (chartCard) {
            chartCard.classList.toggle('p-3', !c);
            chartCard.classList.toggle('p-2', c);
        }

        if (fileChartSvg) {
            fileChartSvg.classList.toggle('h-48', !c);
            fileChartSvg.classList.toggle('h-36', c);
        }
    }

    function closeProductFile() {
        fileProductId = '';
        fileEditMode = false;
        fileImageWasChanged = false;
        if (fileImage) fileImage.value = '';
        toggleFileEditMode(false);
        abrirModal(modalFile, false);
    }

    function renderFileLots(productId) {
        if (!fileLotsTbody) return;
        const pid = String(productId || '').trim();
        const lots = (Array.isArray(cacheLots) ? cacheLots : [])
            .filter(l => String(l?.product_id) === pid)
            .slice();
        lots.sort((a, b) => String(b?.received_at || '').localeCompare(String(a?.received_at || '')));
        if (!lots.length) {
            fileLotsTbody.innerHTML = '<tr><td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">Todavía no hay lotes para este producto.</td></tr>';
            return;
        }
        fileLotsTbody.innerHTML = '';
        lots.forEach(l => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.innerHTML = ''
                + '<td class="px-4 py-3 text-sm text-gray-500">' + fmtFecha(l?.received_at || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + String(l?.lot_code || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-500">' + String(parseNumeroSeguro(l?.qty_initial).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-500">' + String(parseNumeroSeguro(l?.qty_available).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-500">' + formatMoney(parseNumeroSeguro(l?.unit_cost)) + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + String(l?.supplier_name || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + (l?.expiration_date ? fmtFecha(l.expiration_date) : '—') + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + (String(l?.note || '').trim() || '—') + '</td>'
                + '<td class="px-4 py-3 text-sm text-right">'
                + '  <button type="button" class="btn-edit-file-lot text-xs font-medium text-indigo-700 hover:text-indigo-900" data-lot-id="' + String(l?.id || '') + '">Editar</button>'
                + '</td>';
            fileLotsTbody.appendChild(tr);
        });
        Array.from(fileLotsTbody.querySelectorAll('.btn-edit-file-lot')).forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.getAttribute('data-lot-id') || '';
                openEditLot(id);
            });
        });
    }

    function openProductFile(productId) {
        const pid = String(productId || '').trim();
        if (!pid || !modalFile) return;

        fileProductId = pid;
        fileEditMode = false;
        fileImageWasChanged = false;
        if (fileVName) fileVName.textContent = '—';
        if (fileVCategory) fileVCategory.textContent = '—';
        if (fileVCodigoInterno) fileVCodigoInterno.textContent = '—';
        if (fileVBarcode) fileVBarcode.textContent = '—';
        if (fileVActive) fileVActive.textContent = '—';
        if (fileVSupplier) fileVSupplier.textContent = '—';
        if (fileVDesc) fileVDesc.textContent = '—';
        if (fileVStock) fileVStock.textContent = '—';
        if (fileVMin) fileVMin.textContent = '—';
        if (fileVReorder) fileVReorder.textContent = '—';
        if (fileVStatus) fileVStatus.textContent = '—';
        if (fileVMethod) fileVMethod.textContent = '—';
        if (fileSubtitle) fileSubtitle.textContent = 'Cargando…';
        if (fileLotsTbody) fileLotsTbody.innerHTML = '<tr><td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">Cargando…</td></tr>';
        if (fileChartSvg) fileChartSvg.innerHTML = '';
        toggleFileEditMode(false);
        abrirModal(modalFile, true);

        const ensure = (!Array.isArray(cacheProducts) || !cacheProducts.length)
            ? loadProductsLots
            : function (cb) { if (typeof cb === 'function') cb(cacheProducts, cacheLots, cacheMovements); };

        const maybePromise = ensure(function () {
            try {
                const prod = (Array.isArray(cacheProducts) ? cacheProducts : []).find(p => String(p?.id || '') === pid);
                if (!prod) {
                    if (window.showAlertModal) window.showAlertModal('No se encontró el producto seleccionado.', 'Atención', 'Legajo');
                    else alert('No se encontró el producto seleccionado.');
                    closeProductFile();
                    return;
                }

                fileProductId = pid;
                fileImageWasChanged = false;

                if (fileSubtitle) fileSubtitle.textContent = String(prod?.name || '');

                const catName = String(prod?.category?.name || prod?.category || '').trim();
                const supplierName = String(prod?.primary_supplier_name || '').trim();
                const supplierId = String(prod?.primary_supplier_id || '').trim();
                const internalCode = String(prod?.codigo_interno || prod?.internal_code || '').trim();
                const barcode = String(prod?.barcode || '').trim();

                if (fileNameView) fileNameView.textContent = String(prod?.name || '');
                if (fileName) fileName.value = String(prod?.name || '');

                if (fileVName) fileVName.textContent = String(prod?.name || '—');
                if (fileVCategory) fileVCategory.textContent = catName || '—';
                if (fileVCodigoInterno) fileVCodigoInterno.textContent = internalCode || '—';
                if (fileVBarcode) fileVBarcode.textContent = barcode || '—';
                if (fileVActive) fileVActive.textContent = (prod?.active !== false) ? 'Activo' : 'Inactivo';
                if (fileVSupplier) fileVSupplier.textContent = supplierName || '—';
                if (fileVDesc) fileVDesc.textContent = (String(prod?.description || '').trim() || '—');

                if (fileCatView) fileCatView.textContent = catName || '—';
                if (!didLoadCategories) {
                    didLoadCategories = true;
                    loadCategories(function () {
                        refreshCategorySelect(prodCatId?.value || '');
                        refreshFileCategorySelect(String(prod?.category_id || prod?.category?.id || ''));
                    });
                } else {
                    refreshFileCategorySelect(String(prod?.category_id || prod?.category?.id || ''));
                }

                const active = (prod?.active !== false);
                if (fileActiveView) fileActiveView.textContent = active ? 'Activo' : 'Inactivo';
                if (fileActive) fileActive.checked = active;
                syncFileToggleLabels();

                if (fileSku) fileSku.textContent = internalCode || '—';
                if (fileCodigoInterno) fileCodigoInterno.value = internalCode;
                if (fileBarcodeView) fileBarcodeView.textContent = barcode || '—';
                if (fileBarcode) fileBarcode.value = barcode;

                if (fileSupplierView) fileSupplierView.textContent = supplierName || '—';
                if (filePrimarySupplier) filePrimarySupplier.value = supplierName;
                if (filePrimarySupplierId) filePrimarySupplierId.value = supplierId;

                const desc = String(prod?.description || '').trim();
                if (fileDescView) fileDescView.textContent = desc || '—';
                if (fileDesc) fileDesc.value = desc;

                setFileImagePreviewUrl(String(prod?.image_url || '').trim());
                if (fileImage) fileImage.value = '';

                const method = String(prod?.method || 'FIFO').trim() || 'FIFO';
                const methodLabel = (method === 'Average') ? 'Costo promedio' : 'PEPS';
                if (fileMethodView) fileMethodView.textContent = methodLabel;
                if (fileMethod) fileMethod.value = method;
                if (fileVMethod) fileVMethod.textContent = methodLabel;

                try {
                    if (fileMethod && typeof apiGetMethodLock === 'function') {
                        apiGetMethodLock(pid).then(function (res) {
                            const locked = !!(res && res.ok && res.locked);
                            fileMethod.disabled = locked;
                            fileMethod.classList.toggle('bg-gray-50', locked);
                            if (fileMethodLockMsg) fileMethodLockMsg.classList.toggle('hidden', !locked);
                        }).catch(function () {
                        });
                    }
                } catch (e) {
                }

                try {
                    const relLots = (Array.isArray(cacheLots) ? cacheLots : []).filter(l => String(l?.product_id) === pid);
                    const stock = relLots.reduce((acc, l) => acc + parseNumeroSeguro(l?.qty_available), 0);
                    const status = getStatus(stock, prod?.reorder_point, prod?.min_stock);
                    const statusLabel = (status === 'Crítico') ? '🔴 Crítico' : (status === 'Reponer') ? '🟡 Atención' : '🟢 OK';

                    if (fileStock) fileStock.textContent = String(stock.toLocaleString('es-AR', { maximumFractionDigits: 2 }));
                    if (fileMinView) fileMinView.textContent = String(parseNumeroSeguro(prod?.min_stock).toLocaleString('es-AR', { maximumFractionDigits: 2 }));
                    if (fileMin) fileMin.value = String(prod?.min_stock ?? '');
                    if (fileReorderView) fileReorderView.textContent = String(parseNumeroSeguro(prod?.reorder_point).toLocaleString('es-AR', { maximumFractionDigits: 2 }));
                    if (fileReorder) fileReorder.value = String(prod?.reorder_point ?? '');
                    if (fileStatus) fileStatus.textContent = statusLabel;

                    if (fileVStock) fileVStock.textContent = String(stock.toLocaleString('es-AR', { maximumFractionDigits: 2 }));
                    if (fileVMin) fileVMin.textContent = String(parseNumeroSeguro(prod?.min_stock).toLocaleString('es-AR', { maximumFractionDigits: 2 }));
                    if (fileVReorder) fileVReorder.textContent = String(parseNumeroSeguro(prod?.reorder_point).toLocaleString('es-AR', { maximumFractionDigits: 2 }));
                    if (fileVStatus) fileVStatus.textContent = statusLabel;
                } catch (e) {
                }

                renderFileLots(pid);
                refreshFileChart(pid, fileChartDays || 30);
                toggleFileEditMode(false);
                abrirModal(modalFile, true);
                try { document.getElementById('file-scroll')?.scrollTo?.(0, 0); } catch (e) { }
            } catch (e) {
                try { console.error('openProductFile failed', e); } catch (err) { }
                if (window.showAlertModal) window.showAlertModal('No se pudo cargar el legajo. Revisá la consola para más detalles.', 'Error', 'Legajo');
                else alert('No se pudo cargar el legajo.');
            }
        });

        try {
            if (maybePromise && typeof maybePromise.catch === 'function') {
                maybePromise.catch(function () {
                    if (window.showAlertModal) window.showAlertModal('No se pudo cargar el legajo.', 'Error', 'Operación fallida');
                    else alert('No se pudo cargar el legajo.');
                    closeProductFile();
                });
            }
        } catch (e) {
        }
    }

    function saveProductFile() {
        const pid = String(fileProductId || '').trim();
        if (!pid) return;

        const name = String(fileName?.value || '').trim();
        const categoryId = String(fileCat?.value || '').trim();
        const codigoInterno = String(fileCodigoInterno?.value || '').trim();
        const barcode = String(fileBarcode?.value || '').trim();
        const desc = String(fileDesc?.value || '').trim();
        const primarySupplierName = String(filePrimarySupplier?.value || '').trim();
        const primarySupplierId = String(filePrimarySupplierId?.value || '').trim();
        const active = !!fileActive?.checked;

        const min = parseNumeroSeguro(fileMin?.value);
        const reorderPoint = parseNumeroSeguro(fileReorder?.value);

        if (!name) { if (window.showAlertModal) window.showAlertModal('Completá el nombre del producto.', 'Atención', 'Validación requerida'); else alert('Completá el nombre del producto.'); return; }
        if (!categoryId) { if (window.showAlertModal) window.showAlertModal('Seleccioná la categoría del producto.', 'Atención', 'Validación requerida'); else alert('Seleccioná la categoría del producto.'); return; }
        if (codigoInterno && (codigoInterno.length < 4 || codigoInterno.length > 12)) { if (window.showAlertModal) window.showAlertModal('El código interno debe tener entre 4 y 12 caracteres.', 'Atención', 'Validación requerida'); else alert('El código interno debe tener entre 4 y 12 caracteres.'); return; }
        if (codigoInterno && /\s/.test(codigoInterno)) { if (window.showAlertModal) window.showAlertModal('El código interno no admite espacios.', 'Atención', 'Validación requerida'); else alert('El código interno no admite espacios.'); return; }
        if (barcode && barcode.length > 64) { if (window.showAlertModal) window.showAlertModal('El código de barras admite hasta 64 caracteres.', 'Atención', 'Validación requerida'); else alert('El código de barras admite hasta 64 caracteres.'); return; }
        if (barcode && !/^[A-Za-z0-9]+$/.test(barcode)) { if (window.showAlertModal) window.showAlertModal('El código de barras solo admite letras y números.', 'Atención', 'Validación requerida'); else alert('El código de barras solo admite letras y números.'); return; }

        const payload = {
            name,
            category_id: parseInt(categoryId, 10),
            codigo_interno: codigoInterno,
            barcode: barcode,
            description: desc,
            primary_supplier_id: primarySupplierId,
            primary_supplier_name: primarySupplierName,
            active: active,
            min_stock: min,
            reorder_point: reorderPoint,
        };

        if (fileMethod && !fileMethod.disabled) {
            payload.method = String(fileMethod.value || '').trim() || 'FIFO';
        }

        apiUpdateProduct(pid, payload).then(function (res) {
            if (!res || res.ok !== true) {
                const err = String(res?.error || '').trim();
                const msg = (err === 'method_locked')
                    ? 'La metodología no puede modificarse una vez que el producto tiene movimientos.'
                    : 'No se pudo guardar el legajo.';
                if (window.showAlertModal) window.showAlertModal(msg, 'Error', 'Operación fallida');
                else alert(msg);
                return;
            }

            const item = res.item;
            if (item && item.id) {
                cacheProducts = (Array.isArray(cacheProducts) ? cacheProducts : []).map(p => (String(p?.id) === String(item.id)) ? item : p);
            }

            const file = (fileImage && fileImage.files && fileImage.files.length) ? fileImage.files[0] : null;
            if (fileImageWasChanged && file) {
                apiUploadProductImage(pid, file).then(function (res2) {
                    const item2 = res2?.item;
                    if (item2 && item2.id) {
                        cacheProducts = (Array.isArray(cacheProducts) ? cacheProducts : []).map(p => (String(p?.id) === String(item2.id)) ? item2 : p);
                    }
                    fileImageWasChanged = false;
                    if (fileImage) fileImage.value = '';
                    renderAll();
                    openProductFile(pid);
                }).catch(function () {
                    fileImageWasChanged = false;
                    if (fileImage) fileImage.value = '';
                    renderAll();
                    openProductFile(pid);
                });
                return;
            }

            renderAll();
            openProductFile(pid);
        }).catch(function () {
            if (window.showAlertModal) window.showAlertModal('No se pudo guardar el legajo.', 'Error', 'Operación fallida');
            else alert('No se pudo guardar el legajo.');
        });
    }

    function clearProductForm() {
        if (prodName) prodName.value = '';
        if (prodCatId) prodCatId.value = '';
        if (prodCodigoInterno) prodCodigoInterno.value = '';
        if (prodBarcode) prodBarcode.value = '';
        if (prodActive) prodActive.checked = true;
        if (prodReorder) prodReorder.value = '';
        if (prodLots) prodLots.checked = true;
        syncProductToggleLabels();
        if (prodMethod) prodMethod.value = 'FIFO';
        if (prodMethod) {
            prodMethod.disabled = false;
            prodMethod.classList.remove('bg-gray-50');
        }
        if (prodMethodLockMsg) prodMethodLockMsg.classList.add('hidden');
        if (prodMin) prodMin.value = '';
        if (prodDesc) prodDesc.value = '';
        if (prodSalePrice) prodSalePrice.value = '';
        if (prodImage) prodImage.value = '';
        if (prodImagePreview) {
            prodImagePreview.src = '';
            prodImagePreview.classList.add('hidden');
        }
        if (prodImagePlaceholder) prodImagePlaceholder.classList.remove('hidden');
        if (prodExtra) prodExtra.classList.add('hidden');
        if (btnToggleProdExtra) btnToggleProdExtra.setAttribute('aria-expanded', 'false');
        if (iconToggleProdExtra) {
            iconToggleProdExtra.classList.remove('fa-chevron-up');
            iconToggleProdExtra.classList.add('fa-chevron-down');
        }

        if (prodFirstLot) prodFirstLot.classList.remove('hidden');

        if (prodLotSupplier) prodLotSupplier.value = '';
        if (prodLotSupplierId) prodLotSupplierId.value = '';
        if (prodLotCu) prodLotCu.value = '';
        if (prodLotQty) prodLotQty.value = '';
        if (prodLotCt) prodLotCt.value = '$0';
        if (prodLotNoExp) prodLotNoExp.checked = true;
        if (prodLotExp) {
            prodLotExp.value = '';
            prodLotExp.disabled = true;
            prodLotExp.classList.add('bg-gray-50');
        }
        if (prodLotNote) prodLotNote.value = '';
    }

    function toIsoDate(raw) {
        const v = String(raw || '').trim();
        if (!v) return '';
        if (/^\d{4}-\d{2}-\d{2}$/.test(v)) return v;
        const m = v.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if (m) return m[3] + '-' + m[2] + '-' + m[1];
        return '';
    }

    function isoToDisplayDate(raw) {
        const v = String(raw || '').trim();
        if (!v) return '';
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(v)) return v;
        const m = v.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (m) return m[3] + '/' + m[2] + '/' + m[1];
        return '';
    }

    function updateProdLotCt() {
        const cu = parseMonedaARS(prodLotCu?.value);
        const qty = parseNumeroSeguro(prodLotQty?.value);
        const ct = cu * qty;
        if (prodLotCt) prodLotCt.value = formatMonedaARS(ct);
    }

    function resetCreateModal() {
        editingProductId = '';
        clearProductForm();
        if (choiceWrap) choiceWrap.classList.add('hidden');
        if (formProduct) formProduct.classList.add('hidden');
        if (formLot) formLot.classList.add('hidden');
        if (formImport) formImport.classList.add('hidden');
        if (formPreview) formPreview.classList.add('hidden');
        try { if (formProduct) formProduct.style.display = ''; } catch (e) { }
        try { if (formLot) formLot.style.display = ''; } catch (e) { }
        try { if (formImport) formImport.style.display = ''; } catch (e) { }
        try { if (formPreview) formPreview.style.display = ''; } catch (e) { }
    }

    function openEditProduct(productId) {
        const pid = String(productId || '').trim();
        if (!pid) return;
        const prod = (Array.isArray(cacheProducts) ? cacheProducts : []).find(p => String(p?.id || '') === pid);
        if (!prod) return;

        editingProductId = pid;
        resetCreateModal();
        abrirModal(modalCreate, true);
        try { if (createInvScroll) createInvScroll.scrollTop = 0; } catch (e) { }
        if (createInvTitle) createInvTitle.textContent = 'Editar producto';
        if (createInvSubtitle) createInvSubtitle.textContent = '';
        if (choiceWrap) choiceWrap.classList.add('hidden');
        if (formProduct) formProduct.classList.remove('hidden');
        try { if (formLot) formLot.style.display = ''; } catch (e) { }
        if (formImport) formImport.classList.add('hidden');
        if (formPreview) formPreview.classList.add('hidden');

        if (prodFirstLot) prodFirstLot.classList.add('hidden');

        if (prodName) prodName.value = String(prod?.name || '');
        if (prodCatId) prodCatId.value = String(prod?.category_id || prod?.category?.id || '');
        if (prodCodigoInterno) prodCodigoInterno.value = String(prod?.codigo_interno || prod?.internal_code || '');
        if (prodBarcode) prodBarcode.value = String(prod?.barcode || '');
        if (prodLots) prodLots.checked = !!prod?.uses_lots;
        if (prodMethod) prodMethod.value = String(prod?.method || 'FIFO');
        if (prodMin) prodMin.value = String(prod?.min_stock ?? '');
        if (prodReorder) prodReorder.value = String(prod?.reorder_point ?? '');
        if (prodSalePrice) prodSalePrice.value = formatMonedaARS(parseNumeroSeguro(prod?.sale_price));
        if (prodActive) prodActive.checked = (prod?.active !== false);
        if (prodDesc) prodDesc.value = String(prod?.description || '');
        syncProductToggleLabels();

        const imgUrl = String(prod?.image_url || '').trim();
        if (imgUrl && prodImagePreview) {
            prodImagePreview.src = imgUrl;
            prodImagePreview.classList.remove('hidden');
            if (prodImagePlaceholder) prodImagePlaceholder.classList.add('hidden');
        } else {
            if (prodImagePreview) {
                prodImagePreview.src = '';
                prodImagePreview.classList.add('hidden');
            }
            if (prodImagePlaceholder) prodImagePlaceholder.classList.remove('hidden');
        }

        if (!didLoadCategories) {
            didLoadCategories = true;
            loadCategories(function () {
                refreshCategorySelect(String(prod?.category_id || prod?.category?.id || ''));
            });
        } else {
            refreshCategorySelect(String(prod?.category_id || prod?.category?.id || ''));
        }

        if (prodMethod) {
            apiGetMethodLock(pid).then(function (res) {
                const locked = !!(res && res.ok && res.locked);
                prodMethod.disabled = locked;
                prodMethod.classList.toggle('bg-gray-50', locked);
                if (prodMethodLockMsg) prodMethodLockMsg.classList.toggle('hidden', !locked);
            }).catch(function () {
            });
        }
    }

    function openCreate() {
        resetCreateModal();
        abrirModal(modalCreate, true);
        try { if (createInvScroll) createInvScroll.scrollTop = 0; } catch (e) { }
        if (createInvTitle) createInvTitle.textContent = 'Crear ítem';
        if (createInvSubtitle) createInvSubtitle.textContent = '';
        if (choiceWrap) choiceWrap.classList.add('hidden');
        if (formProduct) formProduct.classList.remove('hidden');
        try { if (formLot) formLot.style.display = ''; } catch (e) { }
        if (formImport) formImport.classList.add('hidden');
        if (formPreview) formPreview.classList.add('hidden');

        if (prodFirstLot) prodFirstLot.classList.remove('hidden');
        if (!didLoadCategories) {
            didLoadCategories = true;
            loadCategories(function () {
                refreshCategorySelect('');
            });
        } else {
            refreshCategorySelect('');
        }
    }

    function closeCreate() {
        abrirModal(modalCreate, false);
    }

    function resetImportState() {
        try { previewRows = []; } catch (e) { }
        try {
            if (importFile) importFile.value = '';
        } catch (e) {
        }
        try {
            if (importResult) {
                importResult.classList.add('hidden');
                importResult.innerHTML = '';
            }
        } catch (e) {
        }
        try {
            if (previewResult) {
                previewResult.classList.add('hidden');
                previewResult.innerHTML = '';
            }
        } catch (e) {
        }
    }

    function openRegisterInventory() {
        resetCreateModal();
        abrirModal(modalCreate, true);
        try { if (createInvScroll) createInvScroll.scrollTop = 0; } catch (e) { }
        if (createInvTitle) createInvTitle.textContent = 'Registrar Inventario';
        if (createInvSubtitle) createInvSubtitle.textContent = 'Elegí una opción.';
        if (choiceWrap) choiceWrap.classList.remove('hidden');
        if (formProduct) formProduct.classList.add('hidden');
        if (formLot) formLot.classList.add('hidden');
        if (formImport) formImport.classList.add('hidden');
        if (formPreview) formPreview.classList.add('hidden');
        try {
            if (importFile) importFile.value = '';
            if (importResult) {
                importResult.classList.add('hidden');
                importResult.innerHTML = '';
            }
        } catch (e) {
        }
    }

    function openImportExcel() {
        try {
            if (createInvPanel) {
                createInvPanel.classList.remove('max-w-6xl');
                createInvPanel.classList.add('max-w-4xl');
            }
        } catch (e) { }
        resetCreateModal();
        abrirModal(modalCreate, true);
        try { if (createInvScroll) createInvScroll.scrollTop = 0; } catch (e) { }
        if (createInvTitle) createInvTitle.textContent = 'Importar inventario';
        if (createInvSubtitle) createInvSubtitle.textContent = 'Importación masiva por Excel.';
        if (choiceWrap) choiceWrap.classList.add('hidden');
        if (formProduct) formProduct.classList.add('hidden');
        if (formLot) formLot.classList.add('hidden');
        if (formImport) formImport.classList.remove('hidden');
        if (formPreview) formPreview.classList.add('hidden');
        try {
            if (importFile) importFile.value = '';
            if (importResult) {
                importResult.classList.add('hidden');
                importResult.innerHTML = '';
            }
        } catch (e) {
        }
    }

    function openPreviewScreen() {
        try {
            if (createInvPanel) {
                createInvPanel.classList.remove('max-w-4xl');
                createInvPanel.classList.add('max-w-6xl');
            }
        } catch (e) { }
        if (choiceWrap) choiceWrap.classList.add('hidden');
        if (formProduct) formProduct.classList.add('hidden');
        if (formLot) formLot.classList.add('hidden');
        if (formImport) formImport.classList.add('hidden');
        if (formPreview) formPreview.classList.remove('hidden');
        if (previewDrilldown) previewDrilldown.classList.add('hidden');
        try { if (createInvScroll) createInvScroll.scrollTop = 0; } catch (e) { }
    }

    function openPreviewDrilldown(kind) {
        const k = String(kind || '').trim();
        if (!previewDrilldown || !previewDrilldownList) return;
        const rows = (Array.isArray(previewRows) ? previewRows : []).filter(r => r && !r._deleted);

        let title = 'Detalle';
        let values = [];
        if (k === 'cats') {
            title = 'Categorías nuevas';
            values = rows.filter(r => !!r.will_create_category).map(r => String(r.categoria || '').trim()).filter(Boolean);
        } else if (k === 'sups') {
            title = 'Proveedores nuevos';
            values = rows.filter(r => !!r.will_create_supplier).map(r => String(r.proveedor || '').trim()).filter(Boolean);
        }
        const uniq = Array.from(new Set(values.map(v => v))).sort((a, b) => a.localeCompare(b));

        if (previewDrilldownTitle) previewDrilldownTitle.textContent = title;
        previewDrilldownList.innerHTML = '';
        if (!uniq.length) {
            previewDrilldownList.innerHTML = '<div class="px-3 py-3 text-sm text-gray-600">No hay elementos para mostrar.</div>';
        } else {
            uniq.forEach(function (name) {
                const row = document.createElement('div');
                row.className = 'px-3 py-3 text-sm text-gray-800 flex items-center justify-between';
                row.innerHTML = '<div class="font-medium">' + esc(name) + '</div><div class="text-[11px] text-gray-500">Se creará</div>';
                previewDrilldownList.appendChild(row);
            });
        }

        if (previewDrilldown) previewDrilldown.classList.remove('hidden');
        try {
            const tableWrap = previewDrilldown.closest('#form-preview')?.querySelector('.rounded-xl.border.border-gray-200.bg-white.overflow-hidden');
            if (tableWrap) tableWrap.classList.add('hidden');
        } catch (e) { }
        if (previewResult) previewResult.classList.add('hidden');
        try { if (createInvScroll) createInvScroll.scrollTop = 0; } catch (e) { }
    }

    function closePreviewDrilldown() {
        if (previewDrilldown) previewDrilldown.classList.add('hidden');
        try {
            const tableWrap = document.getElementById('form-preview')?.querySelector('.rounded-xl.border.border-gray-200.bg-white.overflow-hidden');
            if (tableWrap) tableWrap.classList.remove('hidden');
        } catch (e) { }
        renderPreviewTable();
        renderPreviewSummary();
    }

    function apiPreviewExcel(file) {
        const fd = new FormData();
        fd.append('file', file);
        return fetch('/inventory/api/import-excel/preview', {
            method: 'POST',
            credentials: 'same-origin',
            body: fd
        }).then(r => r.json());
    }

    function apiCommitExcel(rows) {
        return fetch('/inventory/api/import-excel/commit', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ rows: Array.isArray(rows) ? rows : [] })
        }).then(r => r.json());
    }

    let previewRows = [];

    function parseNumberRaw(raw) {
        const s = String(raw ?? '').trim();
        if (s === '') return { ok: true, value: null };
        const v = Number(String(s).replace(',', '.'));
        if (!isFinite(v)) return { ok: false, value: null };
        return { ok: true, value: v };
    }

    let pendingImportConfirmRows = [];

    function closeImportConfirm() {
        abrirModal(modalImportConfirm, false);
        pendingImportConfirmRows = [];
    }

    function countLotsFromRows(rows) {
        const list = Array.isArray(rows) ? rows : [];
        return list.filter(r => {
            const n = parseNumberRaw(r?.cantidad);
            return n.ok && (n.value || 0) > 0;
        }).length;
    }

    function openImportConfirm(opts) {
        const o = (opts && typeof opts === 'object') ? opts : {};
        const rows = Array.isArray(o.rows) ? o.rows : [];
        const mode = String(o.mode || '').trim() || 'all';
        const totalAll = Math.max(0, parseInt(String(o.totalAll ?? rows.length), 10) || rows.length);
        const skipped = Math.max(0, totalAll - rows.length);

        const items = rows.length;
        const lots = countLotsFromRows(rows);
        const newCats = rows.filter(r => !!r?.will_create_category).length;
        const newSups = rows.filter(r => !!r?.will_create_supplier).length;

        if (importConfirmTitle) importConfirmTitle.textContent = 'Confirmar importación';
        if (importConfirmSubtitle) importConfirmSubtitle.textContent = (mode === 'valid') ? 'Se importarán solo filas válidas.' : 'Se importarán todas las filas seleccionadas.';
        if (importConfirmItems) importConfirmItems.textContent = String(items);
        if (importConfirmLots) importConfirmLots.textContent = String(lots);
        if (importConfirmCats) importConfirmCats.textContent = String(newCats);
        if (importConfirmSups) importConfirmSups.textContent = String(newSups);
        if (importConfirmRows) importConfirmRows.textContent = String(items);
        if (importConfirmNote) {
            let msg = '';
            msg += 'Se crearán ' + String(items) + ' ítems';
            msg += ' y ' + String(lots) + ' lotes.';
            if (newCats > 0) msg += ' Categorías nuevas: ' + String(newCats) + '.';
            if (newSups > 0) msg += ' Proveedores nuevos: ' + String(newSups) + '.';
            if (mode === 'valid' && skipped > 0) msg += ' Filas descartadas: ' + String(skipped) + '.';
            importConfirmNote.textContent = msg;
        }

        pendingImportConfirmRows = rows;
        abrirModal(modalImportConfirm, true);
    }

    function isValidDateFlexible(raw) {
        const s = String(raw ?? '').trim();
        if (!s) return true;
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return true;
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) return true;
        return false;
    }

    function validatePreviewRow(r) {
        const d = r || {};
        const errs = {};
        const nombre = String(d.nombre ?? '').trim();
        const categoria = String(d.categoria ?? '').trim();
        const codigoInterno = String(d.codigo_interno ?? '').trim();
        const precio = parseNumberRaw(d.precio_lista);
        const cantidad = parseNumberRaw(d.cantidad);
        const cu = parseNumberRaw(d.costo_unitario);
        const venc = String(d.vencimiento ?? '').trim();

        if (!nombre) errs.nombre = 'Completá el nombre.';
        if (!categoria) errs.categoria = 'Completá la categoría.';
        if (!precio.ok) errs.precio_lista = 'Precio de lista debe ser numérico.';
        else if ((precio.value ?? 0) < 0) errs.precio_lista = 'Precio de lista debe ser ≥ 0.';

        if (!cantidad.ok) errs.cantidad = 'Cantidad debe ser numérica.';
        else if ((cantidad.value ?? 0) < 0) errs.cantidad = 'Cantidad debe ser ≥ 0.';

        if (!cu.ok) errs.costo_unitario = 'Costo unitario debe ser numérico.';
        else if ((cu.value ?? 0) < 0) errs.costo_unitario = 'Costo unitario debe ser ≥ 0.';

        if (codigoInterno && (codigoInterno.length < 4 || codigoInterno.length > 12)) errs.codigo_interno = 'Código interno: 4 a 12 caracteres.';
        else if (codigoInterno && /\s/.test(codigoInterno)) errs.codigo_interno = 'Código interno: sin espacios.';

        if (!isValidDateFlexible(venc)) errs.vencimiento = 'Vencimiento inválido (usa dd/mm/aaaa o yyyy-mm-dd).';

        r._errors = errs;
        r._errorCount = Object.keys(errs).length;
        r._isValid = r._errorCount === 0;
        return r;
    }

    function validateAllPreviewRows() {
        previewRows = (Array.isArray(previewRows) ? previewRows : []).map(function (r) {
            if (r && r._deleted) return r;
            return validatePreviewRow(r);
        });
    }

    function setCellErrorUI(inputEl, msg) {
        if (!inputEl) return;
        const hasErr = !!msg;
        inputEl.classList.toggle('border-red-300', hasErr);
        inputEl.classList.toggle('ring-1', hasErr);
        inputEl.classList.toggle('ring-red-200', hasErr);
        inputEl.title = hasErr ? String(msg) : '';
        try {
            const icon = inputEl.parentElement ? inputEl.parentElement.querySelector('.cell-err-icon') : null;
            if (icon) icon.classList.toggle('hidden', !hasErr);
        } catch (e) {
        }
    }

    function renderPreviewSummary() {
        const rows = (Array.isArray(previewRows) ? previewRows : []).filter(r => r && !r._deleted);
        const total = rows.length;
        const errRows = rows.filter(r => (r._errorCount || 0) > 0).length;
        const valid = total - errRows;
        const newCats = rows.filter(r => !!r.will_create_category).length;
        const newSups = rows.filter(r => !!r.will_create_supplier).length;
        const exists = rows.filter(r => !!r.product_exists).length;

        if (previewCountTotal) previewCountTotal.textContent = String(total);
        if (previewCountValid) previewCountValid.textContent = String(valid);
        if (previewCountErrors) previewCountErrors.textContent = String(errRows);
        if (previewCountNewCats) previewCountNewCats.textContent = String(newCats);
        if (previewCountNewSups) previewCountNewSups.textContent = String(newSups);
        if (previewCountExists) previewCountExists.textContent = String(exists);

        if (previewCardNewCats) {
            previewCardNewCats.disabled = !(newCats > 0);
            previewCardNewCats.classList.toggle('opacity-50', !(newCats > 0));
            previewCardNewCats.classList.toggle('cursor-not-allowed', !(newCats > 0));
        }
        if (previewCardNewSups) {
            previewCardNewSups.disabled = !(newSups > 0);
            previewCardNewSups.classList.toggle('opacity-50', !(newSups > 0));
            previewCardNewSups.classList.toggle('cursor-not-allowed', !(newSups > 0));
        }

        const canConfirm = errRows === 0 && total > 0;
        if (btnConfirmImport) {
            btnConfirmImport.disabled = !canConfirm;
            btnConfirmImport.classList.toggle('opacity-50', !canConfirm);
            btnConfirmImport.classList.toggle('cursor-not-allowed', !canConfirm);
        }
    }

    function renderPreviewTable() {
        if (!previewTbody) return;
        const rows = Array.isArray(previewRows) ? previewRows : [];
        previewTbody.innerHTML = '';
        rows.forEach(function (r, idx) {
            if (!r || r._deleted) return;
            const tr = document.createElement('tr');
            tr.className = 'align-top';
            if ((r._errorCount || 0) > 0) tr.classList.add('bg-red-50');

            const badge = function (txt, cls) {
                return '<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium ' + cls + '">' + esc(txt) + '</span>';
            };
            const flags = [];
            if (r.product_exists) flags.push(badge('Ya existe', 'bg-gray-100 text-gray-700'));
            else flags.push(badge('Nuevo', 'bg-indigo-50 text-indigo-700'));

            const td = function (html) {
                const el = document.createElement('td');
                el.className = 'px-3 py-2 text-sm text-gray-700 text-center align-top';
                el.innerHTML = html;
                return el;
            };

            const input = function (field, extraCls, placeholder) {
                const v = String(r[field] ?? '');
                const err = (r._errors && r._errors[field]) ? String(r._errors[field]) : '';
                return ''
                    + '<div class="relative">'
                    + '<input data-row-idx="' + idx + '" data-field="' + esc(field) + '" value="' + esc(v) + '" placeholder="' + esc(placeholder || '') + '"'
                    + ' class="w-full px-2 py-1.5 pr-8 text-sm border rounded-md text-center ' + (extraCls || '') + (err ? ' border-red-300 ring-1 ring-red-200' : ' border-gray-200') + '"'
                    + ' title="' + esc(err || '') + '">'
                    + '<span class="cell-err-icon pointer-events-none absolute inset-y-0 right-2 flex items-center text-red-500 ' + (err ? '' : 'hidden') + '"><i class="fas fa-exclamation-circle"></i></span>'
                    + '</div>';
            };

            const cellCategory = function () {
                const err = (r._errors && r._errors['categoria']) ? String(r._errors['categoria']) : '';
                const isNew = !!r.will_create_category;
                const extra = (isNew && !err) ? 'border-emerald-300 ring-1 ring-emerald-100 bg-emerald-50/40' : '';
                return '<div class="space-y-1">'
                    + input('categoria', extra, 'Categoría')
                    + (isNew ? '<div class="text-[11px] text-emerald-700">Nueva</div>' : '')
                    + '</div>';
            };

            const cellSupplier = function () {
                const err = (r._errors && r._errors['proveedor']) ? String(r._errors['proveedor']) : '';
                const isNew = !!r.will_create_supplier;
                const extra = (isNew && !err) ? 'border-emerald-300 ring-1 ring-emerald-100 bg-emerald-50/40' : '';
                return '<div class="space-y-1">'
                    + input('proveedor', extra, '')
                    + (isNew ? '<div class="text-[11px] text-emerald-700">Nuevo</div>' : '')
                    + '</div>';
            };

            tr.appendChild(td('<div class="flex flex-col items-center gap-1">'
                + '<div class="text-sm font-semibold text-gray-900">' + esc(r.row) + '</div>'
                + '<div class="space-x-1">' + flags.join(' ') + '</div>'
                + '<div class="text-[11px] text-gray-500">Err: ' + esc(r._errorCount || 0) + '</div>'
                + '</div>'));
            tr.appendChild(td(input('nombre', '', 'Nombre')));
            tr.appendChild(td(cellCategory()));
            tr.appendChild(td(input('codigo_interno', '', '')));
            tr.appendChild(td(input('precio_lista', '', '0')));
            tr.appendChild(td(input('descripcion', '', '')));
            tr.appendChild(td(input('cantidad', '', '0')));
            tr.appendChild(td(input('costo_unitario', '', '0')));
            tr.appendChild(td(cellSupplier()));
            tr.appendChild(td(input('vencimiento', '', 'dd/mm/aaaa')));
            tr.appendChild(td(input('nota_lote', '', '')));
            tr.appendChild(td(input('stock_minimo', '', '0')));
            tr.appendChild(td(input('punto_pedido', '', '0')));
            tr.appendChild(td('<button data-action="delete-row" data-row-idx="' + idx + '" type="button" class="inline-flex items-center justify-center px-3 py-2 text-sm font-medium rounded-md border border-gray-200 bg-white hover:bg-gray-50">Quitar</button>'));

            previewTbody.appendChild(tr);
        });

        // Attach events
        Array.from(previewTbody.querySelectorAll('input[data-row-idx][data-field]')).forEach(function (el) {
            el.addEventListener('input', function () {
                const ridx = parseInt(String(el.getAttribute('data-row-idx') || '0'), 10);
                const field = String(el.getAttribute('data-field') || '').trim();
                if (!isFinite(ridx) || !field) return;
                const row = previewRows[ridx];
                if (!row || row._deleted) return;
                row[field] = String(el.value ?? '');
                validatePreviewRow(row);
                setCellErrorUI(el, row._errors ? row._errors[field] : '');
                renderPreviewSummary();
                // update row error counter
                try {
                    const firstTd = el.closest('tr')?.querySelector('td');
                    const info = el.closest('tr')?.querySelector('td div.mt-1.text-\[11px\].text-gray-500');
                    if (info) info.textContent = 'Errores: ' + String(row._errorCount || 0);
                    if (el.closest('tr')) {
                        el.closest('tr').classList.toggle('bg-red-50', (row._errorCount || 0) > 0);
                    }
                } catch (e) {
                }
            });
        });

        Array.from(previewTbody.querySelectorAll('button[data-action="delete-row"][data-row-idx]')).forEach(function (btn) {
            btn.addEventListener('click', function () {
                const ridx = parseInt(String(btn.getAttribute('data-row-idx') || '0'), 10);
                const row = previewRows[ridx];
                if (!row) return;
                row._deleted = true;
                renderPreviewTable();
                renderPreviewSummary();
            });
        });
    }

    function apiImportExcel(file) {
        const fd = new FormData();
        fd.append('file', file);
        return fetch('/inventory/api/import-excel', {
            method: 'POST',
            credentials: 'same-origin',
            body: fd
        }).then(r => r.json());
    }

    function openExport() {
        abrirModal(modalExport, true);
    }

    function closeExport() {
        abrirModal(modalExport, false);
    }

    function closeDangerMenu() {
        if (!invDangerMenu) return;
        invDangerMenu.classList.add('hidden');
        try {
            if (btnInvDanger) btnInvDanger.setAttribute('aria-expanded', 'false');
        } catch (e) {
        }
    }

    function toggleDangerMenu() {
        if (!invDangerMenu) return;
        const willOpen = invDangerMenu.classList.contains('hidden');
        invDangerMenu.classList.toggle('hidden', !willOpen);
        try {
            if (btnInvDanger) btnInvDanger.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
        } catch (e) {
        }
    }

    function syncEmptyInvConfirmUi() {
        const v = String(inputEmptyInvConfirm?.value || '').trim().toLowerCase();
        const wanted = (inventoryDangerAction === 'clear') ? 'borrar inventario' : 'vaciar inventario';
        const ok = (v === wanted);
        if (btnOkEmptyInv) {
            btnOkEmptyInv.disabled = !ok;
            btnOkEmptyInv.classList.toggle('opacity-50', !ok);
            btnOkEmptyInv.classList.toggle('cursor-not-allowed', !ok);
        }
    }

    function openEmptyInv(action) {
        inventoryDangerAction = (action === 'clear') ? 'clear' : 'empty';
        const title = (inventoryDangerAction === 'clear') ? 'Borrar inventario' : 'Vaciar inventario';
        const subtitle = (inventoryDangerAction === 'clear')
            ? 'Acción peligrosa: borra inventario y elimina productos del módulo (se desactivan). No borra movimientos. No se puede deshacer.'
            : 'Acción peligrosa: elimina el inventario actual (lotes). No borra movimientos. No se puede deshacer.';
        const phrase = (inventoryDangerAction === 'clear') ? 'borrar inventario' : 'vaciar inventario';

        if (emptyInvTitle) emptyInvTitle.textContent = title;
        if (emptyInvSubtitle) emptyInvSubtitle.textContent = subtitle;
        if (emptyInvPhrase) emptyInvPhrase.textContent = phrase;
        if (emptyInvMsg) emptyInvMsg.textContent = '';
        if (inputEmptyInvConfirm) inputEmptyInvConfirm.value = '';
        try { if (inputEmptyInvConfirm) inputEmptyInvConfirm.setAttribute('placeholder', phrase); } catch (e) {}
        syncEmptyInvConfirmUi();
        abrirModal(modalEmptyInv, true);
        try { inputEmptyInvConfirm?.focus(); } catch (e) {}
    }

    function closeEmptyInv() {
        abrirModal(modalEmptyInv, false);
    }

    function switchTab(tab) {
        activeTab = tab;
        if (panelCurrent) panelCurrent.classList.toggle('hidden', tab !== 'current');
        if (panelLots) panelLots.classList.toggle('hidden', tab !== 'lots');
        if (tabCurrent) tabCurrent.classList.toggle('bg-white', tab === 'current');
        if (tabCurrent) tabCurrent.classList.toggle('shadow-sm', tab === 'current');
        if (tabCurrent) tabCurrent.classList.toggle('text-gray-900', tab === 'current');
        if (tabLots) tabLots.classList.toggle('bg-white', tab === 'lots');
        if (tabLots) tabLots.classList.toggle('shadow-sm', tab === 'lots');
        if (tabLots) tabLots.classList.toggle('text-gray-900', tab === 'lots');
        if (tabLots) tabLots.classList.toggle('text-gray-600', tab !== 'lots');
        if (tabCurrent) tabCurrent.classList.toggle('text-gray-600', tab !== 'current');
        renderAll();
    }

    function getVisibleRowsData() {
        const products = Array.isArray(cacheProducts) ? cacheProducts : [];
        const lots = Array.isArray(cacheLots) ? cacheLots : [];
        const q = String(filterQ?.value || '').trim().toLowerCase();
        const lotsSupQ = String(filterLotsSup?.value || '').trim().toLowerCase();
        const cat = String(filterCat?.value || '').trim();
        const stList = (filterStatus && filterStatus.selectedOptions)
            ? Array.from(filterStatus.selectedOptions).map(o => String(o.value || '').trim()).filter(Boolean)
            : [];

        const compute = (p) => {
            const rel = lots.filter(l => String(l.product_id) === String(p.id));
            const stock = rel.reduce((acc, l) => acc + parseNumeroSeguro(l.qty_available), 0);
            const costSum = rel.reduce((acc, l) => acc + (parseNumeroSeguro(l.qty_available) * parseNumeroSeguro(l.unit_cost)), 0);
            const avg = stock > 0 ? (costSum / stock) : lastUnitCost(rel);
            const status = getStatus(stock, p.reorder_point, p.min_stock);
            return { stock, avg, total: stock * avg, status };
        };

        const filteredProducts = products
            .filter(p => {
                const isInactive = (p && p.active === false);
                if (q && !String(p.name || '').toLowerCase().includes(q)) return false;
                if (cat && categoryLabel(p) !== cat) return false;

                const metrics = compute(p);
                if (isInactive) metrics.status = 'Inactivo';

                if (!stList.length) {
                    return false;
                }
                return stList.indexOf(metrics.status) >= 0;
            })
            .map(p => {
                const m = compute(p);
                if (p && p.active === false) m.status = 'Inactivo';
                return { p, m };
            });

        const filteredLots = lots
            .filter(l => {
                const p = products.find(x => String(x.id) === String(l.product_id));
                if (!p) return false;
                if (q && !String(p.name || '').toLowerCase().includes(q)) return false;
                if (lotsSupQ && !String(l?.supplier_name || '').toLowerCase().includes(lotsSupQ)) return false;
                return true;
            })
            .map(l => {
                const p = products.find(x => String(x.id) === String(l.product_id));
                return { l, p };
            });

        return { filteredProducts, filteredLots, products, lots };
    }

    function updateFilterOptions(products, lots) {
        if (filterCat) {
            const current = filterCat.value;
            const cats = Array.from(new Set(products.map(p => String(categoryLabel(p) || '').trim()).filter(Boolean))).sort();
            filterCat.innerHTML = '<option value="">Todas</option>';
            cats.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c;
                opt.textContent = c;
                filterCat.appendChild(opt);
            });
            filterCat.value = current;
        }
    }

    function renderKPIs(products, lots) {
        const days30 = 30 * 24 * 60 * 60 * 1000;
        const now = Date.now();
        const activeProducts = (Array.isArray(products) ? products : []).filter(p => !!p && p.active !== false);
        const activeIds = new Set(activeProducts.map(p => String(p.id)));

        const expSoon = lots.filter(l => {
            const exp = String(l.expiration_date || '').trim();
            if (!exp) return false;
            const t = new Date(exp).getTime();
            if (!t) return false;
            const pid = String(l.product_id || '').trim();
            if (!activeIds.has(pid)) return false;
            return t >= now && t <= (now + days30) && parseNumeroSeguro(l.qty_available) > 0;
        });
        const expSoonCount = expSoon.length;

        let totalValue = 0;
        let alerts = 0;
        const alertProducts = [];
        activeProducts.forEach(p => {
            const rel = lots.filter(l => String(l.product_id) === String(p.id));
            const stock = rel.reduce((acc, l) => acc + parseNumeroSeguro(l.qty_available), 0);
            const costSum = rel.reduce((acc, l) => acc + (parseNumeroSeguro(l.qty_available) * parseNumeroSeguro(l.unit_cost)), 0);
            const avg = stock > 0 ? (costSum / stock) : lastUnitCost(rel);
            totalValue += stock * avg;
            const st = getStatus(stock, p.reorder_point, p.min_stock);
            if (st !== 'OK') {
                alerts += 1;
                alertProducts.push({ name: String(p?.name || 'Producto'), status: st });
            }
        });
        alerts += expSoonCount;

        alertProducts.sort(function (a, b) {
            const rank = function (s) {
                if (s === 'Crítico') return 0;
                if (s === 'Reponer') return 1;
                return 2;
            };
            return rank(a.status) - rank(b.status) || String(a.name).localeCompare(String(b.name));
        });

        if (kpiStockValue) kpiStockValue.textContent = formatMoney(totalValue);
        if (kpiProducts) kpiProducts.textContent = String(activeProducts.length);
        if (kpiExpire) kpiExpire.textContent = String(expSoonCount);
        if (kpiAlerts) kpiAlerts.textContent = String(alerts);

        if (kpiAlertsList) {
            const maxItems = 6;
            const shown = alertProducts.slice(0, maxItems);
            if (!shown.length) {
                kpiAlertsList.innerHTML = '<div class="text-xs text-gray-500 text-center">Sin alertas de stock.</div>';
            } else {
                const first = shown[0];
                const rest = shown.slice(1);
                const firstTag = (first.status === 'Crítico') ? 'Crítico' : (first.status === 'Reponer') ? 'Reponer' : 'OK';
                const firstCls = (first.status === 'Crítico') ? 'text-red-700' : (first.status === 'Reponer') ? 'text-indigo-700' : 'text-gray-700';
                const firstRow = '<div class="flex items-center justify-between gap-2">'
                    + '<div class="truncate text-sm font-semibold text-gray-900">' + String(first.name) + '</div>'
                    + '<span class="shrink-0 inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold ' + (first.status === 'Crítico' ? 'bg-red-50 text-red-700' : first.status === 'Reponer' ? 'bg-indigo-50 text-indigo-700' : 'bg-green-50 text-green-700') + '">' + firstTag + '</span>'
                    + '</div>';

                const restRows = rest.map(it => {
                    const tag = (it.status === 'Crítico') ? 'Crítico' : (it.status === 'Reponer') ? 'Reponer' : 'OK';
                    const pill = (it.status === 'Crítico')
                        ? 'bg-red-50 text-red-700'
                        : (it.status === 'Reponer')
                            ? 'bg-indigo-50 text-indigo-700'
                            : 'bg-green-50 text-green-700';
                    return '<div class="flex items-center justify-between gap-2">'
                        + '<div class="truncate text-[11px] text-gray-700">' + String(it.name) + '</div>'
                        + '<span class="shrink-0 inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-semibold ' + pill + '">' + tag + '</span>'
                        + '</div>';
                }).join('');

                kpiAlertsList.innerHTML = firstRow + (restRows ? ('<div class="mt-2 space-y-1">' + restRows + '</div>') : '');
            }
            if (kpiAlertsHint) kpiAlertsHint.classList.toggle('hidden', shown.length > 0);
        }
    }

    function renderCurrent(filteredProducts) {
        if (!tbodyCurrent) return;
        if (!filteredProducts.length) {
            tbodyCurrent.innerHTML = '<tr><td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">No hay resultados para los filtros actuales.</td></tr>';
            return;
        }
        tbodyCurrent.innerHTML = '';
        filteredProducts.forEach(({ p, m }) => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            const imgUrl = String(p?.image_url || '').trim();
            const imgCell = imgUrl
                ? ('<img src="' + imgUrl + '" alt="" class="h-9 w-9 rounded-md object-cover border border-gray-200 bg-gray-50">')
                : ('<div class="h-9 w-9 rounded-md border border-gray-200 bg-gray-50 flex items-center justify-center text-gray-400"><i class="fas fa-image"></i></div>');
            const codigoInterno = String(p?.codigo_interno || p?.internal_code || '').trim();

            const isInactive = (p && p.active === false);
            const toggleText = isInactive ? 'Activar' : 'Inactivar';
            const toggleCls = isInactive ? 'text-green-700' : 'text-gray-700';

            tr.innerHTML = ''
                + '<td class="px-4 py-3 text-sm text-gray-700">' + imgCell + '</td>'
                + '<td class="px-4 py-3 text-sm font-medium text-gray-900">' + esc(p.name) + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-600">' + esc(categoryLabel(p)) + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-600">' + fmtNumero(m.stock) + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-600">' + fmtMoneda(m.avg) + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-600">' + fmtMoneda(m.total) + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-600">' + esc(codigoInterno || '—') + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-600">' + statusBadgeHtml(m.status) + '</td>'
                + '<td class="px-4 py-3 text-right">'
                + '  <div class="relative inline-flex">'
                + '    <button type="button" class="btn-actions-toggle h-8 w-8 inline-flex items-center justify-center rounded-md hover:bg-gray-100 text-gray-600">'
                + '      <i class="fas fa-ellipsis-v"></i>'
                + '    </button>'
                + '    <div class="row-actions-menu hidden absolute right-0 mt-2 w-44 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-30">'
                + '    <div class="py-1 text-[11px]">'
                + '      <button type="button" class="btn-view-file w-full text-left px-3 py-2 text-xs text-blue-700 hover:bg-gray-50" data-product-id="' + String(p.id) + '">Ver legajo</button>'
                + '      <button type="button" class="btn-add-lot-product w-full text-left px-3 py-2 text-xs text-blue-700 hover:bg-gray-50" data-product-id="' + String(p.id) + '">Agregar lote</button>'
                + '      <button type="button" class="btn-toggle-active-product w-full text-left px-3 py-2 text-xs ' + toggleCls + ' hover:bg-gray-50" data-product-id="' + String(p.id) + '" data-active="' + (isInactive ? '0' : '1') + '">' + toggleText + '</button>'
                + '      <button type="button" class="btn-hard-delete-product w-full text-left px-3 py-2 text-xs text-red-600 hover:bg-gray-50" data-product-id="' + String(p.id) + '">Eliminar</button>'
                + '    </div>'
                + '  </div>'
                + '  </div>'
                + '</td>';

            tbodyCurrent.appendChild(tr);
        });

        const closeAllMenus = function () {
            Array.from(tbodyCurrent.querySelectorAll('.row-actions-menu')).forEach(function (m) {
                m.classList.add('hidden');
            });
        };

        if (!window.__invRowActionsDocBound) {
            document.addEventListener('click', function (ev) {
                if (ev && ev.target && (ev.target.closest('.row-actions-menu') || ev.target.closest('.btn-actions-toggle'))) return;
                closeAllMenus();
            });
            window.__invRowActionsDocBound = true;
        }

        Array.from(tbodyCurrent.querySelectorAll('.btn-actions-toggle')).forEach(btn => {
            btn.addEventListener('click', function (ev) {
                ev.preventDefault();
                ev.stopPropagation();
                const wrap = this.closest('td');
                if (!wrap) return;
                const menu = wrap.querySelector('.row-actions-menu');
                if (!menu) return;
                const willOpen = menu.classList.contains('hidden');
                closeAllMenus();
                menu.classList.toggle('hidden', !willOpen);
            });
        });

        Array.from(tbodyCurrent.querySelectorAll('.row-actions-menu')).forEach(menu => {
            menu.addEventListener('click', function (ev) {
                ev.stopPropagation();
            });
        });

        Array.from(tbodyCurrent.querySelectorAll('.btn-view-file')).forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.getAttribute('data-product-id') || '';
                closeAllMenus();
                openProductFile(id);
            });
        });

        Array.from(tbodyCurrent.querySelectorAll('.btn-add-lot-product')).forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.getAttribute('data-product-id') || '';
                if (!id) return;
                closeAllMenus();

                const confirmFn = (window.confirmModal && typeof window.confirmModal === 'function')
                    ? window.confirmModal
                    : function (m) { return Promise.resolve(window.confirm(m)); };

                confirmFn('¿Querés agregar un lote a este producto?', 'Agregar lote', 'Se creará un nuevo lote.', { okText: 'Agregar', cancelText: 'Cancelar' })
                    .then(function (ok) {
                        if (!ok) return;
                        prefillLotProductId = String(id);
                        openAddLot();
                    });
            });
        });

        Array.from(tbodyCurrent.querySelectorAll('.btn-toggle-active-product')).forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.getAttribute('data-product-id') || '';
                if (!id) return;
                closeAllMenus();

                const prod = (Array.isArray(cacheProducts) ? cacheProducts : []).find(p => String(p?.id || '') === String(id));
                const isInactive = (prod && prod.active === false);

                const confirmFn = (window.confirmModal && typeof window.confirmModal === 'function')
                    ? window.confirmModal
                    : function (m) { return Promise.resolve(window.confirm(m)); };

                if (isInactive) {
                    confirmFn('¿Querés activar este producto?', 'Activar producto', 'Volverá a estar disponible en el inventario.', { okText: 'Activar', cancelText: 'Cancelar' })
                        .then(function (ok) {
                            if (!ok) return;
                            const payload = {
                                active: true,
                                description: String(prod?.description || ''),
                                barcode: String(prod?.barcode || ''),
                            };
                            apiUpdateProduct(id, payload).then(function (res) {
                                if (!res || res.ok !== true) {
                                    if (window.showAlertModal) window.showAlertModal('No se pudo activar el producto.', 'Error', 'Operación fallida');
                                    else alert('No se pudo activar el producto.');
                                    return;
                                }
                                renderAll();
                            }).catch(function () {
                                if (window.showAlertModal) window.showAlertModal('No se pudo activar el producto.', 'Error', 'Operación fallida');
                                else alert('No se pudo activar el producto.');
                            });
                        });
                    return;
                }

                confirmFn('¿Querés inactivar este producto?', 'Inactivar producto', 'Podés volver a activarlo más adelante.', { okText: 'Inactivar', cancelText: 'Cancelar' })
                    .then(function (ok) {
                        if (!ok) return;
                        apiDeleteProduct(id).then(function (res) {
                            if (!res || res.ok !== true) {
                                if (window.showAlertModal) window.showAlertModal('No se pudo inactivar el producto.', 'Error', 'Operación fallida');
                                else alert('No se pudo inactivar el producto.');
                                return;
                            }
                            renderAll();
                        }).catch(function () {
                            if (window.showAlertModal) window.showAlertModal('No se pudo inactivar el producto.', 'Error', 'Operación fallida');
                            else alert('No se pudo inactivar el producto.');
                        });
                    });
            });
        });

        Array.from(tbodyCurrent.querySelectorAll('.btn-hard-delete-product')).forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.getAttribute('data-product-id') || '';
                if (!id) return;
                closeAllMenus();

                const confirmFn = (window.confirmModal && typeof window.confirmModal === 'function')
                    ? window.confirmModal
                    : function (m) { return Promise.resolve(window.confirm(m)); };

                confirmFn('¿Seguro que querés eliminar este producto?', 'Eliminar producto', 'Se borrará definitivamente y no quedará registro.', { okText: 'Eliminar', cancelText: 'Cancelar' })
                    .then(function (ok) {
                        if (!ok) return;
                        apiHardDeleteProduct(id).then(function (res) {
                            if (!res || res.ok !== true) {
                                const err = String(res?.error || '').trim();
                                const msg = (err === 'not_found')
                                    ? 'El producto ya no existe.'
                                    : 'No se pudo eliminar el producto.';
                                if (window.showAlertModal) window.showAlertModal(msg, 'Error', 'Operación fallida');
                                else alert(msg);
                                return;
                            }
                            renderAll();
                        }).catch(function () {
                            if (window.showAlertModal) window.showAlertModal('No se pudo eliminar el producto.', 'Error', 'Operación fallida');
                            else alert('No se pudo eliminar el producto.');
                        });
                    });
            });
        });
    }

    function renderLots(filteredLots) {
        if (!tbodyLots) return;
        if (!filteredLots.length) {
            tbodyLots.innerHTML = '<tr><td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">No hay resultados para los filtros actuales.</td></tr>';
            return;
        }
        tbodyLots.innerHTML = '';
        filteredLots.forEach(({ l, p }) => {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            const imgUrl = String(p?.image_url || '').trim();
            const imgCell = imgUrl
                ? ('<img src="' + imgUrl + '" alt="" class="h-9 w-9 rounded-md object-cover border border-gray-200 bg-gray-50">')
                : ('<div class="h-9 w-9 rounded-md border border-gray-200 bg-gray-50 flex items-center justify-center text-gray-400"><i class="fas fa-image"></i></div>');
            const codigoInterno = String(l?.codigo_interno || p?.codigo_interno || p?.internal_code || '').trim();
            tr.innerHTML = ''
                + '<td class="px-4 py-3">' + imgCell + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-900">' + String(p?.name || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + esc(codigoInterno || '—') + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + fmtFecha(l.received_at || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-500">' + String(parseNumeroSeguro(l.qty_initial).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + formatMoney(parseNumeroSeguro(l.unit_cost)) + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + String(l.supplier_name || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + (l.expiration_date ? fmtFecha(l.expiration_date) : '—') + '</td>'
                + '<td class="px-4 py-3 text-sm text-right">'
                + '  <div class="relative inline-flex">'
                + '    <button type="button" class="btn-lot-actions-toggle h-8 w-8 inline-flex items-center justify-center rounded-md hover:bg-gray-100 text-gray-500" aria-label="Acciones" data-lot-id="' + String(l.id) + '" data-product-id="' + String(p?.id || '') + '">' 
                + '      <i class="fas fa-ellipsis-v"></i>'
                + '    </button>'
                + '    <div class="lot-actions-menu hidden absolute right-0 mt-2 w-44 rounded-md border border-gray-200 bg-white shadow-lg z-20">'
                + '      <button type="button" class="btn-lot-edit w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50" data-lot-id="' + String(l.id) + '">Editar lote</button>'
                + '      <button type="button" class="btn-lot-go-file w-full text-left px-3 py-2 text-xs text-gray-700 hover:bg-gray-50" data-product-id="' + String(p?.id || '') + '">Ir al legajo</button>'
                + '      <button type="button" class="btn-lot-delete w-full text-left px-3 py-2 text-xs text-red-600 hover:bg-gray-50" data-lot-id="' + String(l.id) + '">Eliminar lote</button>'
                + '    </div>'
                + '  </div>'
                + '</td>';
            tbodyLots.appendChild(tr);
        });

        const closeAllLotMenus = function () {
            Array.from(tbodyLots.querySelectorAll('.lot-actions-menu')).forEach(function (m) {
                m.classList.add('hidden');
            });
        };

        Array.from(tbodyLots.querySelectorAll('.btn-lot-actions-toggle')).forEach(btn => {
            btn.addEventListener('click', function (ev) {
                ev.preventDefault();
                ev.stopPropagation();
                const wrap = this.closest('td');
                if (!wrap) return;
                const menu = wrap.querySelector('.lot-actions-menu');
                if (!menu) return;
                const willOpen = menu.classList.contains('hidden');
                closeAllLotMenus();
                menu.classList.toggle('hidden', !willOpen);
            });
        });

        document.addEventListener('click', closeAllLotMenus, { once: true });

        Array.from(tbodyLots.querySelectorAll('.btn-lot-edit')).forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.getAttribute('data-lot-id') || '';
                closeAllLotMenus();
                openEditLot(id);
            });
        });

        Array.from(tbodyLots.querySelectorAll('.btn-lot-go-file')).forEach(btn => {
            btn.addEventListener('click', function () {
                const pid = this.getAttribute('data-product-id') || '';
                if (!pid) return;
                closeAllLotMenus();
                openProductFile(pid);
            });
        });

        Array.from(tbodyLots.querySelectorAll('.btn-lot-delete')).forEach(btn => {
            btn.addEventListener('click', function () {
                const id = this.getAttribute('data-lot-id') || '';
                if (!id) return;
                closeAllLotMenus();

                const confirmFn = (window.confirmModal && typeof window.confirmModal === 'function')
                    ? window.confirmModal
                    : function (m) { return Promise.resolve(window.confirm(m)); };

                confirmFn('¿Seguro que querés eliminar este lote?', 'Eliminar lote', 'Esta acción no se puede deshacer.', { okText: 'Eliminar', cancelText: 'Cancelar' })
                    .then(function (ok) {
                        if (!ok) return;
                        apiDeleteLot(id).then(function (res) {
                            if (!res || res.ok !== true) {
                                const err = String(res?.error || '').trim();
                                const msg = (err === 'lot_has_sales')
                                    ? 'No se puede eliminar: el lote ya tiene consumos registrados.'
                                    : 'No se pudo eliminar el lote.';
                                if (window.showAlertModal) window.showAlertModal(msg, 'Error', 'Operación fallida');
                                else alert(msg);
                                return;
                            }
                            cacheLots = (Array.isArray(cacheLots) ? cacheLots : []).filter(l => String(l?.id || '') !== String(id));
                            renderAll();
                        }).catch(function () {
                            if (window.showAlertModal) window.showAlertModal('No se pudo eliminar el lote.', 'Error', 'Operación fallida');
                            else alert('No se pudo eliminar el lote.');
                        });
                    });
            });
        });
    }

    function openEditLot(lotId) {
        const id = String(lotId || '').trim();
        if (!id || !modalEditLot) return;
        const lot = (Array.isArray(cacheLots) ? cacheLots : []).find(l => String(l?.id || '') === id);
        if (!lot) return;
        const prod = (Array.isArray(cacheProducts) ? cacheProducts : []).find(p => String(p?.id || '') === String(lot?.product_id || ''));

        editingLotId = id;
        if (editLotSubtitle) editLotSubtitle.textContent = String(prod?.name || lot?.product_name || '');
        if (editLotProduct) editLotProduct.textContent = String(prod?.name || lot?.product_name || '');
        if (editLotQty) editLotQty.value = String(parseNumeroSeguro(lot?.qty_initial) || '');
        if (editLotCu) editLotCu.value = formatMonedaARS(parseNumeroSeguro(lot?.unit_cost));

        if (editLotCode) editLotCode.value = String(lot?.lot_code || '');
        if (editLotDate) editLotDate.value = isoToDisplayDate(String(lot?.received_at || '').slice(0, 10));
        if (editLotExp) editLotExp.value = isoToDisplayDate(String(lot?.expiration_date || '').slice(0, 10));

        if (editLotSupplier) editLotSupplier.value = String(lot?.supplier_name || '');
        if (editLotSupplierId) editLotSupplierId.value = String(lot?.supplier_id || '');
        if (editLotNote) editLotNote.value = String(lot?.note || '');
        if (editLotMsg) editLotMsg.textContent = '';

        editingLotConsumedQty = 0;
        if (editLotQty) editLotQty.disabled = false;
        if (editLotCu) editLotCu.disabled = false;
        if (btnOpenAdjustLot) {
            const show = !!canAdjustLot;
            btnOpenAdjustLot.classList.toggle('hidden', !show);
            btnOpenAdjustLot.disabled = !show;
            btnOpenAdjustLot.classList.toggle('opacity-50', !show);
            btnOpenAdjustLot.classList.toggle('cursor-not-allowed', !show);
        }

        abrirModal(modalEditLot, true);

        try {
            const pid = String(lot?.product_id || '').trim();
            if (!pid) return;
            apiListMovements(pid).then(function (movs) {
                const safe = Array.isArray(movs) ? movs : [];
                try {
                    const existing = Array.isArray(cacheMovements) ? cacheMovements : [];
                    const rest = existing.filter(m => String(m?.product_id || '') !== pid);
                    cacheMovements = rest.concat(safe);
                } catch (e) {
                    cacheMovements = safe;
                }

                const consumed = safe
                    .filter(m => String(m?.type || '').trim() === 'sale')
                    .filter(m => String(m?.lot_id || '') === String(id))
                    .reduce((acc, m) => acc + Math.max(0, -parseNumeroSeguro(m?.qty_delta)), 0);
                editingLotConsumedQty = consumed;
                const hasSales = (editingLotConsumedQty > 1e-9);
                if (editLotQty) editLotQty.disabled = hasSales;
                if (editLotCu) editLotCu.disabled = hasSales;
                if (hasSales) {
                    if (editLotMsg) editLotMsg.textContent = 'Este lote ya tiene consumos. Para corregir cantidad/costo, usá “Ajustar lote”.';
                }
            }).catch(function () {
                editingLotConsumedQty = 0;
            });
        } catch (e) {
        }
    }

    function closeAdjustLot() {
        if (adjustLotMsg) adjustLotMsg.textContent = '';
        if (adjustLotConfirm) adjustLotConfirm.checked = false;
        abrirModal(modalAdjustLot, false);
    }

    function openAdjustLot() {
        const id = String(editingLotId || '').trim();
        if (!id || !modalAdjustLot) return;
        const lot = (Array.isArray(cacheLots) ? cacheLots : []).find(l => String(l?.id || '') === id);
        if (!lot) return;
        const prod = (Array.isArray(cacheProducts) ? cacheProducts : []).find(p => String(p?.id || '') === String(lot?.product_id || ''));

        const today = new Date();
        const isoToday = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');

        if (adjustLotSubtitle) adjustLotSubtitle.textContent = String(prod?.name || lot?.product_name || '');
        if (adjustLotProduct) adjustLotProduct.textContent = String(prod?.name || lot?.product_name || '');
        if (adjustLotConsumed) adjustLotConsumed.textContent = String(parseNumeroSeguro(editingLotConsumedQty).toLocaleString('es-AR', { maximumFractionDigits: 2 }));
        if (adjustLotDate) adjustLotDate.textContent = fmtFecha(isoToday);
        if (adjustLotQtyOld) adjustLotQtyOld.textContent = String(parseNumeroSeguro(lot?.qty_initial).toLocaleString('es-AR', { maximumFractionDigits: 2 }));
        if (adjustLotCuOld) adjustLotCuOld.textContent = formatMonedaARS(parseNumeroSeguro(lot?.unit_cost));

        if (adjustLotQtyNew) adjustLotQtyNew.value = String(parseNumeroSeguro(lot?.qty_initial) || '');
        if (adjustLotCuNew) adjustLotCuNew.value = formatMonedaARS(parseNumeroSeguro(lot?.unit_cost));
        if (adjustLotNote) adjustLotNote.value = '';
        if (adjustLotMsg) adjustLotMsg.textContent = '';
        if (adjustLotConfirm) adjustLotConfirm.checked = false;

        abrirModal(modalAdjustLot, true);
    }

    function saveAdjustLot() {
        const id = String(editingLotId || '').trim();
        if (!id) return;

        const qtyInitial = parseNumeroSeguro(adjustLotQtyNew?.value);
        const unitCost = parseMonedaARS(adjustLotCuNew?.value);
        const note = String(adjustLotNote?.value || '').trim();

        if (!(qtyInitial > 0)) {
            if (adjustLotMsg) adjustLotMsg.textContent = 'La cantidad debe ser mayor a 0.';
            return;
        }
        if (qtyInitial + 1e-9 < parseNumeroSeguro(editingLotConsumedQty)) {
            if (adjustLotMsg) adjustLotMsg.textContent = 'La cantidad nueva no puede ser menor a la cantidad ya consumida.';
            return;
        }
        if (!(unitCost >= 0)) {
            if (adjustLotMsg) adjustLotMsg.textContent = 'El costo unitario no puede ser negativo.';
            return;
        }
        if (!(adjustLotConfirm && adjustLotConfirm.checked)) {
            if (adjustLotMsg) adjustLotMsg.textContent = 'Confirmá el ajuste para continuar.';
            return;
        }

        const today = new Date();
        const isoToday = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');

        if (adjustLotMsg) adjustLotMsg.textContent = 'Aplicando ajuste…';
        apiAdjustLot(id, {
            qty_initial: qtyInitial,
            unit_cost: unitCost,
            note: note,
            date: isoToday,
        }).then(function (res) {
            if (!res || res.ok !== true) {
                const err = String(res?.error || '').trim();
                const det = String(res?.details || '').trim();
                const msg = (err === 'qty_below_consumed')
                    ? 'La cantidad nueva no puede ser menor a lo consumido.'
                    : (err === 'qty_required')
                        ? 'La cantidad debe ser mayor a 0.'
                        : (err === 'unit_cost_invalid')
                            ? 'El costo unitario no puede ser negativo.'
                            : (err === 'no_company')
                                ? 'Empresa no detectada. Reintentá recargando la página.'
                                : (err === 'forbidden')
                                    ? 'No tenés permisos para ajustar lotes.'
                                    : (err === 'db_error')
                                        ? ('No se pudo aplicar el ajuste.' + (det ? (' (' + det + ')') : ''))
                                        : ('No se pudo aplicar el ajuste.' + (err ? (' (' + err + ')') : ''));
                if (adjustLotMsg) adjustLotMsg.textContent = msg;
                return;
            }

            try {
                const item = res.item;
                if (item && item.id) {
                    cacheLots = (Array.isArray(cacheLots) ? cacheLots : []).map(l => (String(l?.id) === String(item.id)) ? item : l);
                }
            } catch (e) {
            }

            try {
                const adjId = String(res?.created?.adjustment_id || '').trim();
                if (adjId && window.showAlertModal) {
                    window.showAlertModal('Ajuste aplicado. ID: ' + adjId, 'Listo', 'Ajustar lote');
                }
            } catch (e) {
            }

            closeAdjustLot();
            closeEditLot();
            renderAll();
        }).catch(function () {
            if (adjustLotMsg) adjustLotMsg.textContent = 'No se pudo aplicar el ajuste.';
        });
    }

    function closeEditLot() {
        editingLotId = '';
        editingLotConsumedQty = 0;
        if (editLotMsg) editLotMsg.textContent = '';
        abrirModal(modalEditLot, false);
    }

    function saveEditLot() {
        const id = String(editingLotId || '').trim();
        if (!id) return;

        const qtyInitial = parseNumeroSeguro(editLotQty?.value);
        const unitCost = parseMonedaARS(editLotCu?.value);

        const payload = {
            lot_code: String(editLotCode?.value || '').trim(),
            date: toIsoDate(String(editLotDate?.value || '').trim()),
            expiration_date: toIsoDate(String(editLotExp?.value || '').trim()),
            supplier_id: String(editLotSupplierId?.value || '').trim(),
            supplier_name: String(editLotSupplier?.value || '').trim(),
            note: String(editLotNote?.value || '').trim(),
            qty_initial: qtyInitial,
            unit_cost: unitCost,
        };

        if (!payload.date) {
            if (editLotMsg) editLotMsg.textContent = 'Completá la fecha de ingreso.';
            return;
        }
        if (!payload.supplier_name) {
            if (editLotMsg) editLotMsg.textContent = 'Completá el proveedor.';
            return;
        }

        if (!(payload.qty_initial > 0)) {
            if (editLotMsg) editLotMsg.textContent = 'La cantidad debe ser mayor a 0.';
            return;
        }
        if (!(payload.unit_cost >= 0)) {
            if (editLotMsg) editLotMsg.textContent = 'El costo unitario no puede ser negativo.';
            return;
        }

        if (editLotMsg) editLotMsg.textContent = 'Guardando…';
        apiUpdateLot(id, payload).then(function (res) {
            if (!res || res.ok !== true) {
                const err = String(res?.error || '').trim();
                const msg = (err === 'supplier_not_found')
                    ? 'Proveedor inválido.'
                    : (err === 'lot_has_sales')
                        ? 'No se puede cambiar cantidad/costo porque el lote ya tiene consumos registrados.'
                        : (err === 'qty_required')
                            ? 'La cantidad debe ser mayor a 0.'
                            : (err === 'unit_cost_invalid')
                                ? 'El costo unitario no puede ser negativo.'
                                : 'No se pudo guardar el lote.';
                if (editLotMsg) editLotMsg.textContent = msg;
                return;
            }
            const item = res.item;
            if (item && item.id) {
                cacheLots = (Array.isArray(cacheLots) ? cacheLots : []).map(l => (String(l?.id) === String(item.id)) ? item : l);
            }
            closeEditLot();
            renderAll();
        }).catch(function () {
            if (editLotMsg) editLotMsg.textContent = 'No se pudo guardar el lote.';
        });
    }

    function renderAll() {
        if (inventoryLoading) return;
        if (!inventoryHasLoaded) {
            if (tbodyCurrent) tbodyCurrent.innerHTML = '<tr><td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">Cargando inventario…</td></tr>';
            if (tbodyLots) tbodyLots.innerHTML = '<tr><td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">Cargando inventario…</td></tr>';
        }
        if (!didLoadCategories) {
            didLoadCategories = true;
            loadCategories(function () {
                refreshCategorySelect(prodCatId?.value || '');
            });
        }
        inventoryLoading = true;
        loadProductsLots(function (products, lots, movements) {
            inventoryLoading = false;
            inventoryHasLoaded = true;
            updateFilterOptions(products, lots);
            renderKPIs(products, lots);

            const allP = Array.isArray(products) ? products : [];
            if (!allP.length) {
                if (tbodyCurrent) tbodyCurrent.innerHTML = '<tr><td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">Todavía no hay productos. Usá “Crear ítem” para comenzar.</td></tr>';
                if (tbodyLots) tbodyLots.innerHTML = '<tr><td colspan="9" class="px-4 py-6 text-sm text-center text-gray-500">Todavía no hay lotes cargados.</td></tr>';
                return;
            }

            const vis = getVisibleRowsData();
            if (activeTab === 'current') renderCurrent(vis.filteredProducts);
            if (activeTab === 'lots') renderLots(vis.filteredLots);
        }, { movements: false });
    }

    function poblarProductosSelect() {
        if (!lotProduct) return;
        const products = Array.isArray(cacheProducts) ? cacheProducts : [];
        const current = lotProduct.value;
        lotProduct.innerHTML = '<option value="">— Seleccionar —</option>';
        products.forEach(p => {
            const opt = document.createElement('option');
            opt.value = String(p.id);
            opt.textContent = String(p.name || 'Producto');
            lotProduct.appendChild(opt);
        });
        lotProduct.value = current;
    }

    function updateLotCt() {
        const cu = parseMonedaARS(lotCu?.value);
        const qty = parseNumeroSeguro(lotQty?.value);
        const ct = cu * qty;
        if (lotCt) lotCt.value = formatMonedaARS(ct);
    }

    function crearEgresoDesdeInventario({ fecha, proveedor, valor, nota }) {
        try {
            if (window.StorageService && typeof window.StorageService.addExpenseFromInventory === 'function') {
                const res = window.StorageService.addExpenseFromInventory({
                    id: String(Date.now()),
                    fecha: String(fecha || ''),
                    categoria: 'Inventario',
                    valor: parseNumeroSeguro(valor),
                    nota: String(nota || ''),
                    forma_pago: 'Transferencia',
                    tipo_gasto: 'Variable',
                    frecuencia: 'Único',
                    comprobante: [],
                    custom_fields: [],
                    proveedor: String(proveedor || ''),
                    supplier_id: '',
                    supplier_name: String(proveedor || '')
                });
                try {
                    if (res && typeof res.then === 'function') res.catch(function () { });
                } catch (e) {
                }
                return res;
            }
        } catch (e) {
            // noop
        }
        return null;
    }

    function pctChange(oldPrice, newPrice) {
        const oldv = parseNumeroSeguro(oldPrice);
        const newv = parseNumeroSeguro(newPrice);
        if (!(oldv > 0) || !isFinite(oldv)) return '';
        const pct = ((newv - oldv) / oldv) * 100;
        if (!isFinite(pct)) return '';
        return pct.toFixed(2);
    }

    function newPriceFromPct(oldPrice, pct) {
        const oldv = parseNumeroSeguro(oldPrice);
        const pv = parseNumeroSeguro(pct);
        const factor = 1 + (pv / 100);
        const n = oldv * factor;
        return roundPrecio(n);
    }

    function pctFromNewPrice(oldPrice, newPrice) {
        const oldv = parseNumeroSeguro(oldPrice);
        const newv = roundPrecio(newPrice);
        if (!(oldv > 0)) return 0;
        const pct = ((newv - oldv) / oldv) * 100;
        if (!isFinite(pct)) return 0;
        return pct;
    }

    function applyGlobalPct(pct) {
        const pv = parseNumeroSeguro(pct);
        if (!isFinite(pv)) return;
        const products = Array.isArray(cacheProducts) ? cacheProducts : [];
        products.forEach(p => {
            const oldP = parseNumeroSeguro(p?.sale_price);
            const base = roundPrecio(oldP);
            const newP = newPriceFromPct(base, pv);
            const dirty = Math.abs(newP - base) >= 1;
            setDraft(p?.id, { newPrice: newP, pct: pv, dirty });
        });
        syncSaveButton();
        renderPreciosTable();
    }

    function updatePreciosCats(products) {
        if (!preciosCat) return;
        const current = String(preciosCat.value || '').trim();
        const cats = Array.from(new Set((Array.isArray(products) ? products : []).map(p => String(p?.category?.name || p?.category || '').trim()).filter(Boolean))).sort();
        preciosCat.innerHTML = '<option value="">Todas</option>';
        cats.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            preciosCat.appendChild(opt);
        });
        preciosCat.value = current;
    }

    function renderPreciosTable() {
        if (!preciosTbody) return;
        const products = Array.isArray(cacheProducts) ? cacheProducts.slice() : [];
        products.sort((a, b) => String(a?.name || '').localeCompare(String(b?.name || '')));
        updatePreciosCats(products);

        const q = String(preciosQ?.value || '').trim().toLowerCase();
        const cat = String(preciosCat?.value || '').trim();
        const visible = products.filter(p => {
            if (q && !String(p?.name || '').toLowerCase().includes(q)) return false;
            if (cat && String(p?.category?.name || p?.category || '') !== cat) return false;
            return true;
        });

        if (!visible.length) {
            preciosTbody.innerHTML = '<tr><td colspan="6" class="px-4 py-6 text-sm text-center text-gray-500">No hay productos para los filtros actuales.</td></tr>';
            return;
        }

        preciosTbody.innerHTML = '';
        visible.forEach(p => {
            const oldP = parseNumeroSeguro(p?.sale_price);
            const base = roundPrecio(oldP);
            const unitCost = unitCostForProduct(p?.id);
            const hasCost = (isFinite(unitCost) && unitCost > 0);
            const draft = getDraft(p?.id, base, unitCost);
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';
            tr.setAttribute('data-product-id', String(p?.id || ''));
            tr.setAttribute('data-old-price', String(base));
            tr.setAttribute('data-unit-cost', String(parseNumeroSeguro(unitCost)));
            tr.innerHTML = ''
                + '<td class="px-4 py-3 text-sm text-gray-900">' + String(p?.name || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-gray-500">' + String(p?.category?.name || p?.category || '') + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-500">' + (hasCost ? formatMoneyARS0(unitCost) : '<span class="text-amber-700" title="Este producto no tiene costo cargado">—</span>') + '</td>'
                + '<td class="px-4 py-3 text-sm text-right text-gray-500">' + formatMoneyARS0(base) + '</td>'
                + '<td class="px-4 py-3 text-sm text-right">'
                +   '<input type="text" inputmode="numeric" class="w-32 px-2 py-1 border rounded-md text-right text-sm input-new-price" value="' + esc(formatMoneyARS0(draft?.newPrice ?? base)) + '">' 
                + '</td>'
                + '<td class="px-4 py-3 text-sm text-right">'
                +   '<input type="number" step="0.01" class="w-24 px-2 py-1 border rounded-md text-right text-sm input-pct-change" value="' + esc(String(parseNumeroSeguro(draft?.pct ?? 0).toFixed(2))) + '">' 
                + '</td>';
            preciosTbody.appendChild(tr);

            const input = tr.querySelector('.input-new-price');
            const pctInput = tr.querySelector('.input-pct-change');

            const pid = String(p?.id || '').trim();
            const recalcDirty = function (newP) {
                const dirty = Math.abs(roundPrecio(newP) - base) >= 1;
                const d = getDraft(pid, base, unitCost);
                d.dirty = dirty;
                setDraft(pid, d);
                setRowDirty(tr, dirty);
                syncSaveButton();
            };

            if (input) {
                input.addEventListener('focus', function () {
                    const d = getDraft(pid, base, unitCost);
                    input.value = String(roundPrecio(d?.newPrice ?? base));
                    try { input.select(); } catch (e) { }
                });

                input.addEventListener('input', function () {
                    const raw = parseMonedaARS(input.value);
                    const newP = roundPrecio(raw);
                    const pct = pctFromNewPrice(base, newP);
                    const d = getDraft(pid, base, unitCost);
                    d.newPrice = newP;
                    d.pct = pct;
                    setDraft(pid, d);
                    if (pctInput && document.activeElement !== pctInput) pctInput.value = String(parseNumeroSeguro(pct).toFixed(2));
                    recalcDirty(newP);
                });

                input.addEventListener('blur', function () {
                    const d = getDraft(pid, base, unitCost);
                    input.value = formatMoneyARS0(d?.newPrice ?? base);
                });
            }

            if (pctInput) {
                pctInput.addEventListener('input', function () {
                    const pv = parseNumeroSeguro(pctInput.value);
                    const newP = newPriceFromPct(base, pv);
                    const d = getDraft(pid, base, unitCost);
                    d.pct = pv;
                    d.newPrice = newP;
                    setDraft(pid, d);
                    if (input && document.activeElement !== input) input.value = formatMoneyARS0(newP);
                    recalcDirty(newP);
                });
                pctInput.addEventListener('blur', function () {
                    const pv = parseNumeroSeguro(pctInput.value);
                    pctInput.value = String(isFinite(pv) ? pv.toFixed(2) : '0.00');
                });
            }

            setRowDirty(tr, !!draft?.dirty);
        });

        syncSaveButton();
    }

    function exportCsv() {
        const { filteredProducts, filteredLots } = getVisibleRowsData();
        let rows = [];
        if (activeTab === 'current') {
            rows.push(['Producto','Categoría','Código interno','Stock','Costo prom.','Valor total','Estado']);
            filteredProducts.forEach(({ p, m }) => {
                rows.push([
                    String(p.name || ''),
                    String(p?.category?.name || p?.category || ''),
                    String(p.codigo_interno || p.internal_code || ''),
                    String(m.stock),
                    String(m.avg),
                    String(m.total),
                    String(m.status)
                ]);
            });
        } else {
            rows.push(['Producto','Código interno','Lote','Ingreso','Proveedor','CU','Disponible','CT','Vencimiento']);
            filteredLots.forEach(({ l, p }) => {
                const ct = parseNumeroSeguro(l.qty_available) * parseNumeroSeguro(l.unit_cost);
                rows.push([
                    String(p?.name || ''),
                    String(l?.codigo_interno || p?.codigo_interno || p?.internal_code || ''),
                    String(l.lot_code || ''),
                    String(fmtFecha(l.received_at || '')),
                    String(l.supplier_name || ''),
                    String(parseNumeroSeguro(l.unit_cost)),
                    String(parseNumeroSeguro(l.qty_available)),
                    String(ct),
                    String(fmtFecha(l.expiration_date || ''))
                ]);
            });
        }
        const csv = rows.map(r => r.map(c => '"' + String(c).replace(/"/g, '""') + '"').join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = (activeTab === 'current' ? 'inventario_stock_actual.csv' : 'inventario_lotes.csv');
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    function exportPdfPrint() {
        const { filteredProducts, filteredLots } = getVisibleRowsData();
        const title = (activeTab === 'current') ? 'Inventario - Stock actual' : 'Inventario - Stock total (lotes)';
        let head = '';
        let body = '';
        if (activeTab === 'current') {
            head = '<tr>'
                + '<th>Producto</th><th>Categoría</th><th>Código interno</th><th style="text-align:right">Stock</th><th style="text-align:right">Costo prom.</th><th style="text-align:right">Valor total</th><th>Estado</th>'
                + '</tr>';
            filteredProducts.forEach(({ p, m }) => {
                body += '<tr>'
                    + '<td>' + String(p.name || '') + '</td>'
                    + '<td>' + String(p?.category?.name || p?.category || '') + '</td>'
                    + '<td>' + String(p.codigo_interno || p.internal_code || '') + '</td>'
                    + '<td style="text-align:right">' + String(m.stock.toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</td>'
                    + '<td style="text-align:right">' + formatMoney(m.avg) + '</td>'
                    + '<td style="text-align:right">' + formatMoney(m.total) + '</td>'
                    + '<td>' + String(m.status) + '</td>'
                    + '</tr>';
            });
        } else {
            head = '<tr>'
                + '<th>Producto</th><th>Código interno</th><th>Lote</th><th>Ingreso</th><th>Proveedor</th><th style="text-align:right">CU</th><th style="text-align:right">Disponible</th><th style="text-align:right">CT</th><th>Vencimiento</th>'
                + '</tr>';
            filteredLots.forEach(({ l, p }) => {
                const ct = parseNumeroSeguro(l.qty_available) * parseNumeroSeguro(l.unit_cost);
                body += '<tr>'
                    + '<td>' + String(p?.name || '') + '</td>'
                    + '<td>' + String(l?.codigo_interno || p?.codigo_interno || p?.internal_code || '') + '</td>'
                    + '<td>' + String(l.lot_code || '') + '</td>'
                    + '<td>' + String(fmtFecha(l.received_at || '')) + '</td>'
                    + '<td>' + String(l.supplier_name || '') + '</td>'
                    + '<td style="text-align:right">' + formatMoney(parseNumeroSeguro(l.unit_cost)) + '</td>'
                    + '<td style="text-align:right">' + String(parseNumeroSeguro(l.qty_available).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</td>'
                    + '<td style="text-align:right">' + formatMoney(ct) + '</td>'
                    + '<td>' + (l.expiration_date ? String(fmtFecha(l.expiration_date)) : '—') + '</td>'
                    + '</tr>';
            });
        }

        const html = ''
            + '<html><head><title>' + title + '</title>'
            + '<style>'
            + 'body{font-family:Arial, sans-serif; padding:18px; color:#111827;}'
            + 'h1{font-size:16px;margin:0 0 10px 0;}'
            + 'table{width:100%; border-collapse:collapse; font-size:12px;}'
            + 'th,td{border:1px solid #e5e7eb; padding:8px;}'
            + 'th{background:#f9fafb; text-align:left;}'
            + '</style></head><body>'
            + '<h1>' + title + '</h1>'
            + '<table><thead>' + head + '</thead><tbody>' + body + '</tbody></table>'
            + '<script>window.onload=function(){window.print();};<\/script>'
            + '</body></html>';
        const w = window.open('', '_blank');
        if (!w) return;
        w.document.open();
        w.document.write(html);
        w.document.close();
    }

    if (btnRegister) btnRegister.addEventListener('click', openRegisterInventory);
    if (btnCreate) btnCreate.addEventListener('click', openCreate);
    if (btnCloseCreate) btnCloseCreate.addEventListener('click', closeCreate);

    if (btnAddLot) btnAddLot.addEventListener('click', openAddLot);
    if (btnPrecios) btnPrecios.addEventListener('click', openPrecios);
    if (btnClosePrecios) btnClosePrecios.addEventListener('click', closePrecios);
    if (btnCancelPrecios) btnCancelPrecios.addEventListener('click', closePrecios);
    if (preciosQ) preciosQ.addEventListener('input', renderPreciosTable);
    if (preciosCat) preciosCat.addEventListener('change', renderPreciosTable);
    if (preciosGlobalPct) {
        preciosGlobalPct.addEventListener('input', function () {
            const raw = String(preciosGlobalPct.value ?? '').trim();
            if (raw === '') {
                preciosGlobalPctValue = null;
                return;
            }
            const pv = parseNumeroSeguro(raw);
            if (!isFinite(pv)) return;
            preciosGlobalPctValue = pv;
            applyGlobalPct(pv);
        });
    }
    if (btnSavePrecios) {
        btnSavePrecios.addEventListener('click', function () {
            const rows = Array.from(preciosTbody ? preciosTbody.querySelectorAll('tr[data-product-id]') : []);
            const changes = [];
            const invalidRows = [];
            rows.forEach(tr => {
                const id = tr.getAttribute('data-product-id');
                const oldP = roundPrecio(tr.getAttribute('data-old-price'));
                const input = tr.querySelector('.input-new-price');
                const newP = roundPrecio(parseMonedaARS(input?.value));
                if (!id) return;
                if (!isFinite(newP) || newP <= 0) {
                    if (Math.abs(newP - oldP) >= 1) invalidRows.push('El nuevo precio debe ser mayor a cero.');
                    return;
                }
                if (Math.abs(newP - oldP) < 1) return;
                changes.push({ id: parseInt(id, 10), sale_price: newP });
            });
            if (invalidRows.length) {
                if (preciosMsg) preciosMsg.textContent = String(invalidRows[0] || 'No se pudieron guardar los precios.');
                return;
            }
            if (!changes.length) {
                if (preciosMsg) preciosMsg.textContent = 'No hay cambios para guardar.';
                return;
            }
            if (preciosMsg) preciosMsg.textContent = 'Guardando…';
            apiBulkUpdatePrices(changes).then(function (res) {
                if (!res || res.ok !== true) {
                    try {
                        const err = String(res?.error || res?.message || '').trim();
                        const st = (res && res.status != null) ? String(res.status) : '';
                        const suffix = (err || st) ? (' (' + [err, st ? ('http_' + st) : ''].filter(Boolean).join(' / ') + ')') : '';
                        if (preciosMsg) preciosMsg.textContent = 'No se pudieron guardar los precios.' + suffix;
                    } catch (e) {
                        if (preciosMsg) preciosMsg.textContent = 'No se pudieron guardar los precios.';
                    }
                    return;
                }
                const updated = Array.isArray(res.items) ? res.items : [];
                const map = new Map(updated.map(p => [String(p.id), p]));
                cacheProducts = (Array.isArray(cacheProducts) ? cacheProducts : []).map(p => {
                    const u = map.get(String(p.id));
                    return u ? { ...p, sale_price: u.sale_price } : p;
                });
                if (preciosMsg) preciosMsg.textContent = 'Precios actualizados.';
                preciosDraft = new Map();
                preciosGlobalPctValue = null;
                if (preciosGlobalPct) preciosGlobalPct.value = '';
                renderAll();
            }).catch(function () {
                if (preciosMsg) preciosMsg.textContent = 'No se pudieron guardar los precios.';
            });
        });
    }

    if (btnExport) btnExport.addEventListener('click', openExport);
    if (btnCloseExport) btnCloseExport.addEventListener('click', closeExport);
    if (btnCancelExport) btnCancelExport.addEventListener('click', closeExport);
    if (btnExportXls) btnExportXls.addEventListener('click', function () { exportCsv(); closeExport(); });
    if (btnExportPdf) btnExportPdf.addEventListener('click', function () { exportPdfPrint(); closeExport(); });

    if (btnInvDanger) btnInvDanger.addEventListener('click', function (ev) { ev.preventDefault(); ev.stopPropagation(); toggleDangerMenu(); });
    if (btnInvDangerEmpty) {
        btnInvDangerEmpty.addEventListener('click', async function (ev) {
            ev.preventDefault();
            closeDangerMenu();
            const ok = await (window.confirmModal
                ? window.confirmModal(
                    'Vas a eliminar TODO el inventario actual (lotes).',
                    'Vaciar inventario',
                    'No borra productos ni movimientos. Esta acción no se puede deshacer.',
                    { okText: 'Continuar', cancelText: 'Cancelar' }
                )
                : Promise.resolve(window.confirm('¿Continuar y vaciar inventario?')));
            if (!ok) return;
            openEmptyInv('empty');
        });
    }
    if (btnInvDangerDelete) {
        btnInvDangerDelete.addEventListener('click', async function (ev) {
            ev.preventDefault();
            closeDangerMenu();
            const ok = await (window.confirmModal
                ? window.confirmModal(
                    'Vas a borrar TODO el inventario y eliminar los productos.',
                    'Borrar inventario',
                    'No borra movimientos/historial. Esta acción no se puede deshacer.',
                    { okText: 'Continuar', cancelText: 'Cancelar' }
                )
                : Promise.resolve(window.confirm('¿Continuar y borrar inventario?')));
            if (!ok) return;
            openEmptyInv('clear');
        });
    }
    if (invDangerWrap) {
        document.addEventListener('click', function (ev) {
            try {
                if (!invDangerMenu || invDangerMenu.classList.contains('hidden')) return;
                const t = ev.target;
                if (invDangerWrap.contains(t)) return;
                closeDangerMenu();
            } catch (e) {
            }
        });
        document.addEventListener('keydown', function (ev) {
            try {
                if (ev.key !== 'Escape') return;
                closeDangerMenu();
            } catch (e) {
            }
        });
    }
    if (btnCloseEmptyInv) btnCloseEmptyInv.addEventListener('click', closeEmptyInv);
    if (btnCancelEmptyInv) btnCancelEmptyInv.addEventListener('click', closeEmptyInv);
    if (inputEmptyInvConfirm) inputEmptyInvConfirm.addEventListener('input', syncEmptyInvConfirmUi);

    if (btnOkEmptyInv) {
        btnOkEmptyInv.addEventListener('click', function () {
            const v = String(inputEmptyInvConfirm?.value || '').trim();
            if (emptyInvMsg) emptyInvMsg.textContent = 'Vaciando inventario…';
            const action = inventoryDangerAction;
            const callApi = (action === 'clear') ? apiClearInventory : apiEmptyInventory;
            const loadingLabel = (action === 'clear') ? 'Borrando inventario…' : 'Vaciando inventario…';
            if (emptyInvMsg) emptyInvMsg.textContent = loadingLabel;

            callApi(v).then(function (res) {
                if (!res || res.ok !== true) {
                    const err = String(res?.error || '').trim();
                    const msg = (err === 'confirm_required')
                        ? 'Confirmación inválida.'
                        : (action === 'clear' ? 'No se pudo borrar el inventario.' : 'No se pudo vaciar el inventario.');
                    if (emptyInvMsg) emptyInvMsg.textContent = msg;
                    else if (window.showAlertModal) window.showAlertModal(msg, 'Error', 'Operación fallida');
                    return;
                }
                closeEmptyInv();
                const doneMsg = (action === 'clear') ? 'Inventario borrado correctamente.' : 'Inventario vaciado correctamente.';
                if (window.showAlertModal) window.showAlertModal(doneMsg, 'Listo', 'Inventario');
                cacheProducts = [];
                cacheLots = [];
                cacheMovements = [];
                inventoryHasLoaded = false;
                inventoryLoading = false;
                renderAll();
            }).catch(function () {
                if (emptyInvMsg) emptyInvMsg.textContent = 'No se pudo completar la operación.';
            });
        });
    }

    if (tabCurrent) tabCurrent.addEventListener('click', function () { switchTab('current'); });
    if (tabLots) tabLots.addEventListener('click', function () { switchTab('lots'); });

    if (btnBack1) btnBack1.addEventListener('click', closeCreate);
    if (btnBack2) btnBack2.addEventListener('click', closeCreate);
    if (btnBack3) btnBack3.addEventListener('click', openRegisterInventory);

    if (btnChoiceProduct) btnChoiceProduct.addEventListener('click', openCreate);
    if (btnChoiceLot) btnChoiceLot.addEventListener('click', openAddLot);
    if (btnChoiceImport) btnChoiceImport.addEventListener('click', openImportExcel);

    if (btnDownloadImportTemplate) {
        btnDownloadImportTemplate.addEventListener('click', function () {
            try {
                window.location.href = '/inventory/api/import-excel/template';
            } catch (e) {
            }
        });
    }

    if (btnRunImport) {
        btnRunImport.addEventListener('click', function () {
            const f = (importFile && importFile.files && importFile.files.length) ? importFile.files[0] : null;
            if (!f) {
                if (window.showAlertModal) window.showAlertModal('Seleccioná un archivo .xlsx.', 'Atención', 'Validación requerida');
                else alert('Seleccioná un archivo .xlsx.');
                return;
            }
            if (!String(f.name || '').toLowerCase().endsWith('.xlsx')) {
                if (window.showAlertModal) window.showAlertModal('El archivo debe ser .xlsx.', 'Atención', 'Validación requerida');
                else alert('El archivo debe ser .xlsx.');
                return;
            }
            if (importResult) {
                importResult.classList.remove('hidden');
                importResult.innerHTML = '<div class="text-sm text-gray-700">Previsualizando…</div>';
            }
            apiPreviewExcel(f).then(function (res) {
                if (!res || res.ok !== true) {
                    const msg = (res && (res.error || res.message)) ? String(res.error || res.message) : 'No se pudo previsualizar.';
                    if (importResult) {
                        importResult.classList.remove('hidden');
                        importResult.innerHTML = '<div class="text-sm font-semibold text-gray-900">Previsualización</div>'
                            + '<div class="mt-2 text-sm text-red-700">' + esc(msg) + '</div>';
                    }
                    return;
                }
                previewRows = Array.isArray(res.rows) ? res.rows.map(r => ({ ...r })) : [];
                validateAllPreviewRows();
                openPreviewScreen();
                renderPreviewTable();
                renderPreviewSummary();
            }).catch(function () {
                if (importResult) {
                    importResult.classList.remove('hidden');
                    importResult.innerHTML = '<div class="text-sm font-semibold text-gray-900">Previsualización</div>'
                        + '<div class="mt-2 text-sm text-red-700">No se pudo previsualizar.</div>';
                }
            });
        });
    }

    if (importFile && btnRunImport) {
        importFile.addEventListener('change', function () {
            const f = (importFile.files && importFile.files.length) ? importFile.files[0] : null;
            if (!f) return;
            try { btnRunImport.click(); } catch (e) { }
        });
    }

    if (btnPreviewBack) {
        btnPreviewBack.addEventListener('click', function () {
            try {
                if (createInvPanel) {
                    createInvPanel.classList.remove('max-w-6xl');
                    createInvPanel.classList.add('max-w-4xl');
                }
            } catch (e) { }
            openImportExcel();
        });
    }

    if (btnPreviewDrilldownBack) {
        btnPreviewDrilldownBack.addEventListener('click', function () {
            closePreviewDrilldown();
        });
    }

    if (previewCardNewCats) {
        previewCardNewCats.addEventListener('click', function () {
            if (previewCardNewCats.disabled) return;
            openPreviewDrilldown('cats');
        });
    }
    if (previewCardNewSups) {
        previewCardNewSups.addEventListener('click', function () {
            if (previewCardNewSups.disabled) return;
            openPreviewDrilldown('sups');
        });
    }

    function runCommit(rowsToSend) {
        if (previewResult) {
            previewResult.classList.remove('hidden');
            previewResult.innerHTML = '<div class="text-sm text-gray-700">Importando…</div>';
        }
        apiCommitExcel(rowsToSend).then(function (res) {
            if (!res || res.ok !== true) {
                const msg = (res && (res.error || res.message)) ? String(res.error || res.message) : 'No se pudo importar.';
                if (previewResult) {
                    previewResult.classList.remove('hidden');
                    previewResult.innerHTML = '<div class="text-sm font-semibold text-gray-900">Resultado</div>'
                        + '<div class="mt-2 text-sm text-red-700">' + esc(msg) + '</div>';
                }
                return;
            }
            const sum = res.summary || {};
            const errs = Array.isArray(res.errors) ? res.errors : [];
            if (!errs.length) {
                if (previewResult) {
                    previewResult.classList.remove('hidden');
                    previewResult.innerHTML = ''
                        + '<div class="rounded-xl border border-emerald-200 bg-emerald-50 p-4">'
                        + '<div class="flex items-start gap-3">'
                        + '<div class="h-9 w-9 rounded-lg bg-emerald-100 text-emerald-700 flex items-center justify-center shrink-0"><i class="fas fa-check"></i></div>'
                        + '<div class="min-w-0">'
                        + '<div class="text-sm font-semibold text-emerald-900">Éxito</div>'
                        + '<div class="mt-1 text-xs text-emerald-800">Importación exitosa. Cerrando…</div>'
                        + '<div class="mt-2 text-[11px] text-emerald-800">Ítems: ' + esc(sum.items_created ?? 0) + ' · Lotes: ' + esc(sum.lots_created ?? 0) + ' · Categorías: ' + esc(sum.categories_created ?? 0) + ' · Proveedores: ' + esc(sum.suppliers_created ?? 0) + '</div>'
                        + '</div>'
                        + '</div>'
                        + '</div>';
                }
                try {
                    if (btnConfirmImport) {
                        btnConfirmImport.disabled = true;
                        btnConfirmImport.classList.add('opacity-50');
                    }
                    if (btnImportValid) {
                        btnImportValid.disabled = true;
                        btnImportValid.classList.add('opacity-50');
                    }
                } catch (e) {
                }

                setTimeout(function () {
                    resetImportState();
                    closeImportConfirm();
                    try {
                        if (createInvPanel) {
                            createInvPanel.classList.remove('max-w-6xl');
                            createInvPanel.classList.add('max-w-4xl');
                        }
                    } catch (e) { }
                    closeCreate();
                    loadProductsLots(renderAll);
                }, 1500);
                return;
            }
            let html = '';
            html += '<div class="text-sm font-semibold text-gray-900">Resultado</div>';
            html += '<div class="mt-2 grid grid-cols-1 md:grid-cols-3 gap-3">'
                + '<div class="rounded-lg border border-gray-200 p-3"><div class="text-xs text-gray-500">Ítems creados</div><div class="text-lg font-semibold text-gray-900">' + esc(sum.items_created ?? 0) + '</div></div>'
                + '<div class="rounded-lg border border-gray-200 p-3"><div class="text-xs text-gray-500">Lotes creados</div><div class="text-lg font-semibold text-gray-900">' + esc(sum.lots_created ?? 0) + '</div></div>'
                + '<div class="rounded-lg border border-gray-200 p-3"><div class="text-xs text-gray-500">Errores</div><div class="text-lg font-semibold text-gray-900">' + esc(sum.errors ?? 0) + '</div></div>'
                + '</div>';
            html += '<div class="mt-3 text-[11px] text-gray-600">Categorías creadas: ' + esc(sum.categories_created ?? 0) + ' · Proveedores creados: ' + esc(sum.suppliers_created ?? 0) + '</div>';
            if (errs.length) {
                html += '<div class="mt-4 text-xs font-semibold text-gray-700">Errores por fila</div>';
                html += '<div class="mt-2 rounded-lg border border-gray-200 overflow-hidden">';
                html += '<div class="max-h-56 overflow-auto divide-y divide-gray-100">';
                errs.slice(0, 200).forEach(function (e) {
                    html += '<div class="px-3 py-2 text-xs text-gray-700">Fila <span class="font-semibold">' + esc(e.row) + '</span>: ' + esc(e.error) + '</div>';
                });
                html += '</div></div>';
            }
            if (previewResult) {
                previewResult.classList.remove('hidden');
                previewResult.innerHTML = html;
            }
            loadProductsLots(renderAll);
        }).catch(function () {
            if (previewResult) {
                previewResult.classList.remove('hidden');
                previewResult.innerHTML = '<div class="text-sm font-semibold text-gray-900">Resultado</div>'
                    + '<div class="mt-2 text-sm text-red-700">No se pudo importar.</div>';
            }
        });
    }

    if (btnImportValid) {
        btnImportValid.addEventListener('click', function () {
            validateAllPreviewRows();
            const rows = (Array.isArray(previewRows) ? previewRows : []).filter(r => r && !r._deleted && r._isValid);
            if (!rows.length) {
                if (window.showAlertModal) window.showAlertModal('No hay filas válidas para importar.', 'Atención', 'Importación');
                else alert('No hay filas válidas para importar.');
                return;
            }
            const totalAll = (Array.isArray(previewRows) ? previewRows : []).filter(r => r && !r._deleted).length;
            openImportConfirm({ mode: 'valid', rows: rows, totalAll: totalAll });
        });
    }

    if (btnConfirmImport) {
        btnConfirmImport.addEventListener('click', function () {
            validateAllPreviewRows();
            const rows = (Array.isArray(previewRows) ? previewRows : []).filter(r => r && !r._deleted);
            const hasErr = rows.some(r => (r._errorCount || 0) > 0);
            if (hasErr) {
                if (window.showAlertModal) window.showAlertModal('Corregí los errores antes de confirmar la importación.', 'Atención', 'Importación');
                else alert('Corregí los errores antes de confirmar la importación.');
                renderPreviewSummary();
                return;
            }
            if (!rows.length) {
                if (window.showAlertModal) window.showAlertModal('No hay filas para importar.', 'Atención', 'Importación');
                else alert('No hay filas para importar.');
                return;
            }
            openImportConfirm({ mode: 'all', rows: rows, totalAll: rows.length });
        });
    }

    if (btnCloseImportConfirm) btnCloseImportConfirm.addEventListener('click', closeImportConfirm);
    if (btnCancelImportConfirm) btnCancelImportConfirm.addEventListener('click', closeImportConfirm);
    if (btnOkImportConfirm) {
        btnOkImportConfirm.addEventListener('click', function () {
            const rows = Array.isArray(pendingImportConfirmRows) ? pendingImportConfirmRows : [];
            closeImportConfirm();
            if (!rows.length) return;
            runCommit(rows);
        });
    }

    if (prodActive) prodActive.addEventListener('change', syncProductToggleLabels);
    if (prodLots) prodLots.addEventListener('change', syncProductToggleLabels);

    if (btnEditFile) btnEditFile.addEventListener('click', function () { toggleFileEditMode(true); });
    if (btnCancelFile) btnCancelFile.addEventListener('click', function () { if (fileProductId) openProductFile(fileProductId); else closeProductFile(); });
    if (btnSaveFile) btnSaveFile.addEventListener('click', saveProductFile);
    if (btnCloseFile) btnCloseFile.addEventListener('click', closeProductFile);
    if (btnCloseFileBottom) btnCloseFileBottom.addEventListener('click', closeProductFile);

    if (fileActive) fileActive.addEventListener('change', syncFileToggleLabels);

    if (filePrimarySupplier) {
        filePrimarySupplier.addEventListener('input', function () {
            if (suppressSupplierInputClear) return;
            if (filePrimarySupplierId) filePrimarySupplierId.value = '';
        });
    }

    if (btnSelectSupplierFile) btnSelectSupplierFile.addEventListener('click', function () { openSupplierModal('file'); });
    if (linkCreateSupplierFile) linkCreateSupplierFile.addEventListener('click', function (ev) { ev.preventDefault(); goCreateSupplier('file'); });

    if (fileImage) {
        fileImage.addEventListener('change', function () {
            const f = (fileImage.files && fileImage.files.length) ? fileImage.files[0] : null;
            fileImageWasChanged = true;
            if (!f) {
                fileImageWasChanged = false;
                return;
            }
            try {
                const url = URL.createObjectURL(f);
                setFileImagePreviewUrl(url);
            } catch (e) {
            }
        });
    }

    if (btnFileChart15) btnFileChart15.addEventListener('click', function () { if (fileProductId) refreshFileChart(fileProductId, 15); });
    if (btnFileChart30) btnFileChart30.addEventListener('click', function () { if (fileProductId) refreshFileChart(fileProductId, 30); });
    if (btnFileChart60) btnFileChart60.addEventListener('click', function () { if (fileProductId) refreshFileChart(fileProductId, 60); });
    if (btnFileChart90) btnFileChart90.addEventListener('click', function () { if (fileProductId) refreshFileChart(fileProductId, 90); });

    if (lotNoExp) {
        lotNoExp.addEventListener('change', function () {
            const no = !!lotNoExp.checked;
            if (lotExp) {
                lotExp.value = '';
                lotExp.disabled = no;
                lotExp.classList.toggle('bg-gray-50', no);
            }
        });
    }

    if (prodLotNoExp) {
        prodLotNoExp.addEventListener('change', function () {
            const no = !!prodLotNoExp.checked;
            if (prodLotExp) {
                prodLotExp.value = '';
                prodLotExp.disabled = no;
                prodLotExp.classList.toggle('bg-gray-50', no);
            }
        });
    }

    if (lotCu) lotCu.addEventListener('input', updateLotCt);
    if (lotQty) lotQty.addEventListener('input', updateLotCt);

    if (prodLotCu) prodLotCu.addEventListener('input', updateProdLotCt);
    if (prodLotQty) prodLotQty.addEventListener('input', updateProdLotCt);

    if (btnSaveProduct) {
        btnSaveProduct.addEventListener('click', function () {
            const name = String(prodName?.value || '').trim();
            const categoryId = String(prodCatId?.value || '').trim();
            const codigoInterno = String(prodCodigoInterno?.value || '').trim();
            const barcode = String(prodBarcode?.value || '').trim();
            const manageLots = !!prodLots?.checked;
            const method = String(prodMethod?.value || 'FIFO').trim();
            const min = parseNumeroSeguro(prodMin?.value);
            const reorderPoint = parseNumeroSeguro(prodReorder?.value);
            const desc = String(prodDesc?.value || '').trim();
            const salePrice = parseMonedaARS(prodSalePrice?.value);
            const active = true;

            const firstLotQty = parseNumeroSeguro(prodLotQty?.value);
            const wantsFirstLot = (!editingProductId) && (firstLotQty > 0);

            if (!name) { if (window.showAlertModal) window.showAlertModal('Completá el nombre del producto.', 'Atención', 'Validación requerida'); else alert('Completá el nombre del producto.'); return; }
            if (!categoryId) { if (window.showAlertModal) window.showAlertModal('Seleccioná la categoría del producto.', 'Atención', 'Validación requerida'); else alert('Seleccioná la categoría del producto.'); return; }
            if (codigoInterno && (codigoInterno.length < 4 || codigoInterno.length > 12)) { if (window.showAlertModal) window.showAlertModal('El código interno debe tener entre 4 y 12 caracteres.', 'Atención', 'Validación requerida'); else alert('El código interno debe tener entre 4 y 12 caracteres.'); return; }
            if (codigoInterno && /\s/.test(codigoInterno)) { if (window.showAlertModal) window.showAlertModal('El código interno no admite espacios.', 'Atención', 'Validación requerida'); else alert('El código interno no admite espacios.'); return; }
            if (barcode && barcode.length > 64) { if (window.showAlertModal) window.showAlertModal('El código de barras admite hasta 64 caracteres.', 'Atención', 'Validación requerida'); else alert('El código de barras admite hasta 64 caracteres.'); return; }
            if (barcode && !/^[A-Za-z0-9]+$/.test(barcode)) { if (window.showAlertModal) window.showAlertModal('El código de barras solo admite letras y números.', 'Atención', 'Validación requerida'); else alert('El código de barras solo admite letras y números.'); return; }

            const payload = {
                name,
                category_id: parseInt(categoryId, 10),
                codigo_interno: codigoInterno,
                barcode: barcode,
                uses_lots: true,
                method: 'FIFO',
                min_stock: min,
                reorder_point: reorderPoint,
                description: desc,
                active: true,
                sale_price: salePrice
            };

            const req = editingProductId
                ? apiUpdateProduct(editingProductId, payload)
                : apiCreateProduct(payload);

            req.then(function (res) {
                if (!res || res.ok !== true) {
                    const err = String(res?.error || '').trim();
                    const msg = (err === 'category_required')
                        ? 'Seleccioná una categoría.'
                        : (err === 'method_locked')
                            ? 'La metodología no puede modificarse una vez que el producto tiene movimientos.'
                            : (editingProductId ? 'No se pudo editar el producto.' : 'No se pudo crear el producto.');
                    if (window.showAlertModal) window.showAlertModal(msg, 'Error', 'Operación fallida');
                    else alert(msg);
                    return;
                }
                const item = res.item;
                const pid = String(item?.id || editingProductId || '').trim();
                const file = (prodImage && prodImage.files && prodImage.files.length) ? prodImage.files[0] : null;

                let lotFailed = false;
                let lotInvalid = false;
                const createFirstLot = function () {
                    if (!wantsFirstLot) return Promise.resolve({ skipped: true });
                    const entryIso = todayIso();
                    const supplierName = String(prodLotSupplier?.value || '').trim();
                    const supplierId = String(prodLotSupplierId?.value || '').trim();
                    const unitCost = parseMonedaARS(prodLotCu?.value);
                    const qty = parseNumeroSeguro(prodLotQty?.value);
                    const expIso = (prodLotNoExp?.checked) ? '' : toIsoDate(String(prodLotExp?.value || '').trim());
                    if (!prodLotNoExp?.checked && !expIso) {
                        lotInvalid = true;
                        return Promise.resolve({ skipped: true });
                    }
                    const note = String(prodLotNote?.value || '').trim();

                    const lotPayload = {
                        product_id: parseInt(pid, 10),
                        qty: qty,
                        unit_cost: unitCost,
                        date: entryIso,
                        supplier_id: supplierId,
                        supplier_name: supplierName,
                        expiration_date: expIso,
                        note: note
                    };
                    return apiCreateLot(lotPayload).then(function (lr) {
                        if (!lr || lr.ok !== true) {
                            lotFailed = true;
                        }
                        return lr;
                    }).catch(function () {
                        lotFailed = true;
                    });
                };

                const uploadImage = function () {
                    if (!(pid && file)) return Promise.resolve({ skipped: true });
                    return apiUploadProductImage(pid, file).catch(function () {
                    });
                };

                createFirstLot().then(function () {
                    return uploadImage();
                }).then(function () {
                    closeCreate();
                    renderAll();
                    if (wantsFirstLot && lotInvalid) {
                        if (window.showAlertModal) window.showAlertModal('El ítem se guardó, pero el lote no se creó: revisá la fecha de ingreso y/o vencimiento.', 'Atención', 'Lote incompleto');
                        else alert('El ítem se guardó, pero el lote no se creó: revisá la fecha de ingreso y/o vencimiento.');
                    } else if (wantsFirstLot && lotFailed) {
                        if (window.showAlertModal) window.showAlertModal('El ítem se guardó, pero no se pudo crear el lote.', 'Atención', 'Operación parcial');
                        else alert('El ítem se guardó, pero no se pudo crear el lote.');
                    }
                });
            }).catch(function () {
                const msg = editingProductId ? 'No se pudo editar el producto.' : 'No se pudo crear el producto.';
                if (window.showAlertModal) window.showAlertModal(msg, 'Error', 'Operación fallida');
                else alert(msg);
            });
        });
    }

    function openCreateCategory() {
        if (!modalCreateCat) return;
        if (catName) catName.value = '';
        if (catMsg) catMsg.textContent = '';
        renderCategoryList();
        abrirModal(modalCreateCat, true);
        try { catName?.focus(); } catch (e) { }
    }

    function renderCategoryList() {
        if (!catList) return;
        const cats = Array.isArray(cacheCategories) ? cacheCategories : [];
        if (!cats.length) {
            catList.innerHTML = '<div class="px-3 py-3 text-xs text-gray-500">No hay categorías.</div>';
            return;
        }
        const activeCats = cats.filter(c => !!c);
        activeCats.sort((a, b) => String(a?.name || '').localeCompare(String(b?.name || ''), 'es'));
        catList.innerHTML = activeCats.map(function (c) {
            const id = String(c?.id || '').trim();
            const name = String(c?.name || '').trim();
            const disabled = String(c?.active) === 'false';
            return (
                '<div class="flex items-center justify-between px-3 py-2 text-sm">'
                + '<div class="min-w-0">'
                + '<div class="truncate ' + (disabled ? 'text-gray-400 line-through' : 'text-gray-900') + '">' + (name || '—') + '</div>'
                + '</div>'
                + '<button type="button" class="btn-cat-del h-8 w-8 inline-flex items-center justify-center rounded-md hover:bg-red-50 text-red-600" data-cat-id="' + id + '" title="Borrar">'
                + '<i class="fas fa-times"></i>'
                + '</button>'
                + '</div>'
            );
        }).join('');

        catList.querySelectorAll('.btn-cat-del').forEach(function (btn) {
            btn.addEventListener('click', async function () {
                const id = String(btn.getAttribute('data-cat-id') || '').trim();
                if (!id) return;
                const cats2 = Array.isArray(cacheCategories) ? cacheCategories : [];
                const cat = cats2.find(c => String(c?.id || '') === id);
                const name = String(cat?.name || '').trim() || 'esta categoría';
                const ok = await (window.confirmModal ? window.confirmModal(
                    '¿Querés borrar "' + name + '"?',
                    'Borrar categoría',
                    'Esta acción no se puede deshacer.',
                    { okText: 'Borrar', cancelText: 'Cancelar' }
                ) : Promise.resolve(window.confirm('¿Querés borrar "' + name + '"?')));
                if (!ok) return;
                apiDeleteCategory(id).then(function (res) {
                    if (!res || res.ok !== true) {
                        const err = String(res?.error || '').trim();
                        if (err === 'in_use') {
                            if (window.showAlertModal) window.showAlertModal('No se puede borrar: hay productos usando esta categoría.', 'Atención', 'Operación bloqueada');
                            else alert('No se puede borrar: hay productos usando esta categoría.');
                        } else if (err === 'has_children') {
                            if (window.showAlertModal) window.showAlertModal('No se puede borrar: la categoría tiene subcategorías.', 'Atención', 'Operación bloqueada');
                            else alert('No se puede borrar: la categoría tiene subcategorías.');
                        } else if (err === 'not_found') {
                            if (window.showAlertModal) window.showAlertModal('La categoría no existe o ya fue borrada.', 'Atención', 'Operación');
                            else alert('La categoría no existe o ya fue borrada.');
                        } else {
                            if (window.showAlertModal) window.showAlertModal('No se pudo borrar la categoría.', 'Error', 'Operación fallida');
                            else alert('No se pudo borrar la categoría.');
                        }
                        return;
                    }
                    loadCategories(function () {
                        refreshCategorySelect(String(prodCatId?.value || ''));
                        renderCategoryList();
                    });
                }).catch(function () {
                    if (window.showAlertModal) window.showAlertModal('No se pudo borrar la categoría.', 'Error', 'Operación fallida');
                    else alert('No se pudo borrar la categoría.');
                });
            });
        });
    }

    function closeCreateCategory() {
        if (!modalCreateCat) return;
        abrirModal(modalCreateCat, false);
    }

    if (btnOpenCreateCat) btnOpenCreateCat.addEventListener('click', openCreateCategory);
    if (btnCloseCreateCat) btnCloseCreateCat.addEventListener('click', closeCreateCategory);
    if (btnCancelCreateCat) btnCancelCreateCat.addEventListener('click', closeCreateCategory);
    if (btnSaveCreateCat) {
        btnSaveCreateCat.addEventListener('click', function () {
            const name = String(catName?.value || '').trim();
            if (!name) {
                if (catMsg) catMsg.textContent = 'Completá el nombre.';
                return;
            }
            if (catMsg) catMsg.textContent = 'Creando…';
            apiCreateCategory({ name }).then(function (res) {
                if (!res || res.ok !== true) {
                    const err = String(res?.error || '').trim();
                    if (err === 'already_exists') {
                        if (catMsg) catMsg.textContent = 'Ya existe una categoría con ese nombre.';
                    } else {
                        if (catMsg) catMsg.textContent = 'No se pudo crear la categoría.';
                    }
                    return;
                }
                const item = res.item;
                if (!didLoadCategories) didLoadCategories = true;
                loadCategories(function () {
                    refreshCategorySelect(String(item?.id || ''));
                });
                closeCreateCategory();
            }).catch(function () {
                if (catMsg) catMsg.textContent = 'No se pudo crear la categoría.';
            });
        });
    }

    function setImagePreviewFromFile(file) {
        if (!file || !prodImagePreview) return;
        try {
            const url = URL.createObjectURL(file);
            prodImagePreview.src = url;
            prodImagePreview.classList.remove('hidden');
            if (prodImagePlaceholder) prodImagePlaceholder.classList.add('hidden');
        } catch (e) {
        }
    }

    if (prodImage) {
        prodImage.addEventListener('change', function () {
            const file = (prodImage.files && prodImage.files.length) ? prodImage.files[0] : null;
            if (!file) {
                if (prodImagePreview) {
                    prodImagePreview.src = '';
                    prodImagePreview.classList.add('hidden');
                }
                if (prodImagePlaceholder) prodImagePlaceholder.classList.remove('hidden');
                return;
            }
            setImagePreviewFromFile(file);
        });
    }

    if (btnToggleProdExtra) {
        btnToggleProdExtra.addEventListener('click', function () {
            if (!prodExtra) return;
            const nextOpen = prodExtra.classList.contains('hidden');
            prodExtra.classList.toggle('hidden', !nextOpen);
            btnToggleProdExtra.setAttribute('aria-expanded', nextOpen ? 'true' : 'false');
            if (iconToggleProdExtra) {
                iconToggleProdExtra.classList.toggle('fa-chevron-down', !nextOpen);
                iconToggleProdExtra.classList.toggle('fa-chevron-up', nextOpen);
            }
        });
    }

    if (lotSupplier) {
        lotSupplier.addEventListener('input', function () {
            if (suppressSupplierInputClear) return;
            if (lotSupplierId) lotSupplierId.value = '';
        });
    }

    if (prodLotSupplier) {
        prodLotSupplier.addEventListener('input', function () {
            if (suppressSupplierInputClear) return;
            if (prodLotSupplierId) prodLotSupplierId.value = '';
        });
    }

    function safeReturnToWithTarget(target) {
        try {
            const url = new URL(window.location.href);
            url.searchParams.delete('supplier_id');
            url.searchParams.delete('supplier_name');
            url.searchParams.delete('inv_supplier_target');
            url.searchParams.set('inv_supplier_target', String(target || ''));
            return url.pathname + (url.searchParams.toString() ? ('?' + url.searchParams.toString()) : '');
        } catch (e) {
            return window.location.pathname + window.location.search;
        }
    }

    function goCreateSupplier(target) {
        try {
            const draft = {
                wasOpen: !!(modalCreate && !modalCreate.classList.contains('hidden')),
                choiceHidden: !!choiceWrap?.classList.contains('hidden'),
                productHidden: !!formProduct?.classList.contains('hidden'),
                lotHidden: !!formLot?.classList.contains('hidden'),
                editingProductId: String(editingProductId || ''),
                product: {
                    name: String(prodName?.value || ''),
                    categoryId: String(prodCatId?.value || ''),
                    codigoInterno: String(prodCodigoInterno?.value || ''),
                    manageLots: !!prodLots?.checked,
                    method: String(prodMethod?.value || ''),
                    min: String(prodMin?.value || ''),
                    reorder: String(prodReorder?.value || ''),
                    desc: String(prodDesc?.value || ''),
                    salePrice: String(prodSalePrice?.value || ''),
                    active: !!prodActive?.checked,
                    firstLot: {
                        date: String(prodLotDate?.value || ''),
                        supplier: String(prodLotSupplier?.value || ''),
                        supplierId: String(prodLotSupplierId?.value || ''),
                        cu: String(prodLotCu?.value || ''),
                        qty: String(prodLotQty?.value || ''),
                        exp: String(prodLotExp?.value || ''),
                        noExp: !!prodLotNoExp?.checked,
                        note: String(prodLotNote?.value || '')
                    }
                },
                lot: {
                    productId: String(lotProduct?.value || ''),
                    date: String(lotDate?.value || ''),
                    supplier: String(lotSupplier?.value || ''),
                    supplierId: String(lotSupplierId?.value || ''),
                    cu: String(lotCu?.value || ''),
                    qty: String(lotQty?.value || ''),
                    exp: String(lotExp?.value || ''),
                    noExp: !!lotNoExp?.checked,
                    note: String(lotNote?.value || '')
                }
            };
            window.sessionStorage?.setItem('inv_draft', JSON.stringify(draft));
        } catch (e) {
        }
        const returnTo = safeReturnToWithTarget(target);
        const qs = [
            'return_to=' + encodeURIComponent(returnTo),
            'prefill_category=' + encodeURIComponent('Inventario')
        ];
        window.location.href = '/suppliers/new?' + qs.join('&');
    }

    function restoreInventoryDraft() {
        let raw = '';
        try { raw = window.sessionStorage?.getItem('inv_draft') || ''; } catch (e) { raw = ''; }
        if (!raw) return;
        let d = null;
        try { d = JSON.parse(raw); } catch (e) { d = null; }
        try { window.sessionStorage?.removeItem('inv_draft'); } catch (e) { }
        if (!d || !d.wasOpen) return;

        try { window.__inv_draft_restored = true; } catch (e) { }

        try {
            if (d.productHidden === false) {
                openCreate();
            } else if (d.lotHidden === false) {
                openAddLot();
            } else {
                abrirModal(modalCreate, true);
            }
        } catch (e) {
        }

        try {
            editingProductId = String(d.editingProductId || '');
        } catch (e) {
        }

        try {
            if (choiceWrap) choiceWrap.classList.toggle('hidden', !!d.choiceHidden);
            if (formProduct) formProduct.classList.toggle('hidden', !!d.productHidden);
            if (formLot) formLot.classList.toggle('hidden', !!d.lotHidden);
        } catch (e) {
        }

        try {
            if (prodName) prodName.value = String(d?.product?.name || '');
            if (prodCatId) prodCatId.value = String(d?.product?.categoryId || '');
            if (prodCodigoInterno) prodCodigoInterno.value = String(d?.product?.codigoInterno || '');
            if (prodLots) prodLots.checked = !!d?.product?.manageLots;
            if (prodMethod) prodMethod.value = String(d?.product?.method || '');
            if (prodMin) prodMin.value = String(d?.product?.min || '');
            if (prodReorder) prodReorder.value = String(d?.product?.reorder || '');
            if (prodDesc) prodDesc.value = String(d?.product?.desc || '');
            if (prodSalePrice) prodSalePrice.value = String(d?.product?.salePrice || '');
            if (prodActive) prodActive.checked = !!d?.product?.active;
        } catch (e) {
        }

        try {
            const fl = d?.product?.firstLot || {};
            if (prodLotDate) prodLotDate.value = String(fl?.date || '');
            if (prodLotSupplier) prodLotSupplier.value = String(fl?.supplier || '');
            if (prodLotSupplierId) prodLotSupplierId.value = String(fl?.supplierId || '');
            if (prodLotCu) prodLotCu.value = String(fl?.cu || '');
            if (prodLotQty) prodLotQty.value = String(fl?.qty || '');
            if (prodLotExp) prodLotExp.value = String(fl?.exp || '');
            if (prodLotNoExp) prodLotNoExp.checked = !!fl?.noExp;
            if (prodLotNote) prodLotNote.value = String(fl?.note || '');
            try { prodLotNoExp?.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) { }
            try { updateProdLotCt(); } catch (e) { }
        } catch (e) {
        }

        try {
            const l = d?.lot || {};
            if (lotProduct) lotProduct.value = String(l?.productId || '');
            if (lotDate) lotDate.value = String(l?.date || '');
            if (lotSupplier) lotSupplier.value = String(l?.supplier || '');
            if (lotSupplierId) lotSupplierId.value = String(l?.supplierId || '');
            if (lotCu) lotCu.value = String(l?.cu || '');
            if (lotQty) lotQty.value = String(l?.qty || '');
            if (lotExp) lotExp.value = String(l?.exp || '');
            if (lotNoExp) lotNoExp.checked = !!l?.noExp;
            if (lotNote) lotNote.value = String(l?.note || '');
            try { lotNoExp?.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) { }
            try { updateLotCt(); } catch (e) { }
        } catch (e) {
        }
    }
    if (btnSelectSupplierLot) {
        btnSelectSupplierLot.addEventListener('click', function () {
            openSupplierModal('lot');
        });
    }

    if (btnSelectSupplierProdLot) {
        btnSelectSupplierProdLot.addEventListener('click', function () {
            openSupplierModal('prod_lot');
        });
    }

    if (btnSelectSupplierLotEdit) btnSelectSupplierLotEdit.addEventListener('click', function () { openSupplierModal('lot_edit'); });

    if (btnCloseSelectSupplier) btnCloseSelectSupplier.addEventListener('click', closeSupplierModal);
    if (btnCancelSelectSupplier) btnCancelSelectSupplier.addEventListener('click', closeSupplierModal);
    if (supplierModalSearch) {
        supplierModalSearch.addEventListener('input', function () {
            renderSupplierModalList(supplierModalSearch.value);
        });
    }

    if (linkCreateSupplierFromInv) {
        linkCreateSupplierFromInv.addEventListener('click', function (ev) {
            ev.preventDefault();
            goCreateSupplier(currentSupplierTarget || 'lot');
        });
    }
    if (linkCreateSupplierLot) {
        linkCreateSupplierLot.addEventListener('click', function (ev) {
            ev.preventDefault();
            goCreateSupplier('lot');
        });
    }

    if (linkCreateSupplierLotEdit) linkCreateSupplierLotEdit.addEventListener('click', function (ev) { ev.preventDefault(); goCreateSupplier('lot_edit'); });

    if (editLotSupplier) {
        editLotSupplier.addEventListener('input', function () {
            if (suppressSupplierInputClear) return;
            if (editLotSupplierId) editLotSupplierId.value = '';
        });
    }

    if (btnSaveEditLot) btnSaveEditLot.addEventListener('click', saveEditLot);
    if (btnCancelEditLot) btnCancelEditLot.addEventListener('click', closeEditLot);
    if (btnCloseEditLot) btnCloseEditLot.addEventListener('click', closeEditLot);

    if (btnOpenAdjustLot) btnOpenAdjustLot.addEventListener('click', function () {
        if (!canAdjustLot) return;
        openAdjustLot();
    });
    if (btnCloseAdjustLot) btnCloseAdjustLot.addEventListener('click', closeAdjustLot);
    if (btnCancelAdjustLot) btnCancelAdjustLot.addEventListener('click', closeAdjustLot);
    if (btnSaveAdjustLot) btnSaveAdjustLot.addEventListener('click', saveAdjustLot);

    if (btnAddLot) btnAddLot.addEventListener('click', openAddLot);

    if (btnSaveLot) {
        btnSaveLot.addEventListener('click', function () {
            const productId = String(lotProduct?.value || '').trim();
            const supplier = String(lotSupplier?.value || '').trim();
            const supplierId = String(lotSupplierId?.value || '').trim();
            const cu = parseMonedaARS(lotCu?.value);
            const qty = parseNumeroSeguro(lotQty?.value);
            const expiration = (lotNoExp?.checked) ? '' : String(lotExp?.value || '').trim();
            const note = String(lotNote?.value || '').trim();

            const entryIso = todayIso();
            const expIso = (lotNoExp?.checked) ? '' : toIsoDate(expiration);

            if (!productId) { if (window.showAlertModal) window.showAlertModal('Seleccioná un producto.', 'Atención', 'Validación requerida'); else alert('Seleccioná un producto.'); return; }
            if (!supplier) { if (window.showAlertModal) window.showAlertModal('Completá el proveedor.', 'Atención', 'Validación requerida'); else alert('Completá el proveedor.'); return; }
            if (!(cu >= 0)) { if (window.showAlertModal) window.showAlertModal('El costo unitario no puede ser negativo.', 'Atención', 'Validación requerida'); else alert('El costo unitario no puede ser negativo.'); return; }
            if (!(qty > 0)) { if (window.showAlertModal) window.showAlertModal('La cantidad debe ser mayor a 0.', 'Atención', 'Validación requerida'); else alert('La cantidad debe ser mayor a 0.'); return; }
            if (!lotNoExp?.checked && !expIso) { if (window.showAlertModal) window.showAlertModal('Completá la fecha de vencimiento o marcá “No corresponde”.', 'Atención', 'Validación requerida'); else alert('Completá la fecha de vencimiento o marcá “No corresponde”.'); return; }

            const prod = (Array.isArray(cacheProducts) ? cacheProducts : []).find(p => String(p.id) === String(productId));
            if (!prod) { if (window.showAlertModal) window.showAlertModal('Producto inválido.', 'Atención', 'Validación requerida'); else alert('Producto inválido.'); return; }

            const lotId = String(Date.now());
            const lotCode = 'L-' + lotId.slice(-6);

            const total = cu * qty;
            const entryDate = todayDisplay();
            const expensePayload = {
                id: String(Date.now()),
                fecha: entryDate,
                categoria: 'Inventario',
                valor: total,
                nota: 'Desde Inventario - ' + String(prod.name || '') + ' (' + lotCode + ')',
                forma_pago: 'Transferencia',
                tipo_gasto: 'Variable',
                frecuencia: 'Único',
                comprobante: [],
                custom_fields: [],
                proveedor: String(supplier || ''),
                supplier_id: supplierId,
                supplier_name: String(supplier || '')
            };

            apiCreateLot({
                product_id: parseInt(productId, 10),
                date: entryIso,
                unit_cost: cu,
                qty: qty,
                supplier_id: supplierId,
                supplier_name: supplier,
                lot_code: lotCode,
                expiration_date: expIso,
                note: note
            }).then(function (res) {
                if (!res || res.ok !== true) {
                    if (window.showAlertModal) window.showAlertModal('No se pudo cargar el lote.', 'Error', 'Operación fallida');
                    else alert('No se pudo cargar el lote.');
                    return;
                }
                crearEgresoDesdeInventario({ fecha: entryDate, proveedor: supplier, valor: total, nota: expensePayload.nota });
                closeCreate();
                renderAll();
            }).catch(function () {
                if (window.showAlertModal) window.showAlertModal('No se pudo cargar el lote.', 'Error', 'Operación fallida');
                else alert('No se pudo cargar el lote.');
            });
        });
    }

    [filterQ, filterCat].forEach(el => {
        if (!el) return;
        el.addEventListener('input', renderAll);
        el.addEventListener('change', renderAll);
    });

    if (filterQLots && filterQ) {
        try { filterQLots.value = String(filterQ.value || ''); } catch (e) { }
        filterQLots.addEventListener('input', function () {
            try { filterQ.value = String(filterQLots.value || ''); } catch (e) { }
            try { renderAll(); } catch (e) { }
        });
        filterQ.addEventListener('input', function () {
            try { filterQLots.value = String(filterQ.value || ''); } catch (e) { }
        });
    }

    if (filterLotsSup) {
        filterLotsSup.addEventListener('input', renderAll);
        filterLotsSup.addEventListener('change', renderAll);
    }

    function setStatusFilter(values) {
        if (!filterStatus) return;
        const wanted = Array.isArray(values) ? values.map(v => String(v || '').trim()).filter(Boolean) : [];
        Array.from(filterStatus.options).forEach(function (o) {
            const v = String(o.value || '').trim();
            if (!v) {
                o.selected = false;
            } else {
                o.selected = wanted.indexOf(v) >= 0;
            }
        });
        try { filterStatus.dispatchEvent(new Event('change', { bubbles: true })); } catch (e) { }
    }

    // Estado filter: compatible con bootstrap-select.
    // Regla: "Todos" (value="") es exclusivo. Default: solo "Todos".
    let suppressStatusSync = false;
    let lastTodosSelected = false;

    function getStatusOptions() {
        if (!filterStatus) return { allOpt: null, statusOpts: [] };
        const opts = Array.from(filterStatus.options || []);
        const allOpt = opts.find(o => String(o.value || '').trim() === '') || null;
        const statusOpts = opts.filter(o => String(o.value || '').trim() !== '');
        return { allOpt, statusOpts };
    }

    function refreshStatusPickerUI() {
        try {
            if (window.jQuery && window.jQuery.fn && typeof window.jQuery.fn.selectpicker === 'function') {
                window.jQuery(filterStatus).selectpicker('refresh');
            }
        } catch (e) {
        }
    }

    function setTodosOnlySelected() {
        if (!filterStatus) return;
        const { allOpt, statusOpts } = getStatusOptions();
        // Default: "Todos" marcado y todos los estados seleccionados.
        if (allOpt) allOpt.selected = true;
        statusOpts.forEach(function (o) { o.selected = true; });
        refreshStatusPickerUI();
    }

    function enforceStatusSelectionRules() {
        if (!filterStatus) return;
        const { allOpt, statusOpts } = getStatusOptions();
        if (!allOpt) return;

        // Se permite selección vacía. Reglas automáticas mínimas:
        // - Si el usuario seleccionó algún estado manualmente, no tocar.
        // - Si el usuario deja "Todos" seleccionado, no forzamos nada acá (se maneja como toggle en el handler bs.select).
        refreshStatusPickerUI();
    }

    if (filterStatus) {
        const handleStatusChanged = function () {
            if (suppressStatusSync) return;
            suppressStatusSync = true;
            setTimeout(function () {
                try {
                    const { allOpt, statusOpts } = getStatusOptions();
                    const isTodosNow = !!allOpt?.selected;
                    const anyStatusSelected = statusOpts.some(o => !!o.selected);

                    // "Todos" es un toggle independiente:
                    // - OFF -> ON: seleccionar todos los estados
                    // - ON -> OFF: limpiar todos los estados
                    if (isTodosNow && !lastTodosSelected) {
                        statusOpts.forEach(function (o) { o.selected = true; });
                    } else if (!isTodosNow && lastTodosSelected) {
                        statusOpts.forEach(function (o) { o.selected = false; });
                    } else if (isTodosNow && anyStatusSelected) {
                        // Si el usuario toca estados individuales mientras "Todos" está ON,
                        // apagamos "Todos" para permitir selección parcial.
                        // ("Todos" solo sirve para seleccionar todo / deseleccionar todo).
                        const allStatusesSelected = statusOpts.length > 0 && statusOpts.every(o => !!o.selected);
                        if (!allStatusesSelected) {
                            allOpt.selected = false;
                        }
                    }

                    lastTodosSelected = !!allOpt?.selected;
                    enforceStatusSelectionRules();
                    refreshStatusPickerUI();
                } catch (e) {
                }
                suppressStatusSync = false;
                try { renderAll(); } catch (e) { }
            }, 0);
        };

        filterStatus.addEventListener('change', handleStatusChanged);
        try {
            if (window.jQuery && window.jQuery.fn && typeof window.jQuery.fn.selectpicker === 'function') {
                window.jQuery(filterStatus).on('changed.bs.select', handleStatusChanged);
            }
        } catch (e) {
        }

        try {
            setTodosOnlySelected();
            try {
                const { allOpt } = getStatusOptions();
                lastTodosSelected = !!allOpt?.selected;
            } catch (e) { }
            filterStatus.dispatchEvent(new Event('change', { bubbles: true }));
        } catch (e) { }
    }

    function setStatusFilterButtonText(text) {
        if (!filterStatus) return;
        const t = String(text || '').trim();
        const root = filterStatus.closest('th') || filterStatus.parentElement || document;
        const selectors = [
            'button.multiselect',
            'button[data-id="inv-status"]',
            '.dropdown-toggle[data-id="inv-status"]',
            '.bootstrap-select button',
        ];
        let btn = null;
        for (let i = 0; i < selectors.length; i++) {
            try {
                btn = root.querySelector(selectors[i]);
                if (btn) break;
            } catch (e) {
            }
        }
        if (!btn) return;
        const innerSelectors = [
            '.filter-option-inner-inner',
            '.filter-option',
            'span',
        ];
        for (let i = 0; i < innerSelectors.length; i++) {
            try {
                const el = btn.querySelector(innerSelectors[i]);
                if (el) {
                    el.textContent = t;
                    return;
                }
            } catch (e) {
            }
        }
        try { btn.textContent = t; } catch (e) { }
    }

    function refreshStatusFilterCompactLabel() {
        if (!filterStatus) return;
        const { allOpt, statusOpts } = getStatusOptions();
        if (!allOpt) return;
        const selected = statusOpts.filter(o => !!o.selected);
        if (!selected.length) {
            setStatusFilterButtonText('Ninguno');
            return;
        }
        if (selected.length === statusOpts.length) {
            setStatusFilterButtonText('Todos');
            return;
        }
        if (selected.length === 1) {
            setStatusFilterButtonText(String(selected[0].value || '').trim() || 'Estado');
            return;
        }
        setStatusFilterButtonText(String(selected.length) + ' seleccionados');
    }

    if (filterStatus) {
        filterStatus.addEventListener('change', function () {
            try { refreshStatusFilterCompactLabel(); } catch (e) { }
        });
        try {
            setTimeout(function () { try { refreshStatusFilterCompactLabel(); } catch (e) { } }, 0);
            setTimeout(function () { try { refreshStatusFilterCompactLabel(); } catch (e) { } }, 250);
        } catch (e) {
        }
    }

    if (kpiAlertsCard) {
        kpiAlertsCard.addEventListener('click', function () {
            setStatusFilter(['Reponer', 'Crítico']);
            try { switchTab('current'); } catch (e) { }
            try { document.getElementById('panel-current')?.scrollIntoView?.({ behavior: 'smooth', block: 'start' }); } catch (e) { }
        });
    }

    try { restoreInventoryDraft(); } catch (e) { }
    applyReturnedSupplierSelection();

    switchTab('current');
});
</script>
{% endblock %}
