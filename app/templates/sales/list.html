{% extends 'base.html' %}
{% block title %}Ventas{% endblock %}
{% block content %}
<!-- HOME de Ventas: acciones principales + indicadores + historial -->
<div id="ventas-home" class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-2xl font-bold text-gray-900">Ventas</h1>
            <p class="mt-1 text-sm text-gray-600">Registr√° ventas, gestion√° cambios y visualiz√° el historial del d√≠a.</p>
        </div>
        <div class="flex gap-3">
            <button id="btn-nueva-venta" class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                <i class="fas fa-plus mr-2"></i> Nueva venta
            </button>
            <button id="btn-ir-cambios" class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md border border-indigo-200 text-indigo-700 bg-indigo-50 hover:bg-indigo-100">
                <i class="fas fa-exchange-alt mr-2"></i> Realizar cambio
            </button>
        </div>
    </div>

    <!-- Indicadores r√°pidos -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-2 items-stretch">
        <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col items-center justify-center text-center">
            <div class="h-10 w-10 mb-2 flex items-center justify-center rounded-full bg-indigo-50 text-indigo-700">
                <i class="fas fa-cash-register"></i>
            </div>
            <div>
                <p class="text-xs uppercase tracking-wide text-gray-500">Ventas del d√≠a</p>
                <p id="kpi-ventas-dia" class="text-lg font-semibold text-gray-900">$0,00</p>
            </div>
        </div>
        <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col items-center justify-center text-center">
            <div class="h-10 w-10 mb-2 flex items-center justify-center rounded-full bg-blue-50 text-blue-700">
                <i class="fas fa-receipt"></i>
            </div>
            <div>
                <p class="text-xs uppercase tracking-wide text-gray-500">Cantidad de ventas</p>
                <p id="kpi-tickets-dia" class="text-lg font-semibold text-gray-900">0</p>
            </div>
        </div>
        <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col items-center justify-center text-center">
            <div class="h-10 w-10 mb-2 flex items-center justify-center rounded-full bg-green-50 text-green-700">
                <i class="fas fa-box-open"></i>
            </div>
            <div>
                <p class="text-xs uppercase tracking-wide text-gray-500">Cantidad de art√≠culos vendidos</p>
                <p id="kpi-items-dia" class="text-lg font-semibold text-gray-900">0</p>
            </div>
        </div>

        <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col items-center justify-center text-center">
            <div class="h-10 w-10 mb-2 flex items-center justify-center rounded-full bg-emerald-50 text-emerald-700">
                <i class="fas fa-ticket-alt"></i>
            </div>
            <div>
                <p class="text-xs uppercase tracking-wide text-gray-500">Ticket promedio</p>
                <p id="kpi-ticket-promedio" class="text-lg font-semibold text-gray-900">$0,00</p>
            </div>
        </div>
    </div>

    <div id="modal-arqueo" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative h-full w-full flex items-center justify-center p-4 md:p-6">
            <div class="w-full bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden" style="max-width:820px;max-height:85vh">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">Arqueo de caja</h2>
                        <p class="text-xs text-gray-500">Se guarda por d√≠a y queda visible en Movimientos.</p>
                    </div>
                    <button id="btn-close-arqueo" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5 overflow-y-auto" style="max-height:calc(85vh - 132px)">
                    <div id="panel-arqueo" class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block font-medium text-gray-600 mb-1 text-xs">Fecha de arqueo</label>
                                <input id="fecha-arqueo" type="date" class="w-full px-3 py-2 border rounded-md text-sm" value="{{ now.strftime('%Y-%m-%d') }}">
                            </div>
                            <div>
                                <label class="block font-medium text-gray-600 mb-1 text-xs">Empleado responsable del arqueo</label>
                                <select id="arqueo-employee" class="w-full px-3 py-2 border rounded-md text-sm bg-white">
                                    <option value="">‚Äî Seleccionar ‚Äî</option>
                                </select>
                                <p id="msg-arqueo-no-employees" class="mt-1 text-[11px] text-gray-500 hidden">No hay empleados cargados. <a href="{{ url_for('employees.new') }}" class="text-indigo-700 hover:underline">Crear empleado</a></p>
                                <p id="msg-arqueo-employee-required" class="mt-1 text-[11px] text-red-600 hidden flex items-center gap-1"><i class="fas fa-exclamation-circle"></i><span>Seleccion√° un empleado responsable para guardar el arqueo.</span></p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="block font-medium text-gray-600 mb-1 text-xs">Apertura</label>
                                <input id="monto-apertura" type="number" class="w-full px-3 py-2 border rounded-md text-sm" placeholder="Ej: 50000">
                            </div>
                            <div>
                                <label class="block font-medium text-gray-600 mb-1 text-xs">Efectivo del d√≠a (calculado)</label>
                                <input id="monto-efectivo-dia" type="number" class="w-full px-3 py-2 border rounded-md text-sm bg-gray-50" placeholder="Se calcula solo" readonly>
                                <div class="mt-1 text-xs text-gray-500 whitespace-nowrap">Ventas en efectivo ‚Äì Egresos en efectivo</div>
                            </div>
                            <div>
                                <label class="block font-medium text-gray-600 mb-1 text-xs">Cierre</label>
                                <input id="monto-cierre" type="number" class="w-full px-3 py-2 border rounded-md text-sm" placeholder="Ej: 70000">
                            </div>
                        </div>

                        <div class="rounded-lg border border-gray-200 bg-gray-50 p-3">
                            <p id="msg-arqueo-ok" class="text-[11px] text-green-700 hidden flex items-center gap-1">
                                <i class="fas fa-check-circle"></i><span>Arqueo correcto.</span>
                            </p>
                            <p id="msg-arqueo-error" class="text-[11px] text-red-700 hidden flex items-center gap-1">
                                <i class="fas fa-exclamation-circle"></i><span>Cierre de caja err√≥neo.</span>
                            </p>
                            <p id="msg-arqueo-detalle" class="text-[11px] text-gray-700 hidden"></p>
                            <p id="msg-arqueo-guardado" class="mt-2 text-[11px] text-indigo-700 hidden flex items-center gap-1">
                                <i class="fas fa-save"></i><span>Arqueo guardado.</span>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="px-5 py-4 border-t border-gray-100 flex items-center justify-end gap-2 bg-white">
                    <button id="btn-cancel-arqueo" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cerrar</button>
                    <button id="btn-guardar-arqueo" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">Guardar arqueo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Historial combinado -->
    <div id="historial-ventas" class="bg-white rounded-xl shadow overflow-visible">
        <div class="px-4 py-3 border-b border-gray-100 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <div>
                <h2 class="text-sm font-semibold text-gray-900">Historial de movimientos</h2>
                <p class="text-xs text-gray-500">Ventas y cambios recientes.</p>
            </div>
            <div class="flex flex-wrap gap-2 text-[11px]">
                <button id="btn-toggle-arqueo" type="button" class="px-3 py-1 rounded-md border border-emerald-300 bg-emerald-100 text-emerald-900 hover:bg-emerald-200 inline-flex items-center gap-2">
                    <i class="fas fa-cash-register text-[10px] text-emerald-800"></i>
                    <span class="font-medium">Arqueo de Caja</span>
                    <span id="arqueo-status-badge" class="text-[11px] px-2 py-0.5 rounded-full border bg-yellow-50 text-yellow-800 border-yellow-100">Pendiente</span>
                    <i class="fas fa-arrow-right text-[10px] text-emerald-800/70"></i>
                </button>
                <button id="btn-export-ventas" type="button" class="px-3 py-1 rounded-md border border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 inline-flex items-center gap-2">
                    <span>Exportar</span>
                    <i class="fas fa-file-export text-[10px]"></i>
                </button>
                <button id="btn-clear-ventas" type="button" class="px-3 py-1 rounded-md border border-gray-200 bg-gray-50 hover:bg-gray-100 text-gray-700">Limpiar filtros</button>
            </div>
        </div>
        <table class="min-w-full divide-y divide-gray-200 text-xs">
            <thead class="bg-gray-50">
                <tr class="text-xs">
                    <th class="px-3 py-2 text-left text-gray-600 font-semibold align-bottom">Ticket</th>
                    <th class="px-3 py-2 text-left text-gray-600 font-semibold align-bottom">Fecha <i class="fas fa-chevron-down ml-1 text-gray-400"></i></th>
                    <th class="px-3 py-2 text-left text-gray-600 font-semibold align-bottom">Tipo <i class="fas fa-chevron-down ml-1 text-gray-400"></i></th>
                    <th class="px-3 py-2 text-left text-gray-600 font-semibold align-bottom">Cliente</th>
                    <th class="px-3 py-2 text-right text-gray-600 font-semibold align-bottom">Total</th>
                    <th class="px-3 py-2 text-center text-gray-600 font-semibold align-bottom">Pago <i class="fas fa-chevron-down ml-1 text-gray-400"></i></th>
                    <th class="px-3 py-2 text-center text-gray-600 font-semibold align-bottom">Estado <i class="fas fa-chevron-down ml-1 text-gray-400"></i></th>
                    <th class="px-3 py-2 text-center text-gray-600 font-semibold align-bottom"></th>
                </tr>
                <tr class="text-[11px] bg-white align-middle">
                    <th class="px-3 py-1">
                        <input id="ventas-search-ticket" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600" placeholder="Buscar por ticket">
                    </th>
                    <th class="px-3 py-1 text-left text-gray-400">
                        <div class="inline-block min-w-[110px] max-w-[140px] w-full">
                            <input type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 fecha-rango-input" placeholder="dd/mm/aaaa - dd/mm/aaaa">
                        </div>
                    </th>
                    <th class="px-3 py-1 text-left text-gray-400">
                        <select id="ventas-filter-tipo" class="px-2 py-0.5 border rounded-md text-xs text-gray-600 w-20 -ml-2 block">
                            <option value="">Todos</option>
                            <option>Venta</option>
                            <option>Cambio</option>
                        </select>
                    </th>
                    <th class="px-3 py-1">
                        <input id="ventas-search-cliente" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600" placeholder="Buscar por cliente">
                    </th>
                    <th class="px-3 py-1"></th>
                    <th class="px-3 py-1 text-center text-gray-400">
                        <select id="ventas-filter-pago" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600">
                            <option value="">Todas</option>
                            <option>Efectivo</option>
                            <option>Transferencia</option>
                            <option>D√©bito</option>
                            <option>Cr√©dito</option>
                        </select>
                    </th>
                    <th class="px-3 py-1 text-center text-gray-400">
                        <select id="ventas-filter-estado" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600">
                            <option value="">Todas</option>
                            <option>Completada</option>
                            <option>Pendiente</option>
                            <option>Cambio</option>
                        </select>
                    </th>
                    <th class="px-3 py-1"></th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-100">
                <tr>
                    <td colspan="8" class="px-4 py-6 text-center text-sm text-gray-500">Cargando movimientos‚Ä¶</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="modal-export-ventas" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative h-full w-full flex items-center justify-center p-4">
            <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div>
                        <h3 class="text-base font-semibold text-gray-900">Exportar historial</h3>
                        <p class="text-xs text-gray-500">Se exporta exactamente la tabla visible (con filtros aplicados).</p>
                    </div>
                    <button id="btn-close-export-ventas" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="btn-export-ventas-pdf" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                        <div class="text-2xl">üìÑ</div>
                        <div class="mt-2 font-semibold text-gray-900">Exportar a PDF</div>
                        <div class="text-xs text-gray-500">Ideal para imprimir o enviar.</div>
                    </button>
                    <button id="btn-export-ventas-xls" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                        <div class="text-2xl">üìä</div>
                        <div class="mt-2 font-semibold text-gray-900">Exportar a Excel</div>
                        <div class="text-xs text-gray-500">Descarga un CSV compatible.</div>
                    </button>
                </div>
                <div class="px-5 py-4 border-t border-gray-100 flex justify-end">
                    <button id="btn-cancel-export-ventas" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

<div id="modal-cuenta-corriente" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Cuenta corriente</h3>
                    <p class="text-xs text-gray-500">Indic√° cu√°nto abona ahora y se registrar√° el saldo pendiente en el legajo del cliente.</p>
                </div>
                <button id="btn-close-cc" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="p-3 border border-gray-200 rounded-lg">
                        <div class="text-[11px] text-gray-500">Cliente</div>
                        <div id="cc-cliente" class="mt-1 text-sm font-semibold text-gray-900 truncate">‚Äî</div>
                        <div id="cc-cliente-alertas" class="mt-2 text-[11px] text-gray-600">‚Äî</div>
                    </div>
                    <div class="p-3 border border-gray-200 rounded-lg">
                        <div class="text-[11px] text-gray-500">Total del ticket</div>
                        <div id="cc-total" class="mt-1 text-sm font-semibold text-gray-900">$0,00</div>
                        <div class="mt-2 flex items-center justify-between gap-2">
                            <label class="text-[11px] text-gray-600">Abona ahora</label>
                            <input id="cc-paid" type="number" min="0" step="0.01" class="w-32 px-2 py-1 border rounded-md text-right text-sm" value="0">
                        </div>
                        <div class="mt-2 flex items-center justify-between text-[11px] text-gray-600">
                            <span>Saldo a deber</span>
                            <span id="cc-due" class="font-semibold text-red-700">$0,00</span>
                        </div>
                    </div>
                </div>
                <div id="cc-error" class="text-[11px] text-red-600 hidden flex items-center gap-1"><i class="fas fa-exclamation-circle"></i><span>Revis√° el monto abonado.</span></div>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                <button id="btn-cancel-cc" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="btn-accept-cc" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">Aceptar</button>
            </div>
        </div>
    </div>
</div>

<!-- Vista: realizar cambio -->
<div id="vista-realizar-cambio" class="hidden space-y-4">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
            <button id="btn-volver-desde-cambio" class="h-8 w-8 flex items-center justify-center rounded-full bg-white shadow text-gray-600 hover:text-gray-900">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Realizar cambio</h2>
                <p class="text-xs text-gray-500">Registr√° un cambio usando stock real (devoluci√≥n + nueva venta) y se reflejar√° en el historial.</p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow p-4 space-y-4 text-sm">
        <!-- Indicador de pasos internos del flujo de cambio -->
        <div class="flex items-center justify-between mb-2 text-[11px]">
            <div class="flex gap-2 flex-wrap">
                <span id="pill-cambio-paso1" class="px-3 py-1 rounded-full bg-indigo-600 text-white font-medium">1. Seleccionar {{ label_products|lower }} del cambio</span>
                <span id="pill-cambio-paso2" class="px-3 py-1 rounded-full bg-indigo-50 text-indigo-700">2. Nueva venta con saldo a favor</span>
                <span id="pill-cambio-paso3" class="px-3 py-1 rounded-full bg-gray-100 text-gray-600">3. Ticket y registro</span>
            </div>
        </div>

        <!-- Paso 1: selecci√≥n de productos del cambio -->
        <div id="cambio-paso1" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Cat√°logo para cambio -->
            <div class="md:col-span-2 flex flex-col h-full">
                <div id="pills-categorias-cambio" class="mb-3 flex flex-wrap gap-2 text-xs"></div>
                <div class="mb-3">
                    <div class="relative">
                        <input type="text" placeholder="Buscar {{ label_products|lower }} para el cambio..." class="w-full pl-9 pr-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>
                <div id="grid-productos-cambio" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 overflow-y-auto" style="max-height: 380px;">
                    <div class="col-span-full px-3 py-4 text-sm text-gray-500">Cargando {{ label_products|lower }} del inventario...</div>
                </div>
            </div>

            <!-- Carrito de cambio -->
            <div class="p-4 bg-white rounded-lg border border-gray-100 flex flex-col h-full text-xs">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-sm font-medium text-gray-800">Carrito de cambio</h2>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-red-50 text-red-700 border border-red-200 text-[10px] font-semibold uppercase tracking-wide">Cambio</span>
                </div>
                <div class="flex-1 overflow-y-auto overflow-x-hidden border border-gray-100 rounded-md mb-3 text-xs">
                    <table id="tabla-carrito-cambio" class="w-full text-xs">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-1 text-left text-gray-500">Nombre</th>
                                <th class="px-2 py-1 text-right text-gray-500">Precio</th>
                                <th class="px-2 py-1 text-right text-gray-500">Unid.</th>
                                <th class="px-2 py-1 text-right text-gray-500">Desc %</th>
                                <th class="px-2 py-1 text-right text-gray-500">Subt.</th>
                                <th class="px-1 py-1 text-center text-gray-500"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="carrito-cambio-empty-row">
                                <td colspan="6" class="px-2 py-3 text-center text-gray-400 text-[11px]">Agreg√° aqu√≠ los {{ label_products|lower }} involucrados en el cambio. M√°s adelante se conectar√° con el stock real.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="space-y-1 text-xs">
                    <div class="flex justify-between font-semibold"><span>Total del cambio</span><span id="total-cambio">$0,00</span></div>
                </div>
                <button id="btn-confirmar-cambio" class="mt-3 inline-flex items-center justify-center w-full px-3 py-2 text-xs font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                    Confirmar {{ label_products|lower }} del cambio
                </button>
            </div>
        </div>

        <!-- Paso 2: nueva venta con saldo a favor -->
        <div id="cambio-paso2" class="grid grid-cols-1 md:grid-cols-3 gap-4 hidden">
            <!-- Cat√°logo para nueva venta -->
            <div class="md:col-span-2 flex flex-col h-full">
                <div class="mb-3 flex flex-wrap gap-2 text-xs">
                    <span class="text-[11px] text-gray-500">Us√° el saldo a favor para una nueva compra.</span>
                </div>
                <div id="pills-categorias-cambio-venta" class="mb-3 flex flex-wrap gap-2 text-xs"></div>
                <div class="mb-3">
                    <div class="relative">
                        <input type="text" placeholder="Buscar {{ label_products|lower }} para la nueva venta..." class="w-full pl-9 pr-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>
                <div id="grid-productos-cambio-venta" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 overflow-y-auto" style="max-height: 380px;">
                    <div class="col-span-full px-3 py-4 text-sm text-gray-500">Cargando {{ label_products|lower }} del inventario...</div>
                </div>
            </div>

            <!-- Carrito de nueva venta con saldo a favor -->
            <div class="p-4 bg-white rounded-lg border border-gray-100 flex flex-col h-full text-xs">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-sm font-medium text-gray-800">Nueva venta (con saldo a favor)</h2>
                </div>
                <div class="flex-1 overflow-y-auto overflow-x-hidden border border-gray-100 rounded-md mb-3 text-xs">
                    <table id="tabla-carrito-cambio-venta" class="w-full text-xs">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-1 text-left text-gray-500">Nombre</th>
                                <th class="px-2 py-1 text-right text-gray-500">Precio</th>
                                <th class="px-2 py-1 text-right text-gray-500">Unid.</th>
                                <th class="px-2 py-1 text-right text-gray-500">Desc %</th>
                                <th class="px-2 py-1 text-right text-gray-500">Subt.</th>
                                <th class="px-1 py-1 text-center text-gray-500"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="carrito-cambio-venta-empty-row">
                                <td colspan="6" class="px-2 py-3 text-center text-gray-400 text-[11px]">Arm√° aqu√≠ la nueva compra usando el saldo a favor del cambio.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="space-y-1 text-xs">
                    <div class="flex justify-between"><span>Saldo a favor por cambio</span><span id="saldo-a-favor" class="font-semibold text-indigo-700">$0,00</span></div>
                    <div class="flex justify-between"><span>Total nueva compra</span><span id="total-cambio-venta" class="font-semibold text-gray-900">$0,00</span></div>
                    <div class="flex justify-between"><span>Diferencia a abonar</span><span id="diferencia-a-abonar" class="font-semibold text-gray-900">$0,00</span></div>
                </div>
                <button id="btn-confirmar-cambio-venta" class="mt-3 inline-flex items-center justify-center w-full px-3 py-2 text-xs font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                    Confirmar nueva venta
                </button>
            </div>
        </div>

        <!-- Paso 3: ticket, cliente y registro -->
        <div id="cambio-paso3" class="space-y-4 hidden">
            <div class="flex items-center gap-3 mb-1">
                <div>
                    <h3 class="text-sm font-semibold text-gray-900">Paso 3 ¬∑ Detalles del ticket y cliente</h3>
                    <p class="text-xs text-gray-500">Revis√° la forma de pago, asoci√° un cliente y dej√° notas internas.</p>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
                <div class="p-4 bg-white rounded-lg border border-gray-100 space-y-3 lg:col-span-2">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1"># Ticket</label>
                            <input type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-gray-50" value="#0000" disabled>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Ticket original (a reemplazar)</label>
                            <input id="cambio-ticket-original" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="#0001">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Fecha del ticket</label>
                            <input id="cambio-fecha" type="date" class="w-full px-3 py-2 text-sm border rounded-md" value="{{ now.strftime('%Y-%m-%d') }}">
                        </div>
                        <div class="md:col-span-1">
                            <label class="block text-xs font-medium text-gray-600 mb-1">Forma de pago</label>
                            <div class="grid grid-cols-2 gap-2 text-xs">
                                <label class="inline-flex items-center gap-1 px-2 py-1 rounded-md border border-gray-200 bg-gray-50 cursor-pointer">
                                    <input type="radio" name="cambio_forma_pago" class="text-indigo-600" checked>
                                    <span><i class="fas fa-money-bill-wave mr-1 text-green-500"></i>Efectivo</span>
                                </label>
                                <label class="inline-flex items-center gap-1 px-2 py-1 rounded-md border border-gray-200 bg-gray-50 cursor-pointer">
                                    <input type="radio" name="cambio_forma_pago" class="text-indigo-600">
                                    <span><i class="fas fa-exchange-alt mr-1 text-blue-500"></i>Transferencia</span>
                                </label>
                                <label class="inline-flex items-center gap-1 px-2 py-1 rounded-md border border-gray-200 bg-gray-50 cursor-pointer">
                                    <input type="radio" name="cambio_forma_pago" class="text-indigo-600">
                                    <span><i class="fas fa-credit-card mr-1 text-purple-500"></i>D√©bito</span>
                                </label>
                                <label class="inline-flex items-center gap-1 px-2 py-1 rounded-md border border-gray-200 bg-gray-50 cursor-pointer">
                                    <input type="radio" name="cambio_forma_pago" class="text-indigo-600">
                                    <span><i class="fas fa-credit-card mr-1 text-indigo-500"></i>Cr√©dito</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-white rounded-lg border border-gray-100 space-y-3">
                    <label class="block text-xs font-medium text-gray-600 mb-1">Notas del ticket</label>
                    <textarea id="cambio-notas" rows="5" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Observaciones internas, aclaraciones de la operaci√≥n, etc."></textarea>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
                <div class="p-4 bg-white rounded-lg border border-gray-100 space-y-3 lg:col-span-2">
                    <div class="flex items-center justify-between gap-2">
                        <span class="text-sm font-medium text-gray-800">Cliente (opcional)</span>
                        <button id="btn-select-cliente-cambio" type="button" class="px-3 py-1.5 text-xs font-medium rounded-md border border-gray-200 bg-gray-50 hover:bg-gray-100 text-gray-700">Seleccionar cliente</button>
                    </div>
                    <div id="panel-cliente-cambio" class="mt-2 space-y-3">
                        <div class="relative">
                            <input id="cambio-cliente" type="text" placeholder="üîç Buscador de cliente" class="w-full pl-9 pr-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                                <i class="fas fa-search"></i>
                            </span>
                        </div>
                        <button id="btn-crear-cliente-cambio" type="button" class="w-full inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-blue-700 bg-blue-50 rounded-md hover:bg-blue-100">
                            <i class="fas fa-user-plus mr-2"></i> Crear nuevo cliente
                        </button>
                    </div>
                </div>

                <div class="p-4 bg-white rounded-lg border border-gray-100 flex flex-col justify-between text-sm lg:sticky lg:top-24 h-full">
                    <div class="space-y-1 text-xs">
                        <div class="flex justify-between"><span>Saldo a favor</span><span id="resumen-saldo-a-favor" class="font-semibold text-indigo-700">$0,00</span></div>
                        <div class="flex justify-between"><span>Total nueva compra</span><span id="resumen-total-cambio-venta" class="font-semibold text-gray-900">$0,00</span></div>
                        <div class="flex justify-between"><span>Diferencia a abonar</span><span id="resumen-diferencia-a-abonar" class="font-semibold text-gray-900">$0,00</span></div>
                    </div>
                    <button id="btn-confirmar-cambio-final" class="w-full mt-3 inline-flex items-center justify-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                        Confirmar ticket y registrar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Flujo de venta: selecci√≥n de productos + ticket -->
<div id="ventas-flujo" class="space-y-4 hidden">
    <!-- Header con flecha de vuelta y pasos -->
    <div class="flex items-center justify-between mb-2">
        <div id="header-flujo" class="flex items-center gap-3">
            <button id="btn-volver-home" class="h-8 w-8 flex items-center justify-center rounded-full bg-white shadow text-gray-600 hover:text-gray-900">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div>
                <div class="flex items-center gap-2 flex-wrap">
                    <h2 id="ventas-flow-title" class="text-lg font-semibold text-gray-900">Registrar venta</h2>
                    <span id="ventas-edit-badge" class="hidden inline-flex items-center px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 text-[11px] font-medium">‚úèÔ∏è Editando</span>
                </div>
                <p id="ventas-flow-subtitle" class="text-xs text-gray-500">Primero eleg√≠ los {{ label_products|lower }}, luego complet√° los datos del ticket.</p>
            </div>
        </div>
    </div>

    <div class="flex items-center justify-between mb-2 text-[11px]">
        <div class="flex gap-2 flex-wrap">
            <span id="pill-venta-paso1" class="px-3 py-1 rounded-full bg-indigo-600 text-white font-medium">1. {{ label_products }}</span>
            <span id="pill-venta-paso2" class="px-3 py-1 rounded-full bg-indigo-50 text-indigo-700">2. Ticket y cliente</span>
        </div>
    </div>

    <!-- Paso productos -->
    <div id="paso-productos" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <!-- Listado de productos -->
        <div class="md:col-span-2 p-4 bg-white rounded-lg shadow flex flex-col h-full">
            <!-- Categor√≠as como pills -->
            <div id="pills-categorias-venta" class="mb-3 flex flex-wrap gap-2 text-xs"></div>

            <!-- Buscador -->
            <div class="mb-3">
                <div class="relative">
                    <input type="text" placeholder="Buscar {{ label_products|lower }}..." class="w-full pl-9 pr-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                        <i class="fas fa-search"></i>
                    </span>
                </div>
            </div>

            <div class="mb-3 rounded-md border border-gray-200 bg-white p-3 text-xs">
                <div class="flex items-center justify-between">
                    <span class="font-medium text-gray-800">Venta libre</span>
                    <label class="inline-flex items-center text-xs text-gray-600">
                        <input id="toggle-venta-libre" type="checkbox" class="rounded border-gray-300 text-indigo-600 shadow-sm mr-2">
                        Agregar producto fuera de stock
                    </label>
                </div>
                <div id="panel-venta-libre" class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2 hidden">
                    <div class="md:col-span-2">
                        <input id="venta-libre-nombre" type="text" class="w-full px-2 py-1 border rounded-md text-xs" placeholder="Nombre del producto (venta libre)">
                    </div>
                    <div>
                        <input id="venta-libre-precio" type="number" min="0" step="0.01" class="w-full px-2 py-1 border rounded-md text-xs" placeholder="Precio">
                    </div>
                    <div class="md:col-span-3">
                        <button id="btn-agregar-venta-libre" type="button" class="inline-flex items-center justify-center w-full px-3 py-2 text-[11px] font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                            Agregar venta libre
                        </button>
                    </div>
                </div>
            </div>

            <div id="grid-productos" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 overflow-y-auto" style="max-height: 380px;">
                <div class="col-span-full px-3 py-4 text-sm text-gray-500">Cargando {{ label_products|lower }} del inventario...</div>
            </div>
        </div>

        <!-- Carrito lateral -->
        <div class="p-4 bg-white rounded-lg shadow flex flex-col h-full">
            <div class="flex items-center justify-between mb-2">
                <h2 class="text-sm font-medium text-gray-800">Carrito</h2>
            </div>
            <div class="flex-1 overflow-y-auto overflow-x-hidden border border-gray-100 rounded-md mb-3 text-xs">
                <table id="tabla-carrito" class="w-full text-xs">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-2 py-1 text-left text-gray-500">Nombre</th>
                            <th class="px-2 py-1 text-right text-gray-500">Precio</th>
                            <th class="px-2 py-1 text-right text-gray-500">Unid.</th>
                            <th class="px-2 py-1 text-right text-gray-500">Desc %</th>
                            <th class="px-2 py-1 text-right text-gray-500">Subt.</th>
                            <th class="px-1 py-1 text-center text-gray-500"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="carrito-empty-row">
                            <td colspan="6" class="px-2 py-3 text-center text-gray-400 text-[11px]">Aqu√≠ se listar√°n los {{ label_products|lower }} que vayas seleccionando, junto con los descuentos por √≠tem. M√°s adelante lo conectaremos con el inventario real.</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="space-y-2 text-xs">
                <div class="flex justify-between font-semibold"><span>Total estimado</span><span id="total-estimado">$0,00</span></div>
                <div class="flex justify-between items-center gap-2">
                    <span>Descuento general</span>
                    <input id="ticket-descuento-general" type="number" class="w-20 px-2 py-1 border rounded-md text-right" placeholder="0" min="0" max="100">
                    <span class="text-[11px] text-gray-500">%</span>
                </div>
            </div>
            <button id="btn-continuar-ticket" class="mt-3 inline-flex items-center justify-center w-full px-3 py-2 text-xs font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                Continuar al Paso 2
            </button>
        </div>
    </div>

    <!-- Paso 2: datos del ticket y cliente -->
    <div id="paso-ticket" class="space-y-4 hidden">
        <div class="flex items-center gap-3 mb-1">
            <button id="btn-volver-paso1" class="h-8 w-8 flex items-center justify-center rounded-full bg-white shadow text-gray-600 hover:text-gray-900">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div>
                <h3 class="text-sm font-semibold text-gray-900">Paso 2 ¬∑ Detalles del ticket y cliente</h3>
                <p class="text-xs text-gray-500">Revis√° la forma de pago, asoci√° un cliente y dej√° notas internas.</p>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
            <div class="p-4 bg-white rounded-lg shadow space-y-3 lg:col-span-2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1"># Ticket</label>
                        <input type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-gray-50" value="#0001" disabled>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Fecha del ticket</label>
                        <input id="ticket-fecha" type="date" class="w-full px-3 py-2 text-sm border rounded-md" value="{{ now.strftime('%Y-%m-%d') }}">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Forma de pago</label>
                        <div class="grid grid-cols-2 gap-2 text-xs">
                            <label class="inline-flex items-center gap-1 px-2 py-1 rounded-md border border-gray-200 bg-gray-50 cursor-pointer">
                                <input type="radio" name="forma_pago" value="Efectivo" class="text-indigo-600" checked>
                                <span><i class="fas fa-money-bill-wave mr-1 text-green-500"></i>Efectivo</span>
                            </label>
                            <label class="inline-flex items-center gap-1 px-2 py-1 rounded-md border border-gray-200 bg-gray-50 cursor-pointer">
                                <input type="radio" name="forma_pago" value="Transferencia" class="text-indigo-600">
                                <span><i class="fas fa-exchange-alt mr-1 text-blue-500"></i>Transferencia</span>
                            </label>
                            <label class="inline-flex items-center gap-1 px-2 py-1 rounded-md border border-gray-200 bg-gray-50 cursor-pointer">
                                <input type="radio" name="forma_pago" value="D√©bito" class="text-indigo-600">
                                <span><i class="fas fa-credit-card mr-1 text-purple-500"></i>D√©bito</span>
                            </label>
                            <label class="inline-flex items-center gap-1 px-2 py-1 rounded-md border border-gray-200 bg-gray-50 cursor-pointer">
                                <input type="radio" name="forma_pago" value="Cr√©dito" class="text-indigo-600">
                                <span><i class="fas fa-credit-card mr-1 text-indigo-500"></i>Cr√©dito</span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <label class="inline-flex items-center text-xs text-gray-600">
                        <input id="toggle-venta-libre-ticket" type="checkbox" class="rounded border-gray-300 text-indigo-600 shadow-sm mr-2">
                        Venta libre (sin stock vinculado)
                    </label>
                </div>
            </div>

            <!-- Cliente y cuenta corriente -->
            <!-- Notas del ticket (movido a la columna derecha) -->
            <div class="p-4 bg-white rounded-lg shadow space-y-3">
                <label class="block text-xs font-medium text-gray-600 mb-1">Notas del ticket</label>
                <textarea id="ticket-notas" rows="5" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Observaciones internas, aclaraciones de la operaci√≥n, etc."></textarea>
            </div>
        </div>

        <!-- Cliente y confirmaci√≥n (movidos debajo) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-4">
            <div class="p-4 bg-white rounded-lg shadow space-y-3 lg:col-span-2">
                <div class="flex items-center justify-between gap-2">
                    <span class="text-sm font-medium text-gray-800">Cliente (opcional)</span>
                    <button id="btn-select-cliente" type="button" class="px-3 py-1.5 text-xs font-medium rounded-md border border-gray-200 bg-gray-50 hover:bg-gray-100 text-gray-700">Seleccionar cliente</button>
                </div>
                <div id="panel-cliente" class="mt-2 space-y-3">
                    <div class="relative">
                        <input id="ticket-cliente-busqueda" type="text" placeholder="üîç Buscador de cliente" class="w-full pl-9 pr-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                            <i class="fas fa-search"></i>
                        </span>
                        <div id="ticket-cliente-dd" class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg overflow-hidden"></div>
                    </div>
                    <button id="btn-crear-cliente" type="button" class="w-full inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-blue-700 bg-blue-50 rounded-md hover:bg-blue-100">
                        <i class="fas fa-user-plus mr-2"></i> Crear nuevo cliente
                    </button>
                    <div class="pt-2 border-t border-gray-100 space-y-2 text-xs text-gray-600">
                        <div class="flex items-center justify-between">
                            <span>Pago</span>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            <button id="btn-pago-completo" type="button" class="w-full px-3 py-2 rounded-md text-sm font-medium bg-green-50 text-green-700 border border-green-100 hover:bg-green-100">üíµ Pago completo</button>
                            <button id="btn-cuenta-corriente" type="button" class="w-full px-3 py-2 rounded-md text-sm font-medium bg-yellow-50 text-yellow-700 border border-yellow-100 hover:bg-yellow-100">üßæ Cuenta corriente</button>
                        </div>
                        <p id="cuenta-corriente-notice" class="text-[11px] text-gray-500">Se registrar√° saldo pendiente en el legajo del cliente.</p>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow flex flex-col justify-between text-sm lg:sticky lg:top-24 h-full">
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between"><span>Total del ticket</span><span id="ticket-total-sidebar" class="font-semibold">$0,00</span></div>
                    <div class="flex justify-between"><span>Descuentos aplicados</span><span id="ticket-descuentos-sidebar" class="font-semibold">$0,00</span></div>
                    <div class="flex justify-between"><span>Descuento general</span><span id="ticket-descuento-general-view" class="font-semibold text-gray-700">0%</span></div>
                </div>
                <button id="btn-confirmar-venta" class="w-full mt-3 inline-flex items-center justify-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                    Confirmar venta
                </button>
            </div>
        </div>
    </div>
</div>

<div id="modal-select-customer" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Seleccionar cliente</h3>
                    <p class="text-xs text-gray-500">Busc√° por nombre y seleccion√° (o cerr√° para continuar sin cliente).</p>
                </div>
                <button id="btn-close-select-customer" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 space-y-3">
                <div class="relative">
                    <input id="select-customer-q" type="text" placeholder="Buscar cliente por nombre" class="w-full pl-9 pr-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400"><i class="fas fa-search"></i></span>
                </div>
                <div id="select-customer-list" class="border border-gray-200 rounded-md overflow-hidden max-h-80 overflow-y-auto">
                    <div class="px-3 py-4 text-sm text-gray-500">Sin datos.</div>
                </div>
                <button id="btn-open-create-customer" type="button" class="w-full inline-flex items-center justify-center px-3 py-2 text-sm font-medium text-blue-700 bg-blue-50 rounded-md hover:bg-blue-100">
                    <i class="fas fa-user-plus mr-2"></i> Crear nuevo cliente
                </button>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end">
                <button id="btn-cancel-select-customer" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-create-customer" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Crear cliente</h3>
                    <p class="text-xs text-gray-500">Guard√° y se seleccionar√° autom√°ticamente.</p>
                </div>
                <button id="btn-close-create-customer" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Nombre</label>
                    <input id="new-customer-first" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Ej: Juan">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Apellido</label>
                    <input id="new-customer-last" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Ej: P√©rez">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Email (opcional)</label>
                    <input id="new-customer-email" type="email" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Tel√©fono</label>
                    <input id="new-customer-phone" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="">
                </div>
                <div id="msg-create-customer-error" class="md:col-span-2 text-[11px] text-red-600 hidden flex items-center gap-1"><i class="fas fa-exclamation-circle"></i><span>Complet√° nombre, apellido y tel√©fono.</span></div>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                <button id="btn-cancel-create-customer" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="btn-save-create-customer" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">Guardar cliente</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const home = document.getElementById('ventas-home');
    const flujo = document.getElementById('ventas-flujo');
    const btnNuevaVenta = document.getElementById('btn-nueva-venta');
    const btnIrCambios = document.getElementById('btn-ir-cambios');
    const btnVolverHome = document.getElementById('btn-volver-home');
    const pasoProductos = document.getElementById('paso-productos');
    const pasoTicket = document.getElementById('paso-ticket');
    const btnContinuarTicket = document.getElementById('btn-continuar-ticket');
    const btnVolverPaso1 = document.getElementById('btn-volver-paso1');
    const toggleVentaLibre = document.getElementById('toggle-venta-libre');
    const panelVentaLibre = document.getElementById('panel-venta-libre');
    const inputVentaLibreNombre = document.getElementById('venta-libre-nombre');
    const inputVentaLibrePrecio = document.getElementById('venta-libre-precio');
    const btnAgregarVentaLibre = document.getElementById('btn-agregar-venta-libre');
    const panelCliente = document.getElementById('panel-cliente');
    const btnSelectCliente = document.getElementById('btn-select-cliente');
    const btnCrearCliente = document.getElementById('btn-crear-cliente');
    const panelClienteCambio = document.getElementById('panel-cliente-cambio');
    const btnSelectClienteCambio = document.getElementById('btn-select-cliente-cambio');
    const btnCrearClienteCambio = document.getElementById('btn-crear-cliente-cambio');
    const historial = document.getElementById('historial-ventas');
    const headerFlujo = document.getElementById('header-flujo');
    const ventasFlowTitle = document.getElementById('ventas-flow-title');
    const ventasFlowSubtitle = document.getElementById('ventas-flow-subtitle');
    const ventasEditBadge = document.getElementById('ventas-edit-badge');
    const pillPaso1 = document.getElementById('pill-venta-paso1') || null;
    const pillPaso2 = document.getElementById('pill-venta-paso2') || null;
    const montoApertura = document.getElementById('monto-apertura');
    const montoCierre = document.getElementById('monto-cierre');
    const btnArqueo = document.getElementById('btn-arqueo');
    const msgArqueoOk = document.getElementById('msg-arqueo-ok');
    const msgArqueoError = document.getElementById('msg-arqueo-error');
    const msgArqueoDetalle = document.getElementById('msg-arqueo-detalle');
    const msgArqueoGuardado = document.getElementById('msg-arqueo-guardado');
    const btnGuardarArqueo = document.getElementById('btn-guardar-arqueo');
    const montoEfectivoDia = document.getElementById('monto-efectivo-dia');
    const btnConfirmarVenta = document.getElementById('btn-confirmar-venta');
    const btnToggleArqueo = document.getElementById('btn-toggle-arqueo');
    const modalArqueo = document.getElementById('modal-arqueo');
    const btnCloseArqueo = document.getElementById('btn-close-arqueo');
    const btnCancelArqueo = document.getElementById('btn-cancel-arqueo');
    const arqueoStatusBadge = document.getElementById('arqueo-status-badge');
    const selectArqueoEmployee = document.getElementById('arqueo-employee');
    const msgArqueoNoEmployees = document.getElementById('msg-arqueo-no-employees');
    const msgArqueoEmployeeRequired = document.getElementById('msg-arqueo-employee-required');
    const gridProductos = document.getElementById('grid-productos');
    const gridProductosCambio = document.getElementById('grid-productos-cambio');
    const gridProductosCambioVenta = document.getElementById('grid-productos-cambio-venta');
    const ticketFecha = document.getElementById('ticket-fecha');
    const ticketNotas = document.getElementById('ticket-notas');
    const toggleVentaLibreTicket = document.getElementById('toggle-venta-libre-ticket');
    const tablaCarrito = document.getElementById('tabla-carrito');
    let carritoEmptyRow = document.getElementById('carrito-empty-row');
    const totalEstimadoEl = document.getElementById('total-estimado');
    const vistaRealizarCambio = document.getElementById('vista-realizar-cambio');
    const btnVolverDesdeCambio = document.getElementById('btn-volver-desde-cambio');
    const botonesMenuMov = document.querySelectorAll('.btn-mov-menu');
    const menusMov = document.querySelectorAll('.menu-mov-acciones');
    const inputFechaRango = document.querySelector('.fecha-rango-input');
    const btnExportVentas = document.getElementById('btn-export-ventas');
    const btnClearVentas = document.getElementById('btn-clear-ventas');
    const modalExportVentas = document.getElementById('modal-export-ventas');
    const btnCloseExportVentas = document.getElementById('btn-close-export-ventas');
    const btnCancelExportVentas = document.getElementById('btn-cancel-export-ventas');
    const btnExportVentasPdf = document.getElementById('btn-export-ventas-pdf');
    const btnExportVentasXls = document.getElementById('btn-export-ventas-xls');
    const inputSearchVentas = document.getElementById('ventas-search');
    const inputSearchVentasCliente = document.getElementById('ventas-search-cliente');
    const inputSearchVentasTicket = document.getElementById('ventas-search-ticket');
    const selectVentasTipo = document.getElementById('ventas-filter-tipo');
    const selectVentasPago = document.getElementById('ventas-filter-pago');
    const selectVentasEstado = document.getElementById('ventas-filter-estado');
    const kpiVentasDiaEl = document.getElementById('kpi-ventas-dia');
    const kpiTicketsDiaEl = document.getElementById('kpi-tickets-dia');
    const kpiItemsDiaEl = document.getElementById('kpi-items-dia');
    const kpiTicketPromedioEl = document.getElementById('kpi-ticket-promedio');
    // Elementos espec√≠ficos del flujo de cambio
    let botonesProductoCambio = [];
    const tablaCarritoCambio = document.getElementById('tabla-carrito-cambio');
    const carritoCambioEmptyRow = document.getElementById('carrito-cambio-empty-row');
    const totalCambioEl = document.getElementById('total-cambio');
    const btnConfirmarCambio = document.getElementById('btn-confirmar-cambio');
    const pillsCategoriasVentaWrap = document.getElementById('pills-categorias-venta');
    const pillsCategoriasCambioWrap = document.getElementById('pills-categorias-cambio');
    const pillsCategoriasCambioVentaWrap = document.getElementById('pills-categorias-cambio-venta');
    const cambioPaso1 = document.getElementById('cambio-paso1');
    const cambioPaso2 = document.getElementById('cambio-paso2');
    const cambioPaso3 = document.getElementById('cambio-paso3');
    const pillCambioPaso1 = document.getElementById('pill-cambio-paso1');
    const pillCambioPaso2 = document.getElementById('pill-cambio-paso2');
    const pillCambioPaso3 = document.getElementById('pill-cambio-paso3');
    let botonesProductoCambioVenta = [];
    const tablaCarritoCambioVenta = document.getElementById('tabla-carrito-cambio-venta');
    const carritoCambioVentaEmptyRow = document.getElementById('carrito-cambio-venta-empty-row');
    const saldoAFavorEl = document.getElementById('saldo-a-favor');
    const totalCambioVentaEl = document.getElementById('total-cambio-venta');
    const diferenciaAbonarEl = document.getElementById('diferencia-a-abonar');
    const btnConfirmarCambioVenta = document.getElementById('btn-confirmar-cambio-venta');
    const resumenSaldoAFavorEl = document.getElementById('resumen-saldo-a-favor');
    const resumenTotalCambioVentaEl = document.getElementById('resumen-total-cambio-venta');
    const resumenDiferenciaAbonarEl = document.getElementById('resumen-diferencia-a-abonar');
    const inputCambioTicketOriginal = document.getElementById('cambio-ticket-original');
    const inputClienteCambio = document.getElementById('cambio-cliente');
    const inputNotasCambio = document.getElementById('cambio-notas');
    const btnConfirmarCambioFinal = document.getElementById('btn-confirmar-cambio-final');
    const historialTbody = historial ? historial.querySelector('tbody') : null;

    let botonesProducto = document.querySelectorAll('.btn-producto');

    let saldoAFavor = 0;

    const inputDescuentoGeneral = document.getElementById('ticket-descuento-general');
    const ticketDescuentoGeneralView = document.getElementById('ticket-descuento-general-view');
    const ticketTotalSidebar = document.getElementById('ticket-total-sidebar');
    const ticketDescuentosSidebar = document.getElementById('ticket-descuentos-sidebar');
    const inputClienteBusqueda = document.getElementById('ticket-cliente-busqueda');
    const ddCliente = document.getElementById('ticket-cliente-dd');
    const btnPagoCompleto = document.getElementById('btn-pago-completo');
    const btnCuentaCorriente = document.getElementById('btn-cuenta-corriente');
    const modalCuentaCorriente = document.getElementById('modal-cuenta-corriente');
    const btnCloseCc = document.getElementById('btn-close-cc');
    const btnCancelCc = document.getElementById('btn-cancel-cc');
    const btnAcceptCc = document.getElementById('btn-accept-cc');
    const ccCliente = document.getElementById('cc-cliente');
    const ccClienteAlertas = document.getElementById('cc-cliente-alertas');
    const ccTotal = document.getElementById('cc-total');
    const ccPaid = document.getElementById('cc-paid');
    const ccDue = document.getElementById('cc-due');
    const ccError = document.getElementById('cc-error');
    const modalSelectCustomer = document.getElementById('modal-select-customer');
    const btnCloseSelectCustomer = document.getElementById('btn-close-select-customer');
    const btnCancelSelectCustomer = document.getElementById('btn-cancel-select-customer');
    const inputSelectCustomerQ = document.getElementById('select-customer-q');
    const listSelectCustomer = document.getElementById('select-customer-list');
    const btnOpenCreateCustomer = document.getElementById('btn-open-create-customer');
    const modalCreateCustomer = document.getElementById('modal-create-customer');
    const btnCloseCreateCustomer = document.getElementById('btn-close-create-customer');
    const btnCancelCreateCustomer = document.getElementById('btn-cancel-create-customer');
    const btnSaveCreateCustomer = document.getElementById('btn-save-create-customer');
    const inputNewCustomerFirst = document.getElementById('new-customer-first');
    const inputNewCustomerLast = document.getElementById('new-customer-last');
    const inputNewCustomerEmail = document.getElementById('new-customer-email');
    const inputNewCustomerPhone = document.getElementById('new-customer-phone');
    const msgCreateCustomerError = document.getElementById('msg-create-customer-error');

    let cacheCustomers = [];
    let selectedCustomer = null;
    let currentCustomerContext = 'sale';
    let editTicketId = null;

    let ventaOnAccount = false;
    let ventaPaidAmount = 0;

    function isModalEl(el) {
        try {
            if (!el) return false;
            const id = String(el.id || '');
            if (id.startsWith('modal-')) return true;
            const cls = el.classList;
            if (cls && cls.contains('fixed') && cls.contains('inset-0')) return true;
        } catch (e) {
        }
        return false;
    }

    function showOnlyInsideHome(elToShow) {
        if (!home) return;
        try {
            const children = Array.from(home.children || []);
            children.forEach(ch => {
                if (!ch || !(ch instanceof HTMLElement)) return;
                // Nunca destapar modales desde helpers de navegaci√≥n
                if (isModalEl(ch)) {
                    ch.classList.add('hidden');
                    return;
                }
                if (elToShow && ch === elToShow) ch.classList.remove('hidden');
                else ch.classList.add('hidden');
            });
            home.classList.remove('hidden');
        } catch (e) {
        }
    }

    function showHomeAll() {
        if (!home) return;
        try {
            const children = Array.from(home.children || []);
            children.forEach(ch => {
                if (!ch || !(ch instanceof HTMLElement)) return;
                // Nunca destapar modales desde helpers de navegaci√≥n
                if (isModalEl(ch)) {
                    ch.classList.add('hidden');
                    return;
                }
                if (ch === flujo || ch === vistaRealizarCambio) ch.classList.add('hidden');
                else ch.classList.remove('hidden');
            });
            home.classList.remove('hidden');
        } catch (e) {
        }
        if (flujo && (!home || !home.contains(flujo))) flujo.classList.add('hidden');
        if (vistaRealizarCambio && (!home || !home.contains(vistaRealizarCambio))) vistaRealizarCambio.classList.add('hidden');
    }

    function showFlujo() {
        if (home && flujo && home.contains(flujo)) {
            showOnlyInsideHome(flujo);
        } else {
            if (home) home.classList.add('hidden');
            if (flujo) flujo.classList.remove('hidden');
            if (vistaRealizarCambio) vistaRealizarCambio.classList.add('hidden');
        }
    }

    function showCambio() {
        if (home && vistaRealizarCambio && home.contains(vistaRealizarCambio)) {
            showOnlyInsideHome(vistaRealizarCambio);
        } else {
            if (home) home.classList.add('hidden');
            if (flujo) flujo.classList.add('hidden');
            if (vistaRealizarCambio) vistaRealizarCambio.classList.remove('hidden');
        }
    }

    function getCartItemsCambio() {
        if (!tablaCarritoCambio) return [];
        const rows = Array.from(tablaCarritoCambio.querySelectorAll('tbody tr')).filter(tr => tr && tr.id !== 'carrito-cambio-empty-row');
        return rows.map(tr => {
            const nombre = String(tr.querySelector('td')?.textContent || '').trim() || 'Producto';
            const precio = parseFloat(tr.querySelector('.input-precio-cambio')?.value || '0') || 0;
            const cantidad = parseFloat(tr.querySelector('.input-cantidad-cambio')?.value || '0') || 0;
            const descuento = parseFloat(tr.querySelector('.input-descuento-cambio')?.value || '0') || 0;
            const subtotal = parseFloat(tr.querySelector('.input-subtotal-cambio')?.value || '0') || 0;
            const productId = String(tr.getAttribute('data-product-id') || '').trim();
            return {
                product_id: productId,
                nombre,
                precio,
                cantidad,
                descuento,
                subtotal,
                direction: 'in'
            };
        }).filter(it => (parseFloat(it.cantidad || 0) || 0) > 0);
    }

    function getCartItemsCambioVenta() {
        if (!tablaCarritoCambioVenta) return [];
        const rows = Array.from(tablaCarritoCambioVenta.querySelectorAll('tbody tr')).filter(tr => tr && tr.id !== 'carrito-cambio-venta-empty-row');
        return rows.map(tr => {
            const nombre = String(tr.querySelector('td')?.textContent || '').trim() || 'Producto';
            const precio = parseFloat(tr.querySelector('.input-precio-cambio-venta')?.value || '0') || 0;
            const cantidad = parseFloat(tr.querySelector('.input-cantidad-cambio-venta')?.value || '0') || 0;
            const descuento = parseFloat(tr.querySelector('.input-descuento-cambio-venta')?.value || '0') || 0;
            const subtotal = parseFloat(tr.querySelector('.input-subtotal-cambio-venta')?.value || '0') || 0;
            const productId = String(tr.getAttribute('data-product-id') || '').trim();
            return {
                product_id: productId,
                nombre,
                precio,
                cantidad,
                descuento,
                subtotal,
                direction: 'out'
            };
        }).filter(it => (parseFloat(it.cantidad || 0) || 0) > 0);
    }

    function getCambioPaymentMethod() {
        const checked = document.querySelector('input[name="cambio_forma_pago"]:checked');
        if (!checked) return 'Efectivo';
        const label = checked.closest('label');
        const txt = String(label?.textContent || '').replace(/\s+/g, ' ').trim();
        if (txt.toLowerCase().includes('transferencia')) return 'Transferencia';
        if (txt.toLowerCase().includes('d√©bito') || txt.toLowerCase().includes('debito')) return 'D√©bito';
        if (txt.toLowerCase().includes('cr√©dito') || txt.toLowerCase().includes('credito')) return 'Cr√©dito';
        return 'Efectivo';
    }

    function historialAccionesHtml(ticket) {
        const t = String(ticket || '').trim();
        return ''
            + '<div class="relative inline-block text-left">'
            +   '<button type="button" class="btn-mov-menu inline-flex items-center justify-center h-7 w-7 rounded-full hover:bg-gray-100" data-ticket="' + t + '">' 
            +     '<i class="fas fa-ellipsis-v text-gray-500 text-xs"></i>'
            +   '</button>'
            +   '<div class="menu-mov-acciones hidden origin-top-right absolute right-0 mt-1 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">'
            +     '<div class="py-1 text-[11px]">'
            +       '<button type="button" class="w-full text-left px-3 py-1.5 hover:bg-gray-100 opcion-ver-ticket" data-ticket="' + t + '">Ver / editar ticket</button>'
            +       '<button type="button" class="w-full text-left px-3 py-1.5 text-red-600 hover:bg-red-50 opcion-eliminar-ticket" data-ticket="' + t + '">Eliminar ticket</button>'
            +     '</div>'
            +   '</div>'
            + '</div>';
    }

    let salesCache = [];
    let salesLoaded = false;
    let salesLoadPromise = null;

    function isoFromDate(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return y + '-' + m + '-' + day;
    }

    function apiListSales(range) {
        const qs = [];
        if (range && range.from) qs.push('from=' + encodeURIComponent(isoFromDate(range.from)));
        if (range && range.to) qs.push('to=' + encodeURIComponent(isoFromDate(range.to)));
        qs.push('limit=2000');
        const url = '/sales/api/sales' + (qs.length ? ('?' + qs.join('&')) : '');
        return fetch(url, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => (data && data.ok && Array.isArray(data.items)) ? data.items : []);
    }

    function apiCreateSale(payload) {
        return fetch('/sales/api/sales', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        }).then(r => r.json());
    }

    function apiCreateExchange(payload) {
        return fetch('/sales/api/exchanges', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        }).then(r => r.json());
    }

    function apiUpdateSale(ticket, payload) {
        return fetch('/sales/api/sales/' + encodeURIComponent(String(ticket || '').trim()), {
            method: 'PUT',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload || {})
        }).then(r => r.json());
    }

    function apiDeleteSale(ticket) {
        return fetch('/sales/api/sales/' + encodeURIComponent(String(ticket || '').trim()), {
            method: 'DELETE',
            credentials: 'same-origin'
        }).then(r => r.json());
    }

    function loadSalesFromServer() {
        if (salesLoadPromise) return salesLoadPromise;
        const to = new Date();
        const from = new Date();
        from.setDate(from.getDate() - 365);
        salesLoadPromise = apiListSales({ from, to }).then(items => {
            salesCache = Array.isArray(items) ? items : [];
            salesLoaded = true;
            return salesCache;
        }).catch(() => {
            salesCache = [];
            salesLoaded = true;
            return [];
        });
        return salesLoadPromise;
    }

    function leerSales() {
        if (salesLoaded) return salesCache;
        return loadSalesFromServer();
    }

    function findSaleInCache(ticket) {
        const t = String(ticket || '').trim();
        return (Array.isArray(salesCache) ? salesCache : []).find(s => String(s?.ticket || '').trim() === t) || null;
    }

    function statusBadgeHtml(status, type) {
        const st = String(status || '').trim();
        const tp = String(type || '').trim();
        if (tp === 'Cambio' || st.toLowerCase() === 'cambio') return '<span class="px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 text-[11px]">Cambio</span>';
        if (st.toLowerCase() === 'pendiente') return '<span class="px-2 py-0.5 rounded-full bg-yellow-50 text-yellow-800 text-[11px]">Pendiente</span>';
        return '<span class="px-2 py-0.5 rounded-full bg-green-50 text-green-700 text-[11px]">Completada</span>';
    }

    function renderHistorialFromCache() {
        if (!historial || !historialTbody) return;
        historialTbody.innerHTML = '';
        const list = Array.isArray(salesCache) ? salesCache.slice() : [];
        list.sort((a, b) => (parseInt(b?.created_at || 0, 10) || 0) - (parseInt(a?.created_at || 0, 10) || 0));
        if (!list.length) {
            historialTbody.innerHTML = '<tr><td colspan="8" class="px-4 py-6 text-center text-sm text-gray-500">Todav√≠a no hay movimientos.</td></tr>';
            return;
        }
        list.forEach(s => {
            const tr = document.createElement('tr');
            const ticket = String(s?.ticket || '');
            tr.innerHTML = ''
                + '<td class="px-3 py-2 text-gray-500">' + ticket + '</td>'
                + '<td class="px-3 py-2 text-gray-500">' + String(s?.fecha || '‚Äî') + '</td>'
                + '<td class="px-3 py-2 text-gray-500">' + String(s?.type || 'Venta') + '</td>'
                + '<td class="px-3 py-2 text-gray-500">' + String(s?.customer_name || '‚Äî') + '</td>'
                + '<td class="px-3 py-2 text-right text-gray-500">' + formatearMoneda(parseFloat(s?.total || 0) || 0) + '</td>'
                + '<td class="px-3 py-2 text-center text-gray-500">' + String(s?.payment_method || 'Efectivo') + '</td>'
                + '<td class="px-3 py-2 text-center">' + statusBadgeHtml(s?.status, s?.type) + '</td>'
                + '<td class="px-3 py-2 text-center">'
                +   historialAccionesHtml(ticket)
                + '</td>';
            historialTbody.appendChild(tr);
        });
    }

    function clearCartVenta() {
        if (!tablaCarrito) return;
        const body = tablaCarrito.querySelector('tbody');
        if (!body) return;
        body.innerHTML = '<tr id="carrito-empty-row"><td colspan="6" class="px-2 py-3 text-center text-gray-400 text-[11px]">Aqu√≠ se listar√°n los productos que vayas seleccionando, junto con los descuentos por √≠tem.</td></tr>';
        carritoEmptyRow = document.getElementById('carrito-empty-row');
        if (carritoEmptyRow) carritoEmptyRow.classList.remove('hidden');
    }

    function addCartRowFromItem(item) {
        if (!tablaCarrito) return;
        const tbody = tablaCarrito.querySelector('tbody');
        if (!tbody) return;

        const nombre = String(item?.nombre || 'Producto');
        const precio = parseFloat(item?.precio || 0) || 0;
        const cantidad = parseFloat(item?.cantidad || 0) || 0;
        const descuento = parseFloat(item?.descuento || 0) || 0;
        const subtotal = parseFloat(item?.subtotal || 0) || (precio * cantidad * (1 - (descuento / 100)));
        const productId = String(item?.product_id || '').trim();

        if (carritoEmptyRow) carritoEmptyRow.classList.add('hidden');

        const tr = document.createElement('tr');
        if (productId) tr.setAttribute('data-product-id', productId);
        tr.innerHTML = `
            <td class="px-1 py-1 text-gray-700 truncate">${nombre}</td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" step="0.01" class="input-precio w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${precio.toFixed(2)}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" step="1" class="input-cantidad w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${cantidad}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" max="100" step="0.01" class="input-descuento w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${descuento.toFixed(2)}"></td>
            <td class="px-1 py-1 text-right text-gray-900 font-medium"><input type="number" min="0" step="0.01" class="input-subtotal w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${(isFinite(subtotal) ? subtotal : 0).toFixed(2)}"></td>
            <td class="px-1 py-1 text-center">
                <button type="button" class="btn-eliminar-item inline-flex items-center justify-center h-5 w-5 rounded-full bg-red-50 text-red-500 hover:bg-red-100">
                    <i class="fas fa-times text-[10px]"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);

        const inputPrecio = tr.querySelector('.input-precio');
        const inputCantidad = tr.querySelector('.input-cantidad');
        const inputDescuento = tr.querySelector('.input-descuento');
        const inputSubtotal = tr.querySelector('.input-subtotal');

        [
            { el: inputPrecio, origen: 'precio' },
            { el: inputCantidad, origen: 'cantidad' },
            { el: inputDescuento, origen: 'descuento' },
            { el: inputSubtotal, origen: 'subtotal' },
        ].forEach(({ el, origen }) => {
            if (!el) return;
            el.addEventListener('input', function () {
                recalcularFila(tr, origen === 'subtotal' ? 'subtotal' : 'otros');
            });
        });

        if (inputDescuento) {
            inputDescuento.addEventListener('focus', function() {
                if (inputDescuento.value === '0.00' || inputDescuento.value === '0' || inputDescuento.value === '0.0') {
                    inputDescuento.value = '';
                }
            });
            inputDescuento.addEventListener('blur', function() {
                if (inputDescuento.value.trim() === '') {
                    inputDescuento.value = '0.00';
                    recalcularFila(tr, 'otros');
                }
            });
        }
    }

    function upsertHistorialRowVenta(venta) {
        if (!historial || !historialTbody) return;
        const ticket = String(venta?.ticket || '').trim();
        if (!ticket) return;
        const rows = Array.from(historialTbody.querySelectorAll('tr'));
        const found = rows.find(tr => {
            const td = tr.querySelector('td');
            return td && String(td.textContent || '').trim() === ticket;
        });
        const tr = found || document.createElement('tr');
        tr.innerHTML = ''
            + '<td class="px-3 py-2 text-gray-500">' + ticket + '</td>'
            + '<td class="px-3 py-2 text-gray-500">' + String(venta?.fecha || '‚Äî') + '</td>'
            + '<td class="px-3 py-2 text-gray-500">Venta</td>'
            + '<td class="px-3 py-2 text-gray-500">' + String(venta?.customer_name || '‚Äî') + '</td>'
            + '<td class="px-3 py-2 text-right text-gray-500">' + formatearMoneda(parseFloat(venta?.total || '0') || 0) + '</td>'
            + '<td class="px-3 py-2 text-center text-gray-500">' + String(venta?.payment_method || 'Efectivo') + '</td>'
            + '<td class="px-3 py-2 text-center"><span class="px-2 py-0.5 rounded-full bg-green-50 text-green-700 text-[11px]">Completada</span></td>'
            + '<td class="px-3 py-2 text-center">' + historialAccionesHtml(ticket) + '</td>';
        if (!found) historialTbody.insertBefore(tr, historialTbody.firstChild);
    }

    function showPasoProductos() {
        if (pasoTicket) pasoTicket.classList.add('hidden');
        if (pasoProductos) pasoProductos.classList.remove('hidden');
        if (pillPaso1) {
            pillPaso1.classList.add('bg-indigo-600','text-white');
            pillPaso1.classList.remove('bg-indigo-50','text-indigo-700');
        }
        if (pillPaso2) {
            pillPaso2.classList.add('bg-indigo-50','text-indigo-700');
            pillPaso2.classList.remove('bg-indigo-600','text-white');
        }
        scrollAElemento(pasoProductos || flujo);

        try {
            const search = document.querySelector('#paso-productos input[type="text"][placeholder^="Buscar"]');
            if (search) search.focus();
        } catch (e) {
        }
    }

    function recalcularArqueoAutomatico() {
        if (!montoEfectivoDia) return;
        const efectivo = calcularEfectivoDelDiaDesdeHistorial();
        montoEfectivoDia.value = (isNaN(efectivo) ? 0 : efectivo).toFixed(2);
        validarCierreArqueo();
    }

    function scrollAElemento(el) {
        if (!el) return;
        // Ejecutar despu√©s del repaint para que el display/hidden ya est√© aplicado
        window.requestAnimationFrame(function () {
            el.scrollIntoView({ behavior: 'smooth', block: 'start' });
            // Offset por navbar sticky
            window.setTimeout(function () {
                window.scrollBy({ top: -90, left: 0, behavior: 'smooth' });
            }, 0);
        });
    }

    function formatearMoneda(valor) {
        const numero = isNaN(valor) ? 0 : valor;
        return '$' + numero.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function parseDateToTs(raw) {
        const v = String(raw || '').trim();
        if (!v) return 0;
        if (v.includes('/')) {
            const parts = v.split('/').map(x => parseInt(x, 10));
            if (parts.length >= 3) {
                const d = parts[0];
                const m = parts[1];
                const y = parts[2];
                if (d && m && y) {
                    const dt = new Date(y, m - 1, d);
                    const ts = dt.getTime();
                    return isNaN(ts) ? 0 : ts;
                }
            }
        }
        const t = Date.parse(v);
        return isNaN(t) ? 0 : t;
    }

    function leerEmpleados() {
        try {
            if (window.StorageService && typeof window.StorageService.getEmployees === 'function') {
                return window.StorageService.getEmployees();
            }
        } catch (e) {
        }
        return [];
    }

    function initArqueoEmployees() {
        if (!selectArqueoEmployee) return;
        const res = leerEmpleados();
        const apply = function (arr) {
            const empleados = Array.isArray(arr) ? arr : [];
            const current = String(selectArqueoEmployee.value || '');
            selectArqueoEmployee.innerHTML = '<option value="">‚Äî Seleccionar ‚Äî</option>';
            if (!empleados.length) {
                selectArqueoEmployee.disabled = true;
                if (msgArqueoNoEmployees) msgArqueoNoEmployees.classList.remove('hidden');
                return;
            }
            selectArqueoEmployee.disabled = false;
            if (msgArqueoNoEmployees) msgArqueoNoEmployees.classList.add('hidden');
            empleados
                .slice()
                .sort((a, b) => String(a?.last_name || '').localeCompare(String(b?.last_name || '')))
                .forEach(e => {
                    const id = String(e?.id || '');
                    const name = (String(e?.first_name || '') + ' ' + String(e?.last_name || '')).trim() || 'Empleado';
                    const opt = document.createElement('option');
                    opt.value = id;
                    opt.textContent = name;
                    selectArqueoEmployee.appendChild(opt);
                });
            if (current) selectArqueoEmployee.value = current;
        };
        if (isPromise(res)) return res.then(apply);
        apply(res);
        return null;
    }

    const logoUrl = "{{ url_for('static', filename='images/zentra-consultora-horizontal.png.png') }}";
    const defaultFecha = "{{ now.strftime('%Y-%m-%d') }}";

    function isPromise(x) {
        return !!x && typeof x.then === 'function';
    }

    let arqueoLastSavedAtMs = 0;

    const cashflowChannel = (function () {
        try {
            if (typeof window.BroadcastChannel === 'function') return new window.BroadcastChannel('zentral-cashflow');
        } catch (e) {
        }
        return null;
    })();

    function emitCashflowChanged(evt) {
        const payload = { ...(evt || {}), __ts: Date.now() };
        try {
            if (cashflowChannel) cashflowChannel.postMessage(payload);
        } catch (e) {
        }
        try {
            window.localStorage.setItem('zentral_cashflow_ping', JSON.stringify(payload));
            window.localStorage.removeItem('zentral_cashflow_ping');
        } catch (e) {
        }
    }

    function parseIsoToMs(v) {
        const s = String(v || '').trim();
        if (!s) return 0;
        const t = Date.parse(s);
        return isNaN(t) ? 0 : t;
    }

    function getCashflowEventDate(evt) {
        const d = String(evt?.date || evt?.fecha || '').trim();
        return d;
    }

    function maybeMarkArqueoPending(reason) {
        if (!arqueoLastSavedAtMs) return;
        if (!arqueoStatusBadge) return;
        const current = String(arqueoStatusBadge.textContent || '').trim().toLowerCase();
        if (current !== 'realizado') return;
        setArqueoBadge('pendiente');
    }

    function isCashMethod(method) {
        return String(method || '').trim() === 'Efectivo';
    }

    function computeLastSaleAtMsForDate(dateIso, sales) {
        const list = Array.isArray(sales) ? sales : [];
        let last = 0;
        list.forEach(s => {
            if (String(s?.fecha || '').trim() !== String(dateIso || '').trim()) return;
            const ts = (typeof s?.created_at === 'number') ? s.created_at : (typeof s?.updated_at === 'number' ? s.updated_at : 0);
            if ((ts || 0) > last) last = ts || 0;
        });
        return last;
    }

    function computeLastCashExpenseAtMsForDate(dateIso, expenses) {
        const list = Array.isArray(expenses) ? expenses : [];
        let last = 0;
        list.forEach(e => {
            if (String(e?.fecha || '').trim() !== String(dateIso || '').trim()) return;
            if (!isCashMethod(e?.forma_pago || e?.payment_method)) return;
            const ts = (typeof e?.created_at === 'number') ? e.created_at : 0;
            if ((ts || 0) > last) last = ts || 0;
        });
        return last;
    }

    function checkArqueoStaleForDate(dateIso) {
        if (!arqueoLastSavedAtMs) return;
        const d = String(dateIso || '').trim();
        if (!d) return;

        const salesRes = leerSales();
        const expRes = (function () {
            try {
                if (window.StorageService && typeof window.StorageService.getExpenses === 'function') {
                    return window.StorageService.getExpenses();
                }
            } catch (e) {
            }
            return [];
        })();

        Promise.all([
            Promise.resolve(salesRes).then(x => Array.isArray(x) ? x : []),
            Promise.resolve(expRes).then(x => Array.isArray(x) ? x : [])
        ]).then(function (vals) {
            const sales = vals[0] || [];
            const expenses = vals[1] || [];
            const lastSale = computeLastSaleAtMsForDate(d, sales);
            const lastExp = computeLastCashExpenseAtMsForDate(d, expenses);
            const lastMov = Math.max(lastSale || 0, lastExp || 0);
            if (lastMov && lastMov > (arqueoLastSavedAtMs || 0)) {
                setArqueoBadge('pendiente');
            }
        }).catch(function () {
        });
    }

    function leerCustomers() {
        try {
            if (window.StorageService && typeof window.StorageService.getCustomers === 'function') {
                return window.StorageService.getCustomers();
            }
        } catch (e) {
        }
        return [];
    }

    function hideClienteDd() {
        if (!ddCliente) return;
        ddCliente.classList.add('hidden');
        ddCliente.innerHTML = '';
    }

    function showClienteDd(items) {
        if (!ddCliente) return;
        ddCliente.innerHTML = '';
        (Array.isArray(items) ? items : []).slice(0, 10).forEach(c => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'w-full text-left px-3 py-2 text-sm hover:bg-gray-50';
            const name = String(c?.name || c?.nombre || (String(c?.first_name || '') + ' ' + String(c?.last_name || '')).trim() || 'Cliente');
            btn.textContent = name;
            btn.addEventListener('click', function () {
                selectedCustomer = { id: String(c?.id || ''), name: name };
                if (inputClienteBusqueda) inputClienteBusqueda.value = name;
                hideClienteDd();
            });
            ddCliente.appendChild(btn);
        });
        if (!ddCliente.innerHTML) {
            const empty = document.createElement('div');
            empty.className = 'px-3 py-2 text-xs text-gray-500';
            empty.textContent = 'Sin coincidencias.';
            ddCliente.appendChild(empty);
        }
        ddCliente.classList.remove('hidden');
    }

    function actualizarClienteDd() {
        const q = String(inputClienteBusqueda?.value || '').trim().toLowerCase();
        if (!q) {
            hideClienteDd();
            return;
        }
        const list = Array.isArray(cacheCustomers) ? cacheCustomers : [];
        const items = list.filter(c => {
            const nm = String(c?.name || c?.nombre || (String(c?.first_name || '') + ' ' + String(c?.last_name || '')).trim() || '').toLowerCase();
            return nm.includes(q);
        });
        showClienteDd(items);
    }

    function initCustomers() {
        const res = leerCustomers();
        const apply = function (arr) {
            cacheCustomers = Array.isArray(arr) ? arr : [];
        };
        if (isPromise(res)) return res.then(apply);
        apply(res);
        return null;
    }

    function guardarCustomers(arr) {
        try {
            if (window.StorageService && typeof window.StorageService.saveCustomers === 'function') {
                return window.StorageService.saveCustomers(Array.isArray(arr) ? arr : []);
            }
        } catch (e) {
            // fallback
        }
        try {
            window.localStorage.setItem('customers_dummy', JSON.stringify(Array.isArray(arr) ? arr : []));
        } catch (e) {
            // noop
        }
        return null;
    }

    function openModal(el) {
        if (!el) return;
        el.classList.remove('hidden');
    }

    function closeModal(el) {
        if (!el) return;
        el.classList.add('hidden');
    }

    function setEditState(ticket) {
        editTicketId = ticket ? String(ticket) : null;
        if (ventasFlowTitle) {
            ventasFlowTitle.textContent = editTicketId ? ('Editando Ticket ' + editTicketId) : 'Registrar venta';
        }
        if (ventasEditBadge) {
            ventasEditBadge.classList.toggle('hidden', !editTicketId);
        }
        if (ventasFlowSubtitle) {
            ventasFlowSubtitle.textContent = editTicketId ? 'Us√°s el mismo formulario de venta. Solo est√°s editando el ticket.' : 'Primero eleg√≠ los productos, luego complet√° los datos del ticket.';
        }
    }

    function showPasoTicket() {
        if (pasoProductos) pasoProductos.classList.add('hidden');
        if (pasoTicket) pasoTicket.classList.remove('hidden');
        if (pillPaso1) {
            pillPaso1.classList.remove('bg-indigo-600','text-white');
            pillPaso1.classList.add('bg-indigo-50','text-indigo-700');
        }
        if (pillPaso2) {
            pillPaso2.classList.add('bg-indigo-600','text-white');
            pillPaso2.classList.remove('bg-indigo-50','text-indigo-700');
        }
        scrollAElemento(pasoTicket || flujo);
    }

    function openEditTicket(ticket) {
        if (!home || !flujo) return;
        showFlujo();
        setEditState(ticket || '');
        // Precargar datos del ticket en el flujo (sin crear una vista nueva)
        try {
            const res = leerSales();
            const apply = function (arr) {
                const sales = Array.isArray(arr) ? arr : [];
                const t = String(ticket || '').trim();
                const sale = sales.find(s => String(s?.ticket || '').trim() === t) || null;
                if (!sale) return;

                clearCartVenta();
                const items = Array.isArray(sale?.items) ? sale.items : [];
                items.forEach(it => {
                    addCartRowFromItem(it);
                });

                if (inputDescuentoGeneral) {
                    const pct = parseFloat(sale?.discount_general_pct || 0) || 0;
                    inputDescuentoGeneral.value = String(pct);
                }

                if (ticketFecha) ticketFecha.value = String(sale?.fecha || '').trim() || defaultFecha;
                if (ticketNotas) ticketNotas.value = String(sale?.notes || '').trim();

                const cid = String(sale?.customer_id || '').trim();
                const cname = String(sale?.customer_name || '').trim();
                selectedCustomer = (cid || cname) ? { id: cid, name: cname } : null;
                if (inputClienteBusqueda) inputClienteBusqueda.value = cname;

                setPaymentMethod(String(sale?.payment_method || 'Efectivo'));
                ventaPaidAmount = parseFloat(sale?.paid_amount || 0) || 0;
                ventaOnAccount = (parseFloat(sale?.due_amount || 0) || 0) > 0;
                computeTicketTotals();
            };
            if (isPromise(res)) res.then(apply);
            else apply(res);
        } catch (e) {
        }
        showPasoProductos();
    }

    function currentCustomerNameFromInput() {
        return String(inputClienteBusqueda?.value || '').trim();
    }

    function setCustomerForContext(customer) {
        const c = customer && typeof customer === 'object' ? customer : null;
        const name = c ? String(c.name || c.nombre || '').trim() : '';
        const id = c ? String(c.id || '').trim() : '';
        selectedCustomer = c ? { id, name } : null;
        if (currentCustomerContext === 'sale') {
            if (inputClienteBusqueda) inputClienteBusqueda.value = name;
            hideClienteDd();
            setPagoCompleto();
        }
        if (currentCustomerContext === 'cambio') {
            const input = document.getElementById('cambio-cliente');
            if (input) input.value = name;
        }
    }

    function renderSelectCustomerList() {
        if (!listSelectCustomer) return;
        const q = String(inputSelectCustomerQ?.value || '').trim().toLowerCase();
        const list = Array.isArray(cacheCustomers) ? cacheCustomers : [];
        const filtered = q ? list.filter(c => {
            const nm = String(c?.name || c?.nombre || (String(c?.first_name || '') + ' ' + String(c?.last_name || '')).trim() || '').toLowerCase();
            return nm.includes(q);
        }) : list;

        listSelectCustomer.innerHTML = '';
        if (!filtered.length) {
            const empty = document.createElement('div');
            empty.className = 'px-3 py-4 text-sm text-gray-500';
            empty.textContent = 'Sin resultados.';
            listSelectCustomer.appendChild(empty);
            return;
        }

        filtered.slice(0, 200).forEach(c => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'w-full text-left px-3 py-3 text-sm hover:bg-gray-50 border-b border-gray-100';
            const name = String(c?.name || c?.nombre || (String(c?.first_name || '') + ' ' + String(c?.last_name || '')).trim() || 'Cliente');
            btn.textContent = name;
            btn.addEventListener('click', function () {
                setCustomerForContext({ id: String(c?.id || ''), name: name });
                closeModal(modalSelectCustomer);
            });
            listSelectCustomer.appendChild(btn);
        });
        return;
    }

    function openSelectCustomer(context) {
        currentCustomerContext = context || 'sale';
        initCustomers();
        if (inputSelectCustomerQ) inputSelectCustomerQ.value = '';
        renderSelectCustomerList();
        openModal(modalSelectCustomer);
        if (inputSelectCustomerQ) inputSelectCustomerQ.focus();
    }

    function openCreateCustomer(prefillName) {
        if (msgCreateCustomerError) msgCreateCustomerError.classList.add('hidden');
        const raw = String(prefillName || '').trim();
        const parts = raw.split(' ').filter(Boolean);
        const first = parts.length ? parts[0] : '';
        const last = parts.length > 1 ? parts.slice(1).join(' ') : '';
        if (inputNewCustomerFirst) inputNewCustomerFirst.value = first;
        if (inputNewCustomerLast) inputNewCustomerLast.value = last;
        if (inputNewCustomerEmail) inputNewCustomerEmail.value = '';
        if (inputNewCustomerPhone) inputNewCustomerPhone.value = '';
        openModal(modalCreateCustomer);
        if (inputNewCustomerFirst) inputNewCustomerFirst.focus();
    }

    function saveNewCustomer() {
        const first = String(inputNewCustomerFirst?.value || '').trim();
        const last = String(inputNewCustomerLast?.value || '').trim();
        const email = String(inputNewCustomerEmail?.value || '').trim();
        const phone = String(inputNewCustomerPhone?.value || '').trim();
        if (!first || !last || !phone) {
            if (msgCreateCustomerError) msgCreateCustomerError.classList.remove('hidden');
            if (inputNewCustomerFirst && !first) inputNewCustomerFirst.focus();
            else if (inputNewCustomerLast && !last) inputNewCustomerLast.focus();
            else if (inputNewCustomerPhone && !phone) inputNewCustomerPhone.focus();
            return;
        }

        const next = Array.isArray(cacheCustomers) ? cacheCustomers.slice() : [];
        const normKey = (String(first).toLowerCase() + '|' + String(last).toLowerCase() + '|' + String(phone).toLowerCase()).trim();
        const existing = next.find(c => {
            const f = String(c?.first_name || '').trim().toLowerCase();
            const l = String(c?.last_name || '').trim().toLowerCase();
            const p = String(c?.phone || '').trim().toLowerCase();
            return (f + '|' + l + '|' + p) === normKey;
        });

        if (existing) {
            const nm = (String(existing?.first_name || '') + ' ' + String(existing?.last_name || '')).trim();
            setCustomerForContext({ id: String(existing?.id || ''), name: nm });
            closeModal(modalCreateCustomer);
            closeModal(modalSelectCustomer);
            return;
        }

        const id = String(Date.now());
        const payload = { id, first_name: first, last_name: last, phone: phone, email: email, status: 'activo', created_at: Date.now() };
        next.push(payload);
        cacheCustomers = next;
        guardarCustomers(next);

        setCustomerForContext({ id: id, name: (first + ' ' + last).trim() });
        closeModal(modalCreateCustomer);
        closeModal(modalSelectCustomer);
    }

    function setPaymentMethod(v) {
        const value = String(v || '').trim();
        const target = document.querySelector('input[name="forma_pago"][value="' + value.replace(/"/g, '') + '"]');
        if (target) {
            target.checked = true;
        }
    }

    function computeTicketTotals() {
        const items = getCartItems();
        let subtotalBruto = 0;
        let subtotalConDescItem = 0;
        items.forEach(it => {
            const precio = parseFloat(it.precio || '0') || 0;
            const cantidad = parseFloat(it.cantidad || '0') || 0;
            const sub = parseFloat(it.subtotal || '0') || 0;
            subtotalBruto += precio * cantidad;
            subtotalConDescItem += sub;
        });

        let pct = parseFloat(String(inputDescuentoGeneral?.value || '0').replace(',', '.')) || 0;
        if (pct < 0) pct = 0;
        if (pct > 100) pct = 100;
        if (inputDescuentoGeneral) inputDescuentoGeneral.value = String(pct);

        const descItems = subtotalBruto - subtotalConDescItem;
        const descGeneral = subtotalConDescItem * (pct / 100);
        const total = Math.max(0, subtotalConDescItem - descGeneral);
        const descuentos = Math.max(0, descItems + descGeneral);

        if (ticketTotalSidebar) ticketTotalSidebar.textContent = formatearMoneda(total);
        if (ticketDescuentosSidebar) ticketDescuentosSidebar.textContent = formatearMoneda(descuentos);
        if (ticketDescuentoGeneralView) ticketDescuentoGeneralView.textContent = String(pct.toFixed(0)) + '%';
        return { subtotalBruto, subtotalConDescItem, descItems, pct, descGeneral, total };
    }

    function readCustomersAlertsConfig() {
        try {
            const raw = window.localStorage.getItem('clientes_alertas_config');
            const parsed = raw ? JSON.parse(raw) : null;
            if (parsed && typeof parsed === 'object') {
                return {
                    warn10: Math.max(1, parseInt(parsed.warn10 || 10, 10) || 10),
                    warn15: Math.max(1, parseInt(parsed.warn15 || 15, 10) || 15),
                    crit30: Math.max(1, parseInt(parsed.crit30 || 30, 10) || 30)
                };
            }
        } catch (e) {
        }
        return { warn10: 10, warn15: 15, crit30: 30 };
    }

    function getCustomerDebtSummary(customer) {
        const c = customer && typeof customer === 'object' ? customer : null;
        if (!c) return { saldo: 0, dias: 0, alert: '' };

        const sales = Array.isArray(leerSales()) ? leerSales() : [];
        const cid = String(c.id || '').trim();
        const cname = String(c.name || '').trim();

        let saldo = 0;
        let lastImpagoTs = 0;
        sales.forEach(s => {
            const sid = String(s?.customer_id || '').trim();
            const sn = String(s?.customer_name || '').trim();
            const isSame = (cid && sid === cid) || (!sid && cname && sn && sn.toLowerCase() === cname.toLowerCase());
            if (!isSame) return;
            const due = parseFloat(s?.due_amount || 0) || 0;
            if (due > 0) {
                saldo += due;
                const ts = (parseDateToTs(s?.fecha) || (parseInt(s?.created_at || 0, 10) || 0));
                if (ts > lastImpagoTs) lastImpagoTs = ts;
            }
        });
        const dias = (saldo > 0 && lastImpagoTs) ? Math.max(0, Math.floor((Date.now() - lastImpagoTs) / (1000 * 60 * 60 * 24))) : 0;

        const cfg = readCustomersAlertsConfig();
        let alert = '';
        if (saldo > 0) {
            if (dias >= cfg.crit30) alert = 'critica';
            else if (dias >= cfg.warn15) alert = 'warn15';
            else if (dias >= cfg.warn10) alert = 'warn10';
        }
        return { saldo, dias, alert };
    }

    function openCuentaCorrienteModal() {
        if (!modalCuentaCorriente) return;
        if (!selectedCustomer || !selectedCustomer.name) {
            alert('Para usar cuenta corriente ten√©s que asociar un cliente.');
            return;
        }
        const totals = computeTicketTotals();
        const total = totals.total;

        const debt = getCustomerDebtSummary(selectedCustomer);
        if (ccCliente) ccCliente.textContent = selectedCustomer.name || '‚Äî';
        if (ccTotal) ccTotal.textContent = formatearMoneda(total);
        if (ccPaid) ccPaid.value = String(Math.max(0, Math.min(total, ventaPaidAmount || 0)));
        if (ccDue) ccDue.textContent = formatearMoneda(Math.max(0, total - (parseFloat(ccPaid?.value || '0') || 0)));
        if (ccError) ccError.classList.add('hidden');

        let alertTxt = '';
        if ((debt.saldo || 0) > 0) {
            alertTxt = 'Deuda actual: ' + formatearMoneda(debt.saldo) + ' ¬∑ ' + String(debt.dias || 0) + ' d√≠as';
            if (debt.alert === 'critica') alertTxt += ' ¬∑ Cr√≠tica';
            else if (debt.alert === 'warn15') alertTxt += ' ¬∑ Aviso';
            else if (debt.alert === 'warn10') alertTxt += ' ¬∑ Aviso';
        } else {
            alertTxt = 'Sin deudas registradas.';
        }
        if (ccClienteAlertas) ccClienteAlertas.textContent = alertTxt;

        openModal(modalCuentaCorriente);
        if (ccPaid) ccPaid.focus();
    }

    function closeCuentaCorrienteModal() {
        closeModal(modalCuentaCorriente);
    }

    function syncCcDuePreview() {
        const totals = computeTicketTotals();
        const total = totals.total;
        const paid = parseFloat(String(ccPaid?.value || '0').replace(',', '.')) || 0;
        const due = Math.max(0, total - Math.max(0, paid));
        if (ccDue) ccDue.textContent = formatearMoneda(due);
    }

    function acceptCuentaCorriente() {
        const totals = computeTicketTotals();
        const total = totals.total;
        let paid = parseFloat(String(ccPaid?.value || '0').replace(',', '.')) || 0;
        if (paid < 0) paid = 0;
        if (paid > total) paid = total;
        const due = Math.max(0, total - paid);

        if (ccPaid) ccPaid.value = String(paid.toFixed(2));
        if (ccDue) ccDue.textContent = formatearMoneda(due);

        ventaOnAccount = due > 0;
        ventaPaidAmount = paid;

        closeCuentaCorrienteModal();
    }

    function setPagoCompleto() {
        ventaOnAccount = false;
        ventaPaidAmount = 0;
        const totals = computeTicketTotals();
        const total = totals.total;
        ventaPaidAmount = total;
    }

    function applyVentasFilters() {
        if (!historial) return;
        const body = historial.querySelector('tbody');
        if (!body) return;
        const rows = Array.from(body.querySelectorAll('tr'));
        const qCli = String(inputSearchVentasCliente?.value || '').trim().toLowerCase();
        const qTic = String(inputSearchVentasTicket?.value || '').trim().toLowerCase();
        const tipo = String(selectVentasTipo?.value || '').trim();
        const pago = String(selectVentasPago?.value || '').trim();
        const estado = String(selectVentasEstado?.value || '').trim();

        let fromTs = 0;
        let toTs = 0;
        const r = String(inputFechaRango?.value || '').trim();
        if (r && r.includes('-')) {
            const parts = r.split('-').map(x => x.trim());
            if (parts.length >= 2) {
                const a = parseDateToTs(parts[0]);
                const b = parseDateToTs(parts[1]);
                if (a && b) {
                    fromTs = Math.min(a, b);
                    toTs = Math.max(a, b) + (24 * 60 * 60 * 1000 - 1);
                }
            }
        }

        rows.forEach(tr => {
            const tds = tr.querySelectorAll('td');
            if (!tds || tds.length < 7) return;
            const vTicket = String(tds[0]?.textContent || '').trim();
            const vFecha = String(tds[1]?.textContent || '').trim();
            const vTipo = String(tds[2]?.textContent || '').trim();
            const vCliente = String(tds[3]?.textContent || '').trim();
            const vPago = String(tds[5]?.textContent || '').trim();
            const vEstado = String(tds[6]?.textContent || '').trim();

            let ok = true;
            if (qTic && !vTicket.toLowerCase().includes(qTic)) ok = false;
            if (qCli && !vCliente.toLowerCase().includes(qCli)) ok = false;
            if (tipo && vTipo !== tipo) ok = false;
            if (pago && vPago !== pago) ok = false;
            if (estado && !vEstado.toLowerCase().includes(estado.toLowerCase())) ok = false;

            if (ok && fromTs && toTs) {
                const ts = parseDateToTs(vFecha);
                if (!ts || ts < fromTs || ts > toTs) ok = false;
            }

            tr.classList.toggle('hidden', !ok);
        });
    }

    function initKpisFromSales() {
        const res = leerSales();
        const apply = function (arr) {
            const sales = Array.isArray(arr) ? arr : [];
            const today = new Date();
            const y = today.getFullYear();
            const m = today.getMonth();
            const d = today.getDate();
            const start = new Date(y, m, d, 0, 0, 0, 0).getTime();
            const end = new Date(y, m, d, 23, 59, 59, 999).getTime();

            let totalDia = 0;
            let itemsDia = 0;
            let ticketsDia = 0;
            sales.forEach(s => {
                const ts = (typeof s?.created_at === 'number') ? s.created_at : 0;
                if (!ts || ts < start || ts > end) return;
                totalDia += parseFloat(s?.total || '0') || 0;
                ticketsDia += 1;
                const its = Array.isArray(s?.items) ? s.items : [];
                its.forEach(it => {
                    itemsDia += parseFloat(it?.cantidad || '0') || 0;
                });
            });

            const ticketProm = ticketsDia > 0 ? (totalDia / ticketsDia) : 0;

            if (kpiVentasDiaEl) kpiVentasDiaEl.textContent = formatearMoneda(totalDia);
            if (kpiTicketsDiaEl) kpiTicketsDiaEl.textContent = String(ticketsDia);
            if (kpiItemsDiaEl) kpiItemsDiaEl.textContent = String(itemsDia);
            if (kpiTicketPromedioEl) kpiTicketPromedioEl.textContent = formatearMoneda(ticketProm);
        };
        if (isPromise(res)) return res.then(apply);
        apply(res);
        return null;
    }

    let invCache = { products: [], lots: [] };
    let invLoaded = false;
    let invLoadPromise = null;

    let selectedCategoriaVenta = 'Todos';
    let selectedCategoriaCambio = 'Todos';
    let selectedCategoriaCambioVenta = 'Todos';

    function uniqueCategoriesFromProducts(products) {
        const out = [];
        const seen = new Set();
        (Array.isArray(products) ? products : []).forEach(p => {
            const c = String(p?.category?.name || p?.category_name || '').trim();
            if (!c) return;
            if (seen.has(c)) return;
            seen.add(c);
            out.push(c);
        });
        out.sort((a, b) => a.localeCompare(b, 'es'));
        return out;
    }

    function applyCategoryFilter(buttons, categoria) {
        const list = Array.isArray(buttons) ? buttons : [];
        list.forEach(btn => {
            const cat = String(btn?.getAttribute('data-categoria') || '').trim();
            if (!categoria || categoria === 'Todos' || cat === categoria) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        });
    }

    function renderCategoryPills(container, categories, active, onSelect) {
        if (!container) return;
        const cats = Array.isArray(categories) ? categories : [];
        container.innerHTML = '';

        const mk = function (label) {
            const b = document.createElement('button');
            b.type = 'button';
            b.textContent = label;
            b.className = 'px-3 py-1 rounded-full bg-indigo-50 text-indigo-700 border border-indigo-100';
            if (label === active) {
                b.classList.add('bg-indigo-600','text-white','shadow-sm');
                b.classList.remove('bg-indigo-50','text-indigo-700','border','border-indigo-100');
            }
            b.addEventListener('click', function () {
                const val = String(label || '').trim() || 'Todos';
                try {
                    const btns = Array.from(container.querySelectorAll('button'));
                    btns.forEach(x => {
                        x.classList.remove('bg-indigo-600','text-white','shadow-sm');
                        x.classList.add('bg-indigo-50','text-indigo-700','border','border-indigo-100');
                    });
                    b.classList.add('bg-indigo-600','text-white','shadow-sm');
                    b.classList.remove('bg-indigo-50','text-indigo-700','border','border-indigo-100');
                } catch (e) {
                }
                if (typeof onSelect === 'function') onSelect(val);
            });
            return b;
        };

        container.appendChild(mk('Todos'));
        cats.forEach(c => container.appendChild(mk(c)));
    }

    function apiListInventoryProducts() {
        return fetch('/sales/api/products?limit=5000', { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => (data && data.ok && Array.isArray(data.items)) ? data.items : []);
    }

    function apiListInventoryLots() {
        return fetch('/sales/api/lots?limit=10000', { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => (data && data.ok && Array.isArray(data.items)) ? data.items : []);
    }

    function loadInventoryFromServer() {
        if (invLoaded) return invCache;
        if (invLoadPromise) return invLoadPromise;
        invLoadPromise = Promise.all([apiListInventoryProducts(), apiListInventoryLots()]).then(function (vals) {
            invCache = { products: Array.isArray(vals[0]) ? vals[0] : [], lots: Array.isArray(vals[1]) ? vals[1] : [] };
            invLoaded = true;
            return invCache;
        }).catch(function () {
            invCache = { products: [], lots: [] };
            invLoaded = true;
            return invCache;
        });
        return invLoadPromise;
    }

    function leerInventario() {
        if (invLoaded) return invCache;
        return loadInventoryFromServer();
    }

    function stockDisponiblePorProducto(lots, productId) {
        return (Array.isArray(lots) ? lots : [])
            .filter(l => String(l?.product_id) === String(productId))
            .reduce((acc, l) => acc + (parseFloat(l?.qty_available || '0') || 0), 0);
    }

    function renderProductosDesdeInventario() {
        if (!gridProductos) return;
        const res = leerInventario();

        const apply = function (data) {
            const products = Array.isArray(data?.products) ? data.products : [];
            const lots = Array.isArray(data?.lots) ? data.lots : [];
            if (!products.length) return;

            gridProductos.innerHTML = '';
            products.slice(0, 200).forEach(p => {
                const stock = stockDisponiblePorProducto(lots, p?.id);
                const rel = (Array.isArray(lots) ? lots : []).filter(l => String(l?.product_id) === String(p?.id) && (parseFloat(l?.qty_available || '0') || 0) > 0);
                const stockQty = rel.reduce((acc, l) => acc + (parseFloat(l?.qty_available || '0') || 0), 0);
                const costSum = rel.reduce((acc, l) => acc + ((parseFloat(l?.qty_available || '0') || 0) * (parseFloat(l?.unit_cost || '0') || 0)), 0);
                const avgCost = stockQty > 0 ? (costSum / stockQty) : 0;
                const price = parseFloat(p?.sale_price || p?.price || 0) || 0;
                const displayPrice = price > 0 ? price : 0;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn-producto flex flex-col items-start p-3 bg-gray-50 rounded-lg border border-gray-100 hover:border-indigo-200 hover:bg-indigo-50 text-left text-xs';
                btn.setAttribute('data-product-id', String(p?.id || ''));
                btn.setAttribute('data-nombre', String(p?.name || 'Producto'));
                btn.setAttribute('data-precio', String(displayPrice.toFixed(2)));
                btn.setAttribute('data-categoria', String(p?.category?.name || p?.category_name || ''));
                btn.innerHTML = ''
                    + '<div class="w-full mb-2 flex items-center justify-center">'
                    + '  <div class="h-16 w-16 rounded-md bg-white border border-gray-200 flex items-center justify-center overflow-hidden">'
                    + '    <img src="' + logoUrl + '" alt="" class="h-10">'
                    + '  </div>'
                    + '</div>'
                    + '<div class="font-medium text-gray-800 truncate w-full">' + String(p?.name || 'Producto') + '</div>'
                    + '<div class="text-[11px] text-gray-500">' + String(p?.category?.name || p?.category_name || '') + '</div>'
                    + '<div class="mt-1 font-semibold text-sm text-gray-900">' + formatearMoneda(displayPrice) + '</div>'
                    + '<div class="mt-1 text-[11px] text-gray-500">Stock: ' + String((isNaN(stock) ? 0 : stock).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + ' ¬∑ Costo prom: ' + formatearMoneda(avgCost) + '</div>';
                gridProductos.appendChild(btn);
            });

            bindProductButtons();

            try {
                const botones = Array.from(gridProductos.querySelectorAll('.btn-producto'));
                if (pillsCategoriasVentaWrap) {
                    const cats = uniqueCategoriesFromProducts(products);
                    if (selectedCategoriaVenta !== 'Todos' && cats.indexOf(selectedCategoriaVenta) < 0) selectedCategoriaVenta = 'Todos';
                    renderCategoryPills(pillsCategoriasVentaWrap, cats, selectedCategoriaVenta, function (cat) {
                        selectedCategoriaVenta = cat;
                        applyCategoryFilter(botones, selectedCategoriaVenta);
                    });
                }
                applyCategoryFilter(botones, selectedCategoriaVenta);
            } catch (e) {
            }
        };

        if (isPromise(res)) res.then(apply);
        else apply(res);
    }

    function renderProductosCambioDesdeInventario() {
        if (!gridProductosCambio) return;
        const res = leerInventario();

        const apply = function (data) {
            const products = Array.isArray(data?.products) ? data.products : [];
            const lots = Array.isArray(data?.lots) ? data.lots : [];
            gridProductosCambio.innerHTML = '';
            if (!products.length) {
                gridProductosCambio.innerHTML = '<div class="col-span-full px-3 py-4 text-sm text-gray-500">No hay productos en inventario.</div>';
                botonesProductoCambio = [];
                return;
            }

            products.slice(0, 200).forEach(p => {
                const stock = stockDisponiblePorProducto(lots, p?.id);
                const price = parseFloat(p?.sale_price || p?.price || 0) || 0;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn-producto-cambio flex flex-col items-start p-3 bg-gray-50 rounded-lg border border-gray-100 hover:border-indigo-200 hover:bg-indigo-50 text-left text-xs';
                btn.setAttribute('data-product-id', String(p?.id || ''));
                btn.setAttribute('data-nombre', String(p?.name || 'Producto'));
                btn.setAttribute('data-precio', String(price.toFixed(2)));
                btn.setAttribute('data-categoria', String(p?.category?.name || p?.category_name || ''));
                btn.innerHTML = ''
                    + '<div class="w-full mb-2 flex items-center justify-center">'
                    + '  <div class="h-16 w-16 rounded-md bg-white border border-gray-200 flex items-center justify-center overflow-hidden">'
                    + '    <img src="' + logoUrl + '" alt="" class="h-10">'
                    + '  </div>'
                    + '</div>'
                    + '<div class="font-medium text-gray-800 truncate w-full">' + String(p?.name || 'Producto') + '</div>'
                    + '<div class="text-[11px] text-gray-500">' + String(p?.category?.name || p?.category_name || '') + '</div>'
                    + '<div class="mt-1 font-semibold text-sm text-gray-900">' + formatearMoneda(price) + '</div>'
                    + '<div class="mt-1 text-[11px] text-gray-500">Stock: ' + String((isNaN(stock) ? 0 : stock).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</div>';
                btn.addEventListener('click', function () {
                    const nombre = btn.getAttribute('data-nombre') || 'Producto';
                    const precio = btn.getAttribute('data-precio') || '0';
                    agregarProductoAlCarritoCambio(nombre, precio, { productId: btn.getAttribute('data-product-id') || '' });
                });
                gridProductosCambio.appendChild(btn);
            });
            botonesProductoCambio = Array.from(gridProductosCambio.querySelectorAll('.btn-producto-cambio'));

            try {
                if (pillsCategoriasCambioWrap) {
                    const cats = uniqueCategoriesFromProducts(products);
                    if (selectedCategoriaCambio !== 'Todos' && cats.indexOf(selectedCategoriaCambio) < 0) selectedCategoriaCambio = 'Todos';
                    renderCategoryPills(pillsCategoriasCambioWrap, cats, selectedCategoriaCambio, function (cat) {
                        selectedCategoriaCambio = cat;
                        applyCategoryFilter(botonesProductoCambio, selectedCategoriaCambio);
                    });
                }
                applyCategoryFilter(botonesProductoCambio, selectedCategoriaCambio);
            } catch (e) {
            }
        };

        if (isPromise(res)) res.then(apply);
        else apply(res);
    }

    function renderProductosCambioVentaDesdeInventario() {
        if (!gridProductosCambioVenta) return;
        const res = leerInventario();

        const apply = function (data) {
            const products = Array.isArray(data?.products) ? data.products : [];
            const lots = Array.isArray(data?.lots) ? data.lots : [];
            gridProductosCambioVenta.innerHTML = '';
            if (!products.length) {
                gridProductosCambioVenta.innerHTML = '<div class="col-span-full px-3 py-4 text-sm text-gray-500">No hay productos en inventario.</div>';
                botonesProductoCambioVenta = [];
                return;
            }

            products.slice(0, 200).forEach(p => {
                const stock = stockDisponiblePorProducto(lots, p?.id);
                const price = parseFloat(p?.sale_price || p?.price || 0) || 0;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn-producto-cambio-venta flex flex-col items-start p-3 bg-gray-50 rounded-lg border border-gray-100 hover:border-indigo-200 hover:bg-indigo-50 text-left text-xs';
                btn.setAttribute('data-product-id', String(p?.id || ''));
                btn.setAttribute('data-nombre', String(p?.name || 'Producto'));
                btn.setAttribute('data-precio', String(price.toFixed(2)));
                btn.setAttribute('data-categoria', String(p?.category?.name || p?.category_name || ''));
                btn.innerHTML = ''
                    + '<div class="w-full mb-2 flex items-center justify-center">'
                    + '  <div class="h-16 w-16 rounded-md bg-white border border-gray-200 flex items-center justify-center overflow-hidden">'
                    + '    <img src="' + logoUrl + '" alt="" class="h-10">'
                    + '  </div>'
                    + '</div>'
                    + '<div class="font-medium text-gray-800 truncate w-full">' + String(p?.name || 'Producto') + '</div>'
                    + '<div class="text-[11px] text-gray-500">' + String(p?.category?.name || p?.category_name || '') + '</div>'
                    + '<div class="mt-1 font-semibold text-sm text-gray-900">' + formatearMoneda(price) + '</div>'
                    + '<div class="mt-1 text-[11px] text-gray-500">Stock: ' + String((isNaN(stock) ? 0 : stock).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</div>';
                btn.addEventListener('click', function () {
                    const nombre = btn.getAttribute('data-nombre') || 'Producto';
                    const precio = btn.getAttribute('data-precio') || '0';
                    agregarProductoAlCarritoCambioVenta(nombre, precio, { productId: btn.getAttribute('data-product-id') || '' });
                });
                gridProductosCambioVenta.appendChild(btn);
            });
            botonesProductoCambioVenta = Array.from(gridProductosCambioVenta.querySelectorAll('.btn-producto-cambio-venta'));

            try {
                if (pillsCategoriasCambioVentaWrap) {
                    const cats = uniqueCategoriesFromProducts(products);
                    if (selectedCategoriaCambioVenta !== 'Todos' && cats.indexOf(selectedCategoriaCambioVenta) < 0) selectedCategoriaCambioVenta = 'Todos';
                    renderCategoryPills(pillsCategoriasCambioVentaWrap, cats, selectedCategoriaCambioVenta, function (cat) {
                        selectedCategoriaCambioVenta = cat;
                        applyCategoryFilter(botonesProductoCambioVenta, selectedCategoriaCambioVenta);
                    });
                }
                applyCategoryFilter(botonesProductoCambioVenta, selectedCategoriaCambioVenta);
            } catch (e) {
            }
        };

        if (isPromise(res)) res.then(apply);
        else apply(res);
    }

    function bindProductButtons() {
        botonesProducto = gridProductos ? gridProductos.querySelectorAll('.btn-producto') : document.querySelectorAll('.btn-producto');
        botonesProducto.forEach(btn => {
            btn.addEventListener('click', function () {
                const nombre = this.getAttribute('data-nombre') || 'Producto';
                const precio = this.getAttribute('data-precio') || '0';
                const productId = this.getAttribute('data-product-id') || '';
                agregarProductoAlCarrito(nombre, precio, { productId: productId });
            });
        });
    }

    function parseMoneda(texto) {
        if (texto === null || texto === undefined) return 0;
        const limpio = String(texto)
            .replace(/\s/g, '')
            .replace(/\$/g, '')
            .replace(/\./g, '')
            .replace(',', '.');
        const n = parseFloat(limpio);
        return isNaN(n) ? 0 : n;
    }

    function mostrarMensajesArqueo({ ok, detalle }) {
        if (msgArqueoOk) msgArqueoOk.classList.toggle('hidden', !ok);
        if (msgArqueoError) msgArqueoError.classList.toggle('hidden', ok);
        if (msgArqueoDetalle) {
            msgArqueoDetalle.textContent = detalle || '';
            msgArqueoDetalle.classList.toggle('hidden', !(detalle && detalle.trim().length));
        }
    }

    function calcularEfectivoDelDiaDesdeHistorial() {
        let total = 0;

        // 1) Ventas en efectivo desde historial visible
        if (historial) {
            const tbody = historial.querySelector('tbody');
            if (tbody) {
                const filas = tbody.querySelectorAll('tr');
                filas.forEach(tr => {
                    const celdas = tr.querySelectorAll('td');
                    if (!celdas || celdas.length < 6) return;
                    const tipo = (celdas[2]?.textContent || '').trim();
                    const pago = (celdas[5]?.textContent || '').trim();
                    const totalTexto = (celdas[4]?.textContent || '').trim();
                    if (pago === 'Efectivo' && (tipo === 'Venta' || tipo === 'Pago' || tipo === 'Devolucion' || tipo === 'Devoluci√≥n')) {
                        total += parseMoneda(totalTexto);
                    }
                });
            }
        }

        // 2) Egresos en efectivo del d√≠a (resta) desde StorageService/getExpenses
        const fecha = String(document.getElementById('fecha-arqueo')?.value || '').trim();
        const day = fecha ? new Date(fecha + 'T00:00:00') : new Date();
        const y = day.getFullYear();
        const m = day.getMonth();
        const d = day.getDate();
        const start = new Date(y, m, d, 0, 0, 0, 0).getTime();
        const end = new Date(y, m, d, 23, 59, 59, 999).getTime();

        const parseExpenseTs = function (e) {
            const raw = e?.fecha || e?.date || e?.created_at || '';
            if (typeof raw === 'number' && isFinite(raw)) return raw;
            const v = String(raw || '').trim();
            if (!v) return 0;
            if (/^\d{4}-\d{2}-\d{2}$/.test(v)) {
                const parts = v.split('-').map(x => parseInt(x, 10));
                const dt = new Date(parts[0], (parts[1] || 1) - 1, parts[2] || 1);
                const ts = dt.getTime();
                return isNaN(ts) ? 0 : ts;
            }
            if (v.includes('/')) return parseDateToTs(v);
            const ts = Date.parse(v);
            return isNaN(ts) ? 0 : ts;
        };

        const getExpenses = function () {
            try {
                if (window.StorageService && typeof window.StorageService.getExpenses === 'function') {
                    return window.StorageService.getExpenses();
                }
            } catch (e) {
            }
            try {
                const raw = window.localStorage.getItem('egresos_dummy');
                const parsed = raw ? JSON.parse(raw) : [];
                return Array.isArray(parsed) ? parsed : [];
            } catch (e) {
                return [];
            }
        };

        const res = getExpenses();
        const apply = function (arr) {
            const list = Array.isArray(arr) ? arr : [];
            list.forEach(e => {
                const ts = parseExpenseTs(e);
                if (!ts || ts < start || ts > end) return;
                const metodo = String(e?.forma_pago || e?.payment_method || 'Efectivo').trim();
                if (metodo !== 'Efectivo') return;
                const val = parseFloat(e?.valor || e?.amount || 0) || 0;
                total -= val;
            });
        };
        if (isPromise(res)) res.then(apply);
        else apply(res);

        return total;
    }

    function setArqueoBadge(state) {
        if (!arqueoStatusBadge) return;
        const s = String(state || '').toLowerCase();
        const set = function (txt, styles) {
            arqueoStatusBadge.textContent = txt;
            arqueoStatusBadge.className = 'text-[11px] px-2 py-0.5 rounded-full border font-medium';
            const st = styles && typeof styles === 'object' ? styles : {};
            arqueoStatusBadge.style.backgroundColor = String(st.bg || '#f9fafb');
            arqueoStatusBadge.style.color = String(st.color || '#374151');
            arqueoStatusBadge.style.borderColor = String(st.border || '#e5e7eb');
        };
        if (s === 'realizado') {
            set('Realizado', { bg: '#d1fae5', color: '#065f46', border: '#10b981' });
            return;
        }
        if (s === 'pendiente') {
            set('Pendiente', { bg: '#fef3c7', color: '#92400e', border: '#f59e0b' });
            return;
        }
        set('‚Äî', { bg: '#f9fafb', color: '#374151', border: '#e5e7eb' });
    }

    function openArqueoModal() {
        if (!modalArqueo) return;
        modalArqueo.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }

    function closeArqueoModal() {
        if (!modalArqueo) return;
        modalArqueo.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    function loadArqueoFromServer() {
        const fecha = String(document.getElementById('fecha-arqueo')?.value || '').trim();
        if (!fecha) return;
        fetch('/sales/api/cash-count?date=' + encodeURIComponent(fecha), { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => {
                const item = data && data.item ? data.item : null;
                if (!item) {
                    setArqueoBadge('pendiente');
                    arqueoLastSavedAtMs = 0;
                    if (montoApertura) montoApertura.value = '';
                    if (montoCierre) montoCierre.value = '';
                    if (selectArqueoEmployee) selectArqueoEmployee.value = '';
                    recalcularArqueoAutomatico();
                    return;
                }

                if (montoApertura) montoApertura.value = String(item.opening_amount ?? '');
                if (montoCierre) montoCierre.value = String(item.closing_amount ?? '');
                if (montoEfectivoDia) montoEfectivoDia.value = String(item.cash_day_amount ?? '');
                if (selectArqueoEmployee) selectArqueoEmployee.value = String(item.employee_id || '');
                arqueoLastSavedAtMs = parseIsoToMs(item.updated_at) || 0;
                setArqueoBadge('realizado');
                validarCierreArqueo();
                checkArqueoStaleForDate(fecha);
            })
            .catch(() => {
                setArqueoBadge('pendiente');
                arqueoLastSavedAtMs = 0;
            });
    }

    function validarCierreArqueo() {
        if (!montoApertura || !montoCierre || !montoEfectivoDia) return;
        const apertura = parseFloat(montoApertura.value || '0') || 0;
        const efectivoDia = parseFloat(montoEfectivoDia.value || '0') || 0;
        const cierreStr = (montoCierre.value || '').trim();
        // No mostrar validaci√≥n hasta que el usuario ingrese el cierre
        if (!cierreStr) {
            if (msgArqueoOk) msgArqueoOk.classList.add('hidden');
            if (msgArqueoError) msgArqueoError.classList.add('hidden');
            if (msgArqueoDetalle) msgArqueoDetalle.classList.add('hidden');
            return;
        }
        const cierre = parseFloat(cierreStr) || 0;

        const cierreIdeal = apertura + efectivoDia;
        const diferencia = Math.abs(cierreIdeal - cierre);
        const coincide = diferencia < 0.00001;

        if (coincide) {
            mostrarMensajesArqueo({
                ok: true,
                detalle: 'Cierre de caja ideal ' + formatearMoneda(cierreIdeal) + ' ¬∑ Diferencia ' + formatearMoneda(0)
            });
        } else {
            mostrarMensajesArqueo({
                ok: false,
                detalle: 'Cierre de caja ideal ' + formatearMoneda(cierreIdeal) + ' ¬∑ Diferencia ' + formatearMoneda(diferencia)
            });
        }
    }

    function actualizarTotalEstimado() {
        if (!tablaCarrito || !totalEstimadoEl) return;
        let total = 0;
        const filas = tablaCarrito.querySelectorAll('tbody tr');
        filas.forEach(tr => {
            if (tr.id === 'carrito-empty-row') return;
            const inputSubtotal = tr.querySelector('.input-subtotal');
            if (!inputSubtotal) return;
            const subtotal = parseFloat(inputSubtotal.value || '0');
            if (!isNaN(subtotal)) total += subtotal;
        });
        totalEstimadoEl.textContent = formatearMoneda(total);
        computeTicketTotals();
    }

    // --- Carrito de cambio ---
    function actualizarTotalCambio() {
        if (!tablaCarritoCambio || !totalCambioEl) return;
        let total = 0;
        const filas = tablaCarritoCambio.querySelectorAll('tbody tr');
        filas.forEach(tr => {
            if (tr.id === 'carrito-cambio-empty-row') return;
            const inputSubtotal = tr.querySelector('.input-subtotal-cambio');
            if (!inputSubtotal) return;
            const subtotal = parseFloat(inputSubtotal.value || '0');
            if (!isNaN(subtotal)) total += subtotal;
        });
        totalCambioEl.textContent = formatearMoneda(total);
    }

    // --- Carrito de nueva venta con saldo a favor ---
    function actualizarTotalCambioVenta() {
        if (!tablaCarritoCambioVenta || !totalCambioVentaEl || !diferenciaAbonarEl) return;
        let total = 0;
        const filas = tablaCarritoCambioVenta.querySelectorAll('tbody tr');
        filas.forEach(tr => {
            if (tr.id === 'carrito-cambio-venta-empty-row') return;
            const inputSubtotal = tr.querySelector('.input-subtotal-cambio-venta');
            if (!inputSubtotal) return;
            const subtotal = parseFloat(inputSubtotal.value || '0');
            if (!isNaN(subtotal)) total += subtotal;
        });
        totalCambioVentaEl.textContent = formatearMoneda(total);

        // Calcular diferencia a abonar usando el saldo a favor
        let diferencia = 0;
        if (total > saldoAFavor) {
            diferencia = total - saldoAFavor;
        }
        diferenciaAbonarEl.textContent = formatearMoneda(diferencia);
    }

    function recalcularFila(tr, origen) {
        const inputPrecio = tr.querySelector('.input-precio');
        const inputCantidad = tr.querySelector('.input-cantidad');
        const inputDescuento = tr.querySelector('.input-descuento');
        const inputSubtotal = tr.querySelector('.input-subtotal');
        if (!inputPrecio || !inputCantidad || !inputDescuento || !inputSubtotal) return;

        let precio = parseFloat(inputPrecio.value || '0');
        let cantidad = parseFloat(inputCantidad.value || '0');
        let descuento = parseFloat(inputDescuento.value || '0');
        let subtotal = parseFloat(inputSubtotal.value || '0');

        if (precio < 0) precio = 0;
        if (cantidad < 0) cantidad = 0;

        const base = precio * cantidad;

        if (origen === 'subtotal' && base > 0) {
            // Ajustar descuento seg√∫n subtotal editado
            const ratio = subtotal / base;
            descuento = Math.max(0, Math.min(100, (1 - ratio) * 100));
            inputDescuento.value = isFinite(descuento) ? descuento.toFixed(2) : '0';
        } else {
            // Ajustar subtotal seg√∫n precio, cantidad o descuento
            if (descuento < 0) descuento = 0;
            if (descuento > 100) descuento = 100;
            subtotal = base * (1 - descuento / 100);
            inputSubtotal.value = isFinite(subtotal) ? subtotal.toFixed(2) : '0.00';
            inputDescuento.value = isFinite(descuento) ? descuento.toFixed(2) : '0';
        }

        actualizarTotalEstimado();
    }

    function getSelectedPaymentMethod() {
        const checked = document.querySelector('input[name="forma_pago"]:checked');
        const v = checked ? (checked.value || '') : '';
        return String(v || 'Efectivo');
    }

    function getCartItems() {
        if (!tablaCarrito) return [];
        const rows = Array.from(tablaCarrito.querySelectorAll('tbody tr'))
            .filter(tr => tr && tr.id !== 'carrito-empty-row');
        return rows.map(tr => {
            const nombre = (tr.querySelector('td')?.textContent || '').trim();
            const precio = parseFloat(tr.querySelector('.input-precio')?.value || '0') || 0;
            const cantidad = parseFloat(tr.querySelector('.input-cantidad')?.value || '0') || 0;
            const descuento = parseFloat(tr.querySelector('.input-descuento')?.value || '0') || 0;
            const subtotal = parseFloat(tr.querySelector('.input-subtotal')?.value || '0') || 0;
            const productId = tr.getAttribute('data-product-id') || '';
            return { nombre, precio, cantidad, descuento, subtotal, product_id: productId };
        }).filter(x => x && x.cantidad > 0);
    }

    function sortLotsForMethod(lots, method) {
        const list = (Array.isArray(lots) ? lots : []).slice();
        const m = String(method || 'FIFO');
        const getTime = (l) => {
            const d = String(l?.entry_date || '').trim();
            const t = d ? new Date(d).getTime() : 0;
            return isNaN(t) ? 0 : t;
        };
        if (m === 'UEPS') {
            return list.sort((a, b) => getTime(b) - getTime(a));
        }
        return list.sort((a, b) => getTime(a) - getTime(b));
    }

    function consumirStockParaProducto(ctx) {
        const product = ctx.product;
        const lotsAll = ctx.lotsAll;
        const qty = ctx.qty;
        const method = String(product?.method || 'FIFO');

        const rel = lotsAll.filter(l => String(l?.product_id) === String(product?.id) && (parseFloat(l?.qty_available || '0') || 0) > 0);
        const ordered = sortLotsForMethod(rel, method);

        const totalDisponible = ordered.reduce((acc, l) => acc + (parseFloat(l?.qty_available || '0') || 0), 0);
        if (totalDisponible + 1e-9 < qty) {
            return { ok: false, message: 'Stock insuficiente para ' + String(product?.name || 'producto') + ' (disponible: ' + totalDisponible + ')', consumptions: [] };
        }

        let remaining = qty;
        const consumptions = [];

        if (method === 'Average') {
            const costSum = ordered.reduce((acc, l) => acc + ((parseFloat(l?.qty_available || '0') || 0) * (parseFloat(l?.unit_cost || '0') || 0)), 0);
            const avgCost = totalDisponible > 0 ? (costSum / totalDisponible) : 0;
            // Descontamos FIFO para consistencia f√≠sica, pero costo promedio para trazabilidad
            ordered.forEach(l => {
                if (remaining <= 0) return;
                const avail = parseFloat(l?.qty_available || '0') || 0;
                const take = Math.min(avail, remaining);
                if (take <= 0) return;
                l.qty_available = avail - take;
                remaining -= take;
                consumptions.push({ lot_id: l.id, qty: take, unit_cost: avgCost, cost_total: take * avgCost });
            });
            return { ok: true, consumptions };
        }

        ordered.forEach(l => {
            if (remaining <= 0) return;
            const avail = parseFloat(l?.qty_available || '0') || 0;
            const take = Math.min(avail, remaining);
            if (take <= 0) return;
            l.qty_available = avail - take;
            remaining -= take;
            const uc = parseFloat(l?.unit_cost || '0') || 0;
            consumptions.push({ lot_id: l.id, qty: take, unit_cost: uc, cost_total: take * uc });
        });

        return { ok: true, consumptions };
    }

    function appendHistorialRowVenta(venta) {
        if (!historial || !historialTbody) return;
        const tr = document.createElement('tr');
        tr.innerHTML = ''
            + '<td class="px-3 py-2 text-gray-500">' + String(venta?.ticket || '') + '</td>'
            + '<td class="px-3 py-2 text-gray-500">' + String(venta?.fecha || '‚Äî') + '</td>'
            + '<td class="px-3 py-2 text-gray-500">Venta</td>'
            + '<td class="px-3 py-2 text-gray-500">' + String(venta?.customer_name || '‚Äî') + '</td>'
            + '<td class="px-3 py-2 text-right text-gray-500">' + formatearMoneda(parseFloat(venta?.total || '0') || 0) + '</td>'
            + '<td class="px-3 py-2 text-center text-gray-500">' + String(venta?.payment_method || 'Efectivo') + '</td>'
            + '<td class="px-3 py-2 text-center"><span class="px-2 py-0.5 rounded-full bg-green-50 text-green-700 text-[11px]">Completada</span></td>'
            + '<td class="px-3 py-2 text-center">' + historialAccionesHtml(String(venta?.ticket || '')) + '</td>';
        historialTbody.insertBefore(tr, historialTbody.firstChild);
    }

    function recalcularFilaCambio(tr, origen) {
        const inputPrecio = tr.querySelector('.input-precio-cambio');
        const inputCantidad = tr.querySelector('.input-cantidad-cambio');
        const inputDescuento = tr.querySelector('.input-descuento-cambio');
        const inputSubtotal = tr.querySelector('.input-subtotal-cambio');
        if (!inputPrecio || !inputCantidad || !inputDescuento || !inputSubtotal) return;

        let precio = parseFloat(inputPrecio.value || '0');
        let cantidad = parseFloat(inputCantidad.value || '0');
        let descuento = parseFloat(inputDescuento.value || '0');
        let subtotal = parseFloat(inputSubtotal.value || '0');

        if (precio < 0) precio = 0;
        if (cantidad < 0) cantidad = 0;

        const base = precio * cantidad;

        if (origen === 'subtotal' && base > 0) {
            const ratio = subtotal / base;
            descuento = Math.max(0, Math.min(100, (1 - ratio) * 100));
            inputDescuento.value = isFinite(descuento) ? descuento.toFixed(2) : '0';
        } else {
            if (descuento < 0) descuento = 0;
            if (descuento > 100) descuento = 100;
            subtotal = base * (1 - descuento / 100);
            inputSubtotal.value = isFinite(subtotal) ? subtotal.toFixed(2) : '0.00';
            inputDescuento.value = isFinite(descuento) ? descuento.toFixed(2) : '0';
        }

        actualizarTotalCambio();
    }

    function recalcularFilaCambioVenta(tr, origen) {
        const inputPrecio = tr.querySelector('.input-precio-cambio-venta');
        const inputCantidad = tr.querySelector('.input-cantidad-cambio-venta');
        const inputDescuento = tr.querySelector('.input-descuento-cambio-venta');
        const inputSubtotal = tr.querySelector('.input-subtotal-cambio-venta');
        if (!inputPrecio || !inputCantidad || !inputDescuento || !inputSubtotal) return;

        let precio = parseFloat(inputPrecio.value || '0');
        let cantidad = parseFloat(inputCantidad.value || '0');
        let descuento = parseFloat(inputDescuento.value || '0');
        let subtotal = parseFloat(inputSubtotal.value || '0');

        if (precio < 0) precio = 0;
        if (cantidad < 0) cantidad = 0;

        const base = precio * cantidad;

        if (origen === 'subtotal' && base > 0) {
            const ratio = subtotal / base;
            descuento = Math.max(0, Math.min(100, (1 - ratio) * 100));
            inputDescuento.value = isFinite(descuento) ? descuento.toFixed(2) : '0';
        } else {
            if (descuento < 0) descuento = 0;
            if (descuento > 100) descuento = 100;
            subtotal = base * (1 - descuento / 100);
            inputSubtotal.value = isFinite(subtotal) ? subtotal.toFixed(2) : '0.00';
            inputDescuento.value = isFinite(descuento) ? descuento.toFixed(2) : '0';
        }

        actualizarTotalCambioVenta();
    }

    function agregarProductoAlCarrito(nombre, precioStr, meta) {
        if (!tablaCarrito) return;
        const tbody = tablaCarrito.querySelector('tbody');
        if (!tbody) return;

        let precio = parseFloat(String(precioStr).replace('.', '').replace(',', '.'));
        if (isNaN(precio)) precio = 0;
        const cantidad = 1;
        const descuento = 0;
        const subtotal = precio * cantidad;

        if (carritoEmptyRow) {
            carritoEmptyRow.classList.add('hidden');
        }

        const tr = document.createElement('tr');
        if (meta && meta.productId) tr.setAttribute('data-product-id', String(meta.productId));
        tr.innerHTML = `
            <td class="px-1 py-1 text-gray-700 truncate">${nombre}</td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" step="0.01" class="input-precio w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${precio.toFixed(2)}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" step="1" class="input-cantidad w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${cantidad}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" max="100" step="0.01" class="input-descuento w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${descuento.toFixed(2)}"></td>
            <td class="px-1 py-1 text-right text-gray-900 font-medium"><input type="number" min="0" step="0.01" class="input-subtotal w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${subtotal.toFixed(2)}"></td>
            <td class="px-1 py-1 text-center">
                <button type="button" class="btn-eliminar-item inline-flex items-center justify-center h-5 w-5 rounded-full bg-red-50 text-red-500 hover:bg-red-100">
                    <i class="fas fa-times text-[10px]"></i>
                </button>
            </td>
        `;

        tbody.appendChild(tr);

        const inputPrecio = tr.querySelector('.input-precio');
        const inputCantidad = tr.querySelector('.input-cantidad');
        const inputDescuento = tr.querySelector('.input-descuento');
        const inputSubtotal = tr.querySelector('.input-subtotal');

        [
            { el: inputPrecio, origen: 'precio' },
            { el: inputCantidad, origen: 'cantidad' },
            { el: inputDescuento, origen: 'descuento' },
            { el: inputSubtotal, origen: 'subtotal' },
        ].forEach(({ el, origen }) => {
            if (!el) return;
            el.addEventListener('input', function () {
                recalcularFila(tr, origen === 'subtotal' ? 'subtotal' : 'otros');
            });
        });

        // UX para el descuento: limpiar 0.00 al enfocar y restaurar si queda vac√≠o
        if (inputDescuento) {
            inputDescuento.addEventListener('focus', function() {
                if (inputDescuento.value === '0.00' || inputDescuento.value === '0' || inputDescuento.value === '0.0') {
                    inputDescuento.value = '';
                }
            });
            inputDescuento.addEventListener('blur', function() {
                if (inputDescuento.value.trim() === '') {
                    inputDescuento.value = '0.00';
                    recalcularFila(tr, 'otros');
                }
            });
        }

        actualizarTotalEstimado();
    }

    function agregarProductoAlCarritoCambio(nombre, precioStr, meta) {
        if (!tablaCarritoCambio) return;
        const tbody = tablaCarritoCambio.querySelector('tbody');
        if (!tbody) return;

        let precio = parseFloat(String(precioStr).replace('.', '').replace(',', '.'));
        if (isNaN(precio)) precio = 0;
        const cantidad = 1;
        const descuento = 0;
        const subtotal = precio * cantidad;

        if (carritoCambioEmptyRow) {
            carritoCambioEmptyRow.classList.add('hidden');
        }

        const tr = document.createElement('tr');
        if (meta && meta.productId) tr.setAttribute('data-product-id', String(meta.productId));
        tr.innerHTML = `
            <td class="px-1 py-1 text-gray-700 truncate">${nombre}</td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" step="0.01" class="input-precio-cambio w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${precio.toFixed(2)}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" step="1" class="input-cantidad-cambio w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${cantidad}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" max="100" step="0.01" class="input-descuento-cambio w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${descuento.toFixed(2)}"></td>
            <td class="px-1 py-1 text-right text-gray-900 font-medium"><input type="number" min="0" step="0.01" class="input-subtotal-cambio w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${subtotal.toFixed(2)}"></td>
            <td class="px-1 py-1 text-center">
                <button type="button" class="btn-eliminar-item-cambio inline-flex items-center justify-center h-5 w-5 rounded-full bg-red-50 text-red-500 hover:bg-red-100">
                    <i class="fas fa-times text-[10px]"></i>
                </button>
            </td>
        `;

        tbody.appendChild(tr);

        const inputPrecio = tr.querySelector('.input-precio-cambio');
        const inputCantidad = tr.querySelector('.input-cantidad-cambio');
        const inputDescuento = tr.querySelector('.input-descuento-cambio');
        const inputSubtotal = tr.querySelector('.input-subtotal-cambio');

        [
            { el: inputPrecio, origen: 'precio' },
            { el: inputCantidad, origen: 'cantidad' },
            { el: inputDescuento, origen: 'descuento' },
            { el: inputSubtotal, origen: 'subtotal' },
        ].forEach(({ el, origen }) => {
            if (!el) return;
            el.addEventListener('input', function () {
                recalcularFilaCambio(tr, origen === 'subtotal' ? 'subtotal' : 'otros');
            });
        });

        // UX para el descuento de cambio: limpiar 0.00 al enfocar y restaurar si queda vac√≠o
        if (inputDescuento) {
            inputDescuento.addEventListener('focus', function() {
                if (inputDescuento.value === '0.00' || inputDescuento.value === '0' || inputDescuento.value === '0.0') {
                    inputDescuento.value = '';
                }
            });
            inputDescuento.addEventListener('blur', function() {
                if (inputDescuento.value.trim() === '') {
                    inputDescuento.value = '0.00';
                    recalcularFilaCambio(tr, 'otros');
                }
            });
        }

        actualizarTotalCambio();
    }

    function agregarProductoAlCarritoCambioVenta(nombre, precioStr, meta) {
        if (!tablaCarritoCambioVenta) return;
        const tbody = tablaCarritoCambioVenta.querySelector('tbody');
        if (!tbody) return;

        let precio = parseFloat(String(precioStr).replace('.', '').replace(',', '.'));
        if (isNaN(precio)) precio = 0;
        const cantidad = 1;
        const descuento = 0;
        const subtotal = precio * cantidad;

        if (carritoCambioVentaEmptyRow) {
            carritoCambioVentaEmptyRow.classList.add('hidden');
        }

        const tr = document.createElement('tr');
        if (meta && meta.productId) tr.setAttribute('data-product-id', String(meta.productId));
        tr.innerHTML = `
            <td class="px-1 py-1 text-gray-700 truncate">${nombre}</td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" step="0.01" class="input-precio-cambio-venta w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${precio.toFixed(2)}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" step="1" class="input-cantidad-cambio-venta w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${cantidad}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" max="100" step="0.01" class="input-descuento-cambio-venta w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${descuento.toFixed(2)}"></td>
            <td class="px-1 py-1 text-right text-gray-900 font-medium"><input type="number" min="0" step="0.01" class="input-subtotal-cambio-venta w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${subtotal.toFixed(2)}"></td>
            <td class="px-1 py-1 text-center">
                <button type="button" class="btn-eliminar-item-cambio-venta inline-flex items-center justify-center h-5 w-5 rounded-full bg-red-50 text-red-500 hover:bg-red-100">
                    <i class="fas fa-times text-[10px]"></i>
                </button>
            </td>
        `;

        tbody.appendChild(tr);

        const inputPrecio = tr.querySelector('.input-precio-cambio-venta');
        const inputCantidad = tr.querySelector('.input-cantidad-cambio-venta');
        const inputDescuento = tr.querySelector('.input-descuento-cambio-venta');
        const inputSubtotal = tr.querySelector('.input-subtotal-cambio-venta');

        [
            { el: inputPrecio, origen: 'precio' },
            { el: inputCantidad, origen: 'cantidad' },
            { el: inputDescuento, origen: 'descuento' },
            { el: inputSubtotal, origen: 'subtotal' },
        ].forEach(({ el, origen }) => {
            if (!el) return;
            el.addEventListener('input', function () {
                recalcularFilaCambioVenta(tr, origen === 'subtotal' ? 'subtotal' : 'otros');
            });
        });

        // UX para el descuento: limpiar 0.00 al enfocar y restaurar si queda vac√≠o
        if (inputDescuento) {
            inputDescuento.addEventListener('focus', function() {
                if (inputDescuento.value === '0.00' || inputDescuento.value === '0' || inputDescuento.value === '0.0') {
                    inputDescuento.value = '';
                }
            });
            inputDescuento.addEventListener('blur', function() {
                if (inputDescuento.value.trim() === '') {
                    inputDescuento.value = '0.00';
                    recalcularFilaCambioVenta(tr, 'otros');
                }
            });
        }

        actualizarTotalCambioVenta();
    }

    if (btnNuevaVenta && home && flujo) {
        btnNuevaVenta.addEventListener('click', function() {
            // Mostrar siempre el flujo y ocultar el home
            showFlujo();
            setEditState(null);

            // Reset pasos
            pasoTicket.classList.add('hidden');
            pasoProductos.classList.remove('hidden');
            if (headerFlujo) {
                headerFlujo.classList.remove('hidden');
            }
            if (pillPaso1 && pillPaso2) {
                pillPaso1.classList.add('bg-indigo-600','text-white');
                pillPaso1.classList.remove('bg-indigo-50','text-indigo-700');
                pillPaso2.classList.add('bg-indigo-50','text-indigo-700');
                pillPaso2.classList.remove('bg-indigo-600','text-white');
            }
            scrollAElemento(flujo);
        });
    }

    if (btnVolverHome && home && flujo) {
        btnVolverHome.addEventListener('click', function() {
            showHomeAll();
            setEditState(null);
            scrollAElemento(home);
        });
    }

    if (btnIrCambios) {
        btnIrCambios.addEventListener('click', function() {
            // Asegurar que solo la vista de cambio est√© visible
            showCambio();

            // Abrir siempre la vista de cambio arrancando en Paso 1
            if (cambioPaso1) cambioPaso1.classList.remove('hidden');
            if (cambioPaso2) cambioPaso2.classList.add('hidden');
            if (cambioPaso3) cambioPaso3.classList.add('hidden');

            if (pillCambioPaso1) {
                pillCambioPaso1.classList.add('bg-indigo-600','text-white');
                pillCambioPaso1.classList.remove('bg-indigo-50','text-indigo-700');
            }
            if (pillCambioPaso2) {
                pillCambioPaso2.classList.add('bg-indigo-50','text-indigo-700');
                pillCambioPaso2.classList.remove('bg-indigo-600','text-white');
            }
            if (pillCambioPaso3) {
                pillCambioPaso3.classList.add('bg-gray-100','text-gray-600');
                pillCambioPaso3.classList.remove('bg-indigo-600','text-white');
            }

            if (vistaRealizarCambio) {
                if (!home || !home.contains(vistaRealizarCambio)) vistaRealizarCambio.classList.remove('hidden');
                scrollAElemento(vistaRealizarCambio);
            } else if (historial) {
                historial.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }

    if (btnContinuarTicket && pasoProductos && pasoTicket) {
        btnContinuarTicket.addEventListener('click', function() {
            pasoProductos.classList.add('hidden');
            pasoTicket.classList.remove('hidden');
            if (headerFlujo) {
                headerFlujo.classList.add('hidden');
            }
            if (pillPaso1 && pillPaso2) {
                pillPaso1.classList.remove('bg-indigo-600','text-white');
                pillPaso1.classList.add('bg-indigo-50','text-indigo-700');
                pillPaso2.classList.remove('bg-indigo-50','text-indigo-700');
                pillPaso2.classList.add('bg-indigo-600','text-white');
            }
            scrollAElemento(flujo);
        });
    }

    // Permitir navegar de paso 1 a 2 tocando las pills
    if (pillPaso1 && pillPaso2 && pasoProductos && pasoTicket) {
        pillPaso1.style.cursor = 'pointer';
        pillPaso2.style.cursor = 'pointer';

        pillPaso1.addEventListener('click', function() {
            pasoTicket.classList.add('hidden');
            pasoProductos.classList.remove('hidden');
            pillPaso1.classList.add('bg-indigo-600','text-white');
            pillPaso1.classList.remove('bg-indigo-50','text-indigo-700');
            pillPaso2.classList.add('bg-indigo-50','text-indigo-700');
            pillPaso2.classList.remove('bg-indigo-600','text-white');
        });

        pillPaso2.addEventListener('click', function() {
            pasoProductos.classList.add('hidden');
            pasoTicket.classList.remove('hidden');
            if (headerFlujo) {
                headerFlujo.classList.add('hidden');
            }
            pillPaso1.classList.remove('bg-indigo-600','text-white');
            pillPaso1.classList.add('bg-indigo-50','text-indigo-700');
            pillPaso2.classList.remove('bg-indigo-50','text-indigo-700');
            pillPaso2.classList.add('bg-indigo-600','text-white');
        });
    }

    if (btnVolverPaso1 && pasoProductos && pasoTicket) {
        btnVolverPaso1.addEventListener('click', function() {
            pasoTicket.classList.add('hidden');
            pasoProductos.classList.remove('hidden');
            if (headerFlujo) {
                headerFlujo.classList.remove('hidden');
            }
            if (pillPaso1 && pillPaso2) {
                pillPaso1.classList.add('bg-indigo-600','text-white');
                pillPaso1.classList.remove('bg-indigo-50','text-indigo-700');
                pillPaso2.classList.add('bg-indigo-50','text-indigo-700');
                pillPaso2.classList.remove('bg-indigo-600','text-white');
            }
            scrollAElemento(flujo);
        });
    }

    if (btnSelectCliente) {
        btnSelectCliente.addEventListener('click', function () {
            openSelectCustomer('sale');
        });
    }

    if (btnCrearCliente) {
        btnCrearCliente.addEventListener('click', function () {
            openCreateCustomer(currentCustomerNameFromInput());
        });
    }

    if (btnSelectClienteCambio) {
        btnSelectClienteCambio.addEventListener('click', function () {
            openSelectCustomer('cambio');
        });
    }

    if (btnCrearClienteCambio) {
        btnCrearClienteCambio.addEventListener('click', function () {
            const prefill = String(document.getElementById('cambio-cliente')?.value || '').trim();
            openCreateCustomer(prefill);
        });
    }

    // (El bot√≥n btn-arqueo fue removido del UI: el c√°lculo ahora es autom√°tico)

    if (montoApertura) {
        montoApertura.addEventListener('input', function() {
            recalcularArqueoAutomatico();
        });
    }

    if (montoCierre) {
        montoCierre.addEventListener('input', function() {
            recalcularArqueoAutomatico();
        });
    }

    const inputFechaArqueo = document.getElementById('fecha-arqueo');
    if (inputFechaArqueo) {
        inputFechaArqueo.addEventListener('change', function() {
            recalcularArqueoAutomatico();
            loadArqueoFromServer();
        });
    }

    if (selectArqueoEmployee) {
        selectArqueoEmployee.addEventListener('change', function () {
            if (msgArqueoEmployeeRequired) msgArqueoEmployeeRequired.classList.add('hidden');
        });
    }

    if (btnGuardarArqueo && montoApertura && montoEfectivoDia && montoCierre) {
        btnGuardarArqueo.addEventListener('click', function() {
            // Asegurar c√°lculo y validaci√≥n antes de guardar
            recalcularArqueoAutomatico();

            if (msgArqueoEmployeeRequired) msgArqueoEmployeeRequired.classList.add('hidden');
            const employeeId = String(selectArqueoEmployee?.value || '').trim();
            if (!employeeId) {
                if (msgArqueoEmployeeRequired) msgArqueoEmployeeRequired.classList.remove('hidden');
                if (selectArqueoEmployee && !selectArqueoEmployee.disabled) selectArqueoEmployee.focus();
                return;
            }
            const employeeName = String(selectArqueoEmployee?.selectedOptions?.[0]?.textContent || '').trim();
            const fecha = String(document.getElementById('fecha-arqueo')?.value || '').trim();
            if (!fecha) return;

            const opening = parseFloat(montoApertura.value || '0') || 0;
            const cashDay = parseFloat(montoEfectivoDia.value || '0') || 0;
            const closing = parseFloat(montoCierre.value || '0') || 0;

            fetch('/sales/api/cash-count', {
                method: 'POST',
                credentials: 'same-origin',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    date: fecha,
                    employee_id: employeeId,
                    employee_name: employeeName,
                    opening_amount: opening,
                    cash_day_amount: cashDay,
                    closing_amount: closing
                })
            })
                .then(r => r.json())
                .then(data => {
                    if (!data || !data.ok) return;
                    arqueoLastSavedAtMs = Date.now();
                    setArqueoBadge('realizado');
                    if (msgArqueoGuardado) {
                        msgArqueoGuardado.classList.remove('hidden');
                        window.setTimeout(function () { msgArqueoGuardado.classList.add('hidden'); }, 2000);
                    }
                    validarCierreArqueo();
                })
                .catch(() => {
                });
        });
    }

    initArqueoEmployees();
    setArqueoBadge('pendiente');
    loadArqueoFromServer();

    if (cashflowChannel) {
        try {
            cashflowChannel.addEventListener('message', function (e) {
                const msg = e && e.data ? e.data : null;
                if (!msg) return;
                const d = getCashflowEventDate(msg);
                const arqueoDate = String(document.getElementById('fecha-arqueo')?.value || '').trim();
                if (d && arqueoDate && d !== arqueoDate) return;
                if (msg?.kind === 'expense' && !isCashMethod(msg?.payment_method || msg?.forma_pago)) return;
                maybeMarkArqueoPending('cashflow');
            });
        } catch (e) {
        }
    }
    window.addEventListener('storage', function (e) {
        if (!e || e.key !== 'zentral_cashflow_ping') return;
        try {
            const msg = e.newValue ? JSON.parse(e.newValue) : null;
            if (!msg) return;
            const d = getCashflowEventDate(msg);
            const arqueoDate = String(document.getElementById('fecha-arqueo')?.value || '').trim();
            if (d && arqueoDate && d !== arqueoDate) return;
            if (msg?.kind === 'expense' && !isCashMethod(msg?.payment_method || msg?.forma_pago)) return;
            maybeMarkArqueoPending('cashflow');
        } catch (err) {
        }
    });

    if (btnToggleArqueo) {
        btnToggleArqueo.addEventListener('click', function () {
            openArqueoModal();
            initArqueoEmployees();
            loadArqueoFromServer();
            recalcularArqueoAutomatico();
        });
    }
    if (btnCloseArqueo) btnCloseArqueo.addEventListener('click', closeArqueoModal);
    if (btnCancelArqueo) btnCancelArqueo.addEventListener('click', closeArqueoModal);
    if (modalArqueo) {
        modalArqueo.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalArqueo.firstElementChild) closeArqueoModal();
        });
    }

    if (tablaCarrito) {
        bindProductButtons();
    }

    // Guard defensivo: evitar pantalla en blanco si por alg√∫n motivo todas las vistas quedan ocultas
    try {
        const homeHidden = !!(home && home.classList.contains('hidden'));
        const flujoHidden = !!(flujo && flujo.classList.contains('hidden'));
        const cambioHidden = !!(vistaRealizarCambio && vistaRealizarCambio.classList.contains('hidden'));
        if (home && (homeHidden && flujoHidden && cambioHidden)) {
            home.classList.remove('hidden');
        }
        if (home && !home.classList.contains('hidden')) {
            const flujoVisible = !!(flujo && !flujo.classList.contains('hidden'));
            const cambioVisible = !!(vistaRealizarCambio && !vistaRealizarCambio.classList.contains('hidden'));
            if (!flujoVisible && !cambioVisible) {
                showHomeAll();
            }
        }
    } catch (e) {
    }

    if (toggleVentaLibre && panelVentaLibre) {
        toggleVentaLibre.addEventListener('change', function() {
            if (toggleVentaLibre.checked) {
                panelVentaLibre.classList.remove('hidden');
                if (inputVentaLibreNombre) inputVentaLibreNombre.focus();
            } else {
                panelVentaLibre.classList.add('hidden');
            }
        });
    }

    function agregarVentaLibreDesdeFormulario() {
        if (!inputVentaLibreNombre || !inputVentaLibrePrecio) return;
        const nombre = (inputVentaLibreNombre.value || '').trim();
        const precio = parseFloat(inputVentaLibrePrecio.value || '0');
        if (!nombre) return;
        agregarProductoAlCarrito(nombre, isNaN(precio) ? '0' : String(precio.toFixed(2)));
        inputVentaLibreNombre.value = '';
        inputVentaLibrePrecio.value = '';
        inputVentaLibreNombre.focus();
    }

    if (btnAgregarVentaLibre) {
        btnAgregarVentaLibre.addEventListener('click', function() {
            agregarVentaLibreDesdeFormulario();
        });
    }

    if (inputVentaLibreNombre) {
        inputVentaLibreNombre.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                agregarVentaLibreDesdeFormulario();
            }
        });
    }

    if (inputVentaLibrePrecio) {
        inputVentaLibrePrecio.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                agregarVentaLibreDesdeFormulario();
            }
        });
    }

    // Cat√°logo de cambio: agregar productos al carrito de cambio
    if (botonesProductoCambio && botonesProductoCambio.length && tablaCarritoCambio) {
        botonesProductoCambio.forEach(btn => {
            btn.addEventListener('click', function() {
                const nombre = btn.getAttribute('data-nombre') || 'Producto';
                const precio = btn.getAttribute('data-precio') || '0';
                agregarProductoAlCarritoCambio(nombre, precio);
            });
        });
    }

    // Eliminar √≠tems del carrito (delegado sobre la tabla)
    if (tablaCarrito) {
        tablaCarrito.addEventListener('click', function(e) {
            const btnDel = e.target.closest('.btn-eliminar-item');
            if (!btnDel) return;
            const fila = btnDel.closest('tr');
            if (!fila) return;
            fila.remove();

            // Si no quedan filas de √≠tems, mostrar mensaje vac√≠o
            const filasRestantes = tablaCarrito.querySelectorAll('tbody tr');
            let hayItems = false;
            filasRestantes.forEach(tr => {
                if (tr.id !== 'carrito-empty-row') {
                    hayItems = true;
                }
            });
            if (!hayItems && carritoEmptyRow) {
                carritoEmptyRow.classList.remove('hidden');
            }

            actualizarTotalEstimado();
        });
    }

    // Eliminar √≠tems del carrito de cambio (delegado sobre la tabla)
    if (tablaCarritoCambio) {
        tablaCarritoCambio.addEventListener('click', function(e) {
            const btnDel = e.target.closest('.btn-eliminar-item-cambio');
            if (!btnDel) return;
            const fila = btnDel.closest('tr');
            if (!fila) return;
            fila.remove();

            const filasRestantes = tablaCarritoCambio.querySelectorAll('tbody tr');
            let hayItems = false;
            filasRestantes.forEach(tr => {
                if (tr.id !== 'carrito-cambio-empty-row') {
                    hayItems = true;
                }
            });
            if (!hayItems && carritoCambioEmptyRow) {
                carritoCambioEmptyRow.classList.remove('hidden');
            }

            actualizarTotalCambio();
        });
    }

    // Cat√°logo de nueva venta en flujo de cambio: agregar productos al carrito de nueva venta
    if (botonesProductoCambioVenta && botonesProductoCambioVenta.length && tablaCarritoCambioVenta) {
        botonesProductoCambioVenta.forEach(btn => {
            btn.addEventListener('click', function() {
                const nombre = btn.getAttribute('data-nombre') || 'Producto';
                const precio = btn.getAttribute('data-precio') || '0';
                agregarProductoAlCarritoCambioVenta(nombre, precio);
            });
        });
    }

    // Eliminar √≠tems del carrito de nueva venta (delegado sobre la tabla)
    if (tablaCarritoCambioVenta) {
        tablaCarritoCambioVenta.addEventListener('click', function(e) {
            const btnDel = e.target.closest('.btn-eliminar-item-cambio-venta');
            if (!btnDel) return;
            const fila = btnDel.closest('tr');
            if (!fila) return;
            fila.remove();

            const filasRestantes = tablaCarritoCambioVenta.querySelectorAll('tbody tr');
            let hayItems = false;
            filasRestantes.forEach(tr => {
                if (tr.id !== 'carrito-cambio-venta-empty-row') {
                    hayItems = true;
                }
            });
            if (!hayItems && carritoCambioVentaEmptyRow) {
                carritoCambioVentaEmptyRow.classList.remove('hidden');
            }

            actualizarTotalCambioVenta();
        });
    }

    function mostrarVistaMovimiento(vista) {
        // Las vistas dummy fueron removidas. Mantener helper por compatibilidad.
        if (!vista) return;
        vista.classList.add('hidden');
    }

    function handleGlobalEscape() {
        // cerrar modales si est√°n abiertos
        if (modalExportVentas && !modalExportVentas.classList.contains('hidden')) { closeExportVentas(); return; }
        if (modalCuentaCorriente && !modalCuentaCorriente.classList.contains('hidden')) { closeModal(modalCuentaCorriente); return; }
        if (modalSelectCustomer && !modalSelectCustomer.classList.contains('hidden')) { closeModal(modalSelectCustomer); return; }
        if (modalCreateCustomer && !modalCreateCustomer.classList.contains('hidden')) { closeModal(modalCreateCustomer); return; }

        // volver del flujo al home
        if (flujo && !flujo.classList.contains('hidden')) {
            if (flujo) flujo.classList.add('hidden');
            if (home) home.classList.remove('hidden');
            setEditState('');
            scrollAElemento(historial || home);
        }
    }

    function adjustSelectedCartQty(delta) {
        const tbody = tablaCarrito ? tablaCarrito.querySelector('tbody') : null;
        if (!tbody) return;
        const selected = tbody.querySelector('tr[data-selected="1"]');
        if (!selected) return;
        const qtyInput = selected.querySelector('input.item-cantidad');
        if (!qtyInput) return;
        const cur = parseFloat(qtyInput.value || '0') || 0;
        const next = Math.max(0, cur + delta);
        qtyInput.value = String(next);
        qtyInput.dispatchEvent(new Event('input', { bubbles: true }));
    }

    // Acciones sobre movimientos (men√∫ de tres puntitos)
    function cerrarTodosLosMenusMov() {
        const menus = document.querySelectorAll('.menu-mov-acciones');
        if (!menus || !menus.length) return;
        menus.forEach(menu => menu.classList.add('hidden'));
    }

    function deleteTicketById(ticket) {
        const t = String(ticket || '').trim();
        if (!t) return;
        const confirmar = window.confirm('¬øSeguro que quer√©s eliminar el ticket ' + t + '?');
        if (!confirmar) return;

        apiDeleteSale(t).then(function (res) {
            if (!res || res.ok !== true) {
                alert('No se pudo eliminar el ticket.');
                return;
            }
            salesCache = (Array.isArray(salesCache) ? salesCache : []).filter(s => String(s?.ticket || '').trim() !== t);
            renderHistorialFromCache();
            applyVentasFilters();
            initKpisFromSales();
            recalcularArqueoAutomatico();
            scrollAElemento(historial || home);
        }).catch(function () {
            alert('No se pudo eliminar el ticket.');
        });
    }

    // Cerrar men√∫s al hacer clic fuera
    document.addEventListener('click', function () {
        cerrarTodosLosMenusMov();
    });

    // Toggle del men√∫ (delegado para soportar filas renderizadas din√°micamente)
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('.btn-mov-menu');
        if (!btn) return;
        e.stopPropagation();
        const contenedor = btn.closest('.relative');
        if (!contenedor) return;
        const menu = contenedor.querySelector('.menu-mov-acciones');
        if (!menu) return;
        const estabaAbierto = !menu.classList.contains('hidden');
        cerrarTodosLosMenusMov();
        if (!estabaAbierto) menu.classList.remove('hidden');
    });

    // Manejar opciones del men√∫ (editar + eliminar)
    document.addEventListener('click', function (e) {
        const btnVer = e.target.closest('.opcion-ver-ticket');
        const btnEliminar = e.target.closest('.opcion-eliminar-ticket');
        if (!btnVer && !btnEliminar) return;
        e.stopPropagation();
        const ticket = (btnVer || btnEliminar).getAttribute('data-ticket') || '';

        if (btnVer) {
            cerrarTodosLosMenusMov();
            openEditTicket(ticket);
            return;
        }

        if (btnEliminar) {
            cerrarTodosLosMenusMov();
            deleteTicketById(ticket);
        }
    });

    // Preparar input de rango de fechas (calendario de rango con flatpickr)
    if (inputFechaRango && window.flatpickr) {
        inputFechaRango.setAttribute('readonly', 'readonly');
        flatpickr(inputFechaRango, {
            mode: 'range',
            dateFormat: 'd/m/Y',
            locale: window.flatpickr && window.flatpickr.l10ns ? window.flatpickr.l10ns.es : 'es',
            allowInput: false,
            onChange: function () {
                applyVentasFilters();
            }
        });
    }

    function openExportVentas() {
        if (!modalExportVentas) return;
        modalExportVentas.classList.remove('hidden');
    }

    function closeExportVentas() {
        if (!modalExportVentas) return;
        modalExportVentas.classList.add('hidden');
    }

    function escapeCsvCell(v) {
        const s = String(v ?? '');
        if (/[\n\r",;]/.test(s)) {
            return '"' + s.replace(/"/g, '""') + '"';
        }
        return s;
    }

    function getVentasVisibleRows() {
        const tabla = document.querySelector('#historial-ventas table');
        if (!tabla) return [];
        const trs = Array.from(tabla.querySelectorAll('tbody tr'));
        return trs
            .filter(tr => !tr.classList.contains('hidden'))
            .map(tr => {
                const tds = Array.from(tr.querySelectorAll('td')).map(td => (td.textContent || '').trim());
                return {
                    ticket: tds[0] || '',
                    fecha: tds[1] || '',
                    tipo: tds[2] || '',
                    cliente: tds[3] || '',
                    total: tds[4] || '',
                    pago: tds[5] || '',
                    estado: (tr.querySelector('td:nth-child(7)')?.textContent || '').trim()
                };
            });
    }

    function exportVentasCsv() {
        const rows = getVentasVisibleRows();
        const header = ['Ticket','Fecha','Tipo','Cliente','Total','Pago','Estado'];
        const lines = [header.map(escapeCsvCell).join(';')];
        rows.forEach(r => {
            lines.push([
                r.ticket,
                r.fecha,
                r.tipo,
                r.cliente,
                r.total,
                r.pago,
                r.estado
            ].map(escapeCsvCell).join(';'));
        });
        const blob = new Blob(["\ufeff" + lines.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'ventas_historial.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.setTimeout(function () { URL.revokeObjectURL(a.href); }, 500);
    }

    function exportVentasPdfPrint() {
        const rows = getVentasVisibleRows();
        const w = window.open('', '_blank');
        if (!w) return;
        const period = (inputFechaRango?.value || '').trim();
        const htmlRows = rows.map(r => {
            return ''
                + '<tr>'
                + '<td>' + r.ticket + '</td>'
                + '<td>' + r.fecha + '</td>'
                + '<td>' + r.tipo + '</td>'
                + '<td>' + r.cliente + '</td>'
                + '<td class="num">' + r.total + '</td>'
                + '<td>' + r.pago + '</td>'
                + '<td>' + r.estado + '</td>'
                + '</tr>';
        }).join('');

        const html = `
<!doctype html>
<html lang="es"><head><meta charset="utf-8" />
<title>Exportar ventas</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#111}
h1{font-size:18px;margin:0 0 6px 0}
p{margin:0 0 14px 0;color:#555;font-size:12px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}
th{background:#f9fafb}
td.num,th.num{text-align:right}
.meta{display:flex;justify-content:space-between;gap:12px;align-items:flex-end;margin-bottom:12px}
.pill{font-size:12px;color:#111}
</style>
</head><body>
<div class="meta">
  <div>
    <h1>Historial de ventas</h1>
    <p>Per√≠odo: ${period || 'todo'}</p>
  </div>
  <div class="pill">Filtros: <strong>${(inputSearchVentasCliente?.value || '').trim() || '‚Äî'}</strong> / <strong>${(inputSearchVentasTicket?.value || '').trim() || '‚Äî'}</strong></div>
</div>
<table>
  <thead><tr>
    <th>Ticket</th><th>Fecha</th><th>Tipo</th><th>Cliente</th><th class="num">Total</th><th>Pago</th><th>Estado</th>
  </tr></thead>
  <tbody>
    ` + htmlRows + `
  </tbody>
</table>
<script>window.onload=function(){window.print();}<\/script>
</body></html>`;
        w.document.open();
        w.document.write(html);
        w.document.close();
    }

    if (btnExportVentas) btnExportVentas.addEventListener('click', function () { openExportVentas(); });
    if (btnCloseExportVentas) btnCloseExportVentas.addEventListener('click', function () { closeExportVentas(); });
    if (btnCancelExportVentas) btnCancelExportVentas.addEventListener('click', function () { closeExportVentas(); });
    if (modalExportVentas) {
        modalExportVentas.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalExportVentas.firstElementChild) closeExportVentas();
        });
    }
    if (btnExportVentasXls) btnExportVentasXls.addEventListener('click', function () { exportVentasCsv(); closeExportVentas(); });
    if (btnExportVentasPdf) btnExportVentasPdf.addEventListener('click', function () { exportVentasPdfPrint(); closeExportVentas(); });

    if (btnClearVentas) {
        btnClearVentas.addEventListener('click', function () {
            if (inputFechaRango) inputFechaRango.value = '';
            if (inputSearchVentasCliente) inputSearchVentasCliente.value = '';
            if (inputSearchVentasTicket) inputSearchVentasTicket.value = '';
            if (selectVentasTipo) selectVentasTipo.value = '';
            if (selectVentasPago) selectVentasPago.value = '';
            if (selectVentasEstado) selectVentasEstado.value = '';
            applyVentasFilters();
        });
    }

    if (tablaCarrito) {
        tablaCarrito.addEventListener('click', function (e) {
            const tr = e.target.closest('tbody tr');
            if (!tr || tr.id === 'carrito-empty-row') return;
            const tbody = tablaCarrito.querySelector('tbody');
            if (!tbody) return;
            Array.from(tbody.querySelectorAll('tr')).forEach(r => r.removeAttribute('data-selected'));
            tr.setAttribute('data-selected', '1');
        });
    }

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            handleGlobalEscape();
            return;
        }
        if (e.ctrlKey && (e.key === '+' || e.key === '=')) {
            e.preventDefault();
            adjustSelectedCartQty(1);
            return;
        }
        if (e.ctrlKey && e.key === '-') {
            e.preventDefault();
            adjustSelectedCartQty(-1);
            return;
        }
    });

    if (btnVolverDesdeCambio) {
        btnVolverDesdeCambio.addEventListener('click', function() {
            // Si estamos en Paso 2 del flujo de cambio, volver a Paso 1 sin salir al home
            if (cambioPaso2 && !cambioPaso2.classList.contains('hidden') && cambioPaso1) {
                cambioPaso2.classList.add('hidden');
                cambioPaso1.classList.remove('hidden');
                if (pillCambioPaso1 && pillCambioPaso2) {
                    pillCambioPaso1.classList.add('bg-indigo-600','text-white');
                    pillCambioPaso1.classList.remove('bg-indigo-50','text-indigo-700');
                    pillCambioPaso2.classList.add('bg-indigo-50','text-indigo-700');
                    pillCambioPaso2.classList.remove('bg-indigo-600','text-white');
                }
                scrollAElemento(vistaRealizarCambio);
                return;
            }

            // Si ya estamos en Paso 1, la flecha vuelve al home de Ventas
            if (vistaRealizarCambio) vistaRealizarCambio.classList.add('hidden');
            if (home) home.classList.remove('hidden');
            scrollAElemento(historial || home);
        });
    }

    // Navegaci√≥n interna de pasos en flujo de cambio (pills superiores)
    if (pillCambioPaso1 && pillCambioPaso2 && cambioPaso1 && cambioPaso2) {
        pillCambioPaso1.style.cursor = 'pointer';
        pillCambioPaso2.style.cursor = 'pointer';
        if (pillCambioPaso3) pillCambioPaso3.style.cursor = 'pointer';

        pillCambioPaso1.addEventListener('click', function() {
            if (cambioPaso2) cambioPaso2.classList.add('hidden');
            if (cambioPaso3) cambioPaso3.classList.add('hidden');
            cambioPaso1.classList.remove('hidden');
            pillCambioPaso1.classList.add('bg-indigo-600','text-white');
            pillCambioPaso1.classList.remove('bg-indigo-50','text-indigo-700');
            pillCambioPaso2.classList.add('bg-indigo-50','text-indigo-700');
            pillCambioPaso2.classList.remove('bg-indigo-600','text-white');
            if (pillCambioPaso3) {
                pillCambioPaso3.classList.add('bg-gray-100','text-gray-600');
                pillCambioPaso3.classList.remove('bg-indigo-600','text-white');
            }
        });

        pillCambioPaso2.addEventListener('click', function() {
            cambioPaso1.classList.add('hidden');
            if (cambioPaso3) cambioPaso3.classList.add('hidden');
            cambioPaso2.classList.remove('hidden');
            pillCambioPaso1.classList.remove('bg-indigo-600','text-white');
            pillCambioPaso1.classList.add('bg-indigo-50','text-indigo-700');
            pillCambioPaso2.classList.remove('bg-indigo-50','text-indigo-700');
            pillCambioPaso2.classList.add('bg-indigo-600','text-white');
            if (pillCambioPaso3) {
                pillCambioPaso3.classList.add('bg-gray-100','text-gray-600');
                pillCambioPaso3.classList.remove('bg-indigo-600','text-white');
            }
        });

        if (pillCambioPaso3 && cambioPaso3) {
            pillCambioPaso3.addEventListener('click', function() {
                cambioPaso1.classList.add('hidden');
                if (cambioPaso2) cambioPaso2.classList.add('hidden');
                cambioPaso3.classList.remove('hidden');
                pillCambioPaso1.classList.remove('bg-indigo-600','text-white');
                pillCambioPaso1.classList.add('bg-indigo-50','text-indigo-700');
                pillCambioPaso2.classList.remove('bg-indigo-600','text-white');
                pillCambioPaso2.classList.add('bg-indigo-50','text-indigo-700');
                pillCambioPaso3.classList.remove('bg-gray-100','text-gray-600');
                pillCambioPaso3.classList.add('bg-indigo-600','text-white');
            });
        }
    }

    // Confirmar venta (inventario FIFO en backend)
    if (btnConfirmarVenta && home && flujo && pasoProductos && pasoTicket) {
        btnConfirmarVenta.addEventListener('click', function() {
            const items = getCartItems();
            if (!items.length) {
                alert('Agreg√° al menos un producto al carrito.');
                return;
            }

            if (ventaOnAccount) {
                if (!selectedCustomer || !selectedCustomer.name) {
                    alert('Para usar cuenta corriente ten√©s que asociar un cliente.');
                    return;
                }
            }

            const fecha = String(ticketFecha?.value || '').trim() || defaultFecha;
            const notas = String(ticketNotas?.value || '').trim();
            const pago = getSelectedPaymentMethod();
            const totals = computeTicketTotals();
            const total = totals.total;
            const ventaLibre = !!(toggleVentaLibreTicket?.checked || toggleVentaLibre?.checked);

            const paidAmount = ventaOnAccount ? Math.max(0, Math.min(total, (parseFloat(ventaPaidAmount || 0) || 0))) : total;
            const dueAmount = ventaOnAccount ? Math.max(0, total - paidAmount) : 0;

            const payload = {
                fecha,
                type: 'Venta',
                status: 'Completada',
                payment_method: pago,
                notes: notas,
                total,
                discount_general_pct: totals.pct,
                discount_general_amount: totals.descGeneral,
                items,
                customer_id: selectedCustomer ? (selectedCustomer.id || '') : '',
                customer_name: selectedCustomer ? (selectedCustomer.name || '') : '',
                on_account: ventaOnAccount,
                paid_amount: paidAmount,
                due_amount: dueAmount,
            };

            const req = editTicketId ? apiUpdateSale(editTicketId, payload) : apiCreateSale(payload);
            Promise.resolve(req).then(function (res) {
                if (!res || res.ok !== true) {
                    const msg = (res && (res.message || res.error)) ? String(res.message || res.error) : 'No se pudo registrar la venta.';
                    alert(msg);
                    return;
                }
                const saved = res.item;
                if (!saved) return;

                // refrescar cache local
                const t = String(saved.ticket || '').trim();
                const idx = (Array.isArray(salesCache) ? salesCache : []).findIndex(s => String(s?.ticket || '').trim() === t);
                if (idx >= 0) salesCache[idx] = saved;
                else salesCache.unshift(saved);
                salesLoaded = true;

                renderHistorialFromCache();
                applyVentasFilters();
                initKpisFromSales();
                recalcularArqueoAutomatico();
                emitCashflowChanged({ kind: 'sale', date: fecha, payment_method: pago, created_at: saved.created_at || Date.now() });

                clearCartVenta();
                if (inputDescuentoGeneral) inputDescuentoGeneral.value = '';
                if (inputClienteBusqueda) inputClienteBusqueda.value = '';
                if (ticketNotas) ticketNotas.value = '';
                selectedCustomer = null;
                ventaOnAccount = false;
                ventaPaidAmount = 0;
                setEditState(null);
                actualizarTotalEstimado();

                pasoTicket.classList.add('hidden');
                pasoProductos.classList.remove('hidden');
                flujo.classList.add('hidden');
                home.classList.remove('hidden');
                if (headerFlujo) headerFlujo.classList.remove('hidden');
                if (pillPaso1 && pillPaso2) {
                    pillPaso1.classList.add('bg-indigo-600','text-white');
                    pillPaso1.classList.remove('bg-indigo-50','text-indigo-700');
                    pillPaso2.classList.add('bg-indigo-50','text-indigo-700');
                    pillPaso2.classList.remove('bg-indigo-600','text-white');
                }
                scrollAElemento(home);
            }).catch(function () {
                alert('No se pudo registrar la venta.');
            });
        });
    }

    // Si hay inventario real, reemplazar grilla dummy por productos reales
    renderProductosDesdeInventario();
    renderProductosCambioDesdeInventario();
    renderProductosCambioVentaDesdeInventario();

    // Init customers + autocomplete
    initCustomers();
    if (inputClienteBusqueda) {
        inputClienteBusqueda.addEventListener('input', function () {
            selectedCustomer = null;
            actualizarClienteDd();
        });
        inputClienteBusqueda.addEventListener('focus', function () {
            actualizarClienteDd();
        });
        inputClienteBusqueda.addEventListener('blur', function () {
            window.setTimeout(function () { hideClienteDd(); }, 120);
        });
        document.addEventListener('click', function (ev) {
            const wrap = inputClienteBusqueda.parentElement;
            if (wrap && !wrap.contains(ev.target)) hideClienteDd();
        });
    }

    if (btnPagoCompleto) btnPagoCompleto.addEventListener('click', function () { setPagoCompleto(); });
    if (btnCuentaCorriente) btnCuentaCorriente.addEventListener('click', function () { openCuentaCorrienteModal(); });

    if (ccPaid) ccPaid.addEventListener('input', function () { syncCcDuePreview(); });
    if (btnCloseCc) btnCloseCc.addEventListener('click', function () { closeCuentaCorrienteModal(); });
    if (btnCancelCc) btnCancelCc.addEventListener('click', function () { closeCuentaCorrienteModal(); });
    if (btnAcceptCc) btnAcceptCc.addEventListener('click', function () { acceptCuentaCorriente(); });
    if (modalCuentaCorriente) {
        modalCuentaCorriente.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalCuentaCorriente.firstElementChild) closeCuentaCorrienteModal();
        });
    }

    if (modalSelectCustomer) {
        modalSelectCustomer.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalSelectCustomer.firstElementChild) closeModal(modalSelectCustomer);
        });
    }
    if (btnCloseSelectCustomer) btnCloseSelectCustomer.addEventListener('click', function () { closeModal(modalSelectCustomer); });
    if (btnCancelSelectCustomer) btnCancelSelectCustomer.addEventListener('click', function () { closeModal(modalSelectCustomer); });
    if (inputSelectCustomerQ) inputSelectCustomerQ.addEventListener('input', function () { renderSelectCustomerList(); });
    if (btnOpenCreateCustomer) btnOpenCreateCustomer.addEventListener('click', function () { openCreateCustomer(''); });

    if (modalCreateCustomer) {
        modalCreateCustomer.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalCreateCustomer.firstElementChild) closeModal(modalCreateCustomer);
        });
    }
    if (btnCloseCreateCustomer) btnCloseCreateCustomer.addEventListener('click', function () { closeModal(modalCreateCustomer); });
    if (btnCancelCreateCustomer) btnCancelCreateCustomer.addEventListener('click', function () { closeModal(modalCreateCustomer); });
    if (btnSaveCreateCustomer) btnSaveCreateCustomer.addEventListener('click', function () { saveNewCustomer(); });

    if (inputDescuentoGeneral) {
        inputDescuentoGeneral.addEventListener('input', function () {
            computeTicketTotals();
        });
    }

    if (inputSearchVentasCliente) inputSearchVentasCliente.addEventListener('input', function () { applyVentasFilters(); });
    if (inputSearchVentasTicket) inputSearchVentasTicket.addEventListener('input', function () { applyVentasFilters(); });
    if (selectVentasTipo) selectVentasTipo.addEventListener('change', function () { applyVentasFilters(); });
    if (selectVentasPago) selectVentasPago.addEventListener('change', function () { applyVentasFilters(); });
    if (selectVentasEstado) selectVentasEstado.addEventListener('change', function () { applyVentasFilters(); });

    // Init KPIs
    initKpisFromSales();

    // Confirmar productos del cambio (pasar a Paso 2 con saldo a favor)
    if (btnConfirmarCambio && vistaRealizarCambio && cambioPaso1 && cambioPaso2 && saldoAFavorEl) {
        btnConfirmarCambio.addEventListener('click', function() {
            // Tomar el total del cambio como saldo a favor
            let totalCambio = 0;
            if (tablaCarritoCambio) {
                const filas = tablaCarritoCambio.querySelectorAll('tbody tr');
                filas.forEach(tr => {
                    if (tr.id === 'carrito-cambio-empty-row') return;
                    const inputSubtotal = tr.querySelector('.input-subtotal-cambio');
                    if (!inputSubtotal) return;
                    const subtotal = parseFloat(inputSubtotal.value || '0');
                    if (!isNaN(subtotal)) totalCambio += subtotal;
                });
            }

            saldoAFavor = isNaN(totalCambio) ? 0 : totalCambio;
            saldoAFavorEl.textContent = formatearMoneda(saldoAFavor);
            if (resumenSaldoAFavorEl) resumenSaldoAFavorEl.textContent = formatearMoneda(saldoAFavor);

            // Cambiar a Paso 2 dentro de la vista de cambio
            cambioPaso1.classList.add('hidden');
            cambioPaso2.classList.remove('hidden');

            if (pillCambioPaso1 && pillCambioPaso2) {
                pillCambioPaso1.classList.remove('bg-indigo-600','text-white');
                pillCambioPaso1.classList.add('bg-indigo-50','text-indigo-700');
                pillCambioPaso2.classList.remove('bg-indigo-50','text-indigo-700');
                pillCambioPaso2.classList.add('bg-indigo-600','text-white');
            }

            scrollAElemento(vistaRealizarCambio);
        });
    }

    // Confirmar ticket y registrar el cambio en DB
    if (btnConfirmarCambioFinal) {
        btnConfirmarCambioFinal.addEventListener('click', function () {
            const itemsIn = getCartItemsCambio();
            const itemsOut = getCartItemsCambioVenta();
            if (!itemsIn.length) {
                alert('Agreg√° al menos un producto devuelto.');
                return;
            }
            if (!itemsOut.length) {
                alert('Agreg√° al menos un producto de la nueva venta.');
                return;
            }

            const fecha = String(document.getElementById('cambio-fecha')?.value || '').trim() || defaultFecha;
            const pago = getCambioPaymentMethod();
            const notas = String(inputNotasCambio?.value || '').trim();

            const originalTicket = String(inputCambioTicketOriginal?.value || '').trim();

            const returnTotal = itemsIn.reduce((acc, it) => acc + (parseFloat(it.subtotal || 0) || 0), 0);
            const newTotal = itemsOut.reduce((acc, it) => acc + (parseFloat(it.subtotal || 0) || 0), 0);
            const diff = newTotal - returnTotal;

            const custName = String(selectedCustomer?.name || inputClienteCambio?.value || '').trim();
            const custId = String(selectedCustomer?.id || '').trim();

            apiCreateExchange({
                fecha,
                payment_method: pago,
                notes: notas,
                original_ticket: originalTicket,
                customer_id: custId,
                customer_name: custName,
                return_items: itemsIn,
                new_items: itemsOut,
                return_total: returnTotal,
                new_total: newTotal,
            }).then(function (res) {
                if (!res || res.ok !== true) {
                    const msg = (res && (res.message || res.error)) ? String(res.message || res.error) : 'No se pudo registrar el cambio.';
                    alert(msg);
                    return;
                }

                const saleReturn = res?.items?.return || null;
                const saleNew = res?.items?.sale || null;
                const orig = String(res?.original_ticket || '').trim();

                // Remover del cache el ticket original (reemplazado)
                if (orig) {
                    salesCache = (Array.isArray(salesCache) ? salesCache : []).filter(s => String(s?.ticket || '').trim() !== orig);
                }

                if (saleNew && saleNew.ticket) salesCache.unshift(saleNew);
                if (saleReturn && saleReturn.ticket) salesCache.unshift(saleReturn);
                salesLoaded = true;

                // refrescar inventario (cambi√≥ stock)
                invLoaded = false;
                invLoadPromise = null;
                renderProductosDesdeInventario();
                renderProductosCambioDesdeInventario();
                renderProductosCambioVentaDesdeInventario();

                renderHistorialFromCache();
                applyVentasFilters();
                initKpisFromSales();
                recalcularArqueoAutomatico();
                emitCashflowChanged({ kind: 'sale', date: fecha, payment_method: pago, created_at: Date.now() });

                // reset UI del cambio
                if (tablaCarritoCambio) {
                    const b = tablaCarritoCambio.querySelector('tbody');
                    if (b) b.innerHTML = '<tr id="carrito-cambio-empty-row"><td colspan="6" class="px-2 py-3 text-center text-gray-400 text-[11px]">Agreg√° productos devueltos para continuar.</td></tr>';
                }
                if (tablaCarritoCambioVenta) {
                    const b2 = tablaCarritoCambioVenta.querySelector('tbody');
                    if (b2) b2.innerHTML = '<tr id="carrito-cambio-venta-empty-row"><td colspan="6" class="px-2 py-3 text-center text-gray-400 text-[11px]">Agreg√° productos para la nueva venta.</td></tr>';
                }

                saldoAFavor = 0;
                if (saldoAFavorEl) saldoAFavorEl.textContent = formatearMoneda(0);
                if (resumenSaldoAFavorEl) resumenSaldoAFavorEl.textContent = formatearMoneda(0);
                if (inputCambioTicketOriginal) inputCambioTicketOriginal.value = '';

                // volver a home
                if (vistaRealizarCambio) vistaRealizarCambio.classList.add('hidden');
                if (home) home.classList.remove('hidden');
                scrollAElemento(home);
            }).catch(function () {
                alert('No se pudo registrar el cambio.');
            });
        });
    }

    // Confirmar nueva venta (pasar a Paso 3 con resumen)
    if (btnConfirmarCambioVenta && cambioPaso2 && cambioPaso3 && totalCambioVentaEl && diferenciaAbonarEl) {
        btnConfirmarCambioVenta.addEventListener('click', function() {
            // Asegurar totales actualizados
            actualizarTotalCambioVenta();

            const totalVentaTexto = totalCambioVentaEl.textContent || '$0,00';
            const diferenciaTexto = diferenciaAbonarEl.textContent || '$0,00';

            if (resumenTotalCambioVentaEl) resumenTotalCambioVentaEl.textContent = totalVentaTexto;
            if (resumenDiferenciaAbonarEl) resumenDiferenciaAbonarEl.textContent = diferenciaTexto;

            // Pasar a Paso 3
            cambioPaso2.classList.add('hidden');
            cambioPaso3.classList.remove('hidden');
            if (pillCambioPaso1 && pillCambioPaso2 && pillCambioPaso3) {
                pillCambioPaso1.classList.remove('bg-indigo-600','text-white');
                pillCambioPaso1.classList.add('bg-indigo-50','text-indigo-700');
                pillCambioPaso2.classList.remove('bg-indigo-600','text-white');
                pillCambioPaso2.classList.add('bg-indigo-50','text-indigo-700');
                pillCambioPaso3.classList.remove('bg-gray-100','text-gray-600');
                pillCambioPaso3.classList.add('bg-indigo-600','text-white');
            }

            scrollAElemento(vistaRealizarCambio);
        });
    }
});
</script>
{% endblock %}
