{% extends 'base.html' %}
{% block title %}Ventas{% endblock %}
{% block content %}
<!-- HOME de Ventas: acciones principales + indicadores + historial -->
<div id="ventas-home" class="space-y-6">
    <div class="flex items-center justify-between">
        <div>
            <div class="flex items-center gap-2">
                <h1 class="text-2xl font-bold text-gray-900">Ventas</h1>
                <button type="button" class="inline-flex items-center justify-center h-8 w-8 rounded-md hover:bg-gray-100 text-gray-600" data-kpi-toggle="sales" data-kpi-key="sales" data-kpi-target="#kpi-section-sales" aria-expanded="true" aria-label="Mostrar/ocultar KPIs">
                    <i data-kpi-toggle-icon class="fas fa-chevron-down"></i>
                </button>
            </div>
            <p class="mt-1 text-sm text-gray-600">Registr√° ventas, gestion√° cambios y visualiz√° el historial del d√≠a.</p>
        </div>
        <div class="flex gap-3">
            <button id="btn-nueva-venta" class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md text-white" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                <i class="fas fa-plus mr-2"></i> Nueva venta
            </button>
            <button id="btn-ir-cambios" class="inline-flex items-center px-4 py-2 text-sm font-medium rounded-md border border-indigo-200 text-indigo-700 bg-indigo-50 hover:bg-indigo-100">
                <i class="fas fa-exchange-alt mr-2"></i> Realizar cambio
            </button>
        </div>
    </div>

    <div id="modal-exit-cambio" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative h-full w-full flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border-2 border-gray-300 overflow-hidden">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div class="w-full text-center">
                        <h3 class="text-base font-semibold text-gray-900">Salir de Realizar un cambio</h3>
                        <p class="text-xs text-gray-500">Si sal√≠s ahora, vas a volver al m√≥dulo Ventas.</p>
                    </div>
                    <button id="btn-close-exit-cambio" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5">
                    <div class="text-sm text-gray-700 text-center">¬øConfirm√°s salir de la secci√≥n <span class="font-semibold">Realizar un cambio</span>?</div>
                </div>
                <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                    <button id="btn-cancel-exit-cambio" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                    <button id="btn-confirm-exit-cambio" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-exit-venta" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative h-full w-full flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border-2 border-gray-300 overflow-hidden">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div class="w-full text-center">
                        <h3 class="text-base font-semibold text-gray-900">Salir de Nueva venta</h3>
                        <p class="text-xs text-gray-500">Si sal√≠s ahora, vas a volver al m√≥dulo Ventas.</p>
                    </div>
                    <button id="btn-close-exit-venta" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5">
                    <div class="text-sm text-gray-700 text-center">¬øConfirm√°s salir de la secci√≥n <span class="font-semibold">Nueva venta</span>?</div>
                </div>
                <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                    <button id="btn-cancel-exit-venta" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                    <button id="btn-confirm-exit-venta" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-delete-ticket" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40" data-close="1"></div>
        <div class="relative h-full w-full flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white rounded-2xl shadow-xl border-2 border-gray-300 overflow-hidden">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div class="w-full text-center">
                        <h3 class="text-base font-semibold text-gray-900">Eliminar ticket</h3>
                        <p class="text-xs text-gray-500">Esta acci√≥n es irreversible. Se eliminar√°n la venta y todos sus registros asociados (movimientos, cuenta corriente/cuotas) y se revertir√° el stock.</p>
                    </div>
                    <button id="btn-close-delete-ticket" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5">
                    <div class="text-sm text-gray-700 text-center">¬øConfirm√°s eliminar el ticket <span id="delete-ticket-label" class="font-semibold"></span>?</div>
                </div>
                <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                    <button id="btn-cancel-delete-ticket" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                    <button id="btn-confirm-delete-ticket" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white bg-red-600 hover:bg-red-700 rounded-md">Eliminar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Indicadores r√°pidos -->
    <div id="kpi-section-sales" class="grid grid-cols-1 md:grid-cols-4 gap-2 items-stretch">
        <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col items-center justify-center text-center">
            <div class="h-10 w-10 mb-2 flex items-center justify-center rounded-full bg-indigo-50 text-indigo-700">
                <i class="fas fa-cash-register"></i>
            </div>
            <div>
                <p id="kpi-label-ventas" class="text-xs uppercase tracking-wide text-gray-500">Ventas del d√≠a</p>
                <p id="kpi-ventas-dia" class="text-lg font-semibold text-gray-900">$0,00</p>
            </div>
        </div>
        <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col items-center justify-center text-center">
            <div class="h-10 w-10 mb-2 flex items-center justify-center rounded-full bg-blue-50 text-blue-700">
                <i class="fas fa-receipt"></i>
            </div>
            <div>
                <p id="kpi-label-tickets" class="text-xs uppercase tracking-wide text-gray-500">Cantidad de ventas</p>
                <p id="kpi-tickets-dia" class="text-lg font-semibold text-gray-900">0</p>
            </div>
        </div>
        <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col items-center justify-center text-center">
            <div class="h-10 w-10 mb-2 flex items-center justify-center rounded-full bg-green-50 text-green-700">
                <i class="fas fa-box-open"></i>
            </div>
            <div>
                <p id="kpi-label-items" class="text-xs uppercase tracking-wide text-gray-500">Cantidad de art√≠culos vendidos</p>
                <p id="kpi-items-dia" class="text-lg font-semibold text-gray-900">0</p>
            </div>
        </div>

        <div class="p-3 rounded-xl bg-white shadow border border-gray-100 flex flex-col items-center justify-center text-center">
            <div class="h-10 w-10 mb-2 flex items-center justify-center rounded-full bg-emerald-50 text-emerald-700">
                <i class="fas fa-ticket-alt"></i>
            </div>
            <div>
                <p id="kpi-label-promedio" class="text-xs uppercase tracking-wide text-gray-500">Ticket promedio</p>
                <p id="kpi-ticket-promedio" class="text-lg font-semibold text-gray-900">$0,00</p>
            </div>
        </div>
    </div>

    <div id="modal-arqueo" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative h-full w-full flex items-center justify-center p-4 md:p-6">
            <div class="w-full bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden" style="max-width:820px;max-height:85vh">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div>
                        <h2 class="text-lg font-semibold text-gray-900">Arqueo de caja</h2>
                        <p class="text-xs text-gray-500">Se guarda por d√≠a y queda visible en Movimientos.</p>
                    </div>
                    <button id="btn-close-arqueo" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5 overflow-y-auto" style="max-height:calc(85vh - 132px)">
                    <div id="panel-arqueo" class="space-y-3">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block font-medium text-gray-600 mb-1 text-xs">Fecha de arqueo</label>
                                <input id="fecha-arqueo" type="date" class="w-full px-3 py-2 border rounded-md text-sm" value="{{ now.strftime('%Y-%m-%d') }}">
                            </div>
                            <div>
                                <label class="block font-medium text-gray-600 mb-1 text-xs">Empleado responsable del arqueo</label>
                                <select id="arqueo-employee" class="w-full px-3 py-2 border rounded-md text-sm bg-white">
                                    <option value="">‚Äî Seleccionar ‚Äî</option>
                                </select>
                                <p id="msg-arqueo-no-employees" class="mt-1 text-[11px] text-gray-500 hidden">No hay empleados cargados. <a href="{{ url_for('employees.new') }}" class="text-indigo-700 hover:underline">Crear empleado</a></p>
                                <p id="msg-arqueo-employee-required" class="mt-1 text-[11px] text-red-600 hidden flex items-center gap-1"><i class="fas fa-exclamation-circle"></i><span>Seleccion√° un empleado responsable para guardar el arqueo.</span></p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <div>
                                <label class="block font-medium text-gray-600 mb-1 text-xs">Apertura</label>
                                <input id="monto-apertura" type="text" inputmode="decimal" class="w-full px-3 py-2 border rounded-md text-sm" placeholder="$0" data-currency="ars">
                            </div>
                            <div>
                                <label class="block font-medium text-gray-600 mb-1 text-xs">Efectivo del d√≠a (calculado)</label>
                                <input id="monto-efectivo-dia" type="text" inputmode="decimal" class="w-full px-3 py-2 border rounded-md text-sm bg-gray-50" placeholder="Se calcula solo" readonly data-currency="ars">
                                <div class="mt-1 text-xs text-gray-500 whitespace-nowrap">Ventas en efectivo ‚Äì Egresos en efectivo</div>
                            </div>
                            <div>
                                <label class="block font-medium text-gray-600 mb-1 text-xs">Cierre</label>
                                <input id="monto-cierre" type="text" inputmode="decimal" class="w-full px-3 py-2 border rounded-md text-sm" placeholder="$0" data-currency="ars">
                            </div>
                        </div>

                        <div class="rounded-lg border border-gray-200 bg-gray-50 p-3">
                            <p id="msg-arqueo-ok" class="text-[11px] text-green-700 hidden flex items-center gap-1">
                                <i class="fas fa-check-circle"></i><span>Arqueo correcto.</span>
                            </p>
                            <p id="msg-arqueo-error" class="text-[11px] text-red-700 hidden flex items-center gap-1">
                                <i class="fas fa-exclamation-circle"></i><span>Cierre de caja err√≥neo.</span>
                            </p>
                            <p id="msg-arqueo-detalle" class="text-[11px] text-gray-700 hidden"></p>
                            <p id="msg-arqueo-guardado" class="mt-2 text-[11px] text-indigo-700 hidden flex items-center gap-1">
                                <i class="fas fa-save"></i><span>Arqueo guardado.</span>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="px-5 py-4 border-t border-gray-100 flex items-center justify-end gap-2 bg-white">
                    <button id="btn-cancel-arqueo" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cerrar</button>
                    <button id="btn-guardar-arqueo" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">Guardar arqueo</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Historial combinado -->
    <div id="historial-ventas" class="bg-white rounded-xl shadow overflow-visible">
        <div class="px-4 py-3 border-b border-gray-100 flex flex-col gap-2 md:flex-row md:items-center md:justify-between">
            <div>
                <h2 class="text-sm font-semibold text-gray-900">Historial de movimientos</h2>
                <p class="text-xs text-gray-500">Ventas y cambios recientes.</p>
            </div>
            <div class="flex flex-wrap gap-2 text-[11px]">
                <button id="btn-toggle-arqueo" type="button" class="px-3 py-1 rounded-md border border-emerald-300 bg-emerald-100 text-emerald-900 hover:bg-emerald-200 inline-flex items-center gap-2">
                    <i class="fas fa-cash-register text-[10px] text-emerald-800"></i>
                    <span class="font-medium">Arqueo de Caja</span>
                    <span id="arqueo-status-badge" class="text-[11px] px-2 py-0.5 rounded-full border bg-yellow-50 text-yellow-800 border-yellow-100">Pendiente</span>
                    <i class="fas fa-arrow-right text-[10px] text-emerald-800/70"></i>
                </button>
                <button id="btn-export-ventas" type="button" class="px-3 py-1 rounded-md border border-indigo-200 bg-indigo-50 text-indigo-700 hover:bg-indigo-100 inline-flex items-center gap-2">
                    <span>Exportar</span>
                    <i class="fas fa-file-export text-[10px]"></i>
                </button>
                <button id="btn-clear-ventas" type="button" class="px-3 py-1 rounded-md border border-gray-200 bg-gray-50 hover:bg-gray-100 text-gray-700">Regalos</button>
            </div>
        </div>
        <table class="min-w-full divide-y divide-gray-200 text-xs">
            <thead class="bg-gray-50">
                <tr class="text-xs">
                    <th id="ventas-col-ticket-label" class="px-3 py-2 text-left text-gray-600 font-semibold align-bottom">Ticket</th>
                    <th class="px-3 py-2 text-left text-gray-600 font-semibold align-bottom">Fecha <i class="fas fa-chevron-down ml-1 text-gray-400"></i></th>
                    <th class="px-3 py-2 text-left text-gray-600 font-semibold align-bottom">Cliente</th>
                    <th class="px-3 py-2 text-left text-gray-600 font-semibold align-bottom">Empleado responsable</th>
                    <th class="px-3 py-2 text-right text-gray-600 font-semibold align-bottom">Total</th>
                    <th class="px-3 py-2 text-center text-gray-600 font-semibold align-bottom">Pago <i class="fas fa-chevron-down ml-1 text-gray-400"></i></th>
                    <th class="px-3 py-2 text-center text-gray-600 font-semibold align-bottom">Tipo <i class="fas fa-chevron-down ml-1 text-gray-400"></i></th>
                    <th class="px-3 py-2 text-center text-gray-600 font-semibold align-bottom"></th>
                </tr>
                <tr class="text-[11px] bg-white align-middle">
                    <th class="px-3 py-1">
                        <input id="ventas-search-ticket" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600" placeholder="Buscar por ticket">
                    </th>
                    <th class="px-3 py-1 text-left text-gray-400">
                        <div class="inline-block min-w-[110px] max-w-[140px] w-full">
                            <input type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 fecha-rango-input" placeholder="dd/mm/aaaa - dd/mm/aaaa">
                        </div>
                    </th>
                    <th class="px-3 py-1">
                        <input id="ventas-search-cliente" type="text" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600" placeholder="Buscar por cliente">
                    </th>
                    <th class="px-3 py-1">
                        <select id="ventas-filter-employee" class="hidden w-full px-2 py-0.5 border rounded-md text-xs text-gray-600">
                            <option value="">Todos</option>
                        </select>
                        <div class="relative">
                            <button id="ventas-filter-employee-btn" type="button" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white text-left inline-flex items-center justify-between">
                                <span id="ventas-filter-employee-label">Todos</span>
                                <i class="fas fa-chevron-down text-[10px] text-gray-400"></i>
                            </button>
                            <div id="ventas-filter-employee-menu" class="hidden absolute left-0 mt-1 w-64 rounded-md border border-gray-200 bg-white shadow-lg z-50">
                                <div id="ventas-filter-employee-items" class="max-h-56 overflow-auto py-1"></div>
                            </div>
                        </div>
                    </th>
                    <th class="px-3 py-1"></th>
                    <th class="px-3 py-1 text-center text-gray-400">
                        <select id="ventas-filter-pago" class="hidden w-full px-2 py-0.5 border rounded-md text-xs text-gray-600">
                            <option value="">Todas</option>
                            <option>Efectivo</option>
                            <option>Transferencia</option>
                            <option>D√©bito</option>
                            <option>Cr√©dito</option>
                        </select>
                        <div class="relative">
                            <button id="ventas-filter-pago-btn" type="button" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white text-left inline-flex items-center justify-between">
                                <span id="ventas-filter-pago-label">Todas</span>
                                <i class="fas fa-chevron-down text-[10px] text-gray-400"></i>
                            </button>
                            <div id="ventas-filter-pago-menu" class="hidden absolute left-0 mt-1 w-56 rounded-md border border-gray-200 bg-white shadow-lg z-50">
                                <div id="ventas-filter-pago-items" class="max-h-56 overflow-auto py-1"></div>
                            </div>
                        </div>
                    </th>
                    <th class="px-3 py-1 text-center text-gray-400">
                        <select id="ventas-filter-tipo" class="hidden w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white">
                            <option value="">Todas</option>
                            <option>Venta completa</option>
                            <option>Venta CC</option>
                            <option>Venta SC</option>
                            <option>Cambio</option>
                        </select>
                        <div class="relative">
                            <button id="ventas-filter-tipo-btn" type="button" class="w-full px-2 py-0.5 border rounded-md text-xs text-gray-600 bg-white text-left inline-flex items-center justify-between">
                                <span id="ventas-filter-tipo-label">Todas</span>
                                <i class="fas fa-chevron-down text-[10px] text-gray-400"></i>
                            </button>
                            <div id="ventas-filter-tipo-menu" class="hidden absolute left-0 mt-1 w-56 rounded-md border border-gray-200 bg-white shadow-lg z-50">
                                <div id="ventas-filter-tipo-items" class="max-h-56 overflow-auto py-1"></div>
                            </div>
                        </div>
                    </th>
                    <th class="px-3 py-1"></th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-100">
                <tr>
                    <td colspan="8" class="px-4 py-6 text-center text-sm text-gray-500">Cargando movimientos‚Ä¶</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div id="modal-export-ventas" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/40"></div>
        <div class="relative h-full w-full flex items-center justify-center p-4">
            <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
                <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                    <div>
                        <h3 class="text-base font-semibold text-gray-900">Exportar historial</h3>
                        <p class="text-xs text-gray-500">Se exporta exactamente la tabla visible (con filtros aplicados).</p>
                    </div>
                    <button id="btn-close-export-ventas" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <button id="btn-export-ventas-pdf" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                        <div class="text-2xl">üìÑ</div>
                        <div class="mt-2 font-semibold text-gray-900">Exportar a PDF</div>
                        <div class="text-xs text-gray-500">Ideal para imprimir o enviar.</div>
                    </button>
                    <button id="btn-export-ventas-xls" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                        <div class="text-2xl">üìä</div>
                        <div class="mt-2 font-semibold text-gray-900">Exportar a Excel</div>
                        <div class="text-xs text-gray-500">Descarga un CSV compatible.</div>
                    </button>
                </div>
                <div class="px-5 py-4 border-t border-gray-100 flex justify-end">
                    <button id="btn-cancel-export-ventas" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

<div id="modal-cuenta-corriente" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Cuenta corriente</h3>
                    <p class="text-xs text-gray-500">Indic√° cu√°nto abona ahora y se registrar√° el saldo pendiente en el legajo del cliente.</p>
                </div>
                <button id="btn-close-cc" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 space-y-3">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="p-3 border border-gray-200 rounded-lg">
                        <div class="text-[11px] text-gray-500">Cliente</div>
                        <div id="cc-cliente" class="mt-1 text-sm font-semibold text-gray-900 truncate">‚Äî</div>
                        <div id="cc-cliente-alertas" class="mt-2 text-[11px] text-gray-600">‚Äî</div>
                    </div>
                    <div class="p-3 border border-gray-200 rounded-lg">
                        <div class="flex items-center justify-between gap-2">
                            <div class="text-[11px] text-gray-500">Total del ticket</div>
                            <div id="cc-total" class="text-sm font-semibold text-gray-900">$0</div>
                        </div>
                        <div class="mt-3 flex items-center justify-between gap-2">
                            <label class="text-[11px] text-gray-600">Abona ahora</label>
                            <input id="cc-paid" type="text" inputmode="decimal" class="w-32 px-2 py-1 border rounded-md text-right text-sm" value="$0" data-currency="ars">
                        </div>
                        <div class="mt-2 flex items-center justify-between gap-2">
                            <span class="text-[11px] text-gray-600">Saldo a deber</span>
                            <span id="cc-due" class="px-2 py-0.5 rounded-full bg-red-50 text-red-700 border border-red-100 text-[11px] font-semibold">$0</span>
                        </div>
                    </div>
                </div>
                <div id="cc-error" class="text-[11px] text-red-600 hidden flex items-center gap-1"><i class="fas fa-exclamation-circle"></i><span>Revis√° el monto abonado.</span></div>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                <button id="btn-cancel-cc" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="btn-accept-cc" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">Aceptar</button>
            </div>
        </div>
    </div>
</div>

<!-- Vista: realizar cambio -->
<div id="vista-realizar-cambio" class="hidden space-y-4">
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
            <button id="btn-volver-desde-cambio" class="h-8 w-8 flex items-center justify-center rounded-full bg-white shadow text-gray-600 hover:text-gray-900">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div>
                <h2 class="text-lg font-semibold text-gray-900">Realizar cambio</h2>
                <p class="text-xs text-gray-500">Registr√° un cambio usando stock real (devoluci√≥n + nueva venta) y se reflejar√° en el historial.</p>
            </div>
        </div>
    </div>
    <div class="bg-white rounded-xl shadow p-4 space-y-4 text-sm">
        <!-- Indicador de pasos internos del flujo de cambio -->
        <div class="flex items-center justify-between mb-2">
            <div class="flex gap-1.5 flex-wrap text-[10px]">
                <span id="pill-cambio-paso1" class="px-2.5 py-0.5 rounded-full bg-indigo-600 text-white font-medium">1. Seleccionar {{ label_products|lower }} del cambio</span>
                <span id="pill-cambio-paso2" class="px-2.5 py-0.5 rounded-full bg-indigo-50 text-indigo-700">2. Nueva venta con saldo a favor</span>
                <span id="pill-cambio-paso3" class="px-2.5 py-0.5 rounded-full bg-indigo-50 text-indigo-700">3. Ticket y registro</span>
            </div>
        </div>

        <!-- Paso 1: selecci√≥n de productos del cambio -->
        <div id="cambio-paso1" class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- Cat√°logo para cambio -->
            <div class="md:col-span-2 p-4 bg-white rounded-lg shadow flex flex-col h-full">
                <div class="mb-3 flex items-center justify-between gap-2">
                    <div class="flex items-center gap-1 text-xs whitespace-nowrap">
                        <button id="btn-view-list-cambio" type="button" class="px-2.5 py-1 rounded-md border border-gray-200 bg-white text-gray-700 hover:bg-gray-100">Lista</button>
                        <button id="btn-view-grid-cambio" type="button" class="px-2.5 py-1 rounded-md border border-gray-200 bg-gray-50 text-gray-700 hover:bg-gray-100">Cat√°logo</button>
                    </div>
                    <div id="pills-categorias-cambio" class="flex flex-wrap gap-2 text-xs"></div>
                </div>
                <div class="mb-3">
                    <div class="relative">
                        <input id="cambio-search-products" type="text" placeholder="Buscar {{ label_products|lower }} para el cambio..." class="w-full pl-9 pr-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>
                <div id="grid-productos-cambio" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 overflow-y-auto" style="max-height: 380px;">
                    <div class="col-span-full px-3 py-4 text-sm text-gray-500">Cargando {{ label_products|lower }} del inventario...</div>
                </div>

                <div id="tabla-productos-cambio-wrap" class="hidden overflow-y-auto" style="max-height: 380px;">
                    <table class="w-full text-xs">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-2 py-2 text-left text-gray-500 font-medium">Producto</th>
                                <th class="px-2 py-2 text-left text-gray-500 font-medium">Categor√≠a</th>
                                <th class="px-2 py-2 text-right text-gray-500 font-medium">Precio</th>
                                <th class="px-2 py-2 text-right text-gray-500 font-medium">Stock</th>
                                <th class="px-2 py-2 text-center text-gray-500 font-medium">Info</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-productos-cambio-body" class="divide-y divide-gray-100">
                            <tr>
                                <td colspan="5" class="px-3 py-4 text-sm text-gray-500">Cargando {{ label_products|lower }} del inventario...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Carrito de cambio -->
            <div class="p-4 bg-white rounded-lg shadow flex flex-col h-full text-xs">
                <div class="flex items-center justify-between mb-2">
                    <h2 class="text-sm font-medium text-gray-800">Carrito de cambio</h2>
                    <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-red-50 text-red-700 border border-red-200 text-[10px] font-semibold uppercase tracking-wide">Cambio</span>
                </div>
                <div class="flex-1 overflow-y-auto overflow-x-hidden border border-gray-100 rounded-md mb-3 text-xs">
                    <table id="tabla-carrito-cambio" class="w-full text-xs">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-1 text-left text-gray-500">Nombre</th>
                                <th class="px-2 py-1 text-right text-gray-500">Precio</th>
                                <th class="px-2 py-1 text-right text-gray-500">Unid.</th>
                                <th class="px-2 py-1 text-right text-gray-500">Desc %</th>
                                <th class="px-2 py-1 text-right text-gray-500">Subt.</th>
                                <th class="px-1 py-1 text-center text-gray-500"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="carrito-cambio-empty-row">
                                <td colspan="6" class="px-2 py-3 text-center text-gray-400 text-[11px]">Agreg√° aqu√≠ los {{ label_products|lower }} involucrados en el cambio. M√°s adelante se conectar√° con el stock real.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="space-y-1 text-xs">
                    <div class="flex justify-between font-semibold"><span>Total del cambio</span><span id="total-cambio">$0,00</span></div>
                </div>
                <button id="btn-confirmar-cambio" class="mt-3 inline-flex items-center justify-center w-full px-3 py-2 text-xs font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                    Confirmar {{ label_products|lower }} del cambio
                </button>
            </div>
        </div>

        <!-- Paso 2: nueva venta con saldo a favor -->
        <div id="cambio-paso2" class="grid grid-cols-1 md:grid-cols-3 gap-4 hidden">
            <!-- Cat√°logo para nueva venta -->
            <div class="md:col-span-2 p-4 bg-white rounded-lg shadow flex flex-col h-full">
                <div class="mb-3 flex items-center justify-between gap-2">
                    <div class="flex items-center gap-1 text-xs whitespace-nowrap">
                        <button id="btn-view-list-cambio-venta" type="button" class="px-2.5 py-1 rounded-md border border-gray-200 bg-white text-gray-700 hover:bg-gray-100">Lista</button>
                        <button id="btn-view-grid-cambio-venta" type="button" class="px-2.5 py-1 rounded-md border border-gray-200 bg-gray-50 text-gray-700 hover:bg-gray-100">Cat√°logo</button>
                    </div>
                    <div id="pills-categorias-cambio-venta" class="flex flex-wrap gap-2 text-xs"></div>
                </div>
                <div class="mb-3">
                    <div class="relative">
                        <input id="cambio-venta-search-products" type="text" placeholder="Buscar {{ label_products|lower }} para la nueva venta..." class="w-full pl-9 pr-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                            <i class="fas fa-search"></i>
                        </span>
                    </div>
                </div>
                <div id="grid-productos-cambio-venta" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 overflow-y-auto" style="max-height: 380px;">
                    <div class="col-span-full px-3 py-4 text-sm text-gray-500">Cargando {{ label_products|lower }} del inventario...</div>
                </div>

                <div id="tabla-productos-cambio-venta-wrap" class="hidden overflow-y-auto" style="max-height: 380px;">
                    <table class="w-full text-xs">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-2 py-2 text-left text-gray-500 font-medium">Producto</th>
                                <th class="px-2 py-2 text-left text-gray-500 font-medium">Categor√≠a</th>
                                <th class="px-2 py-2 text-right text-gray-500 font-medium">Precio</th>
                                <th class="px-2 py-2 text-right text-gray-500 font-medium">Stock</th>
                                <th class="px-2 py-2 text-center text-gray-500 font-medium">Info</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-productos-cambio-venta-body" class="divide-y divide-gray-100">
                            <tr>
                                <td colspan="5" class="px-3 py-4 text-sm text-gray-500">Cargando {{ label_products|lower }} del inventario...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Carrito de nueva venta con saldo a favor -->
            <div class="p-4 bg-white rounded-lg shadow flex flex-col h-full text-xs">
                <div class="flex items-center justify-center mb-2">
                    <h2 class="text-sm font-medium text-gray-800">Nueva venta (con saldo a favor)</h2>
                </div>
                <div class="flex-1 overflow-y-auto overflow-x-hidden border border-gray-100 rounded-md mb-3 text-xs">
                    <table id="tabla-carrito-cambio-venta" class="w-full text-xs">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-1 text-left text-gray-500">Nombre</th>
                                <th class="px-2 py-1 text-right text-gray-500">Precio</th>
                                <th class="px-2 py-1 text-right text-gray-500">Unid.</th>
                                <th class="px-2 py-1 text-right text-gray-500">Desc %</th>
                                <th class="px-2 py-1 text-right text-gray-500">Subt.</th>
                                <th class="px-1 py-1 text-center text-gray-500"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr id="carrito-cambio-venta-empty-row">
                                <td colspan="6" class="px-2 py-3 text-center text-gray-400 text-[11px]">Arm√° aqu√≠ la nueva compra usando el saldo a favor del cambio.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="space-y-1 text-xs">
                    <div class="flex justify-between"><span>Saldo a favor por cambio</span><span id="saldo-a-favor" class="font-semibold text-indigo-700">$0,00</span></div>
                    <div class="flex justify-between"><span>Total nueva compra</span><span id="total-cambio-venta" class="font-semibold text-gray-900">$0,00</span></div>
                    <div class="flex justify-between"><span>Diferencia a abonar</span><span id="diferencia-a-abonar" class="font-semibold text-gray-900">$0,00</span></div>
                </div>
                <button id="btn-confirmar-cambio-venta" class="mt-3 inline-flex items-center justify-center w-full px-3 py-2 text-xs font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                    Confirmar nueva venta
                </button>
            </div>
        </div>

        <!-- Paso 3: ticket, cliente y registro -->
        <div id="cambio-paso3" class="space-y-4 hidden">
            <div class="flex items-center gap-3 mb-1">
                <div>
                    <h3 class="text-sm font-semibold text-gray-900">Paso 3 ¬∑ Detalles del ticket y cliente</h3>
                    <p class="text-xs text-gray-500">Revis√° la forma de pago, asoci√° un cliente y dej√° notas internas.</p>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
                <div class="p-4 bg-white rounded-lg border border-gray-100 space-y-3 lg:col-span-2">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1"># Ticket</label>
                                <input id="cambio-ticket" type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-gray-50" value="#C0001" disabled>
                            </div>
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Fecha del ticket</label>
                                <input id="cambio-fecha" type="date" class="w-full px-3 py-2 text-sm border rounded-md" value="{{ now.strftime('%Y-%m-%d') }}">
                            </div>
                        </div>

                        <div class="h-full flex flex-col">
                            <label class="block text-xs font-medium text-gray-600 mb-1">Forma de pago</label>
                            <div class="grid grid-cols-2 grid-rows-2 gap-2 text-xs h-full items-stretch">
                                <label class="flex items-center justify-center text-center gap-2 px-2 py-3 rounded-md border border-gray-200 bg-gray-50 cursor-pointer w-full h-full">
                                    <input type="radio" name="cambio_forma_pago" class="text-indigo-600" checked>
                                    <span><i class="fas fa-money-bill-wave mr-1 text-green-500"></i>Efectivo</span>
                                </label>
                                <label class="flex items-center justify-center text-center gap-2 px-2 py-3 rounded-md border border-gray-200 bg-gray-50 cursor-pointer w-full h-full">
                                    <input type="radio" name="cambio_forma_pago" class="text-indigo-600">
                                    <span><i class="fas fa-exchange-alt mr-1 text-blue-500"></i>Transferencia</span>
                                </label>
                                <label class="flex items-center justify-center text-center gap-2 px-2 py-3 rounded-md border border-gray-200 bg-gray-50 cursor-pointer w-full h-full">
                                    <input type="radio" name="cambio_forma_pago" class="text-indigo-600">
                                    <span><i class="fas fa-credit-card mr-1 text-purple-500"></i>D√©bito</span>
                                </label>
                                <label class="flex items-center justify-center text-center gap-2 px-2 py-3 rounded-md border border-gray-200 bg-gray-50 cursor-pointer w-full h-full">
                                    <input type="radio" name="cambio_forma_pago" class="text-indigo-600">
                                    <span><i class="fas fa-credit-card mr-1 text-indigo-500"></i>Cr√©dito</span>
                                </label>
                            </div>
                        </div>

                        <div class="space-y-3">
                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Notas del ticket</label>
                                <textarea id="cambio-notas" rows="5" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Observaciones internas, aclaraciones de la operaci√≥n, etc."></textarea>
                            </div>

                            <div>
                                <label class="block text-xs font-medium text-gray-600 mb-1">Empleado responsable</label>
                                <select id="cambio-employee" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                                    <option value="">‚Äî Seleccionar ‚Äî</option>
                                </select>
                                <p id="msg-cambio-no-employees" class="mt-1 text-[11px] text-gray-500 hidden">No hay empleados cargados. <a href="{{ url_for('employees.new') }}" class="text-indigo-700 hover:underline">Crear empleado</a></p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex flex-col gap-2">
                    <div class="p-4 bg-white rounded-lg border border-gray-100 space-y-3 lg:sticky lg:top-24 h-full">
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-800">Carrito</span>
                            <span id="cambio-ticket-cart-total" class="text-xs font-semibold text-gray-900">$0</span>
                        </div>
                        <div class="border border-gray-100 rounded-md overflow-hidden">
                            <table class="w-full text-xs">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-2 py-1 text-left text-gray-500">Producto</th>
                                        <th class="px-2 py-1 text-right text-gray-500">Unid.</th>
                                        <th class="px-2 py-1 text-right text-gray-500">Precio</th>
                                        <th class="px-2 py-1 text-right text-gray-500">Subt.</th>
                                    </tr>
                                </thead>
                                <tbody id="cambio-ticket-cart-items">
                                    <tr>
                                        <td colspan="4" class="px-2 py-3 text-center text-gray-400 text-[11px]">Sin √≠tems.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mb-3">
                <div class="p-4 bg-white rounded-lg border border-gray-100 space-y-3 lg:col-span-2">
                    <div class="flex items-center justify-between gap-2">
                        <div>
                            <span class="text-sm font-medium text-gray-800">Cliente (opcional)</span>
                            <div class="text-[11px] text-gray-500">En el caso de ser un regalo, debe registrar cliente</div>
                        </div>
                        <div class="flex items-center gap-3">
                            <label class="inline-flex items-center gap-2 text-xs text-gray-700 px-2 py-1 rounded-md border border-gray-200 bg-gray-50 hover:bg-gray-100 cursor-pointer select-none">
                                <input id="cambio-is-gift" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600">
                                <span>Es un regalo</span>
                            </label>
                            <div id="cambio-gift-code-wrap" class="hidden px-3 py-1.5 rounded-md border border-indigo-200 bg-indigo-50 text-indigo-900 flex items-center gap-2">
                                <span class="text-[11px] text-indigo-700">C√≥digo</span>
                                <span id="cambio-gift-code" class="font-mono text-sm font-semibold tracking-wide">‚Äî</span>
                            </div>
                        </div>
                        <button id="btn-select-cliente-cambio" type="button" class="hidden px-3 py-1.5 text-xs font-medium rounded-md border border-gray-200 bg-gray-50 hover:bg-gray-100 text-gray-700">Seleccionar cliente</button>
                    </div>
                    <div id="panel-cliente-cambio" class="mt-2 space-y-3">
                        <div class="relative">
                            <input id="cambio-cliente" type="text" placeholder="Buscador de cliente" class="w-full pl-9 pr-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                                <i class="fas fa-search"></i>
                            </span>
                            <div id="cambio-cliente-dd" class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg overflow-hidden"></div>
                        </div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                            <button id="btn-crear-cliente-cambio" type="button" class="w-full inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-blue-700 bg-blue-50 rounded-md hover:bg-blue-100">
                                <i class="fas fa-user-plus mr-2"></i> Crear nuevo cliente
                            </button>
                            <button id="btn-select-cliente-cambio-bottom" type="button" class="w-full inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-gray-700 bg-gray-50 rounded-md border border-gray-200 hover:bg-gray-100">
                                Seleccionar cliente
                            </button>
                        </div>
                        <div id="panel-pago-cliente-cambio" class="pt-2 border-t border-gray-100 space-y-2 text-xs text-gray-600 hidden">
                            <div class="flex items-center justify-between">
                                <span>Pago</span>
                            </div>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <button id="btn-pago-completo-cambio" type="button" class="w-full px-3 py-2 rounded-md text-sm font-medium bg-green-50 text-green-700 border border-green-100 hover:bg-green-100">üíµ Pago completo</button>
                                <button id="btn-cuenta-corriente-cambio" type="button" class="w-full px-3 py-2 rounded-md text-sm font-medium bg-yellow-50 text-yellow-700 border border-yellow-100 hover:bg-yellow-100">üßæ Cuenta corriente</button>
                            </div>
                            <p class="text-[11px] text-gray-500">Se registrar√° saldo pendiente en el legajo del cliente.</p>
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-white rounded-lg border border-gray-100 flex flex-col justify-between text-sm lg:sticky lg:top-24 h-full">
                    <div class="space-y-1 text-xs">
                        <div class="flex justify-between"><span>Saldo a favor</span><span id="resumen-saldo-a-favor" class="font-semibold text-indigo-700">$0,00</span></div>
                        <div class="flex justify-between"><span>Total nueva compra</span><span id="resumen-total-cambio-venta" class="font-semibold text-gray-900">$0,00</span></div>
                        <div class="flex justify-between"><span>Diferencia a abonar</span><span id="resumen-diferencia-a-abonar" class="font-semibold text-gray-900">$0,00</span></div>
                    </div>
                    <button id="btn-confirmar-cambio-final" class="w-full mt-3 inline-flex items-center justify-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                        Confirmar ticket y registrar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Flujo de venta: selecci√≥n de productos + ticket -->
<div id="ventas-flujo" class="space-y-4 hidden">
    <!-- Header con flecha de vuelta y pasos -->

    <div id="paso-productos-header" class="flex items-center gap-3 mb-1">
        <button id="btn-volver-home" class="h-8 w-8 flex items-center justify-center rounded-full bg-white shadow text-gray-600 hover:text-gray-900">
            <i class="fas fa-arrow-left"></i>
        </button>
        <div>
            <h3 class="text-sm font-semibold text-gray-900">Paso 1: Registrar Venta</h3>
            <p class="text-xs text-gray-500">Primero eleg√≠ los {{ label_products|lower }} y arm√° tu carrito.</p>
        </div>
    </div>

    <!-- Paso productos -->
    <div id="paso-productos" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <!-- Listado de productos -->
        <div class="md:col-span-2 p-4 bg-white rounded-lg shadow flex flex-col h-full">
            <!-- Categor√≠as como pills -->
            <div class="mb-3 flex items-center justify-between gap-2">
                <div class="flex items-center gap-1 text-xs whitespace-nowrap">
                    <button id="btn-view-list" type="button" class="px-2.5 py-1 rounded-md border border-gray-200 bg-white text-gray-700 hover:bg-gray-100">Lista</button>
                    <button id="btn-view-grid" type="button" class="px-2.5 py-1 rounded-md border border-gray-200 bg-gray-50 text-gray-700 hover:bg-gray-100">Cat√°logo</button>
                </div>
                <div id="pills-categorias-venta" class="flex flex-wrap gap-2 text-xs"></div>
            </div>

            <!-- Buscador -->
            <div class="mb-3">
                <div class="relative">
                    <input type="text" placeholder="Buscar {{ label_products|lower }}..." class="w-full pl-9 pr-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                        <i class="fas fa-search"></i>
                    </span>
                </div>
            </div>

            <div class="mb-3 rounded-md border border-gray-200 bg-white p-3 text-xs">
                <div id="venta-libre-header" class="flex items-center justify-between cursor-pointer select-none">
                    <span class="font-medium text-gray-800">Venta libre</span>
                    <label class="inline-flex items-center text-xs text-gray-600">
                        <input id="toggle-venta-libre" type="checkbox" class="rounded border-gray-300 text-indigo-600 shadow-sm mr-2">
                        Agregar producto fuera de stock
                    </label>
                </div>
                <div id="panel-venta-libre" class="mt-3 grid grid-cols-1 md:grid-cols-3 gap-2 hidden">
                    <div class="md:col-span-2">
                        <input id="venta-libre-nombre" type="text" class="w-full px-2 py-1 border rounded-md text-xs" placeholder="Nombre del producto (venta libre)">
                    </div>
                    <div>
                        <input id="venta-libre-precio" type="number" min="0" step="0.01" class="w-full px-2 py-1 border rounded-md text-xs" placeholder="Precio">
                    </div>
                    <div class="md:col-span-3">
                        <button id="btn-agregar-venta-libre" type="button" class="inline-flex items-center justify-center w-full px-3 py-2 text-[11px] font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                            Agregar venta libre
                        </button>
                    </div>
                </div>
            </div>

            <div id="grid-productos" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-3 overflow-y-auto" style="max-height: 380px;">
                <div class="col-span-full px-3 py-4 text-sm text-gray-500">Cargando {{ label_products|lower }} del inventario...</div>
            </div>

            <div id="tabla-productos-wrap" class="hidden overflow-y-auto" style="max-height: 380px;">
                <table class="w-full text-xs">
                    <thead class="bg-gray-50 sticky top-0">
                        <tr>
                            <th class="px-2 py-2 text-left text-gray-500 font-medium">Producto</th>
                            <th class="px-2 py-2 text-left text-gray-500 font-medium">Categor√≠a</th>
                            <th class="px-2 py-2 text-right text-gray-500 font-medium">Precio</th>
                            <th class="px-2 py-2 text-right text-gray-500 font-medium">Stock</th>
                            <th class="px-2 py-2 text-center text-gray-500 font-medium">Info</th>
                        </tr>
                    </thead>
                    <tbody id="tabla-productos-body" class="divide-y divide-gray-100">
                        <tr>
                            <td colspan="5" class="px-3 py-4 text-sm text-gray-500">Cargando {{ label_products|lower }} del inventario...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <input id="scanner-input" type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" class="absolute -left-[9999px] -top-[9999px] opacity-0 pointer-events-none" aria-hidden="true">
        </div>

        <!-- Carrito lateral -->
        <div class="flex flex-col gap-2 h-full">
            <div id="venta-steps-slot-paso1" class="flex">
                <div id="venta-steps-pills" class="flex gap-1.5 flex-wrap text-[10px]">
                    <span id="pill-venta-paso1" class="px-2.5 py-0.5 rounded-full bg-indigo-600 text-white font-medium">1. {{ label_products }}</span>
                    <span id="pill-venta-paso2" class="px-2.5 py-0.5 rounded-full bg-indigo-50 text-indigo-700">2. Ticket y cliente</span>
                </div>
            </div>

            <div class="p-4 bg-white rounded-lg shadow flex flex-col h-full">
                <div class="flex items-center justify-center mb-2">
                    <h2 class="text-sm font-medium text-gray-800">Carrito</h2>
                </div>
                <div class="flex-1 overflow-y-auto overflow-x-hidden border border-gray-100 rounded-md mb-3 text-xs">
                    <table id="tabla-carrito" class="w-full text-xs">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-2 py-1 text-left text-gray-500">Nombre</th>
                            <th class="px-2 py-1 text-right text-gray-500">Precio</th>
                            <th class="px-2 py-1 text-right text-gray-500">Unid.</th>
                            <th class="px-2 py-1 text-right text-gray-500">Desc %</th>
                            <th class="px-2 py-1 text-right text-gray-500">Subt.</th>
                            <th class="px-1 py-1 text-center text-gray-500"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr id="carrito-empty-row">
                            <td colspan="6" class="px-2 py-3 text-center text-gray-400 text-[11px]">Aqu√≠ se listar√°n los {{ label_products|lower }} que vayas seleccionando, junto con los descuentos por √≠tem. M√°s adelante lo conectaremos con el inventario real.</td>
                        </tr>
                    </tbody>
                    </table>
                </div>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between font-semibold"><span>Total estimado</span><span id="total-estimado">$0,00</span></div>
                    <div class="flex justify-between items-center gap-2">
                        <span>Descuento general</span>
                        <div class="relative">
                            <input id="ticket-descuento-general" type="number" class="w-20 px-2 py-1 pr-5 border rounded-md text-right" placeholder="" min="0" max="100">
                            <span class="absolute inset-y-0 right-2 flex items-center text-[11px] text-gray-500 pointer-events-none">%</span>
                        </div>
                    </div>
                    <div class="flex justify-between items-center gap-2 font-semibold">
                        <span>Total</span>
                        <input id="ticket-total-final" type="text" class="w-32 px-2 py-1 border rounded-md text-right" value="$0,00">
                    </div>
                    <div id="cc-resumen-paso1" class="hidden text-[11px] text-gray-600 text-right"></div>
                    <div id="cuotas-resumen-paso1" class="hidden text-[11px] text-gray-600 text-right"></div>
                </div>
                <button id="btn-continuar-ticket" class="mt-3 inline-flex items-center justify-center w-full px-3 py-2 text-xs font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                    Continuar al Paso 2
                </button>
            </div>
        </div>
    </div>

    <!-- Paso 2: datos del ticket y cliente -->
    <div id="paso-ticket" class="space-y-3 hidden">
        <div class="flex items-center gap-3 mb-1">
            <button id="btn-volver-paso1" class="h-8 w-8 flex items-center justify-center rounded-full bg-white shadow text-gray-600 hover:text-gray-900">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div>
                <h3 class="text-sm font-semibold text-gray-900">Paso 2 ¬∑ Detalles del ticket y cliente</h3>
                <p class="text-xs text-gray-500">Revis√° la forma de pago, asoci√° un cliente y dej√° notas internas.</p>
            </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3">
            <div class="p-4 bg-white rounded-lg border border-gray-100 space-y-3 lg:col-span-2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1"># Ticket</label>
                            <input type="text" class="w-full px-3 py-2 text-sm border rounded-md bg-gray-50" value="#0001" disabled>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Fecha del ticket</label>
                            <input id="ticket-fecha" type="date" class="w-full px-3 py-2 text-sm border rounded-md" value="{{ now.strftime('%Y-%m-%d') }}">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">D√≠as de cambio</label>
                            <input id="ticket-dias-cambio" type="number" class="w-full px-3 py-2 text-sm border rounded-md" value="14" min="0" step="1">
                        </div>
                    </div>
                    <div class="h-full flex flex-col">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Forma de pago</label>
                        <div class="grid grid-cols-2 grid-rows-2 gap-2 text-xs h-full items-stretch">
                            <label class="flex items-center justify-center text-center gap-2 px-2 py-3 rounded-md border border-gray-200 bg-gray-50 cursor-pointer w-full h-full">
                                <input type="radio" name="forma_pago" value="Efectivo" class="text-indigo-600" checked>
                                <span><i class="fas fa-money-bill-wave mr-1 text-green-500"></i>Efectivo</span>
                            </label>
                            <label class="flex items-center justify-center text-center gap-2 px-2 py-3 rounded-md border border-gray-200 bg-gray-50 cursor-pointer w-full h-full">
                                <input type="radio" name="forma_pago" value="Transferencia" class="text-indigo-600">
                                <span><i class="fas fa-exchange-alt mr-1 text-blue-500"></i>Transferencia</span>
                            </label>
                            <label class="flex items-center justify-center text-center gap-2 px-2 py-3 rounded-md border border-gray-200 bg-gray-50 cursor-pointer w-full h-full">
                                <input type="radio" name="forma_pago" value="D√©bito" class="text-indigo-600">
                                <span><i class="fas fa-credit-card mr-1 text-purple-500"></i>D√©bito</span>
                            </label>
                            <label class="flex items-center justify-center text-center gap-2 px-2 py-3 rounded-md border border-gray-200 bg-gray-50 cursor-pointer w-full h-full">
                                <input type="radio" name="forma_pago" value="Cr√©dito" class="text-indigo-600">
                                <span><i class="fas fa-credit-card mr-1 text-indigo-500"></i>Cr√©dito</span>
                            </label>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Notas del ticket</label>
                            <textarea id="ticket-notas" rows="5" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="Observaciones internas, aclaraciones de la operaci√≥n, etc."></textarea>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-600 mb-1">Empleado responsable</label>
                            <select id="ticket-employee" class="w-full px-3 py-2 text-sm border rounded-md bg-white">
                                <option value="">‚Äî Seleccionar ‚Äî</option>
                            </select>
                            <p id="msg-venta-no-employees" class="mt-1 text-[11px] text-gray-500 hidden">No hay empleados cargados. <a href="{{ url_for('employees.new') }}" class="text-indigo-700 hover:underline">Crear empleado</a></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cliente y cuenta corriente -->
            <!-- Notas del ticket (movido a la columna derecha) -->
            <div class="flex flex-col gap-2">
                <div id="venta-steps-slot-paso2" class="flex"></div>
                <div class="p-4 bg-white rounded-lg border border-gray-100 space-y-3">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-800">Carrito</span>
                        <span id="ticket-cart-total" class="text-xs font-semibold text-gray-900">$0</span>
                    </div>
                    <div class="border border-gray-100 rounded-md overflow-hidden">
                        <table class="w-full text-xs">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-2 py-1 text-left text-gray-500">Producto</th>
                                <th class="px-2 py-1 text-right text-gray-500">Unid.</th>
                                <th class="px-2 py-1 text-right text-gray-500">Precio</th>
                                <th class="px-2 py-1 text-right text-gray-500">Subt.</th>
                            </tr>
                        </thead>
                        <tbody id="ticket-cart-items">
                            <tr>
                                <td colspan="4" class="px-2 py-3 text-center text-gray-400 text-[11px]">Sin √≠tems.</td>
                            </tr>
                        </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Cliente y confirmaci√≥n (movidos debajo) -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-3 mb-3">
            <div class="p-4 bg-white rounded-lg border border-gray-100 space-y-3 lg:col-span-2">
                <div class="flex items-center justify-between gap-2">
                    <div>
                        <span class="text-sm font-medium text-gray-800">Cliente (opcional)</span>
                        <div class="text-[11px] text-gray-500">En el caso de ser un regalo, debe registrar cliente</div>
                    </div>
                    <div class="flex items-center gap-3">
                        <label class="inline-flex items-center gap-2 text-xs text-gray-700 px-2 py-1 rounded-md border border-gray-200 bg-gray-50 hover:bg-gray-100 cursor-pointer select-none">
                            <input id="ticket-is-gift" type="checkbox" class="h-4 w-4 rounded border-gray-300 text-indigo-600">
                            <span>Es un regalo</span>
                        </label>
                        <div id="gift-code-wrap" class="hidden px-3 py-1.5 rounded-md border border-indigo-200 bg-indigo-50 text-indigo-900 flex items-center gap-2">
                            <span class="text-[11px] text-indigo-700">C√≥digo</span>
                            <span id="ticket-gift-code" class="font-mono text-sm font-semibold tracking-wide">‚Äî</span>
                        </div>
                    </div>
                </div>
                <div id="panel-cliente" class="mt-2 space-y-3">
                    <div class="relative">
                        <input id="ticket-cliente-busqueda" type="text" placeholder="Buscador de cliente" class="w-full pl-9 pr-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400">
                            <i class="fas fa-search"></i>
                        </span>
                        <div id="ticket-cliente-dd" class="hidden absolute z-20 mt-1 w-full bg-white border border-gray-200 rounded-md shadow-lg overflow-hidden"></div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <button id="btn-crear-cliente" type="button" class="w-full inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-blue-700 bg-blue-50 rounded-md hover:bg-blue-100">
                            <i class="fas fa-user-plus mr-2"></i> Crear nuevo cliente
                        </button>
                        <button id="btn-select-cliente" type="button" class="w-full inline-flex items-center justify-center px-3 py-2 text-xs font-medium text-gray-700 bg-gray-50 rounded-md border border-gray-200 hover:bg-gray-100">
                            Seleccionar cliente
                        </button>
                    </div>
                    <div id="panel-pago-cliente" class="pt-2 border-t border-gray-100 space-y-2 text-xs text-gray-600 hidden">
                        <div class="flex items-center justify-between">
                            <span>Pago</span>
                        </div>
                        <div id="payment-buttons-grid" class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                            <button id="btn-pago-completo" type="button" class="w-full px-3 py-2 rounded-md text-sm font-medium bg-green-50 text-green-700 border border-green-100 hover:bg-green-100">üíµ Pago completo</button>
                            <button id="btn-cuenta-corriente" type="button" class="w-full px-3 py-2 rounded-md text-sm font-medium bg-yellow-50 text-yellow-700 border border-yellow-100 hover:bg-yellow-100">üßæ Cuenta corriente</button>
                            <button id="btn-sistema-cuotas" type="button" class="w-full px-3 py-2 rounded-md text-sm font-medium bg-indigo-50 text-indigo-700 border border-indigo-100 hover:bg-indigo-100 hidden">üìÜ Sistema de cuotas</button>
                        </div>
                        <p id="cuenta-corriente-notice" class="text-[11px] text-gray-500">Se registrar√° saldo pendiente en el legajo del cliente.</p>

                        <div id="panel-cuenta-corriente" class="hidden mt-2 p-3 rounded-xl border border-yellow-100 bg-yellow-50 space-y-3">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <div class="text-xs font-semibold text-yellow-900">Cuenta corriente</div>
                                    <div class="text-[11px] text-yellow-700">Indic√° cu√°nto abona ahora y se registrar√° el saldo pendiente en el legajo del cliente.</div>
                                </div>
                                <button id="btn-close-cuenta-corriente" type="button" class="h-8 w-8 inline-flex items-center justify-center rounded-full hover:bg-white/60 text-yellow-700" aria-label="Cerrar">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <div class="p-2 rounded-lg bg-white border border-yellow-100">
                                    <div class="text-[11px] text-yellow-700">Total del ticket</div>
                                    <div id="cc-inline-total" class="text-sm font-semibold text-yellow-900">$0,00</div>
                                </div>
                                <div class="p-2 rounded-lg bg-white border border-yellow-100">
                                    <div class="text-[11px] text-yellow-700">Saldo pendiente</div>
                                    <div id="cc-inline-due" class="text-sm font-semibold text-red-700">$0,00</div>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <div>
                                    <label class="block text-[11px] font-medium text-yellow-800 mb-1">Monto abonado ahora</label>
                                    <input id="cc-inline-paid" type="text" inputmode="decimal" class="w-full px-2 py-1.5 text-sm border border-yellow-200 rounded-md bg-white text-right" value="$0" data-currency="ars" />
                                </div>
                                <div class="flex items-end">
                                    <div id="cc-inline-hint" class="hidden w-full text-[11px] text-yellow-800 bg-white/60 border border-yellow-200 rounded-md px-2 py-2">El abono coincide con el total. Sugerido: Pago completo.</div>
                                </div>
                            </div>
                        </div>

                        <div id="panel-sistema-cuotas" class="hidden mt-2 p-3 rounded-xl border border-indigo-100 bg-indigo-50 space-y-3">
                            <div class="flex items-start justify-between gap-3">
                                <div>
                                    <div class="text-xs font-semibold text-indigo-900">Sistema de cuotas</div>
                                    <div class="text-[11px] text-indigo-700">Configur√° las cuotas del ticket. La primera cuota se cobra ahora.</div>
                                </div>
                                <button id="btn-close-sistema-cuotas" type="button" class="h-8 w-8 inline-flex items-center justify-center rounded-full hover:bg-white/60 text-indigo-700" aria-label="Cerrar">
                                    <i class="fas fa-times text-xs"></i>
                                </button>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <label class="flex items-center gap-2 p-2 rounded-lg bg-white border border-indigo-100 cursor-pointer">
                                    <input id="cuotas-mode-fixed" type="radio" name="cuotas-mode" value="fixed" checked>
                                    <div>
                                        <div class="text-[11px] font-semibold text-indigo-900">Cantidad de cuotas</div>
                                        <div class="text-[11px] text-indigo-700">Divide el total en cuotas.</div>
                                    </div>
                                </label>
                                <label class="flex items-center gap-2 p-2 rounded-lg bg-white border border-indigo-100 cursor-pointer">
                                    <input id="cuotas-mode-indefinite" type="radio" name="cuotas-mode" value="indefinite">
                                    <div>
                                        <div class="text-[11px] font-semibold text-indigo-900">Cuotas indefinidas</div>
                                        <div class="text-[11px] text-indigo-700">Cobros recurrentes sin fin.</div>
                                    </div>
                                </label>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <div id="cuotas-fixed-fields">
                                    <label class="block text-[11px] font-medium text-indigo-800 mb-1">Cantidad de cuotas</label>
                                    <input id="cuotas-count" type="number" min="1" max="24" value="3" class="w-full px-2 py-1.5 text-sm border border-indigo-200 rounded-md bg-white" />
                                </div>
                                <div>
                                    <label class="block text-[11px] font-medium text-indigo-800 mb-1">Intervalo (d√≠as)</label>
                                    <input id="cuotas-interval" type="number" min="1" max="365" value="30" class="w-full px-2 py-1.5 text-sm border border-indigo-200 rounded-md bg-white" />
                                </div>
                            </div>

                            <div id="cuotas-indefinite-fields" class="hidden">
                                <div class="text-[11px] text-indigo-800 font-medium">Cuotas indefinidas</div>
                                <div class="mt-1 text-[11px] text-indigo-700">El cliente abonar√° el total del carrito de forma recurrente cada <span id="cuotas-indefinite-interval-label">30</span> d√≠as, sin l√≠mite de cuotas.</div>
                            </div>

                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                                <div id="cuotas-total-card" class="p-2 rounded-lg bg-white border border-indigo-100">
                                    <div class="text-[11px] text-indigo-700">Total del ticket</div>
                                    <div id="cuotas-total" class="text-sm font-semibold text-indigo-900">$0,00</div>
                                </div>
                                <div id="cuotas-each-card" class="p-2 rounded-lg bg-white border border-indigo-100">
                                    <div id="cuotas-each-label" class="text-[11px] text-indigo-700">Estimado por cuota</div>
                                    <div id="cuotas-each" class="text-sm font-semibold text-indigo-900">$0,00</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg border border-gray-100 flex flex-col justify-between text-sm lg:sticky lg:top-24 h-full">
                <div class="space-y-1 text-xs">
                    <div class="flex justify-between"><span>Total estimado</span><span id="ticket-descuentos-sidebar" class="font-semibold text-gray-900">$0,00</span></div>
                    <div class="flex justify-between items-center gap-2">
                        <span>Descuento general</span>
                        <div class="flex items-center gap-2">
                            <div class="relative">
                                <input id="ticket-descuento-general-paso2" type="number" class="w-20 px-2 py-1 pr-5 border rounded-md text-right" placeholder="" min="0" max="100">
                                <span class="absolute inset-y-0 right-2 flex items-center text-[11px] text-gray-500 pointer-events-none">%</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between"><span>Total</span><span id="ticket-total-sidebar" class="font-semibold text-gray-900">$0,00</span></div>
                    <div id="cc-resumen-paso2" class="hidden text-[11px] text-gray-600 text-right"></div>
                    <div id="cuotas-resumen-paso2" class="hidden text-[11px] text-gray-600 text-right"></div>
                </div>
                <button id="btn-imprimir-ticket" type="button" class="w-full mt-3 inline-flex items-center justify-center px-3 py-2 text-sm font-medium text-gray-700 bg-gray-50 rounded-md border border-gray-200 hover:bg-gray-100" data-business-name="{{ business.name if business else '' }}">
                    Imprimir ticket
                </button>
                <button id="btn-confirmar-venta" class="w-full mt-3 inline-flex items-center justify-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                    Confirmar ticket y registrar
                </button>
            </div>
        </div>
    </div>
</div>

<div id="modal-select-customer" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Seleccionar cliente</h3>
                    <p class="text-xs text-gray-500">Busc√° por nombre y seleccion√° (o cerr√° para continuar sin cliente).</p>
                </div>
                <button id="btn-close-select-customer" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 space-y-3">
                <div class="relative">
                    <input id="select-customer-q" type="text" placeholder="Buscar cliente por nombre" class="w-full pl-9 pr-3 py-2 text-sm border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" autocomplete="off">
                    <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400"><i class="fas fa-search"></i></span>
                </div>
                <div id="select-customer-list" class="border border-gray-200 rounded-md overflow-hidden max-h-80 overflow-y-auto">
                    <div class="px-3 py-4 text-sm text-gray-500">Sin datos.</div>
                </div>
                <button id="btn-open-create-customer" type="button" class="w-full inline-flex items-center justify-center px-3 py-2 text-sm font-medium text-blue-700 bg-blue-50 rounded-md hover:bg-blue-100">
                    <i class="fas fa-user-plus mr-2"></i> Crear nuevo cliente
                </button>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end">
                <button id="btn-cancel-select-customer" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-create-customer" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Nuevo cliente</h3>
                    <p class="text-xs text-gray-500">Los campos obligatorios son: nombre, apellido y tel√©fono.</p>
                </div>
                <button id="btn-close-create-customer" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-3">
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Nombre</label>
                    <input id="new-customer-first" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Apellido</label>
                    <input id="new-customer-last" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Tel√©fono</label>
                    <input id="new-customer-phone" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Email (opcional)</label>
                    <input id="new-customer-email" type="email" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="">
                </div>
                <div>
                    <label class="block text-xs font-medium text-gray-600 mb-1">Fecha de Nacimiento (opcional)</label>
                    <input id="new-customer-birthday" type="date" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs font-medium text-gray-600 mb-1">Direcci√≥n (opcional)</label>
                    <input id="new-customer-address" type="text" class="w-full px-3 py-2 text-sm border rounded-md" placeholder="">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-xs font-medium text-gray-600 mb-1">Observaciones internas (opcional)</label>
                    <textarea id="new-customer-notes" rows="3" class="w-full px-3 py-2 text-sm border rounded-md" placeholder=""></textarea>
                </div>
                <div id="msg-create-customer-error" class="md:col-span-2 text-[11px] text-red-600 hidden flex items-center gap-1"><i class="fas fa-exclamation-circle"></i><span>Complet√° nombre, apellido y tel√©fono.</span></div>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end gap-2">
                <button id="btn-cancel-create-customer" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                <button id="btn-save-create-customer" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md bg-blue-600 hover:bg-blue-700">Guardar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script id="installments-config" type="application/json">{"enabled": {{ 'true' if business and business.habilitar_sistema_cuotas else 'false' }} }</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    let INSTALLMENTS_ENABLED = false;
    try {
        const rawCfg = document.getElementById('installments-config');
        const parsed = rawCfg ? JSON.parse(String(rawCfg.textContent || '{}')) : {};
        INSTALLMENTS_ENABLED = !!(parsed && parsed.enabled);
    } catch (e) {
        INSTALLMENTS_ENABLED = false;
    }

    const TENANT_PREFIX = ((window.location && window.location.pathname || '').match(/^\/c\/[^\/]+/) || [''])[0];
    function apiPath(p) {
        const s = String(p || '');
        if (!s.startsWith('/')) return s;
        if (s.startsWith('/c/')) return s;
        if (!TENANT_PREFIX) return s;
        return TENANT_PREFIX + s;
    }

    function isPromise(v) {
        try {
            return !!v && (typeof v === 'object' || typeof v === 'function') && typeof v.then === 'function';
        } catch (e) {
            return false;
        }
    }

    const logoUrl = '/static/images/favicon.ico';

    function formatearNumero(n) {
        const v = (typeof n === 'number') ? n : (parseFloat(String(n ?? '0').replace(',', '.')) || 0);
        try {
            return v.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        } catch (e) {
            return String(v.toFixed(2));
        }
    }

    function formatearPct(n) {
        const v = (typeof n === 'number') ? n : (parseFloat(String(n ?? '0').replace(',', '.')) || 0);
        try {
            return v.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        } catch (e) {
            return String(v.toFixed(2));
        }
    }

    function formatearMoneda(valor) {
        const n = (typeof valor === 'number') ? valor : (parseFloat(String(valor ?? '0').replace(',', '.')) || 0);
        try {
            return n.toLocaleString('es-AR', { style: 'currency', currency: 'ARS' });
        } catch (e) {
            return '$' + formatearNumero(n);
        }
    }

    let cashflowChannel = null;
    try {
        cashflowChannel = new BroadcastChannel('zentral_cashflow');
    } catch (e) {
        cashflowChannel = null;
    }

    function isCashMethod(method) {
        const s = String(method || '').trim().toLowerCase();
        if (!s) return false;
        return s === 'efectivo' || s === 'cash';
    }

    function getCashflowEventDate(msg) {
        const m = msg && typeof msg === 'object' ? msg : {};
        const candidates = [
            m.date,
            m.expense_date,
            m.sale_date,
            m.cash_count_date,
            m.count_date,
        ];
        for (const c of candidates) {
            const s = String(c || '').trim();
            if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
        }
        return '';
    }

    function maybeMarkArqueoPending(source) {
        try {
            setArqueoBadge('pendiente');
        } catch (e) {
        }
    }

    function placeVentaStepsPills(step) {
        try {
            if (!ventaStepsPills) return;
            const n = parseInt(step || 1, 10) || 1;
            const target = (n >= 2) ? ventaStepsSlotPaso2 : ventaStepsSlotPaso1;
            if (!target) return;
            if (target.contains(ventaStepsPills)) return;
            target.appendChild(ventaStepsPills);
        } catch (e) {
        }
    }

    function setEditState(ticket) {
        const t = String(ticket == null ? '' : ticket).trim();
        editTicketId = t ? t : null;
        try {
            if (ventasEditBadge) ventasEditBadge.classList.toggle('hidden', !editTicketId);
        } catch (e) {
        }
        try {
            if (ventasFlowTitle) ventasFlowTitle.textContent = editTicketId ? 'Editar venta' : 'Nueva venta';
            if (ventasFlowSubtitle) ventasFlowSubtitle.textContent = editTicketId ? ('Ticket ' + editTicketId) : 'Registr√° una venta nueva.';
        } catch (e) {
        }
        try {
            if (editTicketId && ventasEditBadge) ventasEditBadge.textContent = 'Editando';
        } catch (e) {
        }
    }

    function showPasoProductos() {
        try {
            if (pasoTicket) pasoTicket.classList.add('hidden');
            if (pasoProductos) pasoProductos.classList.remove('hidden');
            if (pasoProductosHeader) pasoProductosHeader.classList.remove('hidden');
        } catch (e) {
        }
        try {
            if (pillPaso1 && pillPaso2) {
                pillPaso1.classList.add('bg-indigo-600', 'text-white');
                pillPaso1.classList.remove('bg-indigo-50', 'text-indigo-700');
                pillPaso2.classList.add('bg-indigo-50', 'text-indigo-700');
                pillPaso2.classList.remove('bg-indigo-600', 'text-white');
            }
        } catch (e) {
        }
        try { placeVentaStepsPills(1); } catch (e) {}
        try { scrollAElemento(pasoProductosHeader || pasoProductos || flujo); } catch (e) {}
    }

    function showPasoTicket() {
        try {
            if (pasoProductos) pasoProductos.classList.add('hidden');
            if (pasoTicket) pasoTicket.classList.remove('hidden');
            if (pasoProductosHeader) pasoProductosHeader.classList.add('hidden');
        } catch (e) {
        }
        try {
            if (pillPaso1 && pillPaso2) {
                pillPaso1.classList.add('bg-indigo-50', 'text-indigo-700');
                pillPaso1.classList.remove('bg-indigo-600', 'text-white');
                pillPaso2.classList.add('bg-indigo-600', 'text-white');
                pillPaso2.classList.remove('bg-indigo-50', 'text-indigo-700');
            }
        } catch (e) {
        }
        try { placeVentaStepsPills(2); } catch (e) {}
        try { if (panelPagoCliente) panelPagoCliente.classList.remove('hidden'); } catch (e) {}
        try { computeTicketTotals(); } catch (e) {}
        try { renderTicketCartItemsFromMainCart(); } catch (e) {}
        try { renderTicketCartSummary(); } catch (e) {}
        try { applyEmployeesToSelectors(); } catch (e) {}
        try { scrollAElemento(pasoTicket || flujo); } catch (e) {}
    }

    try {
        window.initArqueoEmployees = window.initArqueoEmployees || initArqueoEmployees;
        window.setEditState = window.setEditState || setEditState;
        window.showPasoTicket = window.showPasoTicket || showPasoTicket;
        window.showPasoProductos = window.showPasoProductos || showPasoProductos;
        window.formatearMoneda = window.formatearMoneda || formatearMoneda;
        window.formatearNumero = window.formatearNumero || formatearNumero;
        window.formatearPct = window.formatearPct || formatearPct;
    } catch (e) {
    }
    const home = document.getElementById('ventas-home');
    const flujo = document.getElementById('ventas-flujo');
    const btnNuevaVenta = document.getElementById('btn-nueva-venta');
    const btnIrCambios = document.getElementById('btn-ir-cambios');
    const btnVolverHome = document.getElementById('btn-volver-home');
    const pasoProductos = document.getElementById('paso-productos');
    const pasoProductosHeader = document.getElementById('paso-productos-header');
    const pasoTicket = document.getElementById('paso-ticket');
    const btnContinuarTicket = document.getElementById('btn-continuar-ticket');
    const btnVolverPaso1 = document.getElementById('btn-volver-paso1');
    const toggleVentaLibre = document.getElementById('toggle-venta-libre');
    const panelVentaLibre = document.getElementById('panel-venta-libre');
    const inputVentaLibreNombre = document.getElementById('venta-libre-nombre');
    const inputVentaLibrePrecio = document.getElementById('venta-libre-precio');
    const btnAgregarVentaLibre = document.getElementById('btn-agregar-venta-libre');
    const panelCliente = document.getElementById('panel-cliente');
    const btnSelectCliente = document.getElementById('btn-select-cliente');
    const btnCrearCliente = document.getElementById('btn-crear-cliente');
    const btnGiftCode = document.getElementById('btn-gift-code');
    const inputIsGift = document.getElementById('ticket-is-gift');
    const giftCodeWrap = document.getElementById('gift-code-wrap');
    const giftCodeEl = document.getElementById('ticket-gift-code');
    const inputIsGiftCambio = document.getElementById('cambio-is-gift');
    const giftCodeWrapCambio = document.getElementById('cambio-gift-code-wrap');
    const giftCodeElCambio = document.getElementById('cambio-gift-code');
    const panelClienteCambio = document.getElementById('panel-cliente-cambio');
    const btnSelectClienteCambio = document.getElementById('btn-select-cliente-cambio');
    const btnSelectClienteCambioBottom = document.getElementById('btn-select-cliente-cambio-bottom');
    const btnCrearClienteCambio = document.getElementById('btn-crear-cliente-cambio');
    const historial = document.getElementById('historial-ventas');
    const headerFlujo = document.getElementById('header-flujo');
    const ventasFlowTitle = document.getElementById('ventas-flow-title');
    const ventasFlowSubtitle = document.getElementById('ventas-flow-subtitle');
    const ventasEditBadge = document.getElementById('ventas-edit-badge');
    const pillPaso1 = document.getElementById('pill-venta-paso1') || null;
    const pillPaso2 = document.getElementById('pill-venta-paso2') || null;
    const ventaStepsPills = document.getElementById('venta-steps-pills');
    const ventaStepsSlotPaso1 = document.getElementById('venta-steps-slot-paso1');
    const ventaStepsSlotPaso2 = document.getElementById('venta-steps-slot-paso2');
    const montoApertura = document.getElementById('monto-apertura');
    const montoCierre = document.getElementById('monto-cierre');
    const btnArqueo = document.getElementById('btn-arqueo');
    const msgArqueoOk = document.getElementById('msg-arqueo-ok');
    const msgArqueoError = document.getElementById('msg-arqueo-error');
    const msgArqueoDetalle = document.getElementById('msg-arqueo-detalle');
    const msgArqueoGuardado = document.getElementById('msg-arqueo-guardado');
    const btnGuardarArqueo = document.getElementById('btn-guardar-arqueo');
    const montoEfectivoDia = document.getElementById('monto-efectivo-dia');
    const btnConfirmarVenta = document.getElementById('btn-confirmar-venta');
    const btnToggleArqueo = document.getElementById('btn-toggle-arqueo');
    const modalArqueo = document.getElementById('modal-arqueo');
    const btnCloseArqueo = document.getElementById('btn-close-arqueo');
    const btnCancelArqueo = document.getElementById('btn-cancel-arqueo');
    const arqueoStatusBadge = document.getElementById('arqueo-status-badge');
    const selectArqueoEmployee = document.getElementById('arqueo-employee');
    const msgArqueoNoEmployees = document.getElementById('msg-arqueo-no-employees');
    const msgArqueoEmployeeRequired = document.getElementById('msg-arqueo-employee-required');
    const gridProductos = document.getElementById('grid-productos');
    const tablaProductosWrap = document.getElementById('tabla-productos-wrap');
    const tablaProductosBody = document.getElementById('tabla-productos-body');
    const btnViewGrid = document.getElementById('btn-view-grid');
    const btnViewList = document.getElementById('btn-view-list');
    const tablaProductosCambioWrap = document.getElementById('tabla-productos-cambio-wrap');
    const tablaProductosCambioBody = document.getElementById('tabla-productos-cambio-body');
    const btnViewGridCambio = document.getElementById('btn-view-grid-cambio');
    const btnViewListCambio = document.getElementById('btn-view-list-cambio');
    const inputSearchCambioProducts = document.getElementById('cambio-search-products');

    const tablaProductosCambioVentaWrap = document.getElementById('tabla-productos-cambio-venta-wrap');
    const tablaProductosCambioVentaBody = document.getElementById('tabla-productos-cambio-venta-body');
    const btnViewGridCambioVenta = document.getElementById('btn-view-grid-cambio-venta');
    const btnViewListCambioVenta = document.getElementById('btn-view-list-cambio-venta');
    const inputSearchCambioVentaProducts = document.getElementById('cambio-venta-search-products');
    const gridProductosCambio = document.getElementById('grid-productos-cambio');
    const gridProductosCambioVenta = document.getElementById('grid-productos-cambio-venta');
    const ticketFecha = document.getElementById('ticket-fecha');
    const ticketNotas = document.getElementById('ticket-notas');
    const ticketDiasCambio = document.getElementById('ticket-dias-cambio');
    const toggleVentaLibreTicket = document.getElementById('toggle-venta-libre-ticket');
    const tablaCarrito = document.getElementById('tabla-carrito');
    let carritoEmptyRow = document.getElementById('carrito-empty-row');
    const totalEstimadoEl = document.getElementById('total-estimado');
    const ticketCartItemsTbody = document.getElementById('ticket-cart-items');
    const ticketCartTotalEl = document.getElementById('ticket-cart-total');
    const cambioTicketCartItemsTbody = document.getElementById('cambio-ticket-cart-items');
    const cambioTicketCartTotalEl = document.getElementById('cambio-ticket-cart-total');

    try {
        // UX: el total no debe mostrarse en el header del carrito del Paso 2
        if (ticketCartTotalEl) ticketCartTotalEl.classList.add('hidden');
    } catch (e) {
    }
    const vistaRealizarCambio = document.getElementById('vista-realizar-cambio');
    const btnVolverDesdeCambio = document.getElementById('btn-volver-desde-cambio');
    const botonesMenuMov = document.querySelectorAll('.btn-mov-menu');
    const menusMov = document.querySelectorAll('.menu-mov-acciones');
    const inputFechaRango = document.querySelector('.fecha-rango-input');
    const btnExportVentas = document.getElementById('btn-export-ventas');
    const btnClearVentas = document.getElementById('btn-clear-ventas');
    const modalExportVentas = document.getElementById('modal-export-ventas');
    const btnCloseExportVentas = document.getElementById('btn-close-export-ventas');
    const btnCancelExportVentas = document.getElementById('btn-cancel-export-ventas');
    const btnExportVentasPdf = document.getElementById('btn-export-ventas-pdf');
    const btnExportVentasXls = document.getElementById('btn-export-ventas-xls');
    const modalExitCambio = document.getElementById('modal-exit-cambio');
    const btnCloseExitCambio = document.getElementById('btn-close-exit-cambio');
    const btnCancelExitCambio = document.getElementById('btn-cancel-exit-cambio');
    const btnConfirmExitCambio = document.getElementById('btn-confirm-exit-cambio');
    const modalExitVenta = document.getElementById('modal-exit-venta');
    const btnCloseExitVenta = document.getElementById('btn-close-exit-venta');
    const btnCancelExitVenta = document.getElementById('btn-cancel-exit-venta');
    const btnConfirmExitVenta = document.getElementById('btn-confirm-exit-venta');
    const inputSearchVentas = document.getElementById('ventas-search');
    const inputSearchVentasCliente = document.getElementById('ventas-search-cliente');
    const inputSearchVentasTicket = document.getElementById('ventas-search-ticket');
    const ventasColTicketLabel = document.getElementById('ventas-col-ticket-label');
    const selectVentasPago = document.getElementById('ventas-filter-pago');
    const selectVentasEstado = document.getElementById('ventas-filter-estado');
    const selectVentasEmployee = document.getElementById('ventas-filter-employee');
    const btnVentasFilterEmployee = document.getElementById('ventas-filter-employee-btn');
    const menuVentasFilterEmployee = document.getElementById('ventas-filter-employee-menu');
    const itemsVentasFilterEmployee = document.getElementById('ventas-filter-employee-items');
    const labelVentasFilterEmployee = document.getElementById('ventas-filter-employee-label');

    const btnVentasFilterPago = document.getElementById('ventas-filter-pago-btn');
    const menuVentasFilterPago = document.getElementById('ventas-filter-pago-menu');
    const itemsVentasFilterPago = document.getElementById('ventas-filter-pago-items');
    const labelVentasFilterPago = document.getElementById('ventas-filter-pago-label');

    const btnVentasFilterTipo = document.getElementById('ventas-filter-tipo-btn');
    const menuVentasFilterTipo = document.getElementById('ventas-filter-tipo-menu');
    const itemsVentasFilterTipo = document.getElementById('ventas-filter-tipo-items');
    const labelVentasFilterTipo = document.getElementById('ventas-filter-tipo-label');
    const kpiVentasDiaEl = document.getElementById('kpi-ventas-dia');
    const kpiTicketsDiaEl = document.getElementById('kpi-tickets-dia');
    const kpiItemsDiaEl = document.getElementById('kpi-items-dia');
    const kpiTicketPromedioEl = document.getElementById('kpi-ticket-promedio');
    const kpiLabelVentasEl = document.getElementById('kpi-label-ventas');
    const kpiLabelTicketsEl = document.getElementById('kpi-label-tickets');
    const kpiLabelItemsEl = document.getElementById('kpi-label-items');
    const kpiLabelPromedioEl = document.getElementById('kpi-label-promedio');
    // Elementos espec√≠ficos del flujo de cambio
    let botonesProductoCambio = [];
    const tablaCarritoCambio = document.getElementById('tabla-carrito-cambio');
    const carritoCambioEmptyRow = document.getElementById('carrito-cambio-empty-row');
    const totalCambioEl = document.getElementById('total-cambio');
    const btnConfirmarCambio = document.getElementById('btn-confirmar-cambio');
    const pillsCategoriasVentaWrap = document.getElementById('pills-categorias-venta');
    const pillsCategoriasCambioWrap = document.getElementById('pills-categorias-cambio');
    const pillsCategoriasCambioVentaWrap = document.getElementById('pills-categorias-cambio-venta');
    const cambioPaso1 = document.getElementById('cambio-paso1');
    const cambioPaso2 = document.getElementById('cambio-paso2');
    const cambioPaso3 = document.getElementById('cambio-paso3');
    const pillCambioPaso1 = document.getElementById('pill-cambio-paso1');
    const pillCambioPaso2 = document.getElementById('pill-cambio-paso2');
    const pillCambioPaso3 = document.getElementById('pill-cambio-paso3');
    let botonesProductoCambioVenta = [];
    const tablaCarritoCambioVenta = document.getElementById('tabla-carrito-cambio-venta');
    const carritoCambioVentaEmptyRow = document.getElementById('carrito-cambio-venta-empty-row');
    const saldoAFavorEl = document.getElementById('saldo-a-favor');
    const totalCambioVentaEl = document.getElementById('total-cambio-venta');
    const diferenciaAbonarEl = document.getElementById('diferencia-a-abonar');
    const btnConfirmarCambioVenta = document.getElementById('btn-confirmar-cambio-venta');
    const resumenSaldoAFavorEl = document.getElementById('resumen-saldo-a-favor');
    const resumenTotalCambioVentaEl = document.getElementById('resumen-total-cambio-venta');
    const resumenDiferenciaAbonarEl = document.getElementById('resumen-diferencia-a-abonar');
    const inputCambioTicket = document.getElementById('cambio-ticket');
    const inputClienteCambio = document.getElementById('cambio-cliente');
    const ddClienteCambio = document.getElementById('cambio-cliente-dd');
    const inputNotasCambio = document.getElementById('cambio-notas');
    const selectTicketEmployee = document.getElementById('ticket-employee');
    const selectCambioEmployee = document.getElementById('cambio-employee');
    const msgVentaNoEmployees = document.getElementById('msg-venta-no-employees');
    const msgCambioNoEmployees = document.getElementById('msg-cambio-no-employees');
    const btnConfirmarCambioFinal = document.getElementById('btn-confirmar-cambio-final');
    const panelPagoClienteCambio = document.getElementById('panel-pago-cliente-cambio');
    const btnPagoCompletoCambio = document.getElementById('btn-pago-completo-cambio');
    const btnCuentaCorrienteCambio = document.getElementById('btn-cuenta-corriente-cambio');
    const historialTbody = historial ? historial.querySelector('tbody') : null;

    let botonesProducto = document.querySelectorAll('.btn-producto');

    let saldoAFavor = 0;

    const inputDescuentoGeneral = document.getElementById('ticket-descuento-general');
    const inputDescuentoGeneralPaso2 = document.getElementById('ticket-descuento-general-paso2');
    const inputTicketTotalFinal = document.getElementById('ticket-total-final');
    const ticketTotalSidebar = document.getElementById('ticket-total-sidebar');
    const ticketDescuentosSidebar = document.getElementById('ticket-descuentos-sidebar');
    const ccResumenPaso1 = document.getElementById('cc-resumen-paso1');
    const ccResumenPaso2 = document.getElementById('cc-resumen-paso2');
    const cuotasResumenPaso1 = document.getElementById('cuotas-resumen-paso1');
    const cuotasResumenPaso2 = document.getElementById('cuotas-resumen-paso2');
    const inputClienteBusqueda = document.getElementById('ticket-cliente-busqueda');
    const ddCliente = document.getElementById('ticket-cliente-dd');
    const btnPagoCompleto = document.getElementById('btn-pago-completo');
    const btnCuentaCorriente = document.getElementById('btn-cuenta-corriente');
    const btnSistemaCuotas = document.getElementById('btn-sistema-cuotas');
    const paymentButtonsGrid = document.getElementById('payment-buttons-grid');
    const panelPagoCliente = document.getElementById('panel-pago-cliente');
    const panelSistemaCuotas = document.getElementById('panel-sistema-cuotas');
    const btnCloseSistemaCuotas = document.getElementById('btn-close-sistema-cuotas');
    const cuotasModeFixed = document.getElementById('cuotas-mode-fixed');
    const cuotasModeIndefinite = document.getElementById('cuotas-mode-indefinite');
    const cuotasFixedFields = document.getElementById('cuotas-fixed-fields');
    const cuotasIndefiniteFields = document.getElementById('cuotas-indefinite-fields');
    const cuotasIndefiniteIntervalLabel = document.getElementById('cuotas-indefinite-interval-label');
    const cuotasTotalCard = document.getElementById('cuotas-total-card');
    const cuotasEachCard = document.getElementById('cuotas-each-card');
    const cuotasEachLabel = document.getElementById('cuotas-each-label');
    const cuotasCount = document.getElementById('cuotas-count');
    const cuotasInterval = document.getElementById('cuotas-interval');
    const cuotasTotal = document.getElementById('cuotas-total');
    const cuotasEach = document.getElementById('cuotas-each');

    const panelCuentaCorriente = document.getElementById('panel-cuenta-corriente');
    const btnCloseCuentaCorriente = document.getElementById('btn-close-cuenta-corriente');
    const ccInlineTotal = document.getElementById('cc-inline-total');
    const ccInlinePaid = document.getElementById('cc-inline-paid');
    const ccInlineDue = document.getElementById('cc-inline-due');
    const ccInlineHint = document.getElementById('cc-inline-hint');

    const modalCuentaCorriente = document.getElementById('modal-cuenta-corriente');
    const btnCloseCc = document.getElementById('btn-close-cc');
    const btnCancelCc = document.getElementById('btn-cancel-cc');
    const btnAcceptCc = document.getElementById('btn-accept-cc');
    const ccCliente = document.getElementById('cc-cliente');
    const ccClienteAlertas = document.getElementById('cc-cliente-alertas');
    const ccTotal = document.getElementById('cc-total');
    const ccPaid = document.getElementById('cc-paid');
    const ccDue = document.getElementById('cc-due');
    const ccError = document.getElementById('cc-error');

    try {
        // Evitar m√°scaras externas por data-currency que pueden reinterpretar el valor ingresado
        if (ccInlinePaid) ccInlinePaid.removeAttribute('data-currency');
        if (ccPaid) ccPaid.removeAttribute('data-currency');
    } catch (e) {
    }

    try {
        if (window.montoAbonado == null) window.montoAbonado = 0;
    } catch (e) {
    }
    const modalSelectCustomer = document.getElementById('modal-select-customer');
    const btnCloseSelectCustomer = document.getElementById('btn-close-select-customer');
    const btnCancelSelectCustomer = document.getElementById('btn-cancel-select-customer');
    const inputSelectCustomerQ = document.getElementById('select-customer-q');
    const listSelectCustomer = document.getElementById('select-customer-list');
    const btnOpenCreateCustomer = document.getElementById('btn-open-create-customer');
    const modalCreateCustomer = document.getElementById('modal-create-customer');
    const btnCloseCreateCustomer = document.getElementById('btn-close-create-customer');
    const btnCancelCreateCustomer = document.getElementById('btn-cancel-create-customer');
    const btnSaveCreateCustomer = document.getElementById('btn-save-create-customer');
    const inputNewCustomerFirst = document.getElementById('new-customer-first');
    const inputNewCustomerLast = document.getElementById('new-customer-last');
    const inputNewCustomerEmail = document.getElementById('new-customer-email');
    const inputNewCustomerPhone = document.getElementById('new-customer-phone');
    const inputNewCustomerBirthday = document.getElementById('new-customer-birthday');
    const inputNewCustomerAddress = document.getElementById('new-customer-address');
    const inputNewCustomerNotes = document.getElementById('new-customer-notes');
    const msgCreateCustomerError = document.getElementById('msg-create-customer-error');

    const inputSearchVentaProducts = document.querySelector('#paso-productos input[type="text"][placeholder^="Buscar"]');

    let cacheCustomers = [];
    let selectedCustomer = null;
    let currentCustomerContext = 'sale';
    let editTicketId = null;
    let editCambioTicketId = null;
    let editCambioVentaTicketId = null;
    let editCambioVentaReturnTotal = 0;
    let editCambioVentaReturnTicketId = '';

    let customersLoaded = false;
    let customersLoadPromise = null;
    let lastSelectCustomerFetchToken = 0;

    const scannerInput = document.getElementById('scanner-input');
    let scannerBuffer = '';
    let scannerLastTs = 0;
    let scannerEnabled = true;

    function openModal(el) {
        if (!el) return;
        try { el.classList.remove('hidden'); } catch (e) {}
    }

    function closeModal(el) {
        if (!el) return;
        try { el.classList.add('hidden'); } catch (e) {}
    }

    function openModalCompat(el) {
        if (!el) return;
        try {
            if (typeof openModal === 'function') {
                openModal(el);
                return;
            }
        } catch (e) {
        }
        try { el.classList.remove('hidden'); } catch (e) {}
    }

    function closeModalCompat(el) {
        if (!el) return;
        try {
            if (typeof closeModal === 'function') {
                closeModal(el);
                return;
            }
        } catch (e) {
        }
        try { el.classList.add('hidden'); } catch (e) {}
    }

    function customerDisplayName(c) {
        const d = c && typeof c === 'object' ? c : {};
        return String(d.name || '').trim() || (String((d.first_name || d.firstName) || '').trim() + ' ' + String((d.last_name || d.lastName) || '').trim()).trim() || 'Cliente';
    }

    function apiListCustomers(q, limit) {
        const qs = [];
        const s = String(q || '').trim();
        if (s) qs.push('q=' + encodeURIComponent(s));
        const lim = Math.max(1, Math.min(5000, parseInt(String(limit || 500), 10) || 500));
        qs.push('limit=' + encodeURIComponent(String(lim)));
        const url = apiPath('/customers/api/customers' + (qs.length ? ('?' + qs.join('&')) : ''));
        return fetch(url, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => (data && data.ok && Array.isArray(data.items)) ? data.items : []);
    }

    function initCustomers() {
        if (customersLoaded) return cacheCustomers;
        if (customersLoadPromise) return customersLoadPromise;
        customersLoadPromise = apiListCustomers('', 2000).then(function (items) {
            cacheCustomers = Array.isArray(items) ? items : [];
            customersLoaded = true;
            return cacheCustomers;
        }).catch(function () {
            cacheCustomers = [];
            customersLoaded = true;
            return cacheCustomers;
        });
        return customersLoadPromise;
    }

    function setSelectedCustomer(cust) {
        selectedCustomer = cust || null;

        const name = selectedCustomer ? customerDisplayName(selectedCustomer) : '';
        try {
            if (currentCustomerContext === 'cambio') {
                if (inputClienteCambio) inputClienteCambio.value = name;
            } else {
                if (inputClienteBusqueda) inputClienteBusqueda.value = name;
            }
        } catch (e) {
        }

        try { updateClientePagoVisibility(); } catch (e) {}
        try { updateClientePagoCambioVisibility(); } catch (e) {}

        try { hideClienteDd(); } catch (e) {}
        try { hideClienteCambioDd(); } catch (e) {}
    }

    function currentCustomerNameFromInput() {
        try {
            if (currentCustomerContext === 'cambio') {
                return String(inputClienteCambio?.value || '').trim();
            }
            return String(inputClienteBusqueda?.value || '').trim();
        } catch (e) {
            return '';
        }
    }

    function openSelectCustomer(context) {
        currentCustomerContext = (context === 'cambio') ? 'cambio' : 'sale';
        if (inputSelectCustomerQ) inputSelectCustomerQ.value = currentCustomerNameFromInput();
        openModalCompat(modalSelectCustomer);
        try { renderSelectCustomerList(); } catch (e) {}
        try { if (inputSelectCustomerQ) inputSelectCustomerQ.focus(); } catch (e) {}
    }

    function renderSelectCustomerList() {
        if (!listSelectCustomer) return;
        const token = ++lastSelectCustomerFetchToken;
        const q = String(inputSelectCustomerQ?.value || '').trim();

        listSelectCustomer.innerHTML = '<div class="px-4 py-4 text-sm text-gray-500">Buscando clientes‚Ä¶</div>';

        Promise.resolve(apiListCustomers(q, 200)).then(function (items) {
            if (token !== lastSelectCustomerFetchToken) return;
            const list = Array.isArray(items) ? items : [];
            if (!q && list.length) {
                cacheCustomers = list;
                customersLoaded = true;
            }
            if (!list.length) {
                listSelectCustomer.innerHTML = '<div class="px-4 py-4 text-sm text-gray-500">No se encontraron clientes.</div>';
                return;
            }
            listSelectCustomer.innerHTML = '';
            list.slice(0, 200).forEach(function (c) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'w-full text-left px-4 py-3 hover:bg-gray-50 border-b border-gray-100';
                const name = customerDisplayName(c);
                const phone = String(c?.phone || '').trim();
                const email = String(c?.email || '').trim();
                btn.innerHTML = ''
                    + '<div class="text-sm font-medium text-gray-900">' + escapeHtml(name) + '</div>'
                    + '<div class="text-[11px] text-gray-500">' + escapeHtml([phone, email].filter(Boolean).join(' ¬∑ ') || '‚Äî') + '</div>';
                btn.addEventListener('click', function () {
                    setSelectedCustomer(c);
                    closeModalCompat(modalSelectCustomer);
                });
                listSelectCustomer.appendChild(btn);
            });
        }).catch(function () {
            if (token !== lastSelectCustomerFetchToken) return;
            listSelectCustomer.innerHTML = '<div class="px-4 py-4 text-sm text-red-600">No se pudieron cargar los clientes.</div>';
        });
    }

    function hideClienteDd() {
        try {
            if (ddCliente) ddCliente.classList.add('hidden');
            if (ddCliente) ddCliente.innerHTML = '';
        } catch (e) {
        }
    }

    function hideClienteCambioDd() {
        try {
            if (ddClienteCambio) ddClienteCambio.classList.add('hidden');
            if (ddClienteCambio) ddClienteCambio.innerHTML = '';
        } catch (e) {
        }
    }

    function actualizarClienteDd() {
        if (!ddCliente || !inputClienteBusqueda) return;
        currentCustomerContext = 'sale';
        const q = String(inputClienteBusqueda.value || '').trim();
        if (!q) { hideClienteDd(); return; }

        ddCliente.classList.remove('hidden');
        ddCliente.innerHTML = '<div class="px-3 py-2 text-xs text-gray-500">Buscando‚Ä¶</div>';
        apiListCustomers(q, 10).then(function (items) {
            const list = Array.isArray(items) ? items : [];
            if (!list.length) {
                ddCliente.innerHTML = '<div class="px-3 py-2 text-xs text-gray-500">Sin resultados.</div>';
                return;
            }
            ddCliente.innerHTML = '';
            list.slice(0, 10).forEach(function (c) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'w-full text-left px-3 py-2 hover:bg-gray-50 text-sm';
                btn.textContent = customerDisplayName(c);
                btn.addEventListener('click', function () {
                    setSelectedCustomer(c);
                    hideClienteDd();
                });
                ddCliente.appendChild(btn);
            });
        }).catch(function () {
            ddCliente.innerHTML = '<div class="px-3 py-2 text-xs text-red-600">Error cargando clientes.</div>';
        });
    }

    function actualizarClienteCambioDd() {
        if (!ddClienteCambio || !inputClienteCambio) return;
        currentCustomerContext = 'cambio';
        const q = String(inputClienteCambio.value || '').trim();
        if (!q) { hideClienteCambioDd(); return; }

        ddClienteCambio.classList.remove('hidden');
        ddClienteCambio.innerHTML = '<div class="px-3 py-2 text-xs text-gray-500">Buscando‚Ä¶</div>';
        apiListCustomers(q, 10).then(function (items) {
            const list = Array.isArray(items) ? items : [];
            if (!list.length) {
                ddClienteCambio.innerHTML = '<div class="px-3 py-2 text-xs text-gray-500">Sin resultados.</div>';
                return;
            }
            ddClienteCambio.innerHTML = '';
            list.slice(0, 10).forEach(function (c) {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'w-full text-left px-3 py-2 hover:bg-gray-50 text-sm';
                btn.textContent = customerDisplayName(c);
                btn.addEventListener('click', function () {
                    setSelectedCustomer(c);
                    hideClienteCambioDd();
                });
                ddClienteCambio.appendChild(btn);
            });
        }).catch(function () {
            ddClienteCambio.innerHTML = '<div class="px-3 py-2 text-xs text-red-600">Error cargando clientes.</div>';
        });
    }

    function updateClientePagoVisibility() {
        try {
            if (!selectedCustomer) {
                ventaOnAccount = false;
                ventaUseInstallments = false;
                if (panelCuentaCorriente) panelCuentaCorriente.classList.add('hidden');
                if (panelSistemaCuotas) panelSistemaCuotas.classList.add('hidden');
                if (typeof updatePaymentButtonsVisual === 'function') updatePaymentButtonsVisual();
            }
        } catch (e) {
        }
    }

    function updateClientePagoCambioVisibility() {
        try {
            if (!selectedCustomer) {
                cambioOnAccount = false;
                if (panelPagoClienteCambio) panelPagoClienteCambio.classList.add('hidden');
            }
        } catch (e) {
        }
    }

    function openCreateCustomer(prefillName) {
        if (!modalCreateCustomer) return;
        try {
            if (msgCreateCustomerError) msgCreateCustomerError.classList.add('hidden');
        } catch (e) {
        }
        const prefill = String(prefillName || '').trim();
        try {
            if (inputNewCustomerFirst) inputNewCustomerFirst.value = prefill;
            if (inputNewCustomerLast) inputNewCustomerLast.value = '';
            if (inputNewCustomerEmail) inputNewCustomerEmail.value = '';
            if (inputNewCustomerPhone) inputNewCustomerPhone.value = '';
            if (inputNewCustomerBirthday) inputNewCustomerBirthday.value = '';
            if (inputNewCustomerAddress) inputNewCustomerAddress.value = '';
            if (inputNewCustomerNotes) inputNewCustomerNotes.value = '';
        } catch (e) {
        }
        openModalCompat(modalCreateCustomer);
        try { if (inputNewCustomerFirst) inputNewCustomerFirst.focus(); } catch (e) {}
    }

    function saveNewCustomer() {
        const payload = {
            first_name: String(inputNewCustomerFirst?.value || '').trim(),
            last_name: String(inputNewCustomerLast?.value || '').trim(),
            email: String(inputNewCustomerEmail?.value || '').trim(),
            phone: String(inputNewCustomerPhone?.value || '').trim(),
            birthday: String(inputNewCustomerBirthday?.value || '').trim(),
            address: String(inputNewCustomerAddress?.value || '').trim(),
            notes: String(inputNewCustomerNotes?.value || '').trim(),
        };
        const url = apiPath('/customers/api/customers');
        fetch(url, {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        }).then(r => r.json()).then(function (data) {
            if (!data || data.ok !== true || !data.item) {
                const msg = (data && (data.message || data.error)) ? String(data.message || data.error) : 'No se pudo crear el cliente.';
                if (msgCreateCustomerError) {
                    msgCreateCustomerError.textContent = msg;
                    msgCreateCustomerError.classList.remove('hidden');
                }
                return;
            }
            const c = data.item;
            try {
                cacheCustomers.unshift(c);
            } catch (e) {
            }
            customersLoaded = true;
            setSelectedCustomer(c);
            closeModalCompat(modalCreateCustomer);
            closeModalCompat(modalSelectCustomer);
        }).catch(function () {
            if (msgCreateCustomerError) {
                msgCreateCustomerError.textContent = 'No se pudo crear el cliente.';
                msgCreateCustomerError.classList.remove('hidden');
            }
        });
    }

    try {
        window.openSelectCustomer = window.openSelectCustomer || openSelectCustomer;
        window.openCreateCustomer = window.openCreateCustomer || openCreateCustomer;
        window.saveNewCustomer = window.saveNewCustomer || saveNewCustomer;
    } catch (e) {
    }

    let ventaOnAccount = false;
    let ventaPaidAmount = 0;
    let ventaUseInstallments = false;

    function resetVentaPaymentState() {
        ventaOnAccount = false;
        ventaPaidAmount = 0;
        ventaUseInstallments = false;
        try {
            if (panelCuentaCorriente) panelCuentaCorriente.classList.add('hidden');
            if (panelSistemaCuotas) panelSistemaCuotas.classList.add('hidden');
        } catch (e) {
        }
        try {
            if (ccInlinePaid) ccInlinePaid.value = '$0';
        } catch (e) {
        }
        try {
            if (cuotasCount) cuotasCount.value = '1';
            if (cuotasInterval) cuotasInterval.value = '30';
            if (cuotasModeFixed) cuotasModeFixed.checked = true;
            if (cuotasModeIndefinite) cuotasModeIndefinite.checked = false;
        } catch (e) {
        }
        try { applyCuotasModeUi(); } catch (e) {}
        try { updatePaymentButtonsVisual(); } catch (e) {}
        try { syncCuentaCorrienteInlinePreview(); } catch (e) {}
        try { syncCuotasPreview(); } catch (e) {}
        try { computeTicketTotals(); } catch (e) {}
    }

    function updatePaymentButtonsVisual() {
        const full = (!ventaOnAccount && !ventaUseInstallments);
        const cc = (!!ventaOnAccount);
        const cuo = (!!ventaUseInstallments);

        try {
            if (btnPagoCompleto) btnPagoCompleto.classList.toggle('opacity-60', !full);
            if (btnCuentaCorriente) btnCuentaCorriente.classList.toggle('opacity-60', !cc);
            if (btnSistemaCuotas) btnSistemaCuotas.classList.toggle('opacity-60', !cuo);
        } catch (e) {
        }

        try {
            if (panelCuentaCorriente) panelCuentaCorriente.classList.toggle('hidden', !cc);
        } catch (e) {
        }
        try {
            if (panelSistemaCuotas) panelSistemaCuotas.classList.toggle('hidden', !cuo);
        } catch (e) {
        }
    }

    function setPagoCompleto() {
        ventaOnAccount = false;
        ventaUseInstallments = false;
        ventaPaidAmount = 0;
        try {
            if (ccInlinePaid) ccInlinePaid.value = '$0';
        } catch (e) {
        }
        updatePaymentButtonsVisual();
        try { computeTicketTotals(); } catch (e) {}
        try { syncCuentaCorrienteInlinePreview(); } catch (e) {}
        try { syncCuotasPreview(); } catch (e) {}
    }

    function syncCuentaCorrienteInlinePreview() {
        if (!panelCuentaCorriente) return;
        const tt = (window.ticketTotals && typeof window.ticketTotals === 'object') ? window.ticketTotals : null;
        const total = tt && isFinite(tt.total) ? (parseFloat(tt.total) || 0) : (parseFloat((computeTicketTotals()?.total) || 0) || 0);

        let paid = parseMoneyInputARS(ccInlinePaid?.value || 0);
        if (!isFinite(paid) || paid < 0) paid = 0;
        if (paid > total) paid = total;

        try { window.montoAbonado = paid; } catch (e) {}

        ventaPaidAmount = paid;

        const due = Math.max(0, total - paid);

        try { if (ccInlineTotal) ccInlineTotal.textContent = formatearMoneda(total); } catch (e) {}
        try { if (ccInlineDue) ccInlineDue.textContent = formatearMoneda(due); } catch (e) {}
        try {
            if (ccInlineHint) {
                const show = total > 0 && Math.abs(due) < 0.00001;
                ccInlineHint.classList.toggle('hidden', !show);
            }
        } catch (e) {}

        try {
            renderCcResumen(ccResumenPaso1, paid, due, ventaOnAccount);
            renderCcResumen(ccResumenPaso2, paid, due, ventaOnAccount);
        } catch (e) {}
    }

    function openCuentaCorrientePanel() {
        if (!selectedCustomer) {
            showAlertModal('Para usar cuenta corriente ten√©s que asociar un cliente.', 'Atenci√≥n', 'Validaci√≥n requerida');
            return;
        }
        ventaOnAccount = true;
        ventaUseInstallments = false;

        try {
            if (panelCuentaCorriente) panelCuentaCorriente.classList.remove('hidden');
            if (panelSistemaCuotas) panelSistemaCuotas.classList.add('hidden');
        } catch (e) {
        }

        try {
            const totals = (typeof computeTicketTotals === 'function') ? computeTicketTotals() : null;
            const total = parseFloat(totals?.total || 0) || 0;
            if (ccInlinePaid) ccInlinePaid.value = formatearMoneda(total);
        } catch (e) {
        }

        updatePaymentButtonsVisual();
        try { syncCuentaCorrienteInlinePreview(); } catch (e) {}
    }

    function closeCuentaCorrientePanel(resetToFull) {
        try { if (panelCuentaCorriente) panelCuentaCorriente.classList.add('hidden'); } catch (e) {}
        if (resetToFull) {
            setPagoCompleto();
            return;
        }
        updatePaymentButtonsVisual();
        try { syncCuentaCorrienteInlinePreview(); } catch (e) {}
    }

    function getCuotasMode() {
        try {
            if (cuotasModeIndefinite && cuotasModeIndefinite.checked) return 'indefinite';
            return 'fixed';
        } catch (e) {
            return 'fixed';
        }
    }

    function applyCuotasModeUi() {
        const mode = getCuotasMode();
        try {
            if (cuotasFixedFields) cuotasFixedFields.classList.toggle('hidden', mode !== 'fixed');
            if (cuotasIndefiniteFields) cuotasIndefiniteFields.classList.toggle('hidden', mode !== 'indefinite');
        } catch (e) {
        }
        try {
            if (cuotasEachLabel) cuotasEachLabel.textContent = (mode === 'fixed') ? 'Cada cuota' : 'Primera cuota';
        } catch (e) {
        }
    }

    function syncCuotasPreview() {
        if (!panelSistemaCuotas || panelSistemaCuotas.classList.contains('hidden')) return;
        const totals = (typeof computeTicketTotals === 'function') ? computeTicketTotals() : null;
        const total = parseFloat(totals?.total || 0) || 0;
        const mode = getCuotasMode();

        let each = total;
        if (mode === 'fixed') {
            const cnt = Math.max(1, Math.min(24, parseInt(String(cuotasCount?.value || '1'), 10) || 1));
            each = cnt > 0 ? (total / cnt) : total;
        }

        try { if (cuotasTotal) cuotasTotal.textContent = formatearMoneda(total); } catch (e) {}
        try { if (cuotasEach) cuotasEach.textContent = formatearMoneda(each); } catch (e) {}

        try {
            const resumen = (mode === 'fixed')
                ? ('Cuotas: ' + String(cuotasCount?.value || '1') + ' ¬∑ Cada una ' + formatearMoneda(each))
                : ('Cuotas indefinidas ¬∑ Intervalo ' + String(cuotasInterval?.value || '') + ' d√≠as');
            if (cuotasResumenPaso1) {
                cuotasResumenPaso1.textContent = resumen;
                cuotasResumenPaso1.classList.toggle('hidden', !ventaUseInstallments);
            }
            if (cuotasResumenPaso2) {
                cuotasResumenPaso2.textContent = resumen;
                cuotasResumenPaso2.classList.toggle('hidden', !ventaUseInstallments);
            }
        } catch (e) {}
    }

    function setSistemaCuotas() {
        if (!INSTALLMENTS_ENABLED) {
            showAlertModal('El sistema de cuotas est√° deshabilitado en la configuraci√≥n del negocio.', 'Atenci√≥n', 'Validaci√≥n requerida');
            return;
        }
        if (!selectedCustomer) {
            showAlertModal('Para usar el sistema de cuotas ten√©s que asociar un cliente.', 'Atenci√≥n', 'Validaci√≥n requerida');
            return;
        }
        ventaUseInstallments = true;
        ventaOnAccount = false;
        ventaPaidAmount = 0;
        try {
            if (panelSistemaCuotas) panelSistemaCuotas.classList.remove('hidden');
            if (panelCuentaCorriente) panelCuentaCorriente.classList.add('hidden');
        } catch (e) {
        }
        applyCuotasModeUi();
        updatePaymentButtonsVisual();
        try { syncCuotasPreview(); } catch (e) {}
        try { computeTicketTotals(); } catch (e) {}
    }

    function syncInstallmentsButtonVisibility() {
        const enabled = !!INSTALLMENTS_ENABLED;
        try {
            if (btnSistemaCuotas) btnSistemaCuotas.classList.toggle('hidden', !enabled);
        } catch (e) {
        }
        try {
            if (paymentButtonsGrid) {
                paymentButtonsGrid.classList.remove('sm:grid-cols-2');
                paymentButtonsGrid.classList.remove('sm:grid-cols-3');
                paymentButtonsGrid.classList.add(enabled ? 'sm:grid-cols-3' : 'sm:grid-cols-2');
            }
        } catch (e) {
        }

        if (!enabled) {
            try {
                if (panelSistemaCuotas) panelSistemaCuotas.classList.add('hidden');
            } catch (e) {
            }
            ventaUseInstallments = false;
            try {
                if (typeof updatePaymentButtonsVisual === 'function') updatePaymentButtonsVisual();
            } catch (e) {
            }
        }
    }

    let ventaIsGift = false;
    let ventaGiftCode = '';
    let ventasGiftOnly = false;

    let cambioIsGift = false;
    let cambioGiftCode = '';

    let cambioOnAccount = false;
    let cambioPaidAmount = 0;

    let ccPrevOnAccount = false;
    let ccPrevPaidAmount = 0;
    let ccPrevCambioOnAccount = false;
    let ccPrevCambioPaidAmount = 0;
    let ccPrevDebtSaldo = 0;
    let ccModalAccepted = false;
    let ccContext = 'sale';
    let ccTargetTotal = 0;

    function syncCcDuePreview() {
        try {
            const total = parseNumeroFlexible(ccTargetTotal || 0);
            let paid = parseMoneyInputARS(ccPaid?.value || 0);
            if (!isFinite(paid) || paid < 0) paid = 0;
            if (paid > total) paid = total;
            const due = Math.max(0, total - paid);

            try { window.montoAbonado = paid; } catch (e) {}

            if (ccTotal) ccTotal.textContent = formatearMoneda(total);
            if (ccDue) ccDue.textContent = formatearMoneda(due);

            if (ccError) ccError.classList.toggle('hidden', true);
        } catch (e) {
        }
    }

    function openCuentaCorrienteCambioModal() {
        ccContext = 'cambio';
        ccModalAccepted = false;
        ccPrevCambioOnAccount = !!cambioOnAccount;
        ccPrevCambioPaidAmount = parseFloat(cambioPaidAmount || 0) || 0;

        const totals = (typeof computeTicketTotalsCambio === 'function') ? computeTicketTotalsCambio() : null;
        const total = parseFloat(totals?.total || 0) || 0;
        ccTargetTotal = total;

        try { if (ccCliente) ccCliente.textContent = selectedCustomer ? customerDisplayName(selectedCustomer) : '‚Äî'; } catch (e) {}
        try { if (ccPaid) ccPaid.value = formatearMoneda(Math.min(total, Math.max(0, ccPrevCambioPaidAmount || 0))); } catch (e) {}
        try { syncCcDuePreview(); } catch (e) {}
        openModalCompat(modalCuentaCorriente);
    }

    function closeCuentaCorrienteModal() {
        try { closeModalCompat(modalCuentaCorriente); } catch (e) {}
        if (!ccModalAccepted) {
            if (ccContext === 'cambio') {
                cambioOnAccount = !!ccPrevCambioOnAccount;
                cambioPaidAmount = parseFloat(ccPrevCambioPaidAmount || 0) || 0;
            } else {
                ventaOnAccount = !!ccPrevOnAccount;
                ventaPaidAmount = parseFloat(ccPrevPaidAmount || 0) || 0;
            }
        }
        ccContext = 'sale';
        ccModalAccepted = false;
    }

    function acceptCuentaCorriente() {
        const total = parseNumeroFlexible(ccTargetTotal || 0);
        let paid = parseMoneyInputARS(ccPaid?.value || 0);
        if (!isFinite(paid) || paid < 0) paid = 0;
        if (paid > total) paid = total;

        try { window.montoAbonado = paid; } catch (e) {}

        ccModalAccepted = true;
        if (ccContext === 'cambio') {
            cambioOnAccount = true;
            cambioPaidAmount = paid;
        } else {
            ventaOnAccount = true;
            ventaUseInstallments = false;
            ventaPaidAmount = paid;
        }
        closeCuentaCorrienteModal();
        try { updatePaymentButtonsVisual(); } catch (e) {}
        try { syncCuentaCorrienteInlinePreview(); } catch (e) {}
        try { computeTicketTotals(); } catch (e) {}
    }

    function setPagoCompletoCambio() {
        cambioOnAccount = false;
        cambioPaidAmount = 0;
        try {
            if (panelPagoClienteCambio) panelPagoClienteCambio.classList.remove('hidden');
        } catch (e) {
        }
    }

    function isModalEl(el) {
        try {
            if (!el) return false;
            const id = String(el.id || '');
            if (id.startsWith('modal-')) return true;
            const cls = el.classList;
            if (cls && cls.contains('fixed') && cls.contains('inset-0')) return true;
        } catch (e) {
        }
        return false;
    }

    function showOnlyInsideHome(elToShow) {
        if (!home) return;
        try {
            const children = Array.from(home.children || []);
            children.forEach(ch => {
                if (!ch || !(ch instanceof HTMLElement)) return;
                // Nunca destapar modales desde helpers de navegaci√≥n
                if (isModalEl(ch)) {
                    ch.classList.add('hidden');
                    return;
                }
                if (elToShow && ch === elToShow) ch.classList.remove('hidden');
                else ch.classList.add('hidden');
            });
            home.classList.remove('hidden');
        } catch (e) {
        }
    }

    function showHomeAll() {
        if (!home) return;
        try {
            const children = Array.from(home.children || []);
            children.forEach(ch => {
                if (!ch || !(ch instanceof HTMLElement)) return;
                // Nunca destapar modales desde helpers de navegaci√≥n
                if (isModalEl(ch)) {
                    ch.classList.add('hidden');
                    return;
                }
                if (ch === flujo || ch === vistaRealizarCambio) ch.classList.add('hidden');
                else ch.classList.remove('hidden');
            });
            home.classList.remove('hidden');
        } catch (e) {
        }
        if (flujo && (!home || !home.contains(flujo))) flujo.classList.add('hidden');
        if (vistaRealizarCambio && (!home || !home.contains(vistaRealizarCambio))) vistaRealizarCambio.classList.add('hidden');
    }

    function showFlujo() {
        if (home && flujo && home.contains(flujo)) {
            showOnlyInsideHome(flujo);
        } else {
            if (home) home.classList.add('hidden');
            if (flujo) flujo.classList.remove('hidden');
            if (vistaRealizarCambio) vistaRealizarCambio.classList.add('hidden');
        }
    }

    function showCambio() {
        if (home && vistaRealizarCambio && home.contains(vistaRealizarCambio)) {
            showOnlyInsideHome(vistaRealizarCambio);
        } else {
            if (home) home.classList.add('hidden');
            if (flujo) flujo.classList.add('hidden');
            if (vistaRealizarCambio) vistaRealizarCambio.classList.remove('hidden');
        }
    }

    function setCambioCustomerContext() {
        currentCustomerContext = 'cambio';
    }

    function computeNextTicketPreview() {
        try {
            const list = Array.isArray(salesCache) ? salesCache : [];
            const maxId = list.reduce((acc, s) => Math.max(acc, parseInt(s?.id || 0, 10) || 0), 0);
            const n = (maxId || 0) + 1;
            return '#' + String(n).padStart(4, '0');
        } catch (e) {
        }
        return '#0000';
    }

    function computeGiftCode(ticketStr, itemsList) {
        const t = String(ticketStr || '').trim();
        const digits = (t.match(/\d+/g) || []).join('') || '0000';
        const letters = [];
        const seen = new Set();
        (Array.isArray(itemsList) ? itemsList : []).forEach(it => {
            const name = String(it?.nombre || it?.product_name || '').trim();
            let ch = '';
            for (let i = 0; i < name.length; i++) {
                const c = name[i];
                if (/^[a-z0-9]$/i.test(c)) { ch = c.toUpperCase(); break; }
            }
            if (!ch) return;
            if (seen.has(ch)) return;
            seen.add(ch);
            letters.push(ch);
        });
        const suffix = letters.slice(0, 6).join('') || 'X';
        return 'R' + digits + suffix;
    }

    function renderGiftUi() {
        if (inputIsGift) inputIsGift.checked = !!ventaIsGift;
        if (!giftCodeWrap || !giftCodeEl) return;
        const show = !!ventaIsGift;
        giftCodeWrap.classList.toggle('hidden', !show);
        giftCodeEl.textContent = (ventaGiftCode || '‚Äî');
    }

    function renderGiftUiCambio() {
        if (inputIsGiftCambio) inputIsGiftCambio.checked = !!cambioIsGift;
        if (!giftCodeWrapCambio || !giftCodeElCambio) return;
        const show = !!cambioIsGift;
        giftCodeWrapCambio.classList.toggle('hidden', !show);
        giftCodeElCambio.textContent = (cambioGiftCode || '‚Äî');
    }

    function maybeRefreshGiftCode() {
        if (!ventaIsGift) {
            renderGiftUi();
            return;
        }
        const ticketBasis = editTicketId ? String(editTicketId) : computeNextTicketPreview();
        const items = getCartItems();
        ventaGiftCode = computeGiftCode(ticketBasis, items);
        renderGiftUi();
    }

    function computeNextTicketPreviewExchangeSale() {
        try {
            const list = Array.isArray(salesCache) ? salesCache : [];
            const maxId = list.reduce((acc, s) => Math.max(acc, parseInt(s?.id || 0, 10) || 0), 0);
            const n = (maxId || 0) + 2;
            return '#' + String(n).padStart(4, '0');
        } catch (e) {
        }
        return '#0000';
    }

    function computeNextCambioTicketPreview() {
        try {
            const list = Array.isArray(salesCache) ? salesCache : [];
            let maxN = 0;
            list.forEach(s => {
                const t = String(s?.ticket || '').trim();
                if (!t.startsWith('#C')) return;
                const digits = (t.slice(2).match(/\d+/g) || []).join('');
                const n = parseInt(digits || '0', 10) || 0;
                if (n > maxN) maxN = n;
            });
            return '#C' + String(maxN + 1).padStart(4, '0');
        } catch (e) {
        }
        return '#C0001';
    }

    function computeNextVentaTicketPreview() {
        try {
            const list = Array.isArray(salesCache) ? salesCache : [];
            let maxN = 0;
            list.forEach(s => {
                const t = String(s?.ticket || '').trim();
                if (!t.startsWith('#') || t.startsWith('#C')) return;
                const digits = (t.slice(1).match(/\d+/g) || []).join('');
                const n = parseInt(digits || '0', 10) || 0;
                if (n > maxN) maxN = n;
            });
            return '#' + String(maxN + 1).padStart(4, '0');
        } catch (e) {
        }
        return '#0001';
    }

    function maybeRefreshCambioGiftCode() {
        if (!cambioIsGift) {
            renderGiftUiCambio();
            return;
        }
        const ticketBasis = computeNextVentaTicketPreview();
        const itemsOut = getCartItemsCambioVenta();
        cambioGiftCode = computeGiftCode(ticketBasis, itemsOut);
        renderGiftUiCambio();
    }

    function setGiftMode(enabled) {
        ventaIsGift = !!enabled;
        if (!ventaIsGift) ventaGiftCode = '';
        maybeRefreshGiftCode();
        renderGiftUi();
    }

    function setGiftModeCambio(enabled) {
        cambioIsGift = !!enabled;
        if (!cambioIsGift) cambioGiftCode = '';
        maybeRefreshCambioGiftCode();
        renderGiftUiCambio();
    }

    function updateCambioViewButtons() {
        if (!btnViewGridCambio || !btnViewListCambio) return;
        const active = 'bg-indigo-600 text-white border-indigo-600';
        const inactive = 'bg-gray-50 text-gray-700 border-gray-200';
        if (cambioViewMode === 'list') {
            btnViewListCambio.className = 'px-2.5 py-1 rounded-md border hover:bg-gray-100 ' + active;
            btnViewGridCambio.className = 'px-2.5 py-1 rounded-md border hover:bg-gray-100 ' + inactive;
        } else {
            btnViewGridCambio.className = 'px-2.5 py-1 rounded-md border hover:bg-gray-100 ' + active;
            btnViewListCambio.className = 'px-2.5 py-1 rounded-md border hover:bg-gray-100 ' + inactive;
        }
    }

    function setCambioViewMode(mode, persist) {
        cambioViewMode = (mode === 'list') ? 'list' : 'grid';
        if (persist) {
            try { window.localStorage.setItem('cambio_view_mode', cambioViewMode); } catch (e) {}
        }
        updateCambioViewButtons();
        if (cambioInvData) renderCambioProductsView(cambioInvData);
    }

    function updateCambioVentaViewButtons() {
        if (!btnViewGridCambioVenta || !btnViewListCambioVenta) return;
        const active = 'bg-indigo-600 text-white border-indigo-600';
        const inactive = 'bg-gray-50 text-gray-700 border-gray-200';
        if (cambioVentaViewMode === 'list') {
            btnViewListCambioVenta.className = 'px-2.5 py-1 rounded-md border hover:bg-gray-100 ' + active;
            btnViewGridCambioVenta.className = 'px-2.5 py-1 rounded-md border hover:bg-gray-100 ' + inactive;
        } else {
            btnViewGridCambioVenta.className = 'px-2.5 py-1 rounded-md border hover:bg-gray-100 ' + active;
            btnViewListCambioVenta.className = 'px-2.5 py-1 rounded-md border hover:bg-gray-100 ' + inactive;
        }
    }

    function setCambioVentaViewMode(mode, persist) {
        cambioVentaViewMode = (mode === 'list') ? 'list' : 'grid';
        if (persist) {
            try { window.localStorage.setItem('cambio_venta_view_mode', cambioVentaViewMode); } catch (e) {}
        }
        updateCambioVentaViewButtons();
        if (cambioVentaInvData) renderCambioVentaProductsView(cambioVentaInvData);
    }

    function getCambioFilterElements() {
        if (cambioViewMode === 'list') {
            return Array.from(tablaProductosCambioBody ? tablaProductosCambioBody.querySelectorAll('tr[data-product-id]') : []);
        }
        return Array.from(gridProductosCambio ? gridProductosCambio.querySelectorAll('.btn-producto-cambio') : []);
    }

    function applyCambioProductsFilter() {
        const list = getCambioFilterElements();
        const categoria = String(selectedCategoriaCambio || '').trim();
        const q = String(cambioSearchQuery || '').trim().toLowerCase();

        let hasExactCodigo = false;
        if (q) {
            try {
                hasExactCodigo = list.some(el => {
                    const ci = String(el?.getAttribute('data-codigo-interno') || '').trim().toLowerCase();
                    return ci && ci === q;
                });
            } catch (e) {
            }
        }
        list.forEach(el => {
            const cat = String(el?.getAttribute('data-categoria') || '').trim();
            const nombre = String(el?.getAttribute('data-nombre') || el?.textContent || '').trim();
            const codigoInterno = String(el?.getAttribute('data-codigo-interno') || '').trim();
            const haystack = (nombre + ' ' + codigoInterno).toLowerCase();
            const okCat = (!categoria || categoria === 'Todos' || cat === categoria);
            const okQ = (!q || (hasExactCodigo ? (String(codigoInterno || '').trim().toLowerCase() === q) : (haystack.indexOf(q) >= 0)));
            if (okCat && okQ) el.classList.remove('hidden');
            else el.classList.add('hidden');
        });
    }

    function getCambioVentaFilterElements() {
        if (cambioVentaViewMode === 'list') {
            return Array.from(tablaProductosCambioVentaBody ? tablaProductosCambioVentaBody.querySelectorAll('tr[data-product-id]') : []);
        }
        return Array.from(gridProductosCambioVenta ? gridProductosCambioVenta.querySelectorAll('.btn-producto-cambio-venta') : []);
    }

    function applyCambioVentaProductsFilter() {
        const list = getCambioVentaFilterElements();
        const categoria = String(selectedCategoriaCambioVenta || '').trim();
        const q = String(cambioVentaSearchQuery || '').trim().toLowerCase();

        let hasExactCodigo = false;
        if (q) {
            try {
                hasExactCodigo = list.some(el => {
                    const ci = String(el?.getAttribute('data-codigo-interno') || '').trim().toLowerCase();
                    return ci && ci === q;
                });
            } catch (e) {
            }
        }
        list.forEach(el => {
            const cat = String(el?.getAttribute('data-categoria') || '').trim();
            const nombre = String(el?.getAttribute('data-nombre') || el?.textContent || '').trim();
            const codigoInterno = String(el?.getAttribute('data-codigo-interno') || '').trim();
            const haystack = (nombre + ' ' + codigoInterno).toLowerCase();
            const okCat = (!categoria || categoria === 'Todos' || cat === categoria);
            const okQ = (!q || (hasExactCodigo ? (String(codigoInterno || '').trim().toLowerCase() === q) : (haystack.indexOf(q) >= 0)));
            if (okCat && okQ) el.classList.remove('hidden');
            else el.classList.add('hidden');
        });
    }

    function agregarProductoDesdeElCambio(el) {
        const nombre = el.getAttribute('data-nombre') || 'Producto';
        const precio = el.getAttribute('data-precio') || '0';
        const productId = el.getAttribute('data-product-id') || '';
        agregarProductoAlCarritoCambio(nombre, precio, { productId: productId });
    }

    function agregarProductoDesdeElCambioVenta(el) {
        const nombre = el.getAttribute('data-nombre') || 'Producto';
        const precio = el.getAttribute('data-precio') || '0';
        const productId = el.getAttribute('data-product-id') || '';
        agregarProductoAlCarritoCambioVenta(nombre, precio, { productId: productId });
    }

    function renderCambioProductsView(data) {
        if (!gridProductosCambio) return;
        const products = Array.isArray(data?.products) ? data.products : [];
        const lots = Array.isArray(data?.lots) ? data.lots : [];

        if (cambioViewMode === 'list') {
            if (tablaProductosCambioWrap) tablaProductosCambioWrap.classList.remove('hidden');
            if (gridProductosCambio) gridProductosCambio.classList.add('hidden');
            if (tablaProductosCambioBody) tablaProductosCambioBody.innerHTML = '';
            if (!products.length || !tablaProductosCambioBody) {
                if (tablaProductosCambioBody) tablaProductosCambioBody.innerHTML = '<tr><td colspan="5" class="px-3 py-4 text-sm text-gray-500">No hay productos en inventario.</td></tr>';
                return;
            }
            products.slice(0, 200).forEach(p => {
                const stock = stockDisponiblePorProducto(lots, p?.id);
                const price = parseFloat(p?.sale_price || p?.price || 0) || 0;
                const cat = String(p?.category?.name || p?.category_name || '').trim();
                const codigoInterno = String(p?.codigo_interno || p?.internal_code || '').trim();
                const desc = String(p?.description || '').trim();
                const infoTitle = 'C√≥digo interno: ' + (codigoInterno || '‚Äî') + (desc ? ('\nDescripci√≥n: ' + desc) : '');
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-indigo-50 cursor-pointer';
                tr.tabIndex = 0;
                tr.setAttribute('data-product-id', String(p?.id || ''));
                tr.setAttribute('data-nombre', String(p?.name || 'Producto'));
                tr.setAttribute('data-precio', String(price.toFixed(2)));
                tr.setAttribute('data-categoria', cat);
                tr.setAttribute('data-codigo-interno', codigoInterno);
                const stockCls = stockColorClass(stock);
                tr.innerHTML = ''
                    + '<td class="px-2 py-2 text-gray-800">' + String(p?.name || 'Producto') + '</td>'
                    + '<td class="px-2 py-2 text-gray-500">' + (cat || '‚Äî') + '</td>'
                    + '<td class="px-2 py-2 text-right text-gray-900 font-medium">' + formatearMoneda(price) + '</td>'
                    + '<td class="px-2 py-2 text-right ' + stockCls + ' font-medium">' + String((isNaN(stock) ? 0 : stock).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</td>'
                    + '<td class="px-2 py-2 text-center">'
                    + '  <button type="button" class="h-7 w-7 inline-flex items-center justify-center rounded-md bg-gray-100 text-gray-600 hover:bg-gray-200" data-action="info" title="' + escapeHtml(infoTitle) + '">'
                    + '    <i class="fas fa-info-circle text-[12px]"></i>'
                    + '  </button>'
                    + '</td>';

                tr.addEventListener('click', function (e) {
                    const infoBtn = e && e.target ? e.target.closest('button[data-action="info"]') : null;
                    if (infoBtn) {
                        try { e.preventDefault(); } catch (ex) {}
                        try { e.stopPropagation(); } catch (ex) {}
                        return;
                    }
                    agregarProductoDesdeElCambio(tr);
                });
                tr.addEventListener('keydown', function (e) {
                    if (!e) return;
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        agregarProductoDesdeElCambio(tr);
                    }
                });

                tablaProductosCambioBody.appendChild(tr);
            });
        } else {
            if (tablaProductosCambioWrap) tablaProductosCambioWrap.classList.add('hidden');
            if (gridProductosCambio) gridProductosCambio.classList.remove('hidden');
        }
        applyCambioProductsFilter();
    }

    function renderCambioVentaProductsView(data) {
        if (!gridProductosCambioVenta) return;
        const products = Array.isArray(data?.products) ? data.products : [];
        const lots = Array.isArray(data?.lots) ? data.lots : [];

        if (cambioVentaViewMode === 'list') {
            if (tablaProductosCambioVentaWrap) tablaProductosCambioVentaWrap.classList.remove('hidden');
            if (gridProductosCambioVenta) gridProductosCambioVenta.classList.add('hidden');
            if (tablaProductosCambioVentaBody) tablaProductosCambioVentaBody.innerHTML = '';
            if (!products.length || !tablaProductosCambioVentaBody) {
                if (tablaProductosCambioVentaBody) tablaProductosCambioVentaBody.innerHTML = '<tr><td colspan="5" class="px-3 py-4 text-sm text-gray-500">No hay productos en inventario.</td></tr>';
                return;
            }
            products.slice(0, 200).forEach(p => {
                const stock = stockDisponiblePorProducto(lots, p?.id);
                const price = parseFloat(p?.sale_price || p?.price || 0) || 0;
                const cat = String(p?.category?.name || p?.category_name || '').trim();
                const codigoInterno = String(p?.codigo_interno || p?.internal_code || '').trim();
                const desc = String(p?.description || '').trim();
                const infoTitle = 'C√≥digo interno: ' + (codigoInterno || '‚Äî') + (desc ? ('\nDescripci√≥n: ' + desc) : '');
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-indigo-50 cursor-pointer';
                tr.tabIndex = 0;
                tr.setAttribute('data-product-id', String(p?.id || ''));
                tr.setAttribute('data-nombre', String(p?.name || 'Producto'));
                tr.setAttribute('data-precio', String(price.toFixed(2)));
                tr.setAttribute('data-categoria', cat);
                tr.setAttribute('data-codigo-interno', codigoInterno);
                const stockCls = stockColorClass(stock);
                tr.innerHTML = ''
                    + '<td class="px-2 py-2 text-gray-800">' + String(p?.name || 'Producto') + '</td>'
                    + '<td class="px-2 py-2 text-gray-500">' + (cat || '‚Äî') + '</td>'
                    + '<td class="px-2 py-2 text-right text-gray-900 font-medium">' + formatearMoneda(price) + '</td>'
                    + '<td class="px-2 py-2 text-right ' + stockCls + ' font-medium">' + String((isNaN(stock) ? 0 : stock).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</td>'
                    + '<td class="px-2 py-2 text-center">'
                    + '  <button type="button" class="h-7 w-7 inline-flex items-center justify-center rounded-md bg-gray-100 text-gray-600 hover:bg-gray-200" data-action="info" title="' + escapeHtml(infoTitle) + '">'
                    + '    <i class="fas fa-info-circle text-[12px]"></i>'
                    + '  </button>'
                    + '</td>';

                tr.addEventListener('click', function (e) {
                    const infoBtn = e && e.target ? e.target.closest('button[data-action="info"]') : null;
                    if (infoBtn) {
                        try { e.preventDefault(); } catch (ex) {}
                        try { e.stopPropagation(); } catch (ex) {}
                        return;
                    }
                    agregarProductoDesdeElCambioVenta(tr);
                });
                tr.addEventListener('keydown', function (e) {
                    if (!e) return;
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        agregarProductoDesdeElCambioVenta(tr);
                    }
                });

                tablaProductosCambioVentaBody.appendChild(tr);
            });
        } else {
            if (tablaProductosCambioVentaWrap) tablaProductosCambioVentaWrap.classList.add('hidden');
            if (gridProductosCambioVenta) gridProductosCambioVenta.classList.remove('hidden');
        }
        applyCambioVentaProductsFilter();
    }

    function getCartItemsCambio() {
        if (!tablaCarritoCambio) return [];
        const rows = Array.from(tablaCarritoCambio.querySelectorAll('tbody tr')).filter(tr => tr && tr.id !== 'carrito-cambio-empty-row');
        return rows.map(tr => {
            const nombre = String(tr.querySelector('td')?.textContent || '').trim() || 'Producto';
            const precio = parseNumeroFlexible(tr.querySelector('.input-precio-cambio')?.value || '0') || 0;
            const cantidad = parseNumeroFlexible(tr.querySelector('.input-cantidad-cambio')?.value || '0') || 0;
            const descuento = parseNumeroFlexible(tr.querySelector('.input-descuento-cambio')?.value || '0') || 0;
            const subtotal = parseNumeroFlexible(tr.querySelector('.input-subtotal-cambio')?.value || '0') || 0;
            const productId = String(tr.getAttribute('data-product-id') || '').trim();
            return {
                product_id: productId,
                nombre,
                precio,
                cantidad,
                descuento,
                subtotal,
                direction: 'in'
            };
        }).filter(it => (parseFloat(it.cantidad || 0) || 0) > 0);
    }

    function getCartItemsCambioVenta() {
        if (!tablaCarritoCambioVenta) return [];
        const rows = Array.from(tablaCarritoCambioVenta.querySelectorAll('tbody tr')).filter(tr => tr && tr.id !== 'carrito-cambio-venta-empty-row');
        return rows.map(tr => {
            const nombre = String(tr.querySelector('td')?.textContent || '').trim() || 'Producto';
            const precio = parseNumeroFlexible(tr.querySelector('.input-precio-cambio-venta')?.value || '0') || 0;
            const cantidad = parseNumeroFlexible(tr.querySelector('.input-cantidad-cambio-venta')?.value || '0') || 0;
            const descuento = parseNumeroFlexible(tr.querySelector('.input-descuento-cambio-venta')?.value || '0') || 0;
            const subtotal = parseNumeroFlexible(tr.querySelector('.input-subtotal-cambio-venta')?.value || '0') || 0;
            const productId = String(tr.getAttribute('data-product-id') || '').trim();
            return {
                product_id: productId,
                nombre,
                precio,
                cantidad,
                descuento,
                subtotal,
                direction: 'out'
            };
        }).filter(it => (parseFloat(it.cantidad || 0) || 0) > 0);
    }

    function getCambioPaymentMethod() {
        const checked = document.querySelector('input[name="cambio_forma_pago"]:checked');
        if (!checked) return 'Efectivo';
        const label = checked.closest('label');
        const txt = String(label?.textContent || '').replace(/\s+/g, ' ').trim();
        if (txt.toLowerCase().includes('transferencia')) return 'Transferencia';
        if (txt.toLowerCase().includes('d√©bito') || txt.toLowerCase().includes('debito')) return 'D√©bito';
        if (txt.toLowerCase().includes('cr√©dito') || txt.toLowerCase().includes('credito')) return 'Cr√©dito';
        return 'Efectivo';
    }

    function historialAccionesHtml(ticket) {
        const t = String(ticket || '').trim();
        return ''
            + '<div class="relative inline-block text-left">'
            +   '<button type="button" class="btn-mov-menu inline-flex items-center justify-center h-7 w-7 rounded-full hover:bg-gray-100" data-ticket="' + t + '">' 
            +     '<i class="fas fa-ellipsis-v text-gray-500 text-xs"></i>'
            +   '</button>'
            +   '<div class="menu-mov-acciones hidden origin-top-right absolute right-0 mt-1 w-40 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10">'
            +     '<div class="py-1 text-[11px]">'
            +       '<button type="button" class="w-full text-left px-3 py-1.5 hover:bg-gray-100 opcion-ver-ticket" data-ticket="' + t + '">Ver / editar ticket</button>'
            +       '<button type="button" class="w-full text-left px-3 py-1.5 text-red-600 hover:bg-red-50 opcion-eliminar-ticket" data-ticket="' + t + '">Eliminar ticket</button>'
            +     '</div>'
            +   '</div>'
            + '</div>';
    }

    let salesCache = [];
    let salesLoaded = false;
    let salesLoadPromise = null;

    function isoFromDate(d) {
        const y = d.getFullYear();
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return y + '-' + m + '-' + day;
    }

    function apiListSales(range) {
        const qs = [];
        if (range && range.from) qs.push('from=' + encodeURIComponent(isoFromDate(range.from)));
        if (range && range.to) qs.push('to=' + encodeURIComponent(isoFromDate(range.to)));
        qs.push('include_replaced=1');
        qs.push('limit=20000');
        const url = apiPath('/sales/api/sales' + (qs.length ? ('?' + qs.join('&')) : ''));
        return fetch(url, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => (data && data.ok && Array.isArray(data.items)) ? data.items : []);
    }

    function fetchJsonSafe(url, options) {
        return fetch(url, options).then(async r => {
            const ct = String(r.headers.get('content-type') || '').toLowerCase();
            if (ct.includes('application/json')) {
                try {
                    return await r.json();
                } catch (e) {
                }
            }
            let text = '';
            try {
                text = await r.text();
            } catch (e) {
                text = '';
            }
            const msg = String(text || '').trim() || ('HTTP ' + String(r.status || ''));
            return { ok: false, error: 'non_json_response', message: msg, status: r.status };
        });
    }

    function apiCreateSale(payload) {
        return fetchJsonSafe(apiPath('/sales/api/sales'), {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });
    }

    function apiCreateExchange(payload) {
        return fetch(apiPath('/sales/api/exchanges'), {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        }).then(r => r.json());
    }

    function apiDebtSummary(customer) {
        const c = customer && typeof customer === 'object' ? customer : null;
        const cid = c ? String(c.id || '').trim() : '';
        const cname = c ? String(c.name || '').trim() : '';
        const qs = [];
        if (cid) qs.push('customer_id=' + encodeURIComponent(cid));
        if (!cid && cname) qs.push('customer_name=' + encodeURIComponent(cname));
        const url = apiPath('/sales/api/sales/debt-summary' + (qs.length ? ('?' + qs.join('&')) : ''));
        return fetch(url, { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => {
                if (!data || data.ok !== true) return { saldo: 0, dias: 0 };
                return {
                    saldo: (parseFloat(data.saldo || 0) || 0),
                    dias: (parseInt(data.dias || 0, 10) || 0)
                };
            })
            .catch(() => ({ saldo: 0, dias: 0 }));
    }

    function apiUpdateSale(ticket, payload) {
        return fetchJsonSafe(apiPath('/sales/api/sales/' + encodeURIComponent(String(ticket || '').trim())), {
            method: 'PUT',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload || {}),
        });
    }

    function apiDeleteSale(ticket) {
        const url = apiPath('/sales/api/sales/' + encodeURIComponent(String(ticket || '').trim()));
        return fetch(url, {
            method: 'DELETE',
            credentials: 'same-origin',
        }).then(function (r) {
            if (!r) return { ok: false, error: 'network' };
            if (r.status === 204) return { ok: true };
            return fetchJsonSafe(url, { method: 'DELETE', credentials: 'same-origin' });
        }).catch(function () {
            return { ok: false, error: 'network' };
        });
    }

    function loadSalesFromServer() {
        if (salesLoadPromise) return salesLoadPromise;
        let range = null;
        try {
            range = parseVentasRangeInputToDates();
        } catch (e) {
            range = null;
        }
        // Si el usuario no seleccion√≥ rango, traer historial completo (sin filtro por fecha)

        salesLoadPromise = apiListSales(range).then(items => {
            salesCache = Array.isArray(items) ? items : [];
            salesLoaded = true;
            return salesCache;
        }).catch(() => {
            salesCache = [];
            salesLoaded = true;
            return [];
        });
        return salesLoadPromise;
    }

    function refreshVentasFromServerForRange() {
        salesLoadPromise = null;
        salesLoaded = false;
        return Promise.resolve(loadSalesFromServer()).then(function (items) {
            salesCache = Array.isArray(items) ? items : [];
            salesLoaded = true;
            initVentasMultiPagoFromSales(salesCache);
            initVentasMultiEmployeeFromData(employeesCache, salesCache);
            renderHistorialFromCache();
            applyVentasFilters();
            initKpisFromSales();
            return salesCache;
        }).catch(function () {
            salesCache = [];
            salesLoaded = true;
            renderHistorialFromCache();
            applyVentasFilters();
            initKpisFromSales();
            return [];
        });
    }

    function leerSales() {
        if (salesLoaded) return salesCache;
        return loadSalesFromServer();
    }

    function findSaleInCache(ticket) {
        const t = String(ticket || '').trim();
        return (Array.isArray(salesCache) ? salesCache : []).find(s => String(s?.ticket || '').trim() === t) || null;
    }

    function historialTipoLabelFromSale(s) {
        const tp = String(s?.type || s?.sale_type || 'Venta').trim() || 'Venta';
        if (tp === 'Cambio') return 'Cambio';
        if (tp === 'CobroCC' || tp === 'CobroCuota' || tp === 'CobroVenta') return '';

        // Hechos comerciales (Venta)
        if (tp !== 'Venta') return '';
        const isInst = !!(s && (s.is_installments === true || s.is_installments === 1 || s.is_installments === '1'));
        if (isInst) return 'Venta SC';

        const due = parseFloat(s?.due_amount || 0) || 0;
        const onAcc = !!(s && (s.on_account === true || s.on_account === 1 || s.on_account === '1'));
        if (onAcc || due > 0) return 'Venta CC';
        return 'Venta completa';
    }

    function statusBadgeHtml(tipoLabel) {
        const tp = String(tipoLabel || '').trim() || 'Venta';
        if (tp === 'Cambio') return '<span class="px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 text-[11px]">Cambio</span>';
        if (tp === 'Venta SC') return '<span class="px-2 py-0.5 rounded-full bg-indigo-50 text-indigo-700 text-[11px]">Venta SC</span>';
        if (tp === 'Venta CC') return '<span class="px-2 py-0.5 rounded-full bg-amber-50 text-amber-800 text-[11px]">Venta CC</span>';
        if (tp === 'Venta completa') return '<span class="px-2 py-0.5 rounded-full bg-green-50 text-green-700 text-[11px]">Venta completa</span>';
        return '<span class="px-2 py-0.5 rounded-full bg-green-50 text-green-700 text-[11px]">Venta</span>';
    }

    function ventasIsoToDmy(iso) {
        const s = String(iso || '').trim();
        if (!s || !/^\d{4}-\d{2}-\d{2}$/.test(s)) return '';
        const y = s.slice(0, 4);
        const m = s.slice(5, 7);
        const d = s.slice(8, 10);
        return d + '/' + m + '/' + y;
    }

    function closeVentasFilterMenus() {
        if (menuVentasFilterEmployee) menuVentasFilterEmployee.classList.add('hidden');
        if (menuVentasFilterPago) menuVentasFilterPago.classList.add('hidden');
        if (menuVentasFilterTipo) menuVentasFilterTipo.classList.add('hidden');
    }

    function toggleVentasFilterMenu(menuEl) {
        if (!menuEl) return;
        const open = !menuEl.classList.contains('hidden');
        closeVentasFilterMenus();
        if (!open) menuEl.classList.remove('hidden');
    }

    const ventasMultiFilters = {
        employee: { options: [], selected: new Set(), allLabel: 'Todos', noneLabel: 'Ninguno' },
        pago: { options: [], selected: new Set(), allLabel: 'Todas', noneLabel: 'Ninguna' },
        tipo: { options: [], selected: new Set(), allLabel: 'Todas', noneLabel: 'Ninguna' },
    };

    function ventasMultiMatches(value, filterKey) {
        const f = ventasMultiFilters[filterKey];
        if (!f) return true;
        const opts = Array.isArray(f.options) ? f.options : [];
        const total = opts.length;
        const sel = f.selected;
        if (!total) return true;
        if (!sel || sel.size === 0) return false;
        if (sel.size >= total) return true;
        return sel.has(String(value || '').trim());
    }

    function normPaymentMethodKey(v) {
        const s = String(v || '').trim().toLowerCase();
        if (!s) return '';
        const noAcc = s.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
        if (noAcc.includes('efectivo')) return 'efectivo';
        if (noAcc.includes('transfer')) return 'transferencia';
        if (noAcc.includes('credito')) return 'credito';
        if (noAcc.includes('debito')) return 'debito';
        return noAcc;
    }

    function displayPaymentMethod(v) {
        const k = normPaymentMethodKey(v);
        if (k === 'efectivo') return 'Efectivo';
        if (k === 'debito') return 'D√©bito';
        if (k === 'credito') return 'Cr√©dito';
        if (k === 'transferencia') return 'Transferencia';
        return String(v || '').trim() || 'Efectivo';
    }

    function renderVentasMultiMenu(filterKey, itemsEl, labelEl) {
        const f = ventasMultiFilters[filterKey];
        if (!f || !itemsEl) return;
        const opts = Array.isArray(f.options) ? f.options : [];

        const isAll = (f.selected.size >= opts.length) && opts.length > 0;

        const updateLabel = function () {
            const total = opts.length;
            const cnt = f.selected.size;
            if (!labelEl) return;
            if (cnt === 0) { labelEl.textContent = f.noneLabel; return; }
            if (cnt >= total) { labelEl.textContent = f.allLabel; return; }
            labelEl.textContent = String(cnt) + ' seleccionados';
        };

        const buildRow = function (id, text, checked) {
            const div = document.createElement('label');
            div.className = 'px-3 py-1.5 flex items-center gap-2 text-xs text-gray-700 hover:bg-gray-50 cursor-pointer';
            div.innerHTML = ''
                + '<input type="checkbox" class="ventas-multi-check" data-filter="' + escapeHtml(filterKey) + '" data-value="' + escapeHtml(id) + '" ' + (checked ? 'checked' : '') + ' />'
                + '<span class="truncate">' + escapeHtml(text) + '</span>';
            return div;
        };

        itemsEl.innerHTML = '';
        itemsEl.appendChild(buildRow('__ALL__', f.allLabel, isAll));
        opts.forEach(o => {
            const v = String(o.value || '').trim();
            const t = String(o.label || '').trim() || v;
            itemsEl.appendChild(buildRow(v, t, f.selected.has(v)));
        });
        updateLabel();
    }

    function setVentasMultiOptions(filterKey, options) {
        const f = ventasMultiFilters[filterKey];
        if (!f) return;
        f.options = Array.isArray(options) ? options.slice() : [];
        f.selected = new Set(f.options.map(o => String(o.value)));
    }

    function initVentasMultiFiltersStatic() {
        setVentasMultiOptions('tipo', [
            { value: 'Venta completa', label: 'Venta completa' },
            { value: 'Venta CC', label: 'Venta CC' },
            { value: 'Venta SC', label: 'Venta SC' },
            { value: 'Cambio', label: 'Cambio' },
        ]);
        renderVentasMultiMenu('tipo', itemsVentasFilterTipo, labelVentasFilterTipo);
    }

    function initVentasMultiPagoFromSales(sales) {
        const preferred = ['efectivo', 'transferencia', 'debito', 'credito'];
        const opts = preferred.map(v => {
            const label = (v === 'efectivo') ? 'Efectivo'
                : (v === 'transferencia') ? 'Transferencia'
                : (v === 'debito') ? 'D√©bito'
                : (v === 'credito') ? 'Cr√©dito'
                : v;
            return { value: v, label: label };
        });
        setVentasMultiOptions('pago', opts);
        renderVentasMultiMenu('pago', itemsVentasFilterPago, labelVentasFilterPago);
    }

    let employeesCache = [];

    function _employeeDisplayName(e) {
        const row = e && typeof e === 'object' ? e : {};
        const nm = String(row.name || '').trim();
        if (nm) return nm;
        const full = (String(row.first_name || '').trim() + ' ' + String(row.last_name || '').trim()).trim();
        return full || String(row.email || '').trim() || 'Empleado';
    }

    function initVentasMultiEmployeeFromData(empleados, sales) {
        const emps = Array.isArray(empleados) ? empleados : [];
        const items = Array.isArray(sales) ? sales : [];

        const empOpts = emps
            .slice()
            .filter(e => String(e?.id || '').trim())
            .sort((a, b) => _employeeDisplayName(a).localeCompare(_employeeDisplayName(b), 'es'))
            .map(e => ({ value: 'e:' + String(e?.id || '').trim(), label: _employeeDisplayName(e) }));

        const userMap = new Map();
        items.forEach(s => {
            const rid = String(s?.responsible_id || '').trim();
            if (!rid || !rid.startsWith('u:')) return;
            const nm = String(s?.responsible_name || '').trim() || rid;
            if (!userMap.has(rid)) userMap.set(rid, nm);
        });
        const userOpts = Array.from(userMap.entries())
            .map(([value, label]) => ({ value: String(value), label: String(label) }))
            .sort((a, b) => String(a.label).localeCompare(String(b.label), 'es'));

        const withEmpty = [{ value: '__EMPTY__', label: '‚Äî' }, ...empOpts, ...userOpts];
        setVentasMultiOptions('employee', withEmpty);
        renderVentasMultiMenu('employee', itemsVentasFilterEmployee, labelVentasFilterEmployee);
    }

    function updateVentasGiftModeUi() {
        try {
            if (ventasColTicketLabel) ventasColTicketLabel.textContent = ventasGiftOnly ? 'C√≥digo Regalo' : 'Ticket';
            if (inputSearchVentasTicket) inputSearchVentasTicket.placeholder = ventasGiftOnly ? 'Buscar por c√≥digo regalo' : 'Buscar por ticket';
        } catch (e) {
        }
    }

    function parseDateToTs(dmy) {
        const s = String(dmy || '').trim();
        if (!s) return 0;
        const m = s.match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
        if (!m) return 0;
        const dd = parseInt(m[1], 10);
        const mm = parseInt(m[2], 10);
        const yy = parseInt(m[3], 10);
        const dt = new Date(yy, mm - 1, dd);
        const ts = dt.getTime();
        return isNaN(ts) ? 0 : ts;
    }

    function renderHistorialFromCache() {
        if (!historialTbody) return;

        const list = (Array.isArray(salesCache) ? salesCache.slice() : [])
            .filter(s => {
                const tipoLabel = historialTipoLabelFromSale(s);
                return !!(tipoLabel && tipoLabel.trim());
            });
        const sortKey = function (s) {
            const iso = String(s?.fecha || '').trim();
            let ts = 0;
            if (iso && /^\d{4}-\d{2}-\d{2}$/.test(iso)) {
                try { ts = new Date(iso + 'T00:00:00').getTime(); } catch (e) { ts = 0; }
            }
            const created = (parseInt(s?.created_at || 0, 10) || 0);
            return { ts: ts || 0, created: created || 0 };
        };

        list.sort((a, b) => {
            const ka = sortKey(a);
            const kb = sortKey(b);
            if ((kb.ts || 0) !== (ka.ts || 0)) return (kb.ts || 0) - (ka.ts || 0);
            return (kb.created || 0) - (ka.created || 0);
        });

        if (!list.length) {
            historialTbody.innerHTML = '<tr><td colspan="8" class="px-4 py-6 text-center text-sm text-gray-500">Todav√≠a no hay movimientos.</td></tr>';
            return;
        }

        historialTbody.innerHTML = '';
        list.forEach(s => {
            const tr = document.createElement('tr');
            const ticket = String(s?.ticket || '');
            const isGift = !!(s && s.is_gift);
            const giftCode = String(s?.gift_code || '');
            tr.setAttribute('data-ticket', ticket);
            tr.setAttribute('data-is-gift', isGift ? '1' : '0');
            tr.setAttribute('data-gift-code', giftCode);
            tr.setAttribute('data-employee-id', String(s?.employee_id || '').trim());
            tr.setAttribute('data-employee-name', String(s?.employee_name || '').trim());
            tr.setAttribute('data-responsible-id', String(s?.responsible_id || '').trim());
            tr.setAttribute('data-responsible-name', String(s?.responsible_name || '').trim());

            let hasVentaLibre = false;
            try {
                if (s && s.has_venta_libre) hasVentaLibre = true;
                const items = Array.isArray(s?.items) ? s.items : [];
                for (const it of items) {
                    const pid = String(it?.product_id || '').trim();
                    const nm = String(it?.nombre || it?.product_name || '').trim().toLowerCase();
                    if (!pid || nm === 'venta libre') { hasVentaLibre = true; break; }
                }
            } catch (e) {}

            const tipoLabel = historialTipoLabelFromSale(s);
            if (!tipoLabel) return;
            tr.setAttribute('data-type', tipoLabel);

            let relatedText = '';
            let relatedTicket = '';
            try {
                relatedText = String(s?.related_label || '').trim();
                relatedTicket = String(s?.related_ticket || '').trim();
                if (relatedText && /(_tmp_|__tmp__)/i.test(relatedText)) relatedText = '';
                if (relatedTicket && /(_tmp_|__tmp__)/i.test(relatedTicket)) relatedTicket = '';
            } catch (e) {
            }
            tr.setAttribute('data-related', relatedText);

            let relatedHtml = '';
            try {
                const relLabel = escapeHtml(relatedText);
                const relTicket = escapeHtml(relatedTicket);
                if (relLabel) {
                    if (relatedTicket) {
                        relatedHtml = '<a href="#" class="mt-0.5 text-[10px] text-indigo-700 hover:underline" onclick="openEditTicket(\'' + relTicket + '\'); return false;">' + relLabel + '</a>';
                    } else {
                        relatedHtml = '<div class="mt-0.5 text-[10px] text-gray-500">' + relLabel + '</div>';
                    }
                }
            } catch (e) {
                relatedHtml = '';
            }

            const statusHtml = ''
                + '<div class="flex flex-col items-center">'
                +   statusBadgeHtml(tipoLabel)
                +   (relatedHtml || '')
                + '</div>';

            let ticketCellHtml = '';
            if (ventasGiftOnly) {
                const g = String(giftCode || '').trim();
                const t = String(ticket || '').trim();
                const primary = g || t || '‚Äî';
                ticketCellHtml = ''
                    + '<div class="text-gray-700 font-mono font-semibold">' + primary + '</div>'
                    + (g && t ? ('<div class="mt-0.5 text-[10px] text-gray-500">' + t + '</div>') : '');
            } else {
                const warn = hasVentaLibre
                    ? '<span class="ml-2 inline-flex items-center" title="Precauci√≥n: este ticket contiene VENTA LIBRE (producto sin registrar / sin costo)"><i class="fas fa-triangle-exclamation text-amber-600"></i></span>'
                    : '';
                ticketCellHtml = '<span>' + String(ticket || '‚Äî') + '</span>' + warn;
            }
            const ticketCellClass = ventasGiftOnly ? 'px-3 py-2' : 'px-3 py-2 text-gray-500';
            tr.innerHTML = ''
                + '<td class="' + ticketCellClass + '">' + ticketCellHtml + '</td>'
                + '<td class="px-3 py-2 text-gray-500">' + formatFechaDisplay(s?.fecha || '‚Äî') + '</td>'
                + '<td class="px-3 py-2 text-gray-500">' + String(s?.customer_name || '‚Äî') + '</td>'
                + '<td class="px-3 py-2 text-gray-500">' + String(s?.responsible_name || s?.employee_name || '‚Äî') + '</td>'
                + '<td class="px-3 py-2 text-right text-gray-500">' + formatearMoneda(parseFloat(s?.total || 0) || 0) + '</td>'
                + '<td class="px-3 py-2 text-center text-gray-500">' + displayPaymentMethod(s?.payment_method) + '</td>'
                + '<td class="px-3 py-2 text-center">' + statusHtml + '</td>'
                + '<td class="px-3 py-2 text-center">' + historialAccionesHtml(ticket) + '</td>';
            historialTbody.appendChild(tr);
        });
    }

    function initSalesEmployeesSelectors() {
        const apply = function (arr) {
            employeesCache = Array.isArray(arr) ? arr.slice() : [];
            try { employeesCache = employeesCache.filter(e => String(e?.id || '').trim()); } catch (e) {}

            initVentasMultiEmployeeFromData(employeesCache, salesCache);
            try { applyEmployeesToSelectors(); } catch (e) {}
        };

        const fetchFromApi = function () {
            try {
                const url = apiPath('/employees/api/employees?limit=2000');
                return fetch(url, { credentials: 'same-origin' })
                    .then(r => r.json())
                    .then(data => (data && data.ok && Array.isArray(data.items)) ? data.items : [])
                    .then(apply)
                    .catch(function () { apply([]); });
            } catch (e) {
                apply([]);
                return null;
            }
        };

        try {
            if (window.StorageService && typeof window.StorageService.getEmployees === 'function') {
                const res = window.StorageService.getEmployees();
                if (res && typeof res.then === 'function') return res.then(apply);
                return apply(res);
            }
        } catch (e) {
        }
        return fetchFromApi();
    }

    function initHistorialVentas() {
        try {
            if (historialTbody) historialTbody.innerHTML = '<tr><td colspan="8" class="px-4 py-6 text-center text-sm text-gray-500">Cargando movimientos‚Ä¶</td></tr>';
        } catch (e) {
        }

        const res = leerSales();
        const apply = function (arr) {
            salesCache = Array.isArray(arr) ? arr : [];
            salesLoaded = true;

            initVentasMultiPagoFromSales(salesCache);
            initVentasMultiEmployeeFromData(employeesCache, salesCache);
            renderHistorialFromCache();
            applyVentasFilters();
            initKpisFromSales();
        };
        if (res && typeof res.then === 'function') return res.then(apply);
        apply(res);
        return null;
    }
    function applyVentasFilters() {
        if (!historial) return;
        const body = historial.querySelector('tbody');
        if (!body) return;
        const rows = Array.from(body.querySelectorAll('tr'));
        const qTic = String(inputSearchVentasTicket?.value || '').trim().toLowerCase();
        const qCli = String(inputSearchVentasCliente?.value || '').trim().toLowerCase();
        const selTipo = ventasMultiFilters.tipo?.selected || new Set();
        const selPago = ventasMultiFilters.pago?.selected || new Set();
        const selEmp = ventasMultiFilters.employee?.selected || new Set();

        let fromTs = 0;
        let toTs = 0;
        const r = String(inputFechaRango?.value || '').trim();
        if (r) {
            const matches = r.match(/\b\d{2}\/\d{2}\/\d{4}\b/g) || [];
            if (matches.length >= 2) {
                const a = parseDateToTs(matches[0]);
                const b = parseDateToTs(matches[1]);
                if (a && b) {
                    fromTs = Math.min(a, b);
                    toTs = Math.max(a, b) + (24 * 60 * 60 * 1000 - 1);
                }
            } else if (matches.length === 1) {
                const a = parseDateToTs(matches[0]);
                if (a) {
                    fromTs = a;
                    toTs = a + (24 * 60 * 60 * 1000 - 1);
                }
            } else if (r.includes('-')) {
                const parts = r.split('-').map(x => x.trim());
                if (parts.length >= 2) {
                    const a = parseDateToTs(parts[0]);
                    const b = parseDateToTs(parts[1]);
                    if (a && b) {
                        fromTs = Math.min(a, b);
                        toTs = Math.max(a, b) + (24 * 60 * 60 * 1000 - 1);
                    }
                }
            }
        }

        rows.forEach(tr => {
            const tds = tr.querySelectorAll('td');
            if (!tds || tds.length < 7) return;
            const isGiftRow = String(tr.getAttribute('data-is-gift') || '') === '1';

            const vTicketNorm = String(tr.getAttribute('data-ticket') || tds[0]?.textContent || '').trim();
            const vGift = String(tr.getAttribute('data-gift-code') || '').trim();
            const vTicketPrimary = ventasGiftOnly ? (vGift || vTicketNorm) : vTicketNorm;
            const vFecha = String(tds[1]?.textContent || '').trim();
            const vCliente = String(tds[2]?.textContent || '').trim();
            const vPago = String(tds[5]?.textContent || '').trim();
            const vPagoKey = normPaymentMethodKey(vPago);
            const vEstado = String(tds[6]?.textContent || '').trim();
            const vTipoNorm = String(tr.getAttribute('data-type') || '').trim();
            const vRespId = String(tr.getAttribute('data-responsible-id') || '').trim();
            const vEmpFallback = String(tr.getAttribute('data-employee-id') || '').trim();
            const vEmpId = (vRespId || (vEmpFallback ? ('e:' + vEmpFallback) : '')) || '__EMPTY__';

            let ok = true;
            if (ventasGiftOnly && !isGiftRow) ok = false;
            if (qTic) {
                const primary = vTicketPrimary.toLowerCase();
                const alt = (ventasGiftOnly ? vTicketNorm : vGift).toLowerCase();
                if (!primary.includes(qTic) && !alt.includes(qTic)) ok = false;
            }
            if (qCli && !vCliente.toLowerCase().includes(qCli)) ok = false;
            if (ok && !ventasMultiMatches(vPagoKey, 'pago')) ok = false;
            if (ok && !ventasMultiMatches(vTipoNorm, 'tipo')) ok = false;
            if (ok && !ventasMultiMatches(vEmpId, 'employee')) ok = false;

            if (ok && fromTs && toTs) {
                const ts = parseDateToTs(vFecha);
                if (!ts || ts < fromTs || ts > toTs) ok = false;
            }

            tr.classList.toggle('hidden', !ok);
        });

        initKpisFromSales();
    }

    function initKpisFromSales() {
        const res = leerSales();
        const apply = function (arr) {
            const sales = Array.isArray(arr) ? arr : [];

            function isSaleForSalesKpis(s) {
                const tpLabel = historialTipoLabelFromSale(s);
                if (!tpLabel || !String(tpLabel).startsWith('Venta')) return false;

                const cust = String(s?.customer_name || '').trim().toLowerCase();
                if (cust === 'sistema / ajuste interno') return false;
                if (cust.includes('ajuste interno')) return false;
                if (cust.startsWith('sistema')) return false;

                const pay = String(s?.payment_method || '').trim().toLowerCase();
                if (pay === 'ajuste interno') return false;

                const notes = String(s?.notes || '').trim();
                if (notes.includes('AdjustmentId:')) return false;

                const ticket = String(s?.ticket || '').trim().toLowerCase();
                if (ticket.startsWith('aj') || ticket.includes('ajuste')) return false;

                return true;
            }

            const qTic = String(inputSearchVentasTicket?.value || '').trim().toLowerCase();
            const qCli = String(inputSearchVentasCliente?.value || '').trim().toLowerCase();
            const selTipo = ventasMultiFilters.tipo?.selected || new Set();
            const selPago = ventasMultiFilters.pago?.selected || new Set();
            const selEmp = ventasMultiFilters.employee?.selected || new Set();

            let fromTs = 0;
            let toTs = 0;
            const r = String(inputFechaRango?.value || '').trim();
            if (r) {
                const matches = r.match(/\b\d{2}\/\d{2}\/\d{4}\b/g) || [];
                if (matches.length >= 2) {
                    const a = parseDateToTs(matches[0]);
                    const b = parseDateToTs(matches[1]);
                    if (a && b) {
                        fromTs = Math.min(a, b);
                        toTs = Math.max(a, b) + (24 * 60 * 60 * 1000 - 1);
                    }
                } else if (matches.length === 1) {
                    const a = parseDateToTs(matches[0]);
                    if (a) {
                        fromTs = a;
                        toTs = a + (24 * 60 * 60 * 1000 - 1);
                    }
                } else if (r.includes('-')) {
                    const parts = r.split('-').map(x => x.trim());
                    if (parts.length >= 2) {
                        const a = parseDateToTs(parts[0]);
                        const b = parseDateToTs(parts[1]);
                        if (a && b) {
                            fromTs = Math.min(a, b);
                            toTs = Math.max(a, b) + (24 * 60 * 60 * 1000 - 1);
                        }
                    }
                }
            }

            let total = 0;
            let itemsVendidos = 0;
            let tickets = 0;

            sales.forEach(s => {
                const st = String(s?.status || '').trim();
                if (st === 'Reemplazada') return;

                const isGiftRow = !!(s && s.is_gift);
                if (ventasGiftOnly && !isGiftRow) return;

                const tipoLabel = historialTipoLabelFromSale(s);

                const ticketNorm = String(s?.ticket || '').trim();
                const gift = String(s?.gift_code || '').trim();
                const ticketPrimary = ventasGiftOnly ? (gift || ticketNorm) : ticketNorm;
                if (qTic) {
                    const primary = ticketPrimary.toLowerCase();
                    const alt = (ventasGiftOnly ? ticketNorm : gift).toLowerCase();
                    if (!primary.includes(qTic) && !alt.includes(qTic)) return;
                }

                const cust = String(s?.customer_name || '').trim();
                if (qCli && !cust.toLowerCase().includes(qCli)) return;

                const pay = String(s?.payment_method || 'Efectivo').trim();
                const payKey = normPaymentMethodKey(pay);
                if (!ventasMultiMatches(payKey, 'pago')) return;

                if (!ventasMultiMatches(tipoLabel, 'tipo')) return;

                const respId = String(s?.responsible_id || '').trim();
                const empFallback = String(s?.employee_id || '').trim();
                const empId = (respId || (empFallback ? ('e:' + empFallback) : '')) || '__EMPTY__';
                if (!ventasMultiMatches(empId, 'employee')) return;

                if (fromTs && toTs) {
                    const fechaTxt = String(s?.fecha || '').trim();
                    const ts = parseDateToTs(fechaTxt);
                    if (!ts || ts < fromTs || ts > toTs) return;
                }

                if (!isSaleForSalesKpis(s)) return;

                total += (parseFloat(s?.total || '0') || 0);
                tickets += 1;
                const its = Array.isArray(s?.items) ? s.items : [];
                its.forEach(it => {
                    const qty = parseFloat(it?.cantidad || '0') || 0;
                    const dir = String(it?.direction || 'out').toLowerCase();
                    itemsVendidos += (dir === 'in') ? (-qty) : qty;
                });
            });

            const ticketProm = tickets > 0 ? (total / tickets) : 0;

            if (kpiVentasDiaEl) kpiVentasDiaEl.textContent = formatearMoneda(total);
            if (kpiTicketsDiaEl) kpiTicketsDiaEl.textContent = String(tickets);
            if (kpiItemsDiaEl) kpiItemsDiaEl.textContent = String(itemsVendidos);
            if (kpiTicketPromedioEl) kpiTicketPromedioEl.textContent = formatearMoneda(ticketProm);

            const anyEmpFilter = (ventasMultiFilters.employee?.options || []).length > 0 && (ventasMultiFilters.employee?.selected || new Set()).size > 0 && (ventasMultiFilters.employee?.selected || new Set()).size < (ventasMultiFilters.employee?.options || []).length;
            if (anyEmpFilter) {
                if (kpiLabelVentasEl) kpiLabelVentasEl.textContent = 'Ventas del empleado';
                if (kpiLabelTicketsEl) kpiLabelTicketsEl.textContent = 'Ventas realizadas por el empleado';
                if (kpiLabelItemsEl) kpiLabelItemsEl.textContent = 'Art√≠culos vendidos por el empleado';
                if (kpiLabelPromedioEl) kpiLabelPromedioEl.textContent = 'Ticket promedio del empleado';
            } else if (r) {
                if (kpiLabelVentasEl) kpiLabelVentasEl.textContent = 'Ventas del per√≠odo';
                if (kpiLabelTicketsEl) kpiLabelTicketsEl.textContent = 'Cantidad de ventas';
                if (kpiLabelItemsEl) kpiLabelItemsEl.textContent = 'Cantidad de art√≠culos vendidos';
                if (kpiLabelPromedioEl) kpiLabelPromedioEl.textContent = 'Ticket promedio';
            } else {
                if (kpiLabelVentasEl) kpiLabelVentasEl.textContent = 'Ventas';
                if (kpiLabelTicketsEl) kpiLabelTicketsEl.textContent = 'Cantidad de movimientos';
                if (kpiLabelItemsEl) kpiLabelItemsEl.textContent = 'Cantidad de art√≠culos (neta)';
                if (kpiLabelPromedioEl) kpiLabelPromedioEl.textContent = 'Ticket promedio';
            }
        };
        if (isPromise(res)) return res.then(apply);
        apply(res);
        return null;
    }

    let invCache = { products: [], lots: [] };
    let invLoaded = false;
    let invLoadPromise = null;

    let selectedCategoriaVenta = 'Todos';
    let selectedCategoriaCambio = 'Todos';
    let selectedCategoriaCambioVenta = 'Todos';
    let ventaViewMode = 'list';
    let ventaSearchQuery = '';
    let ventaInvData = null;
    let cambioViewMode = 'list';
    let cambioSearchQuery = '';
    let cambioInvData = null;
    let cambioVentaViewMode = 'list';
    let cambioVentaSearchQuery = '';
    let cambioVentaInvData = null;

    function uniqueCategoriesFromProducts(products) {
        const out = [];
        const seen = new Set();
        (Array.isArray(products) ? products : []).forEach(p => {
            const c = String(p?.category?.name || p?.category_name || '').trim();
            if (!c) return;
            if (seen.has(c)) return;
            seen.add(c);
            out.push(c);
        });
        out.sort((a, b) => a.localeCompare(b, 'es'));
        return out;
    }

    function applyCategoryFilter(buttons, categoria) {
        const list = Array.isArray(buttons) ? buttons : [];
        list.forEach(btn => {
            const cat = String(btn?.getAttribute('data-categoria') || '').trim();
            if (!categoria || categoria === 'Todos' || cat === categoria) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        });
    }

    function renderCategoryPills(container, categories, active, onSelect) {
        if (!container) return;
        const cats = Array.isArray(categories) ? categories : [];
        container.innerHTML = '';

        const wrap = document.createElement('div');
        wrap.className = 'relative inline-block';

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'px-3 py-1 rounded-full bg-indigo-600 text-white shadow-sm inline-flex items-center gap-2';
        const activeLabel = (String(active || '').trim() && String(active || '').trim() !== 'Todos') ? String(active || '').trim() : 'Categor√≠as';
        btn.innerHTML = '<span>' + activeLabel + '</span><i class="fas fa-chevron-down text-[10px] opacity-80"></i>';

        const menu = document.createElement('div');
        menu.className = 'hidden absolute left-0 mt-2 w-48 bg-white border border-gray-200 rounded-lg shadow-lg z-20 overflow-hidden';

        const mkItem = function (label) {
            const it = document.createElement('button');
            it.type = 'button';
            it.className = 'w-full text-left px-3 py-2 text-xs hover:bg-gray-50';
            const isActive = String(label || '').trim() === String(active || '').trim();
            if (isActive) {
                it.classList.add('bg-indigo-50','text-indigo-700','font-semibold');
            } else {
                it.classList.add('text-gray-700');
            }
            it.textContent = label;
            it.addEventListener('click', function (e) {
                if (e) e.preventDefault();
                const val = String(label || '').trim() || 'Todos';
                try {
                    menu.classList.add('hidden');
                } catch (err) {
                }
                if (typeof onSelect === 'function') onSelect(val);
            });
            return it;
        };

        menu.appendChild(mkItem('Todos'));
        cats.forEach(c => menu.appendChild(mkItem(c)));

        btn.addEventListener('click', function (e) {
            if (e) e.preventDefault();
            try {
                menu.classList.toggle('hidden');
            } catch (err) {
            }
        });

        try {
            if (!window.__catsDdCloseBound) {
                window.__catsDdCloseBound = true;
                document.addEventListener('click', function (ev) {
                    const t = ev && ev.target;
                    const menus = Array.from(document.querySelectorAll('[data-cats-dd="1"]'));
                    menus.forEach(m => {
                        const parent = m.parentElement;
                        if (parent && t && parent.contains(t)) return;
                        m.classList.add('hidden');
                    });
                });
            }
        } catch (e) {
        }

        menu.setAttribute('data-cats-dd', '1');
        wrap.appendChild(btn);
        wrap.appendChild(menu);
        container.appendChild(wrap);
    }

    function apiListInventoryProducts() {
        return fetch(apiPath('/sales/api/products?limit=5000'), { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => (data && data.ok && Array.isArray(data.items)) ? data.items : []);
    }

    function apiListInventoryLots() {
        return fetch(apiPath('/sales/api/lots?limit=10000'), { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => (data && data.ok && Array.isArray(data.items)) ? data.items : []);
    }

    function updateVentaViewButtons() {
        if (!btnViewGrid || !btnViewList) return;
        const active = 'bg-indigo-600 text-white border-indigo-600';
        const inactive = 'bg-gray-50 text-gray-700 border-gray-200';
        if (ventaViewMode === 'list') {
            btnViewList.className = 'px-2.5 py-1 rounded-md border hover:bg-gray-100 ' + active;
            btnViewGrid.className = 'px-2.5 py-1 rounded-md border hover:bg-gray-100 ' + inactive;
        } else {
            btnViewGrid.className = 'px-2.5 py-1 rounded-md border hover:bg-gray-100 ' + active;
            btnViewList.className = 'px-2.5 py-1 rounded-md border hover:bg-gray-100 ' + inactive;
        }
    }

    function setVentaViewMode(mode, persist) {
        ventaViewMode = (mode === 'list') ? 'list' : 'grid';
        if (persist) {
            try { window.localStorage.setItem('venta_view_mode', ventaViewMode); } catch (e) {}
        }
        updateVentaViewButtons();
        if (ventaInvData) {
            renderVentaProductsView(ventaInvData);
        }
    }

    function getVentaFilterElements() {
        if (ventaViewMode === 'list') {
            return Array.from(tablaProductosBody ? tablaProductosBody.querySelectorAll('tr[data-product-id]') : []);
        }
        return Array.from(gridProductos ? gridProductos.querySelectorAll('.btn-producto') : []);
    }

    function applyVentaProductsFilter() {
        const list = getVentaFilterElements();
        const categoria = String(selectedCategoriaVenta || '').trim();
        const q = String(ventaSearchQuery || '').trim().toLowerCase();

        let hasExactCodigo = false;
        if (q) {
            try {
                hasExactCodigo = list.some(el => {
                    const ci = String(el?.getAttribute('data-codigo-interno') || '').trim().toLowerCase();
                    return ci && ci === q;
                });
            } catch (e) {
            }
        }
        list.forEach(el => {
            const cat = String(el?.getAttribute('data-categoria') || '').trim();
            const nombre = String(el?.getAttribute('data-nombre') || el?.textContent || '').trim();
            const codigoInterno = String(el?.getAttribute('data-codigo-interno') || '').trim();
            const haystack = (nombre + ' ' + codigoInterno).toLowerCase();
            const okCat = (!categoria || categoria === 'Todos' || cat === categoria);
            const okQ = (!q || (hasExactCodigo ? (String(codigoInterno || '').trim().toLowerCase() === q) : (haystack.indexOf(q) >= 0)));
            if (okCat && okQ) {
                el.classList.remove('hidden');
            } else {
                el.classList.add('hidden');
            }
        });
    }

    function agregarProductoDesdeEl(el) {
        try {
            const now = Date.now();
            const last = parseInt(el.getAttribute('data-last-add-ms') || '0', 10) || 0;
            if (now - last < 150) return;
            el.setAttribute('data-last-add-ms', String(now));
        } catch (e) {
        }
        const nombre = el.getAttribute('data-nombre') || 'Producto';
        const precio = el.getAttribute('data-precio') || '0';
        const productId = el.getAttribute('data-product-id') || '';
        agregarProductoAlCarrito(nombre, precio, { productId: productId });
    }

    function stockColorClass(stock) {
        const v = parseFloat(stock || 0) || 0;
        if (v <= 0) return 'text-red-700';
        if (v < 5) return 'text-yellow-700';
        return 'text-green-700';
    }

    function renderVentaProductsView(data) {
        if (!gridProductos) return;
        const products = Array.isArray(data?.products) ? data.products : [];
        const lots = Array.isArray(data?.lots) ? data.lots : [];

        if (ventaViewMode === 'list') {
            if (tablaProductosWrap) tablaProductosWrap.classList.remove('hidden');
            gridProductos.classList.add('hidden');
            if (tablaProductosBody) {
                tablaProductosBody.innerHTML = '';
            }
            if (!products.length || !tablaProductosBody) {
                if (tablaProductosBody) tablaProductosBody.innerHTML = '<tr><td colspan="5" class="px-3 py-4 text-sm text-gray-500">No hay productos en inventario.</td></tr>';
                return;
            }
            products.slice(0, 200).forEach(p => {
                const stock = stockDisponiblePorProducto(lots, p?.id);
                const price = parseFloat(p?.sale_price || p?.price || 0) || 0;
                const displayPrice = price > 0 ? price : 0;
                const cat = String(p?.category?.name || p?.category_name || '').trim();
                const codigoInterno = String(p?.codigo_interno || p?.internal_code || '').trim();
                const desc = String(p?.description || '').trim();
                const infoTitle = 'C√≥digo interno: ' + (codigoInterno || '‚Äî') + (desc ? ('\nDescripci√≥n: ' + desc) : '');

                const tr = document.createElement('tr');
                tr.className = 'hover:bg-indigo-50 cursor-pointer';
                tr.tabIndex = 0;
                tr.setAttribute('data-product-id', String(p?.id || ''));
                tr.setAttribute('data-nombre', String(p?.name || 'Producto'));
                tr.setAttribute('data-precio', String(displayPrice.toFixed(2)));
                tr.setAttribute('data-categoria', cat);
                tr.setAttribute('data-codigo-interno', codigoInterno);

                const stockCls = stockColorClass(stock);
                tr.innerHTML = ''
                    + '<td class="px-2 py-2 text-gray-800">' + String(p?.name || 'Producto') + '</td>'
                    + '<td class="px-2 py-2 text-gray-500">' + (cat || '‚Äî') + '</td>'
                    + '<td class="px-2 py-2 text-right text-gray-900 font-medium">' + formatearMoneda(displayPrice) + '</td>'
                    + '<td class="px-2 py-2 text-right ' + stockCls + ' font-medium">' + String((isNaN(stock) ? 0 : stock).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</td>'
                    + '<td class="px-2 py-2 text-center">'
                    + '  <button type="button" class="h-7 w-7 inline-flex items-center justify-center rounded-md bg-gray-100 text-gray-600 hover:bg-gray-200" data-action="info" title="' + escapeHtml(infoTitle) + '">'
                    + '    <i class="fas fa-info-circle text-[12px]"></i>'
                    + '  </button>'
                    + '</td>';

                tr.addEventListener('click', function (e) {
                    const infoBtn = e && e.target ? e.target.closest('button[data-action="info"]') : null;
                    if (infoBtn) {
                        try { e.preventDefault(); } catch (ex) {}
                        try { e.stopPropagation(); } catch (ex) {}
                        return;
                    }
                    agregarProductoDesdeEl(tr);
                });
                tr.addEventListener('keydown', function (e) {
                    if (!e) return;
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        agregarProductoDesdeEl(tr);
                    }
                });

                tablaProductosBody.appendChild(tr);
            });
        } else {
            if (tablaProductosWrap) tablaProductosWrap.classList.add('hidden');
            gridProductos.classList.remove('hidden');
            gridProductos.innerHTML = '';
            if (!products.length) {
                gridProductos.innerHTML = '<div class="col-span-full px-3 py-4 text-sm text-gray-500">No hay productos en inventario.</div>';
                return;
            }
            products.slice(0, 200).forEach(p => {
                const stock = stockDisponiblePorProducto(lots, p?.id);
                const price = parseFloat(p?.sale_price || p?.price || 0) || 0;
                const displayPrice = price > 0 ? price : 0;
                const codigoInterno = String(p?.codigo_interno || p?.internal_code || '').trim();
                const desc = String(p?.description || '').trim();
                const infoTitle = 'C√≥digo interno: ' + (codigoInterno || '‚Äî') + (desc ? ('\nDescripci√≥n: ' + desc) : '');
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn-producto relative flex flex-col items-start p-3 bg-gray-50 rounded-lg border border-gray-100 hover:border-indigo-200 hover:bg-indigo-50 text-left text-xs';
                btn.setAttribute('data-product-id', String(p?.id || ''));
                btn.setAttribute('data-nombre', String(p?.name || 'Producto'));
                btn.setAttribute('data-precio', String(displayPrice.toFixed(2)));
                btn.setAttribute('data-categoria', String(p?.category?.name || p?.category_name || ''));
                btn.setAttribute('data-codigo-interno', codigoInterno);
                const stockCls = stockColorClass(stock);

                const imgUrl = String(p?.image_url || '').trim();
                const imgSrc = imgUrl || logoUrl;
                const imgCls = imgUrl ? 'h-full w-full object-cover' : 'h-10';
                const imgOnErr = "this.onerror=null;this.src='" + logoUrl + "';this.className='h-10';";
                btn.innerHTML = ''
                    + '<div class="absolute top-2 right-2">'
                    + '  <span class="h-7 w-7 inline-flex items-center justify-center rounded-md bg-white/80 border border-gray-200 text-gray-600 hover:bg-white cursor-help" data-action="info" title="' + escapeHtml(infoTitle) + '">'
                    + '    <i class="fas fa-info-circle text-[12px]"></i>'
                    + '  </span>'
                    + '</div>'
                    + '<div class="w-full mb-2 flex items-center justify-center">'
                    + '  <div class="h-16 w-16 rounded-md bg-white border border-gray-200 flex items-center justify-center overflow-hidden">'
                    + '    <img src="' + imgSrc + '" alt="" class="' + imgCls + '" onerror="' + imgOnErr + '">'
                    + '  </div>'
                    + '</div>'
                    + '<div class="font-medium text-gray-800 truncate w-full">' + String(p?.name || 'Producto') + '</div>'
                    + '<div class="text-[11px] text-gray-500">' + String(p?.category?.name || p?.category_name || '') + '</div>'
                    + '<div class="mt-1 font-semibold text-sm text-gray-900">' + formatearMoneda(displayPrice) + '</div>'
                    + '<div class="mt-1 text-[11px] ' + stockCls + '">Stock: ' + String((isNaN(stock) ? 0 : stock).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</div>';
                gridProductos.appendChild(btn);
            });
            bindProductButtons();
        }

        try {
            applyVentaProductsFilter();
        } catch (e) {
        }
    }

    function loadInventoryFromServer() {
        if (invLoaded) return invCache;
        if (invLoadPromise) return invLoadPromise;
        invLoadPromise = Promise.all([apiListInventoryProducts(), apiListInventoryLots()]).then(function (vals) {
            invCache = { products: Array.isArray(vals[0]) ? vals[0] : [], lots: Array.isArray(vals[1]) ? vals[1] : [] };
            invLoaded = true;
            return invCache;
        }).catch(function () {
            invCache = { products: [], lots: [] };
            invLoaded = true;
            return invCache;
        });
        return invLoadPromise;
    }

    function leerInventario() {
        if (invLoaded) return invCache;
        return loadInventoryFromServer();
    }

    function stockDisponiblePorProducto(lots, productId) {
        return (Array.isArray(lots) ? lots : [])
            .filter(l => String(l?.product_id) === String(productId))
            .reduce((acc, l) => acc + (parseFloat(l?.qty_available || '0') || 0), 0);
    }

    function normalizeScanCode(raw) {
        const s = String(raw || '').trim();
        if (!s) return '';
        return s.replace(/\s+/g, '').toUpperCase();
    }

    function isInVentaPasoProductos() {
        try {
            if (!flujo || flujo.classList.contains('hidden')) return false;
            if (!pasoProductos || pasoProductos.classList.contains('hidden')) return false;
            return true;
        } catch (e) {
            return false;
        }
    }

    function focusScannerInput() {
        if (!scannerEnabled) return;
        if (!scannerInput) return;
        if (!isInVentaPasoProductos()) return;
        try {
            const ae = document.activeElement;
            if (ae && (ae.tagName === 'INPUT' || ae.tagName === 'TEXTAREA' || ae.isContentEditable)) {
                // No robar foco si el usuario est√° escribiendo.
                return;
            }
        } catch (e) {
        }
        try { scannerInput.focus(); } catch (e) {}
    }

    function findProductByScan(code) {
        const c = normalizeScanCode(code);
        if (!c) return null;
        const products = Array.isArray(ventaInvData?.products) ? ventaInvData.products : [];
        if (!products.length) return null;
        const direct = products.find(p => normalizeScanCode(p?.barcode) === c) || null;
        if (direct) return direct;
        const byInternal = products.find(p => normalizeScanCode(p?.codigo_interno || p?.internal_code) === c) || null;
        if (byInternal) return byInternal;
        return null;
    }

    function tryAddScannedProduct(code) {
        const c = normalizeScanCode(code);
        if (!c) return;

        const p = findProductByScan(c);
        if (!p) {
            const msg = 'No existe un producto con el c√≥digo "' + c + '".\n\nAcci√≥n sugerida: crearlo en Inventario y volver a escanear.';
            if (window.showAlertModal) window.showAlertModal(msg, 'Producto inexistente', 'C√≥digo de barras');
            else alert(msg);
            return;
        }

        const productId = String(p?.id || '').trim();
        const nombre = String(p?.name || 'Producto').trim() || 'Producto';
        const precio = (function () {
            const pr = parseFloat(p?.sale_price ?? p?.price ?? 0) || 0;
            return String(pr.toFixed(2));
        })();

        try {
            const allowOutOfStock = !!(toggleVentaLibre?.checked || toggleVentaLibreTicket?.checked);
            if (!allowOutOfStock && productId) {
                const lots = Array.isArray(ventaInvData?.lots) ? ventaInvData.lots : [];
                const avail = stockDisponiblePorProducto(lots, productId);
                if ((parseFloat(avail || 0) || 0) <= 0) {
                    const msg = 'Stock insuficiente para "' + nombre + '".\n\nPod√©s activar ‚ÄúVenta libre‚Äù para vender sin stock.';
                    if (window.showAlertModal) window.showAlertModal(msg, 'Stock insuficiente', 'Inventario');
                    else alert(msg);
                    return;
                }
            }
        } catch (e) {
        }

        try {
            agregarProductoAlCarrito(nombre, precio, { productId: productId });
        } catch (e) {
            try { console.error(e); } catch (err) {}
            const msg = 'No se pudo agregar el producto al carrito.';
            if (window.showAlertModal) window.showAlertModal(msg, 'Error', 'Scanner');
            else alert(msg);
            return;
        }
    }

    function renderProductosDesdeInventario() {
        if (!gridProductos) return;
        const res = leerInventario();

        const apply = function (data) {
            const products = Array.isArray(data?.products) ? data.products : [];
            const lots = Array.isArray(data?.lots) ? data.lots : [];
            ventaInvData = { products: products, lots: lots };
            renderVentaProductsView(ventaInvData);

            try {
                if (pillsCategoriasVentaWrap) {
                    const cats = uniqueCategoriesFromProducts(products);
                    if (selectedCategoriaVenta !== 'Todos' && cats.indexOf(selectedCategoriaVenta) < 0) selectedCategoriaVenta = 'Todos';
                    renderCategoryPills(pillsCategoriasVentaWrap, cats, selectedCategoriaVenta, function (cat) {
                        selectedCategoriaVenta = cat;
                        applyVentaProductsFilter();
                        renderCategoryPills(pillsCategoriasVentaWrap, cats, selectedCategoriaVenta, arguments.callee);
                    });
                }
                applyVentaProductsFilter();
            } catch (e) {
            }
        };

        if (isPromise(res)) res.then(apply);
        else apply(res);
    }

    function renderProductosCambioDesdeInventario() {
        if (!gridProductosCambio) return;
        const res = leerInventario();

        const apply = function (data) {
            const products = Array.isArray(data?.products) ? data.products : [];
            const lots = Array.isArray(data?.lots) ? data.lots : [];
            gridProductosCambio.innerHTML = '';
            if (!products.length) {
                gridProductosCambio.innerHTML = '<div class="col-span-full px-3 py-4 text-sm text-gray-500">No hay productos en inventario.</div>';
                botonesProductoCambio = [];
                return;
            }

            products.slice(0, 200).forEach(p => {
                const stock = stockDisponiblePorProducto(lots, p?.id);
                const price = parseFloat(p?.sale_price || p?.price || 0) || 0;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn-producto-cambio flex flex-col items-start p-3 bg-gray-50 rounded-lg border border-gray-100 hover:border-indigo-200 hover:bg-indigo-50 text-left text-xs';
                btn.setAttribute('data-product-id', String(p?.id || ''));
                btn.setAttribute('data-nombre', String(p?.name || 'Producto'));
                btn.setAttribute('data-precio', String(price.toFixed(2)));
                btn.setAttribute('data-categoria', String(p?.category?.name || p?.category_name || ''));
                const stockCls = stockColorClass(stock);

                const imgUrl = String(p?.image_url || '').trim();
                const imgSrc = imgUrl || logoUrl;
                const imgCls = imgUrl ? 'h-full w-full object-cover' : 'h-10';
                const imgOnErr = "this.onerror=null;this.src='" + logoUrl + "';this.className='h-10';";
                btn.innerHTML = ''
                    + '<div class="w-full mb-2 flex items-center justify-center">'
                    + '  <div class="h-16 w-16 rounded-md bg-white border border-gray-200 flex items-center justify-center overflow-hidden">'
                    + '    <img src="' + imgSrc + '" alt="" class="' + imgCls + '" onerror="' + imgOnErr + '">'
                    + '  </div>'
                    + '</div>'
                    + '<div class="font-medium text-gray-800 truncate w-full">' + String(p?.name || 'Producto') + '</div>'
                    + '<div class="text-[11px] text-gray-500">' + String(p?.category?.name || p?.category_name || '') + '</div>'
                    + '<div class="mt-1 font-semibold text-sm text-gray-900">' + formatearMoneda(price) + '</div>'
                    + '<div class="mt-1 text-[11px] text-gray-500">Stock: ' + String((isNaN(stock) ? 0 : stock).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</div>';
                btn.addEventListener('click', function () {
                    const nombre = btn.getAttribute('data-nombre') || 'Producto';
                    const precio = btn.getAttribute('data-precio') || '0';
                    agregarProductoAlCarritoCambio(nombre, precio, { productId: btn.getAttribute('data-product-id') || '' });
                });
                gridProductosCambio.appendChild(btn);
            });
            botonesProductoCambio = Array.from(gridProductosCambio.querySelectorAll('.btn-producto-cambio'));

            cambioInvData = { products: products, lots: lots };
            renderCambioProductsView(cambioInvData);

            try {
                if (pillsCategoriasCambioWrap) {
                    const cats = uniqueCategoriesFromProducts(products);
                    if (selectedCategoriaCambio !== 'Todos' && cats.indexOf(selectedCategoriaCambio) < 0) selectedCategoriaCambio = 'Todos';
                    renderCategoryPills(pillsCategoriasCambioWrap, cats, selectedCategoriaCambio, function (cat) {
                        selectedCategoriaCambio = cat;
                        applyCambioProductsFilter();
                        renderCategoryPills(pillsCategoriasCambioWrap, cats, selectedCategoriaCambio, arguments.callee);
                    });
                }
                applyCambioProductsFilter();
            } catch (e) {
            }
        };

        if (isPromise(res)) res.then(apply);
        else apply(res);
    }

    function renderProductosCambioVentaDesdeInventario() {
        if (!gridProductosCambioVenta) return;
        const res = leerInventario();

        const apply = function (data) {
            const products = Array.isArray(data?.products) ? data.products : [];
            const lots = Array.isArray(data?.lots) ? data.lots : [];
            gridProductosCambioVenta.innerHTML = '';
            if (!products.length) {
                gridProductosCambioVenta.innerHTML = '<div class="col-span-full px-3 py-4 text-sm text-gray-500">No hay productos en inventario.</div>';
                botonesProductoCambioVenta = [];
                return;
            }

            products.slice(0, 200).forEach(p => {
                const stock = stockDisponiblePorProducto(lots, p?.id);
                const price = parseFloat(p?.sale_price || p?.price || 0) || 0;
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'btn-producto-cambio-venta flex flex-col items-start p-3 bg-gray-50 rounded-lg border border-gray-100 hover:border-indigo-200 hover:bg-indigo-50 text-left text-xs';
                btn.setAttribute('data-product-id', String(p?.id || ''));
                btn.setAttribute('data-nombre', String(p?.name || 'Producto'));
                btn.setAttribute('data-precio', String(price.toFixed(2)));
                btn.setAttribute('data-categoria', String(p?.category?.name || p?.category_name || ''));
                const stockCls = stockColorClass(stock);

                const imgUrl = String(p?.image_url || '').trim();
                const imgSrc = imgUrl || logoUrl;
                const imgCls = imgUrl ? 'h-full w-full object-cover' : 'h-10';
                const imgOnErr = "this.onerror=null;this.src='" + logoUrl + "';this.className='h-10';";
                btn.innerHTML = ''
                    + '<div class="w-full mb-2 flex items-center justify-center">'
                    + '  <div class="h-16 w-16 rounded-md bg-white border border-gray-200 flex items-center justify-center overflow-hidden">'
                    + '    <img src="' + imgSrc + '" alt="" class="' + imgCls + '" onerror="' + imgOnErr + '">'
                    + '  </div>'
                    + '</div>'
                    + '<div class="font-medium text-gray-800 truncate w-full">' + String(p?.name || 'Producto') + '</div>'
                    + '<div class="text-[11px] text-gray-500">' + String(p?.category?.name || p?.category_name || '') + '</div>'
                    + '<div class="mt-1 font-semibold text-sm text-gray-900">' + formatearMoneda(price) + '</div>'
                    + '<div class="mt-1 text-[11px] text-gray-500">Stock: ' + String((isNaN(stock) ? 0 : stock).toLocaleString('es-AR', { maximumFractionDigits: 2 })) + '</div>';
                btn.addEventListener('click', function () {
                    const nombre = btn.getAttribute('data-nombre') || 'Producto';
                    const precio = btn.getAttribute('data-precio') || '0';
                    agregarProductoAlCarritoCambioVenta(nombre, precio, { productId: btn.getAttribute('data-product-id') || '' });
                });
                gridProductosCambioVenta.appendChild(btn);
            });
            botonesProductoCambioVenta = Array.from(gridProductosCambioVenta.querySelectorAll('.btn-producto-cambio-venta'));

            cambioVentaInvData = { products: products, lots: lots };
            renderCambioVentaProductsView(cambioVentaInvData);

            try {
                if (pillsCategoriasCambioVentaWrap) {
                    const cats = uniqueCategoriesFromProducts(products);
                    if (selectedCategoriaCambioVenta !== 'Todos' && cats.indexOf(selectedCategoriaCambioVenta) < 0) selectedCategoriaCambioVenta = 'Todos';
                    renderCategoryPills(pillsCategoriasCambioVentaWrap, cats, selectedCategoriaCambioVenta, function (cat) {
                        selectedCategoriaCambioVenta = cat;
                        applyCambioVentaProductsFilter();
                        renderCategoryPills(pillsCategoriasCambioVentaWrap, cats, selectedCategoriaCambioVenta, arguments.callee);
                    });
                }
                applyCambioVentaProductsFilter();
            } catch (e) {
            }
        };

        if (isPromise(res)) res.then(apply);
        else apply(res);
    }

    function bindProductButtons() {
        botonesProducto = gridProductos ? gridProductos.querySelectorAll('.btn-producto') : document.querySelectorAll('.btn-producto');
        botonesProducto.forEach(btn => {
            btn.addEventListener('click', function (e) {
                const infoEl = e && e.target ? e.target.closest('[data-action="info"]') : null;
                if (infoEl) {
                    try { e.preventDefault(); } catch (ex) {}
                    try { e.stopPropagation(); } catch (ex) {}
                    return;
                }
                const nombre = this.getAttribute('data-nombre') || 'Producto';
                const precio = this.getAttribute('data-precio') || '0';
                const productId = this.getAttribute('data-product-id') || '';
                agregarProductoAlCarrito(nombre, precio, { productId: productId });
            });
        });
    }

    const btnImprimirTicket = document.getElementById('btn-imprimir-ticket');
    if (btnImprimirTicket) {
        btnImprimirTicket.addEventListener('click', function () {
            printCurrentTicket();
        });
    }

    function parseMoneda(texto) {
        if (texto === null || texto === undefined) return 0;
        if (window.parseCurrencyARS) return window.parseCurrencyARS(texto);
        const limpio = String(texto)
            .replace(/\s/g, '')
            .replace(/\$/g, '')
            .replace(/\./g, '')
            .replace(',', '.');
        const n = parseFloat(limpio);
        return isNaN(n) ? 0 : n;
    }

    function parseNumeroFlexible(valor) {
        if (valor === null || valor === undefined) return 0;
        if (typeof valor === 'number') return isFinite(valor) ? valor : 0;
        const raw = String(valor).trim();
        if (!raw) return 0;

        const sign = raw.startsWith('-') ? '-' : '';
        let s = raw
            .replace(/\s/g, '')
            .replace(/%/g, '')
            .replace(/\$/g, '')
            .replace(/ARS/gi, '')
            .replace(/\+/g, '')
            .replace(/-/g, '');

        if (!s) return 0;

        const hasComma = s.includes(',');
        const hasDot = s.includes('.');
        if (hasComma && hasDot) {
            // Formato AR t√≠pico: 40.000,50
            s = s.replace(/\./g, '').replace(/,/g, '.');
        } else if (hasDot && !hasComma) {
            // Si los puntos son separadores de miles (30.000 o 1.234.567), eliminarlos.
            // Si parece decimal (40.5), mantener.
            const looksThousands = /^\d{1,3}(\.\d{3})+$/.test(s);
            s = looksThousands ? s.replace(/\./g, '') : s;
        } else if (hasComma && !hasDot) {
            // Si las comas son separadores de miles (30,000), eliminarlas.
            // Si parece decimal (30,5), convertir.
            const looksThousands = /^\d{1,3}(,\d{3})+$/.test(s);
            s = looksThousands ? s.replace(/,/g, '') : s.replace(/,/g, '.');
        }

        const n = parseFloat(sign + s);
        return isNaN(n) ? 0 : n;
    }

    function parseMoneyInputARS(valor) {
        // Parseo √∫nico y consistente para inputs de dinero (ARS), orientado a "monto abonado".
        // Reglas:
        // - Elimina $ y espacios
        // - Trata . o , como miles si encaja con grupos de 3
        // - Trata el √öLTIMO separador como decimal s√≥lo si hay 1-2 d√≠gitos luego
        if (valor === null || valor === undefined) return 0;
        if (typeof valor === 'number') return isFinite(valor) ? valor : 0;
        let s = String(valor).trim();
        if (!s) return 0;
        const negative = s.startsWith('-');
        s = s.replace(/\s/g, '').replace(/\$/g, '').replace(/ARS/gi, '');
        // dejar solo d√≠gitos y separadores
        s = s.replace(/[^0-9.,]/g, '');
        if (!s) return 0;

        // Si tiene ambos, asumimos AR: . miles, , decimales
        if (s.includes('.') && s.includes(',')) {
            s = s.replace(/\./g, '').replace(/,/g, '.');
        } else {
            // Si parece miles (50.000 o 1.234.567) eliminamos separador
            if (/^\d{1,3}(\.\d{3})+$/.test(s)) s = s.replace(/\./g, '');
            if (/^\d{1,3}(,\d{3})+$/.test(s)) s = s.replace(/,/g, '');

            // Si queda un √∫nico separador con 1-2 decimales, lo tratamos como decimal
            const lastDot = s.lastIndexOf('.');
            const lastComma = s.lastIndexOf(',');
            const lastSep = Math.max(lastDot, lastComma);
            if (lastSep >= 0) {
                const decLen = s.length - lastSep - 1;
                if (decLen >= 1 && decLen <= 2) {
                    const intPart = s.slice(0, lastSep).replace(/[.,]/g, '');
                    const decPart = s.slice(lastSep + 1).replace(/[.,]/g, '');
                    s = intPart + '.' + decPart;
                } else {
                    // no es decimal: quitar separadores restantes
                    s = s.replace(/[.,]/g, '');
                }
            }
        }

        const n = parseFloat((negative ? '-' : '') + s);
        return isNaN(n) ? 0 : n;
    }

    function mostrarMensajesArqueo({ ok, detalle }) {
        if (msgArqueoOk) msgArqueoOk.classList.toggle('hidden', !ok);
        if (msgArqueoError) msgArqueoError.classList.toggle('hidden', ok);
        if (msgArqueoDetalle) {
            msgArqueoDetalle.textContent = detalle || '';
            msgArqueoDetalle.classList.toggle('hidden', !(detalle && detalle.trim().length));
        }
    }

    function calcularEfectivoDelDiaDesdeHistorial() {
        let total = 0;

        const fechaSel = String(document.getElementById('fecha-arqueo')?.value || '').trim();
        const daySel = fechaSel ? new Date(fechaSel + 'T00:00:00') : new Date();
        const ySel = daySel.getFullYear();
        const mSel = daySel.getMonth();
        const dSel = daySel.getDate();
        const startDay = new Date(ySel, mSel, dSel, 0, 0, 0, 0).getTime();
        const endDay = new Date(ySel, mSel, dSel, 23, 59, 59, 999).getTime();

        // 1) Ingresos/egresos en efectivo del d√≠a desde salesCache (valores reales)
        // Regla clave: si una venta queda en cuenta corriente, a caja entra SOLO lo efectivamente cobrado.
        const sales = Array.isArray(salesCache) ? salesCache : [];
        sales.forEach(function (s) {
            const st = String(s?.status || '').trim();
            if (st === 'Reemplazada') return;

            const pm = String(s?.payment_method || '').trim();
            if (pm !== 'Efectivo') return;

            const iso = String(s?.fecha || s?.date || '').trim();
            let tsFila = 0;
            if (iso && /^\d{4}-\d{2}-\d{2}$/.test(iso)) {
                try {
                    tsFila = new Date(iso + 'T00:00:00').getTime();
                } catch (e) {
                    tsFila = 0;
                }
            }
            if (!tsFila) {
                const raw = (typeof s?.created_at === 'number') ? s.created_at : 0;
                tsFila = raw || 0;
            }
            if (!tsFila || tsFila < startDay || tsFila > endDay) return;

            const tipo = String(s?.type || s?.sale_type || '').trim();
            const totalVenta = parseFloat(s?.total || 0) || 0;
            const paid = parseFloat(s?.paid_amount || 0) || 0;

            if (tipo === 'Venta') {
                return;
            }

            if (tipo === 'CobroVenta') {
                total += Math.max(0, totalVenta);
                return;
            }

            // Cobro de cuenta corriente: es ingreso de caja real
            if (tipo === 'CobroCC' || tipo === 'Cobro CC') {
                total += Math.max(0, totalVenta);
                return;
            }

            if (tipo === 'CobroCuota' || tipo === 'Cobro Cuota') {
                total += Math.max(0, totalVenta);
                return;
            }

            // Cambios/Devoluciones/Ajustes: impactan caja por su total (puede ser negativo)
            if (tipo === 'Cambio' || tipo === 'Devolucion' || tipo === 'Devoluci√≥n' || tipo === 'Pago') {
                total += totalVenta;
                return;
            }
        });

        // 2) Egresos en efectivo del d√≠a (resta) desde StorageService/getExpenses
        const fecha = String(document.getElementById('fecha-arqueo')?.value || '').trim();
        const day = fecha ? new Date(fecha + 'T00:00:00') : new Date();
        const y = day.getFullYear();
        const m = day.getMonth();
        const d = day.getDate();
        const start = new Date(y, m, d, 0, 0, 0, 0).getTime();
        const end = new Date(y, m, d, 23, 59, 59, 999).getTime();

        const parseExpenseTs = function (e) {
            const raw = e?.fecha || e?.date || e?.created_at || '';
            if (typeof raw === 'number' && isFinite(raw)) return raw;
            const v = String(raw || '').trim();
            if (!v) return 0;
            if (/^\d{4}-\d{2}-\d{2}$/.test(v)) {
                const parts = v.split('-').map(x => parseInt(x, 10));
                const dt = new Date(parts[0], (parts[1] || 1) - 1, parts[2] || 1);
                const ts = dt.getTime();
                return isNaN(ts) ? 0 : ts;
            }
            if (v.includes('/')) return parseDateToTs(v);
            const ts = Date.parse(v);
            return isNaN(ts) ? 0 : ts;
        };

        const getExpenses = function () {
            try {
                if (window.StorageService && typeof window.StorageService.getExpenses === 'function') {
                    return window.StorageService.getExpenses();
                }
            } catch (e) {
            }
            return [];
        };

        const res = getExpenses();
        const apply = function (arr) {
            const list = Array.isArray(arr) ? arr : [];
            list.forEach(e => {
                const ts = parseExpenseTs(e);
                if (!ts || ts < start || ts > end) return;
                const metodo = String(e?.forma_pago || e?.payment_method || 'Efectivo').trim();
                if (metodo !== 'Efectivo') return;
                const val = parseFloat(e?.valor || e?.amount || 0) || 0;
                total -= val;
            });
        };
        if (isPromise(res)) res.then(apply);
        else apply(res);

        return total;
    }

    function recalcularArqueoAutomatico() {
        try {
            const efectivoDia = calcularEfectivoDelDiaDesdeHistorial();
            if (typeof setMonedaARSInput === 'function') {
                setMonedaARSInput(montoEfectivoDia, efectivoDia);
            } else if (montoEfectivoDia) {
                montoEfectivoDia.value = formatearMoneda(efectivoDia);
            }
        } catch (e) {
        }
        try { validarCierreArqueo(); } catch (e) {}
    }

    function setArqueoBadge(state) {
        if (!arqueoStatusBadge) return;
        const s = String(state || '').toLowerCase();
        const set = function (txt, styles) {
            arqueoStatusBadge.textContent = txt;
            arqueoStatusBadge.className = 'text-[11px] px-2 py-0.5 rounded-full border font-medium';
            const st = styles && typeof styles === 'object' ? styles : {};
            arqueoStatusBadge.style.backgroundColor = String(st.bg || '#f9fafb');
            arqueoStatusBadge.style.color = String(st.color || '#374151');
            arqueoStatusBadge.style.borderColor = String(st.border || '#e5e7eb');
        };
        if (s === 'realizado') {
            set('Realizado', { bg: '#d1fae5', color: '#065f46', border: '#10b981' });
            return;
        }
        if (s === 'falta_cierre' || s === 'faltacierre' || s === 'falta cierre') {
            set('Falta cierre', { bg: '#fee2e2', color: '#991b1b', border: '#ef4444' });
            return;
        }
        if (s === 'pendiente') {
            set('Pendiente', { bg: '#fef3c7', color: '#92400e', border: '#f59e0b' });
            return;
        }
        set('‚Äî', { bg: '#f9fafb', color: '#374151', border: '#e5e7eb' });
    }

    function openArqueoModal() {
        if (!modalArqueo) return;
        modalArqueo.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
    }

    function closeArqueoModal() {
        if (!modalArqueo) return;
        modalArqueo.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
    }

    function loadArqueoFromServer() {
        const fecha = String(document.getElementById('fecha-arqueo')?.value || '').trim();
        if (!fecha) return;
        fetch(apiPath('/sales/api/cash-count?date=' + encodeURIComponent(fecha)), { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => {
                const item = data && data.item ? data.item : null;
                if (!item) {
                    setArqueoBadge('pendiente');
                    arqueoLastSavedAtMs = 0;
                    if (montoApertura) montoApertura.value = '';
                    if (montoCierre) montoCierre.value = '';
                    if (selectArqueoEmployee) selectArqueoEmployee.value = '';
                    recalcularArqueoAutomatico();
                    return;
                }

                setMonedaARSInput(montoApertura, item.opening_amount ?? '');
                setMonedaARSInput(montoCierre, item.closing_amount ?? '');
                setMonedaARSInput(montoEfectivoDia, item.cash_day_amount ?? '');
                if (selectArqueoEmployee) selectArqueoEmployee.value = String(item.employee_id || '');
                arqueoLastSavedAtMs = parseIsoToMs(item.updated_at) || 0;
                const openingV = parseMonedaARSInput(item.opening_amount || 0) || 0;
                const closingV = parseMonedaARSInput(item.closing_amount || 0) || 0;
                const hasEmployee = String(item.employee_id || '').trim().length > 0;
                const hasOpening = openingV > 0;
                const hasClosing = closingV > 0;
                if (hasEmployee && hasOpening && !hasClosing) {
                    setArqueoBadge('falta_cierre');
                } else {
                    setArqueoBadge('realizado');
                }
                validarCierreArqueo();
                checkArqueoStaleForDate(fecha);
            })
            .catch(() => {
                setArqueoBadge('pendiente');
                arqueoLastSavedAtMs = 0;
            });
    }

    function validarCierreArqueo() {
        if (!montoApertura || !montoCierre || !montoEfectivoDia) return;
        const apertura = parseMonedaARSInput(montoApertura.value || '0') || 0;
        const efectivoDia = parseMonedaARSInput(montoEfectivoDia.value || '0') || 0;
        const cierreStr = (montoCierre.value || '').trim();
        // No mostrar validaci√≥n hasta que el usuario ingrese el cierre
        if (!cierreStr) {
            if (msgArqueoOk) msgArqueoOk.classList.add('hidden');
            if (msgArqueoError) msgArqueoError.classList.add('hidden');
            if (msgArqueoDetalle) msgArqueoDetalle.classList.add('hidden');
            return;
        }
        const cierre = parseMonedaARSInput(cierreStr || '0') || 0;

        const cierreIdeal = apertura + efectivoDia;
        const diferencia = Math.abs(cierreIdeal - cierre);
        const coincide = diferencia < 0.00001;

        if (coincide) {
            mostrarMensajesArqueo({
                ok: true,
                detalle: 'Cierre de caja ideal ' + formatearMoneda(cierreIdeal) + ' ¬∑ Diferencia ' + formatearMoneda(0)
            });
        } else {
            mostrarMensajesArqueo({
                ok: false,
                detalle: 'Cierre de caja ideal ' + formatearMoneda(cierreIdeal) + ' ¬∑ Diferencia ' + formatearMoneda(diferencia)
            });
        }
    }

    function actualizarTotalEstimado() {
        if (!tablaCarrito || !totalEstimadoEl) return;
        let total = 0;
        const filas = tablaCarrito.querySelectorAll('tbody tr');
        filas.forEach(tr => {
            if (tr.id === 'carrito-empty-row') return;
            const inputSubtotal = tr.querySelector('.input-subtotal');
            if (!inputSubtotal) return;
            const subtotal = parseNumeroFlexible(inputSubtotal.value || '0');
            if (isFinite(subtotal)) total += subtotal;
        });
        totalEstimadoEl.textContent = formatearMoneda(total);
        computeTicketTotals();
        if (pasoTicket && !pasoTicket.classList.contains('hidden')) {
            renderTicketCartSummary();
            try { renderTicketCartItemsFromMainCart(); } catch (e) {}
        }
    }

    function renderTicketCartItemsFromMainCart() {
        if (!ticketCartItemsTbody) return;
        const items = getCartItems();
        if (!items.length) {
            ticketCartItemsTbody.innerHTML = '<tr><td colspan="4" class="px-2 py-3 text-center text-gray-400 text-[11px]">Sin √≠tems.</td></tr>';
            return;
        }
        ticketCartItemsTbody.innerHTML = '';
        let total = 0;
        items.forEach(it => {
            const qty = parseNumeroFlexible(it?.cantidad || 0) || 0;
            const unit = parseNumeroFlexible(it?.precio || 0) || 0;
            const sub = parseNumeroFlexible(it?.subtotal || 0) || 0;
            total += sub;

            const tr = document.createElement('tr');
            tr.innerHTML = ''
                + '<td class="px-2 py-1 text-gray-700 truncate">' + escapeHtml(String(it?.nombre || 'Producto')) + '</td>'
                + '<td class="px-2 py-1 text-right text-gray-500">' + String(qty || 0) + '</td>'
                + '<td class="px-2 py-1 text-right text-gray-500">' + formatearMoneda(unit) + '</td>'
                + '<td class="px-2 py-1 text-right text-gray-900 font-semibold">' + formatearMoneda(sub) + '</td>';
            ticketCartItemsTbody.appendChild(tr);
        });
        // UX: el total se muestra solo en el panel de resumen
    }

    function clearCartVenta() {
        try {
            if (typeof clearCartVentaRows === 'function') {
                clearCartVentaRows();
                return;
            }
        } catch (e) {
        }
        try {
            if (!tablaCarrito) return;
            const tbody = tablaCarrito.querySelector('tbody');
            if (!tbody) return;
            Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                if (tr && tr.id !== 'carrito-empty-row') tr.remove();
            });
            if (carritoEmptyRow) carritoEmptyRow.classList.remove('hidden');
        } catch (e) {
        }
        try { actualizarTotalEstimado(); } catch (e) {}
        try { renderTicketCartItemsFromMainCart(); } catch (e) {}
    }

    function getSelectedEmployeePayload(selectEl) {
        const sel = selectEl || null;
        const id = String(sel?.value || '').trim();
        if (!id) return {};
        let name = '';
        try {
            name = String(sel?.selectedOptions?.[0]?.textContent || '').trim();
        } catch (e) {
            name = '';
        }
        return {
            employee_id: id,
            employee_name: name || 'Empleado',
        };
    }

    function renderCcResumen(el, paid, due, show) {
        if (!el) return;
        const visible = !!show;
        el.classList.toggle('hidden', !visible);
        if (!visible) return;
        el.innerHTML = ''
            + '<div class="text-[11px] text-blue-700 font-semibold">Abona ' + formatearMoneda(paid) + '</div>'
            + '<div class="text-[11px] text-red-700 font-semibold">Debe ' + formatearMoneda(due) + '</div>';
    }

    function applyEmployeesToSelectors() {
        const list = Array.isArray(employeesCache) ? employeesCache.slice() : [];
        const active = list.filter(e => {
            try { return String(e?.id || '').trim().length > 0 && (e?.active !== false); } catch (err) { return false; }
        });
        const sorted = active.sort((a, b) => _employeeDisplayName(a).localeCompare(_employeeDisplayName(b), 'es'));

        const fill = function (selectEl, msgEl) {
            if (!selectEl) return;
            const prev = String(selectEl.value || '').trim();
            selectEl.innerHTML = '<option value="">‚Äî Seleccionar ‚Äî</option>';
            sorted.forEach(e => {
                const opt = document.createElement('option');
                opt.value = String(e?.id || '').trim();
                opt.textContent = _employeeDisplayName(e);
                selectEl.appendChild(opt);
            });
            let chosen = prev;
            if (!chosen) {
                try { chosen = String(window.localStorage.getItem('sales_last_employee_id') || '').trim(); } catch (e) { chosen = ''; }
            }
            if (chosen) {
                try { selectEl.value = chosen; } catch (e) {}
            }
            if (msgEl) msgEl.classList.toggle('hidden', sorted.length > 0);
        };

        fill(selectTicketEmployee, msgVentaNoEmployees);
        fill(selectCambioEmployee, msgCambioNoEmployees);
        fill(selectArqueoEmployee, msgArqueoNoEmployees);
    }

    function apiGetSale(ticket) {
        const t = String(ticket || '').trim();
        if (!t) return Promise.resolve(null);
        return fetch(apiPath('/sales/api/sales/' + encodeURIComponent(t)), { credentials: 'same-origin' })
            .then(r => r.json())
            .then(data => (data && data.ok && data.item) ? data.item : null)
            .catch(function () { return null; });
    }

    function clearCartVentaRows() {
        if (!tablaCarrito) return;
        try {
            const tbody = tablaCarrito.querySelector('tbody');
            if (!tbody) return;
            Array.from(tbody.querySelectorAll('tr')).forEach(tr => {
                if (tr && tr.id !== 'carrito-empty-row') tr.remove();
            });
            if (carritoEmptyRow) carritoEmptyRow.classList.remove('hidden');
        } catch (e) {
        }
        try { actualizarTotalEstimado(); } catch (e) {}
    }

    function addCartRowFromItem(it) {
        if (!tablaCarrito) return;
        const tbody = tablaCarrito.querySelector('tbody');
        if (!tbody) return;
        if (carritoEmptyRow) carritoEmptyRow.classList.add('hidden');

        const nombre = String(it?.nombre || it?.product_name || 'Producto');
        const productId = String(it?.product_id || it?.productId || '').trim();
        const precio = parseNumeroFlexible(it?.precio ?? it?.unit_price ?? it?.price ?? 0) || 0;
        const cantidad = parseNumeroFlexible(it?.cantidad ?? it?.qty ?? 1) || 0;
        const descuento = parseNumeroFlexible(it?.descuento ?? it?.discount_pct ?? 0) || 0;
        const subtotal = parseNumeroFlexible(it?.subtotal ?? 0) || ((precio * cantidad) * (1 - (Math.max(0, Math.min(100, descuento)) / 100)));

        const tr = document.createElement('tr');
        if (productId) tr.setAttribute('data-product-id', productId);
        tr.innerHTML = `
            <td class="px-1 py-1 text-gray-700 truncate">${escapeHtml(nombre)}</td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="text" inputmode="decimal" class="input-precio w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${formatearNumero(precio)}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" step="1" class="input-cantidad w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${String(cantidad)}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="text" inputmode="decimal" class="input-descuento w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${descuento ? formatearPct(descuento) : ''}"></td>
            <td class="px-1 py-1 text-right text-gray-900 font-medium"><input type="text" inputmode="decimal" class="input-subtotal w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${formatearNumero(subtotal)}"></td>
            <td class="px-1 py-1 text-center">
                <button type="button" class="btn-eliminar-item inline-flex items-center justify-center h-5 w-5 rounded-full bg-red-50 text-red-500 hover:bg-red-100">
                    <i class="fas fa-times text-[10px]"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);

        const inputPrecio = tr.querySelector('.input-precio');
        const inputCantidad = tr.querySelector('.input-cantidad');
        const inputDescuento = tr.querySelector('.input-descuento');
        const inputSubtotal = tr.querySelector('.input-subtotal');
        [
            { el: inputPrecio, origen: 'precio' },
            { el: inputCantidad, origen: 'cantidad' },
            { el: inputDescuento, origen: 'descuento' },
            { el: inputSubtotal, origen: 'subtotal' },
        ].forEach(({ el, origen }) => {
            if (!el) return;
            el.addEventListener('input', function () {
                recalcularFila(tr, origen === 'subtotal' ? 'subtotal' : 'otros');
            });
        });
    }

    function setPaymentMethodUi(method) {
        const m = String(method || '').trim();
        const radios = Array.from(document.querySelectorAll('input[name="forma_pago"]'));
        radios.forEach(r => {
            const v = String(r?.value || '').trim();
            r.checked = (v === m);
        });
    }

    function openEditTicket(ticket) {
        const t = String(ticket || '').trim();
        if (!t) return;
        Promise.resolve(apiGetSale(t)).then(function (sale) {
            if (!sale) {
                showAlertModal('No se pudo cargar el ticket ' + t + '.', 'Error', 'Operaci√≥n fallida');
                return;
            }

            showFlujo();
            setEditState(t);

            clearCartVentaRows();
            const items = Array.isArray(sale.items) ? sale.items : [];
            items.forEach(addCartRowFromItem);

            try {
                if (ticketFecha) ticketFecha.value = String(sale.fecha || '') || (ticketFecha.value || '');
                if (ticketNotas) ticketNotas.value = String(sale.notes || '');
            } catch (e) {
            }

            try {
                if (inputDescuentoGeneral) inputDescuentoGeneral.value = (sale.discount_general_pct ? formatearPct(parseFloat(sale.discount_general_pct || 0) || 0) : '');
                if (inputDescuentoGeneralPaso2) inputDescuentoGeneralPaso2.value = inputDescuentoGeneral?.value || '';
            } catch (e) {
            }

            try {
                const cid = String(sale.customer_id || '').trim();
                const cname = String(sale.customer_name || '').trim();
                if (cid || cname) setSelectedCustomer({ id: cid, name: cname || cid });
                else setSelectedCustomer(null);
            } catch (e) {
            }

            try {
                applyEmployeesToSelectors();
                const eid = String(sale.employee_id || '').trim();
                if (selectTicketEmployee && eid) selectTicketEmployee.value = eid;
            } catch (e) {
            }

            try { setPaymentMethodUi(sale.payment_method || 'Efectivo'); } catch (e) {}

            try { actualizarTotalEstimado(); } catch (e) {}
            try { showPasoTicket(); } catch (e) {}
        });
    }

    function renderTicketCartSummary() {
        const t = (window.ticketTotals && typeof window.ticketTotals === 'object') ? window.ticketTotals : computeTicketTotals();
        if (!t) return;
        try {
            if (ticketTotalSidebar) ticketTotalSidebar.textContent = formatearMoneda(parseFloat(t.total || 0) || 0);
        } catch (e) {
        }
        try {
            // En el HTML actual, el id "ticket-descuentos-sidebar" se usa para mostrar "Total estimado".
            // Mantenerlo consistente con el subtotal (antes de descuento general).
            if (ticketDescuentosSidebar) {
                const est = parseFloat((t.subtotalConDescItem != null ? t.subtotalConDescItem : t.subtotal) || 0) || 0;
                ticketDescuentosSidebar.textContent = formatearMoneda(est);
            }
        } catch (e) {
        }
    }

    function computeTicketTotals() {
        let subtotalConDescItem = 0;
        try {
            const filas = tablaCarrito ? Array.from(tablaCarrito.querySelectorAll('tbody tr')) : [];
            filas.forEach(tr => {
                if (!tr || tr.id === 'carrito-empty-row') return;
                const inputPrecio = tr.querySelector('.input-precio');
                const inputCantidad = tr.querySelector('.input-cantidad');
                const inputDescuento = tr.querySelector('.input-descuento');
                const inputSubtotal = tr.querySelector('.input-subtotal');
                if (!inputPrecio || !inputCantidad || !inputDescuento || !inputSubtotal) return;

                let precio = parseNumeroFlexible(inputPrecio.value || '0');
                let cantidad = parseNumeroFlexible(inputCantidad.value || '0');
                let descuento = parseNumeroFlexible(inputDescuento.value || '0');
                if (!isFinite(precio) || precio < 0) precio = 0;
                if (!isFinite(cantidad) || cantidad < 0) cantidad = 0;
                if (!isFinite(descuento) || descuento < 0) descuento = 0;
                if (descuento > 100) descuento = 100;

                const sub = (precio * cantidad) * (1 - descuento / 100);
                if (isFinite(sub)) subtotalConDescItem += sub;

                // Mantener subtotal consistente si el usuario toc√≥ precio/cantidad/desc
                try {
                    if (document.activeElement !== inputSubtotal) inputSubtotal.value = formatearNumero(sub);
                } catch (e) {
                }
            });
        } catch (e) {
        }

        let pct = 0;
        try {
            const raw = String((inputDescuentoGeneralPaso2 && document.activeElement === inputDescuentoGeneralPaso2)
                ? (inputDescuentoGeneralPaso2.value || '')
                : (inputDescuentoGeneral?.value || '')
            ).trim();
            pct = parseNumeroFlexible(raw || '0');
            if (!isFinite(pct) || pct < 0) pct = 0;
            if (pct > 100) pct = 100;
        } catch (e) {
            pct = 0;
        }

        const descGeneral = subtotalConDescItem * (pct / 100);
        const total = Math.max(0, subtotalConDescItem - descGeneral);

        try {
            window.ticketTotals = {
                subtotal: subtotalConDescItem,
                descuento: descGeneral,
                total: total,
                pct: pct,
            };
        } catch (e) {
        }

        try {
            if (totalEstimadoEl) totalEstimadoEl.textContent = formatearMoneda(subtotalConDescItem);
        } catch (e) {
        }
        try {
            if (inputTicketTotalFinal && document.activeElement !== inputTicketTotalFinal) {
                inputTicketTotalFinal.value = formatearMoneda(total);
            }
        } catch (e) {
        }

        try {
            if (inputDescuentoGeneralPaso2 && document.activeElement !== inputDescuentoGeneralPaso2) {
                inputDescuentoGeneralPaso2.value = inputDescuentoGeneral?.value || '';
            }
        } catch (e) {
        }

        return {
            subtotalConDescItem,
            pct,
            descGeneral,
            total,
        };
    }

    // --- Carrito de cambio ---
    function actualizarTotalCambio() {
        if (!tablaCarritoCambio || !totalCambioEl) return;
        let total = 0;
        const tbody = tablaCarritoCambio.querySelector('tbody');
        if (!tbody) return;
        const filas = tbody.querySelectorAll('tr');
        let hayItems = false;
        filas.forEach(tr => {
            if (tr.id === 'carrito-cambio-empty-row') return;
            hayItems = true;
            const inputSubtotal = tr.querySelector('.input-subtotal-cambio');
            if (!inputSubtotal) return;
            const subtotal = parseNumeroFlexible(inputSubtotal.value || '0');
            if (isFinite(subtotal)) total += subtotal;
        });
        const emptyRow = tbody.querySelector('#carrito-cambio-empty-row');
        if (emptyRow) {
            if (hayItems) emptyRow.remove();
            else emptyRow.classList.remove('hidden');
        }
        totalCambioEl.textContent = formatearMoneda(total);
    }

    function computeTicketTotalsCambio() {
        try {
            const t = String(totalCambioEl?.textContent || '').trim();
            if (t) {
                return { total: parseNumeroFlexible(t) || 0 };
            }
        } catch (e) {
        }
        let total = 0;
        try {
            const filas = tablaCarritoCambio ? Array.from(tablaCarritoCambio.querySelectorAll('tbody tr')) : [];
            filas.forEach(tr => {
                if (!tr || tr.id === 'carrito-cambio-empty-row') return;
                const inputSubtotal = tr.querySelector('.input-subtotal-cambio');
                if (!inputSubtotal) return;
                const sub = parseNumeroFlexible(inputSubtotal.value || '0');
                if (isFinite(sub)) total += sub;
            });
        } catch (e) {
        }
        return { total };
    }

    // --- Carrito de nueva venta con saldo a favor ---
    function actualizarTotalCambioVenta() {
        if (!tablaCarritoCambioVenta || !totalCambioVentaEl || !diferenciaAbonarEl) return;
        let total = 0;
        const tbody = tablaCarritoCambioVenta.querySelector('tbody');
        if (!tbody) return;
        const filas = tbody.querySelectorAll('tr');
        let hayItems = false;
        filas.forEach(tr => {
            if (tr.id === 'carrito-cambio-venta-empty-row') return;
            hayItems = true;
            const inputSubtotal = tr.querySelector('.input-subtotal-cambio-venta');
            if (!inputSubtotal) return;
            const subtotal = parseNumeroFlexible(inputSubtotal.value || '0');
            if (isFinite(subtotal)) total += subtotal;
        });
        const emptyRow = tbody.querySelector('#carrito-cambio-venta-empty-row');
        if (emptyRow) {
            if (hayItems) emptyRow.remove();
            else emptyRow.classList.remove('hidden');
        }
        totalCambioVentaEl.textContent = formatearMoneda(total);

        // Calcular diferencia a abonar usando el saldo a favor
        let diferencia = 0;
        if (total > saldoAFavor) {
            diferencia = total - saldoAFavor;
        }
        diferenciaAbonarEl.textContent = formatearMoneda(diferencia);

        try {
            maybeRefreshCambioGiftCode();
        } catch (e) {
        }

        try {
            renderCambioTicketCartSummary();
        } catch (e) {
        }
    }

    function recalcularFila(tr, origen) {
        const inputPrecio = tr.querySelector('.input-precio');
        const inputCantidad = tr.querySelector('.input-cantidad');
        const inputDescuento = tr.querySelector('.input-descuento');
        const inputSubtotal = tr.querySelector('.input-subtotal');
        if (!inputPrecio || !inputCantidad || !inputDescuento || !inputSubtotal) return;

        let precio = parseNumeroFlexible(inputPrecio.value || '0');
        let cantidad = parseNumeroFlexible(inputCantidad.value || '0');
        const rawDesc = String(inputDescuento.value || '');
        let descuento = parseNumeroFlexible(rawDesc || '0');
        let subtotal = parseNumeroFlexible(inputSubtotal.value || '0');

        if (precio < 0) precio = 0;
        if (cantidad < 0) cantidad = 0;

        const base = precio * cantidad;

        if (origen === 'subtotal' && base > 0) {
            // Ajustar descuento seg√∫n subtotal editado
            const ratio = subtotal / base;
            descuento = Math.max(0, Math.min(100, (1 - ratio) * 100));
            if (isFinite(descuento)) {
                inputDescuento.value = formatearPct(descuento);
            } else {
                inputDescuento.value = '';
            }
        } else {
            // Ajustar subtotal seg√∫n precio, cantidad o descuento
            if (descuento < 0) descuento = 0;
            if (descuento > 100) descuento = 100;
            subtotal = base * (1 - descuento / 100);
            inputSubtotal.value = formatearNumero(subtotal);
            if (isFinite(descuento)) {
                inputDescuento.value = formatearPct(descuento);
            } else {
                inputDescuento.value = '';
            }
        }

        actualizarTotalEstimado();
    }

    function getSelectedPaymentMethod() {
        const checked = document.querySelector('input[name="forma_pago"]:checked');
        const v = checked ? (checked.value || '') : '';
        return String(v || 'Efectivo');
    }

    function getCartItems() {
        if (!tablaCarrito) return [];
        const rows = Array.from(tablaCarrito.querySelectorAll('tbody tr'))
            .filter(tr => tr && tr.id !== 'carrito-empty-row');
        return rows.map(tr => {
            const nombre = (tr.querySelector('td')?.textContent || '').trim();
            const precio = parseNumeroFlexible(tr.querySelector('.input-precio')?.value || '0') || 0;
            const cantidad = parseNumeroFlexible(tr.querySelector('.input-cantidad')?.value || '0') || 0;
            const descuento = parseNumeroFlexible(tr.querySelector('.input-descuento')?.value || '0') || 0;
            const subtotal = parseNumeroFlexible(tr.querySelector('.input-subtotal')?.value || '0') || 0;
            const productId = tr.getAttribute('data-product-id') || '';
            return { nombre, precio, cantidad, descuento, subtotal, product_id: productId };
        }).filter(x => x && x.cantidad > 0);
    }

    function sortLotsForMethod(lots, method) {
        const list = (Array.isArray(lots) ? lots : []).slice();
        const m = String(method || 'FIFO');
        const getTime = (l) => {
            const d = String(l?.entry_date || '').trim();
            const t = d ? new Date(d).getTime() : 0;
            return isNaN(t) ? 0 : t;
        };
        if (m === 'UEPS') {
            return list.sort((a, b) => getTime(b) - getTime(a));
        }
        return list.sort((a, b) => getTime(a) - getTime(b));
    }

    function consumirStockParaProducto(ctx) {
        const product = ctx.product;
        const lotsAll = ctx.lotsAll;
        const qty = ctx.qty;
        const method = String(product?.method || 'FIFO');

        const rel = lotsAll.filter(l => String(l?.product_id) === String(product?.id) && (parseFloat(l?.qty_available || '0') || 0) > 0);
        const ordered = sortLotsForMethod(rel, method);

        const totalDisponible = ordered.reduce((acc, l) => acc + (parseFloat(l?.qty_available || '0') || 0), 0);
        if (totalDisponible + 1e-9 < qty) {
            return { ok: false, message: 'Stock insuficiente para ' + String(product?.name || 'producto') + ' (disponible: ' + totalDisponible + ')', consumptions: [] };
        }

        let remaining = qty;
        const consumptions = [];

        if (method === 'Average') {
            const costSum = ordered.reduce((acc, l) => acc + ((parseFloat(l?.qty_available || '0') || 0) * (parseFloat(l?.unit_cost || '0') || 0)), 0);
            const avgCost = totalDisponible > 0 ? (costSum / totalDisponible) : 0;
            // Descontamos FIFO para consistencia f√≠sica, pero costo promedio para trazabilidad
            ordered.forEach(l => {
                if (remaining <= 0) return;
                const avail = parseFloat(l?.qty_available || '0') || 0;
                const take = Math.min(avail, remaining);
                if (take <= 0) return;
                l.qty_available = avail - take;
                remaining -= take;
                consumptions.push({ lot_id: l.id, qty: take, unit_cost: avgCost, cost_total: take * avgCost });
            });
            return { ok: true, consumptions };
        }

        ordered.forEach(l => {
            if (remaining <= 0) return;
            const avail = parseFloat(l?.qty_available || '0') || 0;
            const take = Math.min(avail, remaining);
            if (take <= 0) return;
            l.qty_available = avail - take;
            remaining -= take;
            const uc = parseFloat(l?.unit_cost || '0') || 0;
            consumptions.push({ lot_id: l.id, qty: take, unit_cost: uc, cost_total: take * uc });
        });

        return { ok: true, consumptions };
    }

    function appendHistorialRowVenta(venta) {
        if (!historial || !historialTbody) return;
        const tr = document.createElement('tr');
        tr.innerHTML = ''
            + '<td class="px-3 py-2 text-gray-500">' + String(venta?.ticket || '') + '</td>'
            + '<td class="px-3 py-2 text-gray-500">' + String(venta?.fecha || '‚Äî') + '</td>'
            + '<td class="px-3 py-2 text-gray-500">Venta</td>'
            + '<td class="px-3 py-2 text-gray-500">' + String(venta?.customer_name || '‚Äî') + '</td>'
            + '<td class="px-3 py-2 text-right text-gray-500">' + formatearMoneda(parseFloat(venta?.total || '0') || 0) + '</td>'
            + '<td class="px-3 py-2 text-center text-gray-500">' + String(venta?.payment_method || 'Efectivo') + '</td>'
            + '<td class="px-3 py-2 text-center"><span class="px-2 py-0.5 rounded-full bg-green-50 text-green-700 text-[11px]">Completada</span></td>'
            + '<td class="px-3 py-2 text-center">' + historialAccionesHtml(String(venta?.ticket || '')) + '</td>';
        historialTbody.insertBefore(tr, historialTbody.firstChild);
    }

    function recalcularFilaCambio(tr, origen) {
        const inputPrecio = tr.querySelector('.input-precio-cambio');
        const inputCantidad = tr.querySelector('.input-cantidad-cambio');
        const inputDescuento = tr.querySelector('.input-descuento-cambio');
        const inputSubtotal = tr.querySelector('.input-subtotal-cambio');
        if (!inputPrecio || !inputCantidad || !inputDescuento || !inputSubtotal) return;

        let precio = parseNumeroFlexible(inputPrecio.value || '0');
        let cantidad = parseNumeroFlexible(inputCantidad.value || '0');
        let descuento = parseNumeroFlexible(inputDescuento.value || '0');
        let subtotal = parseNumeroFlexible(inputSubtotal.value || '0');

        if (precio < 0) precio = 0;
        if (cantidad < 0) cantidad = 0;

        const base = precio * cantidad;

        if (origen === 'subtotal' && base > 0) {
            const ratio = subtotal / base;
            descuento = Math.max(0, Math.min(100, (1 - ratio) * 100));
            inputDescuento.value = isFinite(descuento) ? formatearPct(descuento) : '';
        } else {
            if (descuento < 0) descuento = 0;
            if (descuento > 100) descuento = 100;
            subtotal = base * (1 - descuento / 100);
            inputSubtotal.value = formatearNumero(subtotal);
            inputDescuento.value = isFinite(descuento) ? formatearPct(descuento) : '';
        }

        actualizarTotalCambio();
    }

    function recalcularFilaCambioVenta(tr, origen) {
        const inputPrecio = tr.querySelector('.input-precio-cambio-venta');
        const inputCantidad = tr.querySelector('.input-cantidad-cambio-venta');
        const inputDescuento = tr.querySelector('.input-descuento-cambio-venta');
        const inputSubtotal = tr.querySelector('.input-subtotal-cambio-venta');
        if (!inputPrecio || !inputCantidad || !inputDescuento || !inputSubtotal) return;

        let precio = parseNumeroFlexible(inputPrecio.value || '0');
        let cantidad = parseNumeroFlexible(inputCantidad.value || '0');
        let descuento = parseNumeroFlexible(inputDescuento.value || '0');
        let subtotal = parseNumeroFlexible(inputSubtotal.value || '0');

        if (precio < 0) precio = 0;
        if (cantidad < 0) cantidad = 0;

        const base = precio * cantidad;

        if (origen === 'subtotal' && base > 0) {
            const ratio = subtotal / base;
            descuento = Math.max(0, Math.min(100, (1 - ratio) * 100));
            inputDescuento.value = isFinite(descuento) ? formatearPct(descuento) : '';
        } else {
            if (descuento < 0) descuento = 0;
            if (descuento > 100) descuento = 100;
            subtotal = base * (1 - descuento / 100);
            inputSubtotal.value = formatearNumero(subtotal);
            inputDescuento.value = isFinite(descuento) ? formatearPct(descuento) : '';
        }

        actualizarTotalCambioVenta();
    }

    function agregarProductoAlCarrito(nombre, precioStr, meta) {
        if (!tablaCarrito) return;
        const tbody = tablaCarrito.querySelector('tbody');
        if (!tbody) return;

        let precio = parseNumeroFlexible(precioStr);
        const cantidad = 1;
        const descuento = 0;
        const subtotal = precio * cantidad;

        const descuentoValue = '';

        const productId = (meta && meta.productId) ? String(meta.productId).trim() : '';

        try {
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => r && r.id !== 'carrito-empty-row');
            let found = null;
            if (productId) {
                found = rows.find(r => String(r.getAttribute('data-product-id') || '').trim() === productId) || null;
            }
            if (!found) {
                found = rows.find(r => {
                    const td = r.querySelector('td');
                    return td && String(td.textContent || '').trim() === String(nombre || '').trim();
                }) || null;
            }
            if (found) {
                const inputCantidadExist = found.querySelector('.input-cantidad');
                if (inputCantidadExist) {
                    const currQty = parseFloat(inputCantidadExist.value || '0') || 0;
                    inputCantidadExist.value = String(currQty + 1);
                }
                recalcularFila(found, 'otros');
                return;
            }
        } catch (e) {
        }

        if (carritoEmptyRow) {
            carritoEmptyRow.classList.add('hidden');
        }

        const tr = document.createElement('tr');
        if (productId) tr.setAttribute('data-product-id', productId);
        tr.innerHTML = `
            <td class="px-1 py-1 text-gray-700 truncate">${nombre}</td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="text" inputmode="decimal" class="input-precio w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${formatearNumero(precio)}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" step="1" class="input-cantidad w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${cantidad}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="text" inputmode="decimal" class="input-descuento w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${descuentoValue}"></td>
            <td class="px-1 py-1 text-right text-gray-900 font-medium"><input type="text" inputmode="decimal" class="input-subtotal w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${formatearNumero(subtotal)}"></td>
            <td class="px-1 py-1 text-center">
                <button type="button" class="btn-eliminar-item inline-flex items-center justify-center h-5 w-5 rounded-full bg-red-50 text-red-500 hover:bg-red-100">
                    <i class="fas fa-times text-[10px]"></i>
                </button>
            </td>
        `;

        tbody.appendChild(tr);

        const inputPrecio = tr.querySelector('.input-precio');
        const inputCantidad = tr.querySelector('.input-cantidad');
        const inputDescuento = tr.querySelector('.input-descuento');
        const inputSubtotal = tr.querySelector('.input-subtotal');

        [
            { el: inputPrecio, origen: 'precio' },
            { el: inputCantidad, origen: 'cantidad' },
            { el: inputDescuento, origen: 'descuento' },
            { el: inputSubtotal, origen: 'subtotal' },
        ].forEach(({ el, origen }) => {
            if (!el) return;
            el.addEventListener('input', function () {
                recalcularFila(tr, origen === 'subtotal' ? 'subtotal' : 'otros');
            });
        });

        // UX para el descuento: limpiar 0.00 al enfocar y restaurar si queda vac√≠o
        if (inputDescuento) {
            inputDescuento.addEventListener('focus', function() {
                if (inputDescuento.value === '0.00' || inputDescuento.value === '0' || inputDescuento.value === '0.0') {
                    inputDescuento.value = '';
                }
            });
            inputDescuento.addEventListener('blur', function() {
                if (inputDescuento.value.trim() !== '') {
                    recalcularFila(tr, 'otros');
                }
            });
        }

        actualizarTotalEstimado();
    }

    function agregarProductoAlCarritoCambio(nombre, precioStr, meta) {
        if (!tablaCarritoCambio) return;
        const tbody = tablaCarritoCambio.querySelector('tbody');
        if (!tbody) return;

        let precio = parseNumeroFlexible(precioStr);
        const cantidad = 1;
        const descuento = 0;
        const subtotal = precio * cantidad;

        try {
            const productId = String(meta && meta.productId ? meta.productId : '').trim();
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => r && r.id !== 'carrito-cambio-empty-row');
            let found = null;
            if (productId) {
                found = rows.find(r => String(r.getAttribute('data-product-id') || '').trim() === productId) || null;
            }
            if (!found && !productId) {
                const nm = String(nombre || '').trim();
                found = rows.find(r => {
                    const pid = String(r.getAttribute('data-product-id') || '').trim();
                    if (pid) return false;
                    const td = r.querySelector('td');
                    return td && String(td.textContent || '').trim() === nm;
                }) || null;
            }
            if (found) {
                const emptyRow = tbody.querySelector('#carrito-cambio-empty-row');
                if (emptyRow) emptyRow.remove();
                const inputPrecioExist = found.querySelector('.input-precio-cambio');
                const inputCantidadExist = found.querySelector('.input-cantidad-cambio');
                if (inputPrecioExist) inputPrecioExist.value = formatearNumero(precio);
                if (inputCantidadExist) {
                    const cur = parseFloat(inputCantidadExist.value || '0') || 0;
                    inputCantidadExist.value = String(cur + 1);
                }
                recalcularFilaCambio(found, 'otros');
                actualizarTotalCambio();
                return;
            }
        } catch (e) {
        }

        const emptyRow = tbody.querySelector('#carrito-cambio-empty-row');
        if (emptyRow) emptyRow.remove();

        const tr = document.createElement('tr');
        if (meta && meta.productId) tr.setAttribute('data-product-id', String(meta.productId));
        tr.innerHTML = `
            <td class="px-1 py-1 text-gray-700 truncate">${nombre}</td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="text" inputmode="decimal" class="input-precio-cambio w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${formatearNumero(precio)}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" step="1" class="input-cantidad-cambio w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${cantidad}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="text" inputmode="decimal" class="input-descuento-cambio w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${formatearPct(descuento)}"></td>
            <td class="px-1 py-1 text-right text-gray-900 font-medium"><input type="text" inputmode="decimal" class="input-subtotal-cambio w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${formatearNumero(subtotal)}"></td>
            <td class="px-1 py-1 text-center">
                <button type="button" class="btn-eliminar-item-cambio inline-flex items-center justify-center h-5 w-5 rounded-full bg-red-50 text-red-500 hover:bg-red-100">
                    <i class="fas fa-times text-[10px]"></i>
                </button>
            </td>
        `;

        tbody.appendChild(tr);

        const inputPrecio = tr.querySelector('.input-precio-cambio');
        const inputCantidad = tr.querySelector('.input-cantidad-cambio');
        const inputDescuento = tr.querySelector('.input-descuento-cambio');
        const inputSubtotal = tr.querySelector('.input-subtotal-cambio');

        [
            { el: inputPrecio, origen: 'precio' },
            { el: inputCantidad, origen: 'cantidad' },
            { el: inputDescuento, origen: 'descuento' },
            { el: inputSubtotal, origen: 'subtotal' },
        ].forEach(({ el, origen }) => {
            if (!el) return;
            el.addEventListener('input', function () {
                recalcularFilaCambio(tr, origen === 'subtotal' ? 'subtotal' : 'otros');
            });
        });

        // UX para el descuento de cambio: limpiar 0.00 al enfocar y restaurar si queda vac√≠o
        if (inputDescuento) {
            inputDescuento.addEventListener('focus', function() {
                if (inputDescuento.value === '0.00' || inputDescuento.value === '0' || inputDescuento.value === '0.0') {
                    inputDescuento.value = '';
                }
            });
            inputDescuento.addEventListener('blur', function() {
                if (inputDescuento.value.trim() !== '') recalcularFilaCambio(tr, 'otros');
            });
        }

        actualizarTotalCambio();
    }

    function agregarProductoAlCarritoCambioVenta(nombre, precioStr, meta) {
        if (!tablaCarritoCambioVenta) return;
        const tbody = tablaCarritoCambioVenta.querySelector('tbody');
        if (!tbody) return;

        let precio = parseNumeroFlexible(precioStr);
        const cantidad = 1;
        const descuento = 0;
        const subtotal = precio * cantidad;

        try {
            const productId = String(meta && meta.productId ? meta.productId : '').trim();
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(r => r && r.id !== 'carrito-cambio-venta-empty-row');
            let found = null;
            if (productId) {
                found = rows.find(r => String(r.getAttribute('data-product-id') || '').trim() === productId) || null;
            }
            if (!found && !productId) {
                const nm = String(nombre || '').trim();
                found = rows.find(r => {
                    const pid = String(r.getAttribute('data-product-id') || '').trim();
                    if (pid) return false;
                    const td = r.querySelector('td');
                    return td && String(td.textContent || '').trim() === nm;
                }) || null;
            }
            if (found) {
                const emptyRow = tbody.querySelector('#carrito-cambio-venta-empty-row');
                if (emptyRow) emptyRow.remove();
                const inputPrecioExist = found.querySelector('.input-precio-cambio-venta');
                const inputCantidadExist = found.querySelector('.input-cantidad-cambio-venta');
                if (inputPrecioExist) inputPrecioExist.value = formatearNumero(precio);
                if (inputCantidadExist) {
                    const cur = parseFloat(inputCantidadExist.value || '0') || 0;
                    inputCantidadExist.value = String(cur + 1);
                }
                recalcularFilaCambioVenta(found, 'otros');
                actualizarTotalCambioVenta();
                return;
            }
        } catch (e) {
        }

        const emptyRow = tbody.querySelector('#carrito-cambio-venta-empty-row');
        if (emptyRow) emptyRow.remove();

        const tr = document.createElement('tr');
        if (meta && meta.productId) tr.setAttribute('data-product-id', String(meta.productId));
        tr.innerHTML = `
            <td class="px-1 py-1 text-gray-700 truncate">${nombre}</td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="text" inputmode="decimal" class="input-precio-cambio-venta w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${formatearNumero(precio)}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="number" min="0" step="1" class="input-cantidad-cambio-venta w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${cantidad}"></td>
            <td class="px-1 py-1 text-right text-gray-500"><input type="text" inputmode="decimal" class="input-descuento-cambio-venta w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${formatearPct(descuento)}"></td>
            <td class="px-1 py-1 text-right text-gray-900 font-medium"><input type="text" inputmode="decimal" class="input-subtotal-cambio-venta w-full px-1 py-0.5 border rounded text-right text-[11px]" value="${formatearNumero(subtotal)}"></td>
            <td class="px-1 py-1 text-center">
                <button type="button" class="btn-eliminar-item-cambio-venta inline-flex items-center justify-center h-5 w-5 rounded-full bg-red-50 text-red-500 hover:bg-red-100">
                    <i class="fas fa-times text-[10px]"></i>
                </button>
            </td>
        `;

        tbody.appendChild(tr);

        const inputPrecio = tr.querySelector('.input-precio-cambio-venta');
        const inputCantidad = tr.querySelector('.input-cantidad-cambio-venta');
        const inputDescuento = tr.querySelector('.input-descuento-cambio-venta');
        const inputSubtotal = tr.querySelector('.input-subtotal-cambio-venta');

        [
            { el: inputPrecio, origen: 'precio' },
            { el: inputCantidad, origen: 'cantidad' },
            { el: inputDescuento, origen: 'descuento' },
            { el: inputSubtotal, origen: 'subtotal' },
        ].forEach(({ el, origen }) => {
            if (!el) return;
            el.addEventListener('input', function () {
                recalcularFilaCambioVenta(tr, origen === 'subtotal' ? 'subtotal' : 'otros');
            });
        });

        // UX para el descuento: limpiar 0.00 al enfocar y restaurar si queda vac√≠o
        if (inputDescuento) {
            inputDescuento.addEventListener('focus', function() {
                if (inputDescuento.value === '0.00' || inputDescuento.value === '0' || inputDescuento.value === '0.0') {
                    inputDescuento.value = '';
                }
            });
            inputDescuento.addEventListener('blur', function() {
                if (inputDescuento.value.trim() !== '') recalcularFilaCambioVenta(tr, 'otros');
            });
        }

        actualizarTotalCambioVenta();
    }

    if (btnNuevaVenta && home && flujo) {
        btnNuevaVenta.addEventListener('click', function() {
            // Mostrar siempre el flujo y ocultar el home
            showFlujo();
            setEditState(null);

            // Asegurar estado consistente del Paso 1 (header + pills)
            showPasoProductos();
        });
    }

    if (btnVolverHome && home && flujo) {
        btnVolverHome.addEventListener('click', function() {
            if (modalExitVenta) {
                openModal(modalExitVenta);
                return;
            }
            showHomeAll();
            setEditState(null);
            scrollAElemento(home);
        });
    }

    if (btnIrCambios) {
        btnIrCambios.addEventListener('click', function() {
            // Asegurar que solo la vista de cambio est√© visible
            showCambio();

            try {
                if (inputSearchCambioProducts) inputSearchCambioProducts.value = '';
                if (inputSearchCambioVentaProducts) inputSearchCambioVentaProducts.value = '';
                cambioSearchQuery = '';
                cambioVentaSearchQuery = '';
                applyCambioProductsFilter();
                applyCambioVentaProductsFilter();
            } catch (e) {
            }

            try {
                cambioIsGift = false;
                cambioGiftCode = '';
                renderGiftUiCambio();
            } catch (e) {
            }

            try {
                if (inputCambioTicket) inputCambioTicket.value = computeNextCambioTicketPreview();
            } catch (e) {
            }

            // Abrir siempre la vista de cambio arrancando en Paso 1
            if (cambioPaso1) cambioPaso1.classList.remove('hidden');
            if (cambioPaso2) cambioPaso2.classList.add('hidden');
            if (cambioPaso3) cambioPaso3.classList.add('hidden');

            if (pillCambioPaso1) {
                pillCambioPaso1.classList.add('bg-indigo-600','text-white');
                pillCambioPaso1.classList.remove('bg-indigo-50','text-indigo-700');
            }
            if (pillCambioPaso2) {
                pillCambioPaso2.classList.add('bg-indigo-50','text-indigo-700');
                pillCambioPaso2.classList.remove('bg-indigo-600','text-white');
            }
            if (pillCambioPaso3) {
                pillCambioPaso3.classList.add('bg-indigo-50','text-indigo-700');
                pillCambioPaso3.classList.remove('bg-indigo-600','text-white');
                pillCambioPaso3.classList.remove('bg-gray-100','text-gray-600');
            }

            if (vistaRealizarCambio) {
                if (!home || !home.contains(vistaRealizarCambio)) vistaRealizarCambio.classList.remove('hidden');
                scrollAElemento(vistaRealizarCambio);
            } else if (historial) {
                historial.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        });
    }

    if (btnContinuarTicket && pasoProductos && pasoTicket) {
        btnContinuarTicket.addEventListener('click', function() {
            showPasoTicket();
        });
    }

    // Permitir navegar de paso 1 a 2 tocando las pills
    if (pillPaso1 && pillPaso2 && pasoProductos && pasoTicket) {
        pillPaso1.style.cursor = 'pointer';
        pillPaso2.style.cursor = 'pointer';

        pillPaso1.addEventListener('click', function() {
            showPasoProductos();
        });

        pillPaso2.addEventListener('click', function() {
            showPasoTicket();
        });
    }

    if (btnVolverPaso1 && pasoProductos && pasoTicket) {
        btnVolverPaso1.addEventListener('click', function() {
            showPasoProductos();
        });
    }

    if (btnSelectCliente) {
        btnSelectCliente.addEventListener('click', function () {
            openSelectCustomer('sale');
        });
    }

    if (btnCrearCliente) {
        btnCrearCliente.addEventListener('click', function () {
            openCreateCustomer(currentCustomerNameFromInput());
        });
    }

    if (btnSelectClienteCambio) {
        btnSelectClienteCambio.addEventListener('click', function () {
            openSelectCustomer('cambio');
        });
    }

    if (btnSelectClienteCambioBottom) {
        btnSelectClienteCambioBottom.addEventListener('click', function () {
            openSelectCustomer('cambio');
        });
    }

    if (btnCrearClienteCambio) {
        btnCrearClienteCambio.addEventListener('click', function () {
            const prefill = String(document.getElementById('cambio-cliente')?.value || '').trim();
            openCreateCustomer(prefill);
        });
    }

    // (El bot√≥n btn-arqueo fue removido del UI: el c√°lculo ahora es autom√°tico)

    if (montoApertura) {
        montoApertura.addEventListener('input', function() {
            recalcularArqueoAutomatico();
        });
    }

    if (montoCierre) {
        montoCierre.addEventListener('input', function() {
            recalcularArqueoAutomatico();
        });
    }

    const inputFechaArqueo = document.getElementById('fecha-arqueo');
    if (inputFechaArqueo) {
        inputFechaArqueo.addEventListener('change', function() {
            recalcularArqueoAutomatico();
            loadArqueoFromServer();
        });
    }

    if (selectArqueoEmployee) {
        selectArqueoEmployee.addEventListener('change', function () {
            if (msgArqueoEmployeeRequired) msgArqueoEmployeeRequired.classList.add('hidden');
        });
    }

    if (btnGuardarArqueo && montoApertura && montoEfectivoDia && montoCierre) {
        btnGuardarArqueo.addEventListener('click', function() {
            // Asegurar c√°lculo y validaci√≥n antes de guardar
            recalcularArqueoAutomatico();
            validarCierreArqueo();

            if (msgArqueoEmployeeRequired) msgArqueoEmployeeRequired.classList.add('hidden');
            const employeeId = String(selectArqueoEmployee?.value || '').trim();
            if (!employeeId) {
                if (msgArqueoEmployeeRequired) msgArqueoEmployeeRequired.classList.remove('hidden');
                if (selectArqueoEmployee && !selectArqueoEmployee.disabled) selectArqueoEmployee.focus();
                return;
            }
            const employeeName = String(selectArqueoEmployee?.selectedOptions?.[0]?.textContent || '').trim();
            const fecha = String(document.getElementById('fecha-arqueo')?.value || '').trim();
            if (!fecha) return;

            const opening = parseMonedaARSInput(montoApertura.value || '0') || 0;
            const cashDay = parseMonedaARSInput(montoEfectivoDia.value || '0') || 0;
            const closing = parseMonedaARSInput(montoCierre.value || '0') || 0;

            fetch(apiPath('/sales/api/cash-count'), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'same-origin',
                body: JSON.stringify({
                    date: fecha,
                    employee_id: employeeId,
                    employee_name: employeeName,
                    opening_amount: opening,
                    cash_day_amount: cashDay,
                    closing_amount: closing
                })
            })
                .then(async (r) => {
                    let data = null;
                    try {
                        data = await r.json();
                    } catch (e) {
                        data = null;
                    }
                    if (!r.ok) {
                        const msg = (data && (data.message || data.error)) ? String(data.message || data.error) : 'No se pudo guardar el arqueo.';
                        mostrarMensajesArqueo({ ok: false, detalle: msg });
                        throw new Error(msg);
                    }
                    return data;
                })
                .then(data => {
                    if (!data || !data.ok) {
                        const msg = (data && (data.message || data.error)) ? String(data.message || data.error) : 'No se pudo guardar el arqueo.';
                        mostrarMensajesArqueo({ ok: false, detalle: msg });
                        return;
                    }
                    arqueoLastSavedAtMs = Date.now();
                    const opening = parseMonedaARSInput(montoApertura.value || '0') || 0;
                    const closing = parseMonedaARSInput(montoCierre.value || '0') || 0;
                    const employeeId = String(selectArqueoEmployee?.value || '').trim();
                    if (employeeId && opening > 0 && !(closing > 0)) {
                        setArqueoBadge('falta_cierre');
                    } else {
                        setArqueoBadge('realizado');
                    }
                    if (msgArqueoGuardado) {
                        msgArqueoGuardado.classList.remove('hidden');
                        window.setTimeout(function () { msgArqueoGuardado.classList.add('hidden'); }, 2000);
                    }
                    validarCierreArqueo();
                })
                .catch((e) => {
                    const msg = e && e.message ? String(e.message) : 'No se pudo guardar el arqueo.';
                    mostrarMensajesArqueo({ ok: false, detalle: msg });
                });
        });
    }

    initArqueoEmployees();
    setArqueoBadge('pendiente');
    loadArqueoFromServer();

    if (cashflowChannel) {
        try {
            cashflowChannel.addEventListener('message', function (e) {
                const msg = e && e.data ? e.data : null;
                if (!msg) return;
                const d = getCashflowEventDate(msg);
                const arqueoDate = String(document.getElementById('fecha-arqueo')?.value || '').trim();
                if (d && arqueoDate && d !== arqueoDate) return;
                if (msg?.kind === 'expense' && !isCashMethod(msg?.payment_method || msg?.forma_pago)) return;
                maybeMarkArqueoPending('cashflow');
            });
        } catch (e) {
        }
    }
    window.addEventListener('storage', function (e) {
        if (!e || e.key !== 'zentral_cashflow_ping') return;
        try {
            const msg = e.newValue ? JSON.parse(e.newValue) : null;
            if (!msg) return;
            const d = getCashflowEventDate(msg);
            const arqueoDate = String(document.getElementById('fecha-arqueo')?.value || '').trim();
            if (d && arqueoDate && d !== arqueoDate) return;
            if (msg?.kind === 'expense' && !isCashMethod(msg?.payment_method || msg?.forma_pago)) return;
            maybeMarkArqueoPending('cashflow');
        } catch (err) {
        }
    });

    if (btnToggleArqueo) {
        btnToggleArqueo.addEventListener('click', function () {
            openArqueoModal();
            initArqueoEmployees();
            loadArqueoFromServer();
            recalcularArqueoAutomatico();
        });
    }
    if (btnCloseArqueo) btnCloseArqueo.addEventListener('click', closeArqueoModal);
    if (btnCancelArqueo) btnCancelArqueo.addEventListener('click', closeArqueoModal);
    if (modalArqueo) {
        modalArqueo.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalArqueo.firstElementChild) closeArqueoModal();
        });
    }

    if (tablaCarrito) {
        bindProductButtons();
    }

    // Guard defensivo: evitar pantalla en blanco si por alg√∫n motivo todas las vistas quedan ocultas
    try {
        const homeHidden = !!(home && home.classList.contains('hidden'));
        const flujoHidden = !!(flujo && flujo.classList.contains('hidden'));
        const cambioHidden = !!(vistaRealizarCambio && vistaRealizarCambio.classList.contains('hidden'));
        if (home && (homeHidden && flujoHidden && cambioHidden)) {
            home.classList.remove('hidden');
        }
        if (home && !home.classList.contains('hidden')) {
            const flujoVisible = !!(flujo && !flujo.classList.contains('hidden'));
            const cambioVisible = !!(vistaRealizarCambio && !vistaRealizarCambio.classList.contains('hidden'));
            if (!flujoVisible && !cambioVisible) {
                showHomeAll();
            }
        }
    } catch (e) {
    }

    if (toggleVentaLibre && panelVentaLibre) {
        toggleVentaLibre.addEventListener('change', function() {
            if (toggleVentaLibre.checked) {
                panelVentaLibre.classList.remove('hidden');
                if (inputVentaLibreNombre) inputVentaLibreNombre.focus();
            } else {
                panelVentaLibre.classList.add('hidden');
            }
        });
    }

    const ventaLibreHeader = document.getElementById('venta-libre-header');
    if (ventaLibreHeader && toggleVentaLibre) {
        ventaLibreHeader.addEventListener('click', function (e) {
            const t = e && e.target ? e.target : null;
            if (t && (t.closest('input') || t.closest('label'))) return;
            toggleVentaLibre.checked = !toggleVentaLibre.checked;
            toggleVentaLibre.dispatchEvent(new Event('change', { bubbles: true }));
        });
    }

    function agregarVentaLibreDesdeFormulario() {
        if (!inputVentaLibreNombre || !inputVentaLibrePrecio) return;
        const nombre = (inputVentaLibreNombre.value || '').trim();
        const precio = parseFloat(inputVentaLibrePrecio.value || '0');
        if (!nombre) return;
        agregarProductoAlCarrito(nombre, isNaN(precio) ? '0' : String(precio.toFixed(2)));
        inputVentaLibreNombre.value = '';
        inputVentaLibrePrecio.value = '';
        inputVentaLibreNombre.focus();
    }

    if (btnAgregarVentaLibre) {
        btnAgregarVentaLibre.addEventListener('click', function() {
            agregarVentaLibreDesdeFormulario();
        });
    }

    if (inputVentaLibreNombre) {
        inputVentaLibreNombre.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                agregarVentaLibreDesdeFormulario();
            }
        });
    }

    if (inputVentaLibrePrecio) {
        inputVentaLibrePrecio.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                agregarVentaLibreDesdeFormulario();
            }
        });
    }

    // Cat√°logo de cambio: agregar productos al carrito de cambio
    if (false && botonesProductoCambio && botonesProductoCambio.length && tablaCarritoCambio) {
        botonesProductoCambio.forEach(btn => {
            btn.addEventListener('click', function() {
                const nombre = btn.getAttribute('data-nombre') || 'Producto';
                const precio = btn.getAttribute('data-precio') || '0';
                agregarProductoAlCarritoCambio(nombre, precio);
            });
        });
    }

    // Eliminar √≠tems del carrito (delegado sobre la tabla)
    if (tablaCarrito) {
        tablaCarrito.addEventListener('click', function(e) {
            const btnDel = e.target.closest('.btn-eliminar-item');
            if (!btnDel) return;
            const fila = btnDel.closest('tr');
            if (!fila) return;
            fila.remove();

            // Si no quedan filas de √≠tems, mostrar mensaje vac√≠o
            const filasRestantes = tablaCarrito.querySelectorAll('tbody tr');
            let hayItems = false;
            filasRestantes.forEach(tr => {
                if (tr.id !== 'carrito-empty-row') {
                    hayItems = true;
                }
            });
            if (!hayItems && carritoEmptyRow) {
                carritoEmptyRow.classList.remove('hidden');
            }

            actualizarTotalEstimado();
        });
    }

    // Eliminar √≠tems del carrito de cambio (delegado sobre la tabla)
    if (tablaCarritoCambio) {
        tablaCarritoCambio.addEventListener('click', function(e) {
            const btnDel = e.target.closest('.btn-eliminar-item-cambio');
            if (!btnDel) return;
            const fila = btnDel.closest('tr');
            if (!fila) return;
            fila.remove();

            const filasRestantes = tablaCarritoCambio.querySelectorAll('tbody tr');
            let hayItems = false;
            filasRestantes.forEach(tr => {
                if (tr.id !== 'carrito-cambio-empty-row') {
                    hayItems = true;
                }
            });
            if (!hayItems && carritoCambioEmptyRow) {
                carritoCambioEmptyRow.classList.remove('hidden');
            }

            actualizarTotalCambio();
        });
    }

    // Cat√°logo de nueva venta en flujo de cambio: agregar productos al carrito de nueva venta
    if (false && botonesProductoCambioVenta && botonesProductoCambioVenta.length && tablaCarritoCambioVenta) {
        botonesProductoCambioVenta.forEach(btn => {
            btn.addEventListener('click', function() {
                const nombre = btn.getAttribute('data-nombre') || 'Producto';
                const precio = btn.getAttribute('data-precio') || '0';
                agregarProductoAlCarritoCambioVenta(nombre, precio);
            });
        });
    }

    // Eliminar √≠tems del carrito de nueva venta (delegado sobre la tabla)
    if (tablaCarritoCambioVenta) {
        tablaCarritoCambioVenta.addEventListener('click', function(e) {
            const btnDel = e.target.closest('.btn-eliminar-item-cambio-venta');
            if (!btnDel) return;
            const fila = btnDel.closest('tr');
            if (!fila) return;
            fila.remove();

            const filasRestantes = tablaCarritoCambioVenta.querySelectorAll('tbody tr');
            let hayItems = false;
            filasRestantes.forEach(tr => {
                if (tr.id !== 'carrito-cambio-venta-empty-row') {
                    hayItems = true;
                }
            });
            if (!hayItems && carritoCambioVentaEmptyRow) {
                carritoCambioVentaEmptyRow.classList.remove('hidden');
            }

            actualizarTotalCambioVenta();
        });
    }

    function mostrarVistaMovimiento(vista) {
        // Las vistas dummy fueron removidas. Mantener helper por compatibilidad.
        if (!vista) return;
        vista.classList.add('hidden');
    }

    function initArqueoEmployees() {
        if (!selectArqueoEmployee) return;

        const apply = function (arr) {
            const list = Array.isArray(arr) ? arr.slice() : [];
            const active = list.filter(e => {
                try {
                    const id = String(e?.id || '').trim();
                    if (!id) return false;
                    if (e && typeof e === 'object' && e.active === false) return false;
                    return true;
                } catch (err) {
                    return false;
                }
            });
            active.sort((a, b) => _employeeDisplayName(a).localeCompare(_employeeDisplayName(b), 'es'));

            selectArqueoEmployee.innerHTML = '';
            const opt0 = document.createElement('option');
            opt0.value = '';
            opt0.textContent = '‚Äî Seleccionar ‚Äî';
            selectArqueoEmployee.appendChild(opt0);

            active.forEach(function (e) {
                const opt = document.createElement('option');
                opt.value = String(e?.id || '').trim();
                opt.textContent = _employeeDisplayName(e);
                selectArqueoEmployee.appendChild(opt);
            });

            const hasEmployees = active.length > 0;
            try { if (msgArqueoNoEmployees) msgArqueoNoEmployees.classList.toggle('hidden', hasEmployees); } catch (e) {}
        };

        try {
            if (Array.isArray(employeesCache) && employeesCache.length) {
                apply(employeesCache);
                return;
            }
        } catch (e) {
        }

        try {
            if (window.StorageService && typeof window.StorageService.getEmployees === 'function') {
                const res = window.StorageService.getEmployees();
                if (res && typeof res.then === 'function') {
                    res.then(apply).catch(function () { apply([]); });
                    return;
                }
                apply(res);
                return;
            }
        } catch (e) {
        }
        apply([]);
    }

    // Compatibilidad defensiva: si el navegador tiene JS viejo cacheado que llama esta funci√≥n.
    if (!window.showPagoTicket) {
        window.showPagoTicket = function () {
            // No-op: evita que se rompa el m√≥dulo.
            return;
        };
    }

    function handleGlobalEscape() {
        // cerrar modales si est√°n abiertos
        if (modalExportVentas && !modalExportVentas.classList.contains('hidden')) { closeExportVentas(); return; }
        if (modalCuentaCorriente && !modalCuentaCorriente.classList.contains('hidden')) { closeModalCompat(modalCuentaCorriente); return; }
        if (modalSelectCustomer && !modalSelectCustomer.classList.contains('hidden')) { closeModalCompat(modalSelectCustomer); return; }
        if (modalCreateCustomer && !modalCreateCustomer.classList.contains('hidden')) { closeModalCompat(modalCreateCustomer); return; }
        if (modalExitCambio && !modalExitCambio.classList.contains('hidden')) { closeModalCompat(modalExitCambio); return; }
        if (modalExitVenta && !modalExitVenta.classList.contains('hidden')) { closeModalCompat(modalExitVenta); return; }

        // salir de realizar cambio
        if (vistaRealizarCambio && !vistaRealizarCambio.classList.contains('hidden')) {
            if (modalExitCambio) {
                openModal(modalExitCambio);
                return;
            }
        }

        // volver del flujo al home
        if (flujo && !flujo.classList.contains('hidden')) {
            if (modalExitVenta) {
                openModal(modalExitVenta);
                return;
            }
            showHomeAll();
            setEditState('');
            scrollAElemento(historial || home);
        }
    }

    function resetVentaFlow() {
        clearCartVenta();
        if (inputDescuentoGeneral) inputDescuentoGeneral.value = '';
        if (inputClienteBusqueda) inputClienteBusqueda.value = '';
        if (ticketNotas) ticketNotas.value = '';
        if (ticketDiasCambio) ticketDiasCambio.value = '14';
        selectedCustomer = null;
        resetVentaPaymentState();
        ventaIsGift = false;
        ventaGiftCode = '';
        renderGiftUi();
        try { if (ccResumenPaso2) ccResumenPaso2.classList.add('hidden'); } catch (e) {}
        setEditState(null);

        if (pasoTicket) pasoTicket.classList.add('hidden');
        if (pasoProductos) pasoProductos.classList.remove('hidden');
        if (headerFlujo) headerFlujo.classList.remove('hidden');
        if (pillPaso1 && pillPaso2) {
            pillPaso1.classList.add('bg-indigo-600','text-white');
            pillPaso1.classList.remove('bg-indigo-50','text-indigo-700');
            pillPaso2.classList.add('bg-indigo-50','text-indigo-700');
            pillPaso2.classList.remove('bg-indigo-600','text-white');
        }
        try { placeVentaStepsPills(1); } catch (e) {}
        try { actualizarTotalEstimado(); } catch (e) {}
    }

    function escapeHtml(str) {
        return String(str ?? '').replace(/[&<>"']/g, function (ch) {
            if (ch === '&') return '&amp;';
            if (ch === '<') return '&lt;';
            if (ch === '>') return '&gt;';
            if (ch === '"') return '&quot;';
            if (ch === "'") return '&#39;';
            return ch;
        });
    }

    function formatFechaDMY(value) {
        const s = String(value ?? '').trim();
        const m = s.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})$/);
        if (m) return m[3] + '/' + m[2] + '/' + m[1];
        const m2 = s.match(/^([0-9]{4})\/([0-9]{2})\/([0-9]{2})$/);
        if (m2) return m2[3] + '/' + m2[2] + '/' + m2[1];
        return s;
    }

    function buildTicketPrintHtml(data) {
        const businessName = escapeHtml(String(data?.businessName || '').trim() || '');
        const ticket = escapeHtml(String(data?.ticket || '').trim() || '');
        const fecha = escapeHtml(formatFechaDMY(String(data?.fecha || '').trim() || ''));
        const pago = escapeHtml(String(data?.payment_method || '').trim() || '');
        const customer = escapeHtml(String(data?.customer_name || '').trim() || '');
        const notes = escapeHtml(String(data?.notes || '').trim() || '');
        const diasCambio = (parseInt(String(data?.dias_cambio ?? ''), 10) || 0);
        const isGift = !!(data?.is_gift);
        const giftCode = escapeHtml(String(data?.gift_code || '').trim() || '');
        const items = Array.isArray(data?.items) ? data.items : [];

        const rows = items.map(function (it) {
            const name = escapeHtml(String(it?.nombre || it?.product_name || 'Producto'));
            const qty = (parseFloat(it?.cantidad ?? it?.qty ?? 0) || 0);
            const price = (parseFloat(it?.precio ?? it?.unit_price ?? 0) || 0);
            const subtotal = (parseFloat(it?.subtotal ?? 0) || 0);

            if (isGift) {
                return (
                    '<tr>'
                    + '<td class="name">' + name + '</td>'
                    + '<td class="qty">' + escapeHtml(formatearNumero(qty)) + '</td>'
                    + '</tr>'
                );
            }

            return (
                '<tr>'
                + '<td class="name">' + name + '</td>'
                + '<td class="qty">' + escapeHtml(formatearNumero(qty)) + '</td>'
                + '<td class="price">' + escapeHtml(formatearMoneda(price)) + '</td>'
                + '<td class="sub">' + escapeHtml(formatearMoneda(subtotal)) + '</td>'
                + '</tr>'
            );
        }).join('');

        const total = (parseFloat(data?.total ?? 0) || 0);

        return (
            '<!doctype html><html><head><meta charset="utf-8">'
            + '<title>Ticket</title>'
            + '<style>'
            + 'html,body{margin:0;padding:0;font-family:Arial, sans-serif;}'
            + '@page{size:58mm auto;margin:3mm;}'
            + 'body{width:58mm;}'
            + '.h{text-align:center;font-weight:700;font-size:16px;margin:0 0 6px 0;}'
            + '.meta{font-size:11px;line-height:1.2;margin-bottom:6px;}'
            + '.sep{border-top:1px dashed #000;margin:6px 0;}'
            + 'table{width:100%;border-collapse:collapse;font-size:11px;}'
            + 'td{padding:2px 0;vertical-align:top;}'
            + 'td.name{width:48%;padding-right:4px;}'
            + 'td.qty{width:10%;text-align:right;white-space:nowrap;padding-right:4px;}'
            + 'td.price{width:21%;text-align:right;white-space:nowrap;padding-right:6px;}'
            + 'td.sub{width:21%;text-align:right;white-space:nowrap;}'
            + 'tr.th td{padding:0 0 3px 0;font-size:10px;font-weight:700;}'
            + 'tr.th td{border-bottom:1px dotted #000;}'
            + '.tot{font-size:12px;font-weight:700;text-align:right;margin-top:6px;}'
            + '.f{text-align:center;font-size:11px;margin-top:10px;}'
            + '</style></head><body>'
            + (businessName ? ('<div class="h">' + businessName + '</div>') : '')
            + '<div class="meta">'
            + (ticket ? ('<div><b>Ticket:</b> ' + ticket + '</div>') : '')
            + (fecha ? ('<div><b>Fecha:</b> ' + fecha + '</div>') : '')
            + (pago ? ('<div><b>Pago:</b> ' + pago + '</div>') : '')
            + (customer ? ('<div><b>Cliente:</b> ' + customer + '</div>') : '')
            + (notes ? ('<div><b>Notas:</b> ' + notes + '</div>') : '')
            + (isGift ? ('<div><b>C√≥digo de regalo:</b> ' + (giftCode || '‚Äî') + '</div>') : '')
            + '</div>'
            + '<div class="sep"></div>'
            + '<table><tbody>'
            + (isGift ? '' : ('<tr class="th"><td class="name"></td><td class="qty">Cant.</td><td class="price">PU</td><td class="sub">Sub</td></tr>'))
            + rows
            + '</tbody></table>'
            + '<div class="sep"></div>'
            + (isGift ? '' : ('<div class="tot">TOTAL: ' + escapeHtml(formatearMoneda(total)) + '</div>'))
            + (diasCambio ? ('<div class="f">Cont√°s con ' + escapeHtml(String(diasCambio)) + ' d√≠as desde la fecha para realizar un cambio</div>') : '')
            + '<div class="f">¬°Muchas gracias por tu compra!</div>'
            + '</body></html>'
        );
    }

    function printCurrentTicket() {
        const items = getCartItems();
        if (!items.length) {
            showAlertModal('Agreg√° al menos un producto al carrito.', 'Atenci√≥n', 'Validaci√≥n requerida');
            return;
        }

        const fecha = String(ticketFecha?.value || '').trim() || defaultFecha;
        const notas = String(ticketNotas?.value || '').trim();
        const diasCambio = (parseInt(String(ticketDiasCambio?.value || ''), 10) || 0);
        const pago = getSelectedPaymentMethod();
        const totals = computeTicketTotals();
        const total = totals.total;

        let businessName = '';
        try {
            const el = document.getElementById('business-name');
            businessName = String(el?.textContent || '').trim();
        } catch (e) {
            businessName = '';
        }
        if (!businessName) {
            try {
                const btn = document.getElementById('btn-imprimir-ticket');
                businessName = String(btn?.getAttribute('data-business-name') || '').trim();
            } catch (e) {
                businessName = '';
            }
        }

        const data = {
            businessName,
            ticket: editTicketId ? String(editTicketId) : '',
            fecha,
            payment_method: pago,
            customer_name: selectedCustomer ? (selectedCustomer.name || '') : '',
            notes: notas,
            total,
            dias_cambio: diasCambio,
            items,
            is_gift: !!ventaIsGift,
            gift_code: String(ventaGiftCode || '').trim(),
        };

        const html = buildTicketPrintHtml(data);
        const w = window.open('', '_blank', 'width=420,height=720');
        if (!w) {
            showAlertModal('El navegador bloque√≥ la ventana de impresi√≥n. Habilit√° popups para poder imprimir.', 'Atenci√≥n', 'Impresi√≥n');
            return;
        }
        try {
            w.onafterprint = function () { try { w.close(); } catch (e) {} };
        } catch (e) {}
        w.document.open();
        w.document.write(html);
        w.document.close();
        try {
            w.onload = function () {
                try { w.focus(); } catch (e) {}
                try { w.print(); } catch (e) {}
            };
        } catch (e) {}
    }

    function adjustSelectedCartQty(delta) {
        const tbody = tablaCarrito ? tablaCarrito.querySelector('tbody') : null;
        if (!tbody) return;
        const selected = tbody.querySelector('tr[data-selected="1"]');
        if (!selected) return;
        const qtyInput = selected.querySelector('input.item-cantidad');
        if (!qtyInput) return;
        const cur = parseFloat(qtyInput.value || '0') || 0;
        const next = Math.max(0, cur + delta);
        qtyInput.value = String(next);
        qtyInput.dispatchEvent(new Event('input', { bubbles: true }));
    }
 
    // Acciones sobre movimientos (men√∫ de tres puntitos)
    function cerrarTodosLosMenusMov() {
        const menus = document.querySelectorAll('.menu-mov-acciones');
        if (!menus || !menus.length) return;
        menus.forEach(menu => menu.classList.add('hidden'));
    }

    let deleteTicketPromiseResolve = null;
    const modalDeleteTicket = document.getElementById('modal-delete-ticket');
    const deleteTicketLabel = document.getElementById('delete-ticket-label');
    const btnCancelDeleteTicket = document.getElementById('btn-cancel-delete-ticket');
    const btnConfirmDeleteTicket = document.getElementById('btn-confirm-delete-ticket');
    const btnCloseDeleteTicket = document.getElementById('btn-close-delete-ticket');

    function closeDeleteTicketModal(result) {
        if (!modalDeleteTicket) return;
        modalDeleteTicket.classList.add('hidden');
        if (deleteTicketPromiseResolve) {
            const fn = deleteTicketPromiseResolve;
            deleteTicketPromiseResolve = null;
            fn(!!result);
        }
    }

    function confirmDeleteTicket(ticket) {
        const t = String(ticket || '').trim();
        if (!t) return Promise.resolve(false);
        if (!modalDeleteTicket || !deleteTicketLabel) {
            if (window.confirmModal && typeof window.confirmModal === 'function') {
                return window.confirmModal('¬øSeguro que quer√©s eliminar el ticket ' + t + '?', 'Eliminar ticket', 'Esta acci√≥n es irreversible. Se eliminar√°n la venta y sus registros asociados y se revertir√° el stock.', { okText: 'Eliminar', cancelText: 'Cancelar' });
            }
            return Promise.resolve(window.confirm('¬øSeguro que quer√©s eliminar el ticket ' + t + '?'));
        }
        deleteTicketLabel.textContent = t;
        modalDeleteTicket.classList.remove('hidden');
        return new Promise(function (resolve) {
            deleteTicketPromiseResolve = resolve;
        });
    }

    if (btnCancelDeleteTicket) btnCancelDeleteTicket.addEventListener('click', function () { closeDeleteTicketModal(false); });
    if (btnCloseDeleteTicket) btnCloseDeleteTicket.addEventListener('click', function () { closeDeleteTicketModal(false); });
    if (btnConfirmDeleteTicket) btnConfirmDeleteTicket.addEventListener('click', function () { closeDeleteTicketModal(true); });
    if (modalDeleteTicket) {
        modalDeleteTicket.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target.getAttribute && target.getAttribute('data-close') === '1') closeDeleteTicketModal(false);
        });
    }
    document.addEventListener('keydown', function (e) {
        if (!modalDeleteTicket || modalDeleteTicket.classList.contains('hidden')) return;
        if (e.key === 'Escape') closeDeleteTicketModal(false);
    });

    function deleteTicketById(ticket) {
        const t = String(ticket || '').trim();
        if (!t) return;
        confirmDeleteTicket(t).then(function (confirmar) {
            if (!confirmar) return;

            apiDeleteSale(t).then(function (res) {
                if (!res || res.ok !== true) {
                    const msg = (res && (res.message || res.error)) ? String(res.message || res.error) : 'No se pudo eliminar el ticket.';
                    showAlertModal(msg, 'Error', 'Operaci√≥n fallida');
                    return;
                }
                salesCache = (Array.isArray(salesCache) ? salesCache : []).filter(s => String(s?.ticket || '').trim() !== t);
                renderHistorialFromCache();
                applyVentasFilters();
                initKpisFromSales();
                recalcularArqueoAutomatico();
                scrollAElemento(historial || home);
            }).catch(function () {
                showAlertModal('No se pudo eliminar el ticket.', 'Error', 'Operaci√≥n fallida');
            });
        });
    }

    // Cerrar men√∫s al hacer clic fuera
    document.addEventListener('click', function () {
        cerrarTodosLosMenusMov();
    });

    // Toggle del men√∫ (delegado para soportar filas renderizadas din√°micamente)
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('.btn-mov-menu');
        if (!btn) return;
        e.stopPropagation();
        const contenedor = btn.closest('.relative');
        if (!contenedor) return;
        const menu = contenedor.querySelector('.menu-mov-acciones');
        if (!menu) return;
        const estabaAbierto = !menu.classList.contains('hidden');
        cerrarTodosLosMenusMov();
        if (!estabaAbierto) menu.classList.remove('hidden');
    });

    // Manejar opciones del men√∫ (editar + eliminar)
    document.addEventListener('click', function (e) {
        const btnVer = e.target.closest('.opcion-ver-ticket');
        const btnEliminar = e.target.closest('.opcion-eliminar-ticket');
        if (!btnVer && !btnEliminar) return;
        e.stopPropagation();
        const ticket = (btnVer || btnEliminar).getAttribute('data-ticket') || '';

        if (btnVer) {
            cerrarTodosLosMenusMov();
            openEditTicket(ticket);
            return;
        }

        if (btnEliminar) {
            cerrarTodosLosMenusMov();
            deleteTicketById(ticket);
        }
    });

    // Preparar input de rango de fechas (calendario de rango con flatpickr)
    if (inputFechaRango && window.flatpickr) {
        inputFechaRango.setAttribute('readonly', 'readonly');
        ventasRangePicker = flatpickr(inputFechaRango, {
            mode: 'range',
            dateFormat: 'd/m/Y',
            locale: window.flatpickr && window.flatpickr.l10ns ? window.flatpickr.l10ns.es : 'es',
            allowInput: false,
            onChange: function () {
                applyVentasFilters();
            },
            onClose: function () {
                refreshVentasFromServerForRange();
            }
        });
    }

    function openExportVentas() {
        if (!modalExportVentas) return;
        modalExportVentas.classList.remove('hidden');
    }

    function closeExportVentas() {
        if (!modalExportVentas) return;
        modalExportVentas.classList.add('hidden');
    }

    function escapeCsvCell(v) {
        const s = String(v ?? '');
        if (/[\n\r",;]/.test(s)) {
            return '"' + s.replace(/"/g, '""') + '"';
        }
        return s;
    }

    function getVentasVisibleRows() {
        const tabla = document.querySelector('#historial-ventas table');
        if (!tabla) return [];
        const trs = Array.from(tabla.querySelectorAll('tbody tr'));
        return trs
            .filter(tr => !tr.classList.contains('hidden'))
            .map(tr => {
                const tds = Array.from(tr.querySelectorAll('td')).map(td => (td.textContent || '').trim());
                const ticketNorm = String(tr.getAttribute('data-ticket') || '').trim();
                const gift = String(tr.getAttribute('data-gift-code') || '').trim();
                const ticketExport = ventasGiftOnly ? (gift || ticketNorm || (tds[0] || '')) : (ticketNorm || (tds[0] || ''));
                const tipo = String(tr.getAttribute('data-type') || '').trim();
                return {
                    ticket: ticketExport,
                    fecha: tds[1] || '',
                    cliente: tds[2] || '',
                    empleado: tds[3] || '',
                    total: tds[4] || '',
                    pago: tds[5] || '',
                    estado: tipo || (tds[6] || '')
                };
            });
    }

    function exportVentasCsv() {
        const rows = getVentasVisibleRows();
        const header = ['Ticket','Fecha','Cliente','Empleado responsable','Total','Pago','Tipo'];
        const lines = [header.map(escapeCsvCell).join(';')];
        rows.forEach(r => {
            lines.push([
                r.ticket,
                r.fecha,
                r.cliente,
                r.empleado,
                r.total,
                r.pago,
                r.estado
            ].map(escapeCsvCell).join(';'));
        });
        const blob = new Blob(["\ufeff" + lines.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'ventas_historial.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.setTimeout(function () { URL.revokeObjectURL(a.href); }, 500);
    }

    function exportVentasPdfPrint() {
        const rows = getVentasVisibleRows();
        const w = window.open('', '_blank');
        if (!w) return;
        const period = (inputFechaRango?.value || '').trim();
        const htmlRows = rows.map(r => {
            return ''
                + '<tr>'
                + '<td>' + r.ticket + '</td>'
                + '<td>' + r.fecha + '</td>'
                + '<td>' + r.cliente + '</td>'
                + '<td>' + r.empleado + '</td>'
                + '<td class="num">' + r.total + '</td>'
                + '<td>' + r.pago + '</td>'
                + '<td>' + r.estado + '</td>'
                + '</tr>';
        }).join('');

        const html = `
<!doctype html>
<html lang="es"><head><meta charset="utf-8" />
<title>Exportar ventas</title>
<style>
body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#111}
h1{font-size:18px;margin:0 0 6px 0}
p{margin:0 0 14px 0;color:#555;font-size:12px}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;vertical-align:top}
th{background:#f9fafb}
td.num,th.num{text-align:right}
.meta{display:flex;justify-content:space-between;gap:12px;align-items:flex-end;margin-bottom:12px}
.pill{font-size:12px;color:#111}
</style>
</head><body>
<div class="meta">
  <div>
    <h1>Historial de ventas</h1>
    <p>Per√≠odo: ${period || 'todo'}</p>
  </div>
  <div class="pill">Filtros: <strong>${(inputSearchVentasCliente?.value || '').trim() || '‚Äî'}</strong> / <strong>${(inputSearchVentasTicket?.value || '').trim() || '‚Äî'}</strong></div>
</div>
<table>
  <thead><tr>
    <th>Ticket</th><th>Fecha</th><th>Cliente</th><th>Empleado responsable</th><th class="num">Total</th><th>Pago</th><th>Tipo</th>
  </tr></thead>
  <tbody>
    ` + htmlRows + `
  </tbody>
</table>
<script>window.onload=function(){window.print();}<\/script>
</body></html>`;
                w.document.open();
                w.document.write(html);
                w.document.close();
    }

    if (btnExportVentas) btnExportVentas.addEventListener('click', function () { openExportVentas(); });
    if (btnCloseExportVentas) btnCloseExportVentas.addEventListener('click', function () { closeExportVentas(); });
    if (btnCancelExportVentas) btnCancelExportVentas.addEventListener('click', function () { closeExportVentas(); });
    if (modalExportVentas) {
        modalExportVentas.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalExportVentas.firstElementChild) closeExportVentas();
        });
    }
    if (btnExportVentasXls) btnExportVentasXls.addEventListener('click', function () { exportVentasCsv(); closeExportVentas(); });
    if (btnExportVentasPdf) btnExportVentasPdf.addEventListener('click', function () { exportVentasPdfPrint(); closeExportVentas(); });

    if (btnClearVentas) {
        btnClearVentas.addEventListener('click', function () {
            ventasGiftOnly = !ventasGiftOnly;
            updateVentasGiftModeUi();
            renderHistorialFromCache();
            applyVentasFilters();
        });
    }

    function persistLastEmployeeIdFromSelect(select) {
        try {
            const id = String(select?.value || '').trim();
            if (!id) return;
            window.localStorage.setItem('sales_last_employee_id', id);
        } catch (e) {
        }
    }

    if (selectTicketEmployee) {
        selectTicketEmployee.addEventListener('change', function () {
            persistLastEmployeeIdFromSelect(selectTicketEmployee);
        });
    }
    if (selectCambioEmployee) {
        selectCambioEmployee.addEventListener('change', function () {
            persistLastEmployeeIdFromSelect(selectCambioEmployee);
        });
    }

    if (modalExitCambio) {
        modalExitCambio.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalExitCambio.firstElementChild) closeModal(modalExitCambio);
        });
    }
    if (btnCloseExitCambio) btnCloseExitCambio.addEventListener('click', function () { if (modalExitCambio) closeModal(modalExitCambio); });
    if (btnCancelExitCambio) btnCancelExitCambio.addEventListener('click', function () { if (modalExitCambio) closeModal(modalExitCambio); });
    if (btnConfirmExitCambio) {
        btnConfirmExitCambio.addEventListener('click', function () {
            if (modalExitCambio) closeModal(modalExitCambio);
            editCambioTicketId = null;
            editCambioVentaTicketId = null;
            editCambioVentaReturnTotal = 0;
            editCambioVentaReturnTicketId = '';
            setCambioReturnOnlyMode(false);
            setCambioVentaOnlyMode(false);
            showHomeAll();
            setEditState('');
            scrollAElemento(historial || home);
        });
    }

    if (modalExitVenta) {
        modalExitVenta.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalExitVenta.firstElementChild) closeModal(modalExitVenta);
        });
    }
    if (btnCloseExitVenta) btnCloseExitVenta.addEventListener('click', function () { if (modalExitVenta) closeModal(modalExitVenta); });
    if (btnCancelExitVenta) btnCancelExitVenta.addEventListener('click', function () { if (modalExitVenta) closeModal(modalExitVenta); });
    if (btnConfirmExitVenta) {
        btnConfirmExitVenta.addEventListener('click', function () {
            if (modalExitVenta) closeModal(modalExitVenta);
            resetVentaFlow();
            showHomeAll();
            scrollAElemento(historial || home);
        });
    }

    if (tablaCarrito) {
        tablaCarrito.addEventListener('click', function (e) {
            const tr = e.target.closest('tbody tr');
            if (!tr || tr.id === 'carrito-empty-row') return;
            const tbody = tablaCarrito.querySelector('tbody');
            if (!tbody) return;
            Array.from(tbody.querySelectorAll('tr')).forEach(r => r.removeAttribute('data-selected'));
            tr.setAttribute('data-selected', '1');
        });
    }

    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
            handleGlobalEscape();
            return;
        }
        if (e.ctrlKey && (e.key === '+' || e.key === '=')) {
            e.preventDefault();
            adjustSelectedCartQty(1);
            return;
        }
        if (e.ctrlKey && e.key === '-') {
            e.preventDefault();
            adjustSelectedCartQty(-1);
            return;
        }
    });

    if (btnVolverDesdeCambio) {
        btnVolverDesdeCambio.addEventListener('click', function() {
            // Si estamos en Paso 2 del flujo de cambio, volver a Paso 1 sin salir al home
            if (cambioPaso2 && !cambioPaso2.classList.contains('hidden') && cambioPaso1) {
                cambioPaso2.classList.add('hidden');
                cambioPaso1.classList.remove('hidden');
                if (pillCambioPaso1 && pillCambioPaso2) {
                    pillCambioPaso1.classList.add('bg-indigo-600','text-white');
                    pillCambioPaso1.classList.remove('bg-indigo-50','text-indigo-700');
                    pillCambioPaso2.classList.remove('bg-indigo-600','text-white');
                    pillCambioPaso2.classList.add('bg-indigo-50','text-indigo-700');
                }
                if (pillCambioPaso3) {
                    pillCambioPaso3.classList.add('bg-indigo-50','text-indigo-700');
                    pillCambioPaso3.classList.remove('bg-indigo-600','text-white');
                    pillCambioPaso3.classList.remove('bg-gray-100','text-gray-600');
                }
                scrollAElemento(vistaRealizarCambio);
                return;
            }

            if (modalExitCambio) {
                openModal(modalExitCambio);
                return;
            }

            showHomeAll();
            setEditState('');
            scrollAElemento(historial || home);
        });
    }

    // Navegaci√≥n interna de pasos en flujo de cambio (pills superiores)
    if (pillCambioPaso1 && pillCambioPaso2 && cambioPaso1 && cambioPaso2) {
        pillCambioPaso1.style.cursor = 'pointer';
        pillCambioPaso2.style.cursor = 'pointer';
        if (pillCambioPaso3) pillCambioPaso3.style.cursor = 'pointer';

        pillCambioPaso1.addEventListener('click', function() {
            if (cambioPaso2) cambioPaso2.classList.add('hidden');
            if (cambioPaso3) cambioPaso3.classList.add('hidden');
            cambioPaso1.classList.remove('hidden');
            pillCambioPaso1.classList.add('bg-indigo-600','text-white');
            pillCambioPaso1.classList.remove('bg-indigo-50','text-indigo-700');
            pillCambioPaso2.classList.add('bg-indigo-50','text-indigo-700');
            pillCambioPaso2.classList.remove('bg-indigo-600','text-white');
            if (pillCambioPaso3) {
                pillCambioPaso3.classList.add('bg-indigo-50','text-indigo-700');
                pillCambioPaso3.classList.remove('bg-indigo-600','text-white');
                pillCambioPaso3.classList.remove('bg-gray-100','text-gray-600');
            }
        });

        pillCambioPaso2.addEventListener('click', function() {
            cambioPaso1.classList.add('hidden');
            if (cambioPaso3) cambioPaso3.classList.add('hidden');
            cambioPaso2.classList.remove('hidden');
            pillCambioPaso1.classList.remove('bg-indigo-600','text-white');
            pillCambioPaso1.classList.add('bg-indigo-50','text-indigo-700');
            pillCambioPaso2.classList.remove('bg-indigo-50','text-indigo-700');
            pillCambioPaso2.classList.add('bg-indigo-600','text-white');
            if (pillCambioPaso3) {
                pillCambioPaso3.classList.add('bg-indigo-50','text-indigo-700');
                pillCambioPaso3.classList.remove('bg-indigo-600','text-white');
                pillCambioPaso3.classList.remove('bg-gray-100','text-gray-600');
            }
        });

        if (pillCambioPaso3 && cambioPaso3) {
            pillCambioPaso3.addEventListener('click', function() {
                cambioPaso1.classList.add('hidden');
                if (cambioPaso2) cambioPaso2.classList.add('hidden');
                cambioPaso3.classList.remove('hidden');
                pillCambioPaso1.classList.remove('bg-indigo-600','text-white');
                pillCambioPaso1.classList.add('bg-indigo-50','text-indigo-700');
                pillCambioPaso2.classList.remove('bg-indigo-600','text-white');
                pillCambioPaso2.classList.add('bg-indigo-50','text-indigo-700');
                pillCambioPaso3.classList.remove('bg-gray-100','text-gray-600');
                pillCambioPaso3.classList.remove('bg-indigo-50','text-indigo-700');
                pillCambioPaso3.classList.add('bg-indigo-600','text-white');
            });
        }
    }

    // Confirmar venta (inventario FIFO en backend)
    if (btnConfirmarVenta && home && flujo && pasoProductos && pasoTicket) {
        btnConfirmarVenta.addEventListener('click', function() {
            const items = getCartItems();
            if (!items.length) {
                showAlertModal('Agreg√° al menos un producto al carrito.', 'Atenci√≥n', 'Validaci√≥n requerida');
                return;
            }

            if (ventaIsGift) {
                if (!selectedCustomer || !selectedCustomer.name) {
                    showAlertModal('En el caso de ser un regalo, deb√©s registrar un cliente.', 'Atenci√≥n', 'Validaci√≥n requerida');
                    return;
                }
            }

            if (ventaOnAccount) {
                if (!selectedCustomer || !selectedCustomer.name) {
                    showAlertModal('Para usar cuenta corriente ten√©s que asociar un cliente.', 'Atenci√≥n', 'Validaci√≥n requerida');
                    return;
                }
            }

            if (ventaUseInstallments) {
                if (!INSTALLMENTS_ENABLED) {
                    showAlertModal('El sistema de cuotas est√° deshabilitado en la configuraci√≥n del negocio.', 'Atenci√≥n', 'Validaci√≥n requerida');
                    return;
                }
                if (!selectedCustomer || !selectedCustomer.name) {
                    showAlertModal('Para usar cuotas ten√©s que asociar un cliente.', 'Atenci√≥n', 'Validaci√≥n requerida');
                    return;
                }
            }

            const fecha = String(ticketFecha?.value || '').trim() || defaultFecha;
            const notas = String(ticketNotas?.value || '').trim();
            const pago = getSelectedPaymentMethod();
            const totals = computeTicketTotals();
            const total = totals.total;
            const ventaLibre = !!(toggleVentaLibreTicket?.checked || toggleVentaLibre?.checked);

            const paidAmount = ventaOnAccount ? Math.max(0, Math.min(total, (parseFloat(ventaPaidAmount || 0) || 0))) : total;
            const dueAmount = ventaOnAccount ? Math.max(0, total - paidAmount) : 0;

            const payload = {
                fecha,
                type: 'Venta',
                status: 'Completada',
                payment_method: pago,
                notes: notas,
                total,
                discount_general_pct: totals.pct,
                discount_general_amount: totals.descGeneral,
                items,
                customer_id: selectedCustomer ? (selectedCustomer.id || '') : '',
                customer_name: selectedCustomer ? (selectedCustomer.name || '') : '',
                ...getSelectedEmployeePayload(selectTicketEmployee),
                on_account: ventaOnAccount,
                paid_amount: paidAmount,
                due_amount: dueAmount,
                is_gift: !!ventaIsGift,
                gift_code: (ventaIsGift ? (ventaGiftCode || '') : ''),
            };

            if (ventaUseInstallments) {
                const mode = getCuotasMode();
                const intervalRaw = parseInt(cuotasInterval?.value || '', 10);
                if (!isFinite(intervalRaw) || intervalRaw <= 0) {
                    showAlertModal('Ingres√° un intervalo (d√≠as) v√°lido para las cuotas.', 'Atenci√≥n', 'Validaci√≥n requerida');
                    return;
                }
                const interval = Math.max(1, Math.min(365, intervalRaw));
                if (mode === 'indefinite') {
                    payload.installments = {
                        enabled: true,
                        mode: 'indefinite',
                        interval_days: interval,
                    };
                } else {
                    const count = Math.max(1, Math.min(24, parseInt(cuotasCount?.value || 1, 10) || 1));
                    payload.installments = {
                        enabled: true,
                        mode: 'fixed',
                        installments_count: count,
                        interval_days: interval,
                    };
                }
            }

            const req = editTicketId ? apiUpdateSale(editTicketId, payload) : apiCreateSale(payload);
            Promise.resolve(req).then(function (res) {
                if (!res || res.ok !== true) {
                    const msg = (res && (res.message || res.error)) ? String(res.message || res.error) : 'No se pudo registrar la venta.';
                    showAlertModal(msg, 'Error', 'Operaci√≥n fallida');
                    return;
                }
                const saved = res.item;
                if (!saved) return;

                try {

                // refrescar cache local
                const t = String(saved.ticket || '').trim();
                const idx = (Array.isArray(salesCache) ? salesCache : []).findIndex(s => String(s?.ticket || '').trim() === t);
                if (idx >= 0) salesCache[idx] = saved;
                else salesCache.unshift(saved);
                salesLoaded = true;

                renderHistorialFromCache();
                applyVentasFilters();
                initKpisFromSales();
                recalcularArqueoAutomatico();
                emitCashflowChanged({ kind: 'sale', date: fecha, payment_method: pago, created_at: saved.created_at || Date.now() });

                clearCartVenta();
                if (inputDescuentoGeneral) inputDescuentoGeneral.value = '';
                if (inputClienteBusqueda) inputClienteBusqueda.value = '';
                if (ticketNotas) ticketNotas.value = '';
                selectedCustomer = null;
                resetVentaPaymentState();
                ventaIsGift = false;
                ventaGiftCode = '';
                renderGiftUi();
                setEditState(null);
                actualizarTotalEstimado();

                showHomeAll();
                if (pillPaso1 && pillPaso2) {
                    pillPaso1.classList.add('bg-indigo-600','text-white');
                    pillPaso1.classList.remove('bg-indigo-50','text-indigo-700');
                    pillPaso2.classList.add('bg-indigo-50','text-indigo-700');
                    pillPaso2.classList.remove('bg-indigo-600','text-white');
                }
                scrollAElemento(historial || home);
                } catch (e) {
                    try { console.error(e); } catch (err) {}
                }
            }).catch(function () {
                showAlertModal('No se pudo registrar la venta.', 'Error', 'Operaci√≥n fallida');
            });
        });
    }

    // Si hay inventario real, reemplazar grilla dummy por productos reales
    try {
        const saved = window.localStorage.getItem('venta_view_mode');
        if (saved === 'list' || saved === 'grid') ventaViewMode = saved;
    } catch (e) {
    }
    try {
        const savedC = window.localStorage.getItem('cambio_view_mode');
        if (savedC === 'list' || savedC === 'grid') cambioViewMode = savedC;
        const savedCV = window.localStorage.getItem('cambio_venta_view_mode');
        if (savedCV === 'list' || savedCV === 'grid') cambioVentaViewMode = savedCV;
    } catch (e) {
    }
    updateVentaViewButtons();
    if (btnViewGrid) btnViewGrid.addEventListener('click', function () { setVentaViewMode('grid', true); });
    if (btnViewList) btnViewList.addEventListener('click', function () { setVentaViewMode('list', true); });
    updateCambioViewButtons();
    updateCambioVentaViewButtons();
    if (btnViewGridCambio) btnViewGridCambio.addEventListener('click', function () { setCambioViewMode('grid', true); });
    if (btnViewListCambio) btnViewListCambio.addEventListener('click', function () { setCambioViewMode('list', true); });
    if (btnViewGridCambioVenta) btnViewGridCambioVenta.addEventListener('click', function () { setCambioVentaViewMode('grid', true); });
    if (btnViewListCambioVenta) btnViewListCambioVenta.addEventListener('click', function () { setCambioVentaViewMode('list', true); });
    renderProductosDesdeInventario();
    renderProductosCambioDesdeInventario();
    renderProductosCambioVentaDesdeInventario();

    if (scannerInput) {
        try {
            scannerInput.addEventListener('keydown', function (e) {
                const now = Date.now();
                const dt = now - (scannerLastTs || 0);
                scannerLastTs = now;

                // Si pas√≥ mucho tiempo entre teclas, consideramos que empieza un nuevo scan.
                if (dt > 250) scannerBuffer = '';

                if (e.key === 'Enter') {
                    e.preventDefault();
                    const code = String(scannerBuffer || scannerInput.value || '').trim();
                    scannerBuffer = '';
                    scannerInput.value = '';
                    if (code) tryAddScannedProduct(code);
                    window.setTimeout(focusScannerInput, 0);
                    return;
                }

                if (e.key === 'Shift' || e.key === 'Alt' || e.key === 'Control' || e.key === 'Meta') return;
                if (e.key === 'Backspace') {
                    scannerBuffer = scannerBuffer.slice(0, -1);
                    return;
                }
                if (e.key && e.key.length === 1) {
                    scannerBuffer += e.key;
                    return;
                }
            });

            // Mantener foco cuando el usuario hace click en el √°rea de productos/carrito.
            document.addEventListener('click', function () {
                window.setTimeout(focusScannerInput, 0);
            });

            window.setInterval(function () {
                focusScannerInput();
            }, 800);

            window.setTimeout(focusScannerInput, 300);
        } catch (e) {
        }
    }

    // Init customers + autocomplete
    initCustomers();
    if (inputClienteBusqueda) {
        inputClienteBusqueda.addEventListener('input', function () {
            selectedCustomer = null;
            updateClientePagoVisibility();
            actualizarClienteDd();
        });
        inputClienteBusqueda.addEventListener('keydown', function (e) {
            if (e.key !== 'Enter') return;
            if (!ddCliente || ddCliente.classList.contains('hidden')) return;
            const firstBtn = ddCliente.querySelector('button');
            if (!firstBtn) return;
            e.preventDefault();
            firstBtn.click();
        });
        inputClienteBusqueda.addEventListener('focus', function () {
            actualizarClienteDd();
        });
        inputClienteBusqueda.addEventListener('blur', function () {
            window.setTimeout(function () { hideClienteDd(); }, 120);
        });
        document.addEventListener('click', function (ev) {
            const wrap = inputClienteBusqueda.parentElement;
            if (wrap && !wrap.contains(ev.target)) hideClienteDd();
        });
    }

    if (inputIsGift) {
        inputIsGift.addEventListener('change', function () {
            setGiftMode(!!inputIsGift.checked);
        });
    }

    if (inputIsGiftCambio) {
        inputIsGiftCambio.addEventListener('change', function () {
            setGiftModeCambio(!!inputIsGiftCambio.checked);
        });
    }

    if (inputSearchCambioProducts) {
        inputSearchCambioProducts.addEventListener('input', function () {
            cambioSearchQuery = String(inputSearchCambioProducts.value || '');
            applyCambioProductsFilter();
        });
    }

    if (inputSearchCambioVentaProducts) {
        inputSearchCambioVentaProducts.addEventListener('input', function () {
            cambioVentaSearchQuery = String(inputSearchCambioVentaProducts.value || '');
            applyCambioVentaProductsFilter();
        });
    }

    if (inputClienteCambio) {
        inputClienteCambio.addEventListener('input', function () {
            setCambioCustomerContext();
            selectedCustomer = null;
            updateClientePagoCambioVisibility();
            actualizarClienteCambioDd();
        });
        inputClienteCambio.addEventListener('keydown', function (e) {
            if (e.key !== 'Enter') return;
            if (!ddClienteCambio || ddClienteCambio.classList.contains('hidden')) return;
            const firstBtn = ddClienteCambio.querySelector('button');
            if (!firstBtn) return;
            e.preventDefault();
            firstBtn.click();
        });
        inputClienteCambio.addEventListener('focus', function () {
            setCambioCustomerContext();
            actualizarClienteCambioDd();
        });
        inputClienteCambio.addEventListener('blur', function () {
            window.setTimeout(function () { hideClienteCambioDd(); }, 120);
        });
        document.addEventListener('click', function (ev) {
            const wrap = inputClienteCambio.parentElement;
            if (wrap && !wrap.contains(ev.target)) hideClienteCambioDd();
        });
    }

    if (btnPagoCompletoCambio) btnPagoCompletoCambio.addEventListener('click', function () { setPagoCompletoCambio(); });
    if (btnCuentaCorrienteCambio) btnCuentaCorrienteCambio.addEventListener('click', function () { openCuentaCorrienteCambioModal(); });

    syncInstallmentsButtonVisibility();

    if (btnPagoCompleto) btnPagoCompleto.addEventListener('click', function () { setPagoCompleto(); });
    if (btnCuentaCorriente) btnCuentaCorriente.addEventListener('click', function () { openCuentaCorrientePanel(); });
    if (btnSistemaCuotas) btnSistemaCuotas.addEventListener('click', function () { setSistemaCuotas(); });
    if (btnCloseSistemaCuotas && panelSistemaCuotas) btnCloseSistemaCuotas.addEventListener('click', function () {
        panelSistemaCuotas.classList.add('hidden');
        ventaUseInstallments = false;
        updatePaymentButtonsVisual();
        try { computeTicketTotals(); } catch (e) {}
    });
    if (cuotasCount) cuotasCount.addEventListener('input', function () { syncCuotasPreview(); });
    if (cuotasInterval) cuotasInterval.addEventListener('input', function () { syncCuotasPreview(); });

    if (cuotasModeFixed) cuotasModeFixed.addEventListener('change', function () { applyCuotasModeUi(); syncCuotasPreview(); });
    if (cuotasModeIndefinite) cuotasModeIndefinite.addEventListener('change', function () { applyCuotasModeUi(); syncCuotasPreview(); });

    if (ccInlinePaid) ccInlinePaid.addEventListener('input', function () { syncCuentaCorrienteInlinePreview(); });
    if (btnCloseCuentaCorriente) btnCloseCuentaCorriente.addEventListener('click', function () { closeCuentaCorrientePanel(true); });

    if (ccPaid) ccPaid.addEventListener('input', function () { syncCcDuePreview(); });
    if (btnCloseCc) btnCloseCc.addEventListener('click', function () { closeCuentaCorrienteModal(); });
    if (btnCancelCc) btnCancelCc.addEventListener('click', function () { closeCuentaCorrienteModal(); });
    if (btnAcceptCc) btnAcceptCc.addEventListener('click', function () { acceptCuentaCorriente(); });
    if (modalCuentaCorriente) {
        modalCuentaCorriente.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalCuentaCorriente.firstElementChild) closeCuentaCorrienteModal();
        });
    }

    if (modalSelectCustomer) {
        modalSelectCustomer.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalSelectCustomer.firstElementChild) closeModalCompat(modalSelectCustomer);
        });
    }
    if (btnCloseSelectCustomer) btnCloseSelectCustomer.addEventListener('click', function () { closeModalCompat(modalSelectCustomer); });
    if (btnCancelSelectCustomer) btnCancelSelectCustomer.addEventListener('click', function () { closeModalCompat(modalSelectCustomer); });
    if (inputSelectCustomerQ) inputSelectCustomerQ.addEventListener('input', function () { renderSelectCustomerList(); });
    if (btnOpenCreateCustomer) btnOpenCreateCustomer.addEventListener('click', function () { openCreateCustomer(''); });

    if (modalCreateCustomer) {
        modalCreateCustomer.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalCreateCustomer.firstElementChild) closeModalCompat(modalCreateCustomer);
        });
    }
    if (btnCloseCreateCustomer) btnCloseCreateCustomer.addEventListener('click', function () { closeModalCompat(modalCreateCustomer); });
    if (btnCancelCreateCustomer) btnCancelCreateCustomer.addEventListener('click', function () { closeModalCompat(modalCreateCustomer); });
    if (btnSaveCreateCustomer) btnSaveCreateCustomer.addEventListener('click', function () { saveNewCustomer(); });

    if (inputDescuentoGeneral) {
        inputDescuentoGeneral.addEventListener('input', function () {
            computeTicketTotals();
        });
        inputDescuentoGeneral.addEventListener('focus', function () {
            const v = String(inputDescuentoGeneral.value || '').trim();
            if (v === '0' || v === '0.0' || v === '0.00') inputDescuentoGeneral.value = '';
        });
        inputDescuentoGeneral.addEventListener('blur', function () {
            const v = String(inputDescuentoGeneral.value || '').trim().replace(',', '.');
            const n = parseFloat(v || '0') || 0;
            if (!isFinite(n) || n <= 0) {
                inputDescuentoGeneral.value = '';
            } else {
                inputDescuentoGeneral.value = formatearPct(n);
            }
            if (inputDescuentoGeneralPaso2 && document.activeElement !== inputDescuentoGeneralPaso2) {
                inputDescuentoGeneralPaso2.value = inputDescuentoGeneral.value;
            }
            computeTicketTotals();
        });
    }

    if (inputDescuentoGeneralPaso2) {
        inputDescuentoGeneralPaso2.addEventListener('input', function () {
            if (inputDescuentoGeneral && document.activeElement !== inputDescuentoGeneral) {
                inputDescuentoGeneral.value = String(inputDescuentoGeneralPaso2.value || '');
            }
            computeTicketTotals();
        });
        inputDescuentoGeneralPaso2.addEventListener('focus', function () {
            const v = String(inputDescuentoGeneralPaso2.value || '').trim();
            if (v === '0' || v === '0.0' || v === '0.00') inputDescuentoGeneralPaso2.value = '';
        });
        inputDescuentoGeneralPaso2.addEventListener('blur', function () {
            const v = String(inputDescuentoGeneralPaso2.value || '').trim().replace(',', '.');
            const n = parseFloat(v || '0') || 0;
            if (!isFinite(n) || n <= 0) {
                inputDescuentoGeneralPaso2.value = '';
            } else {
                inputDescuentoGeneralPaso2.value = formatearPct(n);
            }
            if (inputDescuentoGeneral && document.activeElement !== inputDescuentoGeneral) {
                inputDescuentoGeneral.value = inputDescuentoGeneralPaso2.value;
            }
            computeTicketTotals();
        });
    }

    if (inputTicketTotalFinal) {
        inputTicketTotalFinal.addEventListener('input', function () {
            const curr = computeTicketTotals();
            const base = parseFloat(curr?.subtotalConDescItem || 0) || 0;
            const desired = parseMoneda(inputTicketTotalFinal.value || '0');
            if (!inputDescuentoGeneral || base <= 0) {
                if (inputDescuentoGeneral) inputDescuentoGeneral.value = '';
                return;
            }
            let pct = (1 - (desired / base)) * 100;
            if (!isFinite(pct)) pct = 0;
            if (pct < 0) pct = 0;
            if (pct > 100) pct = 100;
            inputDescuentoGeneral.value = formatearPct(pct);
            computeTicketTotals();
        });
        inputTicketTotalFinal.addEventListener('blur', function () {
            computeTicketTotals();
        });
    }

    if (inputSearchVentasCliente) inputSearchVentasCliente.addEventListener('input', function () { applyVentasFilters(); });
    if (inputSearchVentasTicket) inputSearchVentasTicket.addEventListener('input', function () { applyVentasFilters(); });

    if (btnVentasFilterEmployee) btnVentasFilterEmployee.addEventListener('click', function (e) {
        e.stopPropagation();
        toggleVentasFilterMenu(menuVentasFilterEmployee);
    });
    if (btnVentasFilterPago) btnVentasFilterPago.addEventListener('click', function (e) {
        e.stopPropagation();
        toggleVentasFilterMenu(menuVentasFilterPago);
    });
    if (btnVentasFilterTipo) btnVentasFilterTipo.addEventListener('click', function (e) {
        e.stopPropagation();
        toggleVentasFilterMenu(menuVentasFilterTipo);
    });

    document.addEventListener('click', function (e) {
        const t = e.target;
        if (t && (t.closest('#ventas-filter-employee-menu') || t.closest('#ventas-filter-pago-menu') || t.closest('#ventas-filter-tipo-menu'))) return;
        closeVentasFilterMenus();
    });

    document.addEventListener('change', function (e) {
        const el = e.target;
        if (!el || !el.classList || !el.classList.contains('ventas-multi-check')) return;

        const filterKey = String(el.getAttribute('data-filter') || '').trim();
        const val = String(el.getAttribute('data-value') || '').trim();
        const f = ventasMultiFilters[filterKey];
        if (!f) return;
        const opts = Array.isArray(f.options) ? f.options : [];
        const total = opts.length;

        if (val === '__ALL__') {
            if (el.checked) {
                f.selected = new Set(opts.map(o => String(o.value)));
            } else {
                f.selected = new Set();
            }
        } else {
            if (el.checked) f.selected.add(val);
            else f.selected.delete(val);
        }

        const isAll = f.selected.size >= total && total > 0;
        try {
            const menu = (filterKey === 'employee') ? menuVentasFilterEmployee : (filterKey === 'pago') ? menuVentasFilterPago : menuVentasFilterTipo;
            if (menu) {
                const allCb = menu.querySelector('input.ventas-multi-check[data-value="__ALL__"]');
                if (allCb) allCb.checked = isAll;
                if (val === '__ALL__' && el.checked) {
                    const cbs = Array.from(menu.querySelectorAll('input.ventas-multi-check')).filter(x => String(x.getAttribute('data-value') || '').trim() !== '__ALL__');
                    cbs.forEach(x => { x.checked = true; });
                }
                if (val !== '__ALL__') {
                    const cbs = Array.from(menu.querySelectorAll('input.ventas-multi-check')).filter(x => String(x.getAttribute('data-value') || '').trim() !== '__ALL__');
                    cbs.forEach(x => {
                        const v = String(x.getAttribute('data-value') || '').trim();
                        x.checked = f.selected.has(v);
                    });
                }
            }
        } catch (err) {
        }

        if (filterKey === 'employee') renderVentasMultiMenu('employee', itemsVentasFilterEmployee, labelVentasFilterEmployee);
        if (filterKey === 'pago') renderVentasMultiMenu('pago', itemsVentasFilterPago, labelVentasFilterPago);
        if (filterKey === 'tipo') renderVentasMultiMenu('tipo', itemsVentasFilterTipo, labelVentasFilterTipo);

        applyVentasFilters();
    });

    initVentasMultiFiltersStatic();

    // No forzar rango por defecto: mostrar historial completo salvo que el usuario seleccione un rango.

    initSalesEmployeesSelectors();
    initHistorialVentas();

    // Confirmar productos del cambio (pasar a Paso 2 con saldo a favor)
    if (btnConfirmarCambio && vistaRealizarCambio && cambioPaso1 && cambioPaso2 && saldoAFavorEl) {
        btnConfirmarCambio.addEventListener('click', function() {
            if (editCambioTicketId) {
                const t = String(editCambioTicketId || '').trim();
                const itemsIn = getCartItemsCambio();
                if (!itemsIn.length) {
                    showAlertModal('Agreg√° al menos un producto devuelto.', 'Atenci√≥n', 'Validaci√≥n requerida');
                    return;
                }
                const returnTotal = itemsIn.reduce((acc, it) => acc + (parseFloat(it.subtotal || 0) || 0), 0);

                let sale = null;
                try { sale = (Array.isArray(salesCache) ? salesCache : []).find(s => String(s?.ticket || '').trim() === t) || null; } catch (e) { sale = null; }
                const fecha = String(sale?.fecha || '').trim() || defaultFecha;
                const pago = String(sale?.payment_method || 'Efectivo').trim() || 'Efectivo';
                const notas = String(sale?.notes || '').trim();
                const custId = String(sale?.customer_id || '').trim();
                const custName = String(sale?.customer_name || '').trim();
                const exNew = (sale && sale.exchange_new_total != null) ? (parseFloat(sale.exchange_new_total) || 0) : null;

                apiUpdateSale(t, {
                    fecha,
                    type: 'Cambio',
                    status: 'Cambio',
                    payment_method: pago,
                    notes: notas,
                    total: -Math.abs(returnTotal),
                    discount_general_pct: 0,
                    discount_general_amount: 0,
                    on_account: false,
                    paid_amount: 0,
                    due_amount: 0,
                    customer_id: custId,
                    customer_name: custName,
                    ...getSelectedEmployeePayload(selectCambioEmployee),
                    exchange_return_total: returnTotal,
                    exchange_new_total: exNew,
                    is_gift: false,
                    gift_code: '',
                    items: itemsIn,
                }).then(function (res) {
                    if (!res || res.ok !== true) {
                        const msg = (res && (res.message || res.error)) ? String(res.message || res.error) : 'No se pudo guardar el cambio.';
                        showAlertModal(msg, 'Error', 'Operaci√≥n fallida');
                        return;
                    }
                    const saved = res?.item || null;
                    if (saved && saved.ticket) {
                        const idx = (Array.isArray(salesCache) ? salesCache : []).findIndex(s => String(s?.ticket || '').trim() === String(saved.ticket || '').trim());
                        if (idx >= 0) salesCache[idx] = saved;
                    }

                    editCambioTicketId = null;
                    setCambioReturnOnlyMode(false);
                    invLoaded = false;
                    invLoadPromise = null;
                    renderProductosDesdeInventario();
                    renderProductosCambioDesdeInventario();
                    renderProductosCambioVentaDesdeInventario();
                    renderHistorialFromCache();
                    applyVentasFilters();
                    initKpisFromSales();
                    recalcularArqueoAutomatico();
                    showHomeAll();
                    scrollAElemento(historial || home);
                }).catch(function () {
                    showAlertModal('No se pudo guardar el cambio.', 'Error', 'Operaci√≥n fallida');
                });
                return;
            }

            // Tomar el total del cambio como saldo a favor
            let totalCambio = 0;
            if (tablaCarritoCambio) {
                const filas = tablaCarritoCambio.querySelectorAll('tbody tr');
                filas.forEach(tr => {
                    if (tr.id === 'carrito-cambio-empty-row') return;
                    const inputSubtotal = tr.querySelector('.input-subtotal-cambio');
                    if (!inputSubtotal) return;
                    const subtotal = parseFloat(inputSubtotal.value || '0');
                    if (!isNaN(subtotal)) totalCambio += subtotal;
                });
            }

            saldoAFavor = isNaN(totalCambio) ? 0 : totalCambio;
            saldoAFavorEl.textContent = formatearMoneda(saldoAFavor);
            if (resumenSaldoAFavorEl) resumenSaldoAFavorEl.textContent = formatearMoneda(saldoAFavor);

            // Cambiar a Paso 2 dentro de la vista de cambio
            cambioPaso1.classList.add('hidden');
            cambioPaso2.classList.remove('hidden');

            if (pillCambioPaso1 && pillCambioPaso2) {
                pillCambioPaso1.classList.remove('bg-indigo-600','text-white');
                pillCambioPaso1.classList.add('bg-indigo-50','text-indigo-700');
                pillCambioPaso2.classList.remove('bg-indigo-50','text-indigo-700');
                pillCambioPaso2.classList.add('bg-indigo-600','text-white');
            }

            scrollAElemento(vistaRealizarCambio);
        });
    }

    // Confirmar ticket y registrar el cambio en DB
    if (btnConfirmarCambioFinal) {
        btnConfirmarCambioFinal.addEventListener('click', function () {
            if (editCambioVentaTicketId) {
                const ticket = String(editCambioVentaTicketId || '').trim();
                const itemsOut = getCartItemsCambioVenta();
                if (!itemsOut.length) {
                    showAlertModal('Agreg√° al menos un producto de la nueva venta.', 'Atenci√≥n', 'Validaci√≥n requerida');
                    return;
                }

                const fecha = String(document.getElementById('cambio-fecha')?.value || '').trim() || defaultFecha;
                const pago = getCambioPaymentMethod();
                let notas = String(inputNotasCambio?.value || '').trim();

                const newTotal = itemsOut.reduce((acc, it) => acc + (parseFloat(it.subtotal || 0) || 0), 0);
                const returnTotal = Math.max(0, parseFloat(editCambioVentaReturnTotal || 0) || 0);

                const diffToPay = Math.max(0, newTotal - returnTotal);
                if (cambioOnAccount && (!selectedCustomer || !selectedCustomer.name)) {
                    showAlertModal('Para usar cuenta corriente ten√©s que asociar un cliente.', 'Atenci√≥n', 'Validaci√≥n requerida');
                    return;
                }

                if (cambioIsGift) {
                    if (!selectedCustomer || !selectedCustomer.name) {
                        showAlertModal('En el caso de ser un regalo, deb√©s registrar un cliente.', 'Atenci√≥n', 'Validaci√≥n requerida');
                        return;
                    }
                }

                const paidCash = (diffToPay <= 0) ? 0 : (cambioOnAccount ? Math.max(0, Math.min(diffToPay, (parseFloat(cambioPaidAmount || 0) || 0))) : diffToPay);
                const credit = Math.min(returnTotal, newTotal);
                const paidForSale = Math.max(0, Math.min(newTotal, credit + paidCash));
                const dueForSale = Math.max(0, newTotal - paidForSale);

                const custName = String(selectedCustomer?.name || inputClienteCambio?.value || '').trim();
                const custId = String(selectedCustomer?.id || '').trim();

                // asegurar relaci√≥n en notas
                if (editCambioVentaReturnTicketId) {
                    const relLine = 'Relacionado a cambio ' + editCambioVentaReturnTicketId;
                    if (!notas.toLowerCase().includes(relLine.toLowerCase())) {
                        notas = (notas ? (notas + '\n') : '') + relLine;
                    }
                }

                apiUpdateSale(ticket, {
                    fecha,
                    type: 'Venta',
                    status: 'Completada',
                    payment_method: pago,
                    notes: notas,
                    total: Math.abs(newTotal),
                    discount_general_pct: 0,
                    discount_general_amount: 0,
                    on_account: (dueForSale > 0),
                    paid_amount: paidForSale,
                    due_amount: dueForSale,
                    customer_id: custId,
                    customer_name: custName,
                    ...getSelectedEmployeePayload(selectCambioEmployee),
                    exchange_return_total: returnTotal,
                    exchange_new_total: newTotal,
                    is_gift: !!cambioIsGift,
                    gift_code: (cambioIsGift ? (String(giftCodeElCambio?.textContent || '').trim() || '') : ''),
                    items: itemsOut,
                }).then(function (res) {
                    if (!res || res.ok !== true) {
                        const msg = (res && (res.message || res.error)) ? String(res.message || res.error) : 'No se pudo guardar la venta.';
                        showAlertModal(msg, 'Error', 'Operaci√≥n fallida');
                        return;
                    }
                    const saved = res?.item || null;
                    if (saved && saved.ticket) {
                        const idx = (Array.isArray(salesCache) ? salesCache : []).findIndex(s => String(s?.ticket || '').trim() === String(saved.ticket || '').trim());
                        if (idx >= 0) salesCache[idx] = saved;
                    }

                    editCambioVentaTicketId = null;
                    editCambioVentaReturnTicketId = '';
                    editCambioVentaReturnTotal = 0;
                    setCambioVentaOnlyMode(false);
                    invLoaded = false;
                    invLoadPromise = null;
                    renderProductosDesdeInventario();
                    renderProductosCambioDesdeInventario();
                    renderProductosCambioVentaDesdeInventario();
                    renderHistorialFromCache();
                    applyVentasFilters();
                    initKpisFromSales();
                    recalcularArqueoAutomatico();
                    showHomeAll();
                    scrollAElemento(historial || home);
                }).catch(function () {
                    showAlertModal('No se pudo guardar la venta.', 'Error', 'Operaci√≥n fallida');
                });
                return;
            }

            const itemsIn = getCartItemsCambio();
            const itemsOut = getCartItemsCambioVenta();
            if (!itemsIn.length) {
                showAlertModal('Agreg√° al menos un producto devuelto.', 'Atenci√≥n', 'Validaci√≥n requerida');
                return;
            }
            if (!itemsOut.length) {
                showAlertModal('Agreg√° al menos un producto de la nueva venta.', 'Atenci√≥n', 'Validaci√≥n requerida');
                return;
            }

            const fecha = String(document.getElementById('cambio-fecha')?.value || '').trim() || defaultFecha;
            const pago = getCambioPaymentMethod();
            const notas = String(inputNotasCambio?.value || '').trim();

            const returnTotal = itemsIn.reduce((acc, it) => acc + (parseFloat(it.subtotal || 0) || 0), 0);
            const newTotal = itemsOut.reduce((acc, it) => acc + (parseFloat(it.subtotal || 0) || 0), 0);
            const diff = newTotal - returnTotal;

            const diffToPay = Math.max(0, diff);
            if (cambioOnAccount && (!selectedCustomer || !selectedCustomer.name)) {
                showAlertModal('Para usar cuenta corriente ten√©s que asociar un cliente.', 'Atenci√≥n', 'Validaci√≥n requerida');
                return;
            }

            if (cambioIsGift) {
                if (!selectedCustomer || !selectedCustomer.name) {
                    showAlertModal('En el caso de ser un regalo, deb√©s registrar un cliente.', 'Atenci√≥n', 'Validaci√≥n requerida');
                    return;
                }
            }
            const paidAmount = (diffToPay <= 0) ? 0 : (cambioOnAccount ? Math.max(0, Math.min(diffToPay, (parseFloat(cambioPaidAmount || 0) || 0))) : diffToPay);
            const dueAmount = (diffToPay <= 0) ? 0 : (cambioOnAccount ? Math.max(0, diffToPay - paidAmount) : 0);
            const onAccount = (diffToPay > 0) && (dueAmount > 0);

            const custName = String(selectedCustomer?.name || inputClienteCambio?.value || '').trim();
            const custId = String(selectedCustomer?.id || '').trim();

            apiCreateExchange({
                fecha,
                payment_method: pago,
                notes: notas,
                customer_id: custId,
                customer_name: custName,
                ...getSelectedEmployeePayload(selectCambioEmployee),
                return_items: itemsIn,
                new_items: itemsOut,
                return_total: returnTotal,
                new_total: newTotal,
                paid_amount: paidAmount,
                due_amount: dueAmount,
                is_gift: !!cambioIsGift,
                gift_code: (cambioIsGift ? (String(giftCodeElCambio?.textContent || '').trim() || '') : ''),
            }).then(function (res) {
                if (!res || res.ok !== true) {
                    const msg = (res && (res.message || res.error)) ? String(res.message || res.error) : 'No se pudo registrar el cambio.';
                    showAlertModal(msg, 'Error', 'Operaci√≥n fallida');
                    return;
                }

                const saleReturn = res?.items?.return || null;
                const saleNew = res?.items?.sale || null;
                if (saleNew && saleNew.ticket) salesCache.unshift(saleNew);
                if (saleReturn && saleReturn.ticket) salesCache.unshift(saleReturn);
                salesLoaded = true;

                // refrescar inventario (cambi√≥ stock)
                invLoaded = false;
                invLoadPromise = null;
                renderProductosDesdeInventario();
                renderProductosCambioDesdeInventario();
                renderProductosCambioVentaDesdeInventario();

                renderHistorialFromCache();
                applyVentasFilters();
                initKpisFromSales();
                recalcularArqueoAutomatico();
                emitCashflowChanged({ kind: 'sale', date: fecha, payment_method: pago, created_at: Date.now() });

                // reset UI del cambio
                if (tablaCarritoCambio) {
                    const b = tablaCarritoCambio.querySelector('tbody');
                    if (b) b.innerHTML = '<tr id="carrito-cambio-empty-row"><td colspan="6" class="px-2 py-3 text-center text-gray-400 text-[11px]">Agreg√° productos devueltos para continuar.</td></tr>';
                }
                if (tablaCarritoCambioVenta) {
                    const b2 = tablaCarritoCambioVenta.querySelector('tbody');
                    if (b2) b2.innerHTML = '<tr id="carrito-cambio-venta-empty-row"><td colspan="6" class="px-2 py-3 text-center text-gray-400 text-[11px]">Agreg√° productos para la nueva venta.</td></tr>';
                }

                saldoAFavor = 0;
                if (saldoAFavorEl) saldoAFavorEl.textContent = formatearMoneda(0);
                if (resumenSaldoAFavorEl) resumenSaldoAFavorEl.textContent = formatearMoneda(0);
                if (inputCambioTicket) inputCambioTicket.value = computeNextCambioTicketPreview();

                cambioIsGift = false;
                cambioGiftCode = '';
                renderGiftUiCambio();

                // volver a home
                showHomeAll();
                setEditState('');
                scrollAElemento(historial || home);
            }).catch(function () {
                showAlertModal('No se pudo registrar el cambio.', 'Error', 'Operaci√≥n fallida');
            });
        });
    }

    // Confirmar nueva venta (pasar a Paso 3 con resumen)
    if (btnConfirmarCambioVenta && cambioPaso2 && cambioPaso3 && totalCambioVentaEl && diferenciaAbonarEl) {
        btnConfirmarCambioVenta.addEventListener('click', function() {
            // Asegurar totales actualizados
            actualizarTotalCambioVenta();

            const totalVentaTexto = totalCambioVentaEl.textContent || '$0,00';
            const diferenciaTexto = diferenciaAbonarEl.textContent || '$0,00';

            if (resumenTotalCambioVentaEl) resumenTotalCambioVentaEl.textContent = totalVentaTexto;
            if (resumenDiferenciaAbonarEl) resumenDiferenciaAbonarEl.textContent = diferenciaTexto;

            // Pasar a Paso 3
            cambioPaso2.classList.add('hidden');
            cambioPaso3.classList.remove('hidden');

            maybeRefreshCambioGiftCode();
            if (pillCambioPaso1 && pillCambioPaso2 && pillCambioPaso3) {
                pillCambioPaso1.classList.remove('bg-indigo-600','text-white');
                pillCambioPaso1.classList.add('bg-indigo-50','text-indigo-700');
                pillCambioPaso2.classList.remove('bg-indigo-600','text-white');
                pillCambioPaso2.classList.add('bg-indigo-50','text-indigo-700');
                pillCambioPaso3.classList.remove('bg-gray-100','text-gray-600');
                pillCambioPaso3.classList.remove('bg-indigo-50','text-indigo-700');
                pillCambioPaso3.classList.add('bg-indigo-600','text-white');
            }

            scrollAElemento(vistaRealizarCambio);
        });
    }
});
</script>
{% endblock %}
