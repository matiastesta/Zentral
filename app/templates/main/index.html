{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="mb-4">
    <div class="flex flex-col gap-3 md:flex-row md:items-start md:justify-between">
        <div class="min-w-0">
            <h1 class="text-2xl font-bold text-gray-900">Panel de Control</h1>
            <p id="dash-subtitle" class="mt-1 text-sm text-gray-600">Bienvenido {{ business.name if business else 'tu negocio' }} de vuelta. AquÃ­ tienes un resumen de tu negocio</p>
        </div>
        <div class="flex gap-2 justify-end">
            <input id="dash-range" type="text" class="w-56 px-3 py-2 text-sm border rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500" placeholder="ğŸ“… PerÃ­odo" readonly>
            <button id="btn-edit-dashboard" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">
                <i class="fas fa-pen mr-2"></i> Editar Tablero
            </button>
            <button id="btn-save-dashboard" type="button" class="hidden inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;" data-brand-bg="{{ brand_color }}">
                <i class="fas fa-save mr-2"></i> Guardar
            </button>
            <button id="btn-cancel-dashboard" type="button" class="hidden inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">
                <i class="fas fa-times mr-2"></i> Cancelar
            </button>
            <button id="btn-export-dashboard" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-blue-700 bg-blue-100 rounded-md hover:bg-blue-200">
                <i class="fas fa-file-export mr-2"></i> Exportar
            </button>
        </div>
    </div>
</div>

<div id="dashboard-root" class="mt-6 space-y-8">
    <section>
        <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-gray-900">Estado general del negocio</h2>
        </div>
        <div id="block-general" data-block-container="general" class="grid grid-cols-1 gap-4 mt-3 md:grid-cols-2 xl:grid-cols-4">
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer" data-card-key="sales_period" data-href="{{ url_for('sales.index') }}" data-module="sales">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-blue-50 text-blue-700 flex items-center justify-center">ğŸ’°</div>
                    <div class="min-w-0">
                        <div class="text-sm font-medium text-gray-500">Ventas del perÃ­odo</div>
                        <div id="kpi-total-sales" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                        <div id="sk-kpi-total-sales" class="mt-2 h-4 w-32 bg-gray-100 rounded animate-pulse"></div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer hidden" data-default-hidden="1" data-card-key="expenses_period" data-href="{{ url_for('expenses.index') }}" data-module="expenses">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-red-50 text-red-700 flex items-center justify-center">ğŸ§¾</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Gastos del perÃ­odo</div>
                        <div id="kpi-total-expenses" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 hidden" data-default-hidden="1" data-card-key="gross_margin" title="(Ventas â€“ CMV) / Ventas">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-emerald-50 text-emerald-700 flex items-center justify-center">ğŸ“¦</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Margen bruto (%)</div>
                        <div id="kpi-gross-margin" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Ventas â€“ CMV</div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 hidden" data-default-hidden="1" data-card-key="net_margin" title="Resultado final / Ventas">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-emerald-50 text-emerald-700 flex items-center justify-center">âœ…</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Margen neto (%)</div>
                        <div id="kpi-net-margin" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Resultado / Ventas</div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 hidden" data-default-hidden="1" data-card-key="break_even" title="EstimaciÃ³n basada en gastos y CMV del perÃ­odo.">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-amber-50 text-amber-700 flex items-center justify-center">âš–ï¸</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Punto de equilibrio estimado</div>
                        <div id="kpi-break-even" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Ventas necesarias</div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200" data-card-key="estimated_result" title="Resultado calculado por criterio devengado. No representa flujo de caja.">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-emerald-50 text-emerald-700 flex items-center justify-center">ğŸ“ˆ</div>
                    <div class="min-w-0">
                        <div class="text-sm font-medium text-gray-500">Resultado operativo del perÃ­odo</div>
                        <div id="kpi-estimated-result" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">
                            <span id="kpi-estimated-margin">â€”</span>
                            <span class="ml-1">Â· Ventas â€“ CMV â€“ Gastos devengados</span>
                        </div>
                        <div id="sk-kpi-estimated-result" class="mt-2 h-4 w-28 bg-gray-100 rounded animate-pulse"></div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer" data-card-key="cash_available" data-href="{{ url_for('movements.index') }}" data-module="movements" title="Liquidez disponible. No representa rentabilidad.">
                <div class="flex items-start gap-3">
                    <div class="h-10 w-10 rounded-full bg-indigo-50 text-indigo-700 flex items-center justify-center">ğŸ¦</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Caja disponible</div>
                        <div id="kpi-total-available" class="mt-1 text-2xl font-semibold text-gray-900 break-words leading-tight">â€”</div>
                        <div class="mt-2 grid grid-cols-2 gap-3 text-xs">
                            <div class="min-w-0">
                                <div class="text-gray-600">Efectivo</div>
                                <div id="kpi-cash" class="mt-0.5 font-semibold text-gray-900 break-words leading-tight">â€”</div>
                            </div>
                            <div class="min-w-0">
                                <div class="text-gray-600">Bancos</div>
                                <div id="kpi-banks" class="mt-0.5 font-semibold text-gray-900 break-words leading-tight">â€”</div>
                            </div>
                        </div>
                        <div id="sk-kpi-cash" class="mt-2 h-4 w-28 bg-gray-100 rounded animate-pulse"></div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer" data-card-key="net_cashflow" data-href="{{ url_for('movements.index') }}" data-module="movements" title="Ingresos cobrados â€“ Egresos pagados del perÃ­odo seleccionado.">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-violet-50 text-violet-700 flex items-center justify-center">ğŸ’§</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Flujo neto de caja</div>
                        <div id="kpi-net-cashflow" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Cobrado â€“ pagado (perÃ­odo)</div>
                        <div id="sk-kpi-net-cashflow" class="mt-2 h-4 w-28 bg-gray-100 rounded animate-pulse"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section>
        <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-gray-900">Alertas crÃ­ticas</h2>
        </div>
        <div id="block-alerts" data-block-container="alerts" class="grid grid-cols-1 gap-4 mt-3 md:grid-cols-3">
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer" data-card-key="alert_customers_overdue" data-href="{{ url_for('customers.index') }}" data-module="customers">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-red-50 text-red-700 flex items-center justify-center">â°</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Clientes con deuda vencida</div>
                        <div id="kpi-alert-overdue" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Vencidos a la fecha</div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer" data-card-key="alert_expenses_out_of_range" data-href="{{ url_for('expenses.index') }}" data-module="expenses">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-amber-50 text-amber-700 flex items-center justify-center">ğŸ“‰</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Gastos fuera de rango</div>
                        <div id="kpi-alert-expenses" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Fuera de umbral</div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer" data-card-key="alert_stock_critical" data-href="{{ url_for('inventory.index') }}" data-module="inventory">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-red-50 text-red-700 flex items-center justify-center">ğŸ“¦</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Stock crÃ­tico</div>
                        <div id="kpi-alert-stock" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Bajo mÃ­nimo</div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section>
        <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-gray-900">Actividad comercial</h2>
        </div>
        <div id="block-activity" data-block-container="activity" class="grid grid-cols-1 gap-4 mt-3 md:grid-cols-2">
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer" data-card-key="sales_today" data-href="{{ url_for('sales.index') }}" data-module="sales" title="Este KPI no depende del perÃ­odo seleccionado.">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-blue-50 text-blue-700 flex items-center justify-center">ğŸ§¾</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Ventas hoy</div>
                        <div id="kpi-sales-today-total" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Cantidad: <span id="kpi-sales-today-count">â€”</span></div>
                        <div id="sk-kpi-sales-today" class="mt-2 h-4 w-32 bg-gray-100 rounded animate-pulse"></div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer hidden" data-default-hidden="1" data-card-key="sales_today_count" data-href="{{ url_for('sales.index') }}" data-module="sales" title="Cantidad total de tickets del dÃ­a.">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-blue-50 text-blue-700 flex items-center justify-center">ğŸ”¢</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Cantidad de ventas hoy</div>
                        <div id="kpi-sales-today-count-only" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Tickets emitidos</div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer hidden" data-default-hidden="1" data-card-key="customers_served" data-href="{{ url_for('customers.index') }}" data-module="customers">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-indigo-50 text-indigo-700 flex items-center justify-center">ğŸ‘¥</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Clientes atendidos</div>
                        <div id="kpi-customers-served" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Ãšnicos en el perÃ­odo</div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 hidden" data-default-hidden="1" data-card-key="sales_daily_pace" title="Promedio diario de ventas del perÃ­odo.">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-emerald-50 text-emerald-700 flex items-center justify-center">ğŸ“…</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Ritmo de ventas diario</div>
                        <div id="kpi-sales-daily-pace" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Promedio diario</div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 hidden" data-default-hidden="1" data-card-key="sales_accum_period" title="Ventas acumuladas en el perÃ­odo seleccionado.">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-blue-50 text-blue-700 flex items-center justify-center">ğŸ“Œ</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Ventas acumuladas del perÃ­odo</div>
                        <div id="kpi-sales-accum" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 hidden" data-default-hidden="1" data-card-key="sales_vs_prev_period" title="ComparaciÃ³n del Ãºltimo dÃ­a del perÃ­odo contra el mismo dÃ­a del perÃ­odo anterior.">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-amber-50 text-amber-700 flex items-center justify-center">ğŸ§­</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Ventas vs mismo dÃ­a perÃ­odo anterior</div>
                        <div id="kpi-sales-vs-prev" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Î” vs anterior: <span id="kpi-sales-vs-prev-delta">â€”</span></div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer" data-card-key="avg_ticket" data-href="{{ url_for('sales.index') }}" data-module="sales">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-emerald-50 text-emerald-700 flex items-center justify-center">ğŸŸï¸</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Ticket promedio</div>
                        <div id="kpi-avg-ticket" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">PerÃ­odo seleccionado</div>
                        <div id="sk-kpi-avg-ticket" class="mt-2 h-4 w-32 bg-gray-100 rounded animate-pulse"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section>
        <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-gray-900">Rankings simples</h2>
        </div>
        <div id="block-rankings" data-block-container="rankings" class="grid grid-cols-1 gap-4 mt-3 md:grid-cols-2">
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer" data-card-key="best_customer" data-href="{{ url_for('customers.index') }}" data-module="customers">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-indigo-50 text-indigo-700 flex items-center justify-center">ğŸ†</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Mejor {{ label_customers|lower }} del perÃ­odo</div>
                        <div id="kpi-best-customer" class="mt-1 text-2xl font-semibold text-gray-900 truncate">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Monto: <span id="kpi-best-customer-amount" class="font-semibold">â€”</span></div>
                        <div id="sk-kpi-best-customer" class="mt-2 h-4 w-40 bg-gray-100 rounded animate-pulse"></div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer" data-card-key="top_product" data-href="{{ url_for('inventory.index') }}">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-gray-50 text-gray-700 flex items-center justify-center">ğŸ“Œ</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">{{ label_products }} mÃ¡s vendido</div>
                        <div id="kpi-top-product" class="mt-1 text-2xl font-semibold text-gray-900 truncate">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Cantidad: <span id="kpi-top-product-qty" class="font-semibold">â€”</span></div>
                        <div class="mt-1 text-xs text-gray-500">Venta bruta: <span id="kpi-top-product-gross" class="font-semibold">â€”</span></div>
                        <div id="sk-kpi-top-product" class="mt-2 h-4 w-40 bg-gray-100 rounded animate-pulse"></div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer hidden" data-default-hidden="1" data-card-key="top_category" data-href="{{ url_for('inventory.index') }}">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-blue-50 text-blue-700 flex items-center justify-center">ğŸ—‚ï¸</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">CategorÃ­a mÃ¡s vendida</div>
                        <div id="kpi-top-category" class="mt-1 text-2xl font-semibold text-gray-900 truncate">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Monto: <span id="kpi-top-category-amount" class="font-semibold">â€”</span></div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer hidden" data-default-hidden="1" data-card-key="best_margin_product" data-href="{{ url_for('inventory.index') }}">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-emerald-50 text-emerald-700 flex items-center justify-center">ğŸ“ˆ</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Producto con mayor margen</div>
                        <div id="kpi-best-margin-product" class="mt-1 text-2xl font-semibold text-gray-900 truncate">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Margen: <span id="kpi-best-margin-pct" class="font-semibold">â€”</span></div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer hidden" data-default-hidden="1" data-card-key="worst_margin_product" data-href="{{ url_for('inventory.index') }}">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-red-50 text-red-700 flex items-center justify-center">ğŸ“‰</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Producto con menor margen</div>
                        <div id="kpi-worst-margin-product" class="mt-1 text-2xl font-semibold text-gray-900 truncate">â€”</div>
                        <div class="mt-1 text-xs text-gray-500">Margen: <span id="kpi-worst-margin-pct" class="font-semibold">â€”</span></div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section>
        <div class="flex items-center justify-between">
            <h2 class="text-sm font-semibold text-gray-900">Inventario</h2>
        </div>
        <div id="block-inventory" data-block-container="inventory" class="grid grid-cols-1 gap-4 mt-3 md:grid-cols-2">
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer hidden" data-default-hidden="1" data-card-key="stock_total_value" data-href="{{ url_for('inventory.index') }}">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-indigo-50 text-indigo-700 flex items-center justify-center">ğŸ’</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Valor total del stock</div>
                        <div id="kpi-stock-total-value" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-white rounded-lg shadow border border-gray-200 cursor-pointer hidden" data-default-hidden="1" data-card-key="stock_total_units" data-href="{{ url_for('inventory.index') }}">
                <div class="flex items-center gap-3">
                    <div class="h-10 w-10 rounded-full bg-gray-50 text-gray-700 flex items-center justify-center">ğŸ“¦</div>
                    <div class="min-w-0 w-full">
                        <div class="text-sm font-medium text-gray-500">Unidades en stock</div>
                        <div id="kpi-stock-total-units" class="mt-1 text-2xl font-semibold text-gray-900">â€”</div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <section>
        <div class="p-5 bg-white rounded-lg shadow border border-gray-200">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-medium text-gray-900">Ventas, Gastos y Resultado â€“ EvoluciÃ³n</h2>
                <div class="text-xs text-gray-500" id="chart-evolution-subtitle">â€”</div>
            </div>
            <div class="h-72">
                <canvas id="evolutionChart" class="w-full h-full"></canvas>
            </div>
        </div>
    </section>
</div>

{% if upcoming_calendar_events is defined and upcoming_calendar_events %}
<div id="dashboard-upcoming-card" class="mt-6 bg-white rounded-lg shadow border border-gray-200 overflow-hidden">
    <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
        <div>
            <div class="text-sm font-semibold text-gray-900">PrÃ³ximos avisos</div>
            <div class="text-xs text-gray-500">Eventos de alta prioridad y vencidos dentro del perÃ­odo seleccionado</div>
        </div>
        <a href="{{ url_for('calendar.index') }}" class="inline-flex items-center px-3 py-2 text-sm font-medium text-blue-700 bg-blue-50 border border-blue-100 rounded-md hover:bg-blue-100">
            <i class="fas fa-calendar-alt mr-2"></i> Ver calendario
        </a>
    </div>
    <div id="dashboard-upcoming-alerts" class="p-5 space-y-2">
        {% for ev in upcoming_calendar_events %}
        <div class="p-3 border border-gray-200 rounded-lg flex items-center justify-between gap-3" data-event-date="{{ ev.date.strftime('%Y-%m-%d') }}">
            <div class="min-w-0">
                <div class="flex items-center gap-2">
                    <div class="h-2.5 w-2.5 rounded-full {% if ev.color == 'red' %}bg-red-500{% elif ev.color == 'yellow' %}bg-yellow-500{% else %}bg-emerald-500{% endif %}"></div>
                    <div class="text-sm font-semibold text-gray-900 truncate">{{ ev.title }}</div>
                    {% if ev.overdue %}<span class="text-[10px] px-2 py-0.5 rounded-full bg-red-50 text-red-700 border border-red-100">vencido</span>{% endif %}
                </div>
                <div class="mt-1 text-xs text-gray-500">{{ ev.date.strftime('%d/%m/%Y') }}</div>
            </div>
            <a href="{{ url_for('calendar.index', view='list', year=ev.date.year, month=ev.date.month) }}" class="h-9 w-9 inline-flex items-center justify-center rounded-md border border-gray-200 hover:bg-gray-50 text-gray-700" title="Ver">
                <i class="fas fa-arrow-right"></i>
            </a>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<div id="dash-empty" class="hidden mt-6 p-5 bg-white rounded-lg shadow border border-gray-200">
    <div class="text-sm font-medium text-gray-900">No hay datos para el perÃ­odo seleccionado</div>
    <div class="mt-1 text-xs text-gray-500">ProbÃ¡ ajustando el rango de fechas o cargando nuevas ventas/egresos.</div>
</div>

<div id="modal-edit-dashboard" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden flex flex-col" style="max-height:85vh">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Editar tablero</h3>
                    <p class="text-xs text-gray-500">ArrastrÃ¡ para mover. Para agregar/eliminar, usÃ¡ el botÃ³n.</p>
                </div>
                <div class="flex items-center gap-2">
                    <button id="btn-toggle-manage-kpis" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">
                        Agregar/Eliminar KPIs
                    </button>
                    <button id="btn-close-edit-dashboard" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="p-5 overflow-y-auto" style="flex:1">
                <div id="edit-kpis-list" class="space-y-5"></div>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex items-center justify-between">
                <div class="text-xs text-gray-500">Los cambios se aplican al guardar.</div>
                <div class="flex items-center gap-2">
                    <button id="btn-cancel-edit-dashboard" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
                    <button id="btn-save-edit-dashboard" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-white rounded-md" style="background-color:#0d1067;">Guardar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="modal-export-dashboard" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="relative h-full w-full flex items-center justify-center p-4">
        <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <div class="px-5 py-4 border-b border-gray-100 flex items-center justify-between">
                <div>
                    <h3 class="text-base font-semibold text-gray-900">Exportar dashboard</h3>
                    <p class="text-xs text-gray-500">Se exporta el resumen calculado para el perÃ­odo seleccionado.</p>
                </div>
                <button id="btn-close-export-dashboard" type="button" class="h-9 w-9 inline-flex items-center justify-center rounded-full hover:bg-gray-100 text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="p-5 grid grid-cols-1 md:grid-cols-2 gap-4">
                <button id="btn-export-dashboard-pdf" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                    <div class="text-2xl">ğŸ“„</div>
                    <div class="mt-2 font-semibold text-gray-900">Exportar a PDF</div>
                    <div class="text-xs text-gray-500">Ideal para imprimir o enviar.</div>
                </button>
                <button id="btn-export-dashboard-xls" type="button" class="w-full text-left p-4 rounded-xl border border-gray-200 hover:border-gray-300 hover:bg-gray-50">
                    <div class="text-2xl">ğŸ“Š</div>
                    <div class="mt-2 font-semibold text-gray-900">Exportar a Excel</div>
                    <div class="text-xs text-gray-500">Descarga un CSV compatible.</div>
                </button>
            </div>
            <div class="px-5 py-4 border-t border-gray-100 flex justify-end">
                <button id="btn-cancel-export-dashboard" type="button" class="inline-flex items-center px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-200 rounded-md hover:bg-gray-50">Cancelar</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script id="dash-permissions" type="application/json">{{ {
    'dashboard': (current_user.is_authenticated and current_user.can('dashboard')),
    'sales': (current_user.is_authenticated and current_user.can('sales')),
    'expenses': (current_user.is_authenticated and current_user.can('expenses')),
    'inventory': (current_user.is_authenticated and current_user.can('inventory')),
    'customers': (current_user.is_authenticated and current_user.can('customers')),
    'suppliers': (current_user.is_authenticated and current_user.can('suppliers')),
    'employees': (current_user.is_authenticated and current_user.can('employees')),
    'movements': (current_user.is_authenticated and current_user.can('movements')),
    'reports': (current_user.is_authenticated and current_user.can('reports')),
    'settings': (current_user.is_authenticated and current_user.can('settings')),
} | tojson }}</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const kpiTotalSales = document.getElementById('kpi-total-sales');
    const kpiTotalExpenses = document.getElementById('kpi-total-expenses');
    const kpiGrossMargin = document.getElementById('kpi-gross-margin');
    const kpiNetMargin = document.getElementById('kpi-net-margin');
    const kpiBreakEven = document.getElementById('kpi-break-even');
    const kpiEstimatedResult = document.getElementById('kpi-estimated-result');
    const kpiEstimatedMargin = document.getElementById('kpi-estimated-margin');
    const kpiCash = document.getElementById('kpi-cash');
    const kpiBanks = document.getElementById('kpi-banks');
    const kpiTotalAvailable = document.getElementById('kpi-total-available');
    const kpiNetCashflow = document.getElementById('kpi-net-cashflow');

    const kpiAlertStock = document.getElementById('kpi-alert-stock');
    const kpiAlertExpenses = document.getElementById('kpi-alert-expenses');
    const kpiAlertOverdue = document.getElementById('kpi-alert-overdue');

    const kpiSalesTodayTotal = document.getElementById('kpi-sales-today-total');
    const kpiSalesTodayCount = document.getElementById('kpi-sales-today-count');
    const kpiSalesTodayCountOnly = document.getElementById('kpi-sales-today-count-only');
    const kpiAvgTicket = document.getElementById('kpi-avg-ticket');
    const kpiCustomersServed = document.getElementById('kpi-customers-served');
    const kpiSalesDailyPace = document.getElementById('kpi-sales-daily-pace');
    const kpiSalesAccum = document.getElementById('kpi-sales-accum');
    const kpiSalesVsPrev = document.getElementById('kpi-sales-vs-prev');
    const kpiSalesVsPrevDelta = document.getElementById('kpi-sales-vs-prev-delta');

    const kpiBestCustomer = document.getElementById('kpi-best-customer');
    const kpiBestCustomerAmount = document.getElementById('kpi-best-customer-amount');
    const kpiTopProduct = document.getElementById('kpi-top-product');
    const kpiTopProductQty = document.getElementById('kpi-top-product-qty');
    const kpiTopProductGross = document.getElementById('kpi-top-product-gross');
    const kpiTopCategory = document.getElementById('kpi-top-category');
    const kpiTopCategoryAmount = document.getElementById('kpi-top-category-amount');
    const kpiBestMarginProduct = document.getElementById('kpi-best-margin-product');
    const kpiBestMarginPct = document.getElementById('kpi-best-margin-pct');
    const kpiWorstMarginProduct = document.getElementById('kpi-worst-margin-product');
    const kpiWorstMarginPct = document.getElementById('kpi-worst-margin-pct');

    const kpiStockTotalValue = document.getElementById('kpi-stock-total-value');
    const kpiStockTotalUnits = document.getElementById('kpi-stock-total-units');

    const emptyState = document.getElementById('dash-empty');
    const dashboardRoot = document.getElementById('dashboard-root');

    const skKpiTotalSales = document.getElementById('sk-kpi-total-sales');
    const skKpiEstimatedResult = document.getElementById('sk-kpi-estimated-result');
    const skKpiCash = document.getElementById('sk-kpi-cash');
    const skKpiSalesToday = document.getElementById('sk-kpi-sales-today');
    const skKpiAvgTicket = document.getElementById('sk-kpi-avg-ticket');
    const skKpiBestCustomer = document.getElementById('sk-kpi-best-customer');
    const skKpiTopProduct = document.getElementById('sk-kpi-top-product');
    const skKpiNetCashflow = document.getElementById('sk-kpi-net-cashflow');

    const chartEvolutionSubtitle = document.getElementById('chart-evolution-subtitle');
    const dashRange = document.getElementById('dash-range');

    const btnEdit = document.getElementById('btn-edit-dashboard');
    const btnSave = document.getElementById('btn-save-dashboard');
    const btnCancel = document.getElementById('btn-cancel-dashboard');
    const modalEdit = document.getElementById('modal-edit-dashboard');
    const btnCloseEdit = document.getElementById('btn-close-edit-dashboard');
    const btnCancelEdit = document.getElementById('btn-cancel-edit-dashboard');
    const btnSaveEdit = document.getElementById('btn-save-edit-dashboard');
    const btnToggleManage = document.getElementById('btn-toggle-manage-kpis');
    const editList = document.getElementById('edit-kpis-list');

    const btnExport = document.getElementById('btn-export-dashboard');
    const modalExport = document.getElementById('modal-export-dashboard');
    const btnCloseExport = document.getElementById('btn-close-export-dashboard');
    const btnCancelExport = document.getElementById('btn-cancel-export-dashboard');
    const btnExportPdf = document.getElementById('btn-export-dashboard-pdf');
    const btnExportXls = document.getElementById('btn-export-dashboard-xls');

    const currentUserId = Number('{{ current_user.id if current_user.is_authenticated else 0 }}') || 0;
    let userCan = {};
    try {
        const elPerms = document.getElementById('dash-permissions');
        userCan = elPerms ? JSON.parse(String(elPerms.textContent || '{}')) : {};
    } catch (e) {
        userCan = {};
    }
    const layoutKey = 'dashboard_layout_u_' + String(currentUserId);
    const blockContainers = {
        general: document.getElementById('block-general'),
        alerts: document.getElementById('block-alerts'),
        activity: document.getElementById('block-activity'),
        rankings: document.getElementById('block-rankings'),
        inventory: document.getElementById('block-inventory')
    };

    function deepClone(obj) {
        try { return JSON.parse(JSON.stringify(obj || {})); } catch (e) { return {}; }
    }

    function readLayout() {
        try {
            const raw = window.localStorage.getItem(layoutKey);
            const parsed = raw ? JSON.parse(raw) : null;
            return parsed && typeof parsed === 'object' ? parsed : null;
        } catch (e) {
            return null;
        }
    }

    function writeLayout(cfg) {
        try {
            window.localStorage.setItem(layoutKey, JSON.stringify(cfg || {}));
        } catch (e) {
        }
    }

    function getDefaultLayoutFromDom() {
        const order = {};
        const hidden = new Set();
        Object.keys(blockContainers).forEach(block => {
            const el = blockContainers[block];
            const cards = el ? Array.from(el.querySelectorAll('[data-card-key]')) : [];
            order[block] = cards.map(c => String(c.getAttribute('data-card-key') || '')).filter(Boolean);
            cards.forEach(c => {
                const k = String(c.getAttribute('data-card-key') || '').trim();
                if (!k) return;
                const defHidden = String(c.getAttribute('data-default-hidden') || '').trim();
                if (defHidden === '1' || defHidden.toLowerCase() === 'true') hidden.add(k);
            });
        });
        return { hiddenKeys: Array.from(hidden), order: order };
    }

    function normalizeLayout(cfg) {
        const base = getDefaultLayoutFromDom();
        const next = {
            hiddenKeys: Array.isArray(cfg?.hiddenKeys) ? cfg.hiddenKeys.map(String) : [],
            order: typeof cfg?.order === 'object' && cfg.order ? cfg.order : {}
        };
        Object.keys(base.order).forEach(block => {
            const existing = new Set(base.order[block]);
            const wanted = Array.isArray(next.order?.[block]) ? next.order[block].map(String) : [];
            const filtered = wanted.filter(k => existing.has(k));
            const missing = base.order[block].filter(k => !filtered.includes(k));
            next.order[block] = filtered.concat(missing);
        });
        next.hiddenKeys = next.hiddenKeys.filter(k => {
            return Object.keys(base.order).some(b => base.order[b].includes(k));
        });
        return next;
    }

    function applyLayout(cfg) {
        const layout = normalizeLayout(cfg);
        Object.keys(blockContainers).forEach(block => {
            const container = blockContainers[block];
            if (!container) return;
            const byKey = new Map();
            Array.from(container.querySelectorAll('[data-card-key]')).forEach(card => {
                const key = String(card.getAttribute('data-card-key') || '');
                if (key) byKey.set(key, card);
            });
            const order = Array.isArray(layout.order?.[block]) ? layout.order[block] : [];
            order.forEach(k => {
                const el = byKey.get(String(k));
                if (el) container.appendChild(el);
            });
            byKey.forEach((el, k) => {
                const hidden = layout.hiddenKeys.includes(String(k));
                el.classList.toggle('hidden', hidden);
            });
        });
        return layout;
    }

    let currentLayout = normalizeLayout(readLayout() || getDefaultLayoutFromDom());
    currentLayout = applyLayout(currentLayout);

    let isEditing = false;
    let draftLayout = null;
    let editManageMode = false;
    let editSelected = null;

    function getCardTitleByKey(blockKey, cardKey) {
        const container = blockContainers[blockKey];
        if (!container) return String(cardKey || 'KPI');
        const card = Array.from(container.querySelectorAll('[data-card-key]')).find(c => String(c.getAttribute('data-card-key') || '') === String(cardKey));
        if (!card) return String(cardKey || 'KPI');
        const t = card.querySelector('.text-sm.font-medium.text-gray-500');
        return String(t?.textContent || '').trim() || String(cardKey || 'KPI');
    }

    function renderEditModal() {
        if (!modalEdit || !editList || !draftLayout) return;

        editList.innerHTML = '';
        if (btnToggleManage) btnToggleManage.textContent = editManageMode ? 'Volver a mover KPIs' : 'Agregar/Eliminar KPIs';
        const blocks = [
            { key: 'general', title: 'Estado general del negocio' },
            { key: 'alerts', title: 'Alertas y riesgos' },
            { key: 'activity', title: 'Actividad comercial' },
            { key: 'rankings', title: 'Rankings simples' },
            { key: 'inventory', title: 'Inventario' }
        ];

        const makeTile = function (blockKey, k) {
            const isHidden = Array.isArray(draftLayout.hiddenKeys) && draftLayout.hiddenKeys.includes(String(k));
            const tile = document.createElement('button');
            tile.type = 'button';
            tile.setAttribute('data-edit-block', String(blockKey));
            tile.setAttribute('data-edit-key', String(k));
            const isSelected = !!editSelected && String(editSelected.block) === String(blockKey) && String(editSelected.key) === String(k);
            tile.className = 'aspect-square w-full rounded-xl border text-left p-3 transition select-none flex flex-col justify-between ' 
                + (isHidden ? 'border-dashed border-gray-300 bg-gray-50 text-gray-500' : 'border-gray-200 bg-white hover:border-gray-300')
                + (isSelected ? ' ring-2 ring-blue-300' : '');

            const head = document.createElement('div');
            head.className = 'flex items-start justify-between gap-2';

            const title = document.createElement('div');
            title.className = 'text-sm font-semibold leading-snug break-words';
            title.textContent = getCardTitleByKey(blockKey, k);

            const badge = document.createElement('div');
            badge.className = 'shrink-0 text-[11px] px-2 py-0.5 rounded-full border font-semibold ' + (isHidden ? 'bg-gray-100 border-gray-200 text-gray-600' : 'bg-emerald-50 border-emerald-100 text-emerald-700');
            badge.textContent = isHidden ? 'invisible' : 'visible';

            head.appendChild(title);
            head.appendChild(badge);
            tile.appendChild(head);

            const hint = document.createElement('div');
            hint.className = 'mt-2 text-xs text-gray-500';
            hint.textContent = editManageMode ? (isHidden ? 'Click para agregar' : 'Click para eliminar') : (isSelected ? 'Click en otra caja para mover' : 'Click para seleccionar (o arrastrÃ¡)');
            tile.appendChild(hint);

            if (!editManageMode && !isHidden) {
                tile.draggable = true;
                tile.addEventListener('click', function () {
                    const key = String(k);
                    if (!editSelected) {
                        editSelected = { block: String(blockKey), key: key };
                        renderEditModal();
                        return;
                    }
                    if (String(editSelected.block) !== String(blockKey)) {
                        editSelected = { block: String(blockKey), key: key };
                        renderEditModal();
                        return;
                    }
                    const fromKey = String(editSelected.key);
                    const toKey = key;
                    if (!fromKey || !toKey) return;
                    if (fromKey === toKey) {
                        editSelected = null;
                        renderEditModal();
                        return;
                    }
                    const arr = Array.isArray(draftLayout.order?.[blockKey]) ? draftLayout.order[blockKey].slice() : [];
                    const fromIdx = arr.indexOf(fromKey);
                    const toIdx = arr.indexOf(toKey);
                    if (fromIdx < 0 || toIdx < 0) {
                        editSelected = null;
                        renderEditModal();
                        return;
                    }
                    arr.splice(fromIdx, 1);
                    const insertAt = fromIdx < toIdx ? (toIdx) : (toIdx);
                    arr.splice(insertAt, 0, fromKey);
                    draftLayout.order[blockKey] = arr;
                    editSelected = null;
                    applyLayout(draftLayout);
                    renderEditModal();
                });
                tile.addEventListener('dragstart', function (e) {
                    try {
                        e.dataTransfer.setData('text/plain', JSON.stringify({ block: String(blockKey), key: String(k) }));
                        e.dataTransfer.effectAllowed = 'move';
                    } catch (err) {
                    }
                });
                tile.addEventListener('dragover', function (e) {
                    e.preventDefault();
                    tile.classList.add('ring-2', 'ring-blue-200');
                });
                tile.addEventListener('dragleave', function () {
                    tile.classList.remove('ring-2', 'ring-blue-200');
                });
                tile.addEventListener('drop', function (e) {
                    e.preventDefault();
                    tile.classList.remove('ring-2', 'ring-blue-200');
                    let raw = '';
                    try { raw = e.dataTransfer.getData('text/plain'); } catch (err) { raw = ''; }
                    if (!raw) return;
                    let payload = null;
                    try { payload = JSON.parse(raw); } catch (err) { payload = null; }
                    if (!payload) return;
                    if (String(payload.block) !== String(blockKey)) return;
                    const fromKey = String(payload.key);
                    const toKey = String(k);
                    if (!fromKey || !toKey || fromKey === toKey) return;

                    const arr = Array.isArray(draftLayout.order?.[blockKey]) ? draftLayout.order[blockKey].slice() : [];
                    const fromIdx = arr.indexOf(fromKey);
                    const toIdx = arr.indexOf(toKey);
                    if (fromIdx < 0 || toIdx < 0) return;
                    arr.splice(fromIdx, 1);
                    const insertAt = fromIdx < toIdx ? toIdx : toIdx;
                    arr.splice(insertAt, 0, fromKey);
                    draftLayout.order[blockKey] = arr;
                    editSelected = null;
                    applyLayout(draftLayout);
                    renderEditModal();
                });
            }

            if (editManageMode) {
                tile.addEventListener('click', function () {
                    const key = String(k);
                    const hidden = Array.isArray(draftLayout.hiddenKeys) ? draftLayout.hiddenKeys.slice() : [];
                    const isNowHidden = hidden.includes(key);
                    if (isNowHidden) {
                        const i = hidden.indexOf(key);
                        if (i >= 0) hidden.splice(i, 1);
                    } else {
                        hidden.push(key);
                    }
                    draftLayout.hiddenKeys = hidden;
                    editSelected = null;
                    applyLayout(draftLayout);
                    renderEditModal();
                });
            }

            return tile;
        };

        blocks.forEach(b => {
            const section = document.createElement('div');
            section.className = 'border border-gray-200 rounded-xl overflow-hidden bg-white';

            const head = document.createElement('div');
            head.className = 'px-4 py-3 bg-gray-50 flex items-center justify-between gap-3';
            const hTitle = document.createElement('div');
            hTitle.className = 'text-sm font-semibold text-gray-900';
            hTitle.textContent = b.title;
            const hHint = document.createElement('div');
            hHint.className = 'text-xs text-gray-500';
            hHint.textContent = editManageMode ? 'Click en una caja para agregar/eliminar' : 'ArrastrÃ¡ una caja sobre otra para reordenar';
            head.appendChild(hTitle);
            head.appendChild(hHint);
            section.appendChild(head);

            const grid = document.createElement('div');
            grid.className = 'p-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3';
            const order = Array.isArray(draftLayout.order?.[b.key]) ? draftLayout.order[b.key].slice() : [];
            const keysToShow = editManageMode ? order : order.filter(k => !draftLayout.hiddenKeys.includes(String(k)));
            keysToShow.forEach(k => {
                grid.appendChild(makeTile(b.key, k));
            });
            section.appendChild(grid);
            editList.appendChild(section);
        });
    }

    function openEdit() {
        if (!modalEdit || !editList) return;
        isEditing = true;
        draftLayout = deepClone(currentLayout);
        editManageMode = false;
        editSelected = null;
        if (btnEdit) btnEdit.classList.add('hidden');
        if (btnSave) btnSave.classList.add('hidden');
        if (btnCancel) btnCancel.classList.add('hidden');

        renderEditModal();
        modalEdit.classList.remove('hidden');
    }

    function closeEdit() {
        if (modalEdit) modalEdit.classList.add('hidden');
    }

    function exitEditMode(save) {
        if (save) {
            currentLayout = normalizeLayout(draftLayout || currentLayout);
            currentLayout = applyLayout(currentLayout);
            writeLayout(currentLayout);
        } else {
            currentLayout = applyLayout(currentLayout);
        }
        draftLayout = null;
        isEditing = false;
        editManageMode = false;
        editSelected = null;
        closeEdit();
        if (btnEdit) btnEdit.classList.remove('hidden');
        if (btnSave) btnSave.classList.add('hidden');
        if (btnCancel) btnCancel.classList.add('hidden');
    }

    function isPromise(x) {
        return !!x && typeof x.then === 'function';
    }

    function formatearMoneda(valor) {
        const numero = safeNum(valor);
        try {
            return '$' + Number(numero || 0).toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        } catch (e) {
            return '$' + String(numero || 0);
        }
    }

    function fmtDateYmd(d) {
        const dd = String(d.getDate()).padStart(2, '0');
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const yy = String(d.getFullYear());
        return yy + '-' + mm + '-' + dd;
    }

    function parseFecha(raw) {
        if (typeof raw === 'number' && isFinite(raw)) {
            const dtNum = new Date(raw);
            return isNaN(dtNum.getTime()) ? null : dtNum;
        }
        const v = String(raw || '').trim();
        if (!v) return null;
        if (/^\d{4}-\d{2}-\d{2}$/.test(v)) {
            const parts = v.split('-').map(x => parseInt(x, 10));
            const y = parts[0];
            const m = parts[1];
            const d = parts[2];
            if (!y || !m || !d) return null;
            const dtIso = new Date(y, m - 1, d);
            return isNaN(dtIso.getTime()) ? null : dtIso;
        }
        if (v.includes('/')) {
            const [d, m, y] = v.split('/').map(x => parseInt(x, 10));
            if (!d || !m || !y) return null;
            const dt = new Date(y, m - 1, d);
            return isNaN(dt.getTime()) ? null : dt;
        }
        const dt = new Date(v);
        return isNaN(dt.getTime()) ? null : dt;
    }

    function parseRangoFechas(raw) {
        const txt = String(raw || '').trim();
        const normalized = txt
            .replace(/\s+(?:a|al|hasta)\s+/ig, ' - ')
            .replace(/\s+to\s+/ig, ' - ')
            .replace(/\s*[â€“â€”]\s*/g, ' - ');
        const parts = normalized.split(' - ').map(p => p.trim()).filter(Boolean);
        if (parts.length !== 2) return null;
        const a = parseFecha(parts[0]);
        const b = parseFecha(parts[1]);
        if (!a || !b) return null;
        a.setHours(0,0,0,0);
        b.setHours(23,59,59,999);
        return { from: a, to: b };
    }

    function setSkeleton(on) {
        const show = !!on;
        const hide = !show;
        if (skKpiTotalSales) skKpiTotalSales.classList.toggle('hidden', hide);
        if (skKpiEstimatedResult) skKpiEstimatedResult.classList.toggle('hidden', hide);
        if (skKpiCash) skKpiCash.classList.toggle('hidden', hide);
        if (skKpiNetCashflow) skKpiNetCashflow.classList.toggle('hidden', hide);
        if (skKpiSalesToday) skKpiSalesToday.classList.toggle('hidden', hide);
        if (skKpiAvgTicket) skKpiAvgTicket.classList.toggle('hidden', hide);
        if (skKpiBestCustomer) skKpiBestCustomer.classList.toggle('hidden', hide);
        if (skKpiTopProduct) skKpiTopProduct.classList.toggle('hidden', hide);
    }

    function setEmpty(on) {
        if (emptyState) emptyState.classList.toggle('hidden', !on);
    }

    function applyUpcomingFilter(range) {
        const wrap = document.getElementById('dashboard-upcoming-alerts');
        if (!wrap) return;
        const rows = Array.from(wrap.querySelectorAll('[data-event-date]'));
        if (!rows.length) return;

        const r = range && range.from && range.to ? range : getRangeOrDefault();
        const from = new Date(r.from.getTime());
        const to = new Date(r.to.getTime());
        from.setHours(0, 0, 0, 0);
        to.setHours(23, 59, 59, 999);

        let visible = 0;
        rows.forEach(el => {
            const raw = String(el.getAttribute('data-event-date') || '').trim();
            const dt = parseFecha(raw);
            const ok = !!dt && dt >= from && dt <= to;
            el.classList.toggle('hidden', !ok);
            if (ok) visible += 1;
        });

        const card = document.getElementById('dashboard-upcoming-card');
        if (card) card.classList.toggle('hidden', visible === 0);
    }

    function getRangeOrDefault() {
        const r = parseRangoFechas(dashRange?.value);
        if (r) return r;
        const now = new Date();
        const from = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        const to = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
        return { from, to, isDefault: true };
    }

    function normalizeSalesDate(sale) {
        return parseFecha(sale?.fecha || sale?.sale_date || sale?.date || sale?.created_at || '');
    }

    function normalizeExpenseDate(exp) {
        return parseFecha(exp?.fecha || exp?.date || exp?.created_at || '');
    }

    function isCompletedSale(s) {
        const st = String(s?.status || '').toLowerCase();
        return st.startsWith('completad');
    }

    function isRealSale(s) {
        return String(s?.type || s?.sale_type || '').trim() === 'Venta';
    }

    function isExchange(s) {
        return String(s?.type || s?.sale_type || '').trim() === 'Cambio';
    }

    function isCashCollection(s) {
        return String(s?.type || s?.sale_type || '').trim() === 'CobroCC';
    }

    function sumGrossSalesDevengadas(sales) {
        return (Array.isArray(sales) ? sales : []).reduce((acc, s) => {
            if (!isCompletedSale(s)) return acc;
            if (!isRealSale(s)) return acc;
            return acc + safeNum(s?.total);
        }, 0);
    }

    function sumExchangesTotal(sales) {
        return (Array.isArray(sales) ? sales : []).reduce((acc, s) => {
            if (!isExchange(s)) return acc;
            return acc + safeNum(s?.total);
        }, 0);
    }

    function sumNetSalesDevengadas(sales) {
        return sumGrossSalesDevengadas(sales) + sumExchangesTotal(sales);
    }

    function sumCashCollected(sales) {
        return (Array.isArray(sales) ? sales : []).reduce((acc, s) => {
            if (!isCompletedSale(s)) return acc;
            const t = String(s?.type || '').trim();
            if (t === 'CobroCC') return acc + safeNum(s?.total);
            if (t === 'Venta') return acc + safeNum(s?.paid_amount);
            return acc;
        }, 0);
    }

    function isPaidExpense(e) {
        const meta = (e && e.meta && typeof e.meta === 'object') ? e.meta : {};
        if (meta.supplier_cc_payment === true) return true;
        const cc = meta.supplier_cc;
        if (cc && cc.enabled === true) return false;
        const pm = String(e?.forma_pago || '').trim();
        if (pm === 'Cuenta corriente') return false;
        return true;
    }

    function isDevengadaExpense(e) {
        const meta = (e && e.meta && typeof e.meta === 'object') ? e.meta : {};
        if (meta.supplier_cc_payment === true) return false;
        return safeNum(e?.valor) > 0;
    }

    function bucketByDay(from, to) {
        const out = [];
        const d = new Date(from.getTime());
        d.setHours(0, 0, 0, 0);
        const end = new Date(to.getTime());
        end.setHours(0, 0, 0, 0);
        while (d <= end) {
            out.push(fmtDateYmd(d));
            d.setDate(d.getDate() + 1);
        }
        return out;
    }

    function fmtMonthKey(d) {
        const yy = String(d.getFullYear());
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        return yy + '-' + mm;
    }

    function bucketByMonth(from, to) {
        const out = [];
        const d = new Date(from.getFullYear(), from.getMonth(), 1);
        const end = new Date(to.getFullYear(), to.getMonth(), 1);
        while (d <= end) {
            out.push(fmtMonthKey(d));
            d.setMonth(d.getMonth() + 1);
        }
        return out;
    }

    function chooseBucket(range) {
        const ms = range.to.getTime() - range.from.getTime();
        const days = Math.max(1, Math.ceil(ms / (1000 * 60 * 60 * 24)));
        if (days > 62) return { kind: 'month', labels: bucketByMonth(range.from, range.to) };
        return { kind: 'day', labels: bucketByDay(range.from, range.to) };
    }

    function tryGetAllData(range) {
        if (!window.StorageService) {
            return Promise.resolve({ sales: [], expenses: [], products: [], lots: [], customers: [], suppliers: [], movements: [] });
        }

        function safe(p, fallback) {
            return Promise.resolve(p).catch(function () { return fallback; });
        }

        const r = (range && range.from && range.to) ? range : getRangeOrDefault();
        const histFrom = new Date(r.from.getTime() - (1000 * 60 * 60 * 24 * 120));
        histFrom.setHours(0, 0, 0, 0);

        const fromIso = fmtDateYmd(histFrom);
        const toIso = fmtDateYmd(r.to);

        const today = new Date();
        const todayFrom = toStartOfDay(today);
        const todayTo = toEndOfDay(today);
        const todayFromIso = fmtDateYmd(todayFrom);
        const todayToIso = fmtDateYmd(todayTo);

        const cashFrom = new Date(todayFrom.getTime() - (1000 * 60 * 60 * 24 * 30));
        cashFrom.setHours(0, 0, 0, 0);
        const cashFromIso = fmtDateYmd(cashFrom);

        const s = (typeof window.StorageService.getSales === 'function')
            ? window.StorageService.getSales({ from: fromIso, to: toIso, limit: 20000, include_replaced: 1, exclude_cc: 0 })
            : [];
        const sToday = (typeof window.StorageService.getSales === 'function')
            ? window.StorageService.getSales({ from: todayFromIso, to: todayToIso, limit: 20000, include_replaced: 0, exclude_cc: 1 })
            : [];

        const e = (typeof window.StorageService.getExpenses === 'function')
            ? window.StorageService.getExpenses({ from: fromIso, to: toIso, limit: 10000 })
            : [];

        const p = (typeof window.StorageService.getInventoryProducts === 'function')
            ? window.StorageService.getInventoryProducts({ limit: 5000, active: 1 })
            : [];
        const l = (typeof window.StorageService.getInventoryLots === 'function')
            ? window.StorageService.getInventoryLots({ limit: 20000 })
            : [];
        const c = (typeof window.StorageService.getCustomers === 'function')
            ? window.StorageService.getCustomers({ limit: 5000 })
            : [];
        const sup = (typeof window.StorageService.getSuppliers === 'function')
            ? window.StorageService.getSuppliers({})
            : [];
        const mv = (typeof window.StorageService.getInventoryMovements === 'function')
            ? window.StorageService.getInventoryMovements({ from: fromIso, to: toIso, limit: 5000 })
            : [];

        const cashCounts = (typeof window.StorageService.getCashCounts === 'function')
            ? window.StorageService.getCashCounts({ from: cashFromIso, to: todayToIso })
            : [];

        const overdueCustomersCount = (typeof window.StorageService.getOverdueCustomersCount === 'function')
            ? window.StorageService.getOverdueCustomersCount({ days: 30 })
            : 0;

        return Promise.all([
            safe(s, []),
            safe(sToday, []),
            safe(e, []),
            safe(p, []),
            safe(l, []),
            safe(c, []),
            safe(sup, []),
            safe(mv, []),
            safe(cashCounts, []),
            safe(overdueCustomersCount, 0)
        ]).then(function (vals) {
            return {
                sales: Array.isArray(vals[0]) ? vals[0] : [],
                salesToday: Array.isArray(vals[1]) ? vals[1] : [],
                expenses: Array.isArray(vals[2]) ? vals[2] : [],
                products: Array.isArray(vals[3]) ? vals[3] : [],
                lots: Array.isArray(vals[4]) ? vals[4] : [],
                customers: Array.isArray(vals[5]) ? vals[5] : [],
                suppliers: Array.isArray(vals[6]) ? vals[6] : [],
                movements: Array.isArray(vals[7]) ? vals[7] : [],
                cashCounts: Array.isArray(vals[8]) ? vals[8] : [],
                overdueCustomersCount: (typeof vals[9] === 'number' && isFinite(vals[9])) ? vals[9] : 0
            };
        });
    }

    let lastSummary = null;
    let _evolutionChart = null;

    function destroyCharts() {
        if (_evolutionChart && typeof _evolutionChart.destroy === 'function') _evolutionChart.destroy();
        _evolutionChart = null;
    }

    function renderCharts(chartsData) {
        if (!window.Chart) {
            console.warn('[Dashboard] Chart.js no estÃ¡ disponible, se omite la renderizaciÃ³n de grÃ¡ficos.');
            return;
        }

        destroyCharts();

        const canvas = document.getElementById('evolutionChart');
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const series = chartsData?.evolution || {};
        const labels = Array.isArray(series.labels) ? series.labels : [];

        _evolutionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Ventas',
                        data: Array.isArray(series.salesSeries) ? series.salesSeries : [],
                        borderColor: 'rgba(59, 130, 246, 1)',
                        backgroundColor: 'rgba(59, 130, 246, 0.12)',
                        borderWidth: 2,
                        pointRadius: 2,
                        tension: 0.25
                    },
                    {
                        label: 'Gastos',
                        data: Array.isArray(series.expensesSeries) ? series.expensesSeries : [],
                        borderColor: 'rgba(239, 68, 68, 1)',
                        backgroundColor: 'rgba(239, 68, 68, 0.10)',
                        borderWidth: 2,
                        pointRadius: 2,
                        tension: 0.25
                    },
                    {
                        label: 'Resultado',
                        data: Array.isArray(series.resultSeries) ? series.resultSeries : [],
                        borderColor: 'rgba(16, 185, 129, 1)',
                        backgroundColor: 'rgba(16, 185, 129, 0.10)',
                        borderWidth: 2,
                        pointRadius: 2,
                        tension: 0.25
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function (ctx) {
                                const v = ctx.parsed?.y ?? 0;
                                return String(ctx.dataset.label || '') + ': ' + formatearMoneda(v);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function (value) { return '$' + Number(value || 0).toLocaleString('es-AR'); }
                        }
                    },
                    x: {
                        ticks: { maxRotation: 0, autoSkip: true }
                    }
                }
            }
        });
    }

    function safeNum(v) {
        const raw = String(v ?? '').trim();
        if (!raw) return 0;

        // Normalize common locale formats:
        // - 1.234,56 (AR) -> 1234.56
        // - 1,234.56 (US) -> 1234.56
        let s = raw.replace(/\s+/g, '');
        const hasDot = s.includes('.');
        const hasComma = s.includes(',');
        if (hasDot && hasComma) {
            const lastDot = s.lastIndexOf('.');
            const lastComma = s.lastIndexOf(',');
            if (lastComma > lastDot) {
                // Dot is thousands, comma is decimal
                s = s.replace(/\./g, '').replace(/,/g, '.');
            } else {
                // Comma is thousands, dot is decimal
                s = s.replace(/,/g, '');
            }
        } else if (hasComma && !hasDot) {
            s = s.replace(/,/g, '.');
        }

        const n = parseFloat(s);
        return isNaN(n) ? 0 : n;
    }

    function toStartOfDay(d) {
        const x = new Date(d.getTime());
        x.setHours(0, 0, 0, 0);
        return x;
    }

    function toEndOfDay(d) {
        const x = new Date(d.getTime());
        x.setHours(23, 59, 59, 999);
        return x;
    }

    function salesInRange(allSales, range) {
        return (Array.isArray(allSales) ? allSales : []).filter(s => {
            const dt = normalizeSalesDate(s);
            if (!dt) return false;
            return dt >= range.from && dt <= range.to;
        });
    }

    function expensesInRange(allExpenses, range) {
        return (Array.isArray(allExpenses) ? allExpenses : []).filter(e => {
            const dt = normalizeExpenseDate(e);
            if (!dt) return false;
            return dt >= range.from && dt <= range.to;
        });
    }

    function buildAvgCostByProduct(products, lots) {
        const ps = Array.isArray(products) ? products : [];
        const ls = Array.isArray(lots) ? lots : [];
        const map = new Map();
        ps.forEach(p => {
            const rel = ls.filter(l => String(l?.product_id) === String(p?.id));
            const stock = rel.reduce((acc, l) => acc + safeNum(l?.qty_available), 0);
            const costSum = rel.reduce((acc, l) => acc + (safeNum(l?.qty_available) * safeNum(l?.unit_cost)), 0);
            const avg = stock > 0 ? (costSum / stock) : 0;
            map.set(String(p?.id || ''), avg);
        });
        return map;
    }

    function cmvRealFromMovements(movements, salesRange) {
        const tickets = new Set((Array.isArray(salesRange) ? salesRange : [])
            .filter(s => isCompletedSale(s) && isRealSale(s))
            .map(s => String(s?.ticket || '').trim())
            .filter(Boolean));
        if (!tickets.size) return 0;
        return (Array.isArray(movements) ? movements : []).reduce((acc, m) => {
            if (String(m?.type || '').trim() !== 'sale') return acc;
            const t = String(m?.sale_ticket || '').trim();
            if (!t || !tickets.has(t)) return acc;
            return acc + safeNum(m?.total_cost);
        }, 0);
    }

    function computeCashAndBanks(sales, expenses) {
        const cashMethods = new Set(['Efectivo']);
        const bankMethods = new Set(['DÃ©bito', 'CrÃ©dito', 'Transferencia']);

        const sumBy = (arr, getterMethod, getterAmount) => (Array.isArray(arr) ? arr : []).reduce((acc, x) => {
            const m = String(getterMethod(x) || '').trim() || 'Efectivo';
            const val = safeNum(getterAmount(x));
            if (cashMethods.has(m)) acc.cash += val;
            else if (bankMethods.has(m)) acc.banks += val;
            return acc;
        }, { cash: 0, banks: 0 });

        const salesAgg = sumBy(sales, (s) => s?.payment_method, (s) => {
            const t = String(s?.type || '').trim();
            if (t === 'CobroCC') return safeNum(s?.total);
            if (t === 'Venta') return safeNum(s?.paid_amount);
            return 0;
        });
        const expAgg = sumBy(expenses, (e) => e?.forma_pago, (e) => {
            if (!isPaidExpense(e)) return 0;
            return safeNum(e?.valor);
        });

        const cash = (salesAgg.cash || 0) - (expAgg.cash || 0);
        const banks = (salesAgg.banks || 0) - (expAgg.banks || 0);
        return { cash, banks, total: cash + banks };
    }

    function computeOutOfRangeExpenses(allExpenses, range) {
        const listAll = (Array.isArray(allExpenses) ? allExpenses : []).filter(isDevengadaExpense);
        if (!listAll.length) return 0;

        const curFrom = new Date(range.from.getTime());
        curFrom.setHours(0, 0, 0, 0);
        const curTo = new Date(range.to.getTime());
        curTo.setHours(23, 59, 59, 999);

        const periodDays = Math.max(1, Math.ceil((curTo.getTime() - curFrom.getTime()) / (1000 * 60 * 60 * 24)));
        const histTo = new Date(curFrom.getTime() - (1000 * 60 * 60 * 24));
        const histFrom = new Date(histTo.getTime() - (1000 * 60 * 60 * 24 * 90));

        const cur = new Map();
        const hist = new Map();

        listAll.forEach(e => {
            const dt = normalizeExpenseDate(e);
            if (!dt) return;
            const cat = String(e?.categoria || 'Sin categorÃ­a').trim() || 'Sin categorÃ­a';
            const val = safeNum(e?.valor);
            if (dt >= curFrom && dt <= curTo) {
                cur.set(cat, (cur.get(cat) || 0) + val);
            } else if (dt >= histFrom && dt <= histTo) {
                hist.set(cat, (hist.get(cat) || 0) + val);
            }
        });

        const histDays = Math.max(1, Math.ceil((histTo.getTime() - histFrom.getTime()) / (1000 * 60 * 60 * 24)));
        const thresholdMult = 1.3;
        let alerts = 0;
        cur.forEach((curTotal, cat) => {
            const histTotal = hist.get(cat) || 0;
            if (histTotal <= 0) return;
            const avgPerDay = histTotal / histDays;
            const expected = avgPerDay * periodDays;
            if (curTotal > (expected * thresholdMult)) alerts += 1;
        });
        return alerts;
    }

    function computeOverdueCounts(payload) {
        const today = new Date();
        const isoToday = fmtDateYmd(today);
        let overdue = 0;

        const apiCount = payload && typeof payload.overdueCustomersCount === 'number' ? payload.overdueCustomersCount : null;
        if (apiCount != null && isFinite(apiCount)) {
            overdue += Math.max(0, Math.floor(apiCount));
        } else {
            // Fallback: si no estÃ¡ disponible el endpoint, aproximar con ventas cargadas.
            const sales = Array.isArray(payload?.sales) ? payload.sales : [];
            const ccMap = new Map();
            sales.forEach(s => {
                if (!isCompletedSale(s)) return;
                if (String(s?.type || '').trim() !== 'Venta') return;
                const due = safeNum(s?.due_amount);
                if (due <= 0) return;
                const createdAtMs = safeNum(s?.created_at);
                const days = createdAtMs ? Math.floor((Date.now() - createdAtMs) / (1000 * 60 * 60 * 24)) : 0;
                if (days >= 30) {
                    const cid = String(s?.customer_id || '').trim() || String(s?.customer_name || '').trim();
                    if (cid) ccMap.set(cid, true);
                }
            });
            overdue += ccMap.size;
        }

        // Proveedores: cc schedule estÃ¡ en meta.supplier_cc.schedule; contar cuotas abiertas con due_date < hoy.
        const exps = Array.isArray(payload?.expenses) ? payload.expenses : [];
        const supMap = new Map();
        exps.forEach(e => {
            const meta = e && e.meta && typeof e.meta === 'object' ? e.meta : {};
            const cc = meta.supplier_cc;
            if (!cc || cc.enabled !== true) return;
            const schedule = Array.isArray(cc.schedule) ? cc.schedule : [];
            schedule.forEach(inst => {
                if (String(inst?.status || '').trim() !== 'open') return;
                const dueDate = String(inst?.due_date || '').trim();
                const rem = safeNum(inst?.remaining);
                if (!dueDate || rem <= 0) return;
                if (dueDate < isoToday) {
                    const sid = String(e?.supplier_id || '').trim() || String(e?.supplier_name || '').trim();
                    if (sid) supMap.set(sid, true);
                }
            });
        });
        overdue += supMap.size;

        return overdue;
    }

    function computeStockCritical(products, lots) {
        const ps = Array.isArray(products) ? products : [];
        const ls = Array.isArray(lots) ? lots : [];

        let criticalCount = 0;
        let topName = '';
        let topGap = -Infinity;

        ps.forEach(p => {
            const rel = ls.filter(l => String(l?.product_id) === String(p?.id));
            const stock = rel.reduce((acc, l) => acc + safeNum(l?.qty_available), 0);
            const min = safeNum(p?.min_stock);
            const isCritical = (min > 0 && stock <= min) || (min <= 0 && stock <= 0);
            if (!isCritical) return;
            criticalCount += 1;

            const gap = (min > 0) ? (min - stock) : (0 - stock);
            if (gap > topGap) {
                topGap = gap;
                topName = String(p?.name || p?.nombre || '').trim() || 'â€”';
            }
        });

        return { criticalCount, topName };
    }

    function computeTopProductByQty(sales) {
        const map = new Map();
        (Array.isArray(sales) ? sales : []).forEach(s => {
            const items = Array.isArray(s?.items) ? s.items : [];
            items.forEach(it => {
                const pid = String(it?.product_id || '').trim();
                const nm = String(it?.nombre || '').trim();
                const key = pid || nm;
                if (!key) return;
                map.set(key, (map.get(key) || 0) + safeNum(it?.cantidad));
            });
        });
        let bestKey = '';
        let bestQty = 0;
        map.forEach((q, k) => {
            if (q > bestQty) { bestQty = q; bestKey = k; }
        });
        return { key: bestKey, qty: bestQty };
    }

    function buildProductById(products) {
        const map = new Map();
        (Array.isArray(products) ? products : []).forEach(p => {
            const id = String(p?.id ?? '').trim();
            if (!id) return;
            map.set(id, p);
        });
        return map;
    }

    function computeInventoryTotals(products, lots) {
        const ps = Array.isArray(products) ? products : [];
        const ls = Array.isArray(lots) ? lots : [];
        let units = 0;
        let value = 0;
        ps.forEach(p => {
            const rel = ls.filter(l => String(l?.product_id) === String(p?.id));
            const qty = rel.reduce((acc, l) => acc + safeNum(l?.qty_available), 0);
            const val = rel.reduce((acc, l) => acc + (safeNum(l?.qty_available) * safeNum(l?.unit_cost)), 0);
            units += qty;
            value += val;
        });
        return { units, value };
    }

    function computeTopCategoryByRevenue(salesRange, products) {
        const byId = buildProductById(products);
        const map = new Map();
        (Array.isArray(salesRange) ? salesRange : []).forEach(s => {
            if (!isCompletedSale(s) || !isRealSale(s)) return;
            const items = Array.isArray(s?.items) ? s.items : [];
            items.forEach(it => {
                const pid = String(it?.product_id || '').trim();
                if (!pid) return;
                const p = byId.get(pid);
                const cat = String(p?.category || p?.category_name || '').trim() || 'Sin categorÃ­a';
                map.set(cat, (map.get(cat) || 0) + safeNum(it?.subtotal));
            });
        });
        let bestKey = '';
        let bestAmount = 0;
        map.forEach((amt, k) => {
            if ((amt || 0) > bestAmount) { bestAmount = amt || 0; bestKey = k; }
        });
        return { category: bestKey, amount: bestAmount };
    }

    function computeMarginExtremes(salesRange, products, lots) {
        const byId = buildProductById(products);
        const avgCost = buildAvgCostByProduct(products, lots);
        const agg = new Map();
        (Array.isArray(salesRange) ? salesRange : []).forEach(s => {
            if (!isCompletedSale(s) || !isRealSale(s)) return;
            const items = Array.isArray(s?.items) ? s.items : [];
            items.forEach(it => {
                const pid = String(it?.product_id || '').trim();
                if (!pid) return;
                const qty = safeNum(it?.cantidad);
                const revenue = safeNum(it?.subtotal);
                const cost = (avgCost.get(pid) || 0) * qty;
                const cur = agg.get(pid) || { revenue: 0, cost: 0, qty: 0 };
                cur.revenue += revenue;
                cur.cost += cost;
                cur.qty += qty;
                agg.set(pid, cur);
            });
        });

        let best = { pid: '', pct: null };
        let worst = { pid: '', pct: null };
        agg.forEach((v, pid) => {
            const rev = v.revenue || 0;
            if (rev <= 0) return;
            const pct = ((rev - (v.cost || 0)) / rev) * 100;
            if (best.pct == null || pct > best.pct) best = { pid, pct };
            if (worst.pct == null || pct < worst.pct) worst = { pid, pct };
        });

        const bestName = best.pid ? String(byId.get(best.pid)?.name || '') : '';
        const worstName = worst.pid ? String(byId.get(worst.pid)?.name || '') : '';
        return {
            bestName,
            bestPct: best.pct,
            worstName,
            worstPct: worst.pct
        };
    }

    function computeCustomersServed(salesRange) {
        const set = new Set();
        (Array.isArray(salesRange) ? salesRange : []).forEach(s => {
            if (!isCompletedSale(s) || !isRealSale(s)) return;
            const id = String(s?.customer_id || '').trim();
            const name = String(s?.customer_name || '').trim();
            const k = id || name;
            if (k) set.add(k);
        });
        return set.size;
    }

    function computeSalesDailyPace(totalSales, range) {
        const days = Math.max(1, Math.ceil((range.to.getTime() - range.from.getTime()) / (1000 * 60 * 60 * 24)));
        return totalSales / days;
    }

    function computeSalesVsPrevPeriodDay(salesAll, range) {
        const end = new Date(range.to.getTime());
        end.setHours(0, 0, 0, 0);
        const prev = new Date(end.getTime() - (1000 * 60 * 60 * 24 * 30));
        const curDay = { from: toStartOfDay(end), to: toEndOfDay(end) };
        const prevDay = { from: toStartOfDay(prev), to: toEndOfDay(prev) };

        const curSales = salesInRange(salesAll, curDay);
        const prevSales = salesInRange(salesAll, prevDay);
        const curTotal = sumNetSalesDevengadas(curSales);
        const prevTotal = sumNetSalesDevengadas(prevSales);
        return { curTotal, prevTotal, delta: curTotal - prevTotal };
    }

    function computeEvolution(range, payload, avgCostByProduct) {
        const bucket = chooseBucket(range);
        const labels = bucket.labels;
        const salesBy = {};
        const expBy = {};
        const cmvBy = {};
        labels.forEach(k => { salesBy[k] = 0; expBy[k] = 0; cmvBy[k] = 0; });

        const tickets = new Set();

        (Array.isArray(payload?.sales) ? payload.sales : []).forEach(s => {
            const dt = normalizeSalesDate(s);
            if (!dt || dt < range.from || dt > range.to) return;
            const k = (bucket.kind === 'month') ? fmtMonthKey(dt) : fmtDateYmd(dt);
            if (!(k in salesBy)) return;
            if (isCompletedSale(s) && isRealSale(s)) {
                salesBy[k] += safeNum(s?.total);
                const t = String(s?.ticket || '').trim();
                if (t) tickets.add(t);
            }
            if (isExchange(s)) {
                // Cambios/devoluciones restan ventas netas (total suele ser negativo)
                salesBy[k] += safeNum(s?.total);
            }
        });

        // CMV real por movimientos (solo tipo sale y tickets del perÃ­odo)
        (Array.isArray(payload?.movements) ? payload.movements : []).forEach(m => {
            if (String(m?.type || '').trim() !== 'sale') return;
            const t = String(m?.sale_ticket || '').trim();
            if (!t || !tickets.has(t)) return;
            const dt = parseFecha(m?.date || '');
            if (!dt || dt < range.from || dt > range.to) return;
            const k = (bucket.kind === 'month') ? fmtMonthKey(dt) : fmtDateYmd(dt);
            if (!(k in cmvBy)) return;
            cmvBy[k] += safeNum(m?.total_cost);
        });

        (Array.isArray(payload?.expenses) ? payload.expenses : []).forEach(e => {
            const dt = normalizeExpenseDate(e);
            if (!dt || dt < range.from || dt > range.to) return;
            const k = (bucket.kind === 'month') ? fmtMonthKey(dt) : fmtDateYmd(dt);
            if (!(k in expBy)) return;
            if (!isDevengadaExpense(e)) return;
            expBy[k] += safeNum(e?.valor);
        });

        const salesSeries = labels.map(k => salesBy[k] || 0);
        const expensesSeries = labels.map(k => expBy[k] || 0);
        const resultSeries = labels.map((k, idx) => (salesSeries[idx] || 0) - (cmvBy[k] || 0) - (expensesSeries[idx] || 0));

        return { kind: bucket.kind, labels, salesSeries, expensesSeries, resultSeries };
    }

    function calculateDashboardKPIs(payload, range) {
        const salesAll = Array.isArray(payload?.sales) ? payload.sales : [];
        const salesTodayPayload = Array.isArray(payload?.salesToday) ? payload.salesToday : [];
        const expensesAll = Array.isArray(payload?.expenses) ? payload.expenses : [];
        const products = Array.isArray(payload?.products) ? payload.products : [];
        const lots = Array.isArray(payload?.lots) ? payload.lots : [];
        const customers = Array.isArray(payload?.customers) ? payload.customers : [];
        const movements = Array.isArray(payload?.movements) ? payload.movements : [];
        const cashCounts = Array.isArray(payload?.cashCounts) ? payload.cashCounts : [];

        const salesRange = salesInRange(salesAll, range);
        const expRange = expensesInRange(expensesAll, range);

        const totalSales = sumNetSalesDevengadas(salesRange);

        const totalExpenses = (Array.isArray(expRange) ? expRange : []).reduce((acc, e) => {
            if (e && e.meta && e.meta.supplier_cc_payment === true) return acc;
            return acc + safeNum(e?.valor);
        }, 0);

        const cmv = cmvRealFromMovements(movements, salesRange);
        const estimatedResult = totalSales - cmv - totalExpenses;
        const estimatedMarginPct = totalSales > 0 ? ((estimatedResult / totalSales) * 100) : 0;

        const grossMarginPct = totalSales > 0 ? (((totalSales - cmv) / totalSales) * 100) : 0;
        const netMarginPct = totalSales > 0 ? ((estimatedResult / totalSales) * 100) : 0;
        const breakEven = (grossMarginPct > 0) ? (totalExpenses / (grossMarginPct / 100)) : 0;

        let caja = computeCashAndBanks(salesAll, expensesAll);
        if (cashCounts.length) {
            const sorted = cashCounts.slice().sort((a, b) => String(b?.date || '').localeCompare(String(a?.date || '')));
            const last = sorted[0] || {};
            const closing = safeNum(last?.closing_amount);
            caja = { cash: closing, banks: 0, total: closing };
        }
        const cashIn = sumCashCollected(salesRange);
        const cashOut = (Array.isArray(expRange) ? expRange : []).reduce((acc, e) => acc + (isPaidExpense(e) ? safeNum(e?.valor) : 0), 0);
        const netCashflow = cashIn - cashOut;

        const stockCrit = computeStockCritical(products, lots);
        const expensesOutOfRange = computeOutOfRangeExpenses(expensesAll, range);
        const overdue = computeOverdueCounts(payload);

        const salesTodayTotal = sumNetSalesDevengadas(salesTodayPayload);
        const salesTodayCount = (Array.isArray(salesTodayPayload) ? salesTodayPayload : []).filter(s => isCompletedSale(s) && isRealSale(s)).length;
        const customersServed = computeCustomersServed(salesRange);
        const salesDailyPace = computeSalesDailyPace(totalSales, range);
        const salesAccum = totalSales;
        const salesVsPrev = computeSalesVsPrevPeriodDay(salesAll, range);

        const avgTicket = salesRange.length > 0 ? (totalSales / salesRange.length) : 0;

        const bestMap = new Map();
        salesRange.forEach(s => {
            if (!isCompletedSale(s) || !isRealSale(s)) return;
            const name = String(s?.customer_name || s?.cliente || s?.customer || '').trim();
            const id = String(s?.customer_id || s?.customerId || '').trim();
            const key = (id || name) ? (id || name) : 'Consumidor final';
            const total = safeNum(s?.total);
            bestMap.set(key, (bestMap.get(key) || 0) + total);
        });
        let bestCustomerKey = '';
        let bestCustomerAmount = 0;
        bestMap.forEach((val, key) => {
            if ((val || 0) > bestCustomerAmount) {
                bestCustomerAmount = val || 0;
                bestCustomerKey = key;
            }
        });
        let bestCustomerName = '';
        if (bestCustomerKey) {
            const fromCustomers = customers.find(c => String(c?.id || '') === String(bestCustomerKey)) || null;
            if (fromCustomers) bestCustomerName = (String(fromCustomers?.first_name || '') + ' ' + String(fromCustomers?.last_name || '')).trim();
            else bestCustomerName = String(bestCustomerKey);
        }

        if (!bestCustomerName) bestCustomerName = 'â€”';

        const topProd = computeTopProductByQty(salesRange.filter(s => isCompletedSale(s) && isRealSale(s)));
        let topProdName = '';
        if (topProd.key) {
            const keyRaw = String(topProd.key);
            const byId = products.find(p => String(p?.id || '') === keyRaw) || null;
            topProdName = String(byId?.name || byId?.nombre || '').trim() || keyRaw;
        }
        const topProdGross = (Array.isArray(salesRange) ? salesRange : []).reduce((acc, s) => {
            if (!isCompletedSale(s)) return acc;
            if (!isRealSale(s)) return acc;
            const items = Array.isArray(s?.items) ? s.items : [];
            const sum = items.reduce((a, it) => {
                const name = String(it?.nombre || it?.product_name || '').trim();
                if (!name) return a;
                if (String(name) !== String(topProdName)) return a;
                return a + safeNum(it?.subtotal);
            }, 0);
            return acc + sum;
        }, 0);

        const evolution = computeEvolution(range, payload, buildAvgCostByProduct(products, lots));

        const inv = computeInventoryTotals(products, lots);
        const topCategory = computeTopCategoryByRevenue(salesRange, products);
        const margins = computeMarginExtremes(salesRange, products, lots);

        return {
            totalSales,
            totalExpenses,
            estimatedResult,
            estimatedMarginPct,
            grossMarginPct,
            netMarginPct,
            breakEven,
            cmv,
            cash: caja.cash,
            banks: caja.banks,
            totalAvailable: caja.total,
            netCashflow,
            alertStock: stockCrit.criticalCount,
            alertExpenses: expensesOutOfRange,
            alertOverdue: overdue,
            salesTodayTotal,
            salesTodayCount,
            customersServed,
            salesDailyPace,
            salesAccum,
            salesVsPrev,
            avgTicket,
            bestCustomerName,
            bestCustomerAmount,
            topProductName: topProdName,
            topProductQty: topProd.qty,
            topProductGross: topProdGross,
            stockTotalUnits: inv.units,
            stockTotalValue: inv.value,
            topCategoryName: topCategory.category,
            topCategoryAmount: topCategory.amount,
            bestMarginProductName: margins.bestName,
            bestMarginPct: margins.bestPct,
            worstMarginProductName: margins.worstName,
            worstMarginPct: margins.worstPct,
            periodLabel: String(dashRange?.value || '').trim() || 'â€”',
            evolution
        };
    }

    function renderKPIs(kpis) {
        if (kpiTotalSales) kpiTotalSales.textContent = formatearMoneda(kpis.totalSales);
        if (kpiTotalExpenses) kpiTotalExpenses.textContent = formatearMoneda(kpis.totalExpenses);
        if (kpiGrossMargin) kpiGrossMargin.textContent = (kpis.totalSales > 0 ? (kpis.grossMarginPct || 0).toFixed(1) + '%' : 'â€”');
        if (kpiNetMargin) kpiNetMargin.textContent = (kpis.totalSales > 0 ? (kpis.netMarginPct || 0).toFixed(1) + '%' : 'â€”');
        if (kpiBreakEven) kpiBreakEven.textContent = (kpis.breakEven > 0 ? formatearMoneda(kpis.breakEven) : 'â€”');

        if (kpiEstimatedResult) {
            kpiEstimatedResult.textContent = formatearMoneda(kpis.estimatedResult);
            const pos = kpis.estimatedResult >= 0;
            kpiEstimatedResult.classList.toggle('text-emerald-700', pos);
            kpiEstimatedResult.classList.toggle('text-red-700', !pos);
        }
        if (kpiEstimatedMargin) {
            if (kpis.totalSales > 0) kpiEstimatedMargin.textContent = (kpis.estimatedMarginPct >= 0 ? '+' : '') + kpis.estimatedMarginPct.toFixed(1) + '%';
            else kpiEstimatedMargin.textContent = 'â€”';
        }

        if (kpiCash) kpiCash.textContent = formatearMoneda(kpis.cash);
        if (kpiBanks) kpiBanks.textContent = formatearMoneda(kpis.banks);
        if (kpiTotalAvailable) kpiTotalAvailable.textContent = formatearMoneda(kpis.totalAvailable);
        if (kpiNetCashflow) kpiNetCashflow.textContent = formatearMoneda(kpis.netCashflow || 0);
        if (kpiAlertStock) kpiAlertStock.textContent = String(kpis.alertStock || 0);
        if (kpiAlertExpenses) kpiAlertExpenses.textContent = String(kpis.alertExpenses || 0);
        if (kpiAlertOverdue) kpiAlertOverdue.textContent = String(kpis.alertOverdue || 0);

        if (kpiSalesTodayTotal) kpiSalesTodayTotal.textContent = formatearMoneda(kpis.salesTodayTotal || 0);
        if (kpiSalesTodayCount) kpiSalesTodayCount.textContent = String(kpis.salesTodayCount || 0);
        if (kpiSalesTodayCountOnly) kpiSalesTodayCountOnly.textContent = String(kpis.salesTodayCount || 0);
        if (kpiAvgTicket) kpiAvgTicket.textContent = formatearMoneda(kpis.avgTicket || 0);

        if (kpiCustomersServed) kpiCustomersServed.textContent = String(kpis.customersServed || 0);
        if (kpiSalesDailyPace) kpiSalesDailyPace.textContent = formatearMoneda(kpis.salesDailyPace || 0);
        if (kpiSalesAccum) kpiSalesAccum.textContent = formatearMoneda(kpis.salesAccum || 0);
        if (kpiSalesVsPrev) kpiSalesVsPrev.textContent = formatearMoneda(kpis.salesVsPrev?.curTotal || 0);
        if (kpiSalesVsPrevDelta) {
            const d = safeNum(kpis.salesVsPrev?.delta);
            const sign = d >= 0 ? '+' : '';
            kpiSalesVsPrevDelta.textContent = sign + formatearMoneda(d);
        }

        if (kpiBestCustomer) kpiBestCustomer.textContent = String(kpis.bestCustomerName || 'â€”');
        if (kpiBestCustomerAmount) kpiBestCustomerAmount.textContent = kpis.bestCustomerName ? formatearMoneda(kpis.bestCustomerAmount || 0) : 'â€”';

        if (kpiTopProduct) kpiTopProduct.textContent = String(kpis.topProductName || 'â€”');
        if (kpiTopProductQty) kpiTopProductQty.textContent = String(kpis.topProductQty || 0);
        if (kpiTopProductGross) kpiTopProductGross.textContent = (kpis.topProductName ? formatearMoneda(kpis.topProductGross || 0) : 'â€”');

        if (kpiStockTotalValue) kpiStockTotalValue.textContent = formatearMoneda(kpis.stockTotalValue || 0);
        if (kpiStockTotalUnits) kpiStockTotalUnits.textContent = String(Math.round(safeNum(kpis.stockTotalUnits || 0)));

        if (kpiTopCategory) kpiTopCategory.textContent = String(kpis.topCategoryName || 'â€”');
        if (kpiTopCategoryAmount) kpiTopCategoryAmount.textContent = (kpis.topCategoryName ? formatearMoneda(kpis.topCategoryAmount || 0) : 'â€”');

        if (kpiBestMarginProduct) kpiBestMarginProduct.textContent = String(kpis.bestMarginProductName || 'â€”');
        if (kpiBestMarginPct) kpiBestMarginPct.textContent = (kpis.bestMarginPct != null ? (Number(kpis.bestMarginPct).toFixed(1) + '%') : 'â€”');
        if (kpiWorstMarginProduct) kpiWorstMarginProduct.textContent = String(kpis.worstMarginProductName || 'â€”');
        if (kpiWorstMarginPct) kpiWorstMarginPct.textContent = (kpis.worstMarginPct != null ? (Number(kpis.worstMarginPct).toFixed(1) + '%') : 'â€”');
    }

    function calcAndRender() {
        const range = getRangeOrDefault();
        setSkeleton(true);
        setEmpty(false);

        return tryGetAllData(range).then(function (payload) {
            const kpis = calculateDashboardKPIs(payload, range);

            const hasAny = (kpis.totalSales > 0) || (kpis.totalExpenses > 0) || (kpis.salesTodayTotal > 0) || (Math.abs(Number(kpis.netCashflow || 0)) > 0.0001);
            setEmpty(!hasAny);

            if (chartEvolutionSubtitle) {
                const p = (String(dashRange?.value || '').trim() || 'PerÃ­odo actual');
                const freq = (kpis?.evolution?.kind === 'month') ? 'Mensual' : 'Diario';
                chartEvolutionSubtitle.textContent = p + ' Â· ' + freq;
            }

            renderKPIs(kpis);
            renderCharts({ evolution: kpis.evolution });

            applyUpcomingFilter(range);

            lastSummary = {
                period: String(dashRange?.value || '').trim() || 'â€”',
                timestamp: new Date().toISOString(),
                kpis
            };

            return null;
        }).catch(function (err) {
            try { console.error('[Dashboard] calcAndRender failed', err); } catch (e) { }
            try {
                if (window.showAlertModal) {
                    window.showAlertModal('No se pudieron calcular los KPIs del dashboard. RevisÃ¡ la consola para mÃ¡s detalles.', 'Error', 'Dashboard');
                }
            } catch (e) {
            }

            // Fallback: render at least zeros so the UI doesn't stay in placeholder state.
            try {
                renderKPIs({
                    totalSales: 0,
                    totalExpenses: 0,
                    estimatedResult: 0,
                    estimatedMarginPct: 0,
                    grossMarginPct: 0,
                    netMarginPct: 0,
                    breakEven: 0,
                    cmv: 0,
                    cash: 0,
                    banks: 0,
                    totalAvailable: 0,
                    netCashflow: 0,
                    alertStock: 0,
                    alertExpenses: 0,
                    alertOverdue: 0,
                    salesTodayTotal: 0,
                    salesTodayCount: 0,
                    customersServed: 0,
                    salesDailyPace: 0,
                    salesAccum: 0,
                    salesVsPrev: { curTotal: 0, prevTotal: 0, delta: 0 },
                    avgTicket: 0,
                    bestCustomerName: 'â€”',
                    bestCustomerAmount: 0,
                    topProductName: 'â€”',
                    topProductQty: 0,
                    topProductGross: 0,
                    stockTotalUnits: 0,
                    stockTotalValue: 0,
                    topCategoryName: 'â€”',
                    topCategoryAmount: 0,
                    bestMarginProductName: 'â€”',
                    bestMarginPct: null,
                    worstMarginProductName: 'â€”',
                    worstMarginPct: null,
                });
            } catch (e) {
            }
            setEmpty(true);
        }).finally(function () {
            setSkeleton(false);
        });
    }

    function openExport() {
        if (!modalExport) return;
        modalExport.classList.remove('hidden');
    }
    function closeExport() {
        if (!modalExport) return;
        modalExport.classList.add('hidden');
    }

    function escapeCsvCell(v) {
        const s = String(v ?? '');
        if (/[\n\r",;]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
        return s;
    }

    function downloadBlob(blob, filename) {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        window.setTimeout(function () { URL.revokeObjectURL(a.href); }, 500);
    }

    function exportExcel() {
        const s = lastSummary || {};
        const k = s?.kpis || {};
        const evo = k?.evolution || {};
        const labels = Array.isArray(evo.labels) ? evo.labels : [];
        const salesSeries = Array.isArray(evo.salesSeries) ? evo.salesSeries : [];
        const expSeries = Array.isArray(evo.expensesSeries) ? evo.expensesSeries : [];
        const resSeries = Array.isArray(evo.resultSeries) ? evo.resultSeries : [];

        const businessLogoUrl = "{% if business and business.logo_filename %}{{ url_for('static', filename='uploads/' ~ business.logo_filename) }}{% else %}{% endif %}";
        const zentraLogoUrl = "{{ url_for('static', filename='images/zentra-consultora-horizontal.png.png') }}";
        const period = String(s.period || 'â€”');
        const exportedAt = new Date().toLocaleString('es-AR');

        const rowsEvolution = labels.map((d, idx) => {
            return '<tr>'
                + '<td>' + String(d || '') + '</td>'
                + '<td style="text-align:right">' + String(salesSeries[idx] ?? 0) + '</td>'
                + '<td style="text-align:right">' + String(expSeries[idx] ?? 0) + '</td>'
                + '<td style="text-align:right">' + String(resSeries[idx] ?? 0) + '</td>'
                + '</tr>';
        }).join('');

        const html = ''
            + '<html><head><meta charset="utf-8" />'
            + '<style>'
            + 'body{font-family:Arial,Helvetica,sans-serif;color:#111}h1{font-size:18px;margin:0}h2{font-size:14px;margin:18px 0 8px 0}'
            + 'table{border-collapse:collapse;width:100%;font-size:12px}th,td{border:1px solid #e5e7eb;padding:6px}th{background:#f9fafb;text-align:left}'
            + '.num{text-align:right}'
            + '</style></head><body>'
            + '<table><tr>'
            + '<td style="border:none;width:20%">'
            + (businessLogoUrl ? '<img src="' + businessLogoUrl + '" style="height:38px;object-fit:contain" />' : '')
            + '</td>'
            + '<td style="border:none;text-align:center;width:60%">'
            + '<div><b>Informe del perÃ­odo</b></div>'
            + '<div>PerÃ­odo: ' + period + '</div>'
            + '<div style="color:#666;font-size:11px">Exportado: ' + exportedAt + '</div>'
            + '</td>'
            + '<td style="border:none;text-align:right;width:20%">'
            + '<img src="' + zentraLogoUrl + '" style="height:38px;object-fit:contain" />'
            + '</td>'
            + '</tr></table>'

            + '<h2>Bloque 1 â€” Estado general del negocio</h2>'
            + '<table>'
            + '<tr><th>KPI</th><th class="num">Valor</th></tr>'
            + '<tr><td>Ventas del perÃ­odo</td><td class="num">' + String(k.totalSales ?? 0) + '</td></tr>'
            + '<tr><td>Gastos devengados del perÃ­odo</td><td class="num">' + String(k.totalExpenses ?? 0) + '</td></tr>'
            + '<tr><td>CMV (solo ventas)</td><td class="num">' + String(k.cmv ?? 0) + '</td></tr>'
            + '<tr><td>Resultado estimado</td><td class="num">' + String(k.estimatedResult ?? 0) + '</td></tr>'
            + '<tr><td>Caja (efectivo)</td><td class="num">' + String(k.cash ?? 0) + '</td></tr>'
            + '<tr><td>Bancos</td><td class="num">' + String(k.banks ?? 0) + '</td></tr>'
            + '<tr><td>Caja disponible (total)</td><td class="num">' + String(k.totalAvailable ?? 0) + '</td></tr>'
            + '<tr><td>Flujo neto de caja (perÃ­odo)</td><td class="num">' + String(k.netCashflow ?? 0) + '</td></tr>'
            + '</table>'

            + '<h2>Bloque 2 â€” Alertas crÃ­ticas</h2>'
            + '<table>'
            + '<tr><th>Alerta</th><th class="num">Cantidad</th></tr>'
            + '<tr><td>Stock crÃ­tico</td><td class="num">' + String(k.alertStock ?? 0) + '</td></tr>'
            + '<tr><td>Gastos fuera de rango</td><td class="num">' + String(k.alertExpenses ?? 0) + '</td></tr>'
            + '<tr><td>Vencimientos vencidos</td><td class="num">' + String(k.alertOverdue ?? 0) + '</td></tr>'
            + '</table>'

            + '<h2>Bloque 3 â€” Actividad comercial</h2>'
            + '<table>'
            + '<tr><th>KPI</th><th class="num">Valor</th></tr>'
            + '<tr><td>Ventas hoy</td><td class="num">' + String(k.salesTodayTotal ?? 0) + '</td></tr>'
            + '<tr><td>Cantidad de ventas hoy</td><td class="num">' + String(k.salesTodayCount ?? 0) + '</td></tr>'
            + '<tr><td>Ticket promedio (perÃ­odo)</td><td class="num">' + String(k.avgTicket ?? 0) + '</td></tr>'
            + '</table>'

            + '<h2>Bloque 4 â€” Ventas, Gastos y Resultado â€“ EvoluciÃ³n</h2>'
            + '<table>'
            + '<tr><th>Fecha</th><th class="num">Ventas</th><th class="num">Gastos</th><th class="num">Resultado</th></tr>'
            + rowsEvolution
            + '</table>'

            + '<h2>Bloque 5 â€” Rankings simples</h2>'
            + '<table>'
            + '<tr><th>Ranking</th><th>Detalle</th></tr>'
            + '<tr><td>Mejor {{ label_customers|lower }}</td><td>' + String(k.bestCustomerName || 'â€”') + ' (' + String(k.bestCustomerAmount ?? 0) + ')</td></tr>'
            + '<tr><td>{{ label_products }} mÃ¡s vendido</td><td>' + String(k.topProductName || 'â€”') + ' (' + String(k.topProductQty ?? 0) + ')</td></tr>'
            + '</table>'
            + '</body></html>';

        const blob = new Blob(["\ufeff" + html], { type: 'application/vnd.ms-excel;charset=utf-8;' });
        const filename = 'Informe_del_periodo_' + period.replace(/\s+/g, '_').replace(/\//g, '-') + '.xls';
        downloadBlob(blob, filename);
    }

    function exportPdfPrint() {
        const s = lastSummary || {};
        const w = window.open('', '_blank');
        if (!w) return;
        const businessLogoUrl = "{% if business and business.logo_filename %}{{ url_for('static', filename='uploads/' ~ business.logo_filename) }}{% else %}{% endif %}";
        const zentraLogoUrl = "{{ url_for('static', filename='images/zentra-consultora-horizontal.png.png') }}";
        const exportedAt = new Date();
        const exportedAtLabel = exportedAt.toLocaleString('es-AR');

        const k = s?.kpis || {};
        const evo = k?.evolution || {};
        const labels = Array.isArray(evo.labels) ? evo.labels : [];
        const salesSeries = Array.isArray(evo.salesSeries) ? evo.salesSeries : [];
        const expSeries = Array.isArray(evo.expensesSeries) ? evo.expensesSeries : [];
        const resSeries = Array.isArray(evo.resultSeries) ? evo.resultSeries : [];

        const rowsHtml = labels.map((d, idx) => {
            const vSales = safeNum(salesSeries[idx] || 0);
            const vExp = safeNum(expSeries[idx] || 0);
            const vRes = safeNum(resSeries[idx] || 0);
            return ''
                + '<tr>'
                +   '<td>' + String(d || '') + '</td>'
                +   '<td class="num">' + formatearMoneda(vSales) + '</td>'
                +   '<td class="num">' + formatearMoneda(vExp) + '</td>'
                +   '<td class="num">' + formatearMoneda(vRes) + '</td>'
                + '</tr>';
        }).join('');

        const html = ''
            + '<!doctype html><html lang="es"><head><meta charset="utf-8" />'
            + '<title>Informe del perÃ­odo</title>'
            + '<style>body{font-family:Arial,Helvetica,sans-serif;padding:24px;color:#111}h1{font-size:18px;margin:0 0 6px 0}p{margin:0 0 14px 0;color:#555;font-size:12px}.muted{color:#666;font-size:11px}table{width:100%;border-collapse:collapse;font-size:12px;margin-top:12px}th,td{border:1px solid #e5e7eb;padding:8px;text-align:left}th{background:#f9fafb}td.num{text-align:right}tfoot td{font-weight:700}</style>'
            + '</head><body>'
            + '<div style="display:flex;align-items:center;justify-content:space-between;gap:12px">'
            + '  <div style="width:25%">'
            + (businessLogoUrl ? '    <img src="' + businessLogoUrl + '" alt="Logo" style="height:38px;object-fit:contain" />' : '')
            + '  </div>'
            + '  <div style="flex:1;text-align:center">'
            + '    <h1>Informe del perÃ­odo</h1>'
            + '    <p>PerÃ­odo: ' + String(s.period || 'â€”') + '</p>'
            + '    <p class="muted">Exportado: ' + exportedAtLabel + '</p>'
            + '  </div>'
            + '  <div style="width:25%;text-align:right">'
            + '    <img src="' + zentraLogoUrl + '" alt="Zentra" style="height:38px;object-fit:contain" />'
            + '  </div>'
            + '</div>'

            + '<table>'
            + '  <thead><tr><th>Bloque 1 â€” Estado general</th><th class="num">Valor</th></tr></thead>'
            + '  <tbody>'
            + '    <tr><td>Ventas del perÃ­odo</td><td class="num">' + formatearMoneda(k.totalSales || 0) + '</td></tr>'
            + '    <tr><td>Gastos devengados del perÃ­odo</td><td class="num">' + formatearMoneda(k.totalExpenses || 0) + '</td></tr>'
            + '    <tr><td>CMV (solo ventas)</td><td class="num">' + formatearMoneda(k.cmv || 0) + '</td></tr>'
            + '    <tr><td>Resultado operativo (devengado)</td><td class="num">' + formatearMoneda(k.estimatedResult || 0) + '</td></tr>'
            + '    <tr><td>Caja disponible (total)</td><td class="num">' + formatearMoneda(k.totalAvailable || 0) + '</td></tr>'
            + '    <tr><td>Flujo neto de caja (perÃ­odo)</td><td class="num">' + formatearMoneda(k.netCashflow || 0) + '</td></tr>'
            + '  </tbody>'
            + '</table>'

            + '<table>'
            + '  <thead><tr><th>Bloque 2 â€” Alertas crÃ­ticas</th><th class="num">Cantidad</th></tr></thead>'
            + '  <tbody>'
            + '    <tr><td>Stock crÃ­tico</td><td class="num">' + String(k.alertStock || 0) + '</td></tr>'
            + '    <tr><td>Gastos fuera de rango</td><td class="num">' + String(k.alertExpenses || 0) + '</td></tr>'
            + '    <tr><td>Vencimientos vencidos</td><td class="num">' + String(k.alertOverdue || 0) + '</td></tr>'
            + '  </tbody>'
            + '</table>'

            + '<table>'
            + '  <thead><tr><th>Bloque 3 â€” Actividad comercial</th><th class="num">Valor</th></tr></thead>'
            + '  <tbody>'
            + '    <tr><td>Ventas hoy</td><td class="num">' + formatearMoneda(k.salesTodayTotal || 0) + '</td></tr>'
            + '    <tr><td>Cantidad de ventas hoy</td><td class="num">' + String(k.salesTodayCount || 0) + '</td></tr>'
            + '    <tr><td>Ticket promedio (perÃ­odo)</td><td class="num">' + formatearMoneda(k.avgTicket || 0) + '</td></tr>'
            + '  </tbody>'
            + '</table>'

            + '<table>'
            + '  <thead><tr><th>Bloque 4 â€” EvoluciÃ³n</th><th class="num">Ventas</th><th class="num">Gastos</th><th class="num">Resultado</th></tr></thead>'
            + '  <tbody>' + rowsHtml + '</tbody>'
            + '</table>'
            + '<p class="muted" style="margin-top:14px">Informe generado por Zentral â€“ Zentra Consultora</p>'
            + '<script>window.onload=function(){window.print();}<\/script>'
            + '</body></html>';
        w.document.open();
        w.document.write(html);
        w.document.close();
    }

    if (dashRange && window.flatpickr) {
        flatpickr(dashRange, {
            mode: 'range',
            dateFormat: 'd/m/Y',
            locale: window.flatpickr && window.flatpickr.l10ns ? window.flatpickr.l10ns.es : 'es',
            allowInput: false,
            onChange: function (selectedDates) {
                if (Array.isArray(selectedDates) && selectedDates.length === 2) calcAndRender();
            },
            onClose: function (selectedDates) {
                if (Array.isArray(selectedDates) && selectedDates.length === 2) calcAndRender();
            }
        });
        dashRange.addEventListener('change', calcAndRender);
    }

    if (btnExport) btnExport.addEventListener('click', function () { openExport(); });
    if (btnCloseExport) btnCloseExport.addEventListener('click', function () { closeExport(); });
    if (btnCancelExport) btnCancelExport.addEventListener('click', function () { closeExport(); });
    if (btnExportXls) btnExportXls.addEventListener('click', function () { exportExcel(); closeExport(); });
    if (btnExportPdf) btnExportPdf.addEventListener('click', function () { exportPdfPrint(); closeExport(); });
    if (modalExport) {
        modalExport.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalExport.firstElementChild) closeExport();
        });
    }

    if (dashboardRoot) {
        dashboardRoot.addEventListener('click', function (e) {
            const el = e.target;
            if (!el || typeof el.closest !== 'function') return;
            const card = el.closest('[data-href]');
            if (!card) return;
            const requiredModule = String(card.getAttribute('data-module') || '').trim();
            if (requiredModule) {
                const allowed = !!userCan?.[requiredModule];
                if (!allowed) {
                    try {
                        if (window.showAlertModal) {
                            window.showAlertModal('No tenÃ©s permisos para acceder a este mÃ³dulo.', 'Acceso denegado', 'Permisos');
                        } else {
                            alert('No tenÃ©s permisos para acceder a este mÃ³dulo.');
                        }
                    } catch (err) {
                    }
                    return;
                }
            }
            const href = card.getAttribute('data-href');
            if (href) window.location.href = href;
        });
    }

    if (btnEdit) btnEdit.addEventListener('click', function () { openEdit(); });
    if (btnSave) btnSave.addEventListener('click', function () { exitEditMode(true); });
    if (btnCancel) btnCancel.addEventListener('click', function () { exitEditMode(false); });
    if (btnCloseEdit) btnCloseEdit.addEventListener('click', function () { exitEditMode(false); });
    if (btnCancelEdit) btnCancelEdit.addEventListener('click', function () { exitEditMode(false); });
    if (btnSaveEdit) btnSaveEdit.addEventListener('click', function () { exitEditMode(true); });
    if (btnToggleManage) {
        btnToggleManage.addEventListener('click', function () {
            if (!isEditing || !draftLayout) return;
            editManageMode = !editManageMode;
            btnToggleManage.textContent = editManageMode ? 'Volver a mover KPIs' : 'Agregar/Eliminar KPIs';
            renderEditModal();
        });
    }
    if (modalEdit) {
        modalEdit.addEventListener('click', function (e) {
            const target = e.target;
            if (target && target === modalEdit.firstElementChild) exitEditMode(false);
        });
    }

    window.addEventListener('storage', function () {
        calcAndRender();
    });

    calcAndRender();
});
</script>
{% endblock %}
